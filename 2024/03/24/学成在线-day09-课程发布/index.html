<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />




  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg?v=5.1.4">






  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="1 模块需求分析1.1 模块介绍课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。 下边是课程编辑与发布的整体流程：  为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。 作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线-day09-课程发布 + day10-页面静态化、认证授权、SpringSecurity">
<meta property="og:url" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/index.html">
<meta property="og:site_name" content="章北海">
<meta property="og:description" content="1 模块需求分析1.1 模块介绍课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。 下边是课程编辑与发布的整体流程：  为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。 作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效">
<meta property="og:locale">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-171126384160695.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-171126384160696.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-171126384160797.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-171126384160798.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-171126384160799.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711263841607102.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711263841607100.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711263841607101.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711263841607103.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711263841607104.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image021-1711263841607105.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711263841607106.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image024-1711263841607107.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image026-1711263841607108.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image028-1711263841607109.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image030-1711263841607110.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711263841607111.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image034-1711263841607112.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image036-1711263841607113.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image038-1711263841607114.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image040-1711263841607115.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image042-1711263841607116.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image044-1711263841607117.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image046-1711263841607118.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image048-1711263841607119.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image050-1711263841607120.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image052-1711263841607121.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image054-1711263841607122.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image056-1711263841607123.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image057-1711263841607124.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image059-1711263841607126.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image061-1711263841607125.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711268014348159.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711268014348160.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711268014348161.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711268014348163.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711268014348162.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711268014348164.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711268014348165.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711268014348166.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711268014348167.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711268014348168.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711268014348169.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711273702556181.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711273702556182.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711273702556184.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711273702556183.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711273702556185.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711273702556186.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711273702556187.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711291285108197.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711291285108195.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711291285108196.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711291285108198.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711291285108199.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711291285108205.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711291285108200.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711291285108201.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711291285108202.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711291285108203.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711291285108204.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image024-1711291285108208.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image026-1711291285108206.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image028-1711291285108207.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image030-1711291285108210.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711291285108209.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711291285108209.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image034-1711291285108211.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image036-1711291285108212.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image038-1711291285108213.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image040-1711291285108216.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711291285108202.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image042-1711291285108215.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image044-1711291285108214.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image046-1711291285108217.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image048-1711291285108218.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image050-1711291285108220.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image052-1711291285108219.gif">
<meta property="og:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image054-1711291285108221.gif">
<meta property="article:published_time" content="2024-03-24T06:46:43.000Z">
<meta property="article:modified_time" content="2024-04-17T05:37:07.142Z">
<meta property="article:author" content="waterdance">
<meta property="article:tag" content="Java,Python,Linux,C++,算法,编程技术">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-171126384160695.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://2698022795.github.io/2024/03/24/学成在线-day09-课程发布/"/>





  <title>学成在线-day09-课程发布 + day10-页面静态化、认证授权、SpringSecurity | 章北海</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">章北海</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">轻舟已过万重山</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">学成在线-day09-课程发布 + day10-页面静态化、认证授权、SpringSecurity</h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-24T14:46:43+08:00">
                2024-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  18.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  75
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1</strong> <strong>模块需求分析</strong></h1><h2 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1</strong> <strong>模块介绍</strong></h2><p>课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。</p>
<p>下边是课程编辑与发布的整体流程：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-171126384160695.gif" alt="img"></p>
<p>为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。</p>
<p>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。</p>
<p>下图是课程预览的效果图，也是课程正式发布后的课程详情界面：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-171126384160696.gif" alt="img"></p>
<p>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。</p>
<p>课程发布模块共包括三块功能：</p>
<p>1、课程预览</p>
<p>2、课程审核</p>
<p>3、课程发布</p>
<h2 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2</strong> <strong>业务流程</strong></h2><h3 id="1-2-1-课程预览"><a href="#1-2-1-课程预览" class="headerlink" title="1.2.1 课程预览"></a><strong>1.2.1</strong> <strong>课程预览</strong></h3><p>1.<strong>教育机构用户</strong>在课程管理中可对该机构内所管理的课程进行检索。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-171126384160797.gif" alt="img"></p>
<p>2.点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面效果。</p>
<p>下图是课程详情首页，显示了课程的基本信息。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-171126384160798.gif" alt="img"></p>
<p>点击课程目录，显示课程计划，通过此界面去核实课程计划的信息是否存在问题。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-171126384160799.gif" alt="img"></p>
<p>点击课程目录中的具体章节，查看视频播放是否正常</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711263841607102.gif" alt="img"></p>
<h3 id="1-2-2-课程审核"><a href="#1-2-2-课程审核" class="headerlink" title="1.2.2 课程审核"></a><strong>1.2.2</strong> <strong>课程审核</strong></h3><p>教学机构提交课程审核后，平台运营人员登录运营平台进行课程审核，课程审核包括程序自动审核和人工审核，程序会审核内容的完整性，人员通过课程预览进行审核。</p>
<p>流程如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711263841607100.gif" alt="img"></p>
<p>1、首先查询待审核的记录。</p>
<p>2、课程审核</p>
<p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。</p>
<p>如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。</p>
<p>如果课程内容没有违规信息且课程内容全面则审核通过。</p>
<p>课程审核通过后教学机构发布课程成功。</p>
<h3 id="1-2-3-课程发布"><a href="#1-2-3-课程发布" class="headerlink" title="1.2.3 课程发布"></a><strong>1.2.3</strong> <strong>课程发布</strong></h3><p>1.<strong>教育机构用户</strong>在课程管理中可对机构内课程进行检索。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711263841607101.gif" alt="img"></p>
<p>2.点击某课程数据后的 发布 链接（审核状态为通过），即可对该课程进行发布。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711263841607103.gif" alt="img"></p>
<p>3、课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711263841607104.gif" alt="img"></p>
<p>4 点击课程搜索页中课程列表的某个课程，可进入课程详情页。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image021-1711263841607105.gif" alt="img"></p>
<h1 id="2-课程预览"><a href="#2-课程预览" class="headerlink" title="2 课程预览"></a><strong>2</strong> <strong>课程预览</strong></h1><h2 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a><strong>2.1</strong> <strong>需求分析</strong></h2><p>课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711263841607106.gif" alt="img"></p>
<p>下图是课程预览的数据来源：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image024-1711263841607107.gif" alt="img"></p>
<p>在课程预览页面点击”视频播放图片”打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image026-1711263841607108.gif" alt="img"></p>
<p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的流程图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image028-1711263841607109.gif" alt="img"></p>
<p>说明如下：</p>
<p>1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。</p>
<p>2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。</p>
<p>3、通过课程预览页面点击”马上学习“打开视频播放页面。</p>
<p>4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资服务查询课程计划绑定的视频文件地址，在线浏览播放视频。</p>
<h2 id="2-2-模板引擎"><a href="#2-2-模板引擎" class="headerlink" title="2.2 模板引擎"></a><strong>2.2</strong> <strong>模板引擎</strong></h2><h3 id="2-2-1-什么是模板引擎"><a href="#2-2-1-什么是模板引擎" class="headerlink" title="2.2.1 什么是模板引擎"></a><strong>2.2.1</strong> <strong>什么是模板引擎</strong></h3><p>根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致。</p>
<p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p>
<p>早期我们采用的jsp技术就是一种模板引擎技术，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image030-1711263841607110.gif" alt="img"></p>
<p>1、浏览器请求web服务器</p>
<p>2、服务器渲染页面，渲染的过程就是向jsp页面(模板)内填充数据(模型)。</p>
<p>3、服务器将渲染生成的页面返回给浏览器。</p>
<p>所以模板引擎就是：模板+数据&#x3D;输出，Jsp页面就是模板，页面中嵌入的jsp标签就是数据，两者相结合输出html网页。</p>
<p>常用的java模板引擎还有哪些？</p>
<p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p>
<p>本项目采用Freemarker作为模板引擎技术。</p>
<p>Freemarker官方地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></p>
<p>FreeMarker 是一款 <em>模板引擎</em>： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。FreeMarker 是 <a target="_blank" rel="noopener" href="http://www.fsf.org/philosophy/free-sw.html">免费的</a>， 基于Apache许可证2.0版本发布。</p>
<h3 id="2-2-2-Freemarker快速入门"><a href="#2-2-2-Freemarker快速入门" class="headerlink" title="2.2.2 Freemarker快速入门"></a><strong>2.2.2 Freemarker快速入门</strong></h3><p>下边在内容管理接口层搭建Freemarker的运行环境并进行测试。</p>
<p>在内容管理接口工层 添加Freemarker与SpringBoot的整合包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在nacos为内容管理接口层配置freemarker，公用配置组新加一个freemarker-config-dev.yaml</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711263841607111.gif" alt="img"></p>
<p>配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span>   <span class="comment">#关闭模板缓存，方便测试</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">template_update_delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span>   <span class="comment">#页面模板后缀名</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/templates/</span>   <span class="comment">#页面模板位置(默认为 classpath:/templates/)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span></span><br></pre></td></tr></table></figure>

<p>在内容管理接口工程添加freemarker-config-dev.yaml</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image034-1711263841607112.gif" alt="img"></p>
<p>添加模板，在resources下创建templates目录，添加test.ftl模板文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Hello $&#123;name&#125;!</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写controller方法，准备模型数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.math.raw.Mod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> freemarker测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/15 19:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testfreemarker&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        <span class="comment">//设置模型数据</span></span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;小明&quot;</span>);</span><br><span class="line">        <span class="comment">//设置模板名称</span></span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/testfreemarker">http://localhost:63040/content/testfreemarker</a></p>
<p>屏幕输出：Hello 小明！</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image036-1711263841607113.gif" alt="img"></p>
<p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p>
<h2 id="2-3-测试静态页面"><a href="#2-3-测试静态页面" class="headerlink" title="2.3 测试静态页面"></a><strong>2.3</strong> <strong>测试静态页面</strong></h2><h3 id="2-3-1-部署网站门户"><a href="#2-3-1-部署网站门户" class="headerlink" title="2.3.1 部署网站门户"></a><strong>2.3.1</strong> <strong>部署网站门户</strong></h3><p>在课程预览界面上要加载css、js、图片等内容，这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image038-1711263841607114.gif" alt="img"></p>
<p>1、在本机安装 Nginx ，从课程资料目录获取nginx-1.23.1.zip并解压。</p>
<p>2、运行nginx-1.23.1目录下的nginx.exe。</p>
<p>默认端口为80，如果本机80端口被占用，则需要杀掉占用进程后再启动nginx。</p>
<p>如果无法杀掉80端口占用进程则需要修改nginx-1.23.1目录下conf&#x2F;nginx.conf配置文件</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image040-1711263841607115.gif" alt="img"></p>
<p>将80端口修改为空闲端口。</p>
<p>启动nginx，访问<a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a> 出现下边的网页表示启动成功</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image042-1711263841607116.gif" alt="img"></p>
<p>下边开始部署前端工程：</p>
<p>1、从课程资料目录获取xc-ui-pc-static-portal.zip 并解压。</p>
<p>2、修改本机hosts文件，加入127.0.0.1 <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">www.51xuecheng.cn</a> 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn。</p>
<p>window10操作系统hosts文件在C:\Windows\System32\drivers\etc下</p>
<p>Centos7操作系统的hosts文件在&#x2F;etc目录下。</p>
<p>在hosts文件加入如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn</span><br></pre></td></tr></table></figure>



<p>3、在nginx-1.23.1目录中找到conf目录，配置目录下的nginx.conf文件。</p>
<p>配置内容如下，注意更改xc-ui-pc-static-portal目录的路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  www.51xuecheng.cn localhost;</span><br><span class="line">    #rewrite ^(.*) https:<span class="comment">//$server_name$1 permanent;</span></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    #静态资源</span><br><span class="line">        location /<span class="keyword">static</span>/img/ &#123;  </span><br><span class="line">        alias  E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/img/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /<span class="keyword">static</span>/css/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/css/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /<span class="keyword">static</span>/js/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/js/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /<span class="keyword">static</span>/plugins/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/plugins/;</span><br><span class="line">        add_header Access-Control-Allow-Origin http:<span class="comment">//ucenter.51xuecheng.cn;  </span></span><br><span class="line">        add_header Access-Control-Allow-Credentials <span class="literal">true</span>;  </span><br><span class="line">        add_header Access-Control-Allow-Methods GET;</span><br><span class="line">    &#125; </span><br><span class="line">    location /plugins/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/plugins/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #error_page  <span class="number">404</span>              /<span class="number">404.</span>html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the <span class="keyword">static</span> page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span></span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http:<span class="comment">//127.0.0.1;</span></span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span></span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, <span class="keyword">if</span> Apache<span class="string">&#x27;s document root</span></span><br><span class="line"><span class="string">        # concurs with nginx&#x27;</span>s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动nginx：</p>
<p>进入任务管理器，杀死nginx的两个进程</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image044-1711263841607117.gif" alt="img"></p>
<p>杀死后再次双击nginx.exe。</p>
<p>启动成功在任务管理器会出现nginx的进程。</p>
<p>日志文件在nginx安装目录下的logs目录：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image046-1711263841607118.gif" alt="img"></p>
<p>启动成功访问<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">http://www.51xuecheng.cn</a> </p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image048-1711263841607119.gif" alt="img"></p>
<h3 id="2-3-2-课程详情页面"><a href="#2-3-2-课程详情页面" class="headerlink" title="2.3.2 课程详情页面"></a><strong>2.3.2</strong> <strong>课程详情页面</strong></h3><p>course_template.html是一个静态html页面，里边还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容。</p>
<p>course_template.html文件在xc-ui-pc-static-portal\course目录下</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image050-1711263841607120.gif" alt="img"></p>
<p>通过浏览器访问：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/course_template.html">http://www.51xuecheng.cn/course/course_template.html</a></p>
<p>效果如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image052-1711263841607121.gif" alt="img"></p>
<p>出现这个画面说明模板文件正常浏览是没有问题的。</p>
<h3 id="2-3-3-文件服务器"><a href="#2-3-3-文件服务器" class="headerlink" title="2.3.3 文件服务器"></a><strong>2.3.3</strong> <strong>文件服务器</strong></h3><p>在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问。如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image054-1711263841607122.gif" alt="img"></p>
<p>在hosts文件配置如下内容，如果已存在不要重复配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> www.51xuecheng.cn file.51xuecheng.cn</span><br></pre></td></tr></table></figure>

<p>在nginx.conf中配置文件服务器的代理地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#文件服务</span><br><span class="line">    upstream fileserver&#123;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span>:<span class="number">9000</span> weight=<span class="number">10</span>;</span><br><span class="line">&#125; </span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  file.51xuecheng.cn;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line">    location /video &#123;</span><br><span class="line">        proxy_pass   http:<span class="comment">//fileserver;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /mediafiles &#123;</span><br><span class="line">        proxy_pass   http:<span class="comment">//fileserver;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完毕，重新加载nginx配置文件。</p>
<p>通过cmd进入nginx.exe所在目录,运行如下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure>

<p>通过<a target="_blank" rel="noopener" href="http://file.51xuecheng.cn/mediafiles/%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80">http://file.51xuecheng.cn/mediafiles/图片文件地址</a> 访问图片</p>
<p>在媒资数据库的文件表中找一个图片的地址进行测试。</p>
<h3 id="2-3-4-视频播放页面"><a href="#2-3-4-视频播放页面" class="headerlink" title="2.3.4 视频播放页面"></a><strong>2.3.4</strong> <strong>视频播放页面</strong></h3><p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image056-1711263841607123.gif" alt="img"></p>
<p>首先在nginx.conf中配置视频播放页面的地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /course/preview/learning.html &#123;</span><br><span class="line">    alias D:/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-<span class="keyword">static</span>-portal/course/learning.html;</span><br><span class="line">&#125; </span><br><span class="line">location /course/search.html &#123;  </span><br><span class="line">    root   D:/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-<span class="keyword">static</span>-portal;</span><br><span class="line">&#125; </span><br><span class="line">location /course/learning.html &#123;  </span><br><span class="line">    root   D:/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-<span class="keyword">static</span>-portal;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>加载nginx配置文件</p>
<p>点击课程详情页面上的视频播放链接，打开视频播放页面，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image057-1711263841607124.gif" alt="img"></p>
<p>下边需要配置learning.html页面的视频播放路径来测试视频播放页面，找到learning.html页面中videoObject对象的定义处，配置视频的播放地址。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image059-1711263841607126.gif" alt="img"></p>
<p>配置完成，刷新页面，观察视频是否可以正常播放。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image061-1711263841607125.gif" alt="img"></p>
<p>注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。</p>
<h2 id="2-4-接口定义"><a href="#2-4-接口定义" class="headerlink" title="2.4 接口定义"></a><strong>2.4</strong> <strong>接口定义</strong></h2><h3 id="2-4-1-定义课程预览接口"><a href="#2-4-1-定义课程预览接口" class="headerlink" title="2.4.1 定义课程预览接口"></a><strong>2.4.1</strong> <strong>定义课程预览接口</strong></h3><p>课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器。</p>
<p>下边对课程预览接口进行分析：</p>
<p>1、请求参数</p>
<p>传入课程id，表示要预览哪一门课程。</p>
<p>2、响应结果</p>
<p>输出课程详情页面到浏览器。</p>
<p>响应页面到浏览器使用freemarker模板引擎技术实现，首先从课程资料目录下获取课程预览页面course_template.html，拷贝至内容管理的接口工程的resources&#x2F;templates下，并将其在本目录复制一份命名为course_template.ftl</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711268014348159.gif" alt="img"></p>
<p>下边开始定义接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览，发布</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> ModelAndView <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">      modelAndView.addObject(<span class="string">&quot;model&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">      modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> modelAndView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/coursepreview/74">http://localhost:63040/content/coursepreview/74</a></p>
<p>如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711268014348160.gif" alt="img"></p>
<p>课程预览页面内容没有样式，稍后解决这个问题。</p>
<h3 id="2-4-2-配置反向代理"><a href="#2-4-2-配置反向代理" class="headerlink" title="2.4.2 配置反向代理"></a><strong>2.4.2</strong> <strong>配置反向代理</strong></h3><p>课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711268014348161.gif" alt="img"></p>
<p>这些静态资源全在门户下，我们需要由Nginx反向代理访问课程预览接口，通过门户的URL去访问课程预览。</p>
<p>1、在Nginx下配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#后台网关</span><br><span class="line">    upstream gatewayserver&#123;</span><br><span class="line">    server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">63010</span> weight=<span class="number">10</span>;</span><br><span class="line">&#125; </span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  www.51xuecheng.cn localhost;</span><br><span class="line">    ....</span><br><span class="line">        #api</span><br><span class="line">        location /api/ &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//gatewayserver/;</span></span><br><span class="line">    &#125; </span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>

<p>2、重新加载Nginx配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure>



<p>3、启动微服务网关</p>
<p>4、此时访问新地址： <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/74">http://www.51xuecheng.cn/api/content/coursepreview/74</a> </p>
<p>输出如下，页面样式正常。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711268014348163.gif" alt="img"></p>
<p>页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用service方式获取模型数据并进行页面渲染。</p>
<p>目前的方式是通过Nginx访问网关，由网关再将请求转发到微服务，Nginx是整个的项目最前方的代理服务器，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711268014348162.gif" alt="img"></p>
<h2 id="2-5-接口开发"><a href="#2-5-接口开发" class="headerlink" title="2.5 接口开发"></a><strong>2.5</strong> <strong>接口开发</strong></h2><h3 id="2-5-1-数据模型"><a href="#2-5-1-数据模型" class="headerlink" title="2.5.1 数据模型"></a><strong>2.5.1</strong> <strong>数据模型</strong></h3><p>课程预览就是把课程基本信息、营销信息、课程计划、师资等课程的相关信息进行整合，在预览页面进行展示。如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711268014348164.gif" alt="img"></p>
<p>在使用freemarker渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。</p>
<p>所以首先定义一个数据模型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览数据模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"> <span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePreviewDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程基本信息,课程营销信息</span></span><br><span class="line">    CourseBaseInfoDto courseBase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程计划信息</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplans;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//师资信息暂时不加...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CourseBaseInfoDto：包括了课程基本信息、营销信息。</p>
<p>List&lt;TeachplanDto&gt; ：包括了课程计划列表。</p>
<h3 id="2-5-2-Service接口"><a href="#2-5-2-Service接口" class="headerlink" title="2.5.2 Service接口"></a><strong>2.5.2 Service接口</strong></h3><p>Service负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成CoursePreviewDto 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览、发布接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:59</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoursePublishService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 获取课程预览信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CoursePreviewDto</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/16 15:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">   <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePreviewInfo</span><span class="params">(Long courseId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseBaseInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.TeachplanService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 15:37</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CoursePublishService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> TeachplanService teachplanService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePreviewInfo</span><span class="params">(Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程基本信息、营销信息</span></span><br><span class="line">  <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程计划信息</span></span><br><span class="line">  List&lt;TeachplanDto&gt; teachplanTree= teachplanService.findTeachplanTree(courseId);</span><br><span class="line"></span><br><span class="line">  <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDto</span>();</span><br><span class="line">  coursePreviewDto.setCourseBase(courseBaseInfo);</span><br><span class="line">  coursePreviewDto.setTeachplans(teachplanTree);</span><br><span class="line">  <span class="keyword">return</span> coursePreviewDto;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-3-接口层完善"><a href="#2-5-3-接口层完善" class="headerlink" title="2.5.3 接口层完善"></a><strong>2.5.3</strong> <strong>接口层完善</strong></h3><p>接口层Controller调用Service方法获取模板引擎需要的模型数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//获取课程预览信息</span></span><br><span class="line">     <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line"></span><br><span class="line">     <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">     modelAndView.addObject(<span class="string">&quot;model&quot;</span>,coursePreviewInfo);</span><br><span class="line">     modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> modelAndView;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-4-前后端联调"><a href="#2-5-4-前后端联调" class="headerlink" title="2.5.4 前后端联调"></a><strong>2.5.4</strong> <strong>前后端联调</strong></h3><p>原来前端直接指向后台网关地址，现在要更改为Nginx的地址，如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711268014348165.gif" alt="img"></p>
<p>重启前端工程，进入课程列表点击”预览”按钮，正常打开课程预览页面<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/2">http://www.51xuecheng.cn/api/content/coursepreview/2</a></p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711268014348166.gif" alt="img"></p>
<h3 id="2-5-5-编写模板"><a href="#2-5-5-编写模板" class="headerlink" title="2.5.5 编写模板"></a><strong>2.5.5</strong> <strong>编写模板</strong></h3><p>模型数据准备好后下一步将模型数据填充到course_template.ftl上，填充时注意不要一次填充太多，一边填充一边刷新调试。</p>
<p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p>
<p>修改模板后需要编译，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711268014348167.gif" alt="img"></p>
<p>在调试模板时，可以看出哪些信息有缺少，在课程管理处进行补充，比如下图显示课程计划信息不完整，需要进入课程计划界面添加课程计划。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711268014348168.gif" alt="img"></p>
<p>完整的course_template.ftl模板在课程资料目录下，差不多学会了freemarker标签的使用方法，将课程资料下的course_template.ftl覆盖自己的工程下的course_template.ftl。</p>
<h3 id="2-5-6-视频播放页面接口"><a href="#2-5-6-视频播放页面接口" class="headerlink" title="2.5.6 视频播放页面接口"></a><strong>2.5.6</strong> <strong>视频播放页面接口</strong></h3><p>从课程详情页面进入视频播放页面，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711268014348169.gif" alt="img"></p>
<p>在此页面需要从后台获取课程信息、根据课程计划获取对应的视频地址，下边编写这两个接口：</p>
<p>获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/open/content/course/whole/课程id</span><br><span class="line"></span><br><span class="line">响应：同课程预览service接口返回数据</span><br></pre></td></tr></table></figure>

<p>根据课程计划获取视频地址接口：&#x2F;open&#x2F;media&#x2F;preview&#x2F;{mediaId}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/open/media/preview/课程计划id</span><br><span class="line"></span><br><span class="line">响应：</span><br><span class="line">&#123;&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;,&quot;result&quot;:&quot;视频的url&quot;,&quot;successful&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>1、在nginx配置如下地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#openapi</span></span><br><span class="line">location /open/content/ &#123;</span><br><span class="line">        proxy_pass http://gatewayserver/content/open/;</span><br><span class="line">&#125; </span><br><span class="line">location /open/media/ &#123;</span><br><span class="line">        proxy_pass http://gatewayserver/media/open/;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p>配置运行nginx.exe -s reload加载nginx的配置文件 </p>
<p>2、在内容管理接口层定义CourseOpenController类，并定义接口：获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程公开查询接口&quot;,tags = &quot;课程公开查询接口&quot;)</span></span><br><span class="line"> <span class="meta">@RestController</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseOpenController</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CoursePreviewDto <span class="title function_">getPreviewInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">//获取课程预览信息</span></span><br><span class="line">    <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line">    <span class="keyword">return</span> coursePreviewInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、在媒资管理服务media-api工程定义MediaOpenController类，并定义接口&#x2F;open&#x2F;media&#x2F;preview&#x2F;</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;媒资文件管理接口&quot;,tags = &quot;媒资文件管理接口&quot;)</span></span><br><span class="line"> <span class="meta">@RestController</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaOpenController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  MediaFileService mediaFileService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;预览文件&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFileService.getFileById(mediaId);</span><br><span class="line">        <span class="keyword">if</span>(mediaFiles == <span class="literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl()))&#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;视频还没有转码处理&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(mediaFiles.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、测试</p>
<p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p>
<h1 id="3-课程审核"><a href="#3-课程审核" class="headerlink" title="3 课程审核"></a><strong>3</strong> <strong>课程审核</strong></h1><h2 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a><strong>3.1</strong> <strong>需求分析</strong></h2><h3 id="3-1-1-业务流程"><a href="#3-1-1-业务流程" class="headerlink" title="3.1.1 业务流程"></a><strong>3.1.1</strong> <strong>业务流程</strong></h3><p>根据模块需求分析，课程发布前要先审核，审核通过方可发布。下图是课程审核及发布的流程图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711273702556181.gif" alt="img"></p>
<p>为什么课程审核通过才可以发布呢？</p>
<p>这样做为了防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。</p>
<p>如何控制课程审核通过才可以发布课程呢？</p>
<p>在课程基本表course_base表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。</p>
<p>下边是课程状态的转化关系：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711273702556182.gif" alt="img"></p>
<p>说明如下：</p>
<p>1、一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。</p>
<p>2、课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。</p>
<p>3、当课程状态为已提交时运营平台人员对课程进行审核。</p>
<p>4、运营平台人员审核课程，结果有两个：审核通过、审核不通过。</p>
<p>5、课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。</p>
<p>6、课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。</p>
<p>7、课程发布后通过”下架“操作可以更改课程发布状态为”下架“</p>
<p>8、课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。</p>
<h3 id="3-1-2-数据模型"><a href="#3-1-2-数据模型" class="headerlink" title="3.1.2 数据模型"></a><strong>3.1.2</strong> <strong>数据模型</strong></h3><p>通过业务流程的分析，现在我们思考：</p>
<p>1、课程提交审核后还允许修改课程吗？</p>
<p>如果不允许修改是不合理的，因为提交审核后可以继续做下一个阶段的课程内容，比如添加课程计划，上传课程视频等。</p>
<p>如果允许修改那么课程审核时看到的课程内容从哪里来？如果也从课程基本信息表、课程营销表、课程计划表查询那么存在什么问题呢？如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711273702556184.gif" alt="img"></p>
<p>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突。比如：运营人员正在审核时教学机构把数据修改了。</p>
<p>为了解决这个问题，专门设计<strong>课程预发布表</strong>。</p>
<p>如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711273702556183.gif" alt="img"></p>
<p>提交课程审核，将课程信息汇总后写入课程预发布表，课程预发布表记录了教学机构在某个时间点要发布的课程信息。</p>
<p>课程审核人员从预发布表查询信息进行审核。</p>
<p>课程审核的同时可以对课程进行修改，修改的内容不会写入课程预发布表。</p>
<p>课程审核通过执行课程发布，将课程预发布表的信息写入课程发布表。</p>
<p>2、提交审核课程后，也修改了课程信息，可以再次提交审核吗？</p>
<p>这个问题在上边分析课程审核状态时已经有了答案，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711273702556185.gif" alt="img"></p>
<p><strong>提交审核课程后，必须等到课程审核完成才可以再次提交课程。</strong></p>
<p>课程审核功能涉及教学机构提交审核，运营人员进行课程审核。在课堂上我们仅实现教学机构提交审核功能，课程审核的结果通过手动修改数据库来实现。</p>
<p>虽然课堂上不实现课程审核功能，完整的课程审核数据表设计需要理解。</p>
<p>提交审核将信息写入课程预发布表，课程预发布表结构如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711273702556186.gif" alt="img"></p>
<p>更新课程基本信息表的课程审核状态为：已经提交</p>
<p>课程审核后更新课程基本信息表的审核状态、课程预发布表的审核状态，并将审核结果写入课程审核记录。</p>
<p>审核记录表结构如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711273702556187.gif" alt="img"></p>
<h2 id="3-2-接口定义"><a href="#3-2-接口定义" class="headerlink" title="3.2 接口定义"></a><strong>3.2</strong> <strong>接口定义</strong></h2><p>下边定义提交课程审核的接口，在课程发布Controller中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/courseaudit/commit/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-3-接口开发"><a href="#3-3-接口开发" class="headerlink" title="3.3 接口开发"></a><strong>3.3</strong> <strong>接口开发</strong></h2><h3 id="3-3-1-Dao开发"><a href="#3-3-1-Dao开发" class="headerlink" title="3.3.1 Dao开发"></a><strong>3.3.1 Dao开发</strong></h3><p>1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。</p>
<p>2、向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态为：已提交。</p>
<p>3、更新课程基本表course_base课程审核状态为：已提交。</p>
<p>约束：</p>
<p>1、对已提交审核的课程不允许提交审核。</p>
<p>2、本机构只允许提交本机构的课程。</p>
<p>3、没有上传图片不允许提交审核。</p>
<p>4、没有添加课程计划不允许提交审核。</p>
<p>使用代码生成器生成课程发布表、课程预发布表的PO、Mpper，并拷贝到相应的工程下。</p>
<h3 id="3-3-1-Service开发"><a href="#3-3-1-Service开发" class="headerlink" title="3.3.1 Service开发"></a><strong>3.3.1 Service开发</strong></h3><p>在课程发布Service类中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 提交审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/18 10:31</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId,Long courseId)</span>;</span><br></pre></td></tr></table></figure>



<p>接口实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//约束校验</span></span><br><span class="line"> <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line"> <span class="comment">//课程审核状态</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> courseBase.getAuditStatus();</span><br><span class="line"> <span class="comment">//当前审核状态为已提交不允许再次提交</span></span><br><span class="line"> <span class="keyword">if</span>(<span class="string">&quot;202003&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;当前为等待审核状态，审核完成可以再次提交。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line"> <span class="keyword">if</span>(!courseBase.getCompanyId().equals(companyId))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//课程图片是否填写</span></span><br><span class="line"> <span class="keyword">if</span>(StringUtils.isEmpty(courseBase.getPic()))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;提交失败，请上传课程图片&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//添加课程预发布记录</span></span><br><span class="line"> <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublishPre</span>();</span><br><span class="line"> <span class="comment">//课程基本信息加部分营销信息</span></span><br><span class="line"> <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line"> BeanUtils.copyProperties(courseBaseInfo,coursePublishPre);</span><br><span class="line"> <span class="comment">//课程营销信息</span></span><br><span class="line"> <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line"> <span class="comment">//转为json</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">courseMarketJson</span> <span class="operator">=</span> JSON.toJSONString(courseMarket);</span><br><span class="line"> <span class="comment">//将课程营销信息json数据放入课程预发布表</span></span><br><span class="line"> coursePublishPre.setMarket(courseMarketJson);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//查询课程计划信息</span></span><br><span class="line"> List&lt;TeachplanDto&gt; teachplanTree = teachplanService.findTeachplanTree(courseId);</span><br><span class="line"> <span class="keyword">if</span>(teachplanTree.size()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;提交失败，还没有添加课程计划&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//转json</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">teachplanTreeString</span> <span class="operator">=</span> JSON.toJSONString(teachplanTree);</span><br><span class="line"> coursePublishPre.setTeachplan(teachplanTreeString);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//设置预发布记录状态,已提交</span></span><br><span class="line"> coursePublishPre.setStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line"> <span class="comment">//教学机构id</span></span><br><span class="line"> coursePublishPre.setCompanyId(companyId);</span><br><span class="line"> <span class="comment">//提交时间</span></span><br><span class="line"> coursePublishPre.setCreateDate(LocalDateTime.now());</span><br><span class="line"> <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPreUpdate</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line"> <span class="keyword">if</span>(coursePublishPreUpdate == <span class="literal">null</span>)&#123;</span><br><span class="line">  <span class="comment">//添加课程预发布记录</span></span><br><span class="line">  coursePublishPreMapper.insert(coursePublishPre);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  coursePublishPreMapper.updateById(coursePublishPre);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//更新课程基本表的审核状态</span></span><br><span class="line"> courseBase.setAuditStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line"> courseBaseMapper.updateById(courseBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-接口完善"><a href="#3-4-接口完善" class="headerlink" title="3.4 接口完善"></a><strong>3.4</strong> <strong>接口完善</strong></h2><p>完善接口层的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/courseaudit/commit/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">     coursePublishService.commitAudit(companyId,courseId);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-5-接口测试"><a href="#3-5-接口测试" class="headerlink" title="3.5 接口测试"></a><strong>3.5</strong> <strong>接口测试</strong></h2><p>使用前端提前课程审核：</p>
<p>1、找一门信息不全的课程，测试各各约束条件。</p>
<p>2、正常提交后，观察数据库中课程预发布表记录的内容是否完整。</p>
<p>3、测试审核过后再次提交，提交后观察数据库中课程预发布表记录的内容是否正确。</p>
<p>审核通过需手动修改数据库：</p>
<p>1、修改课程预发布表的状态为审核通过202004。</p>
<p>2、修改课程基本表的审核状态为审核通过202004。</p>
<h1 id="4-课程发布"><a href="#4-课程发布" class="headerlink" title="4 课程发布"></a><strong>4</strong> <strong>课程发布</strong></h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a><strong>4.1</strong> <strong>需求分析</strong></h2><h3 id="4-1-1-数据模型"><a href="#4-1-1-数据模型" class="headerlink" title="4.1.1 数据模型"></a><strong>4.1.1</strong> <strong>数据模型</strong></h3><p>教学机构人员在课程审核通过后即可发布课程，课程发布后会公开展示在网站上供学生查看、选课和学习。</p>
<p>在网站上展示课程信息需要解决课程信息显示的性能问题，如果速度慢(排除网速)会影响用户的体验性。</p>
<p>如何去快速搜索课程？</p>
<p>打开课程详情页面仍然去查询数据库可行吗？</p>
<p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711291285108197.gif" alt="img"></p>
<p>1、向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表中发布状态为已发布。</p>
<p>2、向Redis存储课程缓存信息。</p>
<p>3、向Elasticsearch存储课程索引信息。</p>
<p>4、请求分布文件系统存储课程静态化页面(即html页面)，实现快速浏览课程详情页面。</p>
<p>课程发布表的数据来源于课程预发布表，它们的结构基本一样，只是课程发布表中的状态是课程发布状态，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711291285108195.gif" alt="img"></p>
<p>redis中的课程缓存信息是将课程发布表中的数据转为json进行存储。</p>
<p>elasticsearch中的课程索引信息是根据搜索需要将课程名称、课程介绍等信息进行索引存储。</p>
<p>MinIO中存储了课程的静态化页面文件（html网页），查看课程详情是通过文件系统去浏览课程详情页面。</p>
<h2 id="4-2-分布式事务技术方案"><a href="#4-2-分布式事务技术方案" class="headerlink" title="4.2 分布式事务技术方案"></a><strong>4.2</strong> <strong>分布式事务技术方案</strong></h2><h3 id="4-2-1-什么是分布式事务"><a href="#4-2-1-什么是分布式事务" class="headerlink" title="4.2.1 什么是分布式事务"></a><strong>4.2.1</strong> <strong>什么是分布式事务</strong></h3><p>一次课程发布操作需要向数据库、redis、elasticsearch、MinIO写四份数据，这里存在分布式事务问题。</p>
<p>什么是分布式事务？</p>
<p>首先理解什么是本地事务？</p>
<p>平常我们在程序中通过spring去控制事务是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，此数据库只属于该应用，所以基于本应用自己的关系型数据库的事务又被称为本地事务。 </p>
<p>本地事务具有ACID四大特性，数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作 要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。 </p>
<p>理解了本地事务，什么是分布式事务？</p>
<p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p>
<p>在分布式系统中分布式事务的场景很多：</p>
<p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p>
<p>拿转账举例：</p>
<p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line"><span class="comment">//1.本地数据库操作：张三减少金额 </span></span><br><span class="line"><span class="comment">//2.本地数据库操作：李四增加金额 </span></span><br><span class="line">commit transation; </span><br></pre></td></tr></table></figure>

<p>但是在分布式环境下，会变成下边这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line"><span class="comment">//1.本地数据库操作：张三减少金额 </span></span><br><span class="line"><span class="comment">//2.远程调用：让李四增加金额 </span></span><br><span class="line">commit transation;</span><br></pre></td></tr></table></figure>

<p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。 </p>
<p>因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应 用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。 </p>
<p>下边的场景都会产生分布式事务：</p>
<p>微服务架构下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711291285108196.gif" alt="img"></p>
<p>单服务多数据库：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711291285108198.gif" alt="img"></p>
<p>多服务单数据库:</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711291285108199.gif" alt="img"></p>
<h3 id="4-2-2-什么是CAP理论"><a href="#4-2-2-什么是CAP理论" class="headerlink" title="4.2.2 什么是CAP理论"></a><strong>4.2.2</strong> <strong>什么是CAP理论</strong></h3><p>控制分布式事务首先需要理解CAP理论，什么是CAP理论？</p>
<p>CAP是 Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p>
<p>使用下边的分布式系统结构 进行说明：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711291285108205.gif" alt="img"></p>
<p>客户端经过网关访问用户服务的两个结点，一致性是指用户不管访问哪一个结点拿到的数据都是最新的，比如查询小明的信息，不能出现在数据没有改变的情况下两次查询结果不一样。</p>
<p>可用性是指任何时候查询用户信息都可以查询到结果，但不保证查询到最新的数据。</p>
<p>分区容忍性也叫分区容错性，当系统采用分布式架构时由于网络通信异常导致请求中断、消息丢失，但系统依然对外提供服务。</p>
<p>CAP理论要强调的是在分布式系统中这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。</p>
<p>满足P那么C和A不能同时满足：</p>
<p>比如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711291285108200.gif" alt="img"></p>
<p>如果要满足C一致性，必须等待小明的信息同步完成系统才可用（否则会出现请求到结点2时查询不到数据，违反了一致性），在信息同步过程中系统是不可用的，所以满足C的同时无法满足A。</p>
<p>如果要满足A可用性，要时刻保证系统可用就不用等待信息同步完成，此时系统的一致性无法满足。</p>
<p>所以在分布式系统中进行分布式事务控制，要么保证CP、要么保证AP。</p>
<h3 id="4-2-3-分布式事务控制方案"><a href="#4-2-3-分布式事务控制方案" class="headerlink" title="4.2.3 分布式事务控制方案"></a><strong>4.2.3</strong> <strong>分布式事务控制方案</strong></h3><p>学习了CAP理论该如何控制分布式事务呢？</p>
<p>学习了CAP理论我们知道进行分布式事务控制要在C和A中作出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要CP还是AP，具体要根据应用场景进行判断。</p>
<p>CP的场景：满足C舍弃A，强调一致性。</p>
<p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p>
<p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p>
<p>AP的场景：满足A舍弃C，强调可用性。</p>
<p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p>
<p>注册送积分，注册成功积分在24分到账。</p>
<p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p>
<p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了BASE理论。</p>
<p>什么是BASE理论？</p>
<p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。</p>
<p>基本可用：当系统无法满足全部可用时保证核心服务可用即可，比如一个外卖系统，每到中午12点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p>
<p>软状态：是指可以存在中间状态，比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在XXX时间后查收。虽然出现了中间状态，但最终状态是正确的。</p>
<p>最终一致性：退款操作后没有及时到账，经过一定的时间后账户到账，舍弃强一致性，满足最终一致性。</p>
<p>分布式事务控制有哪些常用的技术方案？</p>
<p>实现CP就是要实现强一致性:</p>
<p>使用Seata框架基于AT模式实现</p>
<p>使用Seata框架基于TCC模式实现。</p>
<p>实现AP则要保证最终数据一致性:</p>
<p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p>
<p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到elasticsearch、MinIO、redis中。</p>
<h3 id="4-2-4-课程发布的事务控制方案"><a href="#4-2-4-课程发布的事务控制方案" class="headerlink" title="4.2.4 课程发布的事务控制方案"></a><strong>4.2.4</strong> <strong>课程发布的事务控制方案</strong></h3><p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO写四份数据，这个场景用哪种方案？</p>
<p>满足CP？</p>
<p>如果要满足CP就表示课程发布操作后向数据库、redis、elasticsearch、MinIO写四份数据，只要有一份写失败其它的全部回滚。</p>
<p>满足AP？</p>
<p>课程发布操作后，先更新数据库中的课程发布状态，更新后向redis、elasticsearch、MinIO写课程信息，只要在一定时间内最终向redis、elasticsearch、MinIO写数据成功即可。</p>
<p>目前我们已经有了任务调度的技术积累，这里选用任务调度的方案去实现分布式事务控制，课程发布满足AP即可。</p>
<p>下图是具体的技术方案：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711291285108201.gif" alt="img"></p>
<p>1、在内容管理服务的数据库中添加一个消息表，消息表和课程发布表在同一个数据库。</p>
<p>2、点击课程发布通过本地事务向课程发布表写入课程发布信息，同时向消息表写课程发布的消息。通过数据库进行控制，只要课程发布表插入成功消息表也插入成功，消息表的数据就记录了某门课程发布的任务。</p>
<p>3、启动任务调度系统定时调度内容管理服务去定时扫描消息表的记录。</p>
<p>4、当扫描到课程发布的消息时即开始完成向redis、elasticsearch、MinIO同步数据的操作。</p>
<p>5、同步数据的任务完成后删除消息表记录。</p>
<p>时序图如下：</p>
<p>下图是课程发布操作的流程：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711291285108202.gif" alt="img"></p>
<p>1、执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p>
<p>2、任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p>
<p>3、拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p>
<p>4、任务完成后删除消息表记录。</p>
<h2 id="4-3-课程发布接口"><a href="#4-3-课程发布接口" class="headerlink" title="4.3 课程发布接口"></a><strong>4.3</strong> <strong>课程发布接口</strong></h2><h3 id="4-3-1-接口定义"><a href="#4-3-1-接口定义" class="headerlink" title="4.3.1 接口定义"></a><strong>4.3.1</strong> <strong>接口定义</strong></h3><p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p>
<p>在内容管理接口工程中定义课程发布接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览，发布</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程预览发布接口&quot;,tags = &quot;课程预览发布接口&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishController</span> &#123;</span><br><span class="line">...</span><br><span class="line"> <span class="meta">@ApiOperation(&quot;课程发布&quot;)</span></span><br><span class="line"> <span class="meta">@ResponseBody</span></span><br><span class="line"> <span class="meta">@PostMapping</span> (<span class="string">&quot;/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-接口开发"><a href="#4-3-3-接口开发" class="headerlink" title="4.3.3 接口开发"></a><strong>4.3.3</strong> <strong>接口开发</strong></h3><h4 id="4-3-3-1-DAO开发"><a href="#4-3-3-1-DAO开发" class="headerlink" title="4.3.3.1 DAO开发"></a><strong>4.3.3.1 DAO开发</strong></h4><p>课程发布操作对数据库操作如下：</p>
<p>1、向课程发布表course_publish插入一条记录,记录来源于课程预发布表，如果存在则更新，发布状态为：已发布。</p>
<p>2、更新course_base表的课程发布状态为：已发布</p>
<p>3、删除课程预发布表的对应记录。</p>
<p>4、向mq_message消息表插入一条消息，消息类型为：course_publish</p>
<p>约束：</p>
<p>1、课程审核通过方可发布。</p>
<p>2、本机构只允许发布本机构的课程。</p>
<p>以上功能使用自动生成的mapper接口即可完成。</p>
<p>1、在内容管理数据库创建mq_message消息表及消息历史消息表（历史表存储已经完成的消息）。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711291285108203.gif" alt="img"></p>
<p>消息表结构如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711291285108204.gif" alt="img"></p>
<p>2、生成mq_message消息表、course_publish课程发布表的po和mapper接口</p>
<p>稍后会开发一个通用的消息处理组件，这里先不生成代码。</p>
<h4 id="4-3-3-2-Service开发"><a href="#4-3-3-2-Service开发" class="headerlink" title="4.3.3.2 Service开发"></a><strong>4.3.3.2 Service开发</strong></h4><p>定义Service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程发布接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 16:23</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId,Long courseId)</span>;</span><br></pre></td></tr></table></figure>

<p>编写课程发布的Service方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//约束校验</span></span><br><span class="line">  <span class="comment">//查询课程预发布表</span></span><br><span class="line">  <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">     XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line">  <span class="keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;</span><br><span class="line">   XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程审核状态</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line">  <span class="comment">//审核通过方可发布</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="string">&quot;202004&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">   XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//保存课程发布信息</span></span><br><span class="line">  saveCoursePublish(courseId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//保存消息表</span></span><br><span class="line">  saveCoursePublishMessage(courseId);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//删除课程预发布表对应记录</span></span><br><span class="line">  coursePublishPreMapper.deleteById(courseId);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存课程发布信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublish</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">   <span class="comment">//整合课程发布信息</span></span><br><span class="line">  <span class="comment">//查询课程预发布表</span></span><br><span class="line">  <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">   XueChengPlusException.cast(<span class="string">&quot;课程预发布数据为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublish</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//拷贝到课程发布对象</span></span><br><span class="line">  BeanUtils.copyProperties(coursePublishPre,coursePublish);</span><br><span class="line">  coursePublish.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">  <span class="type">CoursePublish</span> <span class="variable">coursePublishUpdate</span> <span class="operator">=</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(coursePublishUpdate == <span class="literal">null</span>)&#123;</span><br><span class="line">   coursePublishMapper.insert(coursePublish);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   coursePublishMapper.updateById(coursePublish);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//更新课程基本表的发布状态</span></span><br><span class="line">  <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">  courseBase.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">  courseBaseMapper.updateById(courseBase);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 保存消息表记录，稍后实现</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublishMessage</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-3-接口完善"><a href="#4-3-3-3-接口完善" class="headerlink" title="4.3.3.3 接口完善"></a><strong>4.3.3.3</strong> <strong>接口完善</strong></h4><p>完善接口层代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程发布&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    coursePublishService.publish(companyId,courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-4-接口测试"><a href="#4-3-4-接口测试" class="headerlink" title="4.3.4 接口测试"></a><strong>4.3.4</strong> <strong>接口测试</strong></h3><p>先使用httpclient方法测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程发布</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/coursepublish/<span class="number">2</span></span><br></pre></td></tr></table></figure>



<p>先测试约束条件：</p>
<p>1、在未提交审核时进行课程发布测试。</p>
<p>2、在课程未审核通过时进行发布。</p>
<p>正常流程测试：</p>
<p>1、提交审核课程</p>
<p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p>
<p>3、执行课程发布</p>
<p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p>
<p>使用前后端联调方式测试。</p>
<h2 id="4-4-消息处理SDK"><a href="#4-4-消息处理SDK" class="headerlink" title="4.4 消息处理SDK"></a><strong>4.4</strong> <strong>消息处理SDK</strong></h2><h3 id="4-4-1-消息模块技术方案"><a href="#4-4-1-消息模块技术方案" class="headerlink" title="4.4.1 消息模块技术方案"></a><strong>4.4.1</strong> <strong>消息模块技术方案</strong></h3><p>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image024-1711291285108208.gif" alt="img"></p>
<p>上图中红色框内的都是与消息处理相关的操作：</p>
<p>1、新增消息表</p>
<p>2、扫描消息表。</p>
<p>3、更新消息表。</p>
<p>4、删除消息表。</p>
<p>使用消息表这种方式实现最终事务一致性的地方除了课程发布还有其它业务场景。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image026-1711291285108206.gif" alt="img"></p>
<p>如果在每个地方都实现一套针对消息表定时扫描、处理的逻辑基本上都是重复的，软件的可复用性太低，成本太高。</p>
<p>如何解决这个问题？</p>
<p>针对这个问题可以想到将消息处理相关的逻辑做成一个通用的东西。</p>
<p>是做成通用的服务，还是做成通用的代码组件呢？</p>
<p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p>
<p>代码组件也是完成一个通用的独立功能，通常会提供API的方式供外部系统使用，比如：fastjson、Apache commons工具包等。</p>
<p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且要提供与微服务通信的网络接口，单就针对当前需求而言开发成本有点高。</p>
<p>如果将消息处理做一个SDK工具包相比通用服务不仅可以解决将消息处理通用化的需求，还可以降低成本。</p>
<p>所以，本项目确定将对消息表相关的处理做成一个SDK组件供各微服务使用,如下图所示：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image028-1711291285108207.gif" alt="img"></p>
<p>下边对消息SDK的设计内容进行说明：</p>
<p>sdk需要提供执行任务的逻辑吗？</p>
<p>拿课程发布任务举例，执行课程发布任务是要向redis、索引库等同步数据，其它任务的执行逻辑是不同的，所以执行任务在sdk中不用实现任务逻辑，只需要提供一个抽象方法由具体的执行任务方去实现。</p>
<p>如何保证任务的幂等性？</p>
<p>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案，任务执行完成后会从消息表删除，如果消息的状态是完成或不存在消息表中则不用执行。</p>
<p>如何保证任务不重复执行？</p>
<p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用分片广播，根据分片参数去获取任务，另外阻塞调度策略为丢弃任务。</p>
<p>注意：这里是信息同步类任务，即使任务重复执行也没有关系，不再使用抢占任务的方式保证任务不重复执行。</p>
<p>还有一个问题，根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，如果一个任务有好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到redis、存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里该如何设计？</p>
<p>将小任务作为任务的不同的阶段，在消息表中设计阶段状态。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image030-1711291285108210.gif" alt="img"></p>
<p>每完成一个阶段在相应的阶段状态字段打上完成标记，即使这个大任务没有完成再重新执行时，如果小阶段任务完成了也不会重复执行某个小阶段的任务。</p>
<p>综上所述，除了消息表的基本的增、删、改、查的接口外，消息SDK还具有如下接口功能：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  服务类</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-09-21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MqMessageService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;MqMessage&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 扫描消息表记录，采用与扫描视频处理表相同的思路</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 扫描记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List 消息记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 18:55</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MqMessage&gt; <span class="title function_">getMessageList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal,  String messageType,<span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 完成任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completed</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 完成阶段任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageOne</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageTwo</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageThree</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageFour</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询阶段状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:54</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageOne</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageTwo</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageThree</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageFour</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>消息SDK提供消息处理抽象类，此抽象类供使用方去继承使用，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息处理抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 19:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqMessage 执行任务内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean true:处理成功，false处理失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 任务处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 19:47</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 扫描消息表多线程执行任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType  消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  一次取出任务总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:35</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal,  String messageType,<span class="type">int</span> count,<span class="type">long</span> timeout)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//扫描消息表获取任务清单</span></span><br><span class="line">            List&lt;MqMessage&gt; messageList = mqMessageService.getMessageList(shardIndex, shardTotal,messageType, count);</span><br><span class="line">            <span class="comment">//任务个数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> messageList.size();</span><br><span class="line">            log.debug(<span class="string">&quot;取出待处理消息&quot;</span>+size+<span class="string">&quot;条&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(size&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建线程池</span></span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">            <span class="comment">//计数器</span></span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">            messageList.forEach(message -&gt; &#123;</span><br><span class="line">                threadPool.execute(() -&gt; &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始任务:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                    <span class="comment">//处理任务</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> execute(message);</span><br><span class="line">                        <span class="keyword">if</span>(result)&#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;)&quot;</span>,message);</span><br><span class="line">                            <span class="comment">//更新任务状态,删除消息表记录,添加到历史表</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">completed</span> <span class="operator">=</span> mqMessageService.completed(message.getId());</span><br><span class="line">                            <span class="keyword">if</span> (completed&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行失败:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        log.debug(<span class="string">&quot;任务出现异常:&#123;&#125;,任务:&#123;&#125;&quot;</span>,e.getMessage(),message);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//计数</span></span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                    log.debug(<span class="string">&quot;结束任务:&#123;&#125;&quot;</span>,message);</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">            countDownLatch.await(timeout,TimeUnit.SECONDS);</span><br><span class="line">            System.out.println(<span class="string">&quot;结束....&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-2-消息模块SDK测试"><a href="#4-4-2-消息模块SDK测试" class="headerlink" title="4.4.2 消息模块SDK测试"></a><strong>4.4.2</strong> <strong>消息模块SDK测试</strong></h3><p>1、在内容管理数据库创建消息表和消息历史表</p>
<p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711291285108209.gif" alt="img"></p>
<p>3、修改test下的bootstrap.yml中的数据库连接</p>
<p>下边测试消息SDK的接口：</p>
<p>1、继承MessageProcessAbstract 抽象类编写任务执行方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息处理测试类，继承MessageProcessAbstract</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 21:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProcessClass</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        log.debug(<span class="string">&quot;开始执行任务:&#123;&#125;&quot;</span>,id);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取出阶段状态</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span>(stageOne&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始执行第一阶段任务&quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> mqMessageService.completedStageOne(id);</span><br><span class="line">            <span class="keyword">if</span>(i&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;完成第一阶段任务&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;无需执行第一阶段任务&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、编写测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 21:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProcessClassTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageProcessClass messageProcessClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;开始执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        messageProcessClass.process(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;test&quot;</span>, <span class="number">5</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;结束执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        Thread.sleep(<span class="number">9000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、准备测试数据，在消息表添加消息类型为”test”的消息</p>
<p>4、执行MessageProcessClassTest 类中的test()方法，观察控制台任务执行的日志信息。</p>
<h3 id="4-4-3-集成消息SDK"><a href="#4-4-3-集成消息SDK" class="headerlink" title="4.4.3 集成消息SDK"></a><strong>4.4.3</strong> <strong>集成消息SDK</strong></h3><h4 id="4-4-3-1-添加消息"><a href="#4-4-3-1-添加消息" class="headerlink" title="4.4.3.1 添加消息"></a><strong>4.4.3.1</strong> <strong>添加消息</strong></h4><p>1、在内容管理数据库创建消息表和消息历史表</p>
<p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711291285108209.gif" alt="img"></p>
<p>3、在内容管理service工程中添加sdk依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-message-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、课程发布操作使用本地事务保存课程发布信息、添加消息表。</p>
<p>回到当初编写课程发布时的代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//约束校验</span></span><br><span class="line"> <span class="comment">//查询课程预发布表</span></span><br><span class="line"> <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line"> <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">    XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line"> <span class="keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//课程审核状态</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line"> <span class="comment">//审核通过方可发布</span></span><br><span class="line"> <span class="keyword">if</span>(!<span class="string">&quot;202004&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//保存课程发布信息</span></span><br><span class="line"> saveCoursePublish(courseId);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//保存消息表</span></span><br><span class="line"> saveCoursePublishMessage(courseId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除课程预发布表对应记录</span></span><br><span class="line"> coursePublishPreMapper.deleteById(courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要填充的saveCoursePublishMessage(courseId)方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 保存消息表记录</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublishMessage</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">&quot;course_publish&quot;</span>, String.valueOf(courseId), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span>(mqMessage==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(CommonError.UNKOWN_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边进行测试：</p>
<p>发布一门课程，观察消息表是否正常添加消息。</p>
<p>需要手动修改课程审核状态为审核通过执行发布操作，发布后可以修改发布状态为下架重新发布测试。</p>
<h4 id="4-4-3-2-课程发布任务处理"><a href="#4-4-3-2-课程发布任务处理" class="headerlink" title="4.4.3.2 课程发布任务处理"></a><strong>4.4.3.2</strong> <strong>课程发布任务处理</strong></h4><p>在内容管理服务添加消息处理sdk的依赖即可使用它，实现sdk中的MessageProcessAbstract类，重写execte方法。</p>
<p>实现sdk中的MessageProcessAbstract类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/22 10:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程发布任务处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span> &#123;</span><br><span class="line">        <span class="comment">//获取消息相关的业务信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">businessKey1</span> <span class="operator">=</span> mqMessage.getBusinessKey1();</span><br><span class="line">        <span class="type">long</span> <span class="variable">courseId</span> <span class="operator">=</span> Integer.parseInt(businessKey1);</span><br><span class="line">        <span class="comment">//课程静态化</span></span><br><span class="line">        generateCourseHtml(mqMessage,courseId);</span><br><span class="line">        <span class="comment">//课程索引</span></span><br><span class="line">        saveCourseIndex(mqMessage,courseId);</span><br><span class="line">        <span class="comment">//课程缓存</span></span><br><span class="line">        saveCourseCache(mqMessage,courseId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成课程静态化页面并上传至文件系统</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateCourseHtml</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="comment">//消息id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        <span class="comment">//消息处理的service</span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">        <span class="comment">//消息幂等性处理</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span>(stageOne &gt;<span class="number">0</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;课程静态化已处理直接返回，课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存第一阶段状态</span></span><br><span class="line">        mqMessageService.completedStageOne(id);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将课程信息缓存至redis</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseCache</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;将课程信息缓存至redis,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存课程索引信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseIndex</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;保存课程索引信息,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-3-3-开启任务调度"><a href="#4-4-3-3-开启任务调度" class="headerlink" title="4.4.3.3 开启任务调度"></a><strong>4.4.3.3</strong> <strong>开启任务调度</strong></h4><p>1、首先在内容管理service工程中添加xxl-job依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置执行器</p>
<p>在nacos中在content-service-dev.yaml中配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">coursepublish-job</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">8999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>

<p>3、从媒资管理服务层工程中拷贝一个XxlJobConfig配置类到内容管理service工程中。</p>
<p>在xxl-job-admin控制台中添加执行器</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image034-1711291285108211.gif" alt="img"></p>
<p>3、编写任务调度入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//任务调度入口</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;CoursePublishJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursePublishJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">        log.debug(<span class="string">&quot;shardIndex=&quot;</span>+shardIndex+<span class="string">&quot;,shardTotal=&quot;</span>+shardTotal);</span><br><span class="line">        <span class="comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span></span><br><span class="line">        process(shardIndex,shardTotal,<span class="string">&quot;course_publish&quot;</span>,<span class="number">30</span>,<span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>



<p>4、在xxl-job添加任务</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image036-1711291285108212.gif" alt="img"></p>
<p>任务配置如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image038-1711291285108213.gif" alt="img"></p>
<p>到此SDK开发、集成完成，下一步添加课程发布后页面静态化、课程缓存、课程索引等任务。</p>
<h4 id="4-4-3-4-测试"><a href="#4-4-3-4-测试" class="headerlink" title="4.4.3.4 测试"></a><strong>4.4.3.4</strong> <strong>测试</strong></h4><p>在消息表添加课程发布的消息，消息类型为course_publish,business_key1为发布课程的ID</p>
<p>1、测试是否可以正常调度执行。</p>
<p>2、测试任务幂等性</p>
<p>在 saveCourseCache(mqMessage,courseId);处打断点，待执行到这里观察数据库第一阶段完成的标记预期标记为1。</p>
<p>结束进程，再重新启动，观察第一阶段的任务预期不再执行。</p>
<p>3、任务执行完成删除消息表记录，插入历史表，state状态字段为1</p>
<h2 id="4-5-页面静态化"><a href="#4-5-页面静态化" class="headerlink" title="4.5 页面静态化"></a><strong>4.5</strong> <strong>页面静态化</strong></h2><h3 id="4-5-1-什么是页面静态化"><a href="#4-5-1-什么是页面静态化" class="headerlink" title="4.5.1 什么是页面静态化"></a><strong>4.5.1</strong> <strong>什么是页面静态化</strong></h3><p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统。</p>
<p>什么是页面静态化？</p>
<p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，服务端渲染的并发能力是有限的。</p>
<p>页面静态化则强调将生成html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时直接请求html页面，由于是静态页面可以使用nginx、apache等高性能的web服务器，并发性能高。</p>
<p>什么时候能用页面静态化技术？</p>
<p>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p>
<p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p>
<h3 id="4-5-2-静态化测试"><a href="#4-5-2-静态化测试" class="headerlink" title="4.5.2 静态化测试"></a><strong>4.5.2</strong> <strong>静态化测试</strong></h3><p>下边使用freemarker技术对页面静态化生成html页面。</p>
<p>在内容管理service工程中添加freemarker依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>编写测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Configuration;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Template;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.TemplateException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.freemarker.FreeMarkerTemplateUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> freemarker测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 18:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试页面静态化</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenerateHtmlByTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        <span class="comment">//配置freemarker</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.getVersion());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模板</span></span><br><span class="line">        <span class="comment">//选指定模板路径,classpath下templates下</span></span><br><span class="line">        <span class="comment">//得到classpath路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(classpath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        <span class="comment">//设置字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定模板文件名称</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备数据</span></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(<span class="number">2L</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//静态化</span></span><br><span class="line">        <span class="comment">//参数1：模板，参数2：数据模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">//将静态化内容输出到文件中</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> IOUtils.toInputStream(content);</span><br><span class="line">        <span class="comment">//输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;D:\\develop\\test.html&quot;</span>);</span><br><span class="line">        IOUtils.copy(inputStream, outputStream);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将content-api工程下的模板拷贝到content-service工程下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image040-1711291285108216.gif" alt="img"></p>
<p>执行测试方法，观察D:\develop\test.html 是否成功生成。</p>
<h3 id="4-5-3-上传文件测试"><a href="#4-5-3-上传文件测试" class="headerlink" title="4.5.3 上传文件测试"></a><strong>4.5.3</strong> <strong>上传文件测试</strong></h3><h4 id="4-5-3-1-配置远程调用环境"><a href="#4-5-3-1-配置远程调用环境" class="headerlink" title="4.5.3.1 配置远程调用环境"></a><strong>4.5.3.1</strong> <strong>配置远程调用环境</strong></h4><p>静态化生成文件后需要上传至分布式文件系统，根据微服务的职责划分，媒资管理服务负责维护文件系统中的文件，所以内容管理服务对页面静态化生成html文件需要调用媒资管理服务的上传文件接口。如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711291285108202.gif" alt="img"></p>
<p>微服务之间难免会存在远程调用，在Spring Cloud中可以使用Feign进行远程调用，</p>
<p>Feign是一个声明式的http客户端，官方地址：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p>
<p>下边先准备Feign的开发环境:</p>
<p>1、在内容管理content-service工程添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--feign支持Multipart格式传参--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、在nacos配置feign-dev.yaml公用配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">30000</span>  <span class="comment">#熔断超时时间</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">60000</span> <span class="comment">#连接超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">60000</span> <span class="comment">#读超时时间</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span> <span class="comment">#重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换实例的重试次数</span></span><br></pre></td></tr></table></figure>



<p>3、在内容管理service工程和内容管理api工程都引入此配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">feign-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>4、在内容管理service工程配置feign支持Multipart，拷贝课程资料下的MultipartSupportConfig 到content-service工程下的config包下。</p>
<h4 id="4-5-3-2-扩充上传文件接口"><a href="#4-5-3-2-扩充上传文件接口" class="headerlink" title="4.5.3.2 扩充上传文件接口"></a><strong>4.5.3.2</strong> <strong>扩充上传文件接口</strong></h4><p>现在需要将课程的静态文件上传到minio，单独存储到course目录下，文件的objectname为”课程id.html”，原有的上传文件接口需要增加一个参数 objectname。</p>
<p>下边扩充媒资服务的上传文件接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(value= &quot;objectName&quot;,required=false)</span> String objectName)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">                                  <span class="comment">//....</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>service接口也增加一个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 上传文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件磁盘路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath,String objectName)</span>;</span><br></pre></td></tr></table></figure>



<p>修改原有uploadFile方法，判断如果objectName为空则采取年月日样式的路径方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储到minio中的对象名(带目录)</span></span><br><span class="line"><span class="keyword">if</span>(StringUtils.isEmpty(objectName))&#123;</span><br><span class="line">    objectName =  defaultFolderPath + fileMd5 + extension;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//        String objectName = defaultFolderPath + fileMd5 + extension;</span></span><br></pre></td></tr></table></figure>

<h4 id="4-5-3-3-远程调用测试"><a href="#4-5-3-3-远程调用测试" class="headerlink" title="4.5.3.3 远程调用测试"></a><strong>4.5.3.3</strong> <strong>远程调用测试</strong></h4><p>在content-service下编写feign接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.feignclient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.config.MultipartSupportConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestPart;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资管理服务远程接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/media/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">uploadFile</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,<span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在启动类添加@EnableFeignClients注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure>

<p>编写测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.feignclient.MediaServiceClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试使用feign远程上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignUploadTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaServiceClient mediaServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程调用，上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="type">MultipartFile</span> <span class="variable">multipartFile</span> <span class="operator">=</span> MultipartSupportConfig.getMultipartFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\test.html&quot;</span>));</span><br><span class="line">        mediaServiceClient.uploadFile(multipartFile,<span class="string">&quot;course&quot;</span>,<span class="string">&quot;test.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边进行测试，启动媒资服务，执行测试方法，上传文件成功，进入minIO查看文件</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image042-1711291285108215.gif" alt="img"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html">http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html</a></p>
<p>查看是否可以正常访问。</p>
<h3 id="4-5-4-熔断降级处理"><a href="#4-5-4-熔断降级处理" class="headerlink" title="4.5.4 熔断降级处理"></a><strong>4.5.4</strong> <strong>熔断降级处理</strong></h3><h4 id="4-5-4-1-什么是熔断降级"><a href="#4-5-4-1-什么是熔断降级" class="headerlink" title="4.5.4.1 什么是熔断降级"></a><strong>4.5.4.1</strong> <strong>什么是熔断降级</strong></h4><p>微服务中难免存在服务之间的远程调用，比如：内容管理服务远程调用媒资服务的上传文件接口，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应。</p>
<p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉，比如：服务B调用服务A，由于A服务异常导致B服务响应缓慢，最后B、C等服务都不可用，像这样由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image044-1711291285108214.gif" alt="img"></p>
<p>如何解决由于微服务异常引起的雪崩效应呢？</p>
<p>可以采用熔断、降级的方法去解决。</p>
<p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系。</p>
<p>熔断：</p>
<p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image046-1711291285108217.gif" alt="img"></p>
<p>降级：</p>
<p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image048-1711291285108218.gif" alt="img"></p>
<p>两者都是为了保护系统，熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法。</p>
<h4 id="4-5-4-2-熔断降级处理"><a href="#4-5-4-2-熔断降级处理" class="headerlink" title="4.5.4.2 熔断降级处理"></a><strong>4.5.4.2</strong> <strong>熔断降级处理</strong></h4><p>项目使用Hystrix框架实现熔断、降级处理，在feign-dev.yaml中配置。</p>
<p>1、开启Feign熔断保护</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  hystrix:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  circuitbreaker:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>2、设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hystrix:</span><br><span class="line">  command:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      execution:</span><br><span class="line">        isolation:</span><br><span class="line">          thread:</span><br><span class="line">            timeoutInMilliseconds: <span class="number">30000</span>  #熔断超时时间</span><br><span class="line">ribbon:</span><br><span class="line">  ConnectTimeout: <span class="number">60000</span> #连接超时时间</span><br><span class="line">  ReadTimeout: <span class="number">60000</span> #读超时时间</span><br><span class="line">  MaxAutoRetries: <span class="number">0</span> #重试次数</span><br><span class="line">  MaxAutoRetriesNextServer: <span class="number">1</span> #切换实例的重试次数</span><br></pre></td></tr></table></figure>



<p>3、定义降级逻辑</p>
<p>两种方法：</p>
<p>1）fallback </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class,fallback = MediaServiceClientFallback.class)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span>&#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口。</p>
<p>第一种方法无法取出熔断所抛出的异常，第二种方法定义MediaServiceClientFallbackFactory 可以解决这个问题。</p>
<p>2）fallbackFactory </p>
<p>第二种方法在FeignClient中指定fallbackFactory ，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class,fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br></pre></td></tr></table></figure>



<p>定义MediaServiceClientFallbackFactory如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;MediaServiceClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MediaServiceClient</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(MultipartFile upload, String objectName)</span> &#123;</span><br><span class="line">                <span class="comment">//降级方法</span></span><br><span class="line">                log.debug(<span class="string">&quot;调用媒资管理服务上传文件时发生熔断，异常信息:&#123;&#125;&quot;</span>,throwable.toString(),throwable);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>降级处理逻辑：</p>
<p>返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p>
<p>测试：</p>
<p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p>
<h3 id="4-5-4-课程静态化开发"><a href="#4-5-4-课程静态化开发" class="headerlink" title="4.5.4 课程静态化开发"></a><strong>4.5.4</strong> <strong>课程静态化开发</strong></h3><p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理SDK去调度执行。</p>
<h4 id="4-5-4-1-静态化实现"><a href="#4-5-4-1-静态化实现" class="headerlink" title="4.5.4.1 静态化实现"></a><strong>4.5.4.1</strong> <strong>静态化实现</strong></h4><p>课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。</p>
<p>在课程发布的service编写这两部分内容，最后通过消息去调度执行。</p>
<p>1、接口定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程静态化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> File 静态化文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/23 16:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">generateCourseHtml</span><span class="params">(Long courseId)</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传课程静态化页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file  静态化文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/23 16:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">uploadCourseHtml</span><span class="params">(Long courseId,File file)</span>;</span><br></pre></td></tr></table></figure>



<p>2、接口实现</p>
<p>将之前编写的静态化测试代码以及上传静态文件测试代码拷贝过来使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">generateCourseHtml</span><span class="params">(Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//静态化文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">htmlFile</span>  <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//配置freemarker</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.getVersion());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模板</span></span><br><span class="line">        <span class="comment">//选指定模板路径,classpath下templates下</span></span><br><span class="line">        <span class="comment">//得到classpath路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(classpath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        <span class="comment">//设置字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定模板文件名称</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备数据</span></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getCoursePreviewInfo(courseId);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//静态化</span></span><br><span class="line">        <span class="comment">//参数1：模板，参数2：数据模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        <span class="comment">//            System.out.println(content);</span></span><br><span class="line">        <span class="comment">//将静态化内容输出到文件中</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> IOUtils.toInputStream(content);</span><br><span class="line">        <span class="comment">//创建静态化文件</span></span><br><span class="line">        htmlFile = File.createTempFile(<span class="string">&quot;course&quot;</span>,<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;课程静态化，生成静态文件:&#123;&#125;&quot;</span>,htmlFile.getAbsolutePath());</span><br><span class="line">        <span class="comment">//输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(htmlFile);</span><br><span class="line">        IOUtils.copy(inputStream, outputStream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;课程静态化异常:&#123;&#125;&quot;</span>,e.toString());</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程静态化异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> htmlFile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadCourseHtml</span><span class="params">(Long courseId, File file)</span> &#123;</span><br><span class="line">    <span class="type">MultipartFile</span> <span class="variable">multipartFile</span> <span class="operator">=</span> MultipartSupportConfig.getMultipartFile(file);</span><br><span class="line">    <span class="type">String</span> <span class="variable">course</span> <span class="operator">=</span> mediaServiceClient.uploadFile(multipartFile, <span class="string">&quot;course/&quot;</span>+courseId+<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(course==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;上传静态文件异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>完善课程发布任务CoursePublishTask类的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成课程静态化页面并上传至文件系统</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateCourseHtml</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">    <span class="comment">//消息id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">    <span class="comment">//消息处理的service</span></span><br><span class="line">    <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">    <span class="comment">//消息幂等性处理</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">    <span class="keyword">if</span>(stageOne == <span class="number">1</span>)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;课程静态化已处理直接返回，课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成静态化页面</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> coursePublishService.generateCourseHtml(courseId);</span><br><span class="line">    <span class="comment">//上传静态化页面</span></span><br><span class="line">    <span class="keyword">if</span>(file!=<span class="literal">null</span>)&#123;</span><br><span class="line">        coursePublishService.uploadCourseHtml(courseId,file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存第一阶段状态</span></span><br><span class="line">    mqMessageService.completedStageOne(id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-5-4-2-测试"><a href="#4-5-4-2-测试" class="headerlink" title="4.5.4.2 测试"></a><strong>4.5.4.2</strong> <strong>测试</strong></h4><p>1、启动网关、媒资管理服务工程。</p>
<p>2、在内容管理api工程的启动类上配置FeignClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure>



<p>在bootstrap.yml引用feign-dev.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- data-id: feign-<span class="variable">$&#123;spring.profiles.active&#125;</span>.yaml</span><br><span class="line">  group: xuecheng-plus-common</span><br><span class="line">  refresh: <span class="literal">true</span>  <span class="comment">#profiles默认为dev</span></span><br></pre></td></tr></table></figure>

<p>启动内容管理接口工程。</p>
<p>在CoursePublishTask类的execute方法中打上断点。</p>
<p>3、发布一门课程，保存消息表存在未处理的处理。</p>
<p>4、启动xxl-job调度中心、启动课程发布任务，等待定时调度。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image050-1711291285108220.gif" alt="img"></p>
<p>5、观察任务调度日志，观察任务是否可以正常处理。</p>
<p>6、处理完成进入文件系统，查询mediafiles桶内是否存在以课程id命名的html文件</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image052-1711291285108219.gif" alt="img"></p>
<p>如果不存在说明课程静态化存在问题，再仔细查看执行日志，排查问题。</p>
<p>如果存在则说明课程静态化并上传到minio成功。</p>
<h4 id="4-5-4-3-浏览详细页面"><a href="#4-5-4-3-浏览详细页面" class="headerlink" title="4.5.4.3 浏览详细页面"></a><strong>4.5.4.3</strong> <strong>浏览详细页面</strong></h4><p>课程静态化成功后可以用浏览器访问html文件是否可以正常浏览，下图表示可以正常浏览。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image054-1711291285108221.gif" alt="img"></p>
<p>页面还没有样式，需要在nginx配置虚拟目录，在<a href="http://www.51xuecheng.cn下配置：">www.51xuecheng.cn下配置：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Plain Text</span><br><span class="line">location /course/ &#123;  </span><br><span class="line">        proxy_pass http://fileserver/mediafiles/course/;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>加载nginx配置文件</p>
<p>访问：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/2.html">http://www.51xuecheng.cn/course/2.html</a></p>
<p>2.html为以课程id命名的html文件。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/" rel="next" title="学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案">
                <i class="fa fa-chevron-left"></i> 学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" rel="prev" title="苍穹外卖技术总结">
                苍穹外卖技术总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
		  
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/2698022795" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:2698022795@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/qq_40493033" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

		  
			
			  <div class="links-of-blogroll motion-element links-of-blogroll-block">
				<div class="links-of-blogroll-title">
				  <!-- modify icon to fire by szw -->
				  <i class="fa fa-history fa-" aria-hidden="true"></i>
				  近期文章
				</div>
				<ul class="links-of-blogroll-list">
				  
				  
					<li class="recent_posts_li">
					  <a href="/2024/04/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day10-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83/" title="学成在线-day10-认证授权" target="_blank">学成在线-day10-认证授权</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/04/03/%E5%86%85%E5%8A%9F-day02-redis%E7%AF%87/" title="内功-day02-redis篇" target="_blank">内功-day02-redis篇</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/31/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" title="学成在线技术总结" target="_blank">学成在线技术总结</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" title="微服务技术总结" target="_blank">微服务技术总结</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" title="苍穹外卖技术总结" target="_blank">苍穹外卖技术总结</a>
					</li>
				  
				</ul>
			  </div>
			


          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">1 模块需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 模块介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 业务流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 课程预览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-%E8%AF%BE%E7%A8%8B%E5%AE%A1%E6%A0%B8"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 课程审核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 课程发布</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88"><span class="nav-number">2.</span> <span class="nav-text">2 课程预览</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 需求分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 模板引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 什么是模板引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-Freemarker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 Freemarker快速入门</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%B5%8B%E8%AF%95%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 测试静态页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E9%83%A8%E7%BD%B2%E7%BD%91%E7%AB%99%E9%97%A8%E6%88%B7"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 部署网站门户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-%E8%AF%BE%E7%A8%8B%E8%AF%A6%E6%83%85%E9%A1%B5%E9%9D%A2"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2 课程详情页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3.3 文件服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-4-%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2"><span class="nav-number">2.3.4.</span> <span class="nav-text">2.3.4 视频播放页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 接口定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E5%AE%9A%E4%B9%89%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.4.1 定义课程预览接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.4.2 配置反向代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 接口开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.5.1.</span> <span class="nav-text">2.5.1 数据模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-2-Service%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.5.2.</span> <span class="nav-text">2.5.2 Service接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-3-%E6%8E%A5%E5%8F%A3%E5%B1%82%E5%AE%8C%E5%96%84"><span class="nav-number">2.5.3.</span> <span class="nav-text">2.5.3 接口层完善</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-4-%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span class="nav-number">2.5.4.</span> <span class="nav-text">2.5.4 前后端联调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-5-%E7%BC%96%E5%86%99%E6%A8%A1%E6%9D%BF"><span class="nav-number">2.5.5.</span> <span class="nav-text">2.5.5 编写模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-6-%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.5.6.</span> <span class="nav-text">2.5.6 视频播放页面接口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E8%AF%BE%E7%A8%8B%E5%AE%A1%E6%A0%B8"><span class="nav-number">3.</span> <span class="nav-text">3 课程审核</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1 业务流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2 数据模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 接口开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-Dao%E5%BC%80%E5%8F%91"><span class="nav-number">3.3.1.</span> <span class="nav-text">3.3.1 Dao开发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-Service%E5%BC%80%E5%8F%91"><span class="nav-number">3.3.2.</span> <span class="nav-text">3.3.1 Service开发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 接口完善</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 接口测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="nav-number">4.</span> <span class="nav-text">4 课程发布</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 需求分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.1.1 数据模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 分布式事务技术方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.2.1.</span> <span class="nav-text">4.2.1 什么是分布式事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-%E4%BB%80%E4%B9%88%E6%98%AFCAP%E7%90%86%E8%AE%BA"><span class="nav-number">4.2.2.</span> <span class="nav-text">4.2.2 什么是CAP理论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88"><span class="nav-number">4.2.3.</span> <span class="nav-text">4.2.3 分布式事务控制方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-4-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E7%9A%84%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88"><span class="nav-number">4.2.4.</span> <span class="nav-text">4.2.4 课程发布的事务控制方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%8E%A5%E5%8F%A3"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 课程发布接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">4.3.1.</span> <span class="nav-text">4.3.1 接口定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="nav-number">4.3.2.</span> <span class="nav-text">4.3.3 接口开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-1-DAO%E5%BC%80%E5%8F%91"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">4.3.3.1 DAO开发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-2-Service%E5%BC%80%E5%8F%91"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">4.3.3.2 Service开发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-3-%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="nav-number">4.3.2.3.</span> <span class="nav-text">4.3.3.3 接口完善</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-4-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-number">4.3.3.</span> <span class="nav-text">4.3.4 接口测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86SDK"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 消息处理SDK</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="nav-number">4.4.1.</span> <span class="nav-text">4.4.1 消息模块技术方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97SDK%E6%B5%8B%E8%AF%95"><span class="nav-number">4.4.2.</span> <span class="nav-text">4.4.2 消息模块SDK测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-3-%E9%9B%86%E6%88%90%E6%B6%88%E6%81%AFSDK"><span class="nav-number">4.4.3.</span> <span class="nav-text">4.4.3 集成消息SDK</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-1-%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF"><span class="nav-number">4.4.3.1.</span> <span class="nav-text">4.4.3.1 添加消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-2-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="nav-number">4.4.3.2.</span> <span class="nav-text">4.4.3.2 课程发布任务处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-3-%E5%BC%80%E5%90%AF%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="nav-number">4.4.3.3.</span> <span class="nav-text">4.4.3.3 开启任务调度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-4-%E6%B5%8B%E8%AF%95"><span class="nav-number">4.4.3.4.</span> <span class="nav-text">4.4.3.4 测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 页面静态化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-1-%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="nav-number">4.5.1.</span> <span class="nav-text">4.5.1 什么是页面静态化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-2-%E9%9D%99%E6%80%81%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="nav-number">4.5.2.</span> <span class="nav-text">4.5.2 静态化测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-3-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="nav-number">4.5.3.</span> <span class="nav-text">4.5.3 上传文件测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-3-1-%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E7%8E%AF%E5%A2%83"><span class="nav-number">4.5.3.1.</span> <span class="nav-text">4.5.3.1 配置远程调用环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-3-2-%E6%89%A9%E5%85%85%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%8E%A5%E5%8F%A3"><span class="nav-number">4.5.3.2.</span> <span class="nav-text">4.5.3.2 扩充上传文件接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-3-3-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="nav-number">4.5.3.3.</span> <span class="nav-text">4.5.3.3 远程调用测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-4-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="nav-number">4.5.4.</span> <span class="nav-text">4.5.4 熔断降级处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="nav-number">4.5.4.1.</span> <span class="nav-text">4.5.4.1 什么是熔断降级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-2-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="nav-number">4.5.4.2.</span> <span class="nav-text">4.5.4.2 熔断降级处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-4-%E8%AF%BE%E7%A8%8B%E9%9D%99%E6%80%81%E5%8C%96%E5%BC%80%E5%8F%91"><span class="nav-number">4.5.5.</span> <span class="nav-text">4.5.4 课程静态化开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-1-%E9%9D%99%E6%80%81%E5%8C%96%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.5.5.1.</span> <span class="nav-text">4.5.4.1 静态化实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-2-%E6%B5%8B%E8%AF%95"><span class="nav-number">4.5.5.2.</span> <span class="nav-text">4.5.4.2 测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-3-%E6%B5%8F%E8%A7%88%E8%AF%A6%E7%BB%86%E9%A1%B5%E9%9D%A2"><span class="nav-number">4.5.5.3.</span> <span class="nav-text">4.5.4.3 浏览详细页面</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">waterdance</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">304.6k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>

-->



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "default";
      
          flOptions.boxForm = "vertical";
      
          flOptions.position = "topRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  
  
		# 要加入的代码
</body>
</html>
