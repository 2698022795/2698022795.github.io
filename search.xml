<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>如何在hexo中安装next主题</title>
    <url>/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/</url>
    <content><![CDATA[<h1 id="1-安装hexo"><a href="#1-安装hexo" class="headerlink" title="1. 安装hexo"></a>1. 安装hexo</h1><p>npm install -g hexo-cli</p>
<h1 id="2-主题下载安装"><a href="#2-主题下载安装" class="headerlink" title="2. 主题下载安装"></a>2. 主题下载安装</h1><p>进入命令行，下载 NexT 主题，输入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<p>修改站点配置文件<code>_config.yml</code>，找到如下代码：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">landscape</span></span><br></pre></td></tr></table></figure>

<p>将 landscape 修改为 next 即可。</p>
<span id="more"></span>





<h1 id="3-配置文件"><a href="#3-配置文件" class="headerlink" title="3. 配置文件"></a>3. 配置文件</h1><p>在 Hexo 中有<strong>两份</strong>主要的配置文件，其名称都是 <strong>_config.yml</strong>。 其中，一份位于站点根目录下，主要包含 Hexo 本身的站点配置；另一份位于<strong>主题目录</strong>下，这份配置由主题作者提供，主要用于配置主题相关的选项。</p>
<p>为了描述方便，在以下说明中，将前者称为 <strong>站点配置文件</strong>， 后者称为 <strong>主题配置文件</strong>。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">/hexo/_config.yml</span></span><br><span class="line"><span class="string">/hexo/themes/next/_config.yml</span></span><br></pre></td></tr></table></figure>

<h1 id="4-修改语言"><a href="#4-修改语言" class="headerlink" title="4. 修改语言"></a>4. 修改语言</h1><p>打开站点配置文件，搜索 language，找到如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">author: waterdance</span><br><span class="line">language: zh-Hans</span><br><span class="line">timezone: Asia/Shanghai</span><br></pre></td></tr></table></figure>

<h1 id="5-新建标签及分类界面"><a href="#5-新建标签及分类界面" class="headerlink" title="5. 新建标签及分类界面"></a>5. 新建标签及分类界面</h1><p>打开 <strong>主题配置文件</strong>，搜索 menu，找到如下代码：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">home</span></span><br><span class="line">  <span class="comment">#about: /about/ || user</span></span><br><span class="line">  <span class="comment">#tags: /tags/ || tags</span></span><br><span class="line">  <span class="comment">#categories: /categories/ || th</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">archive</span></span><br><span class="line">  <span class="comment">#schedule: /schedule/ || calendar</span></span><br><span class="line">  <span class="comment">#sitemap: /sitemap.xml || sitemap</span></span><br><span class="line">  <span class="comment">#commonweal: /404/ || heartbeat</span></span><br></pre></td></tr></table></figure>

<p>把 tags 和 categories 前面的 # 删除</p>
<h1 id="6-切换主题"><a href="#6-切换主题" class="headerlink" title="6. 切换主题"></a>6. 切换主题</h1><p>在主题配置文件<code>/next/_config.yml</code>中查找：<code>scheme</code>，找到如下代码：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Schemes</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">Muse</span></span><br><span class="line"><span class="comment">#scheme: Mist</span></span><br><span class="line"><span class="comment">#scheme: Pisces</span></span><br><span class="line"><span class="comment">#scheme: Gemini</span></span><br><span class="line"><span class="string">选择你喜欢的一种样式，去掉前面的</span> <span class="comment">#，其他主题前加上 # 即可。</span></span><br></pre></td></tr></table></figure>

<h1 id="7-隐藏网页底部-powered-By-Hexo-强力驱动"><a href="#7-隐藏网页底部-powered-By-Hexo-强力驱动" class="headerlink" title="7. 隐藏网页底部 powered By Hexo &#x2F; 强力驱动"></a>7. 隐藏网页底部 powered By Hexo &#x2F; 强力驱动</h1><p>打开 themes&#x2F;next&#x2F;layout&#x2F;_partials&#x2F;footer.swig</p>
<p>找到：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">%</span> <span class="string">if</span> <span class="string">theme.footer.powered.enable</span> <span class="string">%</span>&#125;</span><br><span class="line"><span class="string">&lt;div</span> <span class="string">class=&quot;powered-by&quot;&gt;&#123;#</span></span><br><span class="line"><span class="comment">#&#125;&#123;&#123; __(&#x27;footer.powered&#x27;, &#x27;&lt;a class=&quot;theme-link&quot; target=&quot;_blank&quot;&#x27; + nofollow + &#x27; href=&quot;https://hexo.io&quot;&gt;Hexo&lt;/a&gt;&#x27;) &#125;&#125;&#123;% if theme.footer.powered.version %&#125; v&#123;&#123; hexo_env(&#x27;version&#x27;) &#125;&#125;&#123;% endif %&#125;&#123;#</span></span><br><span class="line"><span class="comment">#&#125;&lt;/div&gt;</span></span><br><span class="line">&#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br><span class="line">&#123;<span class="string">%</span> <span class="string">if</span> <span class="string">theme.footer.powered.enable</span> <span class="string">and</span> <span class="string">theme.footer.theme.enable</span> <span class="string">%</span>&#125;</span><br><span class="line"><span class="string">&lt;span</span> <span class="string">class=&quot;post-meta-divider&quot;&gt;|&lt;/span&gt;</span></span><br><span class="line">&#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br><span class="line">&#123;<span class="string">%</span> <span class="string">if</span> <span class="string">theme.footer.theme.enable</span> <span class="string">%</span>&#125;</span><br><span class="line"><span class="string">&lt;div</span> <span class="string">class=&quot;theme-info&quot;&gt;&#123;#</span></span><br><span class="line"><span class="comment">#&#125;&#123;&#123; __(&#x27;footer.theme&#x27;) &#125;&#125; – &#123;#</span></span><br><span class="line"><span class="comment">#&#125;&lt;a class=&quot;theme-link&quot; target=&quot;_blank&quot;&#123;&#123; nofollow &#125;&#125; href=&quot;https://theme-next.org&quot;&gt;&#123;#</span></span><br><span class="line"><span class="comment">#&#125;NexT.&#123;&#123; theme.scheme &#125;&#125;&#123;#</span></span><br><span class="line"><span class="comment">#&#125;&lt;/a&gt;&#123;% if theme.footer.theme.version %&#125; v&#123;&#123; version &#125;&#125;&#123;% endif %&#125;&#123;#</span></span><br><span class="line"><span class="comment">#&#125;&lt;/div&gt;</span></span><br><span class="line">&#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br></pre></td></tr></table></figure>

<p>把这段代码首尾分别加上：<code>&lt;!--</code> 和<code>--&gt;</code>，或者直接删除。</p>
<h1 id="8-文章加上阴影"><a href="#8-文章加上阴影" class="headerlink" title="8. 文章加上阴影"></a>8. 文章加上阴影</h1><p>打开 &#x2F;themes&#x2F;next&#x2F;source&#x2F;css&#x2F;_custom&#x2F;custom.styl，添加：</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.post</span> &#123;</span><br><span class="line"><span class="attribute">margin-top</span>: <span class="number">60px</span>;</span><br><span class="line"><span class="attribute">margin-bottom</span>: <span class="number">60px</span>;</span><br><span class="line"><span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">-webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">203</span>, .<span class="number">5</span>);</span><br><span class="line">-moz-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">204</span>, .<span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="9-浏览页面显示当前浏览进度"><a href="#9-浏览页面显示当前浏览进度" class="headerlink" title="9. 浏览页面显示当前浏览进度"></a>9. 浏览页面显示当前浏览进度</h1><p>打开 themes&#x2F;next&#x2F;_config.yml，搜索关键字 <code>scrollpercent</code>，把 false 改为 true。</p>
<p><img src="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/image-20240115193347448.png" alt="image-20240115193347448"></p>
<h1 id="10-Local-Search本地搜索"><a href="#10-Local-Search本地搜索" class="headerlink" title="10. Local Search本地搜索"></a>10. Local Search本地搜索</h1><p>安装插件<code>hexo-generator-searchdb</code>,执行以下命令:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>

<p>修改<code>hexo/_config.yml</code>站点配置文件，新增以下内容到任意位置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line"><span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line"><span class="attr">field:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">format:</span> <span class="string">html</span></span><br><span class="line"><span class="attr">limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h1 id="11-设置网站图标"><a href="#11-设置网站图标" class="headerlink" title="11. 设置网站图标"></a>11. 设置网站图标</h1><p>在 EasyIcon 中找一张（32 * 32）的 ico 图标，或者去别的网站下载或者制作，并将图标名称改为 favicon.ico，然后把图标放在 &#x2F;themes&#x2F;next&#x2F;source&#x2F;images 里，并且修改主题配置文件：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">Put</span> <span class="string">your</span> <span class="string">favicon.ico</span> <span class="string">into</span> <span class="string">`hexo-site/source/`</span> <span class="string">directory.</span></span><br><span class="line"><span class="attr">favicon:</span> <span class="string">/favicon.ico</span></span><br></pre></td></tr></table></figure>

<h1 id="12-修改文章底部的-号的标签，改为图标"><a href="#12-修改文章底部的-号的标签，改为图标" class="headerlink" title="12. 修改文章底部的#号的标签，改为图标"></a>12. 修改文章底部的#号的标签，改为图标</h1><p>修改模板<code>/themes/next/layout/_macro/post.swig</code></p>
<p>搜索 rel&#x3D;“tag”&gt;#，将 # 换成<code>&lt;i class=&quot;fa fa-tag&quot;&gt;&lt;/i&gt;</code></p>
<h1 id="13-文章分享功能"><a href="#13-文章分享功能" class="headerlink" title="13. 文章分享功能"></a>13. 文章分享功能</h1><p>打开<code>themes/next/_config.yml</code> 搜索关键字<code>needmoreshare2</code> 修改为下面设置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">needmoreshare2:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">postbottom:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">iconStyle:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">boxForm:</span> <span class="string">horizontal</span></span><br><span class="line">      <span class="comment">#位置</span></span><br><span class="line">      <span class="attr">position:</span> <span class="string">bottomCenter</span></span><br><span class="line">      <span class="comment">#可分享网站</span></span><br><span class="line">      <span class="attr">networks:</span> <span class="string">Weibo,Wechat,Douban,QQZone,Twitter,Facebook</span></span><br><span class="line">  <span class="attr">float:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">iconStyle:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">boxForm:</span> <span class="string">vertical</span></span><br><span class="line">      <span class="comment">#位置</span></span><br><span class="line">      <span class="attr">position:</span> <span class="string">topRight</span></span><br><span class="line">       <span class="comment">#可分享网站</span></span><br><span class="line">      <span class="attr">networks:</span> <span class="string">Weibo,Wechat,Douban,QQZone,Twitter,Facebook</span></span><br></pre></td></tr></table></figure>

<h1 id="14-文章加密访问"><a href="#14-文章加密访问" class="headerlink" title="14. 文章加密访问"></a>14. 文章加密访问</h1><p>打开<code>themes-&gt;next-&gt;layout-&gt;_partials-&gt;head.swig</code>文件,插入这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(function()&#123;</span><br><span class="line">    if(&#x27;&#123;&#123; page.password &#125;&#125;&#x27;)&#123;</span><br><span class="line">        if (prompt(&#x27;请输入文章密码&#x27;) !== &#x27;&#123;&#123; page.password &#125;&#125;&#x27;)&#123;</span><br><span class="line">            alert(&#x27;密码错误！&#x27;);</span><br><span class="line">            history.back();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h1 id="15-增加文章字数统计及阅读时常功能"><a href="#15-增加文章字数统计及阅读时常功能" class="headerlink" title="15. 增加文章字数统计及阅读时常功能"></a>15. 增加文章字数统计及阅读时常功能</h1><p>安装插件<code>hexo-wordcount</code>,执行以下命令:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install hexo-wordcount --save</span><br></pre></td></tr></table></figure>

<p>修改<code>themes/next/_config.yml</code>主题配置文件，搜索关键字<code>post_wordcount</code>,修改如下:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">post_wordcount:</span><br><span class="line">  item_text: true</span><br><span class="line">  wordcount: true #单篇文章字数</span><br><span class="line">  min2read: true #单篇阅读时长</span><br><span class="line">  totalcount: true #站点总字数</span><br><span class="line">  separated_meta: true</span><br></pre></td></tr></table></figure>

<h1 id="16-文章置顶功能"><a href="#16-文章置顶功能" class="headerlink" title="16. 文章置顶功能"></a>16. 文章置顶功能</h1><p>移除默认安装的插件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm uninstall hexo-generator-index --save</span><br></pre></td></tr></table></figure>

<p>安装新插件:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-index-pin-top --save</span><br></pre></td></tr></table></figure>

<p>最后编辑有这需求的相关文章时，在Front-matter（文件最上方以—分隔的区域）加上一行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">top: true</span><br></pre></td></tr></table></figure>

<p>如果你置顶了多篇，怎么控制顺序呢？设置top的值（大的在前面），比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># Post a.md</span><br><span class="line">title: a</span><br><span class="line">top: <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># Post b.md</span><br><span class="line">title: b</span><br><span class="line">top: <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>文章 b 便会显示在文章 a 的前面</p>
<p>设置置顶图标<br>打开&#x2F;themes&#x2F;next&#x2F;layout&#x2F;_macro&#x2F;post.swig文件，在<code>&lt;div class=&quot;post-meta&quot;&gt;</code>下方，插入如下代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% if post.top %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-thumb-tack&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">7D26CD</span>&gt;</span>置顶<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-meta-divider&quot;</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/image-20240115194810928.png" alt="image-20240115194810928"></p>
<h1 id="17-修改【Read-More】按钮样式"><a href="#17-修改【Read-More】按钮样式" class="headerlink" title="17. 修改【Read More】按钮样式"></a>17. 修改【Read More】按钮样式</h1><p>修改<code>themes\next\source\css\_custom\custom.styl</code>文件，加入自定义样式</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">// <span class="selector-attr">[Read More]</span>按钮样式</span><br><span class="line"><span class="selector-class">.post-button</span> <span class="selector-class">.btn</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#555</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">box-shadow</span>: inset <span class="number">0px</span> <span class="number">0px</span> <span class="number">10px</span> <span class="number">0px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.35</span>);</span><br><span class="line">    <span class="attribute">border</span>: none <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">transition-property</span>: unset;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0px</span> <span class="number">15px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.post-button</span> <span class="selector-class">.btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>) <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">15px</span>;</span><br><span class="line">    <span class="attribute">box-shadow</span>: inset <span class="number">0px</span> <span class="number">0px</span> <span class="number">10px</span> <span class="number">0px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.35</span>);</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="number">#a166ab</span> <span class="number">0%</span>, <span class="number">#ef4e7b</span> <span class="number">25%</span>, <span class="number">#f37055</span> <span class="number">50%</span>, <span class="number">#ef4e7b</span> <span class="number">75%</span>, <span class="number">#a166ab</span> <span class="number">100%</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>效果图</strong></p>
<p><img src="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/image-20240116143513555.png" alt="image-20240116143513555"></p>
<p><strong>修改阅读全文前显示文字数量即位置</strong></p>
<p>打开 <code>themes/next/_config.yml</code>，搜索关键字 <code>auto_excerpt</code>， 修改length即可修改阅读全文前显示文字数量</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_excerpt:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">length:</span> <span class="number">150</span></span><br></pre></td></tr></table></figure>



<h1 id="18-修改链接文字样式"><a href="#18-修改链接文字样式" class="headerlink" title="18. 修改链接文字样式"></a>18. 修改链接文字样式</h1><p>打开<code>themes\next\source\css\_common\components\post\post.styl</code>添加以下代码:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.post-body</span> <span class="selector-tag">p</span> a&#123;</span><br><span class="line"></span><br><span class="line"> <span class="attribute">color</span>: <span class="number">#0593d3</span>;</span><br><span class="line"> <span class="attribute">border-bottom</span>: none;</span><br><span class="line"> <span class="selector-pseudo">&amp;:hover</span> &#123;</span><br><span class="line">   <span class="attribute">color</span>: <span class="number">#ff106c</span>;</span><br><span class="line">   <span class="attribute">text-decoration</span>: underline;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="19-头像设置图形，停留旋转效果"><a href="#19-头像设置图形，停留旋转效果" class="headerlink" title="19. 头像设置图形，停留旋转效果"></a>19. 头像设置图形，停留旋转效果</h1><p>修改<code>themes\next\source\css\_common\components\sidebar\sidebar-author.styl</code>,新增以下代码:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.site-author-image</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="variable">$site</span>-author-image-padding;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="variable">$site</span>-author-image-width;</span><br><span class="line">  <span class="attribute">height</span>: <span class="variable">$site</span>-author-image-height;</span><br><span class="line">  <span class="attribute">border</span>: <span class="variable">$site</span>-author-image-border-width solid <span class="variable">$site</span>-author-image-border-color;</span><br><span class="line">  <span class="comment">//设置圆形</span></span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">transition</span>: <span class="number">2s</span> all;</span><br><span class="line">&#125;</span><br><span class="line">   <span class="comment">//旋转</span></span><br><span class="line"><span class="selector-class">.site-author-image</span>:hover&#123;</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">360deg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="20-文章添加阴影效果-文章边框"><a href="#20-文章添加阴影效果-文章边框" class="headerlink" title="20.文章添加阴影效果(文章边框)"></a>20.文章添加阴影效果(文章边框)</h1><p>打开<code>themes/next/source/css/_custom/custom.styl</code>文件添加:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.post</span> &#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">60px</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">60px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">  -webkit-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">203</span>, .<span class="number">5</span>);</span><br><span class="line">  -moz-<span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">rgba</span>(<span class="number">202</span>, <span class="number">203</span>, <span class="number">204</span>, .<span class="number">5</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h1 id="21-近期文章"><a href="#21-近期文章" class="headerlink" title="21. 近期文章"></a>21. 近期文章</h1><p>修改<code>themes/next/layout/_macro/sidebar.swig</code> 。找到<code>theme.social</code>板块代码，在该板块最后的endif后隔一行添加如下代码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;# recent posts #&#125;</span><br><span class="line">&#123;% if theme.recent_posts %&#125;</span><br><span class="line">  &lt;div class=&quot;links-of-blogroll motion-element &#123;&#123; &quot;links-of-blogroll-&quot; + theme.recent_posts_layout  &#125;&#125;&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;links-of-blogroll-title&quot;&gt;</span><br><span class="line">      &lt;!-- modify icon to fire by szw --&gt;</span><br><span class="line">      &lt;i class=&quot;fa fa-history fa-&#123;&#123; theme.recent_posts_icon | lower &#125;&#125;&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;</span><br><span class="line">      &#123;&#123; theme.recent_posts_title &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;ul class=&quot;links-of-blogroll-list&quot;&gt;</span><br><span class="line">      &#123;% set posts = site.posts.sort(&#x27;-date&#x27;) %&#125;</span><br><span class="line">      &#123;% for post in posts.slice(&#x27;0&#x27;, &#x27;5&#x27;) %&#125;</span><br><span class="line">        &lt;li class=&quot;recent_posts_li&quot;&gt;</span><br><span class="line">          &lt;a href=&quot;&#123;&#123; url_for(post.path) &#125;&#125;&quot; title=&quot;&#123;&#123; post.title &#125;&#125;&quot; target=&quot;_blank&quot;&gt;&#123;&#123; post.title &#125;&#125;&lt;/a&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">      &#123;% endfor %&#125;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>编辑<code>themes/next/source/css/_common/components/sidebar/sidebar-0blogroll.styl</code></p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">li</span><span class="selector-class">.recent_posts_li</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: cengter;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">word-break</span>: keep-all;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>themes/next/_config.yml</code>中添加下方代码</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 近期文章设置</span></span><br><span class="line"><span class="attr">recent_posts_title:</span> <span class="string">近期文章</span></span><br><span class="line"><span class="attr">recent_posts_layout:</span> <span class="string">block</span></span><br><span class="line"><span class="attr">recent_posts:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h1 id="22-文章末尾添加“文本结束”标记"><a href="#22-文章末尾添加“文本结束”标记" class="headerlink" title="22. 文章末尾添加“文本结束”标记"></a>22. 文章末尾添加“文本结束”标记</h1><p>修改在themes&#x2F;next&#x2F;layout&#x2F;_macro&#x2F;post.swig中，在wechat-subscriber.swig之前添加如下代码：</p>
<p>—————- The End —————-</p>




<h1 id="23-代码块复制选项"><a href="#23-代码块复制选项" class="headerlink" title="23. 代码块复制选项"></a>23. 代码块复制选项</h1><p>Next6 中自带了复制代码按钮，Next5 需要自己手动配置。</p>
<p>搜索 codeblock，找到如下配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">codeblock:</span></span><br><span class="line"><span class="attr">border_radius:</span> <span class="number">8</span>   <span class="comment"># 按钮圆滑度</span></span><br><span class="line"><span class="attr">copy_button:</span>  <span class="comment"># 设置是否开启代码块复制按钮</span></span><br><span class="line">	<span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">	<span class="attr">show_result:</span> <span class="literal">true</span>  <span class="comment"># 是否显示复制成功信息</span></span><br></pre></td></tr></table></figure>





<h1 id="24-修改加载特效"><a href="#24-修改加载特效" class="headerlink" title="24. 修改加载特效"></a>24. 修改加载特效</h1><p>由于网页不可能一直都秒进，总会等待一段时间的，所以可以设置顶部加载条。Next 已经集成了很多加载特效，可以在下面选项中在线调试测试一下。</p>
<p>搜索<code>pace</code>，找到如下代码：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 页面顶部加载条</span></span><br><span class="line"><span class="comment"># Progress bar in the top during page loading.</span></span><br><span class="line"><span class="attr">pace:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Themes list:</span></span><br><span class="line"><span class="comment">#pace-theme-big-counter</span></span><br><span class="line"><span class="comment">#pace-theme-bounce</span></span><br><span class="line"><span class="comment">#pace-theme-barber-shop</span></span><br><span class="line"><span class="comment">#pace-theme-center-atom</span></span><br><span class="line"><span class="comment">#pace-theme-center-circle</span></span><br><span class="line"><span class="comment">#pace-theme-center-radar</span></span><br><span class="line"><span class="comment">#pace-theme-center-simple</span></span><br><span class="line"><span class="comment">#pace-theme-corner-indicator</span></span><br><span class="line"><span class="comment">#pace-theme-fill-left</span></span><br><span class="line"><span class="comment">#pace-theme-flash</span></span><br><span class="line"><span class="comment">#pace-theme-loading-bar</span></span><br><span class="line"><span class="comment">#pace-theme-mac-osx</span></span><br><span class="line"><span class="comment">#pace-theme-minimal</span></span><br><span class="line"><span class="comment"># For example</span></span><br><span class="line"><span class="comment"># pace_theme: pace-theme-center-simple</span></span><br><span class="line"><span class="attr">pace_theme:</span> <span class="string">pace-theme-minimal</span>  <span class="comment">#默认设置，可以修改为上述任何一个</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>博客</category>
      </categories>
  </entry>
  <entry>
    <title>微服务-day03-入门1</title>
    <url>/2024/03/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day03-%E5%85%A5%E9%97%A81/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>微服务</category>
      </categories>
  </entry>
  <entry>
    <title>微服务-day02-SpringCloud02</title>
    <url>/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/</url>
    <content><![CDATA[<h1 id="Nacos配置管理"><a href="#Nacos配置管理" class="headerlink" title="Nacos配置管理"></a>Nacos配置管理</h1><h2 id="统一配置管理"><a href="#统一配置管理" class="headerlink" title="统一配置管理"></a>统一配置管理</h2><ul>
<li><p>配置更改热更新</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305224009346.png" alt="image-20240305224009346"></p>
</li>
</ul>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305224130659.png" alt="image-20240305224130659"></p>
<p>Data ID的命名规范：userservice-prod.yaml</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305224607825.png" alt="image-20240305224607825"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305224836105.png" alt="image-20240305224836105"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305224845391.png" alt="image-20240305224845391"></p>
<h2 id="微服务配置拉取"><a href="#微服务配置拉取" class="headerlink" title="微服务配置拉取"></a>微服务配置拉取</h2><p>在没有nacos之前，配置获取的步骤：</p>
<ol>
<li>项目启动</li>
<li>读取本地配置文件application.yaml</li>
<li>创建spring容器</li>
<li>加载bean</li>
</ol>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305225022405.png" alt="image-20240305225022405"></p>
<p>在有了nacos之后，配置的获取步骤如下所示：</p>
<ol>
<li>项目启动</li>
<li>先读取nacos中配置文件</li>
<li>读取本地配置文件application.yaml</li>
<li>创建spring容器</li>
<li>加载bean</li>
</ol>
<p><font color="red">这里有一个问题：去哪儿读取nacos地址，读取谁，之前我们是将nacos地址放在了本地配置文件application.yml中，但是现在是先读取nacos地址，再读取本地配置文件。</font></p>
<p><font color="red">解决办法：与nacos地址和配置文件信息放在bootstrap.yml</font></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305230658657.png" alt="image-20240305230658657"></p>
<ol>
<li><p>引入Nacos的配置管理客户端依赖：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!--        nacos的配置管理依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在userservice中的resource目录添加一个bootstrap.yml文件，这个文件是引导文件，优先级高于application.yml；</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240305225938225.png" alt="image-20240305225938225"></p>
<p>这三者决定了nacos的data Id。</p>
</li>
</ol>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306003053003.png" alt="image-20240306003053003"></p>
<p><a href="https://blog.csdn.net/CSDN_user096A/article/details/131660704">Nacos拉取配置信息失败，@Value exception is java.lang.IlleggalArgumentException: Could not resolve placeholder_could not resolve placeholder ‘pattern.dateformat’-CSDN博客</a></p>
<p><font color="red">最关键的一步：添加bootstrap的依赖配置</font></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>总结</strong></p>
<p>将配置交给Nacos管理的步骤</p>
<ol>
<li>在Nacos中添加配置文件</li>
<li>在微服务中引入nacos的config依赖</li>
<li>在微服务中添加bootstrap.yml，配置nacos地址、当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取哪个文件。</li>
</ol>
<h2 id="配置热更新"><a href="#配置热更新" class="headerlink" title="配置热更新"></a>配置热更新</h2><p>Nacos中的配置文件变更后，微服务无需重启就可以感知。不过需要通过下面两种配置实现：</p>
<ul>
<li><p>方式一：在@Value注入的变量所在类上添加注解@RefreshScope</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306003722529.png" alt="image-20240306003722529"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306010955046.png" alt="image-20240306010955046"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306011007721.png" alt="image-20240306011007721"></p>
</li>
<li><p>方式二：使用@ConfigurationProperties注解（配置属性类会读取配置文件中对应配置的值，而配置文件现在不仅包括本地配置文件，还包括注册中心的配置信息，所以还可以读取到注册中心的配置信息）</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306011501579.png" alt="image-20240306011501579"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306011533533.png" alt="image-20240306011533533"></p>
</li>
</ul>
<p><strong>总结</strong></p>
<p>Nacos配置更改后，微服务可以实现热更新，方式：</p>
<ol>
<li>通过@Value注解注入，结合@RefreshScope来刷新</li>
<li>通过@ConfigurationProperties注入，自动刷新（建议使用）</li>
</ol>
<p>注意事项：</p>
<ul>
<li>不是所有的配置都适合放到配置中心，维护起来比较麻烦</li>
<li>不建议将一些关键参数，需要运行时调整的参数放到nacos配置中心，一般都是自定义配置</li>
</ul>
<h2 id="配置共享"><a href="#配置共享" class="headerlink" title="配置共享"></a>配置共享</h2><p>微服务的配置共享，有一个配置属性在生产、测试、开发中的属性值均一致。</p>
<p>微服务启动时会从nacos读取多个配置文件：</p>
<ul>
<li>[spring.application.name] - [spring.profile.active].yaml，例如：userservice-dev.yaml</li>
<li>[spring.application.name].yaml，例如：userservice.yaml</li>
</ul>
<p>无论profile如何变化，[spring.application.name].yaml这个文件一定会加载，因此多环境共享配置可以写入这个文件。</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306012118919.png" alt="image-20240306012118919"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306012014949.png" alt="image-20240306012014949"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306012201885.png" alt="image-20240306012201885"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306012817828.png" alt="image-20240306012817828"></p>
<p>将8082端口的服务改为test环境</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306013122441.png" alt="image-20240306013122441"></p>
<p><strong>8081和8082端口的配置信息读取情况</strong></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306013320250.png" alt="image-20240306013320250"></p>
<p>多种配置的优先级：</p>
<ul>
<li>服务名-profile.yaml &gt; 服务名称.yaml &gt; 本地配置</li>
</ul>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306013557099.png" alt="image-20240306013557099"></p>
<h2 id="搭建Nacos集群"><a href="#搭建Nacos集群" class="headerlink" title="搭建Nacos集群"></a>搭建Nacos集群</h2><p>Nacos生产环境下一定要部署为集群状态。</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306013652900.png" alt="image-20240306013652900"></p>
<h1 id="Nacos集群搭建"><a href="#Nacos集群搭建" class="headerlink" title="Nacos集群搭建"></a>Nacos集群搭建</h1><h1 id="1-集群结构图"><a href="#1-集群结构图" class="headerlink" title="1.集群结构图"></a>1.集群结构图</h1><p>官方给出的Nacos集群图：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210409210621117.png" alt="image-20210409210621117"></p>
<p>其中包含3个nacos节点，然后一个负载均衡器代理3个Nacos。这里负载均衡器可以使用nginx。</p>
<p>我们计划的集群结构：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210409211355037.png" alt="image-20210409211355037"></p>
<p>三个nacos节点的地址：</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>ip</th>
<th>port</th>
</tr>
</thead>
<tbody><tr>
<td>nacos1</td>
<td>192.168.150.1</td>
<td>8845</td>
</tr>
<tr>
<td>nacos2</td>
<td>192.168.150.1</td>
<td>8846</td>
</tr>
<tr>
<td>nacos3</td>
<td>192.168.150.1</td>
<td>8847</td>
</tr>
</tbody></table>
<h1 id="2-搭建集群"><a href="#2-搭建集群" class="headerlink" title="2.搭建集群"></a>2.搭建集群</h1><p>搭建集群的基本步骤：</p>
<ul>
<li>搭建数据库，初始化数据库表结构</li>
<li>下载nacos安装包</li>
<li>配置nacos</li>
<li>启动nacos集群</li>
<li>nginx反向代理</li>
</ul>
<h2 id="2-1-初始化数据库"><a href="#2-1-初始化数据库" class="headerlink" title="2.1.初始化数据库"></a>2.1.初始化数据库</h2><p>Nacos默认数据存储在内嵌数据库Derby中，不属于生产可用的数据库。</p>
<p>官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库可以参考<strong>传智教育</strong>的后续高手课程。</p>
<p>这里我们以单点的数据库为例来讲解。</p>
<p>首先新建一个数据库，命名为nacos，而后导入下面的SQL：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  `c_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_use` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `effect` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_aggr   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_aggr` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `datum_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;datum_id&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;增加租户字段&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_beta   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_beta` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `beta_ips` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;betaIps&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_beta&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_tag   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_tag` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_id&#x27;</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">&#x27;source user&#x27;</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;source ip&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_info_tag&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_tags_relation   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_tags_relation` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `tag_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_name&#x27;</span>,</span><br><span class="line">  `tag_type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tag_type&#x27;</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;data_id&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;group_id&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;config_tag_relation&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = group_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Group ID，空字符表示整个集群&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;配额，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;使用量&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;聚合子配置最大个数，，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;最大变更历史数量&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;集群、各Group容量信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = his_config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `his_config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">64</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `op_type` <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;租户字段&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;多租户改造&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = tenant_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;Tenant ID&#x27;</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;配额，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;使用量&#x27;</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;聚合子配置最大个数&#x27;</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;最大变更历史数量&#x27;</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;租户容量信息表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `kp` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;kp&#x27;</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_id&#x27;</span>,</span><br><span class="line">  `tenant_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;tenant_name&#x27;</span>,</span><br><span class="line">  `tenant_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;tenant_desc&#x27;</span>,</span><br><span class="line">  `create_source` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create_source&#x27;</span>,</span><br><span class="line">  `gmt_create` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `gmt_modified` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;tenant_info&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `users` (</span><br><span class="line">	`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">	`password` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`enabled` <span class="type">boolean</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `roles` (</span><br><span class="line">	`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">UNIQUE</span> INDEX `idx_user_role` (`username` <span class="keyword">ASC</span>, `role` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `permissions` (</span><br><span class="line">    `role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `action` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> INDEX `uk_role_permission` (`role`,`resource`,`action`) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (username, password, enabled) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> roles (username, role) <span class="keyword">VALUES</span> (<span class="string">&#x27;nacos&#x27;</span>, <span class="string">&#x27;ROLE_ADMIN&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="2-2-下载nacos"><a href="#2-2-下载nacos" class="headerlink" title="2.2.下载nacos"></a>2.2.下载nacos</h2><p>nacos在GitHub上有下载地址：<a href="https://github.com/alibaba/nacos/tags%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%89%E6%8B%A9%E4%BB%BB%E6%84%8F%E7%89%88%E6%9C%AC%E4%B8%8B%E8%BD%BD%E3%80%82">https://github.com/alibaba/nacos/tags，可以选择任意版本下载。</a></p>
<p>本例中才用1.4.1版本：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210409212119411.png" alt="image-20210409212119411"></p>
<h2 id="2-3-配置Nacos"><a href="#2-3-配置Nacos" class="headerlink" title="2.3.配置Nacos"></a>2.3.配置Nacos</h2><p>将这个包解压到任意非中文目录下，如图：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210402161843337.png" alt="image-20210402161843337"></p>
<p>目录说明：</p>
<ul>
<li>bin：启动脚本</li>
<li>conf：配置文件</li>
</ul>
<p>进入nacos的conf目录，修改配置文件cluster.conf.example，重命名为cluster.conf：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210409212459292.png" alt="image-20210409212459292"></p>
<p>然后添加内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1:8845</span><br><span class="line">127.0.0.1.8846</span><br><span class="line">127.0.0.1.8847</span><br></pre></td></tr></table></figure>



<p>然后修改application.properties文件，添加数据库配置</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="attr">db.user.0</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">db.password.0</span>=<span class="string">123456</span></span><br></pre></td></tr></table></figure>



<h2 id="2-4-启动"><a href="#2-4-启动" class="headerlink" title="2.4.启动"></a>2.4.启动</h2><p>将nacos文件夹复制三份，分别命名为：nacos1、nacos2、nacos3</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210409213335538.png" alt="image-20210409213335538"> </p>
<p>然后分别修改三个文件夹中的application.properties，</p>
<p>nacos1:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8845</span></span><br></pre></td></tr></table></figure>

<p>nacos2:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8846</span></span><br></pre></td></tr></table></figure>

<p>nacos3:</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8847</span></span><br></pre></td></tr></table></figure>



<p>然后分别启动三个nacos节点：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">startup.cmd</span><br></pre></td></tr></table></figure>



<h2 id="2-5-nginx反向代理"><a href="#2-5-nginx反向代理" class="headerlink" title="2.5.nginx反向代理"></a>2.5.nginx反向代理</h2><p>找到课前资料提供的nginx安装包： </p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210410103253355.png" alt="image-20210410103253355"> </p>
<p>解压到任意非中文目录下：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20210410103322874.png" alt="image-20210410103322874"> </p>
<p>修改conf&#x2F;nginx.conf文件，配置如下：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">upstream</span> nacos-cluster &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8845</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">127.0.0.1:8846</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">127.0.0.1:8847</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /nacos &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://nacos-cluster;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>而后在浏览器访问：<a href="http://localhost/nacos%E5%8D%B3%E5%8F%AF%E3%80%82">http://localhost/nacos即可。</a></p>
<p>代码中application.yml文件配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:80</span> <span class="comment"># Nacos地址</span></span><br></pre></td></tr></table></figure>



<h2 id="2-6-优化"><a href="#2-6-优化" class="headerlink" title="2.6.优化"></a>2.6.优化</h2><ul>
<li><p>实际部署时，需要给做反向代理的nginx服务器设置一个域名，这样后续如果有服务器迁移nacos的客户端也无需更改配置.</p>
</li>
<li><p>Nacos的各个节点应该部署到多个不同服务器，做好容灾和隔离</p>
</li>
</ul>
<h1 id="Feign远程调用"><a href="#Feign远程调用" class="headerlink" title="Feign远程调用"></a>Feign远程调用</h1><p>代替restTemplate调用</p>
<h2 id="Feign代替RestTemplate"><a href="#Feign代替RestTemplate" class="headerlink" title="Feign代替RestTemplate"></a>Feign代替RestTemplate</h2><p>先来看一下我们以前使用RestTemplate发起远程调用的代码：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306114716134.png" alt="image-20240306114716134"></p>
<p>存在下面的问题：</p>
<ul>
<li>代码可读性差，编码体验不统一</li>
<li>复杂的url难以维护</li>
</ul>
<p>Feign是一个声明式的http客户端，官方地址：<a href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306114940285.png" alt="image-20240306114940285"></p>
<p>使用Feign的步骤如下：</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--        feign客户端依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--加入spring-cloud-loadbalancer依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在order-service的启动类添加注解开启Feign的功能：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306115729311.png" alt="image-20240306115729311"></p>
</li>
<li><p>编写Feign的客户端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.clients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.order.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306120014392.png" alt="image-20240306120014392"></p>
</li>
<li><p>主要是基于SpringMVC的注解来声明远程调用的信息，比如：</p>
<ul>
<li>请求名称：userservice</li>
<li>请求方式：GET</li>
<li>请求路径：&#x2F;user&#x2F;{id}</li>
<li>请求参数：Long id</li>
<li>返回值类型：User</li>
</ul>
</li>
</ol>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306120656496.png" alt="image-20240306120656496"></p>
<p><font color="red">注意：早期的feign依赖中引入了ribbon，但是最新版的feign已经不使用ribbon做负载均衡了，所以在pom.xml文件中要做如下修改：</font></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306123225620.png" alt="image-20240306123225620"></p>
<p>由于SpringCloud Feign在Hoxton.M2 RELEASED版本之后不再使用Ribbon而是使用spring-cloud-loadbalancer，所以不引入spring-cloud-loadbalancer会报错<br><strong>解决方法</strong><br>加入spring-cloud-loadbalancer依赖 并且在nacos中排除ribbon依赖，不然loadbalancer无效。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--加入spring-cloud-loadbalancer依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-loadbalancer&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>Feign的使用步骤</p>
<ol>
<li>引入依赖</li>
<li>添加@EnableFeignClients注解</li>
<li>编写FeignClient接口</li>
<li>使用FeignClient中定义的方法代替RestTemplate</li>
</ol>
<h2 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h2><p>Fegin运行自定义配置来覆盖默认配置，可以修改的配置如下：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>feign.Logger.Level</td>
<td>修改日志级别</td>
<td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td>
</tr>
<tr>
<td>fegin.codec.Decoder</td>
<td>响应结果的解析器</td>
<td>http远程调用的结果做解析，例如解析json字符串做java对象</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>请求参数编码</td>
<td>将请求参数编码，便于通过http请求发送</td>
</tr>
<tr>
<td>feign.Contract</td>
<td>支持的注解格式</td>
<td>默认是SpringMVC的注解</td>
</tr>
<tr>
<td>feign.Retryer</td>
<td>失败重试机制</td>
<td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td>
</tr>
</tbody></table>
<p>一般我们需要配置的就是日志级别。</p>
<p>配置Feign日志有两种方式：</p>
<p>方式一：配置文件方式</p>
<ol>
<li><p>全局生效（针对一切访问的微服务都生效）：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306125024026.png" alt="image-20240306125024026"></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">logger-level:</span> <span class="string">FULL</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>局部生效：</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306125038151.png" alt="image-20240306125038151"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306125316960.png" alt="image-20240306125316960"></p>
</li>
</ol>
<p>方式二：java代码方式，需要先声明一个Bean：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultFeignConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">logLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而后如果是全局配置，则把它放到@EnableFeignClient这个注解中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration.class)</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306125910273.png" alt="image-20240306125910273"></p>
<p>如果是局部配置，则把他放到FeignClient接口的@FeignClient这个注解中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;userservice&quot;,configuration = FeignClientProperties.FeignClientConfiguration.class)</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306130216664.png" alt="image-20240306130216664"></p>
<p><strong>总结：</strong></p>
<p>Feign的日志配置</p>
<ol>
<li>方式一是配置文件，feign.client.config.xxx.LoggerLevel<ol>
<li>如果xxx是default则代表全局</li>
<li>如果xxx是服务名称，例如userservice则代表某服务</li>
</ol>
</li>
<li>方式二是Java代码配置Logger.Level这个Bean<ol>
<li>如果在@EnableFeignClients注解声明则代表全局</li>
<li>如果在@FeignClient注解中声明则代表某服务</li>
</ol>
</li>
</ol>
<h2 id="Feign使用优化"><a href="#Feign使用优化" class="headerlink" title="Feign使用优化"></a>Feign使用优化</h2><p>Feign底层的客户端实现：（把我们的声明变成http请求，最终发http请求还是会用到别的客户端，默认用的是URLConnection）</p>
<ul>
<li>URLConnection：默认实现，不支持连接池</li>
<li>Apache HttpClient：支持连接池</li>
<li>OKHttp：支持连接池</li>
</ul>
<p>不适用连接池，那么每次请求都要三次握手，资源消耗挺多。</p>
<p>因此优化Feign的性能主要包括：</p>
<ol>
<li>使用连接池代替默认的URLConnection</li>
<li>日志级别，最好用basic或none</li>
</ol>
<p>Feign添加HttpClient的支持：</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置连接池：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="comment"># default全局的配置</span></span><br><span class="line">        <span class="attr">logger-level:</span> <span class="string">BASIC</span> <span class="comment"># 日志级别，BASIC就是基本的请求和响应信息</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启feign对HttpClient的支持</span></span><br><span class="line">    <span class="attr">max-connections:</span> <span class="number">200</span> <span class="comment"># 最大的连接数</span></span><br><span class="line">    <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment"># 每个路径的最大连接数</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306131850349.png" alt="image-20240306131850349"></p>
<h2 id="最佳实践分析"><a href="#最佳实践分析" class="headerlink" title="最佳实践分析"></a>最佳实践分析</h2><p>企业在不断踩坑中总结的最佳实验方式。</p>
<p>方式一（继承）：给消费者的FeignClient和提供者的controller定义统一的父接口作为标准。</p>
<blockquote>
<p>在Spring Cloud中，使用Feign作为声明式的HTTP客户端来调用远程服务时，一个常见的设计模式是定义一个公共的接口，然后在服务提供者（Provider）和服务消费者（Consumer）之间共享这个接口。服务提供者实现这个接口，而服务消费者通过Feign Client使用这个接口发起远程调用。</p>
<p>当你提到“父接口参数列表中的映射不会被继承”，这里的“映射”指的是使用Spring MVC注解（如<code>@RequestMapping</code>、<code>@GetMapping</code>等）来映射HTTP请求路径及其参数的配置。在这种方式中，父接口定义了一系列的方法和相应的映射注解，旨在为服务提供者和消费者提供一个统一的API契约。</p>
<p>缺点是，尽管服务消费者和服务提供者都继承了这个父接口，使得服务的方法签名保持一致，但是继承自父接口的方法在子接口（实现类）中并不会自动继承其映射注解。这意味着，即使服务消费者和服务提供者都实现了相同的方法，服务提供者还是需要显式地在其控制器（Controller）方法上重新声明这些映射注解，以确保Spring能够正确地将HTTP请求映射到相应的方法上。</p>
<p>这种情况下的具体影响是：</p>
<ol>
<li><strong>代码冗余</strong>：服务提供者需要在控制器中重复声明路径和参数映射，即使这些已经在共享的接口中定义过。</li>
<li><strong>维护成本提高</strong>：如果共享接口的定义发生变化，服务提供者需要手动更新控制器中的映射注解，这增加了维护的复杂性和出错的风险。</li>
</ol>
</blockquote>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306150829020.png" alt="image-20240306150829020"></p>
<p>方式二（抽取）：将FeignClient抽取为独立模块，并且将接口相关的POJO，默认的Feign配置都放在这个模块中，提供给所有消费者使用。</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306151345971.png" alt="image-20240306151345971"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306151409095.png" alt="image-20240306151409095"></p>
<h2 id="实现Feign最佳实践"><a href="#实现Feign最佳实践" class="headerlink" title="实现Feign最佳实践"></a>实现Feign最佳实践</h2><p>实现最佳实践方式二的步骤如下：</p>
<ol>
<li>首先创建一个module，命名为feign-api，然后引入feign的starter依赖</li>
<li>将order-service中编写的UserClient、User、DefaultFeignConfiguration都复制到feign-api项目中</li>
<li>在order-service中引入feign-api的依赖</li>
<li>修改order-service中的所有与上述三个组件有关的import部分，改成导入feign-api中的包</li>
<li>重启测试</li>
</ol>
<p>当定义的FeignClient不在SpringBootApplication的扫描包范围时，这些FeignClient无法使用。有两种方式解决：</p>
<p>方式一：指定FeignClient所在包</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306153035072.png" alt="image-20240306153035072"></p>
<p>方式二：指定FeignClient字节码（个人推荐）</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306153042951.png" alt="image-20240306153042951"></p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306154309373.png" alt="image-20240306154309373"></p>
<h1 id="Gateway服务网关"><a href="#Gateway服务网关" class="headerlink" title="Gateway服务网关"></a>Gateway服务网关</h1><p>微服务内部调用使用Feign即可，但是外部调用要使用网关身份认证，确保安全。</p>
<p>为什么需要网关？</p>
<p>网关功能：</p>
<ul>
<li>身份认证和权限校验</li>
<li>服务路由、负载均衡</li>
<li>请求限流</li>
</ul>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306154754436.png" alt="image-20240306154754436"></p>
<p>在SpringCloud中网关的实现包括两种：</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloudGateway则是基于Spring5中提供的WebFlux，属于是响应式编程的实现，具有更好的性能。</p>
<p><img src="/2024/03/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day02-SpringCloud02/image-20240306154943029.png" alt="image-20240306154943029"></p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>搭建网关服务的步骤：</p>
<ol>
<li><p>创建新的module，引入SpringCloudGateway的依赖和nacos的服务发现依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写路由配置及nacos地址</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span> <span class="comment"># 网关端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span> <span class="comment"># 路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="comment"># url: http:127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span> <span class="comment"># 路由的目标地址 lb就是负载均衡。后面跟服务名称</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment"># 这个是按照路径匹配，只要以/user/开头就符合要求</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>微服务</category>
      </categories>
  </entry>
  <entry>
    <title>微服务-day01-SpringCloud01</title>
    <url>/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/</url>
    <content><![CDATA[<h1 id="认识微服务"><a href="#认识微服务" class="headerlink" title="认识微服务"></a>认识微服务</h1><p><strong>单体架构</strong></p>
<p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打包成一个包部署。</p>
<p><strong>优点</strong>：</p>
<ul>
<li><p>架构简单</p>
</li>
<li><p>部署成本低</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304222010702.png" alt="image-20240304222010702"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304222021542.png" alt="image-20240304222021542"></p>
</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>耦合度高</li>
</ul>
<p><strong>分布式架构</strong></p>
<p><strong>分布式架构</strong>：根据业务功能对系统进行拆分，每个业务模块作为独立项目开发，称为一个服务。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>降低服务耦合</li>
<li>有利于服务升级拓展</li>
</ul>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304222326798.png" alt="image-20240304222326798"></p>
<p><strong>服务治理</strong></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304222345181.png" alt="image-20240304222345181"></p>
<p>单体服务时，各个模块之间是可以直接调用代码的，但是分布式架构之后，不同模块之间的代码是不能直接调用的。</p>
<p>分布式架构要考虑的问题：</p>
<ul>
<li>服务拆分粒度如何？</li>
<li>服务集群地址如何维护？</li>
<li>服务之间如何实现远程调用？</li>
<li>服务健康状态如何感知？</li>
</ul>
<p><strong>微服务</strong></p>
<p>微服务是一种经过良好架构设计的<strong>分布式</strong>架构方案，微服务架构特征：</p>
<ul>
<li>单一职责：微服务拆分力度更小，每个服务都对应唯一的业务能力，做到单一职责，避免重复开发</li>
<li>面向服务：微服务对外暴露业务接口</li>
<li>自治：团队独立、技术独立、数据独立、部署独立</li>
<li>隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题</li>
</ul>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304223012163.png" alt="image-20240304223012163"></p>
<p><strong>总结：</strong></p>
<p>单体架构特点？</p>
<ul>
<li>简单方便，高度耦合，扩展性差，适合小型项目。例如：学生管理系统</li>
</ul>
<p>分布式架构特点？</p>
<ul>
<li>松耦合，扩展性好，但架构复杂，难度大。适合大型互联网项目，例如：京东、淘宝</li>
</ul>
<p>微服务：一种良好的分布式架构方案</p>
<ul>
<li>优点：拆分粒度更小、服务更独立、耦合度更低</li>
<li>缺点：架构非常复杂，运维、监控、部署难度提高</li>
</ul>
<h2 id="微服务结构"><a href="#微服务结构" class="headerlink" title="微服务结构"></a><strong>微服务结构</strong></h2><p>微服务这种方案需要技术框架来落地，全球的互联网公司都在积极尝试自己的微服务落地技术。在国内最知名的就是SpringCloud和阿里巴巴的Dubbo。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304223338889.png" alt="image-20240304223338889"></p>
<h2 id="微服务技术对比"><a href="#微服务技术对比" class="headerlink" title="微服务技术对比"></a><strong>微服务技术对比</strong></h2><table>
<thead>
<tr>
<th></th>
<th>Dubbo</th>
<th>SpringCloud</th>
<th>SpringCloudAlibaba</th>
</tr>
</thead>
<tbody><tr>
<td><strong>注册中心</strong></td>
<td>zookeeper、Redis</td>
<td>Eureka、Consul</td>
<td>Nacos、Eureka</td>
</tr>
<tr>
<td><strong>服务远程调用</strong></td>
<td>Dubbo协议</td>
<td>Feign(http协议)</td>
<td>Dubbo、Feign</td>
</tr>
<tr>
<td><strong>配置中心</strong></td>
<td>无</td>
<td>SpringCloudConfig</td>
<td>SpringCloudConfig、Nacos</td>
</tr>
<tr>
<td><strong>服务网关</strong></td>
<td>无</td>
<td>SpringCloudGateway、Zuul</td>
<td>SpringCloudGateway、Zuul</td>
</tr>
<tr>
<td><strong>服务监控和保护</strong></td>
<td>dubbo-admin，功能弱</td>
<td>Hystrix</td>
<td>Sentinel</td>
</tr>
</tbody></table>
<h2 id="企业需求"><a href="#企业需求" class="headerlink" title="企业需求"></a><strong>企业需求</strong></h2><p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304224025830.png" alt="image-20240304224025830"></p>
<h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><ul>
<li><p>SpringCloud是目前国内使用最广泛的微服务框架。官网地址：<a href="https://spring.io/projects/spring-cloud%E3%80%82">https://spring.io/projects/spring-cloud。</a></p>
</li>
<li><p>SpringCloud集成了各种微服务功能组件，并基于SpringBoot实现了这些组件的自动装配，从而提供了良好的开箱即用体验：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304224755309.png" alt="image-20240304224755309"></p>
</li>
</ul>
<h3 id="认识微服务-1"><a href="#认识微服务-1" class="headerlink" title="认识微服务"></a>认识微服务</h3><p>SpringCloud与SpringBoot的版本兼容关系如下所示：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240304224900377.png" alt="image-20240304224900377"></p>
<p>我们课堂使用的版本是Hoxton.SR10，因此对应的SpringBoot版本是2.3.x版本。</p>
<h1 id="分布式服务架构案例"><a href="#分布式服务架构案例" class="headerlink" title="分布式服务架构案例"></a>分布式服务架构案例</h1><h2 id="服务拆分及远程调用"><a href="#服务拆分及远程调用" class="headerlink" title="服务拆分及远程调用"></a>服务拆分及远程调用</h2><p>需求是查询订单，同时也要获取用户和商品关联信息。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305110043023.png" alt="image-20240305110043023"></p>
<p><strong>服务拆分注意事项</strong>：</p>
<ol>
<li>不同微服务，不要重复开发相同业务</li>
<li>微服务数据独立，不要访问其他微服务的数据库</li>
<li>微服务可以将自己的业务暴露为借口，供其他微服务使用</li>
</ol>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305110236577.png" alt="o"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305125822645.png" alt="l"></p>
<p>这边cloud_user和cloud_order分别存放了具体的表内容</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305130639108.png" alt="image-20240305130639108"></p>
<p>Cloud_order数据库和表结构</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : local</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 50622</span></span><br><span class="line"><span class="comment"> Source Host           : localhost:3306</span></span><br><span class="line"><span class="comment"> Source Schema         : heima</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 50622</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 01/04/2021 14:57:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> cloud_order ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for tb_order</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_order`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_order`  (</span><br><span class="line">                             `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">                             `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">                             `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">                             `price` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品价格&#x27;</span>,</span><br><span class="line">                             `num` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;商品数量&#x27;</span>,</span><br><span class="line">                             <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">                             <span class="keyword">UNIQUE</span> INDEX `username`(`name`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">109</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of tb_order</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">101</span>, <span class="number">1</span>, <span class="string">&#x27;Apple 苹果 iPhone 12 &#x27;</span>, <span class="number">699900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">102</span>, <span class="number">2</span>, <span class="string">&#x27;雅迪 yadea 新国标电动车&#x27;</span>, <span class="number">209900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">103</span>, <span class="number">3</span>, <span class="string">&#x27;骆驼（CAMEL）休闲运动鞋女&#x27;</span>, <span class="number">43900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">104</span>, <span class="number">4</span>, <span class="string">&#x27;小米10 双模5G 骁龙865&#x27;</span>, <span class="number">359900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">105</span>, <span class="number">5</span>, <span class="string">&#x27;OPPO Reno3 Pro 双模5G 视频双防抖&#x27;</span>, <span class="number">299900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">106</span>, <span class="number">6</span>, <span class="string">&#x27;美的（Midea) 新能效 冷静星II &#x27;</span>, <span class="number">544900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">107</span>, <span class="number">2</span>, <span class="string">&#x27;西昊/SIHOO 人体工学电脑椅子&#x27;</span>, <span class="number">79900</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_order` <span class="keyword">VALUES</span> (<span class="number">108</span>, <span class="number">3</span>, <span class="string">&#x27;梵班（FAMDBANN）休闲男鞋&#x27;</span>, <span class="number">31900</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>Cloud_user数据库和对应表结构</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : local</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 50622</span></span><br><span class="line"><span class="comment"> Source Host           : localhost:3306</span></span><br><span class="line"><span class="comment"> Source Schema         : heima</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 50622</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 01/04/2021 14:57:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">create database <span class="keyword">if</span> not exists cloud_user;</span><br><span class="line"></span><br><span class="line">SET NAMES utf8mb4;</span><br><span class="line"><span class="type">SET</span> <span class="variable">FOREIGN_KEY_CHECKS</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure <span class="keyword">for</span> tb_user</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS `tb_user`;</span><br><span class="line">CREATE TABLE `tb_user`  (</span><br><span class="line">                            `id` bigint(<span class="number">20</span>) NOT NULL AUTO_INCREMENT,</span><br><span class="line">                            `username` varchar(<span class="number">100</span>) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;收件人&#x27;</span>,</span><br><span class="line">                            `address` varchar(<span class="number">255</span>) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">                            PRIMARY <span class="title function_">KEY</span> <span class="params">(`id`)</span> USING BTREE,</span><br><span class="line">                            UNIQUE INDEX `username`(`username`) USING BTREE</span><br><span class="line">) ENGINE = <span class="type">InnoDB</span> <span class="variable">AUTO_INCREMENT</span> <span class="operator">=</span> <span class="number">109</span> <span class="type">CHARACTER</span> <span class="variable">SET</span> <span class="operator">=</span> <span class="type">utf8</span> <span class="variable">COLLATE</span> <span class="operator">=</span> <span class="type">utf8_general_ci</span> <span class="variable">ROW_FORMAT</span> <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of tb_user</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO `tb_user` VALUES (<span class="number">1</span>, <span class="string">&#x27;柳岩&#x27;</span>, <span class="string">&#x27;湖南省衡阳市&#x27;</span>);</span><br><span class="line">INSERT INTO `tb_user` VALUES (<span class="number">2</span>, <span class="string">&#x27;文二狗&#x27;</span>, <span class="string">&#x27;陕西省西安市&#x27;</span>);</span><br><span class="line">INSERT INTO `tb_user` VALUES (<span class="number">3</span>, <span class="string">&#x27;华沉鱼&#x27;</span>, <span class="string">&#x27;湖北省十堰市&#x27;</span>);</span><br><span class="line">INSERT INTO `tb_user` VALUES (<span class="number">4</span>, <span class="string">&#x27;张必沉&#x27;</span>, <span class="string">&#x27;天津市&#x27;</span>);</span><br><span class="line">INSERT INTO `tb_user` VALUES (<span class="number">5</span>, <span class="string">&#x27;郑爽爽&#x27;</span>, <span class="string">&#x27;辽宁省沈阳市大东区&#x27;</span>);</span><br><span class="line">INSERT INTO `tb_user` VALUES (<span class="number">6</span>, <span class="string">&#x27;范兵兵&#x27;</span>, <span class="string">&#x27;山东省青岛市&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">SET</span> <span class="variable">FOREIGN_KEY_CHECKS</span> <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>总结：</p>
<ol>
<li>微服务需要根据业务模块拆分，做到单一职责，不要重复开发相同业务</li>
<li>微服务可以将业务暴露为接口，供其他微服务使用</li>
<li>不同微服务都应该有自己独立的数据库</li>
</ol>
<h2 id="案例：根据订单id查询订单功能"><a href="#案例：根据订单id查询订单功能" class="headerlink" title="案例：根据订单id查询订单功能"></a>案例：根据订单id查询订单功能</h2><p>需求：根据订单id查询订单的同时，把订单所属的用户信息一起返回</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305131615122.png" alt="image-20240305131615122"></p>
<p><font color="red">我们从浏览器可以访问不同模块，那同一个模块能不能用类似的方式访问另一个模块，获取需要的数据呢？</font></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305131727010.png" alt="image-20240305131727010"></p>
<p>要想实现跨服务远程调用，其实是发送Http请求，首先要向Spring容器注入RestTemplate对象。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305132430060.png" alt="image-20240305132430060"></p>
<p>利用ResTemplate对象中的getForObject方法，告诉该对象请求的浏览路径和返回的数据的数据类型。修改order-service中的OrderService的queryOrderById方法。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305132532322.png" alt="image-20240305132532322"></p>
<p>总结：</p>
<ol>
<li>微服务调用方式<ul>
<li>基于RestTemplate发起的http请求实现远程调用</li>
<li>http请求做远程调用是与语言无关的调用，只要知道对方的ip、端口、接口路径、请求参数即可。</li>
</ul>
</li>
</ol>
<h1 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h1><h2 id="提供者与消费者"><a href="#提供者与消费者" class="headerlink" title="提供者与消费者"></a>提供者与消费者</h2><ul>
<li>服务提供者：一次业务中，被其他微服务调用的服务。（提供接口给其他微服务）</li>
<li>服务消费者：一次业务中，调用其他微服务的服务。（调用其他微服务提供的接口）</li>
<li>提供者和消费者角色其实是<strong>相对</strong>的</li>
</ul>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305132830113.png" alt="image-20240305132830113"></p>
<p>思考：服务A调用了服务B，服务B调用了服务C，那么服务B是什么角色呢？</p>
<p><font color="red">一个服务既可以是提供者也可以是消费者。</font></p>
<h2 id="远程调用的问题"><a href="#远程调用的问题" class="headerlink" title="远程调用的问题"></a>远程调用的问题</h2><p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305133142579-17096167028611.png" alt="image-20240305133142579"></p>
<p>消费者向提供者请求服务时，请求地址是硬编码的方式。</p>
<ol>
<li><p>对于维护请求地址很困难。</p>
</li>
<li><p>为了应对高并发，user服务可能会部署为多实例，形成一个集群，这个时候硬编码该写谁的地址呢？</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305133409858.png" alt="image-20240305133409858"></p>
</li>
</ol>
<p><strong>问题</strong>：</p>
<p>服务消费者该如何获取服务提供者的地址信息？</p>
<ul>
<li>服务提供者启动时向eureka注册自己的信息</li>
<li>eureka保存这些信息</li>
<li>消费者根据服务名称向eureka拉取提供者信息</li>
</ul>
<p>如果有多个服务提供者，消费者该如何选择？</p>
<ul>
<li>服务消费者利用负载均衡算法，从服务列表中挑选一个</li>
</ul>
<p>消费者如何得知服务提供者的健康状态？</p>
<ul>
<li>服务提供者每隔30秒向EurekaServer发送心跳请求，报告健康状态</li>
<li>eureka会更新记录服务列表信息，心跳不正常会被剔除</li>
<li>消费者就可以拉取到最新的消息</li>
</ul>
<h2 id="eureka原理"><a href="#eureka原理" class="headerlink" title="eureka原理"></a>eureka原理</h2><p>eureka-server：注册中心（记录和管理微服务）</p>
<p>eureka-client：客户端</p>
<ol>
<li><p>只要是eureka的客户端，每一个服务启动时都会向eureka-server注册服务信息。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305133643568.png" alt="image-20240305133643568"></p>
</li>
<li><p>服务消费者会去拉取服务user-service的信息，利用负载均衡的方式从中选择一个链接远程调用服务提供者提供的方法。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305134002828.png" alt="image-20240305134002828"></p>
</li>
<li><p>服务提供者每隔30秒会向注册中心中更新服务信息</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305134036204.png" alt="image-20240305134036204"></p>
</li>
</ol>
<p><strong>总结：</strong></p>
<p>在Eureka架构中，微服务角色有两类：</p>
<ul>
<li>EurekaServer：服务端，注册中心<ul>
<li>记录服务信息</li>
<li>心跳监控</li>
</ul>
</li>
<li>EurekaClient：客户端<ul>
<li>Provider：服务提供者，例如案例中的user-service<ul>
<li>注册自己的信息到EurekaServer</li>
<li>每隔30秒向EurekaServer发送心跳</li>
</ul>
</li>
<li>Consumer：服务消费者，例如案例中的order-service<ul>
<li>根据服务名称从EurekaServer中拉去服务列表</li>
<li>基于服务列表做负载均衡，选中一个微服务后发起远程调用</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="搭建EurekaService"><a href="#搭建EurekaService" class="headerlink" title="搭建EurekaService"></a>搭建EurekaService</h2><p><strong>动手实践</strong></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305134609345.png" alt="image-20240305134609345"></p>
<p>搭建EurekaServer服务步骤如下：</p>
<ol>
<li><p>创建项目，引入spring-cloud-starter-netflix-eureka-server的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写启动类，添加@EnableEurekaServer注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加application.yml文件，编写下面的配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10086</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span> <span class="comment"># eureka的服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># eureka的地址信息</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><font color="red">eureka也是微服务，它启动时会将自己注册到eureka上。多个eureka集群会相互交流。</font></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305144137305.png" alt="image-20240305144137305"></p>
<p><strong>总结</strong>：</p>
<ol>
<li>搭建EurekaServer<ul>
<li>引入eureka-server依赖</li>
<li>添加@EnableEurekaServer注解</li>
<li>在application.yml中配置eureka地址</li>
</ul>
</li>
</ol>
<h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><p>将user-service服务注册到EurekaServer步骤如下：</p>
<ol>
<li><p>在user-service项目中引入spring-cloud-starter-netflix-eureka-client的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在application.yml文件，编写下面的配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span> <span class="comment"># eureka的服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment"># eureka的地址信息</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>另外，我们可以将user-service多次启动，模拟多实例部署，但为了避免端口冲突，需要修改端口设置：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305150330649.png" alt="image-20240305150330649"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305150617320.png" alt="image-20240305150617320"></p>
<p><strong>总结</strong>：</p>
<ol>
<li>服务注册</li>
</ol>
<ul>
<li>引入eureka-client依赖</li>
<li>在application.yml中配置eureka地址</li>
</ul>
<ol start="2">
<li>无论是消费者还是提供者，引入eureka-client依赖，知道eureka地址后，都可以完成服务注册。</li>
</ol>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>服务拉取是基于服务名称获取服务列表，然后对列表服务做负载均衡。</p>
<ol>
<li><p>修改OrderService的代码，修改访问的url路径，用服务名代替ip、端口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://userservice/user/&quot;</span> + order.getUserId();</span><br></pre></td></tr></table></figure>
</li>
<li><p>在order-service项目的启动OrderApplication中的RestTemplate添加<strong>负载均衡</strong>注释：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="keyword">public</span> RestTempalte <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>总结</strong></p>
<ol>
<li><p>搭建EurekaServer</p>
<ul>
<li>引入eureka-server依赖</li>
<li>添加@EnableEurekaServer注解</li>
<li>在application.yml中配置eureka地址</li>
</ul>
</li>
<li><p>服务注册</p>
<ul>
<li>引入eureka-client依赖</li>
<li>在application.yml中配置eureka地址</li>
</ul>
</li>
<li><p>服务发现</p>
<ul>
<li>引入eureka-client依赖</li>
<li>在application.yml中配置eureka地址</li>
<li>给RestTemplate添加@LoadBalanced注解</li>
<li>用服务提供者提供的服务远程名称远程调用</li>
</ul>
</li>
</ol>
<h1 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h1><p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305152722949.png" alt="image-20240305152722949"></p>
<h2 id="负载均衡原理"><a href="#负载均衡原理" class="headerlink" title="负载均衡原理"></a>负载均衡原理</h2><p><font color="red">@LoadBalanced标记restTemplate发起的请求会被ribbon拦截。</font></p>
<p>当请求进入ribbon时，会被LoadBalanceInterceptor负载均衡拦截器拦截，拦截之后得到请求中的服务名称，即userservice，并将其交给RibbonLoadBalanceClient，它会将服务id交给DynamicServerListLoadBalancer，它回去eureka-server中拉去服务列表，并从IRule中执行服务负载均衡并返回某个服务，最终发送url。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305154036947.png" alt="image-20240305154036947"></p>
<h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2><p>Ribbon的负载均衡规则是一个叫做IRule的接口来定义的，每一个子接口多是一种规则。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305154210711.png" alt="image-20240305154210711"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305154229387.png" alt="image-20240305154229387"></p>
<p>通过定义IRule实现可以修改负载均衡规则，有两种方式：</p>
<ol>
<li><p>代码方式：在order-service中的OrderApplication类中，定义一个新的Rule：（上述是全局配置，表示访问任何服务时均执行同种负载均衡策略）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件方式：在order-service的application.yml文件，添加新的配置也可以修改规则：（上述是针对userservice服务单独设置的负载均衡策略）</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalanceRuleClassName:</span> <span class="string">com.netflex.loadbalancer.RandomRule</span> <span class="comment"># 负载均衡规则</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h2><p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间较长。</p>
<p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ribbon:</span><br><span class="line">  eager-load:</span><br><span class="line">    enabled: <span class="literal">true</span> # 开启饥饿加载</span><br><span class="line">    clients: </span><br><span class="line">      - userservice # 指定对userservice这个服务饥饿加载</span><br><span class="line">      # - xxx</span><br></pre></td></tr></table></figure>





<p><strong>总结</strong></p>
<ol>
<li>Ribbon负载均衡规则<ul>
<li>规则接口时IRule</li>
<li>默认实现是ZoneAvoidanceRule，根据zone选择服务列表，然后轮询</li>
</ul>
</li>
<li>负载均衡自定义方式<ul>
<li>代码方式：配置灵活，但修改时需要重新打包发布</li>
<li>配置方式：直观、方便，无需重新打包发布，但无法做到全局配置</li>
</ul>
</li>
<li>饥饿加载<ul>
<li>开启饥饿加载</li>
<li>指定饥饿加载的微服务名称</li>
</ul>
</li>
</ol>
<h1 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h1><h2 id="认识和安装Nacos"><a href="#认识和安装Nacos" class="headerlink" title="认识和安装Nacos"></a>认识和安装Nacos</h2><p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305161140438.png" alt="image-20240305161140438"></p>
<p>开发阶段采用单机安装即可。</p>
<h2 id="1-1-下载安装包"><a href="#1-1-下载安装包" class="headerlink" title="1.1.下载安装包"></a>1.1.下载安装包</h2><p>在Nacos的GitHub页面，提供有下载链接，可以下载编译好的Nacos服务端或者源代码：</p>
<p>GitHub主页：<a href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a></p>
<p>GitHub的Release下载页：<a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p>
<p>如图：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402161102887.png" alt="image-20210402161102887"></p>
<p>本课程采用1.4.1.版本的Nacos，课前资料已经准备了安装包：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402161130261.png" alt="image-20210402161130261"></p>
<p>windows版本使用<code>nacos-server-1.4.1.zip</code>包即可。</p>
<h2 id="1-2-解压"><a href="#1-2-解压" class="headerlink" title="1.2.解压"></a>1.2.解压</h2><p>将这个包解压到任意非中文目录下，如图：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402161843337.png" alt="image-20210402161843337"></p>
<p>目录说明：</p>
<ul>
<li>bin：启动脚本</li>
<li>conf：配置文件</li>
</ul>
<h2 id="1-3-端口配置"><a href="#1-3-端口配置" class="headerlink" title="1.3.端口配置"></a>1.3.端口配置</h2><p>Nacos的默认端口是8848，如果你电脑上的其它进程占用了8848端口，请先尝试关闭该进程。</p>
<p><strong>如果无法关闭占用8848端口的进程</strong>，也可以进入nacos的conf目录，修改配置文件中的端口：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402162008280.png" alt="image-20210402162008280"></p>
<p>修改其中的内容：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402162251093.png" alt="image-20210402162251093"></p>
<h2 id="1-4-启动"><a href="#1-4-启动" class="headerlink" title="1.4.启动"></a>1.4.启动</h2><p>启动非常简单，进入bin目录，结构如下：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402162350977.png" alt="image-20210402162350977"></p>
<p>然后执行命令即可：</p>
<ul>
<li><p>windows命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">startup.cmd -m standalone</span><br></pre></td></tr></table></figure></li>
</ul>
<p>执行后的效果如图：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402162526774.png" alt="image-20210402162526774"></p>
<h2 id="1-5-访问"><a href="#1-5-访问" class="headerlink" title="1.5.访问"></a>1.5.访问</h2><p>在浏览器输入地址：<a href="http://127.0.0.1:8848/nacos%E5%8D%B3%E5%8F%AF%EF%BC%9A">http://127.0.0.1:8848/nacos即可：</a></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402162630427.png" alt="image-20210402162630427"></p>
<p>默认的账号和密码都是nacos，进入后：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20210402162709515.png" alt="image-20210402162709515"></p>
<h2 id="Nacos快速入门"><a href="#Nacos快速入门" class="headerlink" title="Nacos快速入门"></a>Nacos快速入门</h2><ol>
<li><p>在cloud-demo父工程中添加spring-cloud-alibaba的管理依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注释掉order-service和user-service中原有的eureka依赖。</p>
</li>
<li><p>添加nacos的客户端依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- nacos客户端依赖包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改user-service&amp;order-service中的application.yml文件，注释掉eureka地址，添加nacos地址：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305163148480.png" alt="image-20240305163148480"></p>
</li>
<li><p>启动并测试</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305163846124.png" alt="image-20240305163846124"></p>
</li>
</ol>
<p><strong>总结</strong></p>
<ol>
<li>Nacos服务搭建<ol>
<li>下载安装包</li>
<li>解压</li>
<li>在bin目录下运行指令：startup.cmd -m standalone</li>
</ol>
</li>
<li>Nacos服务注册或发现<ol>
<li>引入nacos.discovery依赖</li>
<li>配置nacos地址spring.cloud.nacos.server-addr</li>
</ol>
</li>
</ol>
<h2 id="Nacos服务分级存储模型"><a href="#Nacos服务分级存储模型" class="headerlink" title="Nacos服务分级存储模型"></a>Nacos服务分级存储模型</h2><p>所有实例放在一个机房，如果机房宕机，整个服务都停了。</p>
<p><font color="red">同在一个机房的多个实例作为一个集群。</font></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305164414812.png" alt="image-20240305164414812"></p>
<p>服务调用尽可能选择本地集群的服务，跨集群调用延迟较高。</p>
<p>本地集群不可访问时，再去访问其他集群。</p>
<p> <img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305164535787.png" alt="image-20240305164535787"></p>
<p>配置服务集群属性：</p>
<ol>
<li><p>修改application.yml，添加如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务器地址</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">cluster-name:</span> <span class="string">HZ</span> <span class="comment">#配置集群名称，也就是机房位置，例如：HZ，杭州  </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在Nacos控制台可以看到集群变化：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305165037959.png" alt="image-20240305165037959"></p>
</li>
</ol>
<p><strong>总结</strong>：</p>
<ol>
<li>Nacos服务分级存储模型<ol>
<li>一级是服务，例如userservice</li>
<li>二级是集群，例如杭州或上海</li>
<li>三级是实例，例如杭州机房的某台部署了userservice的服务器</li>
</ol>
</li>
<li>如何设置实例的集群属性<ol>
<li>修改application.yml文件，添加spring.cloud.nacos.discovery.cluster-name属性即可</li>
</ol>
</li>
</ol>
<h2 id="NacosRule负载均衡"><a href="#NacosRule负载均衡" class="headerlink" title="NacosRule负载均衡"></a>NacosRule负载均衡</h2><p>我们修改user-service配置，达到以下的效果：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305202406876.png" alt="image-20240305202406876"></p>
<p><strong>修改集群负载均衡</strong></p>
<ol>
<li><p>修改order-service中的application.yml，设置集群为HZ：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#nacos服务端地址</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">cluster-name:</span> <span class="string">HZ</span> <span class="comment">#配置集群名称，也就是机房位置</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在order-service中设置负载均衡的IRule为NacosRule，这个规则优先寻找与自己同集群的服务，在本地集群中的多个服务中选择随机方式进行负载均衡：</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305211206181.png" alt="image-20240305211206181"></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">	<span class="attr">ribbon:</span></span><br><span class="line">		<span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span class="comment"># 负载均衡规则</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注意将user-service的权重都设置为1</p>
</li>
</ol>
<p><strong>总结</strong></p>
<ol>
<li>NacosRule负载均衡策略<ol>
<li>优先选择同集群服务实例列表</li>
<li>本地集群找不到提供者，才去其他集群寻找，并且会报警告</li>
<li>确定了可用实例列表后，再采用随机负载挑选实例</li>
</ol>
</li>
</ol>
<h2 id="Nacos服务实例的权重设置"><a href="#Nacos服务实例的权重设置" class="headerlink" title="Nacos服务实例的权重设置"></a>Nacos服务实例的权重设置</h2><p>实际部署中会出现的场景：</p>
<ul>
<li>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求</li>
<li>Nacos提供了权重配置来控制访问频率，权重越大则访问评率越高</li>
</ul>
<ol>
<li><p>在Nacos控制台可以设置实例的权重值，首先选中实例后面的编辑按钮</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305210956184.png" alt="image-20240305210956184"></p>
</li>
<li><p>将权重设置为0.1，测试可以发现8081被访问到的频率大大降低</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305211103036.png" alt="image-20240305211103036"></p>
</li>
</ol>
<p>权重设计，可以让新版本的服务权重从小不断增加，先让小部分用户测试新版本，没问题再升级权重。</p>
<p><strong>总结</strong></p>
<p>实例的权重控制</p>
<ol>
<li>Nacos控制台可以设置实例的权重值，0~1之间</li>
<li>同集群内的多个实例，权重越高被访问的概率越高</li>
<li>权重设置为0则完全不会被访问</li>
</ol>
<h2 id="Nacos环境隔离"><a href="#Nacos环境隔离" class="headerlink" title="Nacos环境隔离"></a>Nacos环境隔离</h2><p><strong>环境隔离 - namespace</strong></p>
<p>nacos不仅是注册中心，还是数据中心，为了数据的管理，他会做环境隔离。</p>
<p>Nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305211640168.png" alt="image-20240305211640168"></p>
<p>在Nacos控制台可以创建namespace，用来隔离不同环境</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212005285.png" alt="image-20240305212005285"></p>
<p> <img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212128956.png" alt="image-20240305212128956"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212136338.png" alt="image-20240305212136338"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212142930.png" alt="image-20240305212142930"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212443910.png" alt="image-20240305212443910"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212423014.png" alt="image-20240305212423014"></p>
<p>要想服务可以运行，要将其放在相同目录下。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212619177.png" alt="image-20240305212619177"></p>
<p><strong>总结</strong></p>
<ol>
<li>Nacos环境隔离<ol>
<li>namespace用来做环境隔离</li>
<li>每个namespace都有唯一id</li>
<li>不同namespace下的服务不可见</li>
</ol>
</li>
</ol>
<h2 id="Nacos和Eureka的对比"><a href="#Nacos和Eureka的对比" class="headerlink" title="Nacos和Eureka的对比"></a>Nacos和Eureka的对比</h2><p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305212953635.png" alt="image-20240305212953635"></p>
<p>在nacos中，实例分为临时实例和非临时实例。默认情况下，所有实例都是临时实例，其中临时实例如下所示</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305213236381.png" alt="image-20240305213236381"></p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305213330438.png" alt="image-20240305213330438"></p>
<p>临时实例的心跳检测失败则直接删除注册。</p>
<p>非临时实例，nacos会主动询问。如果非临时实例不健康了，不会将其从注册中心中移除，而是将其标记为不健康。等待其回复健康。</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305213427089.png" alt="image-20240305213427089"></p>
<p>nacos发现有服务挂了，会向消费者主动推送变更消息push</p>
<p><img src="/2024/03/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day01-SpringCloud01/image-20240305213558721.png" alt="image-20240305213558721"></p>
<p><strong>临时实例和非临时实例</strong></p>
<p>服务注册到Nacos时，可以选择注册为临时或非临时实例，通过下面的配置来设置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment">#设置为非临时实例</span></span><br></pre></td></tr></table></figure>



<p><strong>总结</strong></p>
<p>Nacos与eureka的共同点</p>
<ol>
<li>都支持服务注册和服务拉取</li>
<li>都支持服务提供者心跳方式做健康检测</li>
</ol>
<p>Nacos与Eureka的区别</p>
<ol>
<li>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</li>
<li>临时实例心跳不正常会被提出，非临时实例则不会被剔除</li>
<li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li>
<li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka默认采用AP模式。</li>
</ol>
]]></content>
      <categories>
        <category>微服务</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day12-数据统计</title>
    <url>/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="数据报表"><a href="#数据报表" class="headerlink" title="数据报表"></a>数据报表</h1><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304185718012.png" alt="image-20240304185718012"></p>
<h1 id="工作台"><a href="#工作台" class="headerlink" title="工作台"></a>工作台</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p> 工作台是系统运营的数据看板， 并提供快捷操作入口，可以有效提高商家的工作效率。</p>
<p>工作台展示的数据：</p>
<ul>
<li>进入数据</li>
<li>订单管理</li>
<li>菜品总览</li>
<li>套餐总览</li>
<li>订单信息</li>
</ul>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304190903243.png" alt="image-20240304190903243"></p>
<p>名词解释：</p>
<ul>
<li>营业额：已完成订单的总金额</li>
<li>有效订单：已完成订单的数量</li>
<li>订单完成率：有效订单数&#x2F;总订单数 * 100%</li>
<li>平均客单价：营业额&#x2F;有效订单数</li>
<li>新增用户：新增用户的数量</li>
</ul>
<p><strong>接口设计</strong></p>
<ul>
<li>今日数据接口</li>
<li>订单管理接口</li>
<li>菜品总览接口</li>
<li>套餐总览接口</li>
<li>订单搜索（已完成）</li>
<li>各个状态的订单数量统计（已完成）</li>
</ul>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304191802637.png" alt="image-20240304191802637"></p>
<p><strong>今日数据的接口设计：</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304191959537.png" alt="image-20240304191959537"></p>
<p><strong>订单管理的接口设计：</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304192054014.png" alt="image-20240304192054014"></p>
<p><strong>菜品总览的接口设计：</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304192132813.png" alt="image-20240304192132813"></p>
<p><strong>套餐总览的接口设计：</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304192154803.png" alt="image-20240304192154803"></p>
<h2 id="代码导入"><a href="#代码导入" class="headerlink" title="代码导入"></a>代码导入</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304192915915.png" alt="image-20240304192915915"></p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304192930839.png" alt="image-20240304192930839"></p>
<h2 id="Apache-POI"><a href="#Apache-POI" class="headerlink" title="Apache POI"></a>Apache POI</h2><p>Apache POI是一个处理Miscrosoft Office各种文件格式的开源项目。简单来说就是，我们可以用POI在Java程序中对Miscrosoft Office各种文件进行读写操作。</p>
<p>一般情况下，POI都是操作Excel文件。</p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304194119767.png" alt="image-20240304194119767"></p>
<p>Apache POI的应用场景：</p>
<ul>
<li>银行网银系统导出交易明细</li>
<li>各种业务系统导出Excel报表</li>
<li>批量导入业务数据</li>
</ul>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304194154240.png" alt="image-20240304194154240"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304194228057.png" alt="image-20240304194228057"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304194246336.png" alt="image-20240304194246336"></p>
<h2 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h2><p>Apache POI的maven坐标：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- poi --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;poi&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;poi&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写案例代码：</p>
<p><strong>写入excel文件内容</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用POI操作Excel文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POITest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过POI创建Excel文件并且写入文件内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//在内存中创建一个excel文件</span></span><br><span class="line">        <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>();</span><br><span class="line">        <span class="comment">//在Excel文件中创建一个sheet页</span></span><br><span class="line">        <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.createSheet(<span class="string">&quot;info&quot;</span>);</span><br><span class="line">        <span class="comment">//在Sheet中创建行对象,rownum编号从0开始</span></span><br><span class="line">        <span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//创建单元格，给文件写入内容</span></span><br><span class="line">        row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;姓名&quot;</span>);</span><br><span class="line">        row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;城市&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建一个新行</span></span><br><span class="line">        row = sheet.createRow(<span class="number">2</span>);</span><br><span class="line">        row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;吴康惠&quot;</span>);</span><br><span class="line">        row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;杭州&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建一个新行</span></span><br><span class="line">        row = sheet.createRow(<span class="number">3</span>);</span><br><span class="line">        row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;陈梦婷&quot;</span>);</span><br><span class="line">        row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;上海&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过输出流将内存中的excel文件写入到磁盘</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\info.xlsx&quot;</span>));</span><br><span class="line">        excel.write(out);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        out.close();</span><br><span class="line">        excel.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        write();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>读取excel文件内容</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用POI操作Excel文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POITest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过POI读取Excel文件中的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\info.xlsx&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取磁盘上已经存在的excel文件，并将其封装为excel</span></span><br><span class="line">        <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(file);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取excel文件中的第一个sheet页</span></span><br><span class="line">        <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheetAt(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取Sheet页中最后一行的行号</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastRowNum</span> <span class="operator">=</span> sheet.getLastRowNum();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;=  lastRowNum; i++) &#123;</span><br><span class="line">            <span class="comment">//获取第一行</span></span><br><span class="line">            <span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.getRow(i);</span><br><span class="line">            <span class="comment">//获得单元格</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cellValue1</span> <span class="operator">=</span> row.getCell(<span class="number">1</span>).getStringCellValue();</span><br><span class="line">            <span class="type">String</span> <span class="variable">cellValue2</span> <span class="operator">=</span> row.getCell(<span class="number">2</span>).getStringCellValue();</span><br><span class="line">            System.out.println(cellValue1 + <span class="string">&quot; &quot;</span> +  cellValue2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        excel.close();</span><br><span class="line">        file.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="导出运营数据Excel报表"><a href="#导出运营数据Excel报表" class="headerlink" title="导出运营数据Excel报表"></a>导出运营数据Excel报表</h2><h3 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h3><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304201916592.png" alt="image-20240304201916592"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304202038081.png" alt="image-20240304202038081"></p>
<p>业务规则：</p>
<ul>
<li>导出Excel形式的报表文件</li>
<li>导出最近30天的运营数据（通过输出流向客户端写出文件）</li>
</ul>
<p><strong>接口设计</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304202329131.png" alt="image-20240304202329131"></p>
<p>注意：当前接口是没有返回数据的，因为报表导出功能本质上是文件下载，服务端会通过输出流将Excel文件下载到客户端浏览器。</p>
<h3 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h3><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304202458088.png" alt="image-20240304202458088"></p>
<p>实现步骤：</p>
<ol>
<li>设计Excel模板文件（包含了各种合并单元格和背景颜色）</li>
<li>查询近30天的运营数据</li>
<li>将查询到的运营数据写入到模板文件</li>
<li>通过输出流将Excel文件下载到客户端浏览器</li>
</ol>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304202855053.png" alt="image-20240304202855053"></p>
<p><strong>ReportController</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出运营数据报表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;导出运营数据报表&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/export&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">    reportService.exportBusinessData(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出运营数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">exportBusinessData</span><span class="params">(HttpServletResponse response)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ReportServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出运营数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportBusinessData</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1. 查询数据库，获取营业数据 -- 查询最近30天的运营数据</span></span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">dateBegin</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">30</span>);</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">dateEnd</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(dateBegin, LocalTime.MIN);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(dateBegin, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询概览数据</span></span><br><span class="line">    <span class="type">BusinessDataVO</span> <span class="variable">businessData</span> <span class="operator">=</span> workspaceService.getBusinessData(beginTime, endTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 通过POI将数据写入到Excel文件中</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;template/运营数据报表模板&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于模板文件创建一个新的excel文件</span></span><br><span class="line">    <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(in);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 通过输出流将Excel文件下载至客户端浏览器</span></span><br><span class="line">    <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据 -- 时间</span></span><br><span class="line">    sheet.getRow(<span class="number">1</span>).getCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;时间：&quot;</span> + dateBegin + <span class="string">&quot;至&quot;</span> + dateEnd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据 -- 营业额 | 订单完成率 | 新增用户数</span></span><br><span class="line">    sheet.getRow(<span class="number">3</span>).getCell(<span class="number">2</span>).setCellValue(businessData.getTurnover());</span><br><span class="line">    sheet.getRow(<span class="number">3</span>).getCell(<span class="number">4</span>).setCellValue(businessData.getOrderCompletionRate());</span><br><span class="line">    sheet.getRow(<span class="number">3</span>).getCell(<span class="number">6</span>).setCellValue(businessData.getNewUsers());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据 -- 有效订单数 | 平均客单价</span></span><br><span class="line">    sheet.getRow(<span class="number">4</span>).getCell(<span class="number">2</span>).setCellValue(businessData.getValidOrderCount());</span><br><span class="line">    sheet.getRow(<span class="number">4</span>).getCell(<span class="number">4</span>).setCellValue(businessData.getUnitPrice());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充明细数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> dateBegin.plusDays(i);</span><br><span class="line">        <span class="comment">//查询某一天的营业数据</span></span><br><span class="line">        <span class="type">BusinessDataVO</span> <span class="variable">businessDataVO</span> <span class="operator">=</span> workspaceService.getBusinessData(LocalDateTime.of(date, LocalTime.MIN), LocalDateTime.of(date, LocalTime.MAX));</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">1</span>).setCellValue(date.toString());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">2</span>).setCellValue(businessDataVO.getTurnover());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">3</span>).setCellValue(businessDataVO.getValidOrderCount());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">4</span>).setCellValue(businessDataVO.getOrderCompletionRate());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">5</span>).setCellValue(businessDataVO.getUnitPrice());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">6</span>).setCellValue(businessDataVO.getNewUsers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过输出流对象下载数据到客户端浏览器</span></span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    excel.write(out);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源</span></span><br><span class="line">    out.close();</span><br><span class="line">    excel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h3><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day12-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1/image-20240304210743824.png" alt="image-20240304210743824"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day11-数据统计,图形报表</title>
    <url>/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/</url>
    <content><![CDATA[<h1 id="数据统计"><a href="#数据统计" class="headerlink" title="数据统计"></a>数据统计</h1><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304011805226.png" alt="image-20240304011805226"></p>
<h1 id="Apache-ECharts"><a href="#Apache-ECharts" class="headerlink" title="Apache ECharts"></a>Apache ECharts</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Apache ECharts是一款基于Javascript的数据可视化图标，提供直观、生动、可交互，可个性化定制的数据可视化图表。</p>
<p>官网地址：<a href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304012202089.png" alt="image-20240304012202089"></p>
<p>效果展示：</p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304012218649.png" alt="image-20240304012218649"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304012224570.png" alt="image-20240304012224570"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304012344585.png" alt="image-20240304012344585"></p>
<h2 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h2><p>Apache Echarts官方提供的快速入门：<a href="https://echarts.apache.org/handbook/zh/get-started/">https://echarts.apache.org/handbook/zh/get-started/</a></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304012540268.png" alt="image-20240304012540268"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304013108917.png" alt="image-20240304013108917"></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304014538199.png" alt="image-20240304014538199"></p>
<p>总结：使用Echarts，重点在于研究当前图表所需的数据格式。通常是需要后端提供符合格式要求的动态数据，然后响应给前端来展示图表。</p>
<h1 id="营业额统计"><a href="#营业额统计" class="headerlink" title="营业额统计"></a>营业额统计</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304014833202.png" alt="image-20240304014833202"></p>
<p>业务规则：</p>
<ul>
<li>营业额指的是订单状态已完成的订单金额总计。</li>
<li>基于可视化报表的折线图展示营业额数据，x轴为日期，Y轴为营业额</li>
<li>根据时间选择区间，展示每天的营业额数据</li>
</ul>
<p><strong>接口设计</strong>：</p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304112249920.png" alt="image-20240304112249920"></p>
<h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p>根据接口定义设计对应的VO：</p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304112754173.png" alt="image-20240304112754173"></p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>ReportController</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据统计相关接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/report&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;数据统计相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ReportService reportService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 营业额统计</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/turnoverStatistics&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;营业额统计&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;TurnoverReportVO&gt; <span class="title function_">turnoverStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span></span><br><span class="line"><span class="params">        <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;营业额数据统计：&#123;&#125;，&#123;&#125;&quot;</span>,begin,end);</span><br><span class="line">        <span class="type">TurnoverReportVO</span>  <span class="variable">turnoverReportVO</span> <span class="operator">=</span> reportService.getTurnoverStatistics(begin,end);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(turnoverReportVO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.vo.TurnoverReportVO;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReportService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的营业额数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TurnoverReportVO <span class="title function_">getTurnoverStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ReportService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的营业额数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TurnoverReportVO <span class="title function_">getTurnoverStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">        <span class="comment">//当前集合用于存放从begin到end范围内的每天的日期</span></span><br><span class="line">        List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        dateList.add(begin);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        在Java中，对于日期对象（如LocalDate、LocalDateTime等），当你将它添加到列表（如dateList）时，实际上添加的是一个引用到该日期对象的引用。但是，值得注意的是，LocalDate和LocalDateTime这样的日期时间类是不可变的。这意味着，一旦一个LocalDate实例被创建，它的值就不能改变。如果你调用它的plusDays方法（或其他任何修改日期时间的方法），它会返回一个新的LocalDate实例，而原始的实例保持不变。</span></span><br><span class="line"><span class="comment">//        因此，在你的代码片段中，每次循环时调用begin.plusDays(1)会创建一个新的LocalDate对象，并且更新begin变量引用这个新的对象。然后，你将这个新的对象添加到dateList中。所以，尽管begin变量本身是一个引用变量，但由于LocalDate的不可变性，你实际上每次都在向列表中添加一个新的、不同的LocalDate对象。</span></span><br><span class="line">        <span class="keyword">while</span> (!begin.equals(end)) &#123;</span><br><span class="line">            <span class="comment">//日期计算，计算指定日期的后一天对应的日期</span></span><br><span class="line">            begin = begin.plusDays(<span class="number">1</span>);</span><br><span class="line">            dateList.add(begin);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Double&gt; turnoverList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (LocalDate date : dateList) &#123;</span><br><span class="line">            <span class="comment">//查询date日期对应的营业额数据，营业额是指：状态为“已完成”的订单金额合计</span></span><br><span class="line">            <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">            <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            map.put(<span class="string">&quot;begin&quot;</span>,beginTime);</span><br><span class="line">            map.put(<span class="string">&quot;end&quot;</span>,endTime);</span><br><span class="line">            map.put(<span class="string">&quot;status&quot;</span>, Orders.COMPLETED);</span><br><span class="line">            <span class="type">Double</span> <span class="variable">turnover</span> <span class="operator">=</span> orderMapper.sumByMap(map);</span><br><span class="line">            turnover = turnover == <span class="literal">null</span> ? <span class="number">0.0</span> : turnover;</span><br><span class="line">            turnoverList.add(turnover);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装返回结果</span></span><br><span class="line">        <span class="keyword">return</span> TurnoverReportVO</span><br><span class="line">            .builder()</span><br><span class="line">            .dateList(StringUtils.join(dateList, <span class="string">&#x27;,&#x27;</span>)) <span class="comment">//list中每个元素取出来，转化为字符串</span></span><br><span class="line">            .turnoverList(StringUtils.join(turnoverList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>orderMapper</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据动态条件来统计营业额数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">Double <span class="title function_">sumByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>orderMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;sumByMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Double&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.util.Map&quot;</span>&gt;</span></span><br><span class="line">    select sum(amount) from orders</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;begin != null&quot;</span>&gt;</span>and order_time <span class="symbol">&amp;gt;</span> #&#123;begin&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;end != null&quot;</span>&gt;</span>and order_time <span class="symbol">&amp;lt;</span> #&#123;end&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span>and status = #&#123;status&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304130559620.png" alt="image-20240304130559620"></p>
<h1 id="用户统计"><a href="#用户统计" class="headerlink" title="用户统计"></a>用户统计</h1><h2 id="需求分析和设计-2"><a href="#需求分析和设计-2" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304130744657.png" alt="image-20240304130744657"></p>
<p>业务规则：</p>
<ul>
<li>基于可视化报表的折线图来展示用户数据，x轴为日期，Y轴为用户数</li>
<li>根据时间选择区间，展示每天的用户总量和新增用户量数据</li>
</ul>
<p><strong>接口设计</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304133851944.png" alt="image-20240304133851944"></p>
<h2 id="代码开发-1"><a href="#代码开发-1" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>ReportController</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户统计</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/userStatistics&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户统计&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;UserReportVO&gt; <span class="title function_">userStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;用户数据统计：&#123;&#125;&quot;</span>,begin,end);</span><br><span class="line">    <span class="type">UserReportVO</span> <span class="variable">userReportVO</span> <span class="operator">=</span> reportService.getUserStatistics(begin,end);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(userReportVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的用户数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">UserReportVO <span class="title function_">getUserStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ReportServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的用户数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserReportVO <span class="title function_">getUserStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">    <span class="comment">//存放在begin和end之间的每天对应的日期</span></span><br><span class="line">    List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    dateList.add(begin);</span><br><span class="line">    <span class="keyword">while</span> (!begin.equals(end)) &#123;</span><br><span class="line">        <span class="comment">//日期计算，计算指定日期的后一天对应的日期</span></span><br><span class="line">        begin = begin.plusDays(<span class="number">1</span>);</span><br><span class="line">        dateList.add(begin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放每天的新增用户数量</span></span><br><span class="line">    <span class="comment">//select count(id) from user where create_time &lt; ? and create_time &gt; ?</span></span><br><span class="line">    List&lt;Integer&gt; newUserList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//存放每天的总用户数量</span></span><br><span class="line">    <span class="comment">//select count(id) from user where create_time &lt; ?</span></span><br><span class="line">    List&lt;Integer&gt; totalUserList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (LocalDate date : dateList) &#123;</span><br><span class="line">        <span class="comment">//查询date日期对应的营业额数据，营业额是指：状态为“已完成”的订单金额合计</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;end&quot;</span>,endTime);</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">totalUser</span> <span class="operator">=</span> userMapper.countByMap(map);</span><br><span class="line">        totalUserList.add(totalUser);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;begin&quot;</span>,beginTime);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">newUser</span> <span class="operator">=</span> userMapper.countByMap(map);</span><br><span class="line">        newUserList.add(newUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> UserReportVO.builder()</span><br><span class="line">        .dateList(StringUtils.join(dateList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        .newUserList(StringUtils.join(newUserList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        .totalUserList(StringUtils.join(totalUserList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>UserMapper</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据动态条件统计用户数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">Integer <span class="title function_">countByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>UserMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;countByMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.util.Map&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from user</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;begin != null&quot;</span>&gt;</span></span><br><span class="line">            and create_time <span class="symbol">&amp;gt;</span> #&#123;begin&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;end != null&quot;</span>&gt;</span></span><br><span class="line">            and create_time <span class="symbol">&amp;lt;</span> #&#123;end&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304143222436.png" alt="image-20240304143222436"></p>
<h1 id="订单统计"><a href="#订单统计" class="headerlink" title="订单统计"></a>订单统计</h1><h2 id="需求分析和设计-3"><a href="#需求分析和设计-3" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304143650130.png" alt="image-20240304143650130"></p>
<p>业务规则：</p>
<ul>
<li>有效订单指的是状态为“已完成”的订单</li>
<li>基于可视化报表的折线图展示订单数据，x轴为日期，Y轴为订单数量</li>
<li>根据时间选择区间，展示每天的订单总数和有效订单数</li>
<li>展示所选时间区间内的有效订单数、总订单数、订单完成率 &#x3D; 有效订单数 &#x2F;总订单数 * 100 %</li>
</ul>
<p><strong>接口设计</strong>：</p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304144203906.png" alt="image-20240304144203906"></p>
<h2 id="代码开发-2"><a href="#代码开发-2" class="headerlink" title="代码开发"></a>代码开发</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304144517287.png" alt="image-20240304144517287"></p>
<p><strong>ReportController</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的订单数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/odersStatistics&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;订单统计&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderReportVO&gt; <span class="title function_">orderStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;订单数据统计：&#123;&#125;,&#123;&#125;&quot;</span>,begin,end);</span><br><span class="line">    <span class="type">OrderReportVO</span> <span class="variable">orderReportVO</span> <span class="operator">=</span> reportService.getOrderStatistics(begin,end);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(orderReportVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计指定时间区间内的订单数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderReportVO <span class="title function_">getOrderStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">    <span class="comment">//存放在begin和end之间的每天对应的日期</span></span><br><span class="line">    List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    dateList.add(begin);</span><br><span class="line">    <span class="keyword">while</span> (!begin.equals(end)) &#123;</span><br><span class="line">        <span class="comment">//日期计算，计算指定日期的后一天对应的日期</span></span><br><span class="line">        begin = begin.plusDays(<span class="number">1</span>);</span><br><span class="line">        dateList.add(begin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Integer&gt; orderCountList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;Integer&gt; validOrderCountList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历dateList集合,查询每天的有效订单数和订单总数</span></span><br><span class="line">    <span class="keyword">for</span> (LocalDate date : dateList) &#123;</span><br><span class="line">        <span class="comment">//查询date日期对应的营业额数据，营业额是指：状态为“已完成”的订单金额合计</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询每天的订单总数 select count(id) from orders where order_time &gt; ? and order_time &lt; ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">orderCount</span> <span class="operator">=</span> getOrderCount(beginTime, endTime, <span class="literal">null</span>);</span><br><span class="line">        orderCountList.add(orderCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询每天的有效订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ? and status = ?</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> getOrderCount(beginTime, endTime, Orders.COMPLETED);</span><br><span class="line">        validOrderCountList.add(validOrderCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算时间区间内的订单总数量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">totalOrderCount</span> <span class="operator">=</span> orderCountList.stream().reduce(Integer::sum).get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算时间区间内的有效订单数量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> validOrderCountList.stream().reduce(Integer::sum).get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算订单完成率</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">orderCompletionRate</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">if</span> (totalOrderCount != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//计算订单完成率</span></span><br><span class="line">        orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">OrderReportVO</span> <span class="variable">orderReportVO</span> <span class="operator">=</span> OrderReportVO.builder()</span><br><span class="line">        .dateList(StringUtils.join(dateList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        .orderCountList(StringUtils.join(orderCountList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        .validOrderCountList(StringUtils.join(validOrderCountList, <span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        .totalOrderCount(totalOrderCount)</span><br><span class="line">        .validOrderCount(validOrderCount)</span><br><span class="line">        .orderCompletionRate(orderCompletionRate)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderReportVO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据条件统计订单数量</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer <span class="title function_">getOrderCount</span><span class="params">(LocalDateTime begin, LocalDateTime end, Integer status)</span> &#123;</span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;begin&quot;</span>, begin);</span><br><span class="line">    map.put(<span class="string">&quot;end&quot;</span>, end);</span><br><span class="line">    map.put(<span class="string">&quot;status&quot;</span>, status);</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line">    <span class="keyword">return</span> integer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计指定时间区间内的订单数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OrderReportVO <span class="title function_">getOrderStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>OrderMapper</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据动态条件统计订单数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">Integer <span class="title function_">countByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>OrderMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;countByMap&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.util.Map&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from orders</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;begin != null&quot;</span>&gt;</span>and order_time <span class="symbol">&amp;gt;</span> #&#123;begin&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;end != null&quot;</span>&gt;</span>and order_time <span class="symbol">&amp;lt;</span> #&#123;end&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span>and status = #&#123;status&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="功能测试-2"><a href="#功能测试-2" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304152249706.png" alt="image-20240304152249706"></p>
<h1 id="销量排名Top10"><a href="#销量排名Top10" class="headerlink" title="销量排名Top10"></a>销量排名Top10</h1><h2 id="需求分析和设计-4"><a href="#需求分析和设计-4" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304153058597.png" alt="image-20240304153058597"></p>
<p><strong>业务规则：</strong></p>
<ul>
<li>根据时间选择区间，展示销量前10的商品（包括菜品和套餐）</li>
<li>基于可视化报表的柱状图降序展示商品销量</li>
<li>此处的销量为商品销售的份数</li>
</ul>
<p><strong>接口设计：</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304154130097.png" alt="image-20240304154130097"></p>
<p><strong>根据销量排名接口的返回结果设计VO：</strong></p>
<p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304154259462.png" alt="image-20240304154259462"></p>
<h2 id="代码开发-3"><a href="#代码开发-3" class="headerlink" title="代码开发"></a>代码开发</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计菜品和套餐的TOP10销售数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/top10&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;销量TOP10&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;SalesTop10ReportVO&gt; <span class="title function_">top10</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;销量排名top10：&#123;&#125;,&#123;&#125;&quot;</span>,begin,end);</span><br><span class="line"></span><br><span class="line">    <span class="type">SalesTop10ReportVO</span> <span class="variable">salesTop10ReportVO</span> <span class="operator">=</span>  reportService.getSalesTop10(begin,end);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(salesTop10ReportVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReportService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的销量排名top10</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">SalesTop10ReportVO <span class="title function_">getSalesTop10</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ReportServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的销量排名top10</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SalesTop10ReportVO <span class="title function_">getSalesTop10</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(begin, LocalTime.MIN);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(end, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">    List&lt;GoodsSalesDTO&gt; salesTop = orderMapper.getSalesTop(beginTime, endTime);</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; names = salesTop.stream().map(GoodsSalesDTO::getName).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">nameList</span> <span class="operator">=</span> StringUtils.join(names, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;Integer&gt; numbers = salesTop.stream().map(GoodsSalesDTO::getNumber).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">numberList</span> <span class="operator">=</span> StringUtils.join(numbers, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SalesTop10ReportVO.builder()</span><br><span class="line">        .nameList(nameList)</span><br><span class="line">        .numberList(numberList)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OrderMapper</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计指定时间区间内的销量排名前10</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">List&lt;GoodsSalesDTO&gt; <span class="title function_">getSalesTop</span><span class="params">(LocalDateTime begin,LocalDateTime end)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>OrderMapper.xml</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;getSalesTop&quot;</span> resultType=<span class="string">&quot;com.sky.dto.GoodsSalesDTO&quot;</span>&gt;</span><br><span class="line">    select od.name, sum(od.number) as number</span><br><span class="line">    from sky_take_out.order_detail od,</span><br><span class="line">sky_take_out.orders o</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">    od.order_id = o.id</span><br><span class="line">    and o.status = <span class="number">5</span></span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">&quot;begin!= null&quot;</span>&gt;and o.order_time &amp;gt; #&#123;begin&#125;&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">&quot;end != null&quot;</span>&gt;and o.order_time &amp;lt; #&#123;end&#125;&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;/where&gt;</span><br><span class="line">            group by od.name</span><br><span class="line">            order by number desc</span><br><span class="line">            limit <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>



<h2 id="功能测试-3"><a href="#功能测试-3" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/04/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day11-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1-%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/image-20240304162246940.png" alt="image-20240304162246940"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day10-订单状态定时处理、来单提醒和客户催单</title>
    <url>/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/</url>
    <content><![CDATA[<h1 id="订单状态定时处理"><a href="#订单状态定时处理" class="headerlink" title="订单状态定时处理"></a>订单状态定时处理</h1><p><strong>支付超时的订单如何处理？</strong></p>
<p>订单超时就取消。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303132610198.png" alt="image-20240303132610198"></p>
<p><strong>派送中的订单一直不点击完成如何处理？</strong></p>
<p>定时处理订单。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303132616206.png" alt="image-20240303132616206"></p>
<h1 id="来单提醒和客户催单"><a href="#来单提醒和客户催单" class="headerlink" title="来单提醒和客户催单"></a>来单提醒和客户催单</h1><p>用户支付成功后，商家要进行语音播报，提醒商家来单。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303132645635.png" alt="image-20240303132645635"></p>
<p>用户支付完订单了，商家还未发单，用户可以催单。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303132711971.png" alt="image-20240303132711971"></p>
<h1 id="Spring-Task"><a href="#Spring-Task" class="headerlink" title="Spring Task"></a>Spring Task</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Spring Task是spring框架提供的任务调度工具，可以按照约定的时间自动执行某个任务逻辑。</p>
<p>定时：定时任务框架</p>
<p>作用：定时自动执行某段Java代码</p>
<p>应用场景：</p>
<ul>
<li><p>信用卡每日还款提醒</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303133816397.png" alt="image-20240303133816397"></p>
</li>
<li><p>银行贷款每月还款提醒</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303133902653.png" alt="image-20240303133902653"></p>
</li>
<li><p>火车票售票系统处理未支付订单</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303133925421.png" alt="image-20240303133925421"></p>
</li>
<li><p>入职纪念日为用户发送通知</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303134035423.png" alt="image-20240303134035423"></p>
</li>
<li><p><font color="red">只要是需要定时处理的场景都可以使用Spring Task</font></p>
</li>
</ul>
<p><strong>启动类加上注解@EnableCaching</strong></p>
<p><strong>task.MyTask</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定时任务 每隔5秒触发一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTask</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;定时任务开始执行：&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303164947876.png" alt="image-20240303164947876"></p>
<h2 id="cron表达式"><a href="#cron表达式" class="headerlink" title="cron表达式"></a>cron表达式</h2><p>cron表达式其实就是一个字符串，通过cron表达式可以定义任务触发的事件</p>
<p>构成规则：分成6或7个域，由空格分隔开，每个域代表一个含义</p>
<p>每个域的含义分别为：秒、分钟、小时、日、月、周、年（可选）</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303165813217.png" alt="image-20240303165813217"></p>
<p>cron表达式在线生成器：<a href="https://cron.qqe2.com/">https://cron.qqe2.com/</a></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303165922769.png" alt="image-20240303165922769"></p>
<h2 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h2><p>Spring Task使用步骤：</p>
<ol>
<li>导入maven坐标spring-context（已存在）</li>
<li>启动类添加注释@EnableScheduling开启任务调度</li>
<li>自定义定时任务类</li>
</ol>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303170731276.png" alt="image-20240303170731276"></p>
<h1 id="订单状态定时处理-1"><a href="#订单状态定时处理-1" class="headerlink" title="订单状态定时处理"></a>订单状态定时处理</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>用户下单后可能存在的情况：</p>
<ul>
<li><p>下单后未支付，订单一直处于“<font color="red">待支付</font>”状态。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303171518762.png" alt="image-20240303171518762"></p>
</li>
<li><p>用户收货后管理端未点击完成按钮，订单一直处于“<font color="red">派送中</font>”状态。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303171509233.png" alt="image-20240303171509233"></p>
</li>
</ul>
<p>对于上面两种情况需要通过<font color="red">定时任务</font>来修改订单状态，具体逻辑为：</p>
<ul>
<li>通过定时任务<strong>每分钟检查一次</strong>是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”。</li>
<li>通过定时任务<strong>每天凌晨一点检查一次</strong>是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”。</li>
</ul>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Orders;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定时任务类，定时处理订单状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理超时订单的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = &quot;0 * * * * ?&quot;) //每分钟触发一次</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;1/5 * * * * ?&quot;)</span> <span class="comment">//每分钟触发一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processTimeOutOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;定时处理超时订单：&#123;&#125;&quot;</span>, LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//select * from orders where status == ? and order_time  &lt; (当前时间 - 15分钟)</span></span><br><span class="line">        List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrderTimeLT(Orders.PENDING_PAYMENT, time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">                orders.setStatus(Orders.CANCELLED);</span><br><span class="line">                orders.setCancelReason(<span class="string">&quot;订单超时，自动取消&quot;</span>);</span><br><span class="line">                orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">                orderMapper.update(orders);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理一直处于派送中状态的订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = &quot;0 0 1 * * ?&quot;) //每天凌晨1点触发一次</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeliveryOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;定时处理处于派送中的订单：&#123;&#125;&quot;</span>,LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrderTimeLT(Orders.DELIVERY_IN_PROGRESS, time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">                orders.setStatus(Orders.COMPLETED);</span><br><span class="line">                orderMapper.update(orders);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p>略</p>
<h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>WebSocket是基于TCP的一种新的<font color="red">网络协议</font>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<font color="red">持久性</font>的链接，并进行<font color="red">双向</font>传输。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303210949025.png" alt="image-20240303210949025"></p>
<p>HTTP协议，左侧Client，右侧Server。</p>
<p>客户端和服务器的交互过程基于HTTP：客户端Client发送请求给服务器，服务器收到这个请求之后，会进行相应的处理，接着给客户端response。这种交互方式称为<strong>请求-响应模式</strong>，是<strong>短连接</strong>。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303212623145.png" alt="image-20240303212623145"></p>
<p>客户端向服务端发送Handshake，服务端给客户端Acknowledgement，此后二者建立连接。客户端和服务端均可以发送消息。（类比于现实打电话），是<strong>长连接</strong>。</p>
<p><strong>HTTP协议和WebSocket协议对比：</strong></p>
<ul>
<li>HTTP是<font color="red">短连接</font></li>
<li>WebSocket是<font color="red">长连接</font></li>
<li>HTTP通信是<font color="red">单向</font>的，基于请求响应模式</li>
<li>WebSocket支持<font color="red">双向</font>通信</li>
<li>HTTP和WebSocket底层都是TCP链接</li>
</ul>
<p>应用场景：</p>
<ul>
<li><p>视频弹幕</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303211712257.png" alt="image-20240303211712257"></p>
</li>
<li><p>网页聊天</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303211749684.png" alt="image-20240303211749684"></p>
</li>
<li><p>体育实况更新</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303211811583.png" alt="image-20240303211811583"></p>
</li>
<li><p>股票基金报价实时更新</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303211851380.png" alt="image-20240303211851380"></p>
</li>
</ul>
<h2 id="入门案例-1"><a href="#入门案例-1" class="headerlink" title="入门案例"></a>入门案例</h2><p>实现步骤：</p>
<ol>
<li>直接使用websocket.html页面作为WebSocket客户端</li>
<li>导入WebSocket的maven坐标</li>
<li>导入WebSocket服务端组件WebSocketServer，用于和客户端通信</li>
<li>导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</li>
<li>导入定时任务类WebSocketTask，定时向客户端推送数据</li>
</ol>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303212557934.png" alt="image-20240303212557934"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303212612276.png" alt="image-20240303212612276"></p>
<p><strong>导入maven坐标</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>WebSocketConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket配置类，用于注册WebSocket的Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>WebSocketServer</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnClose;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnMessage;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnOpen;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放会话对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接建立成功调用的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;客户端：&quot;</span> + sid + <span class="string">&quot;建立连接&quot;</span>);</span><br><span class="line">        sessionMap.put(sid, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到客户端消息后调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 客户端发送过来的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到来自客户端：&quot;</span> + sid + <span class="string">&quot;的信息:&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接关闭调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;连接断开:&quot;</span> + sid);</span><br><span class="line">        sessionMap.remove(sid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 群发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllClient</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        Collection&lt;Session&gt; sessions = sessionMap.values();</span><br><span class="line">        <span class="keyword">for</span> (Session session : sessions) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//服务器向客户端发送消息</span></span><br><span class="line">                session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <strong>WebSocketTask</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.websocket.WebSocketServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketTask</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过WebSocket每隔5秒向客户端发送消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToClient</span><span class="params">()</span> &#123;</span><br><span class="line">        webSocketServer.sendToAllClient(<span class="string">&quot;这是来自服务端的消息：&quot;</span> + DateTimeFormatter.ofPattern(<span class="string">&quot;HH:mm:ss&quot;</span>).format(LocalDateTime.now()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="来单提醒"><a href="#来单提醒" class="headerlink" title="来单提醒"></a>来单提醒</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p>用户下单并且支付成功后，需要第一时间通知外卖商家，通知的形式有如下两种：</p>
<ul>
<li>语音播放</li>
<li>弹出提示框</li>
</ul>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303220126521.png" alt="image-20240303220126521"></p>
<p><strong>设计：</strong></p>
<ul>
<li><p>通过WebSocket实现管理端页面和服务端保持长连接状态</p>
<p>已经完成了，我们完成了WebSocketServer类，并将他作为Bean对象注入到IOC容器中，它一直监听着对应的&#x2F;ws&#x2F;{sid}接口。请求是先请求到nginx，再由nginx反向代理转发到后端（我们需要提前在nginx中配置文件）。</p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303233558871.png" alt="image-20240303233558871"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303233616675.png" alt="image-20240303233616675"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303234106056.png" alt="image-20240303234106056"></p>
</li>
<li><p>当用户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</p>
</li>
<li><p>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</p>
</li>
<li><p>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content</p>
<ul>
<li>type为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId为订单id</li>
<li>content为消息内容</li>
</ul>
</li>
</ul>
<h2 id="代码开发-1"><a href="#代码开发-1" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>修改paySuccess</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据订单号查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getByNumber(outTradeNo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">        .id(ordersDB.getId())</span><br><span class="line">        .status(Orders.TO_BE_CONFIRMED)</span><br><span class="line">        .payStatus(Orders.PAID)</span><br><span class="line">        .checkoutTime(LocalDateTime.now())</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过websocket向客户端浏览器推送消息 type orderId content</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;type&quot;</span>,<span class="number">1</span>);  <span class="comment">//1. 表示来单提醒， 2. 表示客户催单</span></span><br><span class="line">    map.put(<span class="string">&quot;orderId&quot;</span>,ordersDB.getId());</span><br><span class="line">    map.put(<span class="string">&quot;content&quot;</span>,<span class="string">&quot;订单号：&quot;</span> + outTradeNo);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(map);</span><br><span class="line">    webSocketServer.sendToAllClient(json);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303235101847.png" alt="image-20240303235101847"></p>
<p><strong>后端修改回调地址</strong></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303235212549.png" alt="image-20240303235212549"></p>
<p><strong>后端启动程序，前端登录</strong></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303235416549.png" alt="image-20240303235416549"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240303235429278.png" alt="image-20240303235429278"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304000557187.png" alt="image-20240304000557187"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304000441664.png" alt="image-20240304000441664"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304000426919.png" alt="image-20240304000426919"></p>
<h1 id="客户催单"><a href="#客户催单" class="headerlink" title="客户催单"></a>客户催单</h1><h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304000636439.png" alt="image-20240304000636439"></p>
<p>设计：</p>
<ul>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</li>
<li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li>
<li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul>
<li>type为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId为订单id</li>
<li>content为消息内容</li>
</ul>
</li>
</ul>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304000906366.png" alt="image-20240304000906366"></p>
<h2 id="代码开发-2"><a href="#代码开发-2" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>user.OrderController</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户催单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;客户催单&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/reminder/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">reminder</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">    orderService.reminder(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OrderService</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户催单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">reminder</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>OrderServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户催单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reminder</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在，并且状态为4</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;type&quot;</span>,<span class="number">2</span>); <span class="comment">//1.来单提醒 2.客户催单</span></span><br><span class="line">    map.put(<span class="string">&quot;orderId&quot;</span>,id);</span><br><span class="line">    map.put(<span class="string">&quot;content&quot;</span>,<span class="string">&quot;订单号：&quot;</span> + ordersDB.getNumber());</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(map);</span><br><span class="line"></span><br><span class="line">    webSocketServer.sendToAllClient(json);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="功能测试-2"><a href="#功能测试-2" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304001814377.png" alt="image-20240304001814377"></p>
<p><img src="/2024/03/03/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day10-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E3%80%81%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/image-20240304001825301.png" alt="image-20240304001825301"></p>
<p>当用户端点击催单按钮，它会先发送一个请求，请求到Controller方法，在这里我们通过webSocketServer向管理端推送消息，在管理端就会显示该消息。</p>
<p>原理：网页的管理端前端页面向服务器后端发起了websocket请求，建立长连接，接着小程序的客户端点击催单按钮，向我们后端的服务器对应方法发起请求，该方法执行时会调用websocket相关方法，向管理端发送信息。</p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day09-用户端历史订单模块、商家端订单管理模块</title>
    <url>/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/</url>
    <content><![CDATA[<h1 id="用户端历史订单模块"><a href="#用户端历史订单模块" class="headerlink" title="用户端历史订单模块"></a>用户端历史订单模块</h1><h2 id="1-查询历史订单"><a href="#1-查询历史订单" class="headerlink" title="1. 查询历史订单"></a>1. 查询历史订单</h2><h3 id="1-1-需求分析和设计"><a href="#1-1-需求分析和设计" class="headerlink" title="1.1 需求分析和设计"></a>1.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128092537535.png" alt="image-20221128092537535"></p>
<p>业务规则</p>
<ul>
<li>分页查询历史订单</li>
<li>可以根据订单状态查询</li>
<li>展示订单数据时，需要展示的数据包括：下单时间、订单状态、订单金额、订单明细（商品名称、图片）</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128103222657.png" alt="image-20221128103222657"></p>
<h3 id="1-2-代码实现"><a href="#1-2-代码实现" class="headerlink" title="1.2 代码实现"></a>1.2 代码实现</h3><h4 id="1-2-1-user-OrderController"><a href="#1-2-1-user-OrderController" class="headerlink" title="1.2.1 user&#x2F;OrderController"></a>1.2.1 user&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 历史订单查询</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status   订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/historyOrders&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;历史订单查询&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> pageSize, Integer status)</span> &#123;</span><br><span class="line">    <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> orderService.pageQuery4User(page, pageSize, status);</span><br><span class="line">    <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-OrderService"><a href="#1-2-2-OrderService" class="headerlink" title="1.2.2 OrderService"></a>1.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户端订单分页查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PageResult <span class="title function_">pageQuery4User</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> pageSize, Integer status)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-OrderServiceImpl"><a href="#1-2-3-OrderServiceImpl" class="headerlink" title="1.2.3 OrderServiceImpl"></a>1.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户端订单分页查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">pageQuery4User</span><span class="params">(<span class="type">int</span> pageNum, <span class="type">int</span> pageSize, Integer status)</span> &#123;</span><br><span class="line">        <span class="comment">// 设置分页</span></span><br><span class="line">        PageHelper.startPage(pageNum, pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="type">OrdersPageQueryDTO</span> <span class="variable">ordersPageQueryDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrdersPageQueryDTO</span>();</span><br><span class="line">        ordersPageQueryDTO.setUserId(BaseContext.getCurrentId());</span><br><span class="line">        ordersPageQueryDTO.setStatus(status);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分页条件查询</span></span><br><span class="line">        Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        List&lt;OrderVO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询出订单明细，并封装入OrderVO进行响应</span></span><br><span class="line">        <span class="keyword">if</span> (page != <span class="literal">null</span> &amp;&amp; page.getTotal() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Orders orders : page) &#123;</span><br><span class="line">                <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orders.getId();<span class="comment">// 订单id</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 查询订单明细</span></span><br><span class="line">                List&lt;OrderDetail&gt; orderDetails = orderDetailMapper.getByOrderId(orderId);</span><br><span class="line"></span><br><span class="line">                <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">                BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">                orderVO.setOrderDetailList(orderDetails);</span><br><span class="line"></span><br><span class="line">                list.add(orderVO);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), list);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-4-OrderMapper"><a href="#1-2-4-OrderMapper" class="headerlink" title="1.2.4 OrderMapper"></a>1.2.4 OrderMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页条件查询并按下单时间排序</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Page&lt;Orders&gt; <span class="title function_">pageQuery</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-5-OrderMapper-xml"><a href="#1-2-5-OrderMapper-xml" class="headerlink" title="1.2.5 OrderMapper.xml"></a>1.2.5 OrderMapper.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageQuery&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Orders&quot;</span>&gt;</span></span><br><span class="line">       select * from orders</span><br><span class="line">       <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;number != null and number!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               and number like concat(&#x27;%&#x27;,#&#123;number&#125;,&#x27;%&#x27;)</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;phone != null and phone!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">               and phone like concat(&#x27;%&#x27;,#&#123;phone&#125;,&#x27;%&#x27;)</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span></span><br><span class="line">               and user_id = #&#123;userId&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span></span><br><span class="line">               and status = #&#123;status&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;beginTime != null&quot;</span>&gt;</span></span><br><span class="line">               and order_time <span class="symbol">&amp;gt;</span>= #&#123;beginTime&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;endTime != null&quot;</span>&gt;</span></span><br><span class="line">               and order_time <span class="symbol">&amp;lt;</span>= #&#123;endTime&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">       order by order_time desc</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-6-OrderDetailMapper"><a href="#1-2-6-OrderDetailMapper" class="headerlink" title="1.2.6 OrderDetailMapper"></a>1.2.6 OrderDetailMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id查询订单明细</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select(&quot;select * from order_detail where order_id = #&#123;orderId&#125;&quot;)</span></span><br><span class="line">List&lt;OrderDetail&gt; <span class="title function_">getByOrderId</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-功能测试"><a href="#1-3-功能测试" class="headerlink" title="1.3 功能测试"></a>1.3 功能测试</h3><p>略</p>
<h2 id="2-查询订单详情"><a href="#2-查询订单详情" class="headerlink" title="2. 查询订单详情"></a>2. 查询订单详情</h2><h3 id="2-1-需求分析和设计"><a href="#2-1-需求分析和设计" class="headerlink" title="2.1 需求分析和设计"></a>2.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128102144294.png" alt="image-20221128102144294"></p>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128142142811.png" alt="image-20221128142142811"></p>
<h3 id="2-2-代码实现"><a href="#2-2-代码实现" class="headerlink" title="2.2 代码实现"></a>2.2 代码实现</h3><h4 id="2-2-1-user-OrderController"><a href="#2-2-1-user-OrderController" class="headerlink" title="2.2.1 user&#x2F;OrderController"></a>2.2.1 user&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/orderDetail/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询订单详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderVO&gt; <span class="title function_">details</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> orderService.details(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-OrderService"><a href="#2-2-2-OrderService" class="headerlink" title="2.2.2 OrderService"></a>2.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询订单详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OrderVO <span class="title function_">details</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-OrderServiceImpl"><a href="#2-2-3-OrderServiceImpl" class="headerlink" title="2.2.3 OrderServiceImpl"></a>2.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OrderVO <span class="title function_">details</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询该订单对应的菜品/套餐明细</span></span><br><span class="line">    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将该订单及其详情封装到OrderVO并返回</span></span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">    BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">    orderVO.setOrderDetailList(orderDetailList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-OrderMapper"><a href="#2-2-4-OrderMapper" class="headerlink" title="2.2.4 OrderMapper"></a>2.2.4 OrderMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据id查询订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select(&quot;select * from orders where id=#&#123;id&#125;&quot;)</span></span><br><span class="line">Orders <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-功能测试"><a href="#2-3-功能测试" class="headerlink" title="2.3 功能测试"></a>2.3 功能测试</h3><p>略</p>
<h2 id="3-取消订单"><a href="#3-取消订单" class="headerlink" title="3. 取消订单"></a>3. 取消订单</h2><h3 id="3-1-需求分析和设计"><a href="#3-1-需求分析和设计" class="headerlink" title="3.1 需求分析和设计"></a>3.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128145444268.png" alt="image-20221128145444268"></p>
<p>业务规则：</p>
<ul>
<li>待支付和待接单状态下，用户可直接取消订单</li>
<li>商家已接单状态下，用户取消订单需电话沟通商家</li>
<li>派送中状态下，用户取消订单需电话沟通商家</li>
<li>如果在待接单状态下取消订单，需要给用户退款</li>
<li>取消订单后需要将订单状态修改为“已取消”</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128164410852.png" alt="image-20221128164410852"></p>
<h3 id="3-2-代码实现"><a href="#3-2-代码实现" class="headerlink" title="3.2 代码实现"></a>3.2 代码实现</h3><h4 id="3-2-1-user-OrderController"><a href="#3-2-1-user-OrderController" class="headerlink" title="3.2.1 user&#x2F;OrderController"></a>3.2.1 user&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/cancel/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;取消订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">cancel</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    orderService.userCancelById(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-OrderService"><a href="#3-2-2-OrderService" class="headerlink" title="3.2.2 OrderService"></a>3.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户取消订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">userCancelById</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-OrderServiceImpl"><a href="#3-2-3-OrderServiceImpl" class="headerlink" title="3.2.3 OrderServiceImpl"></a>3.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户取消订单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userCancelById</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// 根据id查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 校验订单是否存在</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB.getStatus() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">       orders.setId(ordersDB.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单处于待接单状态下取消，需要进行退款</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) &#123;</span><br><span class="line">           <span class="comment">//调用微信支付退款接口</span></span><br><span class="line">           weChatPayUtil.refund(</span><br><span class="line">                   ordersDB.getNumber(), <span class="comment">//商户订单号</span></span><br><span class="line">                   ordersDB.getNumber(), <span class="comment">//商户退款单号</span></span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),<span class="comment">//退款金额，单位 元</span></span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));<span class="comment">//原订单金额</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">//支付状态修改为 退款</span></span><br><span class="line">           orders.setPayStatus(Orders.REFUND);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 更新订单状态、取消原因、取消时间</span></span><br><span class="line">       orders.setStatus(Orders.CANCELLED);</span><br><span class="line">       orders.setCancelReason(<span class="string">&quot;用户取消&quot;</span>);</span><br><span class="line">       orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-功能测试"><a href="#3-3-功能测试" class="headerlink" title="3.3 功能测试"></a>3.3 功能测试</h3><p>略</p>
<h2 id="4-再来一单"><a href="#4-再来一单" class="headerlink" title="4. 再来一单"></a>4. 再来一单</h2><h3 id="4-1-需求分析和设计"><a href="#4-1-需求分析和设计" class="headerlink" title="4.1 需求分析和设计"></a>4.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128173238656.png" alt="image-20221128173238656"></p>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221128173350467.png" alt="image-20221128173350467"></p>
<p>业务规则：</p>
<ul>
<li>再来一单就是将原订单中的商品重新加入到购物车中</li>
</ul>
<h3 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h3><h4 id="4-2-1-user-OrderController"><a href="#4-2-1-user-OrderController" class="headerlink" title="4.2.1 user&#x2F;OrderController"></a>4.2.1 user&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 再来一单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/repetition/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;再来一单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">repetition</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    orderService.repetition(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-OrderService"><a href="#4-2-2-OrderService" class="headerlink" title="4.2.2 OrderService"></a>4.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 再来一单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">repetition</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-OrderServiceImpl"><a href="#4-2-3-OrderServiceImpl" class="headerlink" title="4.2.3 OrderServiceImpl"></a>4.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 再来一单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">repetition</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">       <span class="comment">// 查询当前用户id</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单id查询当前订单详情</span></span><br><span class="line">       List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(id);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 将订单详情对象转换为购物车对象</span></span><br><span class="line">       List&lt;ShoppingCart&gt; shoppingCartList = orderDetailList.stream().map(x -&gt; &#123;</span><br><span class="line">           <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 将原订单详情里面的菜品信息重新复制到购物车对象中</span></span><br><span class="line">           BeanUtils.copyProperties(x, shoppingCart, <span class="string">&quot;id&quot;</span>);</span><br><span class="line">           shoppingCart.setUserId(userId);</span><br><span class="line">           shoppingCart.setCreateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> shoppingCart;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 将购物车对象批量添加到数据库</span></span><br><span class="line">       shoppingCartMapper.insertBatch(shoppingCartList);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-4-ShoppingCartMapper"><a href="#4-2-4-ShoppingCartMapper" class="headerlink" title="4.2.4 ShoppingCartMapper"></a>4.2.4 ShoppingCartMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量插入购物车数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> shoppingCartList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;ShoppingCart&gt; shoppingCartList)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-5-ShoppingCartMapper-xml"><a href="#4-2-5-ShoppingCartMapper-xml" class="headerlink" title="4.2.5 ShoppingCartMapper.xml"></a>4.2.5 ShoppingCartMapper.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertBatch&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">        insert into shopping_cart</span><br><span class="line">        (name, image, user_id, dish_id, setmeal_id, dish_flavor, number, amount, create_time)</span><br><span class="line">        values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;shoppingCartList&quot;</span> <span class="attr">item</span>=<span class="string">&quot;sc&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">            (#&#123;sc.name&#125;,#&#123;sc.image&#125;,#&#123;sc.userId&#125;,#&#123;sc.dishId&#125;,#&#123;sc.setmealId&#125;,#&#123;sc.dishFlavor&#125;,#&#123;sc.number&#125;,#&#123;sc.amount&#125;,#&#123;sc.createTime&#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-功能测试"><a href="#4-3-功能测试" class="headerlink" title="4.3 功能测试"></a>4.3 功能测试</h3><p>略</p>
<h1 id="商家端订单管理模块"><a href="#商家端订单管理模块" class="headerlink" title="商家端订单管理模块"></a>商家端订单管理模块</h1><h2 id="1-订单搜索"><a href="#1-订单搜索" class="headerlink" title="1. 订单搜索"></a>1. 订单搜索</h2><h3 id="1-1-需求分析和设计-1"><a href="#1-1-需求分析和设计-1" class="headerlink" title="1.1 需求分析和设计"></a>1.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129092023177.png" alt="image-20221129092023177"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129114035570.png" alt="image-20221129114035570"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129114054664.png" alt="image-20221129114054664"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129114116492.png" alt="image-20221129114116492"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129114132956.png" alt="image-20221129114132956"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129114151055.png" alt="image-20221129114151055"></p>
<p>业务规则：</p>
<ul>
<li>输入订单号&#x2F;手机号进行搜索，支持模糊搜索</li>
<li>根据订单状态进行筛选</li>
<li>下单时间进行时间筛选</li>
<li>搜索内容为空，提示未找到相关订单</li>
<li>搜索结果页，展示包含搜索关键词的内容</li>
<li>分页展示搜索到的订单数据</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129092552620.png" alt="image-20221129092552620"></p>
<h3 id="1-2-代码实现-1"><a href="#1-2-代码实现-1" class="headerlink" title="1.2 代码实现"></a>1.2 代码实现</h3><h4 id="1-2-1-admin-OrderController"><a href="#1-2-1-admin-OrderController" class="headerlink" title="1.2.1 admin&#x2F;OrderController"></a>1.2.1 admin&#x2F;OrderController</h4><p>在admin包下创建OrderController</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController(&quot;adminOrderController&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/order&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;订单管理接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单搜索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/conditionSearch&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;订单搜索&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> orderService.conditionSearch(ordersPageQueryDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-OrderService-1"><a href="#1-2-2-OrderService-1" class="headerlink" title="1.2.2 OrderService"></a>1.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 条件搜索订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PageResult <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-OrderServiceImpl-1"><a href="#1-2-3-OrderServiceImpl-1" class="headerlink" title="1.2.3 OrderServiceImpl"></a>1.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单搜索</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">    PageHelper.startPage(ordersPageQueryDTO.getPage(), ordersPageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">    Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 部分订单状态，需要额外返回订单菜品信息，将Orders转化为OrderVO</span></span><br><span class="line">    List&lt;OrderVO&gt; orderVOList = getOrderVOList(page);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), orderVOList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;OrderVO&gt; <span class="title function_">getOrderVOList</span><span class="params">(Page&lt;Orders&gt; page)</span> &#123;</span><br><span class="line">    <span class="comment">// 需要返回订单菜品信息，自定义OrderVO响应结果</span></span><br><span class="line">    List&lt;OrderVO&gt; orderVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    List&lt;Orders&gt; ordersList = page.getResult();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(ordersList)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">            <span class="comment">// 将共同字段复制到OrderVO</span></span><br><span class="line">            <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">            BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">            <span class="type">String</span> <span class="variable">orderDishes</span> <span class="operator">=</span> getOrderDishesStr(orders);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将订单菜品信息封装到orderVO中，并添加到orderVOList</span></span><br><span class="line">            orderVO.setOrderDishes(orderDishes);</span><br><span class="line">            orderVOList.add(orderVO);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> orderVOList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取菜品信息字符串</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getOrderDishesStr</span><span class="params">(Orders orders)</span> &#123;</span><br><span class="line">    <span class="comment">// 查询订单菜品详情信息（订单中的菜品和数量）</span></span><br><span class="line">    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将每一条订单菜品信息拼接为字符串（格式：宫保鸡丁*3；）</span></span><br><span class="line">    List&lt;String&gt; orderDishList = orderDetailList.stream().map(x -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderDish</span> <span class="operator">=</span> x.getName() + <span class="string">&quot;*&quot;</span> + x.getNumber() + <span class="string">&quot;;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> orderDish;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将该订单对应的所有菜品信息拼接在一起</span></span><br><span class="line">    <span class="keyword">return</span> String.join(<span class="string">&quot;&quot;</span>, orderDishList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-功能测试-1"><a href="#1-3-功能测试-1" class="headerlink" title="1.3 功能测试"></a>1.3 功能测试</h3><p>略</p>
<h2 id="2-各个状态的订单数量统计"><a href="#2-各个状态的订单数量统计" class="headerlink" title="2. 各个状态的订单数量统计"></a>2. 各个状态的订单数量统计</h2><h3 id="2-1-需求分析和设计-1"><a href="#2-1-需求分析和设计-1" class="headerlink" title="2.1 需求分析和设计"></a>2.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129095804419.png" alt="image-20221129095804419"></p>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129095912896.png" alt="image-20221129095912896"></p>
<h3 id="2-2-代码实现-1"><a href="#2-2-代码实现-1" class="headerlink" title="2.2 代码实现"></a>2.2 代码实现</h3><h4 id="2-2-1-admin-OrderController"><a href="#2-2-1-admin-OrderController" class="headerlink" title="2.2.1 admin&#x2F;OrderController"></a>2.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/statistics&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;各个状态的订单数量统计&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderStatisticsVO&gt; <span class="title function_">statistics</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">OrderStatisticsVO</span> <span class="variable">orderStatisticsVO</span> <span class="operator">=</span> orderService.statistics();</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderStatisticsVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-OrderService-1"><a href="#2-2-2-OrderService-1" class="headerlink" title="2.2.2 OrderService"></a>2.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OrderStatisticsVO <span class="title function_">statistics</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-OrderServiceImpl-1"><a href="#2-2-3-OrderServiceImpl-1" class="headerlink" title="2.2.3 OrderServiceImpl"></a>2.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OrderStatisticsVO <span class="title function_">statistics</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 根据状态，分别查询出待接单、待派送、派送中的订单数量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">toBeConfirmed</span> <span class="operator">=</span> orderMapper.countStatus(Orders.TO_BE_CONFIRMED);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">confirmed</span> <span class="operator">=</span> orderMapper.countStatus(Orders.CONFIRMED);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">deliveryInProgress</span> <span class="operator">=</span> orderMapper.countStatus(Orders.DELIVERY_IN_PROGRESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将查询出的数据封装到orderStatisticsVO中响应</span></span><br><span class="line">    <span class="type">OrderStatisticsVO</span> <span class="variable">orderStatisticsVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderStatisticsVO</span>();</span><br><span class="line">    orderStatisticsVO.setToBeConfirmed(toBeConfirmed);</span><br><span class="line">    orderStatisticsVO.setConfirmed(confirmed);</span><br><span class="line">    orderStatisticsVO.setDeliveryInProgress(deliveryInProgress);</span><br><span class="line">    <span class="keyword">return</span> orderStatisticsVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-OrderMapper-1"><a href="#2-2-4-OrderMapper-1" class="headerlink" title="2.2.4 OrderMapper"></a>2.2.4 OrderMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态统计订单数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select(&quot;select count(id) from orders where status = #&#123;status&#125;&quot;)</span></span><br><span class="line">Integer <span class="title function_">countStatus</span><span class="params">(Integer status)</span>;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-功能测试-1"><a href="#2-3-功能测试-1" class="headerlink" title="2.3 功能测试"></a>2.3 功能测试</h3><p>略</p>
<h2 id="3-查询订单详情"><a href="#3-查询订单详情" class="headerlink" title="3. 查询订单详情"></a>3. 查询订单详情</h2><h3 id="3-1-需求分析和设计-1"><a href="#3-1-需求分析和设计-1" class="headerlink" title="3.1 需求分析和设计"></a>3.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129101712084.png" alt="image-20221129101712084"></p>
<p>业务规则：</p>
<ul>
<li>订单详情页面需要展示订单基本信息（状态、订单号、下单时间、收货人、电话、收货地址、金额等）</li>
<li>订单详情页面需要展示订单明细数据（商品名称、数量、单价）</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129101035374.png" alt="image-20221129101035374"></p>
<h3 id="3-2-代码实现-1"><a href="#3-2-代码实现-1" class="headerlink" title="3.2 代码实现"></a>3.2 代码实现</h3><h4 id="3-2-1-admin-OrderController"><a href="#3-2-1-admin-OrderController" class="headerlink" title="3.2.1 admin&#x2F;OrderController"></a>3.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/details/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询订单详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderVO&gt; <span class="title function_">details</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> orderService.details(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-功能测试-1"><a href="#3-3-功能测试-1" class="headerlink" title="3.3 功能测试"></a>3.3 功能测试</h3><p>略</p>
<h2 id="4-接单"><a href="#4-接单" class="headerlink" title="4. 接单"></a>4. 接单</h2><h3 id="4-1-需求分析和设计-1"><a href="#4-1-需求分析和设计-1" class="headerlink" title="4.1 需求分析和设计"></a>4.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129105142623.png" alt="image-20221129105142623"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129105116285.png" alt="image-20221129105116285"></p>
<p>业务规则：</p>
<ul>
<li>商家接单其实就是将订单的状态修改为“已接单”</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129105313172.png" alt="image-20221129105313172"></p>
<h3 id="4-2-代码实现-1"><a href="#4-2-代码实现-1" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h3><h4 id="4-2-1-admin-OrderController"><a href="#4-2-1-admin-OrderController" class="headerlink" title="4.2.1 admin&#x2F;OrderController"></a>4.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/confirm&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;接单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">confirm</span><span class="params">(<span class="meta">@RequestBody</span> OrdersConfirmDTO ordersConfirmDTO)</span> &#123;</span><br><span class="line">    orderService.confirm(ordersConfirmDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-OrderService-1"><a href="#4-2-2-OrderService-1" class="headerlink" title="4.2.2 OrderService"></a>4.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersConfirmDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(OrdersConfirmDTO ordersConfirmDTO)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-OrderServiceImpl-1"><a href="#4-2-3-OrderServiceImpl-1" class="headerlink" title="4.2.3 OrderServiceImpl"></a>4.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersConfirmDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(OrdersConfirmDTO ordersConfirmDTO)</span> &#123;</span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">            .id(ordersConfirmDTO.getId())</span><br><span class="line">            .status(Orders.CONFIRMED)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-3-功能测试-1"><a href="#4-3-功能测试-1" class="headerlink" title="4.3 功能测试"></a>4.3 功能测试</h3><p>略</p>
<h2 id="5-拒单"><a href="#5-拒单" class="headerlink" title="5. 拒单"></a>5. 拒单</h2><h3 id="5-1-需求分析和设计"><a href="#5-1-需求分析和设计" class="headerlink" title="5.1 需求分析和设计"></a>5.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129110358976.png" alt="image-20221129110358976"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129110428390.png" alt="image-20221129110428390"></p>
<p>业务规则：</p>
<ul>
<li>商家拒单其实就是将订单状态修改为“已取消”</li>
<li>只有订单处于“待接单”状态时可以执行拒单操作</li>
<li>商家拒单时需要指定拒单原因</li>
<li>商家拒单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129110725031.png" alt="image-20221129110725031"></p>
<h3 id="5-2-代码实现"><a href="#5-2-代码实现" class="headerlink" title="5.2 代码实现"></a>5.2 代码实现</h3><h4 id="5-2-1-admin-OrderController"><a href="#5-2-1-admin-OrderController" class="headerlink" title="5.2.1 admin&#x2F;OrderController"></a>5.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/rejection&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;拒单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">rejection</span><span class="params">(<span class="meta">@RequestBody</span> OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    orderService.rejection(ordersRejectionDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-OrderService"><a href="#5-2-2-OrderService" class="headerlink" title="5.2.2 OrderService"></a>5.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersRejectionDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">rejection</span><span class="params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-OrderServiceImpl"><a href="#5-2-3-OrderServiceImpl" class="headerlink" title="5.2.3 OrderServiceImpl"></a>5.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 拒单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersRejectionDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejection</span><span class="params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// 根据id查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(ordersRejectionDTO.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单只有存在且状态为2（待接单）才可以拒单</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//支付状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> ordersDB.getPayStatus();</span><br><span class="line">       <span class="keyword">if</span> (payStatus == Orders.PAID) &#123;</span><br><span class="line">           <span class="comment">//用户已支付，需要退款</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">refund</span> <span class="operator">=</span> weChatPayUtil.refund(</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));</span><br><span class="line">           log.info(<span class="string">&quot;申请退款：&#123;&#125;&quot;</span>, refund);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 拒单需要退款，根据订单id更新订单状态、拒单原因、取消时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">       orders.setId(ordersDB.getId());</span><br><span class="line">       orders.setStatus(Orders.CANCELLED);</span><br><span class="line">       orders.setRejectionReason(ordersRejectionDTO.getRejectionReason());</span><br><span class="line">       orders.setCancelTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-功能测试"><a href="#5-3-功能测试" class="headerlink" title="5.3 功能测试"></a>5.3 功能测试</h3><p>略</p>
<h2 id="6-取消订单"><a href="#6-取消订单" class="headerlink" title="6. 取消订单"></a>6. 取消订单</h2><h3 id="6-1-需求分析和设计"><a href="#6-1-需求分析和设计" class="headerlink" title="6.1 需求分析和设计"></a>6.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129111402099.png" alt="image-20221129111402099"></p>
<p>业务规则：</p>
<ul>
<li>取消订单其实就是将订单状态修改为“已取消”</li>
<li>商家取消订单时需要指定取消原因</li>
<li>商家取消订单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129112201836.png" alt="image-20221129112201836"></p>
<h3 id="6-2-代码实现"><a href="#6-2-代码实现" class="headerlink" title="6.2 代码实现"></a>6.2 代码实现</h3><h4 id="6-2-1-admin-OrderController"><a href="#6-2-1-admin-OrderController" class="headerlink" title="6.2.1 admin&#x2F;OrderController"></a>6.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/cancel&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;取消订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">cancel</span><span class="params">(<span class="meta">@RequestBody</span> OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    orderService.cancel(ordersCancelDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-OrderService"><a href="#6-2-2-OrderService" class="headerlink" title="6.2.2 OrderService"></a>6.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 商家取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersCancelDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></table></figure>

<h4 id="6-2-3-OrderServiceImpl"><a href="#6-2-3-OrderServiceImpl" class="headerlink" title="6.2.3 OrderServiceImpl"></a>6.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 取消订单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersCancelDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">// 根据id查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(ordersCancelDTO.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//支付状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> ordersDB.getPayStatus();</span><br><span class="line">       <span class="keyword">if</span> (payStatus == <span class="number">1</span>) &#123;</span><br><span class="line">           <span class="comment">//用户已支付，需要退款</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">refund</span> <span class="operator">=</span> weChatPayUtil.refund(</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));</span><br><span class="line">           log.info(<span class="string">&quot;申请退款：&#123;&#125;&quot;</span>, refund);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 管理端取消订单需要退款，根据订单id更新订单状态、取消原因、取消时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">       orders.setId(ordersCancelDTO.getId());</span><br><span class="line">       orders.setStatus(Orders.CANCELLED);</span><br><span class="line">       orders.setCancelReason(ordersCancelDTO.getCancelReason());</span><br><span class="line">       orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-功能测试"><a href="#6-3-功能测试" class="headerlink" title="6.3 功能测试"></a>6.3 功能测试</h3><p>略</p>
<h2 id="7-派送订单"><a href="#7-派送订单" class="headerlink" title="7. 派送订单"></a>7. 派送订单</h2><h3 id="7-1-需求分析和设计"><a href="#7-1-需求分析和设计" class="headerlink" title="7.1 需求分析和设计"></a>7.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129113257201.png" alt="image-20221129113257201"></p>
<p>业务规则：</p>
<ul>
<li>派送订单其实就是将订单状态修改为“派送中”</li>
<li>只有状态为“待派送”的订单可以执行派送订单操作</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129113449124.png" alt="image-20221129113449124"></p>
<h3 id="7-2-代码实现"><a href="#7-2-代码实现" class="headerlink" title="7.2 代码实现"></a>7.2 代码实现</h3><h4 id="7-2-1-admin-OrderController"><a href="#7-2-1-admin-OrderController" class="headerlink" title="7.2.1 admin&#x2F;OrderController"></a>7.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/delivery/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;派送订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">delivery</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    orderService.delivery(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-2-OrderService"><a href="#7-2-2-OrderService" class="headerlink" title="7.2.2 OrderService"></a>7.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delivery</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-3-OrderServiceImpl"><a href="#7-2-3-OrderServiceImpl" class="headerlink" title="7.2.3 OrderServiceImpl"></a>7.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delivery</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在，并且状态为3</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.CONFIRMED)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersDB.getId());</span><br><span class="line">    <span class="comment">// 更新订单状态,状态转为派送中</span></span><br><span class="line">    orders.setStatus(Orders.DELIVERY_IN_PROGRESS);</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-功能测试"><a href="#7-3-功能测试" class="headerlink" title="7.3 功能测试"></a>7.3 功能测试</h3><p>略</p>
<h2 id="8-完成订单"><a href="#8-完成订单" class="headerlink" title="8. 完成订单"></a>8. 完成订单</h2><h3 id="8-1-需求分析和设计"><a href="#8-1-需求分析和设计" class="headerlink" title="8.1 需求分析和设计"></a>8.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129112554051.png" alt="image-20221129112554051"></p>
<p>业务规则：</p>
<ul>
<li>完成订单其实就是将订单状态修改为“已完成”</li>
<li>只有状态为“派送中”的订单可以执行订单完成操作</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221129113622784.png" alt="image-20221129113622784"></p>
<h3 id="8-2-代码实现"><a href="#8-2-代码实现" class="headerlink" title="8.2 代码实现"></a>8.2 代码实现</h3><h4 id="8-2-1-admin-OrderController"><a href="#8-2-1-admin-OrderController" class="headerlink" title="8.2.1 admin&#x2F;OrderController"></a>8.2.1 admin&#x2F;OrderController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/complete/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;完成订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">complete</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    orderService.complete(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-2-2-OrderService"><a href="#8-2-2-OrderService" class="headerlink" title="8.2.2 OrderService"></a>8.2.2 OrderService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="8-2-3-OrderServiceImpl"><a href="#8-2-3-OrderServiceImpl" class="headerlink" title="8.2.3 OrderServiceImpl"></a>8.2.3 OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在，并且状态为4</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.DELIVERY_IN_PROGRESS)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersDB.getId());</span><br><span class="line">    <span class="comment">// 更新订单状态,状态转为完成</span></span><br><span class="line">    orders.setStatus(Orders.COMPLETED);</span><br><span class="line">    orders.setDeliveryTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-功能测试"><a href="#8-3-功能测试" class="headerlink" title="8.3 功能测试"></a>8.3 功能测试</h3><p>略</p>
<h1 id="校验收货地址是否超出配送范围"><a href="#校验收货地址是否超出配送范围" class="headerlink" title="校验收货地址是否超出配送范围"></a>校验收货地址是否超出配送范围</h1><h2 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h2><p>注册账号：<a href="https://passport.baidu.com/v2/?reg&tt=1671699340600&overseas=&gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&tpl=pp&u=https://lbsyun.baidu.com/index.php?title=%E9%A6%96%E9%A1%B5">https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&amp;tpl=pp&amp;u=https%3A%2F%2Flbsyun.baidu.com%2Findex.php%3Ftitle%3D%E9%A6%96%E9%A1%B5</a></p>
<p>登录百度地图开放平台：<a href="https://lbsyun.baidu.com/">https://lbsyun.baidu.com/</a></p>
<p>进入控制台，创建应用，获取AK：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221222170049729.png" alt="image-20221222170049729"></p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221222170256927.png" alt="image-20221222170256927"></p>
<p>相关接口:</p>
<p><a href="https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding">https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding</a></p>
<p><a href="https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1">https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1</a></p>
<h2 id="2-代码开发"><a href="#2-代码开发" class="headerlink" title="2. 代码开发"></a>2. 代码开发</h2><h3 id="2-1-application-yml"><a href="#2-1-application-yml" class="headerlink" title="2.1 application.yml"></a>2.1 application.yml</h3><p>配置外卖商家店铺地址和百度地图的AK：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221222170819582.png" alt="image-20221222170819582"></p>
<h3 id="2-2-OrderServiceImpl"><a href="#2-2-OrderServiceImpl" class="headerlink" title="2.2 OrderServiceImpl"></a>2.2 OrderServiceImpl</h3><p>改造OrderServiceImpl，注入上面的配置项：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;sky.shop.address&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String shopAddress;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;sky.baidu.ak&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String ak;</span><br></pre></td></tr></table></figure>

<p>在OrderServiceImpl中提供校验方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查客户的收货地址是否超出配送范围</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkOutOfRange</span><span class="params">(String address)</span> &#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;address&quot;</span>,shopAddress);</span><br><span class="line">        map.put(<span class="string">&quot;output&quot;</span>,<span class="string">&quot;json&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;ak&quot;</span>,ak);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取店铺的经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopCoordinate</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(shopCoordinate);</span><br><span class="line">        <span class="keyword">if</span>(!jsonObject.getString(<span class="string">&quot;status&quot;</span>).equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;店铺地址解析失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解析</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">location</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;result&quot;</span>).getJSONObject(<span class="string">&quot;location&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lat</span> <span class="operator">=</span> location.getString(<span class="string">&quot;lat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lng</span> <span class="operator">=</span> location.getString(<span class="string">&quot;lng&quot;</span>);</span><br><span class="line">        <span class="comment">//店铺经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopLngLat</span> <span class="operator">=</span> lat + <span class="string">&quot;,&quot;</span> + lng;</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;address&quot;</span>,address);</span><br><span class="line">        <span class="comment">//获取用户收货地址的经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userCoordinate</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">        jsonObject = JSON.parseObject(userCoordinate);</span><br><span class="line">        <span class="keyword">if</span>(!jsonObject.getString(<span class="string">&quot;status&quot;</span>).equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;收货地址解析失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解析</span></span><br><span class="line">        location = jsonObject.getJSONObject(<span class="string">&quot;result&quot;</span>).getJSONObject(<span class="string">&quot;location&quot;</span>);</span><br><span class="line">        lat = location.getString(<span class="string">&quot;lat&quot;</span>);</span><br><span class="line">        lng = location.getString(<span class="string">&quot;lng&quot;</span>);</span><br><span class="line">        <span class="comment">//用户收货地址经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userLngLat</span> <span class="operator">=</span> lat + <span class="string">&quot;,&quot;</span> + lng;</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;origin&quot;</span>,shopLngLat);</span><br><span class="line">        map.put(<span class="string">&quot;destination&quot;</span>,userLngLat);</span><br><span class="line">        map.put(<span class="string">&quot;steps_info&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//路线规划</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">&quot;https://api.map.baidu.com/directionlite/v1/driving&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">        jsonObject = JSON.parseObject(json);</span><br><span class="line">        <span class="keyword">if</span>(!jsonObject.getString(<span class="string">&quot;status&quot;</span>).equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;配送路线规划失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解析</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> (JSONArray) result.get(<span class="string">&quot;routes&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">distance</span> <span class="operator">=</span> (Integer) ((JSONObject) jsonArray.get(<span class="number">0</span>)).get(<span class="string">&quot;distance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(distance &gt; <span class="number">5000</span>)&#123;</span><br><span class="line">            <span class="comment">//配送距离超过5000米</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;超出配送范围&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在OrderServiceImpl的submitOrder方法中调用上面的校验方法：</p>
<p><img src="/2024/03/02/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day09-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97%E3%80%81%E5%95%86%E5%AE%B6%E7%AB%AF%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97/image-20221222171444981-170937784053635.png" alt="image-20221222171444981"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day08-用户下单、订单支付</title>
    <url>/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/</url>
    <content><![CDATA[<h1 id="用户下单"><a href="#用户下单" class="headerlink" title="用户下单"></a>用户下单</h1><p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301164352182.png" alt="image-20240301164352182"></p>
<h1 id="导入地址簿功能代码"><a href="#导入地址簿功能代码" class="headerlink" title="导入地址簿功能代码"></a>导入地址簿功能代码</h1><p>从技术层面来说就是单表的增删改查，这块代码不再编写，直接导入即可。</p>
<h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p>一个用户可以有多个地址，但是只能有一个默认地址。可以新增收货地址，编辑收货地址，删除收货地址。</p>
<p><strong>产品原型:</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301164838336.png" alt="image-20240301164838336"></p>
<ul>
<li>查询地址列表</li>
<li>新增收货地址</li>
<li>修改收货地址（1.根据主键把原先的地址收货信息查出来，用于页面回写 2. 修改内容）</li>
<li>删除收货地址</li>
<li>设置默认地址</li>
<li>查询默认地址</li>
</ul>
<p><strong>接口设计：</strong></p>
<ul>
<li>新增地址</li>
<li>查询当前登录用户的所有地址信息</li>
<li>查询默认地址</li>
<li>根据id修改地址</li>
<li>根据id删除地址</li>
<li>根据id查询地址</li>
<li>设置默认地址</li>
</ul>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301165444509.png" alt="image-20240301165444509"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301212740075.png" alt="image-20240301212740075"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301212750229.png" alt="image-20240301212750229"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301212814494.png" alt="image-20240301212814494"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301212933217.png" alt="image-20240301212933217"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301213033647.png" alt="image-20240301213033647"></p>
<p><strong>数据库设计（address_book表）</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301213223486.png" alt="image-20240301213223486"></p>
<h2 id="代码导入"><a href="#代码导入" class="headerlink" title="代码导入"></a>代码导入</h2><p>导入课程资料中的地址簿模块功能代码</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301214000482.png" alt="image-20240301214000482"></p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301215743474.png" alt="image-20240301215743474"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301215758660.png" alt="image-20240301215758660"></p>
<h1 id="用户下单-1"><a href="#用户下单-1" class="headerlink" title="用户下单"></a>用户下单</h1><h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p>用户下单业务说明：</p>
<p>在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。</p>
<p>用户下单后会产生订单相关数据，订单数据需要能够体现如下信息：</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301220047378.png" alt="image-20240301220047378"></p>
<ul>
<li>用户购买了哪些商品，每个商品数量是多少？（用户购物车）</li>
<li>订单总金额是多少？（餐盒费：1元&#x2F;一个菜品，配送费：固定6元）</li>
<li>收货地址是哪？（地址簿表）</li>
<li>哪个用户下的单？（地址簿表）</li>
<li>用户手机号是多少？（地址簿表）</li>
</ul>
<p><strong>用户点餐业务流程：</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301222617161.png" alt="image-20240301222617161"></p>
<p>接口设计（分析）：</p>
<ul>
<li><p>请求方式：POST</p>
</li>
<li><p>请求路径：&#x2F;user&#x2F;order&#x2F;submit</p>
</li>
<li><p>参数：</p>
<ul>
<li>地址簿id</li>
<li>配送状态（立即送出、选择送出时间）</li>
<li>打包费</li>
<li>总金额</li>
<li>备注</li>
<li>餐具数量</li>
</ul>
</li>
</ul>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301222801169.png" alt="image-20240301222801169"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301223059603.png" alt="image-20240301223059603"></p>
<p>返回数据：</p>
<ul>
<li>下单时间</li>
<li>订单总金额</li>
<li>订单号</li>
<li>订单id</li>
</ul>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301223435368.png" alt="image-20240301223435368"></p>
<p><strong>数据表设计</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301224540874.png" alt="image-20240301224540874"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301224551523.png" alt="image-20240301224551523"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301225121299.png" alt="image-20240301225121299"></p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>根据用户下单接口的参数设计DTO</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301233219545.png" alt="image-20240301233219545"></p>
<p><strong>根据用户下单接口的返回结果设计VO</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240301233254551.png" alt="image-20240301233254551"></p>
<p><strong>user.OrderController</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.OrdersSubmitDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderSubmitVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController(&quot;userOrderController&quot;)</span> <span class="comment">//给这个类的Bean对象起别名，防止其他包内同名类声明成Bean变量</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/order&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户端订单相关接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/submit&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;用户下单&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;OrderSubmitVO&gt; <span class="title function_">submit</span><span class="params">(<span class="meta">@RequestBody</span> OrdersSubmitDTO ordersSubmitDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;用户下单：参数为：&#123;&#125;&quot;</span>,ordersSubmitDTO);</span><br><span class="line">        <span class="type">OrderSubmitVO</span> <span class="variable">orderSubmitVO</span> <span class="operator">=</span> orderService.submitOrder(ordersSubmitDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success(orderSubmitVO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>orderservice类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.OrdersSubmitDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderSubmitVO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    OrderSubmitVO <span class="title function_">submitOrder</span><span class="params">(OrdersSubmitDTO ordersSubmitDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OrderServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailMapper orderDetailMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressBookMapper addressBookMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderSubmitVO <span class="title function_">submitOrder</span><span class="params">(OrdersSubmitDTO ordersSubmitDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//处理各种业务异常(地址簿为空、购物车数据为空）</span></span><br><span class="line">        <span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());</span><br><span class="line">        <span class="keyword">if</span>(addressBook == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//抛出业务异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AddressBookBusinessException</span>(MessageConstant.ADDRESS_BOOK_IS_NULL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询当前用户的购物车数据</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">        shoppingCart.setUserId(userId);</span><br><span class="line">        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(shoppingCartList == <span class="literal">null</span> || shoppingCartList.size() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShoppingCartBusinessException</span>(MessageConstant.SHOPPING_CART_IS_NULL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向订单表插入1条数据</span></span><br><span class="line">        <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">        BeanUtils.copyProperties(ordersSubmitDTO, orders);</span><br><span class="line">        orders.setOrderTime(LocalDateTime.now());</span><br><span class="line">        orders.setPayStatus(Orders.UN_PAID);</span><br><span class="line">        orders.setStatus(Orders.PENDING_PAYMENT);</span><br><span class="line">        orders.setNumber(String.valueOf(System.currentTimeMillis()));</span><br><span class="line">        orders.setPhone(addressBook.getPhone());</span><br><span class="line">        orders.setConsignee(addressBook.getConsignee());</span><br><span class="line">        orders.setUserId(userId);</span><br><span class="line">        orderMapper.insert(orders);</span><br><span class="line"></span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向订单明细表插入n条数据</span></span><br><span class="line">        <span class="keyword">for</span> (ShoppingCart cart : shoppingCartList) &#123;</span><br><span class="line">            <span class="type">OrderDetail</span> <span class="variable">orderDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetail</span>();</span><br><span class="line">            BeanUtils.copyProperties(cart,orderDetail);</span><br><span class="line">            orderDetail.setOrderId(orders.getId()); <span class="comment">//设置当前订单明细关联的订单ID</span></span><br><span class="line">            orderDetailList.add(orderDetail);</span><br><span class="line">        &#125;</span><br><span class="line">        orderDetailMapper.insertBatch(orderDetailList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//清空当前用户的购物车数据</span></span><br><span class="line">        shoppingCartMapper.deleteByUserId(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装VO返回结果</span></span><br><span class="line">        <span class="type">OrderSubmitVO</span> <span class="variable">orderSubmitVO</span> <span class="operator">=</span> OrderSubmitVO.builder()</span><br><span class="line">            .id(orders.getId())</span><br><span class="line">            .orderTime(orders.getOrderTime())</span><br><span class="line">            .orderNumber(orders.getNumber())</span><br><span class="line">            .orderAmount(orders.getAmount())</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderSubmitVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OrderDetailMapper</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.OrderDetail;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderDetailMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入订单明细数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderDetailList</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;OrderDetail&gt; orderDetailList)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>OrderMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.OrderMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span> = <span class="string">&quot;insert&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert into orders (number, status, user_id, address_book_id, order_time, checkout_time, pay_method, pay_status, amount, remark, phone, address, user_name, consignee, cancel_reason, rejection_reason, cancel_time, estimated_delivery_time, delivery_status, delivery_time, pack_amount, tableware_number, tableware_status) VALUES</span><br><span class="line">            (#&#123;number&#125;, #&#123;status&#125;, #&#123;userId&#125;, #&#123;addressBookId&#125;, #&#123;orderTime&#125;, #&#123;checkoutTime&#125;, #&#123;payMethod&#125;, #&#123;payStatus&#125;, #&#123;amount&#125;, #&#123;remark&#125;, #&#123;phone&#125;, #&#123;address&#125;, #&#123;userName&#125;, #&#123;consignee&#125;, #&#123;cancelReason&#125;, #&#123;rejectionReason&#125;, #&#123;cancelTime&#125;, #&#123;estimatedDeliveryTime&#125;, #&#123;deliveryStatus&#125;, #&#123;deliveryTime&#125;, #&#123;packAmount&#125;, #&#123;tablewareNumber&#125;, #&#123;tablewareStatus&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>OrderDetailMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.OrderDetail;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderDetailMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入订单明细数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderDetailList</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;OrderDetail&gt; orderDetailList)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>OrderDetailMapper.xml</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sky.mapper.OrderDetailMapper&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;insertBatch&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">order_detail</span> <span class="params">(name, image, order_id, dish_id, setmeal_id, dish_flavor, amount)</span> VALUES</span><br><span class="line">        &lt;foreach collection=<span class="string">&quot;orderDetailList&quot;</span> separator=<span class="string">&quot;,&quot;</span> item=<span class="string">&quot;od&quot;</span>&gt;</span><br><span class="line">            (#&#123;od.name&#125;, #&#123;od.image&#125;, #&#123;od.orderId&#125;, #&#123;od.dishId&#125;, #&#123;od.setmealId&#125;, #&#123;od.dishFlavor&#125;, #&#123;od.amount&#125;)</span><br><span class="line">        &lt;/foreach&gt;</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>



<h2 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302004333856.png" alt="image-20240302004333856"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302004348098.png" alt="image-20240302004348098"></p>
<h1 id="订单支付"><a href="#订单支付" class="headerlink" title="订单支付"></a>订单支付</h1><h2 id="微信支付介绍"><a href="#微信支付介绍" class="headerlink" title="微信支付介绍"></a>微信支付介绍</h2><p>要实现微信支付，要注册微信支付的商户号，注册商户号是有要求的，比如说必须要有一家企业，并且需要有正规的企业营业执照。只有具备这些资质，才能注册商户号，才能开通支付权限。</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302005600308.png" alt="image-20240302005600308"></p>
<p><strong>微信支付接入流程：</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302010033959.png" alt="image-20240302010033959"></p>
<p><strong>微信小程序支付时序图</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302010600013.png" alt="image-20240302010600013"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302010735321.png" alt="image-20240302010735321"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302011129869.png" alt="image-20240302011129869"></p>
<p>JSAP下单：商户系统调用该接口在微信支付服务后台生成预支付交易单</p>
<p>适用对象：直连商户</p>
<p>请求URL：<a href="https://api/mch.weixin.qq.com/v3/pay/transactions/jsapi">https://api/mch.weixin.qq.com/v3/pay/transactions/jsapi</a></p>
<p>请求方式：POST</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302011421383.png" alt="image-20240302011421383"></p>
<p>微信小程序调起支付：通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法wx.requestPayment调用小程序支付</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302011805064.png" alt="image-20240302011805064"></p>
<h2 id="微信支付准备工作"><a href="#微信支付准备工作" class="headerlink" title="微信支付准备工作"></a>微信支付准备工作</h2><p>获取微信支付平台证书、商户私钥文件</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302012338158.png" alt="image-20240302012338158"></p>
<p><strong>获取临时域名：支付成功后微信服务通过该域名回调我们的程序</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302012549593.png" alt="image-20240302012549593"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302014347118.png" alt="image-20240302014347118"></p>
<h1 id="导入功能代码"><a href="#导入功能代码" class="headerlink" title="导入功能代码"></a>导入功能代码</h1><p>配置微信支付相关信息</p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302125724453.png" alt="image-20240302125724453"></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302131956590.png" alt="image-20240302131956590"></p>
<p><strong>OrderController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/payment&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;订单支付&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderPaymentVO&gt; <span class="title function_">payment</span><span class="params">(<span class="meta">@RequestBody</span> OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    log.info(<span class="string">&quot;订单支付：&#123;&#125;&quot;</span>, ordersPaymentDTO);</span><br><span class="line">    <span class="type">OrderPaymentVO</span> <span class="variable">orderPaymentVO</span> <span class="operator">=</span> orderService.payment(ordersPaymentDTO);</span><br><span class="line">    log.info(<span class="string">&quot;生成预支付交易单：&#123;&#125;&quot;</span>, orderPaymentVO);</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderPaymentVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OrderSerivce类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>OrderServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailMapper orderDetailMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressBookMapper addressBookMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatPayUtil weChatPayUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 当前登录用户id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用微信支付接口，生成预支付交易单</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> weChatPayUtil.pay(</span><br><span class="line">            ordersPaymentDTO.getOrderNumber(), <span class="comment">//商户订单号</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>), <span class="comment">//支付金额，单位 元</span></span><br><span class="line">            <span class="string">&quot;苍穹外卖订单&quot;</span>, <span class="comment">//商品描述</span></span><br><span class="line">            user.getOpenid() <span class="comment">//微信用户的openid</span></span><br><span class="line">        );</span><br><span class="line"><span class="comment">//        JSONObject jsonObject = new JSONObject();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jsonObject.getString(<span class="string">&quot;code&quot;</span>) != <span class="literal">null</span> &amp;&amp; jsonObject.getString(<span class="string">&quot;code&quot;</span>).equals(<span class="string">&quot;ORDERPAID&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;该订单已支付&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">OrderPaymentVO</span> <span class="variable">vo</span> <span class="operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);</span><br><span class="line">        vo.setPackageStr(jsonObject.getString(<span class="string">&quot;package&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span> &#123;</span><br><span class="line">        <span class="comment">// 根据订单号查询订单</span></span><br><span class="line">        <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getByNumber(outTradeNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span></span><br><span class="line">        <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">            .id(ordersDB.getId())</span><br><span class="line">            .status(Orders.TO_BE_CONFIRMED)</span><br><span class="line">            .payStatus(Orders.PAID)</span><br><span class="line">            .checkoutTime(LocalDateTime.now())</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        orderMapper.update(orders);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>OrderMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Orders;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入订单数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Orders orders)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据订单号查询订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderNumber</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from orders where number = #&#123;orderNumber&#125;&quot;)</span></span><br><span class="line">    Orders <span class="title function_">getByNumber</span><span class="params">(String orderNumber)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改订单信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Orders orders)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>orderMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.OrderMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.sky.entity.Orders&quot;</span>&gt;</span></span><br><span class="line">        update orders</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;cancelReason != null and cancelReason!=&#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">                cancel_reason=#&#123;cancelReason&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;rejectionReason != null and rejectionReason!=&#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">                rejection_reason=#&#123;rejectionReason&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;cancelTime != null&quot;</span>&gt;</span></span><br><span class="line">                cancel_time=#&#123;cancelTime&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;payStatus != null&quot;</span>&gt;</span></span><br><span class="line">                pay_status=#&#123;payStatus&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;payMethod != null&quot;</span>&gt;</span></span><br><span class="line">                pay_method=#&#123;payMethod&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;checkoutTime != null&quot;</span>&gt;</span></span><br><span class="line">                checkout_time=#&#123;checkoutTime&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span></span><br><span class="line">                status = #&#123;status&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;deliveryTime != null&quot;</span>&gt;</span></span><br><span class="line">                delivery_time = #&#123;deliveryTime&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="阅读订单支付功能代码"><a href="#阅读订单支付功能代码" class="headerlink" title="阅读订单支付功能代码"></a>阅读订单支付功能代码</h2><p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302134848276.png" alt="image-20240302134848276"></p>
<p><strong>因为个人没有企业版小程序，没有对应的版本号和资格证书，所以如下修改代码</strong></p>
<p>修改<strong>OrderServiceImpl</strong>类的payment方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailMapper orderDetailMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressBookMapper addressBookMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatPayUtil weChatPayUtil;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Orders orders;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 当前登录用户id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        //调用微信支付接口，生成预支付交易单</span></span><br><span class="line"><span class="comment">//        JSONObject jsonObject = weChatPayUtil.pay(</span></span><br><span class="line"><span class="comment">//            ordersPaymentDTO.getOrderNumber(), //商户订单号</span></span><br><span class="line"><span class="comment">//            new BigDecimal(0.01), //支付金额，单位 元</span></span><br><span class="line"><span class="comment">//            &quot;苍穹外卖订单&quot;, //商品描述</span></span><br><span class="line"><span class="comment">//            user.getOpenid() //微信用户的openid</span></span><br><span class="line"><span class="comment">//        );</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        if (jsonObject.getString(&quot;code&quot;) != null &amp;&amp; jsonObject.getString(&quot;code&quot;).equals(&quot;ORDERPAID&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//            throw new OrderBusinessException(&quot;该订单已支付&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line">        jsonObject.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;ORDERPAID&quot;</span>);</span><br><span class="line">        <span class="type">OrderPaymentVO</span> <span class="variable">vo</span> <span class="operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);</span><br><span class="line">        vo.setPackageStr(jsonObject.getString(<span class="string">&quot;package&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为替代微信支付成功后的数据库订单状态更新，多定义一个方法进行修改</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">OrderPaidStatus</span> <span class="operator">=</span> Orders.PAID; <span class="comment">//支付状态，已支付</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">OrderStatus</span> <span class="operator">=</span> Orders.TO_BE_CONFIRMED;  <span class="comment">//订单状态，待接单</span></span><br><span class="line">        <span class="comment">//发现没有将支付时间 check_out属性赋值，所以在这里更新</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">check_out_time</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        orderMapper.updateStatus(OrderStatus, OrderPaidStatus, check_out_time, orders.getId());</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改orderMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Orders;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于替换微信支付更新数据库状态的问题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderStatus</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderPaidStatus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update(&quot;update orders set status = #&#123;orderStatus&#125;,pay_status = #&#123;orderPaidStatus&#125; ,checkout_time = #&#123;check_out_time&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateStatus</span><span class="params">(Integer orderStatus, Integer orderPaidStatus, LocalDateTime check_out_time, Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改前端代码</strong></p>
<p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302145505722.png" alt="image-20240302145505722"></p>
<h2 id="功能测试-2"><a href="#功能测试-2" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/03/01/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day08-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/image-20240302151443363.png" alt="image-20240302151443363"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day07-缓存商品、购物车</title>
    <url>/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/</url>
    <content><![CDATA[<h1 id="需求原因"><a href="#需求原因" class="headerlink" title="需求原因"></a>需求原因</h1><p>通过小程序可以展示菜品和套餐数据，这些都是存储在同一个数据库当中，如果在某个时间段内，有大量的用户来点餐，就会频繁的查询数据库，数据库的访问压力相对来说比较大，造成数据库查询性能下降，用户使用体验不是很好，直观的体验是点击某个分类之后要经过几秒钟才能显示对应数据。</p>
<p><strong>解决办法</strong>：使用缓存来解决，需要把商品数据缓存至redis当中。这会大大提高系统的查询性能。</p>
<p><strong>购物车相关功能，点击+号，将商品添加到购物车。</strong></p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240229144150227.png" alt="image-20240229144150227"></p>
<h1 id="缓存菜品"><a href="#缓存菜品" class="headerlink" title="缓存菜品"></a>缓存菜品</h1><h2 id="问题说明"><a href="#问题说明" class="headerlink" title="问题说明"></a>问题说明</h2><p>从系统的查询性能分析问题，然后通过缓存的方式提高系统的查询性能。</p>
<ol>
<li>是不是所有商品都要缓存？</li>
<li>商品缓存的粒度如何？</li>
</ol>
<p>用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。系统查询的瓶颈是数据库查询。</p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240229151909242.png" alt="image-20240229151909242"></p>
<p>结果：系统响应慢、用户体验差</p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p>通过Redis来缓存菜品数据，减少数据库查询操作。</p>
<p>Redis是基于内存访问数据的，数据库是磁盘IO操作。</p>
<p>内存操作相对于磁盘操作性能较高。</p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240229221904137.png" alt="image-20240229221904137"></p>
<p><strong>缓存逻辑分析：</strong></p>
<ul>
<li><p>每个分类的菜品保存一份缓存数据（key：分类ID，value：分类下具体的菜品数据，使用string字符串保存，右侧的菜品在java中用list表示，我们可以将其序列化，转成redis的字符串）</p>
</li>
<li><p>数据库中菜品数据有变更时清理缓存数据。（在商家端改了数据，要清理缓存，不然数据没有更新）</p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240229222637493.png" alt="image-20240229222637493"></p>
</li>
</ul>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240229223752062.png" alt="image-20240229223752062"></p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>user.dishcontroller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController(&quot;userDishController&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端-菜品浏览接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;DishVO&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">        <span class="comment">//构造redis中的key，规则：dish_分类id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + categoryId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询redis中是否存在菜品数据</span></span><br><span class="line">        List&lt;DishVO&gt; list = (List&lt;DishVO&gt;) redisTemplate.opsForValue().get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果存在，直接返回，无需查询数据库</span></span><br><span class="line">            <span class="keyword">return</span> Result.success(list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">        dish.setCategoryId(categoryId);</span><br><span class="line">        dish.setStatus(StatusConstant.ENABLE);<span class="comment">//查询起售中的菜品</span></span><br><span class="line"></span><br><span class="line">        list = dishService.listWithFlavor(dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果不存在，查询数据库，将查询到的数据放到redis中</span></span><br><span class="line">        redisTemplate.opsForValue().set(key, list);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改管理端接口DishController的相关方法，加入清理缓存的逻辑，需要改造的方法：</p>
<ul>
<li>新增菜品</li>
<li>修改菜品</li>
<li>批量删除菜品</li>
<li>起售、停售菜品</li>
</ul>
<p><strong>admin.dishcontroller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;菜品相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增菜品接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;新增菜品：&#123;&#125;&quot;</span>, dishDTO);</span><br><span class="line">        dishService.saveWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//清理缓存数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + dishDTO.getCategoryId();</span><br><span class="line">        redisTemplate.delete(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/page&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;菜品分页查询接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;菜品分页查询:&#123;&#125;&quot;</span>, dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> dishService.pageQuery(dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜品批量删除接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;菜品批量删除接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;菜品批量删除：&#123;&#125;&quot;</span>, ids);</span><br><span class="line">        dishService.deleteBatch(ids);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将所有的菜品缓存数据清理掉，所有以dish_下划线开头的key</span></span><br><span class="line">        cleanCache(<span class="string">&quot;dish_*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据id查询菜品&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;DishVO&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;根据id查询菜品：&#123;&#125;&quot;</span>,id);</span><br><span class="line">        <span class="type">DishVO</span> <span class="variable">dishVO</span> <span class="operator">=</span> dishService.getByIdWithFlavor(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(dishVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;修改菜品接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;修改菜品:&#123;&#125;&quot;</span>,dishDTO);</span><br><span class="line">        dishService.updateWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">        cleanCache(<span class="string">&quot;dish_*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;Dish&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;根据分类id查询菜品:&#123;&#125;&quot;</span>,categoryId);</span><br><span class="line">        List&lt;Dish&gt; list = dishService.list(categoryId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanCache</span><span class="params">(String pattern)</span>&#123;</span><br><span class="line">        <span class="comment">//将所有的菜品缓存数据清理掉，所有以dish_下划线开头的key</span></span><br><span class="line">        <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> redisTemplate.keys(pattern);</span><br><span class="line">        redisTemplate.delete(keys);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><h1 id="缓存套餐-Spring-Cache"><a href="#缓存套餐-Spring-Cache" class="headerlink" title="缓存套餐_Spring Cache"></a>缓存套餐_Spring Cache</h1><p>新的技术（spring-cache），由spring提供的技术。</p>
<h2 id="Spring-Cache"><a href="#Spring-Cache" class="headerlink" title="Spring Cache"></a>Spring Cache</h2><p>使用它可以进一步简化代码，提供了注解，要操作缓存数据，只要在方法上加入它提供的注解就可以。这种使用方式类似于事务管理。</p>
<p>Spring Cache是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。</p>
<p>Spring Cache提供了一层抽象，底层可以切换不同的缓存实现，例如：</p>
<ul>
<li>EHCache</li>
<li>Caffeine</li>
<li>Redis</li>
</ul>
<p><strong>导入maven坐标</strong>（不同缓存对应不同坐标，用redis就导入redis坐标）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!-- redis坐标 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>常用注解：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@EnableCaching</td>
<td>开启缓存注解功能，通常加在启动类上</td>
</tr>
<tr>
<td>@Cacheable</td>
<td>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将方法返回值放到缓存中</td>
</tr>
<tr>
<td>@CachePut</td>
<td>将方法的返回值放到缓存中</td>
</tr>
<tr>
<td>@CacheEvict</td>
<td>将一条或多条数据从缓存中删除</td>
</tr>
</tbody></table>
<h2 id="实现思路-1"><a href="#实现思路-1" class="headerlink" title="实现思路"></a>实现思路</h2><ol>
<li><p>在启动类加上@EnableCaching注解，开启缓存注解功能。</p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301112330973.png" alt="image-20240301112330973"></p>
</li>
<li><p>使用@CachePut注解，将对应方法的返回值放入redis缓存中。</p>
<p>该返回值的键，可以由#user.id或#result.id决定。</p>
<p><strong>UserController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#user.id&quot;) //如果使用spring Cache缓存数据，key的生成：userCache::2,</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#result.id&quot;) //对象导航</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#p0.id&quot;) //拿到当前方法的第一个参数</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#a0.id&quot;) //拿到当前方法的第一个参数</span></span><br><span class="line"><span class="meta">@CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#root.args[0].id&quot;)</span> <span class="comment">//拿到当前方法的第一个参数</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">    <span class="comment">//插入数据时要将数据放到缓存中</span></span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用@Cacheable注解，如果查到数据，会把它直接放到缓存中。</p>
<p>（Spring Cache底层是基于代理技术，即加入注解之后，Spring Cache会为当前的controller创建代理对象，我们在请求方法前是先进入代理对象，而在代理对象中查询redis）</p>
<p><strong>UserController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;userCache&quot;,key=&quot;#id&quot;)</span>  <span class="comment">//key的生成 userCache::id</span></span><br><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(id);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用@CacheEvict注解，方法结束完之后会删除缓存中的单条数据或全部数据</p>
<p><strong>UserController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;userCache&quot;,key=&quot;#id&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    userMapper.deleteById(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;userCache&quot;,allEntries = true)</span> <span class="comment">//删除redis缓存中userCache下的所有键值对</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/delAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span>&#123;</span><br><span class="line">    userMapper.deleteAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="代码开发-1"><a href="#代码开发-1" class="headerlink" title="代码开发"></a>代码开发</h2><h3 id="实现思路-2"><a href="#实现思路-2" class="headerlink" title="实现思路"></a>实现思路</h3><p>具体实现思路如下：</p>
<ul>
<li>导入Spring Cache和Redis相关的maven坐标</li>
<li>在启动类上加入@EnableCaching注解，开启缓存注解功能</li>
<li>在用户端接口SetmealController的list方法上加入@Cacheable注解</li>
<li>在管理端接口SetmealController的save、delete、update、startOrStop等方法上加入CacheEvit注解</li>
</ul>
<p><strong>检查pom文件</strong></p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301132623493.png" alt="image-20240301132623493"></p>
<p><strong>开启缓存功能</strong></p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301132649067.png" alt="image-20240301132649067"></p>
<p><strong>修改user&#x2F;setmealcontroller类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据分类id查询套餐&quot;)</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;setmealCache&quot;, key = &quot;#categoryId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;Setmeal&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">    setmeal.setCategoryId(categoryId);</span><br><span class="line">    setmeal.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">    List&lt;Setmeal&gt; list = setmealService.list(setmeal);</span><br><span class="line">    <span class="keyword">return</span> Result.success(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301132834586.png" alt="image-20240301132834586"></p>
<p><strong>修改admin&#x2F;setmealcontroller类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;, key = &quot;#setmealDTO.categoryId&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;新增套餐接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;新增套餐接口:&#123;&#125;&quot;</span>,setmealDTO);</span><br><span class="line">    setmealService.saveWithDish(setmealDTO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;批量删除套餐&quot;)</span></span><br><span class="line"><span class="keyword">public</span>  Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span>&#123;</span><br><span class="line">    setmealService.deleteBatch(ids);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;修改套餐&quot;)</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> &#123;</span><br><span class="line">    setmealService.update(setmealDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;套餐起售停售&quot;)</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status, Long id)</span> &#123;</span><br><span class="line">    setmealService.startOrStop(status, id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">给user&#x2F;admin端的dishcontroller类中也修改对应的注释。</font></p>
<h2 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h2><p>管理端前端登录，修改菜品价格，会发现redis中对应的缓存数据被删除。</p>
<p>客户端根据分类查询菜品，会发现redis中保存了菜品的对应数据。</p>
<h1 id="添加购物车"><a href="#添加购物车" class="headerlink" title="添加购物车"></a>添加购物车</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301135115767.png" alt="image-20240301135115767"></p>
<p><strong>接口设计</strong></p>
<ul>
<li>请求方式：POST</li>
<li>请求路径：&#x2F;user&#x2F;shoppingCart&#x2F;add</li>
<li>请求参数：套餐id、菜品id、口味</li>
<li>返回结果：code、data、msg</li>
</ul>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301135634271.png" alt="image-20240301135634271"></p>
<p><strong>数据库设计</strong></p>
<ul>
<li>作用：暂时存放所选商品的地方</li>
<li>选的什么商品</li>
<li>每个商品都买了几个</li>
<li>不同用户的购物车需要区分开</li>
</ul>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301140329045.png" alt="image-20240301140329045"></p>
<p>加点冗余字段，不用联表查询，单表查询，提高查询速度。</p>
<h2 id="代码开发-2"><a href="#代码开发-2" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>shoppingCartController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/shoppingCart&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端-购物车相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartService shoppingCartService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加购物车&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;添加购物车，商品信息为：&#123;&#125;&quot;</span>,shoppingCartDTO);</span><br><span class="line"></span><br><span class="line">        shoppingCartService.addShoppingCart(shoppingCartDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartService接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.ShoppingCartDTO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//判断当前加入到购物车中的商品是否已经存在了</span></span><br><span class="line">        <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">        BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        shoppingCart.setUserId(currentId);</span><br><span class="line"></span><br><span class="line">        List&lt;ShoppingCart&gt; list = shoppingCartMapper.list(shoppingCart);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果已经存在了，只需要将数量加一</span></span><br><span class="line">        <span class="comment">//要么查不到，要么对于同一用户的的同一商品的同一口味，只有可能获得一条数据</span></span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">ShoppingCart</span> <span class="variable">cart</span> <span class="operator">=</span> list.get(<span class="number">0</span>);  <span class="comment">//查到数据</span></span><br><span class="line">            cart.setNumber(cart.getNumber() + <span class="number">1</span>); <span class="comment">//update shopping_car set number = ? and id = ?</span></span><br><span class="line">            shoppingCartMapper.updateNumberById(cart);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果不存在，需要插入一条购物车数据</span></span><br><span class="line">            <span class="comment">//判断本次添加到购物车的是菜品还是套餐</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">dishId</span> <span class="operator">=</span> shoppingCartDTO.getDishId();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">setmealId</span> <span class="operator">=</span> shoppingCartDTO.getSetmealId();</span><br><span class="line">            <span class="keyword">if</span> (dishId != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//本次添加到购物车的是菜品</span></span><br><span class="line">                <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(dishId);</span><br><span class="line">                shoppingCart.setName(dish.getName());</span><br><span class="line">                shoppingCart.setImage(dish.getImage());</span><br><span class="line">                shoppingCart.setAmount(dish.getPrice());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//本次添加到购物车的是套餐</span></span><br><span class="line">                <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(setmealId);</span><br><span class="line">                shoppingCart.setName(setmeal.getName());</span><br><span class="line">                shoppingCart.setImage(setmeal.getImage());</span><br><span class="line">                shoppingCart.setAmount(setmeal.getPrice());</span><br><span class="line">            &#125;</span><br><span class="line">            shoppingCart.setNumber(<span class="number">1</span>);</span><br><span class="line">            shoppingCart.setCreateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">            shoppingCartMapper.insert(shoppingCart);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.ShoppingCart;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartMapper</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态条件查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;ShoppingCart&gt; <span class="title function_">list</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update shopping_cart set number = #&#123;number&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateNumberById</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入购物车数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into shopping_cart (name, image, user_id, dish_id, setmeal_id, dish_flavor, amount, create_time) &quot; +</span></span><br><span class="line"><span class="meta">        &quot;values (#&#123;name&#125;,#&#123;userId&#125;,#&#123;dishId&#125;,#&#123;setmealId&#125;,#&#123;dishFlavor&#125;,#&#123;amount&#125;,#&#123;createTime&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.ShoppingCartMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.sky.entity.ShoppingCart&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.sky.entity.ShoppingCart&quot;</span>&gt;</span></span><br><span class="line">        select * from shopping_cart</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>user_id = #&#123;userId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;setmealId != null&quot;</span>&gt;</span>setmeal_id = #&#123;setmealId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dishId != null&quot;</span>&gt;</span>dish_id = #&#123;dishId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dishFlavor != null&quot;</span>&gt;</span>dish_flavor = #&#123;dishFlavor&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-2"><a href="#功能测试-2" class="headerlink" title="功能测试"></a>功能测试</h2><p>正常测试即可。</p>
<h1 id="查看购物车"><a href="#查看购物车" class="headerlink" title="查看购物车"></a>查看购物车</h1><h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301151804526.png" alt="image-20240301151804526"></p>
<p><strong>接口设计</strong></p>
<ul>
<li>请求方式：GET方式</li>
<li>请求路径：&#x2F;user&#x2F;shoppingCart&#x2F;list</li>
<li>请求参数：无</li>
</ul>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301153218027.png" alt="image-20240301153218027"></p>
<h2 id="代码开发-3"><a href="#代码开发-3" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>ShoppingCartController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查看购物车&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;ShoppingCart&gt;&gt; <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;ShoppingCart&gt; list = shoppingCartService.showShoppingCart();</span><br><span class="line">    <span class="keyword">return</span> Result.success(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartService类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">List&lt;ShoppingCart&gt; <span class="title function_">showShoppingCart</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ShoppingCart&gt; <span class="title function_">showShoppingCart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">        <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> ShoppingCart.builder()</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        List&lt;ShoppingCart&gt; list = shoppingCartMapper.list(shoppingCart);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.ShoppingCartMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.sky.entity.ShoppingCart&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.sky.entity.ShoppingCart&quot;</span>&gt;</span></span><br><span class="line">        select * from shopping_cart</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>user_id = #&#123;userId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;setmealId != null&quot;</span>&gt;</span>and setmeal_id = #&#123;setmealId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dishId != null&quot;</span>&gt;</span>and dish_id = #&#123;dishId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dishFlavor != null&quot;</span>&gt;</span>and dish_flavor = #&#123;dishFlavor&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-3"><a href="#功能测试-3" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301154323794.png" alt="image-20240301154323794"></p>
<h1 id="清空购物车"><a href="#清空购物车" class="headerlink" title="清空购物车"></a>清空购物车</h1><h2 id="需求分析与设计"><a href="#需求分析与设计" class="headerlink" title="需求分析与设计"></a>需求分析与设计</h2><p><strong>产品原型：</strong></p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301154620724.png" alt="image-20240301154620724"></p>
<p><strong>接口设计</strong></p>
<ul>
<li><p>请求方式：DELETE</p>
</li>
<li><p>请求路径：&#x2F;user&#x2F;shoppingCart&#x2F;clean</p>
</li>
<li><p>请求参数：无</p>
</li>
<li><p>返回结果：Result.sucess()</p>
</li>
</ul>
<p>把当前用户所有购物车数据删除即可。</p>
<p><img src="/2024/02/29/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day07-%E7%BC%93%E5%AD%98%E5%95%86%E5%93%81%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6/image-20240301154809669.png" alt="image-20240301154809669"></p>
<h2 id="代码开发-4"><a href="#代码开发-4" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>ShoppingCartController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/shoppingCart&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端-购物车相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartService shoppingCartService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/clean&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;清空购物车&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">clean</span><span class="params">()</span>&#123;</span><br><span class="line">        shoppingCartService.cleanShoppingCart();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartService类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.ShoppingCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.ShoppingCart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空购物车</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cleanShoppingCart</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空购物车</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanShoppingCart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">        shoppingCartMapper.deleteByUserId(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据UserId删除数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Delete(&quot;delete from shopping_cart where user_id = #&#123;userId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteByUserId</span><span class="params">(Long userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="功能测试-4"><a href="#功能测试-4" class="headerlink" title="功能测试"></a>功能测试</h2><p>已测试</p>
<h1 id="从购物车中减去某个商品"><a href="#从购物车中减去某个商品" class="headerlink" title="从购物车中减去某个商品"></a>从购物车中减去某个商品</h1><p><strong>ShoppingCartController</strong>类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从购物车中减去某个商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/sub&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;从购物车中减去某个商品&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sub</span><span class="params">(<span class="meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span>&#123;</span><br><span class="line">    shoppingCartService.subShoppingCart(shoppingCartDTO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartService类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartService</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">        BeanUtils.copyProperties(shoppingCartDTO,shoppingCart);</span><br><span class="line">        shoppingCart.setUserId(userId);</span><br><span class="line"></span><br><span class="line">        List&lt;ShoppingCart&gt; list = shoppingCartMapper.list(shoppingCart);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果已经存在了，只需要将数量加一</span></span><br><span class="line">        <span class="comment">//要么查不到，要么对于同一用户的的同一商品的同一口味，只有可能获得一条数据</span></span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">ShoppingCart</span> <span class="variable">cart</span> <span class="operator">=</span> list.get(<span class="number">0</span>);  <span class="comment">//查到数据</span></span><br><span class="line">            <span class="keyword">if</span> (cart.getNumber() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                cart.setNumber(cart.getNumber() - <span class="number">1</span>); <span class="comment">//update shopping_car set number = ? and id = ?</span></span><br><span class="line">                shoppingCartMapper.updateNumberById(cart);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                shoppingCartMapper.delByUserInfo(cart);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartMapper</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delByUserInfo</span><span class="params">(ShoppingCart cart)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ShoppingCartMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.ShoppingCartMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;delByUserInfo&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.sky.entity.ShoppingCart&quot;</span>&gt;</span></span><br><span class="line">        delete from shopping_cart</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>user_id = #&#123;userId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;setmealId != null&quot;</span>&gt;</span>and setmeal_id = #&#123;setmealId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dishId != null&quot;</span>&gt;</span>and dish_id = #&#123;dishId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;dishFlavor != null&quot;</span>&gt;</span>and dish_flavor = #&#123;dishFlavor&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day06-微信登录、商品浏览</title>
    <url>/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/</url>
    <content><![CDATA[<h1 id="微信登录、商品浏览"><a href="#微信登录、商品浏览" class="headerlink" title="微信登录、商品浏览"></a>微信登录、商品浏览</h1><p>从使用者角度来看，分为两个端，一个是提供给商家来使用的，我们称之为管理端，还有一个是给点餐用户使用的，我们称之为用户端。用户端实际上是通过微信小程序来实现。我们今天要开发的是用户端的两个功能，一个是微信登录，另一个是商品浏览。</p>
<p><strong>实现效果</strong></p>
<p>当点餐用户进入小程序之后，小程序会弹出这个窗口，即获取当前微信用户的昵称、头像，然后用户既可以点击允许，这个时候我们就可以获取用户相关的信息，完成登录。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227153826569.png" alt="image-20240227153826569"></p>
<p>登录成功之后就会进入首页面，首页面会展示对应的商品，商品只有两种，一种是菜品、一种是套餐。它是按照不同的分类来展示的，不同的分类下面挂着相应的菜品或套餐，我们这边分别展示套餐和菜品的相应结果。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227153911199.png" alt="image-20240227153911199"></p>
<p>我们今天要完成的是客户端的微信登录和商品浏览功能。</p>
<h1 id="HttpClient"><a href="#HttpClient" class="headerlink" title="HttpClient"></a>HttpClient</h1><p>使用它就可以在Java中构造请求并发送请求，后面要实现微信登录，在实现功能时会使用HttpClient来请求微信的某个接口，最终实现微信登录。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>HttpClient时Apache Jakarta Common下的子项目，可以用来提供高效的、最新的、功能丰富的支持HTTP协议的客户端编程工具包，并且它支持HTTP协议最新的版本和建议。</p>
<ul>
<li><p>HttpClient时客户端编程工具包</p>
</li>
<li><p>可以在Java程序中通过HttpClient工具包构建Http请求，并且可以发送HttpClient请求</p>
</li>
<li><p>如果要使用这个依赖的话，要添加如下的依赖坐标</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>核心API：</p>
<ul>
<li>HttpClient（接口，设计了可以发送http请求的方法）</li>
<li>HttpClients（可以创建HttpClient实现类对象）</li>
<li>CloseableHttpClient（实现类，实现了HttpClient接口的方法）</li>
<li>HttpGet（Http Get请求）</li>
<li>HttpPost（Http Post请求）</li>
</ul>
<p>发送请求步骤：</p>
<ul>
<li><p>创建HttpClient对象</p>
</li>
<li><p>创建Http请求对象（如果要发送get方式请求，就需要构造httpget对象，同理，如果要发送post方式请求，就需要构造httppost对象）</p>
</li>
<li><p>调用HttpClient的execute方法发送请求</p>
</li>
</ul>
<h2 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h2><p>在sky-common包下已经导入了aliyun-sdk-oss坐标，它其实底层使用了httpclient依赖，已经导入了对应的jar包。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227155419091.png" alt="image-20240227155419091"></p>
<h2 id="发送GET方式请求"><a href="#发送GET方式请求" class="headerlink" title="发送GET方式请求"></a>发送GET方式请求</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpClientTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过httpclient发送GET方式的请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGET</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//创建HttpClient对象(是HttpClient接口的实现类）</span></span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建Http请求对象(设置请求url）</span></span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(<span class="string">&quot;http://localhost:8080/user/shop/status&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送请求,接收响应结果</span></span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取服务端返回的状态码</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.getStatusLine().getStatusCode();</span><br><span class="line">        System.out.println(<span class="string">&quot;服务端返回的状态码为：&quot;</span> + statusCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取响应体(它是HttpEntity类）</span></span><br><span class="line">        <span class="type">HttpEntity</span> <span class="variable">entity</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用EntityUtils解析HttpEntity类对象的内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> EntityUtils.toString(entity);</span><br><span class="line">        System.out.println(<span class="string">&quot;服务端返回的数据为：&quot;</span> + body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        response.close();</span><br><span class="line">        httpClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过httpclient发送POST方式的请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPOST</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227161833300.png" alt="image-20240227161833300"></p>
<h2 id="发送POST方式请求"><a href="#发送POST方式请求" class="headerlink" title="发送POST方式请求"></a>发送POST方式请求</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.StringEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpClientTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过httpclinet发送POST方式的请求,POST要提交JSON格式的数据，包含用户名和密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPOST</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//创建httpclient对象</span></span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建请求对象</span></span><br><span class="line">        <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(<span class="string">&quot;http://localhost:8080/admin/employee/login&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建JSON对象，对应请求体，请求体中存储对应的键值对</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringEntity</span>(jsonObject.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置请求参数</span></span><br><span class="line">        entity.setContentEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置请求体的数据格式</span></span><br><span class="line">        entity.setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="comment">//将请求体数据entity放到httpPost中</span></span><br><span class="line">        httpPost.setEntity(entity);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送请求</span></span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析返回结果</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.getStatusLine().getStatusCode();</span><br><span class="line">        System.out.println(<span class="string">&quot;服务端返回的状态码为: &quot;</span> + statusCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取响应体（它是httpEntity类对象）</span></span><br><span class="line">        <span class="type">HttpEntity</span> <span class="variable">entity1</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用EntityUtils解析HttpEntity类对象的内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> EntityUtils.toString(entity1);</span><br><span class="line">        System.out.println(<span class="string">&quot;服务端返回的数据为：&quot;</span> + body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        response.close();</span><br><span class="line">        httpClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227165020563.png" alt="image-20240227165020563"></p>
<p>为了方便在项目中使用它，我们在项目sky-common中封装了HttpClientUtil工具类，里面有doGet方法，doPost方法，doPost4Json方法。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227165701177.png" alt="image-20240227165701177"></p>
<h1 id="微信小程序开发"><a href="#微信小程序开发" class="headerlink" title="微信小程序开发"></a>微信小程序开发</h1><p>用户端时基于微信小程序开发的，讲一下它的完整开发流程。</p>
<h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227170358065.png" alt="image-20240227170358065"></p>
<p><a href="https://mp.weixin.qq.com/cgi-bin/wx?token=&lang=zh_CN">https://mp.weixin.qq.com/cgi-bin/wx?token=&amp;lang=zh_CN</a></p>
<p><strong>开放注册范围</strong></p>
<p><font color="red"><strong>个人是没有权限开通支付功能的</strong></font></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227170636131.png" alt="image-20240227170636131"></p>
<p><strong>开发支持</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227170717321.png" alt="image-20240227170717321"></p>
<p><strong>介绍</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240227170758028.png" alt="image-20240227170758028"></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="注册小程序"><a href="#注册小程序" class="headerlink" title="注册小程序"></a>注册小程序</h3><p>注册地址：<a href="https://mp.weixin.qq.com/wxopen/waregister?action=step1">https://mp.weixin.qq.com/wxopen/waregister?action=step1</a></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228114809590.png" alt="image-20240228114809590"></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228115457266.png" alt="image-20240228115457266"></p>
<h3 id="完善小程序信息"><a href="#完善小程序信息" class="headerlink" title="完善小程序信息"></a>完善小程序信息</h3><p><font color="red">完善小程序信息、小程序类目</font></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228115852988.png" alt="image-20240228115852988"></p>
<p>获取APPID和AppSecret </p>
<p>（appID：wx1d1f9482fef7f19e）</p>
<p>（密钥：xxx）</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228120100017.png" alt="image-20240228120100017"></p>
<h3 id="下载开发者工具"><a href="#下载开发者工具" class="headerlink" title="下载开发者工具"></a>下载开发者工具</h3><p>下载地址： <a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/stable.html">https://developers.weixin.qq.com/miniprogram/dev/devtools/stable.html</a></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228120158680.png" alt="image-20240228120158680"></p>
<p>下载并安装开发者工具</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228120734805.png" alt="image-20240228120734805"></p>
<p><strong>开发界面介绍</strong></p>
<p><strong>左侧-模拟器，最终在手机上显示的效果</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228120947976.png" alt="image-20240228120947976"></p>
<p><strong>右侧-调试器，调试小程序，小程序发送了何种请求，服务端响应回来的数据是什么，它实际上跟浏览器的调试工具是一样的，即它们用的是同一个内核。</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228121022625.png" alt="image-20240228121022625"></p>
<p><strong>中间-编辑器，主要对代码进行编辑操作的区域</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228121250712.png" alt="image-20240228121250712"></p>
<p><strong>设置选择显示哪些界面</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228121430392.png" alt="image-20240228121430392"></p>
<p><font color="red">在本地设置中勾选不校验合法域名，我们现在在开发阶段，小程序有可能要发出请求，最终请求到我们本地后端的tomcat服务器，如果不勾选不校验合法域名，请求是发送不出去的。</font></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228121549279.png" alt="image-20240228121549279"></p>
<h2 id="入门案例-1"><a href="#入门案例-1" class="headerlink" title="入门案例"></a>入门案例</h2><p>操作步骤：</p>
<ul>
<li><p>了解小程序目录结构</p>
</li>
<li><p>编写小程序代码</p>
</li>
<li><p>编译小程序（在开发工具模拟器中可以查看效果）</p>
</li>
</ul>
<h3 id="了解小程序目录结构"><a href="#了解小程序目录结构" class="headerlink" title="了解小程序目录结构"></a>了解小程序目录结构</h3><p>小程序包含一个描述整体程序的app和多个描述各自页面的page。一个小程序主体部分由三个文件组成，必须放在项目的根目录，如下：</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>必需</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>app.js</td>
<td>是</td>
<td>小程序逻辑</td>
</tr>
<tr>
<td>app.json</td>
<td>是</td>
<td>小程序公共配置</td>
</tr>
<tr>
<td>app.wxss</td>
<td>否</td>
<td>小程序公共样式表</td>
</tr>
</tbody></table>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228122652914.png" alt="image-20240228122652914"></p>
<p>一个小程序可能有多个页面，商品浏览页面，购物车页面，订单支付页面，商品详情页面。这些页面会放在pages中。一个小程序页面由四个文件组成：</p>
<table>
<thead>
<tr>
<th>文件类型</th>
<th>必需</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>js</td>
<td>是</td>
<td>页面逻辑</td>
</tr>
<tr>
<td>wxml</td>
<td>是</td>
<td>页面结构</td>
</tr>
<tr>
<td>json</td>
<td>否</td>
<td>页面配置</td>
</tr>
<tr>
<td>wxss</td>
<td>否</td>
<td>页面样式表</td>
</tr>
</tbody></table>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228122700305.png" alt="image-20240228122700305"></p>
<h3 id="内容讲解"><a href="#内容讲解" class="headerlink" title="内容讲解"></a>内容讲解</h3><p>app.json内容中的pages设置了当前页面的文件路径，实际上是page&#x2F;index目录下的index.wxml文件。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228124635317.png" alt="image-20240228124635317"></p>
<p>index.wxml就类似于html，模拟器中的Weixin字段是由index.wxml来决定的。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228125651655.png" alt="image-20240228125651655"></p>
<p>在模拟器中动态设置显示的值，现在index.wxml中编写对应的变量，再在index.js中设置data，编写键值对msg设置对应的值。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228125909677.png" alt="image-20240228125909677"></p>
<p>在index.wxml中创建获取用户信息按钮，给按钮设置显示样式bind:tag，挂靠方法getUserInfo，在index.js中设置对应的方法实现。</p>
<p>方法的具体实现细节如下：使用微信小程序内置对象wx，调用这个对象的getUserProfile方法，调用该方法时会在模拟器中弹出获取昵称、头像等页面信息，该方法会获取当前微信用户的信息。success属性对应一个回调函数，类似于lambda表达式，res是返回值，通过console在控制台输出返回值中包含的用户信息。</p>
<p><font color="red">注：微信版本更新之后，这个小程序会不弹框，要修改基础库，在右上角 详细-&gt;本地设置-&gt;调试基础库 建议选择基础库版本在2.21.2~2.27.0版本之间头像，昵称都能获取。</font></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228131640243.png" alt="image-20240228131640243"></p>
<h3 id="获取用户的昵称、头像"><a href="#获取用户的昵称、头像" class="headerlink" title="获取用户的昵称、头像"></a><strong>获取用户的昵称、头像</strong></h3><p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228133125216.png" alt="image-20240228133125216"></p>
<p>上述的功能并不是微信登录，微信登录要获取当前微信用户的唯一标识，即openid，要获取openid，就需要微信小程序首先获得授权码（用户授权给我们），然后我们使用获得的授权码向微信服务器发送请求，最终获取到当前微信用户的openId。</p>
<p>下面演示如何获取微信用户的授权码（只能使用一次，用户每次返回的授权码是不同的）。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228134325727.png" alt="image-20240228134325727"></p>
<h3 id="向服务器发送GET请求"><a href="#向服务器发送GET请求" class="headerlink" title="向服务器发送GET请求"></a><strong>向服务器发送GET请求</strong></h3><p>在index.wxml中编写发送请求按钮，挂载wxLogin方法，在index.js中实现wxLogin方法，调用wx.request方法，设置url，请求方式method以及成功后获取的值res.data。在模拟器中点击发送请求按钮，会向url地址以method方式发送请求，返回的值Result的json数据格式封装在res.data中。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228152755836.png" alt="image-20240228152755836"></p>
<h3 id="发布小程序"><a href="#发布小程序" class="headerlink" title="发布小程序"></a>发布小程序</h3><p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228153324209.png" alt="image-20240228153324209"></p>
<p>目前上传的版本是开发者版本，可以在微信小程序网页端查询。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228153502527.png" alt="image-20240228153502527"></p>
<p>他是开发版本，我们在微信小程序中是搜索不到这个小程序的。</p>
<h1 id="微信登录"><a href="#微信登录" class="headerlink" title="微信登录"></a>微信登录</h1><h2 id="导入小程序代码"><a href="#导入小程序代码" class="headerlink" title="导入小程序代码"></a>导入小程序代码</h2><p>开发小程序本质上属于前端的开发。本项目侧重后端开发。对于小程序的代码，我们已经提供好了。直接导入到微信开发者工具中使用即可。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228154535876.png" alt="image-20240228154535876"></p>
<p><font color="red">确保AppID是自己的ID。</font></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228154724267.png" alt="image-20240228154724267"></p>
<p><strong>项目代码整体结构</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228155000326.png" alt="image-20240228155000326"></p>
<p>可以通过vendor.js修改对应后端请求的端口号。</p>
<h2 id="微信登录流程"><a href="#微信登录流程" class="headerlink" title="微信登录流程"></a>微信登录流程</h2><p>微信登录：<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html</a></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228155242039.png" alt="image-20240228155242039"></p>
<ol>
<li>在小程序端，使用wx.login()获取授权码，再使用wx.request()向本地编写的后端服务发送授权码</li>
<li>后端服务要调用微信接口服务，需要向微信接口传输以下几个参数，appid，appsecret，code。（通过httpclient实现该功能）</li>
<li>微信接口服务向后端服务返回相应的数据，即session_key和openId（微信用户的唯一标识）。</li>
<li>后端服务要自定义登录状态，记录当前微信用户的一些信息，如openid存到数据库，同时还可以为微信用户产生一个token，即一个令牌，因为后续小程序还要持续不断的请求后端服务，如添加购物车，下单等，这个时候都需要知道小程序的微信用户是谁。因此，后端服务会将令牌返回给小程序。</li>
<li>小程序存储自定义登录状态。</li>
<li>后续发起各种业务请求，如添加购物车，浏览商品，查看订单，查询历史订单，一系列的业务请求，这个时候它就要将自定义的登录状态给他带过去，请求后端服务，也就是开发者服务器。</li>
<li>后端服务要解析token，解析完之后就知道当前微信用户，进行相应业务操作，返回业务数据。</li>
</ol>
<p>在postman中向微信接口服务发送请求：<a href="https://api.weixin.qq.com/sns/jscode2session?appid=wx1d1f9482fef7f19e&secret=2aaa22b5aeafd21e2d8742d72e99cdd1&js_code=0f1Jgz100T0aER1o1k400rlBAK0Jgz1g&grant_type=authorization_code%EF%BC%8C%E5%BE%AE%E4%BF%A1%E6%8E%A5%E5%8F%A3%E6%9C%8D%E5%8A%A1%E4%BC%9A%E8%BF%94%E5%9B%9E%E5%AF%B9%E5%BA%94%E7%9A%84session_key%E5%92%8Copenid%E3%80%82">https://api.weixin.qq.com/sns/jscode2session?appid=wx1d1f9482fef7f19e&amp;secret=2aaa22b5aeafd21e2d8742d72e99cdd1&amp;js_code=0f1Jgz100T0aER1o1k400rlBAK0Jgz1g&amp;grant_type=authorization_code，微信接口服务会返回对应的session_key和openid。</a></p>
<p>发送的请求要求填写四个参数，其中grant_type的值要求固定为authorization_code。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228225958639.png" alt="image-20240228225958639"></p>
<h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228230305932.png" alt="image-20240228230305932"></p>
<p>用户名账号登录要注册账号，设置密码，使用注册的账号密码登录。</p>
<p>微信登录不用注册，直接来获得微信用户的唯一标识，知道当前的微信用户是谁即可。</p>
<p>业务规则：</p>
<ul>
<li>基于微信登录实现小程序的登录功能</li>
<li><font color="red">如果是新用户需要自动完成注册，把用户返回的信息保存到自定义的数据库当中。</font></li>
</ul>
<p><strong>接口设计</strong></p>
<p>要完成微信登录，要获得openId；要获得openId，就要先获得授权码code；接口应该小程序和后端发送请求，并且把授权码发过来，然后我们使用授权码请求微信接口服务，需要给用户返回令牌，令牌中包含用户的唯一标识，后续用户操作都要携带令牌，验证他是合法用户。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228231445814.png" alt="image-20240228231445814"></p>
<p>数据库设计（user表）：</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228231818854.png" alt="image-20240228231818854"></p>
<p>(不同的小程序，我们能够使用的权限是不同的，如果是以个人注册的小程序，没有权限获取到微信用户注册的手机号的，如果是以企业的资质注册的小程序，可以拿到微信用户的手机号)</p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><p>配置微信登录所需的配置项：</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228232754608.png" alt="image-20240228232754608"></p>
<p>配置为微信用户生成jwt令牌时使用的配置项（管理端和用户端有不同的jwt令牌规则，注意token-name已经提前跟前端沟通好了，前端会通过请求头带过来token，然后我们按照获取这个参数的值来校验即可）</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228233039039.png" alt="image-20240228233039039"></p>
<p>我们在这里设置了对应的配置属性类，程序启动时，@Component注解将其自动作为Bean对象注入到IOC容器中，同时@ConfigurationProperties(prefix&#x3D;”xxx”)会让该Bean对象从yml文件的对应配置项中获取属性值。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240228234536502.png" alt="image-20240228234536502"></p>
<p><strong>UserContrller</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.UserLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.UserLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/user&quot;)</span>  <span class="comment">//用户端的用户模块</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端用户相关接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;微信登录&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;UserLoginVO&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> UserLoginDTO userLoginDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;微信用户登录：&#123;&#125;&quot;</span>,userLoginDTO.getCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//微信登录</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.wxLogin(userLoginDTO);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(JwtClaimsConstant.USER_ID,user.getId());  <span class="comment">//用户的唯一标识，用户的主键ID</span></span><br><span class="line">        <span class="comment">//为微信用户生成jwt令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtUtil.createJWT(jwtProperties.getUserSecretKey(), jwtProperties.getUserTtl(), claims);</span><br><span class="line"></span><br><span class="line">        <span class="type">UserLoginVO</span> <span class="variable">userLoginVO</span> <span class="operator">=</span> UserLoginVO.builder()</span><br><span class="line">            .id(user.getId())</span><br><span class="line">            .openid(user.getOpenid())</span><br><span class="line">            .token(token)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(userLoginVO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>UserService接口</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.UserLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信登录，返回用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    User <span class="title function_">wxLogin</span><span class="params">(UserLoginDTO userLoginDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>UserServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.UserLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.LoginFailedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.WeChatProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.HttpClientUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatProperties weChatProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//微信服务接口地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WX_LOGIN=<span class="string">&quot;https://api.weixin.qq.com/sns/jscode2session&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">wxLogin</span><span class="params">(UserLoginDTO userLoginDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//传统的用户登录是检查自己的用户表，检查用户名和密码是否正确，现在是微信服务，需要先调用微信服务器接口，获得当前微信用户的openid。</span></span><br><span class="line">        <span class="comment">//调用微信接口服务，获取当前微信用户的openid。</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> getOpenid(userLoginDTO.getCode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(openid == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LoginFailedException</span>(MessageConstant.LOGIN_FAILED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前用户是否为新用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getByOpenId(openid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果是新用户，自动完成注册</span></span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">            user = User.builder()</span><br><span class="line">                    .openid(openid)</span><br><span class="line">                    .createTime(LocalDateTime.now())</span><br><span class="line">                    .build();</span><br><span class="line">            userMapper.insert(user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回这个用户对象</span></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用微信接口服务，获取微信用户的openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getOpenid</span><span class="params">(String code)</span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;appid&quot;</span>,weChatProperties.getAppid());</span><br><span class="line">        map.put(<span class="string">&quot;secret&quot;</span>,weChatProperties.getSecret());</span><br><span class="line">        map.put(<span class="string">&quot;js_code&quot;</span>,code);</span><br><span class="line">        map.put(<span class="string">&quot;grant_type&quot;</span>,<span class="string">&quot;authorization_code&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> HttpClientUtil.doGet(WX_LOGIN, map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断openid是否为空，如果为空，表示登录失败，抛出业务异常</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;openid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> openid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>UserMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据openid查询用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from User where openid = #&#123;openId&#125; &quot;)</span></span><br><span class="line">    User <span class="title function_">getByOpenId</span><span class="params">(String openid)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入用户对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>UserMapper.xml</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sky.mapper.UserMapper&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;insert&quot;</span> useGeneratedKeys=<span class="string">&quot;true&quot;</span> keyProperty=<span class="string">&quot;id&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">user</span> <span class="params">(openid, name, phone, sex, id_number, avatar, create_time)</span> VALUES</span><br><span class="line">                        (#&#123;openid&#125;,#&#123;name&#125;,#&#123;phone&#125;,#&#123;sex&#125;,#&#123;idNumber&#125;,#&#123;avatar&#125;,#&#123;createTime&#125;)</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>



<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229123908275.png" alt="image-20240229123908275"></p>
<p>登录成功后，后续每一次请求，都会在请求头中把token带过去，但是它的请求头的键是authentication，值是登录成功是返回给小程序端的token。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229123949741.png" alt="image-20240229123949741"></p>
<p>接下来要编写拦截器来校验用户端，也就是小程序端发送过来的请求，校验其token是否合法。</p>
<p>复制客户端拦截器，修改部分代码</p>
<p><strong>JwtTokenUserInterceptor</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jwt令牌校验的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenUserInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验jwt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前线程的id:&quot;</span> + Thread.currentThread().getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前拦截到的是Controller的方法还是其他资源</span></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            <span class="comment">//当前拦截到的不是动态方法，直接放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、从请求头中获取令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getUserTokenName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、校验令牌</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;jwt校验:&#123;&#125;&quot;</span>, token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.USER_ID).toString());</span><br><span class="line">            log.info(<span class="string">&quot;当前用户id：&quot;</span>, userId);</span><br><span class="line">            BaseContext.setCurrentId(userId);</span><br><span class="line">            <span class="comment">//3、通过，放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">//4、不通过，响应401状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229124703282.png" alt="image-20240229124703282"></p>
<p><strong>注册拦截器，排除不用的部分</strong></p>
<p><strong>WebMvcConfiguration</strong></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229124744445.png" alt="image-20240229124744445"></p>
<h1 id="导入商品浏览功能代码"><a href="#导入商品浏览功能代码" class="headerlink" title="导入商品浏览功能代码"></a>导入商品浏览功能代码</h1><p>从技术层面来说仍然属于CRUD范围。分析需求，使用的接口。</p>
<h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p>用户进入苍穹外卖小程序之前要先进行微信登录，登录之后，会进入到下面这个页面。</p>
<p><strong>产品原型</strong></p>
<p>左侧：套餐分类、菜品分类。</p>
<p>右侧：菜品。菜品展示还有区别，有的菜品有规格选择，有的菜品是+号。</p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229125411899.png" alt="image-20240229125411899"></p>
<p><strong>接口分析</strong></p>
<ol>
<li>查询分类（左侧分类数据要查询，对应查询分类的接口。）</li>
<li>根据分类id查询菜品（右侧菜品要查，根据某个菜品的分类ID查询对应的菜品。）</li>
<li>根据分类id查询套餐（根据分类ID查套餐的数据。）</li>
<li>根据套餐id查询包含的菜品（根据套餐ID查询他具体包含哪些菜品。）</li>
</ol>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229125830802.png" alt="image-20240229125830802"></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229130002753.png" alt="image-20240229130002753"></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229130532936.png" alt="image-20240229130532936"></p>
<p><img src="/2024/02/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day06-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E3%80%81%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/image-20240229130554697.png" alt="image-20240229130554697"></p>
<h2 id="代码导入和功能测试"><a href="#代码导入和功能测试" class="headerlink" title="代码导入和功能测试"></a>代码导入和功能测试</h2><p>(已完成)</p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day05-redis-店铺营业状态设置</title>
    <url>/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/</url>
    <content><![CDATA[<h1 id="店铺营业状态设置"><a href="#店铺营业状态设置" class="headerlink" title="店铺营业状态设置"></a>店铺营业状态设置</h1><p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240224203009689.png" alt="image-20240224203009689"></p>
<h1 id="Redis入门"><a href="#Redis入门" class="headerlink" title="Redis入门"></a>Redis入门</h1><h2 id="Redis简介"><a href="#Redis简介" class="headerlink" title="Redis简介"></a>Redis简介</h2><p>Redis是一个基于<strong>内存</strong>的key-value结构数据库。（内存存储）</p>
<ul>
<li>基于内存存储，读写性能高</li>
<li>适合存储热点数据（热点商品、咨询、新闻）（热点数据：在某个点会有大量用户访问该数据）</li>
<li>企业应用广泛</li>
</ul>
<p>官网：<a href="https://redis.io/">https://redis.io</a></p>
<p>中文网：<a href="https://www.redis.net.cn/">https://www.redis.net.cn/</a></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225211637018.png" alt="image-20240225211637018"></p>
<p><strong>Redis与mysql的区别</strong></p>
<ol>
<li>redis将数据存到内存中，mysql将数据存到磁盘的数据文件中。</li>
<li>redis是基于键值对存储数据，mysql通过二维表的形式存储数据。</li>
</ol>
<h2 id="Redis下载与安装"><a href="#Redis下载与安装" class="headerlink" title="Redis下载与安装"></a>Redis下载与安装</h2><p>Redis安装包分为Windows版本和Linux版本：</p>
<ul>
<li>Windows版本下载地址：<a href="https://github.com/microsoftarchive/redis/releases">https://github.com/microsoftarchive/redis/releases</a></li>
<li>Linux版下载地址：<a href="https://download.redis.io/releases/">https://download.redis.io/releases/</a></li>
</ul>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225211828939.png" alt="image-20240225211828939"></p>
<p>Redis的Windows版属于绿色软件，直接解压即可使用，解压后目录结构如下：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225212144784.png" alt="image-20240225212144784"></p>
<h2 id="Redis服务启动与停止"><a href="#Redis服务启动与停止" class="headerlink" title="Redis服务启动与停止"></a>Redis服务启动与停止</h2><p><strong>启动服务</strong>（第一个参数是redis-server.exe，第二个参数是redis.windows.conf）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">redis-server.exe redis.windows.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225213141902.png" alt="image-20240225213141902"></p>
<p><strong>停止服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ctrl + c</span><br></pre></td></tr></table></figure>



<p><strong>通过客户端连接redis服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">redis-cls.exe</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225214144982.png" alt="image-20240225214144982"></p>
<p>测试是否连上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225214313241.png" alt="image-20240225214313241"></p>
<p>退出redis</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225214412285.png" alt="image-20240225214412285"></p>
<p><strong>指定连接主机地址和端口</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">redis-cli.exe -h localhost -p 6379</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225214532703.png" alt="image-20240225214532703"></p>
<p>redis配置文件中默认是没有配置密码的，我们的客户端不用密码就可以连接上该redis。</p>
<p><strong>配置redis.windows.conf文件，给redis设置密码。</strong>（redis中没有用户名的概念）</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225214937198.png" alt="image-20240225214937198"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225215410275.png" alt="image-20240225215410275"></p>
<p>我们后期经常用的是redis客户端图形界面。</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225215513434.png" alt="image-20240225215513434"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225215559337.png" alt="image-20240225215559337"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225215648190.png" alt="image-20240225215648190"></p>
<p><strong>选择简体中文</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225215828897.png" alt="image-20240225215828897"></p>
<h1 id="Redis数据类型"><a href="#Redis数据类型" class="headerlink" title="Redis数据类型"></a>Redis数据类型</h1><h2 id="5种常用数据类型介绍"><a href="#5种常用数据类型介绍" class="headerlink" title="5种常用数据类型介绍"></a>5种常用数据类型介绍</h2><p>Redis存储的是key-value结构的数据，其中key是字符串类型，value有5种常用的数据类型。</p>
<ul>
<li>字符串string</li>
<li>哈希hash</li>
<li>列表list</li>
<li>集合set</li>
<li>有序集合 sorted set &#x2F; zset</li>
</ul>
<h2 id="各种数据类型特点"><a href="#各种数据类型特点" class="headerlink" title="各种数据类型特点"></a>各种数据类型特点</h2><p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225220033296.png" alt="image-20240225220033296"></p>
<ul>
<li>字符串（string）：普通字符串，Redis中最简单的数据类型</li>
<li>哈希（hash）：也叫散列，类似于Java中的HashMap结构（适合存储对象，这个值也可以看成键值对）</li>
<li>列表（list）：按照插入顺序排序，可以有重复元素，类似于Java中的LinkedList（朋友圈点赞的数据可以使用列表存储）</li>
<li>集合（set）：无序集合，没有重复元素，类似于Java中的HashSet，集合是可以做运算的。（朋友圈的共同朋友）</li>
<li>有序集合（sorted set &#x2F; zset）：集合中每个元素会关联一个分数（score）,根据分数升序排序，没有重复元素（各种排行榜，视频播放排行榜，投票排行榜等等）</li>
</ul>
<h1 id="Redis常用命令"><a href="#Redis常用命令" class="headerlink" title="Redis常用命令"></a>Redis常用命令</h1><p>mysql中操作数据是通过执行sql语句实现。</p>
<p>redis中操作数据，根据数据类型决定具体的操作语句。</p>
<p>redis和mysql一样不区分大小写。</p>
<h2 id="字符串操作命令"><a href="#字符串操作命令" class="headerlink" title="字符串操作命令"></a>字符串操作命令</h2><p>Redis字符串类型常用命令：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SET key value</td>
<td>设置指定key的值</td>
</tr>
<tr>
<td>GET key</td>
<td>获取指定key的值</td>
</tr>
<tr>
<td>SETEX key seconds value</td>
<td>设置指定key的值，并将key的过期时间设为seconds秒</td>
</tr>
<tr>
<td>SETNX key value</td>
<td>只有在key不存在时设置key的值</td>
</tr>
</tbody></table>
<p>SETEX key seconds value（获取手机号，输入验证码，验证码是有时间有效期的）</p>
<p>SETNX key value（分布式锁）</p>
<p><strong>redis编写界面</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225221635635.png" alt="image-20240225221635635"></p>
<ul>
<li>set name jack（设置键name的值为jack）</li>
<li>setex code 30 1234（设置键code的值为1234，有效期为30秒）</li>
<li>setnx name jack（如果内存中没有键name，那么设置其对应的值为jack）</li>
<li>get name（获取键name的值）</li>
</ul>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225222726132.png" alt="image-20240225222726132"></p>
<h2 id="哈希操作命令"><a href="#哈希操作命令" class="headerlink" title="哈希操作命令"></a>哈希操作命令</h2><p>Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象，常用命令：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>HSET key field value</td>
<td>将哈希表key中的字段field的值设为value</td>
</tr>
<tr>
<td>HGET key field</td>
<td>获取存储在哈希表中指定字段的值</td>
</tr>
<tr>
<td>HDEL key field</td>
<td>删除存储在哈希表中的指定字段</td>
</tr>
<tr>
<td>HKEYS key</td>
<td>获取哈希表中所有字段</td>
</tr>
<tr>
<td>HVALS key</td>
<td>获取哈希表中所有值</td>
</tr>
</tbody></table>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225224022001.png" alt="image-20240225224022001"></p>
<p><strong>新增键值对</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225225123082.png" alt="image-20240225225123082"></p>
<p><strong>删除键值对</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225225353214.png" alt="image-20240225225353214"></p>
<p><strong>查看键值对</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225225551179.png" alt="image-20240225225551179"></p>
<h2 id="列表操作命令"><a href="#列表操作命令" class="headerlink" title="列表操作命令"></a>列表操作命令</h2><p>Redis列表是简单的字符串列表，按照插入顺序排序，常用命令：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>LPUSH key value1 [value2]</td>
<td>将一个或多个值插入到列表头部（L指的是left）</td>
</tr>
<tr>
<td>LRANGE key start stop</td>
<td>获取列表指定范围内的元素（类似于sql当中的分页查询）</td>
</tr>
<tr>
<td>RPOP key</td>
<td>移除并获取列表最后一个元素（从右侧移出元素）</td>
</tr>
<tr>
<td>LLEN key</td>
<td>获取列表长度（元素的个数）</td>
</tr>
</tbody></table>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225225837799.png" alt="image-20240225225837799"></p>
<p><strong>LPUSH操作</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225230124699.png" alt="image-20240225230124699"></p>
<p><strong>LRANGE操作</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225230318256.png" alt="image-20240225230318256"></p>
<p><strong>RPOP操作</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225230429180.png" alt="image-20240225230429180"></p>
<p><strong>LLEN操作</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225230507692.png" alt="image-20240225230507692"></p>
<h2 id="集合操作命令"><a href="#集合操作命令" class="headerlink" title="集合操作命令"></a>集合操作命令</h2><p>Redis set是string类型的无序集合。集合成员是唯一的，集合中不能出现重复的数据，常用命令：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>SADD key member1 [member2]</td>
<td>向集合中添加一个或多个成员</td>
</tr>
<tr>
<td>SMEMBERS key</td>
<td>返回集合中的所有成员</td>
</tr>
<tr>
<td>SCARD key</td>
<td>获取集合的成员数</td>
</tr>
<tr>
<td>SINTER key1 [key2]</td>
<td>返回给定所有集合的交集</td>
</tr>
<tr>
<td>SUNION key1 [key2]</td>
<td>返回所有给定集合的并集</td>
</tr>
<tr>
<td>SREM key member1 [member2]</td>
<td>删除集合中一个或多个成员</td>
</tr>
</tbody></table>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231003667.png" alt="image-20240225231003667"></p>
<p><strong>创建set</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231309602.png" alt="image-20240225231309602"></p>
<p><strong>查看set所有成员</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231430272.png" alt="image-20240225231430272"></p>
<p><strong>获取集合成员数</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231453157.png" alt="image-20240225231453157"></p>
<p><strong>查看集合交集</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231554456.png" alt="image-20240225231554456"></p>
<p><strong>查看集合并集</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231619565.png" alt="image-20240225231619565"></p>
<p><strong>删除集合成员</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225231711195.png" alt="image-20240225231711195"></p>
<h2 id="有序集合操作命令"><a href="#有序集合操作命令" class="headerlink" title="有序集合操作命令"></a>有序集合操作命令</h2><p>Redis有序集合是string类型元素的集合，且不允许有重复成员。每个元素都会关联一个double类型的分数。分数可以用来排序。常用命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>ZADD key score1 member1 [score2  member2]</td>
<td>向有序集合添加一个或多个成员</td>
</tr>
<tr>
<td>ZRANGE key start stop [WITHSCORES]</td>
<td>通过索引区间返回有序集合中指定区间内的成员</td>
</tr>
<tr>
<td>ZINCRBY key increment member</td>
<td>有序集合中对指定成员的分数加上增量increment</td>
</tr>
<tr>
<td>ZREM key member [member …]</td>
<td>移除有序集合中的一个或多个成员</td>
</tr>
</tbody></table>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225232001110.png" alt="image-20240225232001110"></p>
<p><strong>创建有序集合</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225232306448.png" alt="image-20240225232306448"></p>
<p><strong>查询有序集合的内容（默认按照升序排列）</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225232508385.png" alt="image-20240225232508385"></p>
<p><strong>增加有序集合中值的权重</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225232631623.png" alt="image-20240225232631623"></p>
<p><strong>删除有序集合中的元素</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225232737356.png" alt="image-20240225232737356"></p>
<h2 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h2><p>Redis的通用命令是不分数据类型的，都可以使用的命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>KEYS pattern</td>
<td>查找所有符合给定模式（pattern）的key</td>
</tr>
<tr>
<td>EXISTS key</td>
<td>检查给定key是否存在</td>
</tr>
<tr>
<td>TYPE key</td>
<td>返回key所存储的值的类型</td>
</tr>
<tr>
<td>DEL key</td>
<td>该命令用于在key存在时删除key</td>
</tr>
</tbody></table>
<p><strong>查看所有的key</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225233017458.png" alt="image-20240225233017458"></p>
<p><strong>检查某个key是否存在</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225233046764.png" alt="image-20240225233046764"></p>
<p><strong>检查key的值类型</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225233128225.png" alt="image-20240225233128225"></p>
<p><strong>删除key</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240225233151433.png" alt="image-20240225233151433"></p>
<h1 id="在Java中操作Redis"><a href="#在Java中操作Redis" class="headerlink" title="在Java中操作Redis"></a>在Java中操作Redis</h1><h2 id="Redis的Java客户端"><a href="#Redis的Java客户端" class="headerlink" title="Redis的Java客户端"></a>Redis的Java客户端</h2><p>Redis的Java客户端很多，常用的几种：</p>
<ul>
<li>Jedis（Redis官方推荐的客户端）</li>
<li>Lettuce</li>
<li>Spring Data Redis（对Jedis和Lettuce进行了高度封装）</li>
</ul>
<p>Spring Data Redis是Spring的一部分，对Redis底层开发包进行了高度封装。</p>
<p>在Spring项目中，可以使用Spring Data Redis来简化操作。</p>
<h2 id="Spring-Data-Redis使用方式"><a href="#Spring-Data-Redis使用方式" class="headerlink" title="Spring Data Redis使用方式"></a>Spring Data Redis使用方式</h2><p>操作步骤：</p>
<ol>
<li><p>导入Spring Data Redis的maven坐标</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226001646019.png" alt="image-20240226001646019"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Redis数据源</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226001654290.png" alt="image-20240226001654290"></p>
<p><font color="red">redis服务启动后，默认情况下，他在redis服务中，创建了16个库。可以通过database指定使用的数据库，不同数据库的数据是完全隔离的。如果不配置database，默认连接到redis后，使用0号数据库。</font></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226002257564.png" alt="image-20240226002257564"></p>
</li>
<li><p>编写配置类，创建RedisTemplate对象（这个对象是Spring Data Redis最核心、最常用的对象）</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226001724266.png" alt="image-20240226001724266"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123; <span class="comment">//如果第三方bean需要依赖其他bean对象，直接再bean定义方法中设置形参即可，容器会根据类型自动装配</span></span><br><span class="line">        <span class="type">RedisTemplate</span> <span class="variable">redisTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置redis的连接工厂对象</span></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置redis当中key的序列化器</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过RedisTemplate对象操作Redis（通过单元测试可以系统学习redis的具体使用方式）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226004010021.png" alt="image-20240226004010021"></p>
</li>
</ol>
<p>redis有五种数据类型，每一种数据类型提供了各种操作命令，在此，redisTemplate封装了五种操作接口，对应五种数据类型。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226004304257.png" alt="image-20240226004304257"></p>
<h3 id="Spring-Data-Redis使用方法-操作字符串类型的数据"><a href="#Spring-Data-Redis使用方法-操作字符串类型的数据" class="headerlink" title="Spring Data Redis使用方法 操作字符串类型的数据"></a>Spring Data Redis使用方法 操作字符串类型的数据</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作字符串类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//set 向redis中插入数据</span></span><br><span class="line">        <span class="comment">//get 从redis中获取数据</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;city&quot;</span>,<span class="string">&quot;北京&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(<span class="string">&quot;city&quot;</span>);</span><br><span class="line">        System.out.println(city);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setex 插入数据的同时设置数据有效期（设置键值对code:1234，有效期是3分钟）</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;code&quot;</span>,<span class="string">&quot;1234&quot;</span>,<span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setnx 向redis中插入数据（如果键不存在）（value可以给任意类型，最终它都会将其序列化，最终都会转成redis当中的string进行存储，从java代码角度来看，可以给任何类型的参数）</span></span><br><span class="line">        redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;lock&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在application-dev.yml文件中设置了redis连接的内存的数据库为10号，在debug模式下进入到以下语句，再查看db10中对应的键值对。</p>
<p>此时db10中已经存在对应的键值对 “city”:”北京”</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226103538896.png" alt="image-20240226103538896"></p>
<p>我们使用redis desktop manager查看db10中city的值，会发现它是乱码的。</p>
<p><font color="red">这个时候它其实不是乱码的，我们是通过java程序操作对应的redis数据，它其实对数据进行了序列化操作，序列化之后才变成了如下图所示的值。而且key（city）是没问题的，并未出现乱码的效果，那是因为我们在用配置类声明RedisTemplate时，在其中配置了redis key的序列化器。如果不配置序列化器，redis也会使用默认的序列化器来序列化数据。</font></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226103631514.png" alt="image-20240226103631514"></p>
<p><font color="red">所以在java中查询redis的键值对中的value是没有问题的。只是在客户端上看起来乱码。</font></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226104111245.png" alt="image-20240226104111245"></p>
<h3 id="Spring-Data-Redis使用方法-操作哈希类型的数据"><a href="#Spring-Data-Redis使用方法-操作哈希类型的数据" class="headerlink" title="Spring Data Redis使用方法 操作哈希类型的数据"></a>Spring Data Redis使用方法 操作哈希类型的数据</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作哈希类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="comment">//hset</span></span><br><span class="line">        hashOperations.put(<span class="string">&quot;100&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        hashOperations.put(<span class="string">&quot;100&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;20&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hget</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) hashOperations.get(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">age</span> <span class="operator">=</span> (String) hashOperations.get(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;age&quot;</span>);</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(age);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hkeys</span></span><br><span class="line">        <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> hashOperations.keys(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        System.out.println(keys);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hvals</span></span><br><span class="line">        <span class="type">List</span> <span class="variable">values</span> <span class="operator">=</span> hashOperations.values(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        System.out.println(values);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hdel</span></span><br><span class="line">        hashOperations.delete(<span class="string">&quot;100&quot;</span>,<span class="string">&quot;age&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226105445070.png" alt="image-20240226105445070"></p>
<h3 id="Spring-Data-Redis使用方法-操作其他类型的数据"><a href="#Spring-Data-Redis使用方法-操作其他类型的数据" class="headerlink" title="Spring Data Redis使用方法 操作其他类型的数据"></a>Spring Data Redis使用方法 操作其他类型的数据</h3><p><strong>操作list类型数据</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226110601784.png" alt="image-20240226110601784"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作列表类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//lpush lrange rpop llen</span></span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//lpush</span></span><br><span class="line">        listOperations.leftPushAll(<span class="string">&quot;mylist&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>);</span><br><span class="line">        listOperations.leftPush(<span class="string">&quot;mylist&quot;</span>,<span class="string">&quot;d&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//lrange</span></span><br><span class="line">        <span class="type">List</span> <span class="variable">mylist</span> <span class="operator">=</span> listOperations.range(<span class="string">&quot;mylist&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        System.out.println(mylist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//rpop</span></span><br><span class="line">        listOperations.rightPop(<span class="string">&quot;mylist&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> listOperations.size(<span class="string">&quot;mylist&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">List</span> <span class="variable">mylist2</span> <span class="operator">=</span> listOperations.range(<span class="string">&quot;mylist&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        System.out.println(mylist2);</span><br><span class="line"></span><br><span class="line">        System.out.println(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>操作set类型数据</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226111149869.png" alt="image-20240226111149869"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作集合类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line"></span><br><span class="line">        setOperations.add(<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>);</span><br><span class="line">        setOperations.add(<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="string">&quot;y&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">set1</span> <span class="operator">=</span> setOperations.members(<span class="string">&quot;set1&quot;</span>);</span><br><span class="line">        System.out.println(set1);</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> setOperations.size(<span class="string">&quot;set1&quot;</span>);</span><br><span class="line">        System.out.println(size);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">intersect</span> <span class="operator">=</span> setOperations.intersect(<span class="string">&quot;set1&quot;</span>, <span class="string">&quot;set2&quot;</span>);</span><br><span class="line">        System.out.println(intersect);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">union</span> <span class="operator">=</span> setOperations.union(<span class="string">&quot;set1&quot;</span>, <span class="string">&quot;set2&quot;</span>);</span><br><span class="line">        System.out.println(union);</span><br><span class="line"></span><br><span class="line">        setOperations.remove(<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        System.out.println(setOperations.members(<span class="string">&quot;set1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>有序集合类型数据</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226111711857.png" alt="image-20240226111711857"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作有序集合类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testZset</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">        zSetOperations.add(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        zSetOperations.add(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="number">12</span>);</span><br><span class="line">        zSetOperations.add(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">zset1</span> <span class="operator">=</span> zSetOperations.range(<span class="string">&quot;zset1&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        System.out.println(zset1);</span><br><span class="line"></span><br><span class="line">        zSetOperations.incrementScore(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        zSetOperations.remove(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通用命令操作</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226112106895.png" alt="image-20240226112106895"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.DataType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用命令操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCommon</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//keys exists type del</span></span><br><span class="line">        <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> redisTemplate.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        System.out.println(keys);</span><br><span class="line"></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">name</span> <span class="operator">=</span> redisTemplate.hasKey(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">set</span> <span class="operator">=</span> redisTemplate.hasKey(<span class="string">&quot;set&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object key : keys) &#123;</span><br><span class="line">            <span class="type">DataType</span> <span class="variable">type</span> <span class="operator">=</span> redisTemplate.type(key);</span><br><span class="line">            System.out.println(type.name());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;mylist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="店铺营业状态设置-1"><a href="#店铺营业状态设置-1" class="headerlink" title="店铺营业状态设置"></a>店铺营业状态设置</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240226134917828.png" alt="image-20240226134917828"></p>
<p><strong>接口设计</strong></p>
<ul>
<li><p>修改营业状态的接口</p>
</li>
<li><p>管理端查询营业状态</p>
<p>查询营业接口首先要在商家查询，在客户端也要是查询的，商家和客户端能不能用同一个接口查询营业状态。从技术层面上是可以实现的，但是在项目当中，我们将其设置为两个不同的查询接口，为什么这么设置是因为，当前项目对于请求路径接口做了约定。</p>
</li>
<li><p>用户端查询营业状态</p>
</li>
</ul>
<p>本项目约定：</p>
<ul>
<li>管理端发出的请求，统一使用&#x2F;admin作为前缀</li>
<li>用户端发出的请求，统一使用&#x2F;user作为前缀</li>
</ul>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><p><font color="red">建议在每次开发前将测试类的方法前面的注释@SpringBootTest注释掉。</font></p>
<p>设置shopController层代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/shop&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;店铺相关接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置店铺的营业状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;status&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;设置店铺的营业状态&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">setStatus</span><span class="params">(<span class="meta">@PathVariable</span> Integer status)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;设置店铺的营业状态：&#123;&#125;&quot;</span>,status == <span class="number">1</span> ? <span class="string">&quot;营业中&quot;</span>:<span class="string">&quot;打烊中&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取店铺的营业状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取店铺的营业状态&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/status&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getStatus</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        log.info(&quot;获取到店铺的营业状态为：&#123;&#125;&quot;,);</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(<span class="string">&quot;SHOP_STATUS&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;设置店铺的营业状态：&#123;&#125;&quot;</span>, status == <span class="number">1</span> ? <span class="string">&quot;营业中&quot;</span>:<span class="string">&quot;打烊中&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们这里要操作redis就需要redisTemplate类，我们已经在配置类中创建了这个类，该类的对象已经注入到IOC容器中。</p>
<p><strong>创建用户端controller类，修改接口，保留查询方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/shop&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;店铺相关接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取店铺的营业状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取店铺的营业状态&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/status&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getStatus</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        log.info(&quot;获取到店铺的营业状态为：&#123;&#125;&quot;,);</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(<span class="string">&quot;SHOP_STATUS&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;设置店铺的营业状态：&#123;&#125;&quot;</span>, status == <span class="number">1</span> ? <span class="string">&quot;营业中&quot;</span>:<span class="string">&quot;打烊中&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>目前出现的问题</strong></p>
<p>user和admin下的类均为ShopController，且均加了注解@ResController，它们都会创建在Spring容器中，且Bean的名称相同，启动时会报错。</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227134346557.png" alt="image-20240227134346557"></p>
<p><strong>解决办法</strong></p>
<p>在user和admin目录下分别设置RestController类的Bean对象的别名</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227134611221.png" alt="image-20240227134611221"></p>
<p><strong>修改状态值为常量，方便代码维护</strong></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227134842819.png" alt="image-20240227134842819"></p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><ol>
<li><p>后端接口测试</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227145920511.png" alt="image-20240227145920511"></p>
</li>
<li><p>前后端联调测试</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227145838851.png" alt="image-20240227145838851"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227145851147.png" alt="image-20240227145851147"></p>
</li>
</ol>
<p>需求：我们希望客户端相关接口和管理端相关接口分开，方便后续测试。</p>
<p>解决办法，复制一份WebMvcConfiguration配置类下的docket方法，并修改部分代码，如下所示：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227150848627.png" alt="image-20240227150848627"></p>
<p>重启并打开后端测试界面</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day05-redis/image-20240227150914330.png" alt="image-20240227150914330"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day04-套餐管理</title>
    <url>/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<p>完成套餐管理模块所有业务功能，包括：</p>
<ul>
<li>新增套餐</li>
<li>套餐分页查询</li>
<li>删除套餐</li>
<li>修改套餐</li>
<li>起售停售套餐</li>
</ul>
<p>要求：</p>
<ol>
<li>根据产品原型进行需求分析，分析出业务规则</li>
<li>设计接口</li>
<li>梳理表之间的关系（分类表、菜品表、套餐表、口味表、套餐菜品关系表）</li>
<li>根据接口设计进行代码实现</li>
<li>分别通过swagger接口文档和前后端联调进行功能测试</li>
</ol>
<h3 id="1-1-需求分析和设计"><a href="#1-1-需求分析和设计" class="headerlink" title="1.1 需求分析和设计"></a>1.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018135930842-17087774618395.png" alt="image-20221018135930842"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018140833345-17087774618396.png" alt="image-20221018140833345"></p>
<p>业务规则：</p>
<ul>
<li>套餐名称唯一</li>
<li>套餐必须属于某个分类</li>
<li>套餐必须包含菜品</li>
<li>名称、分类、价格、图片为必填项</li>
<li>添加菜品窗口需要根据分类类型来展示菜品</li>
<li>新增的套餐默认为停售状态</li>
</ul>
<p>接口设计（共涉及到4个接口）：</p>
<ul>
<li>根据类型查询分类（已完成）</li>
<li>根据分类id查询菜品</li>
<li>图片上传（已完成）</li>
<li>新增套餐</li>
</ul>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018141521068-17087774618408.png" alt="image-20221018141521068"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018141606787-17087774618407.png" alt="image-20221018141606787"></p>
<p>数据库设计：</p>
<p>setmeal表为套餐表，用于存储套餐的信息。具体表结构如下：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>套餐名称</td>
<td>唯一</td>
</tr>
<tr>
<td>category_id</td>
<td>bigint</td>
<td>分类id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>price</td>
<td>decimal(10,2)</td>
<td>套餐价格</td>
<td></td>
</tr>
<tr>
<td>image</td>
<td>varchar(255)</td>
<td>图片路径</td>
<td></td>
</tr>
<tr>
<td>description</td>
<td>varchar(255)</td>
<td>套餐描述</td>
<td></td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>售卖状态</td>
<td>1起售 0停售</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>创建时间</td>
<td></td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>最后修改时间</td>
<td></td>
</tr>
<tr>
<td>create_user</td>
<td>bigint</td>
<td>创建人id</td>
<td></td>
</tr>
<tr>
<td>update_user</td>
<td>bigint</td>
<td>最后修改人id</td>
<td></td>
</tr>
</tbody></table>
<p>setmeal_dish表为套餐菜品关系表，用于存储套餐和菜品的关联关系。具体表结构如下：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>setmeal_id</td>
<td>bigint</td>
<td>套餐id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>dish_id</td>
<td>bigint</td>
<td>菜品id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>菜品名称</td>
<td>冗余字段</td>
</tr>
<tr>
<td>price</td>
<td>decimal(10,2)</td>
<td>菜品单价</td>
<td>冗余字段</td>
</tr>
<tr>
<td>copies</td>
<td>int</td>
<td>菜品份数</td>
<td></td>
</tr>
</tbody></table>
<h3 id="1-2-代码实现"><a href="#1-2-代码实现" class="headerlink" title="1.2 代码实现"></a>1.2 代码实现</h3><h4 id="1-2-1-DishController"><a href="#1-2-1-DishController" class="headerlink" title="1.2.1 DishController"></a>1.2.1 DishController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;Dish&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span>&#123;</span><br><span class="line">    List&lt;Dish&gt; list = dishService.list(categoryId);</span><br><span class="line">    <span class="keyword">return</span> Result.success(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-DishService"><a href="#1-2-2-DishService" class="headerlink" title="1.2.2 DishService"></a>1.2.2 DishService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Dish&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-DishServiceImpl"><a href="#1-2-3-DishServiceImpl" class="headerlink" title="1.2.3 DishServiceImpl"></a>1.2.3 DishServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Dish&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">    <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> Dish.builder()</span><br><span class="line">        .categoryId(categoryId)</span><br><span class="line">        .status(StatusConstant.ENABLE)</span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">return</span> dishMapper.list(dish);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-4-DishMapper"><a href="#1-2-4-DishMapper" class="headerlink" title="1.2.4 DishMapper"></a>1.2.4 DishMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态条件查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Dish&gt; <span class="title function_">list</span><span class="params">(Dish dish)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-5-DishMapper-xml"><a href="#1-2-5-DishMapper-xml" class="headerlink" title="1.2.5 DishMapper.xml"></a>1.2.5 DishMapper.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Dish&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Dish&quot;</span>&gt;</span></span><br><span class="line">    select * from dish</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null&quot;</span>&gt;</span></span><br><span class="line">            and name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;categoryId != null&quot;</span>&gt;</span></span><br><span class="line">            and category_id = #&#123;categoryId&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span></span><br><span class="line">            and status = #&#123;status&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    order by create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-6-SetmealController"><a href="#1-2-6-SetmealController" class="headerlink" title="1.2.6 SetmealController"></a>1.2.6 SetmealController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 套餐管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/setmeal&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;套餐相关接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealService setmealService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增套餐&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> &#123;</span><br><span class="line">        setmealService.saveWithDish(setmealDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-7-SetmealService"><a href="#1-2-7-SetmealService" class="headerlink" title="1.2.7 SetmealService"></a>1.2.7 SetmealService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetmealService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐，同时需要保存套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveWithDish</span><span class="params">(SetmealDTO setmealDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-8-SetmealServiceImpl"><a href="#1-2-8-SetmealServiceImpl" class="headerlink" title="1.2.8 SetmealServiceImpl"></a>1.2.8 SetmealServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 套餐业务实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SetmealService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐，同时需要保存套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveWithDish</span><span class="params">(SetmealDTO setmealDTO)</span> &#123;</span><br><span class="line">        <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">        BeanUtils.copyProperties(setmealDTO, setmeal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向套餐表插入数据</span></span><br><span class="line">        setmealMapper.insert(setmeal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取生成的套餐id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">setmealId</span> <span class="operator">=</span> setmeal.getId();</span><br><span class="line"></span><br><span class="line">        List&lt;SetmealDish&gt; setmealDishes = setmealDTO.getSetmealDishes();</span><br><span class="line">        setmealDishes.forEach(setmealDish -&gt; &#123;</span><br><span class="line">            setmealDish.setSetmealId(setmealId);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存套餐和菜品的关联关系</span></span><br><span class="line">        setmealDishMapper.insertBatch(setmealDishes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-9-SetmealMapper"><a href="#1-2-9-SetmealMapper" class="headerlink" title="1.2.9 SetmealMapper"></a>1.2.9 SetmealMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmeal</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@AutoFill(OperationType.INSERT)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Setmeal setmeal)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-10-SetmealMapper-xml"><a href="#1-2-10-SetmealMapper-xml" class="headerlink" title="1.2.10 SetmealMapper.xml"></a>1.2.10 SetmealMapper.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Setmeal&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">    insert into setmeal</span><br><span class="line">    (category_id, name, price, status, description, image, create_time, update_time, create_user, update_user)</span><br><span class="line">    values (#&#123;categoryId&#125;, #&#123;name&#125;, #&#123;price&#125;, #&#123;status&#125;, #&#123;description&#125;, #&#123;image&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;,</span><br><span class="line">    #&#123;createUser&#125;, #&#123;updateUser&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-11-SetmealDishMapper"><a href="#1-2-11-SetmealDishMapper" class="headerlink" title="1.2.11 SetmealDishMapper"></a>1.2.11 SetmealDishMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量保存套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDishes</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;SetmealDish&gt; setmealDishes)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-12-SetmealDishMapper-xml"><a href="#1-2-12-SetmealDishMapper-xml" class="headerlink" title="1.2.12 SetmealDishMapper.xml"></a>1.2.12 SetmealDishMapper.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertBatch&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">    insert into setmeal_dish</span><br><span class="line">    (setmeal_id,dish_id,name,price,copies)</span><br><span class="line">    values</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;setmealDishes&quot;</span> <span class="attr">item</span>=<span class="string">&quot;sd&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">        (#&#123;sd.setmealId&#125;,#&#123;sd.dishId&#125;,#&#123;sd.name&#125;,#&#123;sd.price&#125;,#&#123;sd.copies&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-功能测试"><a href="#1-3-功能测试" class="headerlink" title="1.3 功能测试"></a>1.3 功能测试</h3><p>略</p>
<h2 id="2-套餐分页查询"><a href="#2-套餐分页查询" class="headerlink" title="2. 套餐分页查询"></a>2. 套餐分页查询</h2><h3 id="2-1-需求分析和设计"><a href="#2-1-需求分析和设计" class="headerlink" title="2.1 需求分析和设计"></a>2.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018152429246.png" alt="image-20221018152429246"></p>
<p>业务规则：</p>
<ul>
<li>根据页码进行分页展示</li>
<li>每页展示10条数据</li>
<li>可以根据需要，按照套餐名称、分类、售卖状态进行查询</li>
</ul>
<p>接口设计：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018152731141.png" alt="image-20221018152731141"></p>
<h3 id="2-2-代码实现"><a href="#2-2-代码实现" class="headerlink" title="2.2 代码实现"></a>2.2 代码实现</h3><h4 id="2-2-1-SetmealController"><a href="#2-2-1-SetmealController" class="headerlink" title="2.2.1 SetmealController"></a>2.2.1 SetmealController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/page&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;分页查询&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span> &#123;</span><br><span class="line">    <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> setmealService.pageQuery(setmealPageQueryDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-SetmealService"><a href="#2-2-2-SetmealService" class="headerlink" title="2.2.2 SetmealService"></a>2.2.2 SetmealService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">PageResult <span class="title function_">pageQuery</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-SetmealServiceImpl"><a href="#2-2-3-SetmealServiceImpl" class="headerlink" title="2.2.3 SetmealServiceImpl"></a>2.2.3 SetmealServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> setmealPageQueryDTO.getPage();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> setmealPageQueryDTO.getPageSize();</span><br><span class="line"></span><br><span class="line">    PageHelper.startPage(pageNum, pageSize);</span><br><span class="line">    Page&lt;SetmealVO&gt; page = setmealMapper.pageQuery(setmealPageQueryDTO);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), page.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-SetmealMapper"><a href="#2-2-4-SetmealMapper" class="headerlink" title="2.2.4 SetmealMapper"></a>2.2.4 SetmealMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Page&lt;SetmealVO&gt; <span class="title function_">pageQuery</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-SetmealMapper-xml"><a href="#2-2-5-SetmealMapper-xml" class="headerlink" title="2.2.5 SetmealMapper.xml"></a>2.2.5 SetmealMapper.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageQuery&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.sky.vo.SetmealVO&quot;</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">    	s.*,c.name categoryName</span><br><span class="line">    from</span><br><span class="line">    	setmeal s</span><br><span class="line">    left join</span><br><span class="line">    	category c</span><br><span class="line">    on</span><br><span class="line">    	s.category_id = c.id</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null&quot;</span>&gt;</span></span><br><span class="line">            and s.name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span></span><br><span class="line">            and s.status = #&#123;status&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;categoryId != null&quot;</span>&gt;</span></span><br><span class="line">            and s.category_id = #&#123;categoryId&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    order by s.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-功能测试"><a href="#2-3-功能测试" class="headerlink" title="2.3 功能测试"></a>2.3 功能测试</h3><p>略</p>
<h2 id="3-删除套餐"><a href="#3-删除套餐" class="headerlink" title="3. 删除套餐"></a>3. 删除套餐</h2><h3 id="3-1-需求分析和设计"><a href="#3-1-需求分析和设计" class="headerlink" title="3.1 需求分析和设计"></a>3.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018153756531.png" alt="image-20221018153756531"></p>
<p>业务规则：</p>
<ul>
<li>可以一次删除一个套餐，也可以批量删除套餐</li>
<li>起售中的套餐不能删除</li>
</ul>
<p>接口设计：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018154541067.png" alt="image-20221018154541067"></p>
<h3 id="3-2-代码实现"><a href="#3-2-代码实现" class="headerlink" title="3.2 代码实现"></a>3.2 代码实现</h3><h4 id="3-2-1-SetmealController"><a href="#3-2-1-SetmealController" class="headerlink" title="3.2.1 SetmealController"></a>3.2.1 SetmealController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;批量删除套餐&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span>&#123;</span><br><span class="line">    setmealService.deleteBatch(ids);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-SetmealService"><a href="#3-2-2-SetmealService" class="headerlink" title="3.2.2 SetmealService"></a>3.2.2 SetmealService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-SetmealServiceImpl"><a href="#3-2-3-SetmealServiceImpl" class="headerlink" title="3.2.3 SetmealServiceImpl"></a>3.2.3 SetmealServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">    ids.forEach(id -&gt; &#123;</span><br><span class="line">        <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(id);</span><br><span class="line">        <span class="keyword">if</span>(StatusConstant.ENABLE == setmeal.getStatus())&#123;</span><br><span class="line">            <span class="comment">//起售中的套餐不能删除</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.SETMEAL_ON_SALE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ids.forEach(setmealId -&gt; &#123;</span><br><span class="line">        <span class="comment">//删除套餐表中的数据</span></span><br><span class="line">        setmealMapper.deleteById(setmealId);</span><br><span class="line">        <span class="comment">//删除套餐菜品关系表中的数据</span></span><br><span class="line">        setmealDishMapper.deleteBySetmealId(setmealId);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-SetmealMapper"><a href="#3-2-4-SetmealMapper" class="headerlink" title="3.2.4 SetmealMapper"></a>3.2.4 SetmealMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Select(&quot;select * from setmeal where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">Setmeal <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Delete(&quot;delete from setmeal where id = #&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-5-SetmealDishMapper"><a href="#3-2-5-SetmealDishMapper" class="headerlink" title="3.2.5 SetmealDishMapper"></a>3.2.5 SetmealDishMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据套餐id删除套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Delete(&quot;delete from setmeal_dish where setmeal_id = #&#123;setmealId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-功能测试"><a href="#3-3-功能测试" class="headerlink" title="3.3 功能测试"></a>3.3 功能测试</h3><p>略</p>
<h2 id="4-修改套餐"><a href="#4-修改套餐" class="headerlink" title="4. 修改套餐"></a>4. 修改套餐</h2><h3 id="4-1-需求分析和设计"><a href="#4-1-需求分析和设计" class="headerlink" title="4.1 需求分析和设计"></a>4.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018160214225.png" alt="image-20221018160214225"></p>
<p>接口设计（共涉及到5个接口）：</p>
<ul>
<li>根据id查询套餐</li>
<li>根据类型查询分类（已完成）</li>
<li>根据分类id查询菜品（已完成）</li>
<li>图片上传（已完成）</li>
<li>修改套餐</li>
</ul>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018160915177.png" alt="image-20221018160915177"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018160949864.png" alt="image-20221018160949864"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018161046352.png" alt="image-20221018161046352"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018161117780.png" alt="image-20221018161117780"></p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018161139861.png" alt="image-20221018161139861"></p>
<h3 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h3><h4 id="4-2-1-SetmealController"><a href="#4-2-1-SetmealController" class="headerlink" title="4.2.1 SetmealController"></a>4.2.1 SetmealController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐，用于修改页面回显数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据id查询套餐&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;SetmealVO&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">SetmealVO</span> <span class="variable">setmealVO</span> <span class="operator">=</span> setmealService.getByIdWithDish(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(setmealVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改套餐</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;修改套餐&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> &#123;</span><br><span class="line">    setmealService.update(setmealDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-SetmealService"><a href="#4-2-2-SetmealService" class="headerlink" title="4.2.2 SetmealService"></a>4.2.2 SetmealService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐和关联的菜品数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">SetmealVO <span class="title function_">getByIdWithDish</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">update</span><span class="params">(SetmealDTO setmealDTO)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-SetmealServiceImpl"><a href="#4-2-3-SetmealServiceImpl" class="headerlink" title="4.2.3 SetmealServiceImpl"></a>4.2.3 SetmealServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐和套餐菜品关系</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> SetmealVO <span class="title function_">getByIdWithDish</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(id);</span><br><span class="line">    List&lt;SetmealDish&gt; setmealDishes = setmealDishMapper.getBySetmealId(id);</span><br><span class="line"></span><br><span class="line">    <span class="type">SetmealVO</span> <span class="variable">setmealVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SetmealVO</span>();</span><br><span class="line">    BeanUtils.copyProperties(setmeal, setmealVO);</span><br><span class="line">    setmealVO.setSetmealDishes(setmealDishes);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> setmealVO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改套餐</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(SetmealDTO setmealDTO)</span> &#123;</span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">    BeanUtils.copyProperties(setmealDTO, setmeal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、修改套餐表，执行update</span></span><br><span class="line">    setmealMapper.update(setmeal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//套餐id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">setmealId</span> <span class="operator">=</span> setmealDTO.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、删除套餐和菜品的关联关系，操作setmeal_dish表，执行delete</span></span><br><span class="line">    setmealDishMapper.deleteBySetmealId(setmealId);</span><br><span class="line"></span><br><span class="line">    List&lt;SetmealDish&gt; setmealDishes = setmealDTO.getSetmealDishes();</span><br><span class="line">    setmealDishes.forEach(setmealDish -&gt; &#123;</span><br><span class="line">        setmealDish.setSetmealId(setmealId);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//3、重新插入套餐和菜品的关联关系，操作setmeal_dish表，执行insert</span></span><br><span class="line">    setmealDishMapper.insertBatch(setmealDishes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-4-SetmealDishMapper"><a href="#4-2-4-SetmealDishMapper" class="headerlink" title="4.2.4 SetmealDishMapper"></a>4.2.4 SetmealDishMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据套餐id查询套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select(&quot;select * from setmeal_dish where setmeal_id = #&#123;setmealId&#125;&quot;)</span></span><br><span class="line">   List&lt;SetmealDish&gt; <span class="title function_">getBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></table></figure>



<h3 id="4-3-功能测试"><a href="#4-3-功能测试" class="headerlink" title="4.3 功能测试"></a>4.3 功能测试</h3><p>略</p>
<h2 id="5-起售停售套餐"><a href="#5-起售停售套餐" class="headerlink" title="5. 起售停售套餐"></a>5. 起售停售套餐</h2><h3 id="5-1-需求分析和设计"><a href="#5-1-需求分析和设计" class="headerlink" title="5.1 需求分析和设计"></a>5.1 需求分析和设计</h3><p>产品原型：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018163720881.png" alt="image-20221018163720881"></p>
<p>业务规则：</p>
<ul>
<li>可以对状态为起售的套餐进行停售操作，可以对状态为停售的套餐进行起售操作</li>
<li>起售的套餐可以展示在用户端，停售的套餐不能展示在用户端</li>
<li>起售套餐时，如果套餐内包含停售的菜品，则不能起售</li>
</ul>
<p>接口设计：</p>
<p><img src="/2024/02/24/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day04-%E5%A5%97%E9%A4%90%E7%AE%A1%E7%90%86/image-20221018165055208.png" alt="image-20221018165055208"></p>
<h3 id="5-2-代码实现"><a href="#5-2-代码实现" class="headerlink" title="5.2 代码实现"></a>5.2 代码实现</h3><h4 id="5-2-1-SetmealController"><a href="#5-2-1-SetmealController" class="headerlink" title="5.2.1 SetmealController"></a>5.2.1 SetmealController</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 套餐起售停售</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;套餐起售停售&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status, Long id)</span> &#123;</span><br><span class="line">    setmealService.startOrStop(status, id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-SetmealService"><a href="#5-2-2-SetmealService" class="headerlink" title="5.2.2 SetmealService"></a>5.2.2 SetmealService</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 套餐起售、停售</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-3-SetmealServiceImpl"><a href="#5-2-3-SetmealServiceImpl" class="headerlink" title="5.2.3 SetmealServiceImpl"></a>5.2.3 SetmealServiceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 套餐起售、停售</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//起售套餐时，判断套餐内是否有停售菜品，有停售菜品提示&quot;套餐内包含未启售菜品，无法启售&quot;</span></span><br><span class="line">    <span class="keyword">if</span>(status == StatusConstant.ENABLE)&#123;</span><br><span class="line">        <span class="comment">//select a.* from dish a left join setmeal_dish b on a.id = b.dish_id where b.setmeal_id = ?</span></span><br><span class="line">        List&lt;Dish&gt; dishList = dishMapper.getBySetmealId(id);</span><br><span class="line">        <span class="keyword">if</span>(dishList != <span class="literal">null</span> &amp;&amp; dishList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            dishList.forEach(dish -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span>(StatusConstant.DISABLE == dish.getStatus())&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SetmealEnableFailedException</span>(MessageConstant.SETMEAL_ENABLE_FAILED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> Setmeal.builder()</span><br><span class="line">        .id(id)</span><br><span class="line">        .status(status)</span><br><span class="line">        .build();</span><br><span class="line">    setmealMapper.update(setmeal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-4-DishMapper"><a href="#5-2-4-DishMapper" class="headerlink" title="5.2.4 DishMapper"></a>5.2.4 DishMapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据套餐id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Select(&quot;select a.* from dish a left join setmeal_dish b on a.id = b.dish_id where b.setmeal_id = #&#123;setmealId&#125;&quot;)</span></span><br><span class="line">List&lt;Dish&gt; <span class="title function_">getBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-功能测试"><a href="#5-3-功能测试" class="headerlink" title="5.3 功能测试"></a>5.3 功能测试</h3><p>略</p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day03-菜品管理</title>
    <url>/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h1 id="问题分析和实现思路"><a href="#问题分析和实现思路" class="headerlink" title="问题分析和实现思路"></a>问题分析和实现思路</h1><p>具体要求：新建菜品、修改菜品、删除菜品、启用禁用菜品，菜品分页查询</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221223949538.png" alt="image-20240221223949538"></p>
<h1 id="公共字段自动填充"><a href="#公共字段自动填充" class="headerlink" title="公共字段自动填充"></a>公共字段自动填充</h1><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>业务表中的公共字段：</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221224200823.png" alt="image-20240221224200823"></p>
<p>前面课程开发的员工管理模块和直接导入的分类管理模块，对应两张表，一个是员工表，一个是分类表，两个表中都有这四个字段。菜品表，套餐表这些业务表中都有这几个公共字段，当我们向这些表中插入数据时，需要为这些公共字段赋值。即很有可能会多次看到这种代码。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221224523173.png" alt="image-20240221224523173">\</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221224605012.png" alt="image-20240221224605012"></p>
<p><font color="red">在程序中存在冗余的代码，如果后期表结构发生了变化，这部分的代码都要修改。现在问题是：业务表中存在公共字段，导致Java代码中存在冗余的代码，后期如果发生变更，代码维护复杂。</font></p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><ol>
<li><p>明确公共字段在什么操作类型下会被修改。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221224853616.png" alt="image-20240221224853616"></p>
</li>
<li><p>对于公共字段，该如何处理呢？</p>
<p>我们可以通过切面的方式处理公共字段。通过切面拦截Mapper层，统一为其赋值。但是Mapper层还有其他方法是不需要切面拦截的，例如Select。通过定义注解，表示当前方法需要被拦截，需要为这几个公共字段赋值，如果不加，则不需要处理。</p>
</li>
</ol>
<p><strong>解决办法</strong></p>
<ul>
<li>自定义注解AutoFill，用于标识需要进行公共字段自动填充的方法</li>
<li>自定义切面类AutoFillAspect，统一拦截加入了AutoFill注解的方法，通过反射为公共字段赋值</li>
<li>在Mapper的方法上加上AutoFill注解</li>
</ul>
<p>技术点：枚举、注解、AOP、反射</p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><ol>
<li><p>创建自定义注解AutoFill</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义注解，用于标识某个方法需要进行功能字段自动填充处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoFill &#123;</span><br><span class="line">    <span class="comment">//数据库操作类型</span></span><br><span class="line">    OperationType <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221231935143.png" alt="image-20240221231935143"></p>
</li>
<li><p>实现自定义切面类（加上@Aspect注解确定他是切面类，设置@PointCut，指定代拦截的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义切面，实现公共字段自动填充处理逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//log</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//切面类</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//交由IOC容器的Bean对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoFillAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定切入点（对哪些类的哪些方法指定）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)&quot;)</span>  <span class="comment">//拦截mapper包下所有类和接口的所有方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFillPointCut</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知，在通知中进行公共字段的赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;autoFillPointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFill</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始进行公共字段的自动填充...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给待测试的方法insert和update分别加上@AutoFill字段，使其成为AOP的拦截方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.image.RescaleOp;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入员工数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into employee (name, username, password, phone, sex, id_number, create_time, update_time, create_user, update_user) &quot; +</span></span><br><span class="line"><span class="meta">        &quot;values(#&#123;name&#125;,#&#123;username&#125;,#&#123;password&#125;,#&#123;phone&#125;,#&#123;sex&#125;,#&#123;idNumber&#125;,#&#123;createTime&#125;,#&#123;updateTime&#125;,#&#123;createUser&#125;,#&#123;updateUser&#125;)&quot;)</span></span><br><span class="line">    <span class="meta">@AutoFill(value = OperationType.INSERT)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Employee employee)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键动态修改属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AutoFill(value = OperationType.UPDATE)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Employee employee)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>前后端联调测试</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240221233716527.png" alt="image-20240221233716527"></p>
</li>
</ol>
<p>autoFill前置通知方法执行时，拦截了@PointCut设置的符合条件的mapper方法（加了@AutoFill注解）。</p>
<p>在切面类中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;autoFillPointCut()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFill</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;开始进行公共字段的自动填充...&quot;</span>);</span><br><span class="line">    <span class="comment">//获取当前被拦截的方法上的数据库操作类型（这个数据库操作类型加载@AutoFill注解的value属性上）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>的具体编写思路如下：</p>
<ol>
<li>获取当前被拦截的方法的数据库的操作类型</li>
<li>获取到方法的参数（实体类，可以是员工实体，分类实体，套餐实体，菜品实体）</li>
<li>准备待赋值的数据，为实体对象赋值（有createTime，updateTime，createUser，updateUser）</li>
<li>根据当前不同的操作类型，为对应的属性赋值（通过反射）</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.AutoFillConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义切面，实现公共字段自动填充处理逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//log</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//切面类</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//交由IOC容器的Bean对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoFillAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定切入点（对哪些类的哪些方法指定）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)&quot;)</span>  <span class="comment">//拦截mapper包下所有类和接口的所有方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFillPointCut</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知，在通知中进行公共字段的赋值，这个切面的执行会直接修改通过这些mapper方法传递的参数实体。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;autoFillPointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFill</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始进行公共字段的自动填充...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*        Signature signature = joinPoint.getSignature(); //获取目标方法签名</span></span><br><span class="line"><span class="comment">        String name = joinPoint.getSignature().getName();</span></span><br><span class="line"><span class="comment">        Object[] args = joinPoint.getArgs();</span></span><br><span class="line"><span class="comment">        System.out.println(signature);</span></span><br><span class="line"><span class="comment">        System.out.println(name);</span></span><br><span class="line"><span class="comment">        System.out.println(args);*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        1. 获取当前被拦截的方法的数据库的操作类型（上面是反射包的相关代码，可读性相对差一些）</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature(); <span class="comment">//方法签名对象</span></span><br><span class="line"><span class="comment">//        void com.sky.mapper.EmployeeMapper.update(Employee)</span></span><br><span class="line"><span class="comment">//        System.out.println(signature);</span></span><br><span class="line">        <span class="type">AutoFill</span> <span class="variable">autoFill</span> <span class="operator">=</span> signature.getMethod().getAnnotation(AutoFill.class);  <span class="comment">//获得方法上的注解对象</span></span><br><span class="line"><span class="comment">//        System.out.println(autoFill);</span></span><br><span class="line"><span class="comment">//        @com.sky.annotation.AutoFill(UPDATE)</span></span><br><span class="line">        <span class="type">OperationType</span> <span class="variable">operationType</span> <span class="operator">=</span> autoFill.value(); <span class="comment">//获得数据库操作类型</span></span><br><span class="line"><span class="comment">//        System.out.println(operationType);</span></span><br><span class="line"><span class="comment">//        UPDATE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        2. 获取到方法的参数（实体类，可以是员工实体，分类实体，套餐实体，菜品实体），确保实体类对象放在第一个参数</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line"><span class="comment">//        System.out.println(args);</span></span><br><span class="line"><span class="comment">//        [Ljava.lang.Object;@6f17c9e0</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;\n\n&quot;);</span></span><br><span class="line">        <span class="keyword">if</span>(args == <span class="literal">null</span> &amp;&amp; args.length == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">entity</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(args[0]);</span></span><br><span class="line"><span class="comment">//        Employee(id=8, username=wangwu, name=王五, password=null, phone=15988853410, sex=1, idNumber=112233445566778989, status=null, createTime=null, updateTime=2024-02-22T12:08:43.927707700, createUser=null, updateUser=1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        3. 准备待赋值的数据，为实体对象赋值（有createTime，updateTime，createUser，updateUser）</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        4. 根据当前不同的操作类型，为对应的属性赋值（通过反射）</span></span><br><span class="line">        <span class="keyword">if</span>(operationType == OperationType.INSERT)&#123;</span><br><span class="line">            <span class="comment">//为4个公共字段赋值</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//直接用方法名去取method，是硬编码，如果获取的类方法发生了变化，整个代码就要重构</span></span><br><span class="line">                <span class="comment">//使用类常量命名，防止手敲出错</span></span><br><span class="line">                <span class="type">Method</span> <span class="variable">setCreateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setCreateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_USER, Long.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//通过反射为对象属性赋值</span></span><br><span class="line">                setCreateTime.invoke(entity,now);</span><br><span class="line">                setUpdateTime.invoke(entity,now);</span><br><span class="line">                setCreateUser.invoke(entity,currentId);</span><br><span class="line">                setUpdateUser.invoke(entity,currentId);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(operationType == OperationType.UPDATE)&#123;</span><br><span class="line">            <span class="comment">//为2个公共字段赋值</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//通过反射为对象属性赋值</span></span><br><span class="line">                setUpdateTime.invoke(entity,now);</span><br><span class="line">                setUpdateUser.invoke(entity,currentId);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将分类模块下的更新和插入方法加上@AutoFill注解</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222124141927.png" alt="image-20240222124141927"></p>
<p>将员工模块下的更新和插入方法加上@AutoFill注解</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222124243680.png" alt="image-20240222124243680"></p>
<p>修改EmpServiceImpl和CategoryServiceImpl下的实现方法，注释掉对应的代码</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222124454312.png" alt="image-20240222124454312"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222124620554.png" alt="image-20240222124620554"></p>
<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p><strong>前后端联调测试</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222125401691.png" alt="image-20240222125401691"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222125445984.png" alt="image-20240222125445984"></p>
<h1 id="新增菜品"><a href="#新增菜品" class="headerlink" title="新增菜品"></a>新增菜品</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型页面</strong></p>
<p>要新增一个菜品，需要录入菜品名称、菜品分类（从分类表中查询，可以调用分类管理的接口，获取对应的数据，最终展示在下拉框中）、菜品价格、口味做法配置、菜品图片、菜品描述）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222125801979.png" alt="image-20240222125801979"></p>
<p>业务规则：</p>
<ul>
<li>菜品名称必须是唯一的</li>
<li>菜品必须属于某个分类下 ，不能单独存在</li>
<li>新增菜品时可以根据情况选择菜品的品味</li>
<li>每个菜品必须对应一张图片</li>
</ul>
<p><strong>接口设计</strong></p>
<ul>
<li><p>根据类型查询分类（已完成）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222130510250.png" alt="image-20240222130510250"></p>
</li>
<li><p>文件上传</p>
<p>请求方式是POST方式，请求路径是&#x2F;admin&#x2F;common&#x2F;upload，因为是文件上传，要在请求头中设置键值对，Content-Type:multipart&#x2F;form-data。返回数据要求返回文件上传的路径url（实际上是阿里云绝对的访问地址），为什么要返回的是url，因为希望获取url，在页面回显时显示该图片。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222131025056.png" alt="image-20240222131025056"></p>
</li>
<li><p>新增菜品</p>
<p>请求方式是POST方式，请求地址是&#x2F;admin&#x2F;dish，以JSON格式提交数据。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222131851174.png" alt="image-20240222131851174"></p>
<p><strong>数据库设计（dish菜品表和dish_flavor口味表，dish菜品表包含分类id）</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222132532058.png" alt="image-20240222132532058"></p>
</li>
</ul>
<h2 id="代码开发-1"><a href="#代码开发-1" class="headerlink" title="代码开发"></a>代码开发</h2><p>分析下来，新增菜品要涉及到三个接口，第一个接口是查询分类接口，第二个接口，文件上传接口，新增菜品接口。</p>
<p><strong>开发文件上传接口：</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222133731966.png" alt="image-20240222133731966"></p>
<p><strong>创建CommonController层代码</strong>(注意接收的参数是二进制的multipart&#x2F;form-data，请求体中的参数是file)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/common&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;通用接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;文件上传&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;文件上传：&#123;&#125;&quot;</span>,file);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222152625240.png" alt="image-20240222152625240"></p>
<p><strong>application-dev.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">sky_take_out</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">alioss:</span></span><br><span class="line">    <span class="attr">endpoint :</span> <span class="string">https://oss-cn-hangzhou.aliyuncs.com</span></span><br><span class="line">    <span class="attr">access-key-id :</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">access-key-secret :</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">bucket-name :</span> <span class="string">waterdance-web-tlias</span></span><br></pre></td></tr></table></figure>

<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-circular-references:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">$&#123;sky.datasource.driver-class-name&#125;</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;sky.datasource.host&#125;:$&#123;sky.datasource.port&#125;/$&#123;sky.datasource.database&#125;?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;sky.datasource.username&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;sky.datasource.password&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment">#mapper配置文件</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.sky.entity</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#开启驼峰命名</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com:</span></span><br><span class="line">      <span class="attr">sky:</span></span><br><span class="line">        <span class="attr">mapper:</span> <span class="string">debug</span></span><br><span class="line">        <span class="attr">service:</span> <span class="string">info</span></span><br><span class="line">        <span class="attr">controller:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="comment"># 设置jwt签名加密时使用的秘钥</span></span><br><span class="line">    <span class="attr">admin-secret-key:</span> <span class="string">itcast</span></span><br><span class="line">    <span class="comment"># 设置jwt过期时间</span></span><br><span class="line">    <span class="attr">admin-ttl:</span>  <span class="number">864000000</span></span><br><span class="line">    <span class="comment"># 设置前端传递过来的令牌名称</span></span><br><span class="line">    <span class="attr">admin-token-name:</span> <span class="string">token</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">alioss:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">$&#123;sky.alioss.endpoint&#125;</span></span><br><span class="line">    <span class="attr">access-key-id:</span> <span class="string">$&#123;sky.alioss.access-key-id&#125;</span></span><br><span class="line">    <span class="attr">access-key-secret:</span> <span class="string">$&#123;sky.alioss.access-key-secret&#125;</span></span><br><span class="line">    <span class="attr">bucket-name:</span> <span class="string">$&#123;sky.alioss.bucket-name&#125;</span></span><br></pre></td></tr></table></figure>

<p><font color="red">为什么在application.yml中定义aliyun参数时可以不用硬编码，因为我们定义了属性配置类，在com.sky.properties下。且我们特意将具体的配置写在了application-dev.yml文件中，是因为开发环境下硬编码写入的OSS配置可能不是生产环境的配置文件。</font></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222154924046.png" alt="image-20240222154924046"></p>
<p><font color="red">application.yml文件中指定了具体的配置文件，这里设置了spring.profiles.active的属性为dev，即可以导入application-dev.yml中的配置而不用硬编码。</font></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240222160207606.png" alt="image-20240222160207606"></p>
<p>查看AliOssUtil.java文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.ClientException;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSS;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClientBuilder;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSException;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliOssUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] bytes, String objectName)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建PutObject请求。</span></span><br><span class="line">            ossClient.putObject(bucketName, objectName, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OSSException oe) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an OSSException, which means your request made it to OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;but was rejected with an error response for some reason.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message:&quot;</span> + oe.getErrorMessage());</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Code:&quot;</span> + oe.getErrorCode());</span><br><span class="line">            System.out.println(<span class="string">&quot;Request ID:&quot;</span> + oe.getRequestId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Host ID:&quot;</span> + oe.getHostId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException ce) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an ClientException, which means the client encountered &quot;</span></span><br><span class="line">                    + <span class="string">&quot;a serious internal problem while trying to communicate with OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;such as not being able to access the network.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message:&quot;</span> + ce.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ossClient != <span class="literal">null</span>) &#123;</span><br><span class="line">                ossClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//文件访问路径规则 https://BucketName.Endpoint/ObjectName</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;https://&quot;</span>);</span><br><span class="line">        stringBuilder</span><br><span class="line">                .append(bucketName)</span><br><span class="line">                .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">                .append(endpoint)</span><br><span class="line">                .append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                .append(objectName);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;文件上传到:&#123;&#125;&quot;</span>, stringBuilder.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><font color="red">AliOssUtil类还没有实体化，他的属性值是空的，我们要在配置类中声明该类的对象，加上@Bean注解，将其加入到IOC容器中。</font></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.properties.AliOssProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.AliOssUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，用于创建AliOssUtil对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> AliOssUtil <span class="title function_">aliOssUtil</span><span class="params">(AliOssProperties aliOssProperties)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始创建阿里云文件上传工具类对象：&#123;&#125;&quot;</span>,aliOssProperties);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliOssUtil</span>(aliOssProperties.getEndpoint(),</span><br><span class="line">                                aliOssProperties.getAccessKeyId(),</span><br><span class="line">                                aliOssProperties.getAccessKeySecret(),</span><br><span class="line">                                aliOssProperties.getBucketName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现上传图片至阿里云服务器的功能</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.AliOssUtil;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/common&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;通用接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AliOssUtil aliOssUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;文件上传&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;文件上传：&#123;&#125;&quot;</span>,file);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//原始文件名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="comment">//截取原始文件名的后缀 dfdfdf.png</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="comment">//构造新文件名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> UUID.randomUUID().toString() + extension;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//为了防止文件重名导致文件覆盖，使用UUID重命名，</span></span><br><span class="line">            <span class="comment">//文件的请求路径</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> aliOssUtil.upload(file.getBytes(), objectName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result.success(filePath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;文件上传失败：&#123;&#125;&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.error(MessageConstant.UPLOAD_FAILED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>前后端联调</strong></p>
<p>前端请求了我们返回的路径，从而展示了图片的信息。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223174439657.png" alt="image-20240223174439657"></p>
<p><strong>新增菜品接口</strong></p>
<p><strong>DishController层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;菜品相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增菜品接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;新增菜品：&#123;&#125;&quot;</span>,dishDTO);</span><br><span class="line">        dishService.saveWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写DishServiceImpl层代码</strong></p>
<p>注意，这边加了@Transactional注解，表示将方法作为事务执行，要么全部成功，要么一起失败。</p>
<ol>
<li>dish表插入插入菜品</li>
<li>dishFlavor表插入口味</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishFlavorMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜品和对应的口味</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span> <span class="comment">//要么全成功，要么全失败</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveWithFlavor</span><span class="params">(DishDTO dishDTO)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建实体类Dish对象（属性命名必须保持一致才能拷贝）</span></span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">        BeanUtils.copyProperties(dishDTO,dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向菜品表插入1条数据</span></span><br><span class="line">        dishMapper.insert(dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取insert语句生成的主键值</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">dishId</span> <span class="operator">=</span> dish.getId();</span><br><span class="line"></span><br><span class="line">        List&lt;DishFlavor&gt; flavors = dishDTO.getFlavors();</span><br><span class="line">        <span class="keyword">if</span>(flavors != <span class="literal">null</span> &amp;&amp; flavors.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//为口味表的元素设置dishId。</span></span><br><span class="line">            flavors.forEach(dishFlavor -&gt; &#123;</span><br><span class="line">                dishFlavor.setDishId(dishId);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//向口味表插入n条数据</span></span><br><span class="line">            <span class="comment">//sql支持批量插入，直接把集合对象传入</span></span><br><span class="line">            dishFlavorMapper.insertBatch(flavors);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DishMapper.xml</strong>（插入语句要返回对应的id主键，所以设置了useGeneratedKeys&#x3D;”true” keyProperty&#x3D;”id”，再详细点说，<code>useGeneratedKeys</code>这个属性在MyBatis的<code>&lt;insert&gt;</code>标签中使用，它的作用是指示MyBatis在执行插入操作后使用数据库自动生成的主键值。这个功能特别适合数据库表中有自增长主键的情况。当你设置<code>useGeneratedKeys=&quot;true&quot;</code>时，MyBatis会自动寻找数据库生成的主键值，并将其赋值给你在<code>keyProperty</code>属性中指定的Java对象的属性。）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.DishMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span> # 获得insert语句插入所生成的主键值</span><br><span class="line">        insert into dish (name, category_id, price, image, description, create_time, update_time, create_user,</span><br><span class="line">                          update_user, status)</span><br><span class="line">        VALUES (#&#123;name&#125;, #&#123;categoryId&#125;, #&#123;price&#125;, #&#123;image&#125;, #&#123;description&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;createUser&#125;,</span><br><span class="line">                #&#123;updateUser&#125;, #&#123;status&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>DishFlavorMapper.xml</strong>（将集合直接foreach遍历插入到dishflavor表）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sky.mapper.DishFlavorMapper&quot;</span>&gt;</span><br><span class="line">    &lt;insert id=<span class="string">&quot;insertBatch&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">dish_flavor</span> <span class="params">(dish_id, name, value)</span></span><br><span class="line">        values</span><br><span class="line">        &lt;foreach collection=<span class="string">&quot;flavors&quot;</span> item=<span class="string">&quot;df&quot;</span> separator=<span class="string">&quot;,&quot;</span>&gt;</span><br><span class="line">            (#&#123;df.dishId&#125;,#&#123;df.name&#125;,#&#123;df.value&#125;)</span><br><span class="line">        &lt;/foreach&gt;</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>





<h2 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223192947602.png" alt="image-20240223192947602"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223193053795.png" alt="image-20240223193053795"></p>
<h1 id="菜品分页查询"><a href="#菜品分页查询" class="headerlink" title="菜品分页查询"></a>菜品分页查询</h1><h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p>这里有菜品名称、图片、分类、售价、状态等等。因为是分页查询，所以在右下角需要展示分页条。分页条展示总计记录数和页码。搜索栏中有菜品的名称、菜品的分类、售卖状态等等。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223215642367.png" alt="image-20240223215642367"></p>
<p>业务规则：</p>
<ul>
<li>根据页码展示菜品信息</li>
<li>每页展示10条数据</li>
<li>分页查询时可以根据需要输入菜品名称、菜品分类、菜品状态进行查询</li>
</ul>
<p><strong>接口设计</strong></p>
<p>因为分页查询是查询类的操作，所以它的请求方式是GET，请求路径还是&#x2F;admin&#x2F;dish&#x2F;page，注意，在返回数据中，categoryName字段不在dish表中</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223221213389.png" alt="image-20240223221213389"></p>
<h2 id="代码开发-2"><a href="#代码开发-2" class="headerlink" title="代码开发"></a>代码开发</h2><p>根据菜品分页查询接口定义设计对应的DTO：（DTO接收前端传来的参数）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223221625402.png" alt="image-20240223221625402"></p>
<p>根据菜品分页查询接口定义设计对应的VO：（VO是返回前端的数据）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223222003240.png" alt="image-20240223222003240"></p>
<p><strong>controller层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;菜品相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/page&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;菜品分页查询接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;菜品分页查询:&#123;&#125;&quot;</span>,dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> dishService.pageQuery(dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishFlavorMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜品分页查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span> &#123;</span><br><span class="line">        PageHelper.startPage(dishPageQueryDTO.getPage(), dishPageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">        Page&lt;DishVO&gt; page = dishMapper.pageQuery(dishPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(),page.getResult());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入菜品数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AutoFill(value= OperationType.INSERT)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Dish dish)</span>;</span><br><span class="line"></span><br><span class="line">    Page&lt;DishVO&gt; <span class="title function_">pageQuery</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>mapper.xml编写</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.DishMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageQuery&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.sky.vo.DishVO&quot;</span>&gt;</span></span><br><span class="line">        select d.*, c.name as categoryName from dish d left join category c on d.category_id = c.id</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name!=null&quot;</span>&gt;</span> d.name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;),<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status!=null&quot;</span>&gt;</span> d.status = #&#123;status&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;categoryId != null&quot;</span>&gt;</span> d.category_id = #&#123;categoryId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by d.create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-2"><a href="#功能测试-2" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240223231956652.png" alt="image-20240223231956652"></p>
<h1 id="删除菜品"><a href="#删除菜品" class="headerlink" title="删除菜品"></a>删除菜品</h1><h2 id="需求分析和设计-2"><a href="#需求分析和设计-2" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p>在操作列有删除按钮，点击删除可以删除单个菜品，勾选多个菜品点击批量删除可以删除多个菜品。在逻辑实现功能上，如果菜品正在启售，是不能删除菜品的。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224131914657.png" alt="image-20240224131914657"></p>
<p>业务规则：</p>
<ul>
<li>可以一次删除一个菜品，也可以批量删除菜品</li>
<li>起售中的菜品不能删除</li>
<li>被套餐关联的菜品不能删除</li>
<li>删除菜品后，关联的口味数据也需要删除掉</li>
</ul>
<p><strong>接口分析</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224132421431.png" alt="image-20240224132421431"></p>
<p><strong>数据库设计</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224132745888.png" alt="image-20240224132745888"></p>
<ul>
<li>dish表</li>
<li>dish_flavor表（菜品的口味表）</li>
<li>setmeal_dish表（套餐和菜品的关联表）</li>
</ul>
<h2 id="代码开发-3"><a href="#代码开发-3" class="headerlink" title="代码开发"></a>代码开发</h2><p>如果传入的参数是string类型逗号分隔的数组，请求方式是query。接收该参数的方法有以下几种。网址：<a href="https://localhost:8080/admin/dish?ids=1,2,3">https://localhost:8080/admin/dish?ids=1,2,3</a></p>
<ol>
<li>String ids</li>
<li><font color="red">@RequestParam List&lt;Long&gt; ids（加注解@RequestParam之后，MVC才会动态解析自动串并将其封装到ids中)</font></li>
</ol>
<p><strong>controller层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;菜品相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜品批量删除接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;菜品批量删除接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;菜品批量删除：&#123;&#125;&quot;</span>, ids);</span><br><span class="line">        dishService.deleteBatch(ids);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.DeletionNotAllowedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishFlavorMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealDishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜品批量删除功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        <span class="comment">//判断当前菜品是否能够删除--是否存在起售中的菜品？？</span></span><br><span class="line">        <span class="keyword">for</span> (Long id : ids) &#123;</span><br><span class="line">            <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(id);</span><br><span class="line">            <span class="keyword">if</span>(dish.getStatus() == StatusConstant.ENABLE)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.DISH_ON_SALE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前菜品是否能够删除--是否被套餐关联了？？</span></span><br><span class="line">        List&lt;Long&gt; setmealIds = setmealDishMapper.getSetmealIdsByDishIds(ids);</span><br><span class="line">        <span class="keyword">if</span>(setmealIds != <span class="literal">null</span> &amp;&amp; setmealIds.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//当前菜品被套餐关联了，不能删除</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.DISH_BE_RELATED_BY_SETMEAL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除菜品表中的菜品数据</span></span><br><span class="line">        <span class="keyword">for</span> (Long id : ids) &#123;</span><br><span class="line">            dishMapper.deleteById(id);</span><br><span class="line">            <span class="comment">//删除菜品关联的口味数据</span></span><br><span class="line">            dishFlavorMapper.deleteByDishId(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主删除菜品数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Delete(&quot;delete from dish where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetmealDishMapper</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据菜品ID查询对应的套餐id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//select setmeal_id from setmeal_dish where dishId in dishIds;</span></span><br><span class="line">    List&lt;Long&gt; <span class="title function_">getSetmealIdsByDishIds</span><span class="params">(List&lt;Long&gt; dishIds)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.SetmealDishMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getSetmealIdsByDishIds&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">        select setmeal_id from setmeal_dish where setmeal_id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;dishIds&quot;</span> <span class="attr">item</span>=<span class="string">&quot;dishId&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">            #&#123;dishId&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-3"><a href="#功能测试-3" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224141308731.png" alt="image-20240224141308731"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224141320685.png" alt="image-20240224141320685"></p>
<p><strong>改进空间</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.DeletionNotAllowedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishFlavorMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealDishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 菜品批量删除功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        <span class="comment">//判断当前菜品是否能够删除--是否存在起售中的菜品？？</span></span><br><span class="line">        <span class="keyword">for</span> (Long id : ids) &#123;</span><br><span class="line">            <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(id);</span><br><span class="line">            <span class="keyword">if</span>(dish.getStatus() == StatusConstant.ENABLE)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.DISH_ON_SALE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前菜品是否能够删除--是否被套餐关联了？？</span></span><br><span class="line">        List&lt;Long&gt; setmealIds = setmealDishMapper.getSetmealIdsByDishIds(ids);</span><br><span class="line">        <span class="keyword">if</span>(setmealIds != <span class="literal">null</span> &amp;&amp; setmealIds.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//当前菜品被套餐关联了，不能删除</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.DISH_BE_RELATED_BY_SETMEAL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除菜品表中的菜品数据</span></span><br><span class="line">        <span class="keyword">for</span> (Long id : ids) &#123;</span><br><span class="line">            dishMapper.deleteById(id);</span><br><span class="line">            <span class="comment">//删除菜品关联的口味数据</span></span><br><span class="line">            dishFlavorMapper.deleteByDishId(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的删除菜品表中菜品要求对数据库频繁操作。能够只发一条sql，就删除菜品口味表中所有相关数据。</p>
<p>创建deleteByIds和deleteByDishIds，传入ids参数，直接在sql语句中删除对应的数据</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.DishFlavorMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByDishIds&quot;</span>&gt;</span></span><br><span class="line">        delete from dish_flavor where dish_id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span>&gt;</span></span><br><span class="line">            #&#123;id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.DishMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByIds&quot;</span> &gt;</span></span><br><span class="line">        delete from dish where id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">            #&#123;id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="修改菜品"><a href="#修改菜品" class="headerlink" title="修改菜品"></a>修改菜品</h1><h2 id="需求分析和设计-3"><a href="#需求分析和设计-3" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224151756233.png" alt="image-20240224151756233"></p>
<p><strong>接口设计</strong></p>
<ul>
<li>根据id查询菜品</li>
<li>根据类型查询分类（已经实现）</li>
<li>文件上传（已实现）</li>
<li>修改菜品</li>
</ul>
<p><strong>根据id查询菜品</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224152053594.png" alt="image-20240224152053594"></p>
<p><strong>修改菜品</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224152241187.png" alt="image-20240224152241187"></p>
<h2 id="代码开发-4"><a href="#代码开发-4" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>根据id查询菜品</strong></p>
<p><strong>controller层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;菜品相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据id查询菜品&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;DishVO&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;根据id查询菜品：&#123;&#125;&quot;</span>,id);</span><br><span class="line">        <span class="type">DishVO</span> <span class="variable">dishVO</span> <span class="operator">=</span> dishService.getByIdWithFlavor(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(dishVO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.DeletionNotAllowedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishFlavorMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealDishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询菜品和对应的口味数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DishVO <span class="title function_">getByIdWithFlavor</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 查询id查询菜品相关信息</span></span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 查询菜品查询口味数据</span></span><br><span class="line">        List&lt;DishFlavor&gt; dishFlavors =  dishFlavorMapper.getByDishId(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 将查询到的数据封装为VO</span></span><br><span class="line">        <span class="type">DishVO</span> <span class="variable">dishVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DishVO</span>();</span><br><span class="line">        BeanUtils.copyProperties(dish,dishVO);</span><br><span class="line">        dishVO.setFlavors(dishFlavors);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dishVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishFlavorMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据菜品id查询对应的口味数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from dish_flavor where dish_id = #&#123;dishId&#125;&quot;)</span></span><br><span class="line">    List&lt;DishFlavor&gt; <span class="title function_">getByDishId</span><span class="params">(Long dishId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>修改菜品</strong></p>
<p><strong>编写controller层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;菜品相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;修改菜品接口&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;修改菜品:&#123;&#125;&quot;</span>,dishDTO);</span><br><span class="line">        dishService.updateWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.DeletionNotAllowedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishFlavorMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealDishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改菜品和对应的口味数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateWithFlavor</span><span class="params">(DishDTO dishDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//修改菜品表基本信息</span></span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">        BeanUtils.copyProperties(dishDTO,dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除原有的口味数据</span></span><br><span class="line">        dishMapper.update(dish);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除原有口味数据</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> dishDTO.getId();</span><br><span class="line">        dishFlavorMapper.deleteByDishId(id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//重新插入口味数据</span></span><br><span class="line">        List&lt;DishFlavor&gt; flavors = dishDTO.getFlavors();</span><br><span class="line">        <span class="keyword">if</span> (flavors != <span class="literal">null</span> &amp;&amp; flavors.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//为口味表的元素设置dishId。</span></span><br><span class="line">            flavors.forEach(dishFlavor -&gt; &#123;</span><br><span class="line">                dishFlavor.setDishId(id);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//向口味表插入n条数据</span></span><br><span class="line">            <span class="comment">//sql支持批量插入，直接把集合对象传入</span></span><br><span class="line">            dishFlavorMapper.insertBatch(flavors);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据ID动态修改菜品数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AutoFill(value = OperationType.UPDATE)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Dish dish)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.DishMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.sky.entity.Dish&quot;</span>&gt;</span></span><br><span class="line">        update dish</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;name != null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;categoryId != null&quot;</span>&gt;</span>category_id=#&#123;categoryId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;price != null&quot;</span>&gt;</span>price=#&#123;price&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;image != null&quot;</span>&gt;</span>image=#&#123;image&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;description != null&quot;</span>&gt;</span>description=#&#123;description&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;status != null&quot;</span>&gt;</span>status=#&#123;status&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;name != null&quot;</span>&gt;</span>name=#&#123;name&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateTime != null&quot;</span>&gt;</span> update_time = #&#123;updateTime&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateUser != null&quot;</span>&gt;</span> update_user = #&#123;updateUser&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-4"><a href="#功能测试-4" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224155659378.png" alt="image-20240224155659378"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day03-%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/image-20240224155719158.png" alt="image-20240224155719158"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day02-员工管理、分类管理</title>
    <url>/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h1 id="员工管理、分类管理"><a href="#员工管理、分类管理" class="headerlink" title="员工管理、分类管理"></a>员工管理、分类管理</h1><p>本节主要完成商家管理部分的员工管理和分类管理。</p>
<p><strong>员工管理模块</strong>有添加员工、分页查询员工、修改员工、禁用员工等实现功能。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221122736390.png" alt="image-20240221122736390"></p>
<p><strong>分类管理模块</strong>有新建菜品分类和新增套餐分类，查询分类，对分类进行修改、删除、禁用等功能。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221122850337.png" alt="image-20240221122850337"></p>
<h1 id="新增员工"><a href="#新增员工" class="headerlink" title="新增员工"></a>新增员工</h1><h2 id="需求分析和设计"><a href="#需求分析和设计" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221123500727.png" alt="image-20240221123500727"></p>
<ul>
<li><p>账号必须是唯一的</p>
</li>
<li><p>手机号为合法的11位手机号码</p>
</li>
<li><p>身份证为合法的18位身份证号码</p>
</li>
<li><p>密码默认为123456</p>
</li>
</ul>
<p>接口的请求方式应该是POST，提交的数据是表单项中的数据，以json格式提交，后端返回的设计格式也是json。</p>
<p><strong>接口设计</strong>：</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221124004779.png" alt="image-20240221124004779"></p>
<p>本项目约定：</p>
<ul>
<li>管理端发出的请求，统一使用&#x2F;admin作为前缀</li>
<li>用户端发出的请求，统一使用&#x2F;user作为前缀</li>
</ul>
<p><strong>数据库设计（employee表）</strong>：</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221124246494.png" alt="image-20240221124246494"></p>
<h2 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h2><p>根据新增员工接口设计对应的DTO，封装前端提交过来的数据。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221124508384.png" alt="image-20240221124508384"></p>
<p>为什么不用实体类来封装前端提交的数据？</p>
<p><font color="red">原因：当前端提交的数据和实体类中对应的属性差别较大时，建议使用DTO来封装数据。</font></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221124722772.png" alt="image-20240221124722772"></p>
<p><strong>编写controller层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/employee&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;员工相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增员工</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;新增员工&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeDTO employeeDTO)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;新增员工：&#123;&#125;&quot;</span>, employeeDTO);</span><br><span class="line">        employeeService.save(employeeDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/employee&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;员工相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增员工</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;新增员工&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeDTO employeeDTO)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;新增员工：&#123;&#125;&quot;</span>, employeeDTO);</span><br><span class="line">        employeeService.save(employeeDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入员工数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into employee (name, username, password, phone, sex, id_number, create_time, update_time, create_user, update_user) &quot; +</span></span><br><span class="line"><span class="meta">        &quot;values(#&#123;name&#125;,#&#123;username&#125;,#&#123;password&#125;,#&#123;phone&#125;,#&#123;sex&#125;,#&#123;idNumber&#125;,#&#123;createTime&#125;,#&#123;updateTime&#125;,#&#123;createUser&#125;,#&#123;updateUser&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Employee employee)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h2><p>功能测试方式</p>
<ul>
<li>通过接口文档测试</li>
<li>通过前后端联调测试</li>
</ul>
<p>注意：由于开发阶段前端和后端是并行开发的，后端完成某个功能后，此时前端对应的功能可能还没有开发完成，导致无法进行前后端联调测试。所以在开发阶段，后端测试主要以接口文档测试为主。</p>
<p>先通过员工登录接口获取token，并将其设置在文档管理的全局参数设置中。</p>
<p><strong>获取token</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221134158354.png" alt="image-20240221134158354"></p>
<p><strong>将token配置到全局参数设置中</strong>（参数类型是header）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221134241220.png" alt="image-20240221134241220"></p>
<p><strong>再次测试新增员工方法</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221134327794.png" alt="image-20240221134327794"></p>
<p><strong>前后端联调</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221134704428.png" alt="image-20240221134704428"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221134910323.png" alt="image-20240221134910323"></p>
<h2 id="代码完善"><a href="#代码完善" class="headerlink" title="代码完善"></a>代码完善</h2><p>程序存在的问题：</p>
<ul>
<li><p>录入的用户名已经存在，抛出异常后没有处理</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221135055314.png" alt="image-20240221135055314"></p>
<p>解决办法：在全局异常处理器中捕获异常</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.BaseException;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.SQLIntegrityConstraintViolationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理器，处理项目中抛出的业务异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理SQL异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span><span class="params">(SQLIntegrityConstraintViolationException ex)</span>&#123;</span><br><span class="line"><span class="comment">//        Duplicate entry &#x27;zhangsan&#x27; for key &#x27;employee.idx_username&#x27;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span>(message.contains(<span class="string">&quot;Duplicate entry&quot;</span>))&#123;</span><br><span class="line">            String[] split = message.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> split[<span class="number">2</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> username + MessageConstant.ALREADY_EXISTS;</span><br><span class="line">            <span class="keyword">return</span> Result.error(msg);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(MessageConstant.UNKNOWN_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增员工时，创建人id和修改人id设置为了固定值</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221135135315.png" alt="image-20240221135135315"></p>
<p>解决办法：针对第二个问题，需要通过某种方式动态获取当前登录员工的id。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221145518597.png" alt="image-20240221145518597"></p>
<p>JWT认证流程</p>
<p>前端发起请求，把用户名和密码提交给后端。后端校验之后认证通过，生成JWT token并返回给前端，前端会在本地保存JWT令牌。后续前端的每次操作请求后端接口都会在请求头中携带JWT，后端接收到请求后会用拦截器拦截请求，检查token，如果通过，就放行，不通过就返回错误信息。</p>
<p>拦截器验证的token中存在用户名和密码。如果新增员工业务在拦截器拦截时能够获取JWT中的信息，就能确定当前登录员工的ID。</p>
</li>
</ul>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221150141394.png" alt="image-20240221150141394"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221150254097.png" alt="image-20240221150254097"></p>
<p>解析出登录员工ID之后，如何传递给Service的save方法?</p>
<p>答：ThreadLocal。</p>
<p>ThreadLocal并不是一个Thread，而是Thread的局部变量。</p>
<p><font color="red">ThreadLocal为每个线程提供单独一份存储空间，具有线程隔离的效果，只有在线程内才能获取对应的值，线程外则不能访问。</font></p>
<p><font color="red">客户端发起的每一次请求，tomcat都会为其分配单独的线程，在线程上可能要执行不同的代码，比如拦截器代码，controller代码，service代码，它们都属于同一个线程。只要满足这个条件，就可以使用ThreadLocal，将我们的数据存进去，在对应的地方取出来。</font></p>
<p>ThreadLocal常用方法</p>
<ul>
<li>public void set(T value) 设置当前线程的线程局部变量的值</li>
<li>public T get() 返回当前线程所对应的线程局部变量的值</li>
<li>public void remove() 移除当前线程的线程局部变量</li>
</ul>
<p>我们使用ThreadLocal时通常的做法是将其封装为工具类，这样使用起来更方便。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221151624886.png" alt="image-20240221151624886"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setCurrentId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        threadLocal.set(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getCurrentId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeCurrentId</span><span class="params">()</span> &#123;</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>实现步骤</p>
<ol>
<li><p>在JWT拦截器部分将解析出来的ID值加入到Thread中。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221152153763.png" alt="image-20240221152153763"></p>
</li>
<li><p>在新增员工业务将对应的Thread值存入数据表中</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221152257216.png" alt="image-20240221152257216"></p>
</li>
</ol>
<h1 id="员工分页查询"><a href="#员工分页查询" class="headerlink" title="员工分页查询"></a>员工分页查询</h1><h2 id="需求分析和设计-1"><a href="#需求分析和设计-1" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221152741313.png" alt="image-20240221152741313"></p>
<p>业务规则：</p>
<ul>
<li>根据页码展示员工信息</li>
<li>每页展示10条数据</li>
<li>分页查询时可以根据需要，输入员工姓名进行查询</li>
</ul>
<p><strong>接口设计</strong></p>
<p>操作是查询操作，请求方式是get类型，分页查询需要将页码，每一页的记录数，员工姓名作为查询参数发送给后端，后端需要展示总的记录数，并且将当前页展示的数据集合响应给前端。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221153439677.png" alt="image-20240221153439677"></p>
<p>请求参数是以Query的方式传到后端的，相当于在url后面加参数和值。这意味着controller层对应方法要加上与之同名的形参。</p>
<h2 id="代码开发-1"><a href="#代码开发-1" class="headerlink" title="代码开发"></a>代码开发</h2><p>根据分页查询接口设计对应的DTO。</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221154353897.png" alt="image-20240221154353897"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221154344482.png" alt="image-20240221154344482"></p>
<p>后面所有的分页查询，统一都封装成PageResult对象：</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221154906603.png" alt="image-20240221154906603"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221154939771.png" alt="image-20240221154939771"></p>
<p>员工信息分页查询后端返回的对象类型为：Result&lt;PageResult&gt;</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221155025472.png" alt="image-20240221155025472"></p>
<p><strong>controller层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/employee&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;员工相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/page&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;员工分页查询&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;员工分页查询：参数为：&#123;&#125;&quot;</span>,employeePageQueryDTO);</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> employeeService.pageQuery(employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.PasswordConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountLockedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountNotFoundException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.PasswordErrorException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmployeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span> &#123;</span><br><span class="line"><span class="comment">//        //1.设置分页参数</span></span><br><span class="line"><span class="comment">//        PageHelper.startPage(employeePageQueryDTO.getPage(),employeePageQueryDTO.getPageSize());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //2.执行查询</span></span><br><span class="line"><span class="comment">//        List&lt;Employee&gt; empList = employeeMapper.list();</span></span><br><span class="line"><span class="comment">//        Page&lt;Employee&gt; p = (Page&lt;Employee&gt;) empList;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        // 3. 封装PageBean对象</span></span><br><span class="line"><span class="comment">//        PageResult pageResult = new PageResult(p.getTotal(),p.getResult());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        return pageResult;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始分页查询</span></span><br><span class="line">        PageHelper.startPage(employeePageQueryDTO.getPage(),employeePageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">        Page&lt;Employee&gt; page = employeeMapper.pageQuery(employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), page.getResult());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码编写</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from employee&quot;)</span></span><br><span class="line">    List&lt;Employee&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Page&lt;Employee&gt; <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的mapper.xml文件编写pageQuery实现</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.EmployeeMapper&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageQuery&quot;</span>  <span class="attr">resultType</span>=<span class="string">&quot;com.sky.entity.Employee&quot;</span>&gt;</span></span><br><span class="line">        select * from employee</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">                name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h2><p>可以通过接口文档进行测试，也可以通过前后端联调测试，最后操作时间字段展示有问题，如下所示：</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221162938244.png" alt="image-20240221162938244"></p>
<h2 id="代码完善-1"><a href="#代码完善-1" class="headerlink" title="代码完善"></a>代码完善</h2><p>解决方式：</p>
<ul>
<li><p>方式一：在属性上加入注解，对日期进行格式化（缺点：只能给单个成员变量加注释）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime updateTime;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221164702793.png" alt="image-20240221164702793"></p>
</li>
<li><p>方式二：在WebMvcConfiguration中拓展Spring MVC的消息转换器，统一对日期类型进行格式化处理</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221164331753.png" alt="image-20240221164331753"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.interceptor.JwtTokenAdminInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.sky.json.JacksonObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，注册web层相关组件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenAdminInterceptor jwtTokenAdminInterceptor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扩展Spring MVC框架的消息转化器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> converters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个消息转换器对象</span></span><br><span class="line">        <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//需要为消息转换器设置一个对象转换器，对象转换器可以将Java对象序列化为json数组</span></span><br><span class="line">        converter.setObjectMapper(<span class="keyword">new</span> <span class="title class_">JacksonObjectMapper</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将我们自己的转换器放入spring MVC框架的容器中</span></span><br><span class="line">        converters.add(<span class="number">0</span>,converter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JacksonObjectMapper相关代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.<span class="keyword">module</span>.SimpleModule;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalTimeSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对象映射器:基于jackson将Java对象转为json，或者将json转为Java对象</span></span><br><span class="line"><span class="comment"> * 将JSON解析为Java对象的过程称为 [从JSON反序列化Java对象]</span></span><br><span class="line"><span class="comment"> * 从Java对象生成JSON的过程称为 [序列化Java对象到JSON]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JacksonObjectMapper</span> <span class="keyword">extends</span> <span class="title class_">ObjectMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DATE_FORMAT</span> <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">    <span class="comment">//public static final String DEFAULT_DATE_TIME_FORMAT = &quot;yyyy-MM-dd HH:mm:ss&quot;;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DATE_TIME_FORMAT</span> <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_TIME_FORMAT</span> <span class="operator">=</span> <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JacksonObjectMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="comment">//收到未知属性时不报异常</span></span><br><span class="line">        <span class="built_in">this</span>.configure(FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化时，属性不存在的兼容处理</span></span><br><span class="line">        <span class="built_in">this</span>.getDeserializationConfig().withoutFeatures(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleModule</span> <span class="variable">simpleModule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleModule</span>()</span><br><span class="line">                .addDeserializer(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">LocalDateTimeDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))</span><br><span class="line">                .addDeserializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))</span><br><span class="line">                .addDeserializer(LocalTime.class, <span class="keyword">new</span> <span class="title class_">LocalTimeDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)))</span><br><span class="line">                .addSerializer(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">LocalDateTimeSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))</span><br><span class="line">                .addSerializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))</span><br><span class="line">                .addSerializer(LocalTime.class, <span class="keyword">new</span> <span class="title class_">LocalTimeSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册功能模块 例如，可以添加自定义序列化器和反序列化器</span></span><br><span class="line">        <span class="built_in">this</span>.registerModule(simpleModule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="启用禁用员工账号"><a href="#启用禁用员工账号" class="headerlink" title="启用禁用员工账号"></a>启用禁用员工账号</h1><h2 id="需求分析和设计-2"><a href="#需求分析和设计-2" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型：</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221170119891.png" alt="image-20240221170119891"></p>
<p>业务规则：</p>
<ul>
<li>可以对状态为“启用”的员工账号进行“禁用”操作</li>
<li>可以对状态为“禁用”的员工账号进行“启用”操作</li>
<li>状态为“禁用”的员工账号不能登录系统</li>
</ul>
<p><strong>接口设计</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221170325406.png" alt="image-20240221170325406"></p>
<p><font color="red">注意这里的status是路径参数，但是id是query方式传上去的。于是我们在controller层接受这个两个参数时，status要用@PathVariable注解。id则直接作为函数的参数形参传入即可。</font></p>
<h2 id="代码开发-2"><a href="#代码开发-2" class="headerlink" title="代码开发"></a>代码开发</h2><p><strong>编写controller层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/employee&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;员工相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用禁用员工账号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;启用禁用员工账号&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status,Long id)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;启用禁用员工账号:&#123;&#125;,&#123;&#125;&quot;</span>,status,id);</span><br><span class="line"></span><br><span class="line">        employeeService.startOrStop(status,id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.PasswordConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountLockedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountNotFoundException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.PasswordErrorException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmployeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用禁用员工账号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// update employee set status = ? where id = ?</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*Employee employee = new Employee();</span></span><br><span class="line"><span class="comment">        employee.setStatus(status);</span></span><br><span class="line"><span class="comment">        employee.setId(id);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> Employee.builder()</span><br><span class="line">            .status(status)</span><br><span class="line">            .id(id)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        employeeMapper.update(employee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键动态修改属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Employee employee)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.EmployeeMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Employee&quot;</span>&gt;</span></span><br><span class="line">        update employee</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null&quot;</span>&gt;</span>name = #&#123;name&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;password != null&quot;</span>&gt;</span>password = #&#123;password&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;username != null&quot;</span>&gt;</span>username = #&#123;username&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;phone != null&quot;</span>&gt;</span>phone = #&#123;phone&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex != null&quot;</span>&gt;</span>sex = #&#123;sex&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;idNumber != null&quot;</span>&gt;</span>id_Number = #&#123;idNumber&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateTime != null&quot;</span>&gt;</span>update_time = #&#123;updateTime&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateUser != null&quot;</span>&gt;</span>update_user = #&#123;updateUser&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span>status = #&#123;status&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="功能测试-2"><a href="#功能测试-2" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221174844571.png" alt="image-20240221174844571"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221174911640.png" alt="image-20240221174911640"></p>
<h1 id="编辑员工"><a href="#编辑员工" class="headerlink" title="编辑员工"></a>编辑员工</h1><h2 id="需求分析和设计-3"><a href="#需求分析和设计-3" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221175433011.png" alt="image-20240221175433011"></p>
<p>对员工信息进行操作，能够修改的选项如上图所示。</p>
<p>要完成编辑员工的业务，可以看到，这边有一个回显操作，回写需要根据员工的ID查询出数据，然后才能在这个页面回显数据。</p>
<p>所以第一步要根据ID查询用户信息，第二步在表单页面进行信息修改。</p>
<p>编辑员工功能涉及到两个接口：</p>
<ul>
<li><p>根据id查询员工信息</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221180539074.png" alt="image-20240221180539074"></p>
</li>
<li><p>编辑员工信息（它属于修改类的操作，所以请求方式是PUT）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221180634012.png" alt="image-20240221180634012"></p>
</li>
</ul>
<h2 id="代码开发-3"><a href="#代码开发-3" class="headerlink" title="代码开发"></a>代码开发</h2><ul>
<li><p>根据id查询员工信息</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221180539074.png" alt="image-20240221180539074"></p>
</li>
</ul>
<p><strong>controller层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/employee&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;员工相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;根据id查询用户信息&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Employee&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeService.getById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success(employee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.PasswordConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountLockedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountNotFoundException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.PasswordErrorException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmployeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询员工</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Employee <span class="title function_">getById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeMapper.getById(id);</span><br><span class="line">        employee.setPassword(<span class="string">&quot;****&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.image.RescaleOp;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键动态修改属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Employee employee)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.EmployeeMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageQuery&quot;</span>  <span class="attr">resultType</span>=<span class="string">&quot;com.sky.entity.Employee&quot;</span>&gt;</span></span><br><span class="line">        select * from employee</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">                name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Employee&quot;</span>&gt;</span></span><br><span class="line">        update employee</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null&quot;</span>&gt;</span>name = #&#123;name&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;password != null&quot;</span>&gt;</span>password = #&#123;password&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;username != null&quot;</span>&gt;</span>username = #&#123;username&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;phone != null&quot;</span>&gt;</span>phone = #&#123;phone&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;sex != null&quot;</span>&gt;</span>sex = #&#123;sex&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;idNumber != null&quot;</span>&gt;</span>id_Number = #&#123;idNumber&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateTime != null&quot;</span>&gt;</span>update_time = #&#123;updateTime&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateUser != null&quot;</span>&gt;</span>update_user = #&#123;updateUser&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;status != null&quot;</span>&gt;</span>status = #&#123;status&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p>编辑员工信息（它属于修改类的操作，所以请求方式是PUT）</p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221180634012.png" alt="image-20240221180634012"></p>
</li>
</ul>
<p><strong>controller层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/employee&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;员工相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编辑员工信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;编辑员工信息&quot;)</span></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeDTO employeeDTO)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;编辑员工信息：&#123;&#125;&quot;</span>,employeeDTO);</span><br><span class="line">        employeeService.update(employeeDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.PasswordConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountLockedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountNotFoundException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.PasswordErrorException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmployeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编辑员工信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(EmployeeDTO employeeDTO)</span> &#123;</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">        BeanUtils.copyProperties(employeeDTO, employee);</span><br><span class="line">        employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">        employeeMapper.update(employee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.image.RescaleOp;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键动态修改属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Employee employee)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="功能测试-3"><a href="#功能测试-3" class="headerlink" title="功能测试"></a>功能测试</h2><p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221193142242.png" alt="image-20240221193142242"></p>
<h1 id="导入分类模块功能代码"><a href="#导入分类模块功能代码" class="headerlink" title="导入分类模块功能代码"></a>导入分类模块功能代码</h1><h2 id="需求分析和设计-4"><a href="#需求分析和设计-4" class="headerlink" title="需求分析和设计"></a>需求分析和设计</h2><p><strong>产品原型</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221193359609.png" alt="image-20240221193359609"></p>
<p>菜品分类和套餐分类，还有修改、查询、禁用操作。</p>
<p>业务规则：</p>
<ul>
<li>分类名称必须是唯一的。</li>
<li>分类按照类型可以分为菜品分类和套餐分类。</li>
<li>新添加的分类状态默认为“禁用”。</li>
</ul>
<p><strong>接口设计</strong></p>
<ul>
<li>新增分类</li>
<li>分类分页查询</li>
<li>根据id删除分类</li>
<li>修改分类</li>
<li>启用禁用分类</li>
<li>根据类型查询分类</li>
</ul>
<p><strong>分类接口</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221193942346.png" alt="image-20240221193942346"></p>
<p><strong>数据库设计（category表）</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221194404816.png" alt="image-20240221194404816"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221222612780.png" alt="image-20240221222612780"></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221223226040.png" alt="image-20240221223226040"></p>
<p><strong>第三方导入的类建议最好再编译一下</strong></p>
<p><img src="/2024/02/21/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day02-%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E3%80%81%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/image-20240221223333510.png" alt="image-20240221223333510"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>苍穹外卖-day01-项目概述、环境搭建</title>
    <url>/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/</url>
    <content><![CDATA[<h1 id="课程优势"><a href="#课程优势" class="headerlink" title="课程优势"></a>课程优势</h1><p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220181432990.png" alt="image-20240220181432990"></p>
<h1 id="课程安排"><a href="#课程安排" class="headerlink" title="课程安排"></a>课程安排</h1><p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220181624181.png" alt="image-20240220181624181"></p>
<h1 id="项目效果演示"><a href="#项目效果演示" class="headerlink" title="项目效果演示"></a>项目效果演示</h1><p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220181837351.png" alt="image-20240220181837351"></p>
<p><strong>管理端</strong></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220181935488.png" alt="image-20240220181935488"></p>
<p><strong>用户端</strong></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220181957327.png" alt="image-20240220181957327"></p>
<h1 id="项目概述、环境搭建"><a href="#项目概述、环境搭建" class="headerlink" title="项目概述、环境搭建"></a>项目概述、环境搭建</h1><h2 id="软件开发整体介绍"><a href="#软件开发整体介绍" class="headerlink" title="软件开发整体介绍"></a>软件开发整体介绍</h2><h3 id="软件开发流程"><a href="#软件开发流程" class="headerlink" title="软件开发流程"></a>软件开发流程</h3><p><strong>需求分析</strong>：需求规格说明书、产品原型</p>
<p>需求规格说明书：word规格的内容。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184001140.png" alt="image-20240220184001140"></p>
<p>产品原型：通过静态网页的形式来展示项目当中一个个业务功能。</p>
<p>以下是新增员工的业务功能的页面原型。</p>
<p> <img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184155834.png" alt="image-20240220184155834"></p>
<p><strong>设计</strong>：UI设计、数据库设计、接口设计</p>
<p>UI设计：最终项目做完之后的界面效果，小到一个按钮的效果，大到页面布局，包括人机交互的逻辑</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184312846.png" alt="image-20240220184312846"></p>
<p>数据库设计：数据库结构，每个表的字段，类型，定义出来，包括表之间的关系</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184434245.png" alt="image-20240220184434245"></p>
<p>接口设计：请求方式、请求路径、传的参数，返回数据等规定</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184516432.png" alt="image-20240220184516432"></p>
<p><strong>编码</strong>：项目代码、单元测试（开发人员测试代码，确保代码正确有效）</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184549237.png" alt="image-20240220184549237"></p>
<p><strong>测试</strong>：编写测试用例、测试报告</p>
<p><strong>上线运维</strong>：软件环境的安装、配置</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184638064.png" alt="image-20240220184638064"></p>
<h3 id="角色分工"><a href="#角色分工" class="headerlink" title="角色分工"></a>角色分工</h3><ul>
<li><p>项目经理：对整个项目负责、任务分配，把控进度（管理角色）</p>
</li>
<li><p>产品经理：进行需求调研，输出需求调研文档，产品原型等</p>
</li>
<li><p>UI设计师：根据产品原型输出界面效果图</p>
</li>
<li><p>架构师：项目整体架构设计、技术选型</p>
</li>
<li><p>开发工程师：代码实现</p>
</li>
<li><p>测试工程师：编写测试用例，输出测试报告</p>
</li>
<li><p>运维工程师：软件环境搭建、项目上线</p>
</li>
</ul>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220184900920.png" alt="image-20240220184900920"></p>
<h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h3><ul>
<li>开发环境（development）：开发人员在开发阶段使用的环境，一般外部用户无法访问</li>
<li>测试环境（testing）：专门给测试人员使用的环境，用于测试项目，一般外部用户无法访问</li>
<li>生产环境（production）：即线上环境，正式提供对外服务的环境</li>
</ul>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220191425242.png" alt="image-20240220191425242"></p>
<h2 id="苍穹外卖项目介绍"><a href="#苍穹外卖项目介绍" class="headerlink" title="苍穹外卖项目介绍"></a>苍穹外卖项目介绍</h2><h3 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h3><p>定位：专门为餐饮企业（餐厅、饭店）定制的一款软件产品</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220191757076.png" alt="image-20240220191757076"></p>
<p>功能架构：体现项目中的业务功能模块</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220191908865.png" alt="image-20240220191908865"></p>
<h3 id="产品原型"><a href="#产品原型" class="headerlink" title="产品原型"></a>产品原型</h3><p>产品原型：用于展示项目的业务功能：一般由产品经理进行设计</p>
<p><strong>管理端</strong></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220192009154.png" alt="image-20240220192009154"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220192627836.png" alt="image-20240220192627836"></p>
<p><strong>用户端</strong></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220192018972.png" alt="image-20240220192018972"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220192554198.png" alt="image-20240220192554198"></p>
<h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><p>技术选型：<font color="red">展示项目中使用到的技术框架和中间件等</font></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220192934832.png" alt="image-20240220192934832"></p>
<h2 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h2><h3 id="前端环境搭建"><a href="#前端环境搭建" class="headerlink" title="前端环境搭建"></a>前端环境搭建</h3><p>前端代码已经开发好，只要环境运行起来就可。已经提供了Nginx服务器。</p>
<h4 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h4><p>管理端（Web）是基于Nginx服务器运行的，至于用户端（小程序）的搭建，在开发到相应阶段时再设置。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220193245072.png" alt="image-20240220193245072"></p>
<p>前端工程基于nginx运行。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220193724490.png" alt="image-20240220193724490"></p>
<p>启动nginx：双击nginx.exe即可启动nginx服务，访问端口号默认为80（注意nginx要求在原英文路径下才能正常运行）</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220193911190.png" alt="image-20240220193911190"></p>
<h3 id="后端环境搭建"><a href="#后端环境搭建" class="headerlink" title="后端环境搭建"></a>后端环境搭建</h3><p>后端工程基于maven进行项目构建，并且进行分模块开发</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220194118617.png" alt="image-20240220194118617"></p>
<p>用IDEA打开初始工程，了解项目的整体结构</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220194259776.png" alt="image-20240220194259776"></p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>sky-take-out</td>
<td>maven父工程，统一管理以来版本，聚合其他子模块</td>
</tr>
<tr>
<td>2</td>
<td>sky-common</td>
<td>子模块，存放公共类，例如：工具类，常量类，异常类等</td>
</tr>
<tr>
<td>3</td>
<td>sky-pojo</td>
<td>子模块，存放实体类，VO，DTO等</td>
</tr>
<tr>
<td>4</td>
<td>sky-server</td>
<td>子模块，后端服务，存放配置文件、Controller、Service、Mapper等</td>
</tr>
</tbody></table>
<p>sky-common子模块中存放的是一些公共类，可以供其他模块使用</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220194544087.png" alt="image-20240220194544087"></p>
<p>sky-pojo子模块中存放的是一些entity、DTO、VO</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220194710799.png" alt="image-20240220194710799"></p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Entity</td>
<td>实体、通常和数据库中的表对应</td>
</tr>
<tr>
<td>DTO</td>
<td>数据传输对象、通常用于程序中各层之间传递数据（前端提供JSON，后端使用DTO作为类封装JSON）</td>
</tr>
<tr>
<td>VO</td>
<td>视图对象，为前端展示数据提供的对象（列表数据，表单数据等）</td>
</tr>
<tr>
<td>POJO</td>
<td>普通Java对象，只有属性和对应的getter和setter</td>
</tr>
</tbody></table>
<p>sky-server子模块中存放的是配置文件、配置类、拦截器、controller、service、mapper、启动类等</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220195029539.png" alt="image-20240220195029539"></p>
<h4 id="使用Git进行版本控制"><a href="#使用Git进行版本控制" class="headerlink" title="使用Git进行版本控制"></a>使用Git进行版本控制</h4><p>使用Git进行版本代码的版本控制，具体操作：</p>
<ul>
<li><p>创建Git本地仓库</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220201845559.png" alt="image-20240220201845559"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220201900511.png" alt="image-20240220201900511"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220201713170.png" alt="image-20240220201713170"></p>
</li>
<li><p>创建Git远程仓库</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220202018386.png" alt="image-20240220202018386"></p>
</li>
<li><p>将本地文件推送至Git远程仓库</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220202041009.png" alt="image-20240220202041009"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220202403868.png" alt="image-20240220202403868"></p>
</li>
</ul>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220202637021.png" alt="image-20240220202637021"></p>
<h4 id="数据库环境搭建"><a href="#数据库环境搭建" class="headerlink" title="数据库环境搭建"></a>数据库环境搭建</h4><p>通过数据库建表语句创建数据库表结构：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE  IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `sky_take_out` ;</span><br><span class="line">USE `sky_take_out`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `address_book`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `address_book` (</span><br><span class="line">                                `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                                `user_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">                                `consignee` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;收货人&#x27;</span>,</span><br><span class="line">                                `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">                                `phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">                                `province_code` <span class="type">varchar</span>(<span class="number">12</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省级区划编号&#x27;</span>,</span><br><span class="line">                                `province_name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省级名称&#x27;</span>,</span><br><span class="line">                                `city_code` <span class="type">varchar</span>(<span class="number">12</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市级区划编号&#x27;</span>,</span><br><span class="line">                                `city_name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市级名称&#x27;</span>,</span><br><span class="line">                                `district_code` <span class="type">varchar</span>(<span class="number">12</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;区级区划编号&#x27;</span>,</span><br><span class="line">                                `district_name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;区级名称&#x27;</span>,</span><br><span class="line">                                `detail` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;详细地址&#x27;</span>,</span><br><span class="line">                                `label` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标签&#x27;</span>,</span><br><span class="line">                                `is_default` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;默认 0 否 1是&#x27;</span>,</span><br><span class="line">                                <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;地址簿&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `category`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `category` (</span><br><span class="line">                            `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                            `type` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;类型   1 菜品分类 2 套餐分类&#x27;</span>,</span><br><span class="line">                            `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;分类名称&#x27;</span>,</span><br><span class="line">                            `sort` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;顺序&#x27;</span>,</span><br><span class="line">                            `status` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;分类状态 0:禁用，1:启用&#x27;</span>,</span><br><span class="line">                            `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                            `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">                            `create_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">                            `update_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">                            <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">                            <span class="keyword">UNIQUE</span> KEY `idx_category_name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">23</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;菜品及套餐分类&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">11</span>,<span class="number">1</span>,<span class="string">&#x27;酒水饮料&#x27;</span>,<span class="number">10</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:09:18&#x27;</span>,<span class="string">&#x27;2022-06-09 22:09:18&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">12</span>,<span class="number">1</span>,<span class="string">&#x27;传统主食&#x27;</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:09:32&#x27;</span>,<span class="string">&#x27;2022-06-09 22:18:53&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">13</span>,<span class="number">2</span>,<span class="string">&#x27;人气套餐&#x27;</span>,<span class="number">12</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:11:38&#x27;</span>,<span class="string">&#x27;2022-06-10 11:04:40&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">15</span>,<span class="number">2</span>,<span class="string">&#x27;商务套餐&#x27;</span>,<span class="number">13</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:14:10&#x27;</span>,<span class="string">&#x27;2022-06-10 11:04:48&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">16</span>,<span class="number">1</span>,<span class="string">&#x27;蜀味烤鱼&#x27;</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:15:37&#x27;</span>,<span class="string">&#x27;2022-08-31 14:27:25&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">17</span>,<span class="number">1</span>,<span class="string">&#x27;蜀味牛蛙&#x27;</span>,<span class="number">5</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:16:14&#x27;</span>,<span class="string">&#x27;2022-08-31 14:39:44&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">18</span>,<span class="number">1</span>,<span class="string">&#x27;特色蒸菜&#x27;</span>,<span class="number">6</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:17:42&#x27;</span>,<span class="string">&#x27;2022-06-09 22:17:42&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">19</span>,<span class="number">1</span>,<span class="string">&#x27;新鲜时蔬&#x27;</span>,<span class="number">7</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:18:12&#x27;</span>,<span class="string">&#x27;2022-06-09 22:18:28&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">20</span>,<span class="number">1</span>,<span class="string">&#x27;水煮鱼&#x27;</span>,<span class="number">8</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:22:29&#x27;</span>,<span class="string">&#x27;2022-06-09 22:23:45&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `category` <span class="keyword">VALUES</span> (<span class="number">21</span>,<span class="number">1</span>,<span class="string">&#x27;汤类&#x27;</span>,<span class="number">11</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:51:47&#x27;</span>,<span class="string">&#x27;2022-06-10 10:51:47&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `dish`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dish` (</span><br><span class="line">                        `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                        `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品名称&#x27;</span>,</span><br><span class="line">                        `category_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品分类id&#x27;</span>,</span><br><span class="line">                        `price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品价格&#x27;</span>,</span><br><span class="line">                        `image` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图片&#x27;</span>,</span><br><span class="line">                        `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述信息&#x27;</span>,</span><br><span class="line">                        `status` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;0 停售 1 起售&#x27;</span>,</span><br><span class="line">                        `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                        `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">                        `create_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">                        `update_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">                        <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">                        <span class="keyword">UNIQUE</span> KEY `idx_dish_name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">70</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;菜品&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">46</span>,<span class="string">&#x27;王老吉&#x27;</span>,<span class="number">11</span>,<span class="number">6.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-09 22:40:47&#x27;</span>,<span class="string">&#x27;2022-06-09 22:40:47&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">47</span>,<span class="string">&#x27;北冰洋&#x27;</span>,<span class="number">11</span>,<span class="number">4.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/4451d4be-89a2-4939-9c69-3a87151cb979.png&#x27;</span>,<span class="string">&#x27;还是小时候的味道&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:18:49&#x27;</span>,<span class="string">&#x27;2022-06-10 09:18:49&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">48</span>,<span class="string">&#x27;雪花啤酒&#x27;</span>,<span class="number">11</span>,<span class="number">4.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/bf8cbfc1-04d2-40e8-9826-061ee41ab87c.png&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:22:54&#x27;</span>,<span class="string">&#x27;2022-06-10 09:22:54&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">49</span>,<span class="string">&#x27;米饭&#x27;</span>,<span class="number">12</span>,<span class="number">2.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/76752350-2121-44d2-b477-10791c23a8ec.png&#x27;</span>,<span class="string">&#x27;精选五常大米&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:30:17&#x27;</span>,<span class="string">&#x27;2022-06-10 09:30:17&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">50</span>,<span class="string">&#x27;馒头&#x27;</span>,<span class="number">12</span>,<span class="number">1.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/475cc599-8661-4899-8f9e-121dd8ef7d02.png&#x27;</span>,<span class="string">&#x27;优质面粉&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:34:28&#x27;</span>,<span class="string">&#x27;2022-06-10 09:34:28&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">51</span>,<span class="string">&#x27;老坛酸菜鱼&#x27;</span>,<span class="number">20</span>,<span class="number">56.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/4a9cefba-6a74-467e-9fde-6e687ea725d7.png&#x27;</span>,<span class="string">&#x27;原料：汤，草鱼，酸菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:40:51&#x27;</span>,<span class="string">&#x27;2022-06-10 09:40:51&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">52</span>,<span class="string">&#x27;经典酸菜鮰鱼&#x27;</span>,<span class="number">20</span>,<span class="number">66.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/5260ff39-986c-4a97-8850-2ec8c7583efc.png&#x27;</span>,<span class="string">&#x27;原料：酸菜，江团，鮰鱼&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:46:02&#x27;</span>,<span class="string">&#x27;2022-06-10 09:46:02&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">53</span>,<span class="string">&#x27;蜀味水煮草鱼&#x27;</span>,<span class="number">20</span>,<span class="number">38.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/a6953d5a-4c18-4b30-9319-4926ee77261f.png&#x27;</span>,<span class="string">&#x27;原料：草鱼，汤&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:48:37&#x27;</span>,<span class="string">&#x27;2022-06-10 09:48:37&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">54</span>,<span class="string">&#x27;清炒小油菜&#x27;</span>,<span class="number">19</span>,<span class="number">18.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/3613d38e-5614-41c2-90ed-ff175bf50716.png&#x27;</span>,<span class="string">&#x27;原料：小油菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:51:46&#x27;</span>,<span class="string">&#x27;2022-06-10 09:51:46&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">55</span>,<span class="string">&#x27;蒜蓉娃娃菜&#x27;</span>,<span class="number">19</span>,<span class="number">18.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/4879ed66-3860-4b28-ba14-306ac025fdec.png&#x27;</span>,<span class="string">&#x27;原料：蒜，娃娃菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:53:37&#x27;</span>,<span class="string">&#x27;2022-06-10 09:53:37&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">56</span>,<span class="string">&#x27;清炒西兰花&#x27;</span>,<span class="number">19</span>,<span class="number">18.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/e9ec4ba4-4b22-4fc8-9be0-4946e6aeb937.png&#x27;</span>,<span class="string">&#x27;原料：西兰花&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:55:44&#x27;</span>,<span class="string">&#x27;2022-06-10 09:55:44&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">57</span>,<span class="string">&#x27;炝炒圆白菜&#x27;</span>,<span class="number">19</span>,<span class="number">18.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/22f59feb-0d44-430e-a6cd-6a49f27453ca.png&#x27;</span>,<span class="string">&#x27;原料：圆白菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 09:58:35&#x27;</span>,<span class="string">&#x27;2022-06-10 09:58:35&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">58</span>,<span class="string">&#x27;清蒸鲈鱼&#x27;</span>,<span class="number">18</span>,<span class="number">98.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/c18b5c67-3b71-466c-a75a-e63c6449f21c.png&#x27;</span>,<span class="string">&#x27;原料：鲈鱼&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:12:28&#x27;</span>,<span class="string">&#x27;2022-06-10 10:12:28&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">59</span>,<span class="string">&#x27;东坡肘子&#x27;</span>,<span class="number">18</span>,<span class="number">138.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/a80a4b8c-c93e-4f43-ac8a-856b0d5cc451.png&#x27;</span>,<span class="string">&#x27;原料：猪肘棒&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:24:03&#x27;</span>,<span class="string">&#x27;2022-06-10 10:24:03&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">60</span>,<span class="string">&#x27;梅菜扣肉&#x27;</span>,<span class="number">18</span>,<span class="number">58.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/6080b118-e30a-4577-aab4-45042e3f88be.png&#x27;</span>,<span class="string">&#x27;原料：猪肉，梅菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:26:03&#x27;</span>,<span class="string">&#x27;2022-06-10 10:26:03&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">61</span>,<span class="string">&#x27;剁椒鱼头&#x27;</span>,<span class="number">18</span>,<span class="number">66.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/13da832f-ef2c-484d-8370-5934a1045a06.png&#x27;</span>,<span class="string">&#x27;原料：鲢鱼，剁椒&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:28:54&#x27;</span>,<span class="string">&#x27;2022-06-10 10:28:54&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">62</span>,<span class="string">&#x27;金汤酸菜牛蛙&#x27;</span>,<span class="number">17</span>,<span class="number">88.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/7694a5d8-7938-4e9d-8b9e-2075983a2e38.png&#x27;</span>,<span class="string">&#x27;原料：鲜活牛蛙，酸菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:33:05&#x27;</span>,<span class="string">&#x27;2022-06-10 10:33:05&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">63</span>,<span class="string">&#x27;香锅牛蛙&#x27;</span>,<span class="number">17</span>,<span class="number">88.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/f5ac8455-4793-450c-97ba-173795c34626.png&#x27;</span>,<span class="string">&#x27;配料：鲜活牛蛙，莲藕，青笋&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:35:40&#x27;</span>,<span class="string">&#x27;2022-06-10 10:35:40&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">64</span>,<span class="string">&#x27;馋嘴牛蛙&#x27;</span>,<span class="number">17</span>,<span class="number">88.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/7a55b845-1f2b-41fa-9486-76d187ee9ee1.png&#x27;</span>,<span class="string">&#x27;配料：鲜活牛蛙，丝瓜，黄豆芽&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:37:52&#x27;</span>,<span class="string">&#x27;2022-06-10 10:37:52&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">65</span>,<span class="string">&#x27;草鱼2斤&#x27;</span>,<span class="number">16</span>,<span class="number">68.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/b544d3ba-a1ae-4d20-a860-81cb5dec9e03.png&#x27;</span>,<span class="string">&#x27;原料：草鱼，黄豆芽，莲藕&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:41:08&#x27;</span>,<span class="string">&#x27;2022-06-10 10:41:08&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">66</span>,<span class="string">&#x27;江团鱼2斤&#x27;</span>,<span class="number">16</span>,<span class="number">119.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/a101a1e9-8f8b-47b2-afa4-1abd47ea0a87.png&#x27;</span>,<span class="string">&#x27;配料：江团鱼，黄豆芽，莲藕&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:42:42&#x27;</span>,<span class="string">&#x27;2022-06-10 10:42:42&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">67</span>,<span class="string">&#x27;鮰鱼2斤&#x27;</span>,<span class="number">16</span>,<span class="number">72.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/8cfcc576-4b66-4a09-ac68-ad5b273c2590.png&#x27;</span>,<span class="string">&#x27;原料：鮰鱼，黄豆芽，莲藕&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:43:56&#x27;</span>,<span class="string">&#x27;2022-06-10 10:43:56&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">68</span>,<span class="string">&#x27;鸡蛋汤&#x27;</span>,<span class="number">21</span>,<span class="number">4.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/c09a0ee8-9d19-428d-81b9-746221824113.png&#x27;</span>,<span class="string">&#x27;配料：鸡蛋，紫菜&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:54:25&#x27;</span>,<span class="string">&#x27;2022-06-10 10:54:25&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish` <span class="keyword">VALUES</span> (<span class="number">69</span>,<span class="string">&#x27;平菇豆腐汤&#x27;</span>,<span class="number">21</span>,<span class="number">6.00</span>,<span class="string">&#x27;https://sky-itcast.oss-cn-beijing.aliyuncs.com/16d0a3d6-2253-4cfc-9b49-bf7bd9eb2ad2.png&#x27;</span>,<span class="string">&#x27;配料：豆腐，平菇&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-06-10 10:55:02&#x27;</span>,<span class="string">&#x27;2022-06-10 10:55:02&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `dish_flavor`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `dish_flavor` (</span><br><span class="line">                               `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                               `dish_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品&#x27;</span>,</span><br><span class="line">                               `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;口味名称&#x27;</span>,</span><br><span class="line">                               `<span class="keyword">value</span>` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;口味数据list&#x27;</span>,</span><br><span class="line">                               <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">104</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;菜品口味关系表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">40</span>,<span class="number">10</span>,<span class="string">&#x27;甜味&#x27;</span>,<span class="string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">41</span>,<span class="number">7</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">42</span>,<span class="number">7</span>,<span class="string">&#x27;温度&#x27;</span>,<span class="string">&#x27;[\&quot;热饮\&quot;,\&quot;常温\&quot;,\&quot;去冰\&quot;,\&quot;少冰\&quot;,\&quot;多冰\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">45</span>,<span class="number">6</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">46</span>,<span class="number">6</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">47</span>,<span class="number">5</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">48</span>,<span class="number">5</span>,<span class="string">&#x27;甜味&#x27;</span>,<span class="string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">49</span>,<span class="number">2</span>,<span class="string">&#x27;甜味&#x27;</span>,<span class="string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">50</span>,<span class="number">4</span>,<span class="string">&#x27;甜味&#x27;</span>,<span class="string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">51</span>,<span class="number">3</span>,<span class="string">&#x27;甜味&#x27;</span>,<span class="string">&#x27;[\&quot;无糖\&quot;,\&quot;少糖\&quot;,\&quot;半糖\&quot;,\&quot;多糖\&quot;,\&quot;全糖\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">52</span>,<span class="number">3</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">86</span>,<span class="number">52</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">87</span>,<span class="number">52</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">88</span>,<span class="number">51</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">89</span>,<span class="number">51</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">92</span>,<span class="number">53</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">93</span>,<span class="number">53</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">94</span>,<span class="number">54</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">95</span>,<span class="number">56</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">96</span>,<span class="number">57</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">97</span>,<span class="number">60</span>,<span class="string">&#x27;忌口&#x27;</span>,<span class="string">&#x27;[\&quot;不要葱\&quot;,\&quot;不要蒜\&quot;,\&quot;不要香菜\&quot;,\&quot;不要辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">101</span>,<span class="number">66</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">102</span>,<span class="number">67</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `dish_flavor` <span class="keyword">VALUES</span> (<span class="number">103</span>,<span class="number">65</span>,<span class="string">&#x27;辣度&#x27;</span>,<span class="string">&#x27;[\&quot;不辣\&quot;,\&quot;微辣\&quot;,\&quot;中辣\&quot;,\&quot;重辣\&quot;]&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `employee`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employee` (</span><br><span class="line">                            `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                            `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">                            `username` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">                            `password` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">                            `phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">                            `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">                            `id_number` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">                            `status` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;状态 0:禁用，1:启用&#x27;</span>,</span><br><span class="line">                            `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                            `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">                            `create_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">                            `update_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">                            <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">                            <span class="keyword">UNIQUE</span> KEY `idx_username` (`username`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;员工信息&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employee` <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;管理员&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;13812312312&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;110101199001010047&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2022-02-15 15:51:20&#x27;</span>,<span class="string">&#x27;2022-02-17 09:16:20&#x27;</span>,<span class="number">10</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `order_detail`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `order_detail` (</span><br><span class="line">                                `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                                `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;名字&#x27;</span>,</span><br><span class="line">                                `image` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图片&#x27;</span>,</span><br><span class="line">                                `order_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">                                `dish_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品id&#x27;</span>,</span><br><span class="line">                                `setmeal_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;套餐id&#x27;</span>,</span><br><span class="line">                                `dish_flavor` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;口味&#x27;</span>,</span><br><span class="line">                                `number` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">                                `amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;金额&#x27;</span>,</span><br><span class="line">                                <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;订单明细表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `orders`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `orders` (</span><br><span class="line">                          `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                          `number` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单号&#x27;</span>,</span><br><span class="line">                          `status` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消 7退款&#x27;</span>,</span><br><span class="line">                          `user_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;下单用户&#x27;</span>,</span><br><span class="line">                          `address_book_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址id&#x27;</span>,</span><br><span class="line">                          `order_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;下单时间&#x27;</span>,</span><br><span class="line">                          `checkout_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;结账时间&#x27;</span>,</span><br><span class="line">                          `pay_method` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;支付方式 1微信,2支付宝&#x27;</span>,</span><br><span class="line">                          `pay_status` tinyint <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;支付状态 0未支付 1已支付 2退款&#x27;</span>,</span><br><span class="line">                          `amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;实收金额&#x27;</span>,</span><br><span class="line">                          `remark` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">                          `phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">                          `address` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">                          `user_name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名称&#x27;</span>,</span><br><span class="line">                          `consignee` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;收货人&#x27;</span>,</span><br><span class="line">                          `cancel_reason` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单取消原因&#x27;</span>,</span><br><span class="line">                          `rejection_reason` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单拒绝原因&#x27;</span>,</span><br><span class="line">                          `cancel_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单取消时间&#x27;</span>,</span><br><span class="line">                          `estimated_delivery_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;预计送达时间&#x27;</span>,</span><br><span class="line">                          `delivery_status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;配送状态  1立即送出  0选择具体时间&#x27;</span>,</span><br><span class="line">                          `delivery_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;送达时间&#x27;</span>,</span><br><span class="line">                          `pack_amount` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;打包费&#x27;</span>,</span><br><span class="line">                          `tableware_number` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;餐具数量&#x27;</span>,</span><br><span class="line">                          `tableware_status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;餐具数量状态  1按餐量提供  0选择具体数量&#x27;</span>,</span><br><span class="line">                          <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;订单表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `setmeal`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `setmeal` (</span><br><span class="line">                           `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                           `category_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品分类id&#x27;</span>,</span><br><span class="line">                           `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;套餐名称&#x27;</span>,</span><br><span class="line">                           `price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;套餐价格&#x27;</span>,</span><br><span class="line">                           `status` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;售卖状态 0:停售 1:起售&#x27;</span>,</span><br><span class="line">                           `description` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述信息&#x27;</span>,</span><br><span class="line">                           `image` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图片&#x27;</span>,</span><br><span class="line">                           `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                           `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">                           `create_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">                           `update_user` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;修改人&#x27;</span>,</span><br><span class="line">                           <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">                           <span class="keyword">UNIQUE</span> KEY `idx_setmeal_name` (`name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">32</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;套餐&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `setmeal_dish`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `setmeal_dish` (</span><br><span class="line">                                `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                                `setmeal_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;套餐id&#x27;</span>,</span><br><span class="line">                                `dish_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品id&#x27;</span>,</span><br><span class="line">                                `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品名称 （冗余字段）&#x27;</span>,</span><br><span class="line">                                `price` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品单价（冗余字段）&#x27;</span>,</span><br><span class="line">                                `copies` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品份数&#x27;</span>,</span><br><span class="line">                                <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">47</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;套餐菜品关系&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `shopping_cart`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `shopping_cart` (</span><br><span class="line">                                 `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                                 `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">                                 `image` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图片&#x27;</span>,</span><br><span class="line">                                 `user_id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                                 `dish_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;菜品id&#x27;</span>,</span><br><span class="line">                                 `setmeal_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;套餐id&#x27;</span>,</span><br><span class="line">                                 `dish_flavor` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;口味&#x27;</span>,</span><br><span class="line">                                 `number` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">                                 `amount` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;金额&#x27;</span>,</span><br><span class="line">                                 `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                                 <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">9</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;购物车&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">user</span>`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">                        `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">                        `openid` <span class="type">varchar</span>(<span class="number">45</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;微信用户唯一标识&#x27;</span>,</span><br><span class="line">                        `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">                        `phone` <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">                        `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">                        `id_number` <span class="type">varchar</span>(<span class="number">18</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">                        `avatar` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像&#x27;</span>,</span><br><span class="line">                        `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                        <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;用户信息&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220210022362.png" alt="image-20240220210022362"></p>
<h4 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h4><p>后端的初始工程已经实现了登录功能，直接进行前后端联调测试即可</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220210553806.png" alt="image-20240220210553806"></p>
<ol>
<li><p>编译文件</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220225310010.png" alt="image-20240220225310010"></p>
</li>
<li><p>运行启动类</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220225423436.png" alt="image-20240220225423436"></p>
</li>
<li><p>修改配置页面，确保数据库用户密码正确</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220231214419.png" alt="image-20240220231214419"></p>
</li>
</ol>
<h4 id="Nginx反向代理和负载均衡概念"><a href="#Nginx反向代理和负载均衡概念" class="headerlink" title="Nginx反向代理和负载均衡概念"></a>Nginx反向代理和负载均衡概念</h4><p><strong>前端发送的请求，是如何请求到后端服务的？</strong></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220232059536.png" alt="image-20240220232059536"></p>
<p>前端的请求地址是localhost，没有指定端口号，默认80，后面的路径是api&#x2F;employee&#x2F;login。前端的请求地址：<a href="http://localhost/api/employee/login">http://localhost/api/employee/login</a></p>
<p>后端的接口地址是 <a href="http://localhost:8080/admin/employee/login">http://localhost:8080/admin/employee/login</a></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220232208186.png" alt="image-20240220232208186"></p>
<p>前后端的接口地址并未匹配，但是请求成功了，这是问什么呢？</p>
<p>原因：nginx反向代理，就是将前端发送的动态请求由nginx转发到后端服务器。nginx在之前的课程中主要用来部署静态资源，把它当作HTTP服务器。实际上nginx还可以作为反向代理服务器，一般通过nginx做反向代理，把前端发过来的动态请求转发到后端服务器。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220232459573.png" alt="image-20240220232459573"></p>
<p>也就是说，之前的登录请求过程实际可以看作如下的过程（nginx通过反向代理转发前端请求到后端的tomcat服务器）：</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220232723613.png" alt="image-20240220232723613"></p>
<p>为何不直接将前端的请求发送到后端的tomcat服务器，而是要用nginx服务器呢？</p>
<p>nginx反向代理的好处：</p>
<ul>
<li><p>提高访问速度（向nginx发送相同请求，nginx可以缓存后端数据，直接返回相应的后端数据）</p>
</li>
<li><p>进行负载均衡（<font color="red">将大量的请求按照我们指定的方式均衡的分配给集群中的每台服务器</font>）</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220232959729.png" alt="image-20240220232959729"></p>
</li>
<li><p>保证后端服务安全（服务器往往部署在公司内部的局域网内，不是对外开放的，通过前端不能直接请求到后端的，所以这个时候要请求后端服务，只有这个入口，即前端发来的请求，先请求到nginx服务器，然后再由nginx服务器走内网，将这个请求转发给后端服务）</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220233224248.png" alt="image-20240220233224248"></p>
</li>
</ul>
<h4 id="Nginx反向代理和负载均衡配置"><a href="#Nginx反向代理和负载均衡配置" class="headerlink" title="Nginx反向代理和负载均衡配置"></a>Nginx反向代理和负载均衡配置</h4><p><strong>nginx反向代理的配置方式</strong>(配置nginx的配置文件nginx.conf)：</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220233455762.png" alt="image-20240220233455762"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220233556775.png" alt="image-20240220233556775"></p>
<p><strong>nginx负载均衡的配置方式</strong>((配置nginx的配置文件nginx.conf)：</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220233837975.png" alt="image-20240220233837975"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220233846731.png" alt="image-20240220233846731"></p>
<p>主要配置webservers，声明了两个后端服务器的8080端口。让两个服务器来接受前端的请求，底层还是基于反向代理。只不过负载均衡转发时需要转发到任意一台服务器。</p>
<p>nginx负载均衡策略：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>默认方式</td>
</tr>
<tr>
<td>weight</td>
<td>权重方式，默认为1，权重越高，被分配的客户端请求就越多</td>
</tr>
<tr>
<td>ip_hash</td>
<td>根据ip分配方式，这样每个访客可以固定访问一个后端服务</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式，把请求优先分配给连接数少的后端服务</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据url分配方式，这样相同的url会被分配到同一个后端服务</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式，响应时间短的服务将会被优先分配</td>
</tr>
</tbody></table>
<h3 id="完善登录功能"><a href="#完善登录功能" class="headerlink" title="完善登录功能"></a>完善登录功能</h3><p>问题：员工表中的密码是明文存储，安全性太低。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220235038781.png" alt="image-20240220235038781"></p>
<ol>
<li><p>将密码加密之后存储，提高安全性</p>
</li>
<li><p>使用MD5 加密方式对明文密码加密</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220235218252.png" alt="image-20240220235218252"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220235408563.png" alt="image-20240220235408563"></p>
</li>
</ol>
<p>实现步骤</p>
<ol>
<li><p>修改数据库中明文密码，改为MD5加密后的密文</p>
</li>
<li><p>修改Java代码，前端提交的代码进行MD5加密后再跟数据库中密码对比</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240220235547628.png" alt="image-20240220235547628"></p>
</li>
</ol>
<p><font color="red">找到TODO标签页，里面有所有遗留问题的链接</font></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221000308322.png" alt="image-20240221000308322"></p>
<p>完成TODO内容，先对前端来的password做md5加密。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221001526426.png" alt="image-20240221001526426"></p>
<h2 id="导入接口文档"><a href="#导入接口文档" class="headerlink" title="导入接口文档"></a>导入接口文档</h2><p>前面完成了开发环境的搭建，后面要导入接口文档，开发方式是基于前后端分离的开发方式，要求开发之前，先将接口定义好，然后呢，前后端开发人员才能并行开发。我们需要将项目的接口导入到接口管理平台，为业务开发做好准备。</p>
<p>接口是开发过程中前后端多次开会决定的，且会不断地改进。</p>
<h4 id="前后端分离开发流程"><a href="#前后端分离开发流程" class="headerlink" title="前后端分离开发流程"></a>前后端分离开发流程</h4><p>前后端分离开发流程：</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221002030439.png" alt="image-20240221002030439"></p>
<h4 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h4><p>将课程资料中提供的项目接口导入YApi。</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221002137198.png" alt="image-20240221002137198"></p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221002354144.png" alt="image-20240221002354144"></p>
<p>导入对应的管理端JSON文件</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221002444885.png" alt="image-20240221002444885"></p>
<p>查看接口内容</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221002651360.png" alt="image-20240221002651360"></p>
<p>同理上传完客户端接口</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221002807634.png" alt="image-20240221002807634"></p>
<h2 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h2><p>前面已经导入了接口文档，有了接口文档，我们就可以开发后端的代码了，如果开发完了某个功能，后端如何来验证功能是否正确，这个时候就需要测试，如何测试，之前使用的是postman。</p>
<p>使用postman有个问题，有的接口请求参数过多，如果用postman测试，要构建许多参数， 效率还是比较低的，swagger应运而生。</p>
<p>swagger帮助后端高效生成接口文档，并且可以进行后端的接口测试，它是后端开发的常见技术。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>使用Swagger只需要按照它的规范去定义接口及接口相关的信息，就可以做到<strong>生成接口文档</strong>，以及<strong>在线接口调试页面</strong>。</p>
<p>官网：<a href="https://swagger.io/">https://swagger.io/</a></p>
<p>Knife4j是为Java MVC框架集成Swagger生成APi文档的增强解决方案。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221114241942.png" alt="image-20240221114241942"></p>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><ol>
<li><p>导入knife4j的maven坐标</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221114507874.png" alt="image-20240221114507874"></p>
</li>
<li><p>在配置类中加入knife4j的相关配置</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221114520003.png" alt="image-20240221114520003"></p>
</li>
<li><p>设置静态资源映射，否则接口文档页面无法访问</p>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221115134316.png" alt="image-20240221115134316"></p>
</li>
</ol>
<p>完整代码(WebMvcConfiguration加了@Configuration，是配置类，且继承自WebMvcConfigurationSupport)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.interceptor.JwtTokenAdminInterceptor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，注册web层相关组件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过knife4j生成接口文档</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">docket</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;准备生成接口文档...&quot;</span>);</span><br><span class="line">        <span class="type">ApiInfo</span> <span class="variable">apiInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;苍穹外卖项目接口文档&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;2.0&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;苍穹外卖项目接口文档&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Docket</span> <span class="variable">docket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.sky.controller&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> docket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置静态资源映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始设置静态资源映射...&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/doc.html&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/webjars/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过Swagger就可以生成接口文档，那么我们就不需要Yapi了？</p>
<ol>
<li>Yapi是涉及阶段使用的工具，管理和维护接口</li>
<li>Swagger在开发阶段使用的框架，帮助后端人员做后端的接口测试</li>
</ol>
<h3 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h3><p>通过注解可以控制生成的接口文档，使接口文档拥有更好的可读性，常用注解如下：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Api</td>
<td>用在类上，例如Controller，表示对类的说明</td>
</tr>
<tr>
<td>@ApiModel</td>
<td>用在类上，例如entity、DTO、VO，表示对用途的说明</td>
</tr>
<tr>
<td>@ApiModelProperty</td>
<td>用在属性上，描述属性信息</td>
</tr>
<tr>
<td>@ApiOperation</td>
<td>用在方法上，例如Controller的方法，说明方法的用途、作用</td>
</tr>
</tbody></table>
<p>例如</p>
<ul>
<li>@Api(tags &#x3D; “员工相关接口”)</li>
<li>@ApiOperation(value &#x3D; “员工登录”)</li>
<li>@ApiModel(description &#x3D; “员工登录返回的数据格式”)</li>
<li>@ApiModelProperty(“用户名”)</li>
</ul>
<p><img src="/2024/02/20/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96-day01/image-20240221122024885.png" alt="image-20240221122024885"></p>
]]></content>
      <categories>
        <category>苍穹外卖</category>
      </categories>
  </entry>
  <entry>
    <title>mybatisplus-day01</title>
    <url>/2024/02/18/mybatisplus-day01/</url>
    <content><![CDATA[<h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="入门案例Mybatis"><a href="#入门案例Mybatis" class="headerlink" title="入门案例Mybatis"></a>入门案例Mybatis</h2><p>需求：基于课程资料提供的项目，实现以下功能：</p>
<ol>
<li>新增用户功能</li>
<li>根据id查询用户</li>
<li>根据id批量查询用户</li>
<li>根据id更新用户</li>
<li>根据id删除用户</li>
</ol>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218131908492.png" alt="image-20240218131908492"></p>
<p>创建对应的数据库表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 导出 mp 的数据库结构</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `mp` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */</span> <span class="comment">/*!80016 DEFAULT ENCRYPTION=&#x27;N&#x27; */</span>;</span><br><span class="line">USE `mp`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导出  表 mp.address 结构</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `address` (</span><br><span class="line">                                         `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">                                         `user_id` <span class="type">bigint</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">                                         `province` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;省&#x27;</span>,</span><br><span class="line">                                         `city` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;市&#x27;</span>,</span><br><span class="line">                                         `town` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;县/区&#x27;</span>,</span><br><span class="line">                                         `mobile` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机&#x27;</span>,</span><br><span class="line">                                         `street` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;详细地址&#x27;</span>,</span><br><span class="line">                                         `contact` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系人&#x27;</span>,</span><br><span class="line">                                         `is_default` bit(<span class="number">1</span>) <span class="keyword">DEFAULT</span> b<span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;是否是默认 1默认 0否&#x27;</span>,</span><br><span class="line">                                         `notes` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">                                         `deleted` bit(<span class="number">1</span>) <span class="keyword">DEFAULT</span> b<span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;逻辑删除&#x27;</span>,</span><br><span class="line">                                         <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">                                         KEY `user_id` (`user_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">71</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 ROW_FORMAT<span class="operator">=</span>COMPACT;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正在导出表  mp.address 的数据：~11 rows (大约)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `address` (`id`, `user_id`, `province`, `city`, `town`, `mobile`, `street`, `contact`, `is_default`, `notes`, `deleted`) <span class="keyword">VALUES</span></span><br><span class="line">                                                                                                                                         (<span class="number">59</span>, <span class="number">2</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;13900112222&#x27;</span>, <span class="string">&#x27;金燕龙办公楼&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">60</span>, <span class="number">1</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;朝阳区&#x27;</span>, <span class="string">&#x27;13700221122&#x27;</span>, <span class="string">&#x27;修正大厦&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">61</span>, <span class="number">1</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;浦东新区&#x27;</span>, <span class="string">&#x27;13301212233&#x27;</span>, <span class="string">&#x27;航头镇航头路&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">63</span>, <span class="number">2</span>, <span class="string">&#x27;广东&#x27;</span>, <span class="string">&#x27;佛山&#x27;</span>, <span class="string">&#x27;永春&#x27;</span>, <span class="string">&#x27;13301212233&#x27;</span>, <span class="string">&#x27;永春武馆&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">64</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13567809102&#x27;</span>, <span class="string">&#x27;浙江大学&#x27;</span>, <span class="string">&#x27;Hope&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">65</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13967589201&#x27;</span>, <span class="string">&#x27;左岸花园&#x27;</span>, <span class="string">&#x27;Hope&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">66</span>, <span class="number">4</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;武汉&#x27;</span>, <span class="string">&#x27;汉口&#x27;</span>, <span class="string">&#x27;13967519202&#x27;</span>, <span class="string">&#x27;天天花园&#x27;</span>, <span class="string">&#x27;Thomas&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">67</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13967589201&#x27;</span>, <span class="string">&#x27;左岸花园&#x27;</span>, <span class="string">&#x27;Hopey&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">68</span>, <span class="number">4</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;武汉&#x27;</span>, <span class="string">&#x27;汉口&#x27;</span>, <span class="string">&#x27;13967519202&#x27;</span>, <span class="string">&#x27;天天花园&#x27;</span>, <span class="string">&#x27;Thomas&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">69</span>, <span class="number">3</span>, <span class="string">&#x27;浙江&#x27;</span>, <span class="string">&#x27;杭州&#x27;</span>, <span class="string">&#x27;拱墅区&#x27;</span>, <span class="string">&#x27;13967589201&#x27;</span>, <span class="string">&#x27;左岸花园&#x27;</span>, <span class="string">&#x27;Hopey&#x27;</span>, b<span class="string">&#x27;0&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>),</span><br><span class="line">                                                                                                                                         (<span class="number">70</span>, <span class="number">4</span>, <span class="string">&#x27;湖北&#x27;</span>, <span class="string">&#x27;武汉&#x27;</span>, <span class="string">&#x27;汉口&#x27;</span>, <span class="string">&#x27;13967519202&#x27;</span>, <span class="string">&#x27;天天花园&#x27;</span>, <span class="string">&#x27;Thomas&#x27;</span>, b<span class="string">&#x27;1&#x27;</span>, <span class="keyword">NULL</span>, b<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导出  表 mp.user 结构</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">                        `id` <span class="type">BIGINT</span>(<span class="number">19</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">                        `username` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">                        `password` <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">                        `phone` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注册手机号&#x27;</span> <span class="keyword">COLLATE</span> <span class="string">&#x27;utf8_general_ci&#x27;</span>,</span><br><span class="line">                        `info` JSON <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;详细信息&#x27;</span>,</span><br><span class="line">                        `status` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> COMMENT <span class="string">&#x27;使用状态（1正常 2冻结）&#x27;</span>,</span><br><span class="line">                        `balance` <span class="type">INT</span>(<span class="number">10</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;账户余额&#x27;</span>,</span><br><span class="line">                        `create_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                        `update_time` DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">                        <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">                        <span class="keyword">UNIQUE</span> INDEX `username` (`username`) <span class="keyword">USING</span> BTREE</span><br><span class="line">)</span><br><span class="line">    COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span></span><br><span class="line">    <span class="keyword">COLLATE</span><span class="operator">=</span><span class="string">&#x27;utf8_general_ci&#x27;</span></span><br><span class="line">    ENGINE<span class="operator">=</span>InnoDB</span><br><span class="line">    ROW_FORMAT<span class="operator">=</span>COMPACT</span><br><span class="line">    AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正在导出表  mp.user 的数据：~4 rows (大约)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (`id`, `username`, `password`, `phone`, `info`, `status`, `balance`, `create_time`, `update_time`) <span class="keyword">VALUES</span></span><br><span class="line">                                                                                                                          (<span class="number">1</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;13900112224&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 20, &quot;intro&quot;: &quot;佛系青年&quot;, &quot;gender&quot;: &quot;male&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">1600</span>, <span class="string">&#x27;2023-05-19 20:50:21&#x27;</span>, <span class="string">&#x27;2023-06-19 20:50:21&#x27;</span>),</span><br><span class="line">                                                                                                                          (<span class="number">2</span>, <span class="string">&#x27;Rose&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;13900112223&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 19, &quot;intro&quot;: &quot;青涩少女&quot;, &quot;gender&quot;: &quot;female&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">600</span>, <span class="string">&#x27;2023-05-19 21:00:23&#x27;</span>, <span class="string">&#x27;2023-06-19 21:00:23&#x27;</span>),</span><br><span class="line">                                                                                                                          (<span class="number">3</span>, <span class="string">&#x27;Hope&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;13900112222&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 25, &quot;intro&quot;: &quot;上进青年&quot;, &quot;gender&quot;: &quot;male&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">100000</span>, <span class="string">&#x27;2023-06-19 22:37:44&#x27;</span>, <span class="string">&#x27;2023-06-19 22:37:44&#x27;</span>),</span><br><span class="line">                                                                                                                          (<span class="number">4</span>, <span class="string">&#x27;Thomas&#x27;</span>, <span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;17701265258&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 29, &quot;intro&quot;: &quot;伏地魔&quot;, &quot;gender&quot;: &quot;male&quot;&#125;&#x27;</span>, <span class="number">1</span>, <span class="number">800</span>, <span class="string">&#x27;2023-06-19 23:44:45&#x27;</span>, <span class="string">&#x27;2023-06-19 23:44:45&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>在application.yml中设置数据库连接相关信息</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line"><span class="comment">#    url: jdbc:mysql://127.0.0.1:3306/mp?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/mp</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置mybatis的日志信息，指定输出至控制台</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.example:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss</span></span><br></pre></td></tr></table></figure>

<p>设置pom.xml配置信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">3.1</span><span class="number">.6</span>&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mp-demo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;<span class="number">17</span>&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-j&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;<span class="literal">true</span>&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.5</span><span class="number">.3</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;excludes&gt;</span><br><span class="line">                        &lt;exclude&gt;</span><br><span class="line">                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                        &lt;/exclude&gt;</span><br><span class="line">                    &lt;/excludes&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>设置Mapper</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//public interface UserMapper extends BaseMapper&lt;User&gt; &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">queryUserById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">queryUserByIds</span><span class="params">(<span class="meta">@Param(&quot;ids&quot;)</span> List&lt;Long&gt; ids)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>设置User实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">//用户id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//注册手机号</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">//详细信息</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">    <span class="comment">//使用状态（1正常2冻结）</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编写UserMapper.xml实现接口的sql语句</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.example.mapper.UserMapper&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;saveUser&quot;</span> parameterType=<span class="string">&quot;com.example.pojo.User&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">user</span><span class="params">(id, username, password, phone, info, balance)</span></span><br><span class="line">        values (#&#123;id&#125;, #&#123;username&#125;, #&#123;password&#125;, #&#123;phone&#125;, #&#123;info&#125;, #&#123;balance&#125;)</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line">    &lt;update id=<span class="string">&quot;updateUser&quot;</span> parameterType=<span class="string">&quot;com.example.pojo.User&quot;</span>&gt;</span><br><span class="line">        update user</span><br><span class="line">        &lt;set&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;username != null&quot;</span>&gt;</span><br><span class="line">                username = #&#123;username&#125;,</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;password != null&quot;</span>&gt;</span><br><span class="line">                password = #&#123;password&#125;,</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;phone != null&quot;</span>&gt;</span><br><span class="line">                phone = #&#123;phone&#125;,</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;info != null&quot;</span>&gt;</span><br><span class="line">                info = #&#123;info&#125;,</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null&quot;</span>&gt;</span><br><span class="line">                status = #&#123;status&#125;,</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;balance != null&quot;</span>&gt;</span><br><span class="line">                balance = #&#123;balance&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;/set&gt;</span><br><span class="line">        <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id&#125;;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line">    &lt;delete id=<span class="string">&quot;deleteUser&quot;</span> parameterType=<span class="string">&quot;com.example.pojo.User&quot;</span>&gt;</span><br><span class="line">        delete</span><br><span class="line">        from user</span><br><span class="line">        <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id&#125;</span><br><span class="line">    &lt;/delete&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryUserById&quot;</span> resultType=<span class="string">&quot;com.example.pojo.User&quot;</span>&gt;</span><br><span class="line">        select *</span><br><span class="line">        from user</span><br><span class="line">        <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;queryUserByIds&quot;</span> resultType=<span class="string">&quot;com.example.pojo.User&quot;</span>&gt;</span><br><span class="line">        select * from user</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">&quot;ids != null&quot;</span>&gt;</span><br><span class="line">            where id in</span><br><span class="line">            &lt;foreach collection=<span class="string">&quot;ids&quot;</span> open=<span class="string">&quot;(&quot;</span> close=<span class="string">&quot;)&quot;</span> item=<span class="string">&quot;id&quot;</span> separator=<span class="string">&quot;,&quot;</span>&gt;</span><br><span class="line">                #&#123;id&#125;</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        LIMIT <span class="number">10</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在单元测试中编写相应的测试方法完成测试案例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MpDemoApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="comment">//        user.setId(1L); // 假设ID是自动生成的，这里只是示例</span></span><br><span class="line">        user.setUsername(<span class="string">&quot;TestUser&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;password123&quot;</span>);</span><br><span class="line">        user.setPhone(<span class="string">&quot;1234567890&quot;</span>);</span><br><span class="line">        user.setInfo(<span class="string">&quot;&#123;\&quot;age\&quot;:30,\&quot;gender\&quot;:\&quot;male\&quot;&#125;&quot;</span>);</span><br><span class="line">        user.setBalance(<span class="number">1000</span>);</span><br><span class="line">        userMapper.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDeleteUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 假设要删除的用户ID为1</span></span><br><span class="line">        userMapper.deleteUser(<span class="number">5L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testUpdateUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">1L</span>); <span class="comment">// 更新ID为1的用户</span></span><br><span class="line">        user.setUsername(<span class="string">&quot;UpdatedUser&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;newPassword123&quot;</span>);</span><br><span class="line">        user.setPhone(<span class="string">&quot;0987654321&quot;</span>);</span><br><span class="line">        user.setInfo(<span class="string">&quot;&#123;\&quot;age\&quot;:31,\&quot;gender\&quot;:\&quot;male\&quot;&#125;&quot;</span>);</span><br><span class="line"><span class="comment">//        user.setBalance(1500);</span></span><br><span class="line">        user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        userMapper.updateUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQueryUserById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 查询ID为1的用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.queryUserById(<span class="number">5L</span>);</span><br><span class="line">        log.info(String.valueOf(user));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQueryUserByIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 查询ID为1和2的用户</span></span><br><span class="line">        List&lt;Long&gt; ids = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.queryUserByIds(ids);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="快速开始MybatisPlus"><a href="#快速开始MybatisPlus" class="headerlink" title="快速开始MybatisPlus"></a>快速开始MybatisPlus</h2><p>我们要实现User表的CRUD，需要以下几步：</p>
<ul>
<li>引入MybatisPlus依赖</li>
<li>定义Mapper</li>
</ul>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><p>MybatisPlus提供了starter，实现了自动Mybatis以及MybatisPlus的自动装配功能，坐标如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于这个starter包含了对mybatis的自动装配，因此完全可以替换掉Mybatis的starter。</p>
<p>最终，项目的依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mp-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="定义Mapper接口"><a href="#定义Mapper接口" class="headerlink" title="定义Mapper接口"></a>定义Mapper接口</h3><p>为了简化表CRUD，MybatisPlus提供了一个基础的BaseMapper接口，其中已经实现了表单的CRUD：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218132852524.png" alt="image-20240218132852524"></p>
<p>因此我们定义的Mapper只要实现了这个BaseMapper，就无需自己实现表单CRUD了。修改mp-demo中的com.example包下的UserMapper接口，让其继承BaseMapper；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt;&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用MP的sql方法完成功能</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MpDemoApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">6L</span>); <span class="comment">// 假设ID是自动生成的，这里只是示例</span></span><br><span class="line">        user.setUsername(<span class="string">&quot;TestUser2&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;password123&quot;</span>);</span><br><span class="line">        user.setPhone(<span class="string">&quot;1234567890&quot;</span>);</span><br><span class="line">        user.setInfo(<span class="string">&quot;&#123;\&quot;age\&quot;:30,\&quot;gender\&quot;:\&quot;male\&quot;&#125;&quot;</span>);</span><br><span class="line">        user.setBalance(<span class="number">1000</span>);</span><br><span class="line">        user.setCreateTime(LocalDateTime.now());</span><br><span class="line">        user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testDeleteUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 假设要删除的用户ID为1</span></span><br><span class="line">        userMapper.deleteById(<span class="number">5L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testUpdateUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setId(<span class="number">1L</span>); <span class="comment">// 更新ID为1的用户</span></span><br><span class="line">        user.setUsername(<span class="string">&quot;UpdatedUser&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;newPassword123&quot;</span>);</span><br><span class="line">        user.setPhone(<span class="string">&quot;0987654321&quot;</span>);</span><br><span class="line">        user.setInfo(<span class="string">&quot;&#123;\&quot;age\&quot;:31,\&quot;gender\&quot;:\&quot;male\&quot;&#125;&quot;</span>);</span><br><span class="line">        user.setBalance(<span class="number">1500</span>);</span><br><span class="line">        user.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSelectById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 查询ID为1的用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(<span class="number">5L</span>);</span><br><span class="line">        log.info(String.valueOf(<span class="string">&quot;user = &quot;</span> + user));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQueryByIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 查询ID为1和2的用户</span></span><br><span class="line">        List&lt;Long&gt; ids = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>, <span class="number">4L</span>);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectBatchIds(ids);</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>使用MybatisPlus的基本步骤：</p>
<ol>
<li><p>引入MybatisPlus依赖，代替Mybatis依赖</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218155025974.png" alt="image-20240218155025974"></p>
</li>
<li><p>定义Mapper接口并集成BaseMapper</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218155032709.png" alt="image-20240218155032709"></p>
</li>
</ol>
<h2 id="常见注解"><a href="#常见注解" class="headerlink" title="常见注解"></a>常见注解</h2><p>MyBatisPlus通过扫描实体类，并基于反射获取实体类信息作为数据库表信息。</p>
<p><font color="red">MP是泛型，当输入具体的实体类时，会通过反射获取该实体类的相关信息。</font></p>
<p>默认约定的具体映射关系如下所示：</p>
<ul>
<li>类名驼峰命名，对应的表名是类名驼峰转下划线</li>
<li>表中名为id的字段作为主键</li>
<li>类名的属性驼峰命名，对应的表名字段是类名属性驼峰转下划线</li>
</ul>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218155556926.png" alt="image-20240218155556926"></p>
<p>如果没有遵循默认约定，要求显式用注解来指定相关规则</p>
<p>MybatisPlus中比较常见的几个注解如下：</p>
<ul>
<li><p>@TableName：用来指定表名（当实体类名和表名不符合规则时）</p>
</li>
<li><p>@TableId：用来指定表中的主键字段信息（当类名中不存在值为id的属性）</p>
<p>@TableId（value&#x3D;”id”, type&#x3D;…)，这里的type是IdType枚举类型</p>
<ul>
<li>AUTO：数据库自增长（数据库决定）</li>
<li>INPUT：通过set方法自行输入（用户决定）</li>
<li>ASSIGN_ID：分配ID，接口IdentifierGenerator的方法nextId来生成id，默认实现类为DefaultIdentifierGenerator雪花算法（默认方法）</li>
</ul>
</li>
<li><p>@TableField：用来指定表中的普通字段信息（使用场景如下）</p>
<ul>
<li>当成员变量名与数据库字段名不一致</li>
<li>当成员变量名以is开头，且是布尔值</li>
<li>当成员变量名与数据库关键字冲突</li>
<li>当成员变量不是数据库字段</li>
</ul>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218161312143.png" alt="image-20240218161312143"></p>
</li>
</ul>
<p><strong>总结</strong></p>
<p>MybatisPlus是如何获取实现CRUD的数据库表信息的？</p>
<blockquote>
<p> MP会根据你给的实体类信息，获取数据库的表信息，从而帮我们生成单表数据。</p>
<p>约定</p>
<ul>
<li>类的名称为表名下划线转驼峰</li>
<li>类的成员变量为字段名下划线转驼峰</li>
<li>类中名为id的成员变量作为主键</li>
</ul>
</blockquote>
<p>MybatisPlus的常见注解有哪些？</p>
<blockquote>
<ul>
<li>@TableName：指定表名称及相关配置</li>
<li>@TableId：指定id字段及相关配置</li>
<li>@TableField：指定普通字段及相关配置</li>
</ul>
</blockquote>
<p>IdType的常见类型有哪些?</p>
<blockquote>
<p>AUTO、ASSIGN（默认方式）、INPUT</p>
</blockquote>
<p>使用@TableField的常见场景是什么？</p>
<blockquote>
<ul>
<li>当成员变量名与数据库字段名不一致</li>
<li>当成员变量名以is开头，且是布尔值</li>
<li>当成员变量名与数据库关键字冲突</li>
<li>当成员变量不是数据库字段</li>
</ul>
</blockquote>
<h2 id="常见配置"><a href="#常见配置" class="headerlink" title="常见配置"></a>常见配置</h2><p>在application.yml中添加MybatisPlus的配置项。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218164921377.png" alt="image-20240218164921377"></p>
<p>MybatisPlus的配置项继承了Mybatis原生配置和自己特有的配置，例如：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.itheima.mp.domain.po</span>  <span class="comment"># 别名扫描包</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">&quot;classpath*:/mapper/**/*.xml&quot;</span> <span class="comment"># Mapper.xml文件地址，当前这个是默认值。</span></span><br><span class="line">  <span class="string">configuration：</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span> <span class="comment"># 是否开启下划线和驼峰的映射</span></span><br><span class="line">    <span class="attr">cache-enable:</span> <span class="string">falase</span> <span class="comment"># 是否开启二级缓存</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># id为雪花算法生成</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span> <span class="comment"># 更新策略：只更新非空字段</span></span><br></pre></td></tr></table></figure>

<ul>
<li>type-aliases-package，给类名起别称，以后不用写全类名，直接写简化名</li>
<li>mapper-locations：mapper.xml的文件地址默认值（mp适合单表查询，如果是多表查询，还是需要mybatis，允许用户通过xml自定义sql语句实现多表查询）</li>
<li>map-underscore-to-camel-case: true # 是否开启下划线和驼峰的映射    </li>
<li>cache-enable: falase # 是否开启二级缓存</li>
<li>id-type: assign_id # id为雪花算法生成（相当于修改TableId的type的默认值）</li>
<li>update-strategy: not_null # 更新策略：只更新非空字段</li>
</ul>
<p>MyBatisPlus使用的基本流程是什么？</p>
<ol>
<li>引入起步依赖</li>
<li>自定义Mapper基础BaseMapper</li>
<li>在实体类上添加注解声明 表信息</li>
<li>在application.yml中根据需要添加配置信息</li>
</ol>
<h1 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h1><h2 id="条件构造器"><a href="#条件构造器" class="headerlink" title="条件构造器"></a>条件构造器</h2><p>MyBatisPlus支持各种复杂的where条件，可以满足日常开发的所有需求。</p>
<p>Wrapper就是条件构造器。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218172927436.png" alt="image-20240218172927436"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218172950865.png" alt="image-20240218172950865"></p>
<p>其中的AbstractWrapper内容如下</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218173036392.png" alt="image-20240218173036392"></p>
<p>querywrapper内容（查询条件相关）</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218173210559.png" alt="image-20240218173210559"></p>
<p>updatewrapper内容（set部分）</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218173237833.png" alt="image-20240218173237833"></p>
<h3 id="案例：基于QueryWrapper的查询"><a href="#案例：基于QueryWrapper的查询" class="headerlink" title="案例：基于QueryWrapper的查询"></a>案例：基于QueryWrapper的查询</h3><p>需求：</p>
<ol>
<li><p>查询出名字中带o的，存款大于等于1000元的人的id、username、info、balance字段</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> id,username,info,balance <span class="keyword">from</span> tb_user <span class="keyword">where</span> username <span class="keyword">like</span> <span class="string">&#x27;%o%&#x27;</span> <span class="keyword">and</span> balance <span class="operator">&gt;=</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testQueryWrapper</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1.构建查询条件</span></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;()</span><br><span class="line">        .select(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;username&quot;</span>,<span class="string">&quot;info&quot;</span>,<span class="string">&quot;balance&quot;</span>)</span><br><span class="line">        .like(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;o&quot;</span>)</span><br><span class="line">        .ge(<span class="string">&quot;balance&quot;</span>,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.查询</span></span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line"></span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新用户名为jack的用户的余额为2000</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> tb_user <span class="keyword">set</span> balance <span class="operator">=</span> <span class="number">2000</span> <span class="keyword">where</span> username <span class="operator">=</span> jack;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateByQueryWrapper</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 待更新的数据</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setBalance(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 更新的条件</span></span><br><span class="line">    QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;User&gt;().eq(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;jack&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 执行更新</span></span><br><span class="line">    userMapper.update(user,wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="案例：基于UpdateWrapper的更新"><a href="#案例：基于UpdateWrapper的更新" class="headerlink" title="案例：基于UpdateWrapper的更新"></a>案例：基于UpdateWrapper的更新</h3><p>需求：更新id为1，2，4的用户的余额，扣200</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> tb_user <span class="keyword">set</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">200</span> <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateWrapper</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;Long&gt; ids = List.of(<span class="number">1L</span>,<span class="number">2L</span>,<span class="number">4L</span>);</span><br><span class="line"></span><br><span class="line">    UpdateWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;User&gt;()</span><br><span class="line">        .setSql(<span class="string">&quot;balance = balance - 200&quot;</span>)</span><br><span class="line">        .in(<span class="string">&quot;id&quot;</span>,ids);</span><br><span class="line"></span><br><span class="line">    userMapper.update(<span class="literal">null</span>,wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="案例：基于LambdaQueryWrapper的查询"><a href="#案例：基于LambdaQueryWrapper的查询" class="headerlink" title="案例：基于LambdaQueryWrapper的查询"></a>案例：基于LambdaQueryWrapper的查询</h3><p><font color="red">LambdaQueryWrapper防止硬编码，确保select语句传入的是函数而不是具体的值。</font></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testLambdaQueryWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.构建查询条件</span></span><br><span class="line">    LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;()</span><br><span class="line">        .select(User::getId, User::getUsername, User::getInfo, User::getBalance)</span><br><span class="line">        .like(User::getUsername, <span class="string">&quot;o&quot;</span>)</span><br><span class="line">        .ge(User::getBalance, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.查询</span></span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line"></span><br><span class="line">    users.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>条件构造器的用法：</p>
<ul>
<li>QueryWrapper和LambdaQueryWrapper通常是用来构建select、delete、update和where条件部分</li>
<li>UpdateWrapper和LambdaUpdateWrapper通常只有在set语句比较特殊才使用</li>
<li><font color="red">尽量使用LamdbaQueryWrapper和LambdaUpdateWrapper，避免硬编码</font></li>
</ul>
<h2 id="自定义SQL"><a href="#自定义SQL" class="headerlink" title="自定义SQL"></a>自定义SQL</h2><p>我们可以利用MyBatisPlus中的wrapper来构建复杂的where条件，然后自己定义SQL语句中剩下的部分。</p>
<p>案例：自定义SQL</p>
<p>需求：将id在指定范围的用户（例如1，2，4）的余额扣减指定值。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateBalanceByIds&quot;</span>&gt;</span></span><br><span class="line">	UPDATE tb_user</span><br><span class="line">    SET balance = balance - #&#123;amount&#125;</span><br><span class="line">    WHERE id in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">seperator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">end</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">    	#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateWrapper</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Long&gt; ids = List.of(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">4L</span>);</span><br><span class="line"></span><br><span class="line">    UpdateWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;User&gt;()</span><br><span class="line">        .setSql(<span class="string">&quot;balance = balance - 200&quot;</span>)</span><br><span class="line">        .in(<span class="string">&quot;id&quot;</span>, ids);</span><br><span class="line"></span><br><span class="line">    userMapper.update(<span class="literal">null</span>, wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/mybatisplus-day01/image-20240218181322133.png" alt="image-20240218181322133"></p>
<p>对于复杂的sql语句，wrapper不一定能够完全实现，这个时候可以用MyBatisPlus的wrapper来构建复杂的Where条件，然后自己自定义SQL语句中剩下的部分。</p>
<ol>
<li><p>基于Wrapper构建where条件</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218182806514.png" alt="image-20240218182806514"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Long&gt; ids = List.of(<span class="number">1L</span>,<span class="number">2L</span>,<span class="number">4L</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">amount</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.构建条件</span></span><br><span class="line">LambdaQueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;User&gt;.in(User::getId,ids);</span><br><span class="line"><span class="comment">//2.自定义SQL方法调用</span></span><br><span class="line">userMapper.updateBalanceByIds(wrapper,amount);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在mapper方法参数中用Param注解声明wrapper变量名称，必须是ew</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218182832870.png" alt="image-20240218182832870"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateBalanceByIds</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> LambdaQueryWrapper&lt;User&gt; wrapper, <span class="meta">@Param(&quot;amount&quot;)</span> <span class="type">int</span> amount)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义SQL，并使用Wrapper条件</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218182855128.png" alt="image-20240218182855128"></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span> = <span class="string">&quot;updateBalanceByIds&quot;</span>&gt;</span></span><br><span class="line">	UPDATE tb_user SET balance = balance - #&#123;amount&#125; $&#123;ew.customSqlSegment&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Service接口"><a href="#Service接口" class="headerlink" title="Service接口"></a>Service接口</h2><h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p><strong>service接口汇总</strong></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218183050358.png" alt="image-20240218183050358"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218210152819.png" alt="image-20240218210152819"></p>
<p>原来我们是定义UserService接口，再用UserServiceImpl继承和实现其接口方法。</p>
<p>现在我们让UserService接口去继承IService接口，（IService接口定义了许多有用的service层的方法），再让UserServiceImpl类去继承ServiceImpl类，实现UserService接口（ServiceImpl类实现了IService接口定义的所有方法），通过继承ServiceImpl类，UserServiceImpl拥有和实现了许多IService接口定义的方法，以至于他也能够实现UserService接口的所有方法。</p>
<ol>
<li><p>让UserService接口去继承IService接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span>  <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>让UserServiceImpl类去继承ServiceImpl类，实现UserService接口（泛型，要指定对应的mapper类UserMapper和要操作的实体类User）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper,User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试用例测试service类功能（注意，这个时候已经实现了不用mapper层，直接用service层即可进行数据库操作）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.jupiter.api.Assertions.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IUserServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="comment">//        user.setId(1L); // 更新ID为1的用户</span></span><br><span class="line">        user.setUsername(<span class="string">&quot;UpdatedUser&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;newPassword123&quot;</span>);</span><br><span class="line">        user.setPhone(<span class="string">&quot;0987654321&quot;</span>);</span><br><span class="line">        user.setInfo(<span class="string">&quot;&#123;\&quot;age\&quot;:31,\&quot;gender\&quot;:\&quot;male\&quot;&#125;&quot;</span>);</span><br><span class="line">        user.setBalance(<span class="number">1500</span>);</span><br><span class="line">        user.setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        userService.save(user);</span><br><span class="line"><span class="comment">//        userMapper.updateById(user);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQuery</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;User&gt; users = userService.listByIds(List.of(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">4L</span>));</span><br><span class="line">        users.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>MP的Service接口使用流程是怎么样的？</p>
<ul>
<li><p>自定义Service接口继承IService接口。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218214647313.png" alt="image-20240218214647313"></p>
</li>
<li><p>自定义Service实现类，实现自定义接口并继承ServiceImpl类。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240218214653369.png" alt="image-20240218214653369"></p>
</li>
</ul>
</li>
</ol>
<h3 id="基础业务接口"><a href="#基础业务接口" class="headerlink" title="基础业务接口"></a>基础业务接口</h3><p>需求：基于Restful风格实现下面的接口：</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>接口</th>
<th>请求方式</th>
<th>请求路径</th>
<th>请求参数</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>新增用户</td>
<td>POST</td>
<td>&#x2F;users</td>
<td>用户表单实体</td>
<td>无</td>
</tr>
<tr>
<td>2</td>
<td>删除用户</td>
<td>DELETE</td>
<td>&#x2F;users&#x2F;{id}</td>
<td>用户id</td>
<td>无</td>
</tr>
<tr>
<td>3</td>
<td>根据id查询用户</td>
<td>GET</td>
<td>&#x2F;users&#x2F;{id}</td>
<td>用户id</td>
<td>用户V0</td>
</tr>
<tr>
<td>4</td>
<td>根据id批量查询</td>
<td>GET</td>
<td>&#x2F;users</td>
<td>用户id集合</td>
<td>用户V0集合</td>
</tr>
<tr>
<td>5</td>
<td>根据id扣减余额</td>
<td>GET</td>
<td>&#x2F;users&#x2F;{id}&#x2F;deduction&#x2F;{money}</td>
<td>用户id<br>扣减金额</td>
<td>无</td>
</tr>
</tbody></table>
<p>首先，在项目pom.xml中引入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--HuTool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--web--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在application.yaml中配置swagger信息</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">用户管理接口文档</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;用户管理接口文档&quot;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">zhanghuyi@itcast.cn</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">虎哥</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.example.controller</span></span><br></pre></td></tr></table></figure>

<p>然后，接口需要两个实体：</p>
<ul>
<li>UserFormDTO：代表新增时的用户表单</li>
<li>UserVO：代表查询的返回结果</li>
</ul>
<p>首先是UserFormDTO</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户表单实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFormDTO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;密码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;注册手机号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;详细信息，JSON风格&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;账户余额&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后是UserVO：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户VO实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserVO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;详细信息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;使用状态（1正常 2冻结）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;账户余额&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后，按照Restful风格编写Controller接口方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.dto.UserFormDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiParam;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Api(tags=&quot;用户管理接口&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span>  <span class="comment">//对那些对象初始化需要初始的成员变量初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IUserService userService;  <span class="comment">//final代表它是常量，必须在类的对象初始化时将该成员变量初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;新增用户接口&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> UserFormDTO userFormDTO)</span>&#123; <span class="comment">//RequestBody接收浏览器发送来的数据</span></span><br><span class="line">        <span class="comment">// 1.把DTO拷贝到POJO</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  BeanUtil.copyProperties(userFormDTO, User.class);  <span class="comment">//使用hutool工具中的静态方法将DTO转化为实体类</span></span><br><span class="line">        <span class="comment">// 2.新增</span></span><br><span class="line">        userService.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;删除用户接口&quot;)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUserById</span><span class="params">(<span class="meta">@ApiParam(&quot;用户id&quot;)</span> <span class="meta">@PathVariable</span> Long id)</span>&#123; <span class="comment">//PathVariable接收浏览器页面请求的id</span></span><br><span class="line">        userService.removeById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据ID查询用户接口&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> UserVO <span class="title function_">queryUserById</span><span class="params">(<span class="meta">@ApiParam(&quot;用户id&quot;)</span> <span class="meta">@PathVariable</span> Long id)</span>&#123; <span class="comment">//PathVariable接收浏览器页面请求的id</span></span><br><span class="line">        <span class="comment">//1.查询用户POJO</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.把PO拷贝到VO</span></span><br><span class="line">        <span class="keyword">return</span> BeanUtil.copyProperties(user,UserVO.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据ID批量查询用户接口&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserVO&gt; <span class="title function_">queryUserById</span><span class="params">(<span class="meta">@ApiParam(&quot;用户id集合&quot;)</span> <span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; ids)</span>&#123; <span class="comment">//RequestParam代表数组</span></span><br><span class="line">        <span class="comment">//1.查询用户集合POJO</span></span><br><span class="line">        List&lt;User&gt; users = userService.listByIds(ids);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.把PO拷贝到VO</span></span><br><span class="line">        <span class="keyword">return</span> BeanUtil.copyToList(users,UserVO.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复杂业务接口"><a href="#复杂业务接口" class="headerlink" title="复杂业务接口"></a>复杂业务接口</h3><p>扣减金额：先根据status判断是否执行扣减操作，再根据balance判断金额是否足够扣减</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219115537636.png" alt="image-20240219115537636"></p>
<p>controller层定义相应的实现方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;扣减用户余额接口&quot;)</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/&#123;id&#125;/deduction/&#123;money&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductMoneyById</span><span class="params">(<span class="meta">@ApiParam(&quot;用户id&quot;)</span> <span class="meta">@PathVariable(&quot;id&quot;)</span> Long id,</span></span><br><span class="line"><span class="params">                            <span class="meta">@ApiParam(&quot;扣减的金额&quot;)</span> <span class="meta">@PathVariable(&quot;money&quot;)</span> Integer money)</span>&#123; <span class="comment">//RequestParam代表数组</span></span><br><span class="line"></span><br><span class="line">    userService.deductBalance(id, money);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service接口创建对应的方法头</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span>  <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer money)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service实现类实现该方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper,User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer money)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 查询用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 校验用户状态</span></span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span> || user.getStatus() != <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户状态异常！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 校验余额是否充足</span></span><br><span class="line">        <span class="keyword">if</span>(user.getBalance() &lt; money)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户余额不足！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 扣减余额 update tb_user set balance = balance = ?</span></span><br><span class="line">        baseMapper.deductBalance(id,money);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mapper层的UserMapper实现deductBalance方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.update.LambdaUpdateWrapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt;&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateBalanceByIds</span><span class="params">(<span class="meta">@Param(&quot;ew&quot;)</span> LambdaUpdateWrapper&lt;User&gt; wrapper,<span class="meta">@Param(&quot;amount&quot;)</span> <span class="type">int</span> amount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;UPDATE tb_user SET balance = balance - #&#123;money&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id,<span class="meta">@Param(&quot;money&quot;)</span> Integer money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行项目</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219124424902.png" alt="image-20240219124424902"></p>
<p>访问页面localhost:8080&#x2F;doc.html#name</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219124457932.png" alt="image-20240219124457932"></p>
<p>测试接口是否正常运行</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219132003865.png" alt="image-20240219132003865"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219132013295.png" alt="image-20240219132013295"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219132043263.png" alt="image-20240219132043263"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219132123079.png" alt="image-20240219132123079"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219132140012.png" alt="image-20240219132140012"></p>
<h3 id="Lambda方法"><a href="#Lambda方法" class="headerlink" title="Lambda方法"></a>Lambda方法</h3><p>案例：IService的Lambda查询</p>
<p>需求：实现一个根据复杂条件查询用户的接口，查询条件如下：</p>
<ul>
<li>name：用户名关键字，可以为空</li>
<li>status：用户状态，可以为空</li>
<li>minBalance：最小余额，可以为空</li>
<li>maxBalance：最大余额，可以为空</li>
</ul>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219133315138.png" alt="image-20240219133315138"></p>
<p><strong>controller层</strong>（将传入的数据封装到UserQuery类中）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.query;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户查询条件实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名关键字&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户状态：1-正常，2-冻结&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最小值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer minBalance;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最大值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxBalance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>controller层</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据复杂条件查询用户接口&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title function_">queryUsers</span><span class="params">(UserQuery query)</span>&#123;</span><br><span class="line">    <span class="comment">//1. 查询用户PO</span></span><br><span class="line">    List&lt;User&gt; users = userService.queryUsers(query.getName(),query.getStatus(),query.getMinBalance(),query.getMaxBalance());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 把PO拷贝到VO</span></span><br><span class="line">    <span class="keyword">return</span> BeanUtil.copyToList(users,UserVO.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在Service接口层声明对应的方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span>  <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer money)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">queryUsers</span><span class="params">(String name, Integer status, Integer minBalance, Integer maxBalance)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在UserService接口实现类中实现对应的方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">queryUsers</span><span class="params">(String name, Integer status, Integer minBalance, Integer maxBalance)</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; users = lambdaQuery()  <span class="comment">//使用lambdaQuery()方法实现对应的增删改查操作</span></span><br><span class="line">            .like(name != <span class="literal">null</span>, User::getUsername, name)</span><br><span class="line">            .eq(status != <span class="literal">null</span>, User::getStatus, status)</span><br><span class="line">            .ge(minBalance != <span class="literal">null</span>, User::getBalance, minBalance)</span><br><span class="line">            .le(maxBalance != <span class="literal">null</span>, User::getBalance, maxBalance)</span><br><span class="line">            .list();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>案例：IService的Lambda更新</p>
<p>需求：改造根据id修改用户余额的接口，查询条件如下：</p>
<ul>
<li><p>完成对用户状态校验</p>
</li>
<li><p>完成对用户余额校验</p>
</li>
<li><p>如果扣减后余额为0，则将用户status修改为冻结状态</p>
</li>
</ul>
<p><strong>修改UserService接口实现类中实现对应的方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductBalance</span><span class="params">(Long id, Integer money)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 查询用户</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 校验用户状态</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span> || user.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户状态异常！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 校验余额是否充足</span></span><br><span class="line">    <span class="keyword">if</span> (user.getBalance() &lt; money) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户余额不足！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">remainBalance</span> <span class="operator">=</span> user.getBalance() - money;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 扣减余额 update tb_user set balance = balance = ?</span></span><br><span class="line">    lambdaUpdate()</span><br><span class="line">        .set(User::getBalance,remainBalance)</span><br><span class="line">        .set(remainBalance &lt;= <span class="number">0</span>,User::getStatus,<span class="number">2</span>)</span><br><span class="line">        .eq(User::getId,id)</span><br><span class="line">        .update();  <span class="comment">//加update实行sql操作</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="批量新增"><a href="#批量新增" class="headerlink" title="批量新增"></a>批量新增</h3><p>需求：批量插入10万条用户数据，并作出对比：</p>
<ul>
<li>普通for循环插入</li>
<li>IService的批量插入</li>
<li>开启rewriteBatchedStatements&#x3D;true参数</li>
</ul>
<p>在test目录下IUserServiceTest测试类中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveOneByOne</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">b</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            userService.save(buildUser(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">e</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;耗时：&quot;</span> + (e - b));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveBatch</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//我们每次批量插入1000条件，插入100次即10万条数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.准备一个容器为1000的集合</span></span><br><span class="line">        ArrayList&lt;User&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">b</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//2.添加一个user</span></span><br><span class="line">            list.add(buildUser(i));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.每100条批量插入一次</span></span><br><span class="line">            <span class="keyword">if</span>(i % <span class="number">1000</span> == <span class="number">0</span>)&#123;</span><br><span class="line">                userService.saveBatch(list);</span><br><span class="line">                list.clear(); <span class="comment">//将集合再次清空</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">e</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;耗时：&quot;</span> + (e - b));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>普通for循环插入</strong></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219150341222.png" alt="image-20240219150341222"></p>
<p><strong>IService的批量插入</strong></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219150621143.png" alt="image-20240219150621143"></p>
<p><strong>开启rewriteBatchedStatements&#x3D;true</strong>参数</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219150701124.png" alt="image-20240219150701124"></p>
<p>在application.yml配置中在数据库配置项spring.datasource.url后加上rewriteBatchedStatements&#x3D;true</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219151256254.png" alt="image-20240219151256254"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219151416654.png" alt="image-20240219151416654"></p>
<p>批处理方案：</p>
<ul>
<li>普通for循环逐条插入，速度极差，不推荐</li>
<li>MP的批量新增，基于预编译的批处理，性能不错</li>
<li>配置jdbc参数，开rewriteBatchedStatements&#x3D;true，性能最好</li>
</ul>
<h1 id="扩展功能"><a href="#扩展功能" class="headerlink" title="扩展功能"></a>扩展功能</h1><h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><p>目前MP的使用方法</p>
<ol>
<li><p>引入对应的MP依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>准备实体类（设置TableName将实体类与数据库表做映射）</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219211202183.png" alt="image-20240219211202183"></p>
</li>
<li><p>设置mapper接口继承BaseMapper&lt;User&gt;接口，指定泛型类型</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219211348617.png" alt="image-20240219211348617"></p>
</li>
<li><p>设置service接口继承IService&lt;User&gt;接口，指定泛型类型</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219211501734.png" alt="image-20240219211501734"></p>
</li>
<li><p>编写Service实现类UserServiceImpl，继承ServiceImpl&lt;UserMapper，User&gt;，同时实现IUserService接口</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219211714367.png" alt="image-20240219211714367"></p>
</li>
</ol>
<p>代码简化操作</p>
<ol>
<li><p>下载MyBatisPlus插件</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219212822585.png" alt="image-20240219212822585"></p>
</li>
<li><p>连接数据库</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219225926496.png" alt="image-20240219225926496"></p>
</li>
<li><p>代码生成设置界面</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219225448458.png" alt="image-20240219225448458"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219230651368.png" alt="image-20240219230651368"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240219233633273.png" alt="image-20240219233633273"></p>
</li>
</ol>
<h2 id="静态工具"><a href="#静态工具" class="headerlink" title="静态工具"></a>静态工具</h2><p><img src="/2024/02/18/mybatisplus-day01/image-20240219233757262.png" alt="image-20240219233757262"></p>
<p>与IService接口基本一致，但是Db是静态方法。</p>
<p>IService接口是非静态的，需要自定义接口去继承它，同时还要创建类实现该接口的方法。而静态的方法是没法读取到类上的泛型，因而无法得到实体类的类型，进而无法获知表信息。因此它的方法还要穿一个额外的参数，Class&lt;T&gt;，即实体类的字节码。只有传了这个，才能用反射拿到实体类的相关信息，从而得到注解上的类名，表名，才能实现增删改查。</p>
<p>案例：静态工具查询</p>
<p>需求：</p>
<ol>
<li>改造根据id查询用户的接口，查询用户的同时，查询出用户对应的所有地址</li>
<li>改造根据id批量查询用户的接口，查询用户的同时，查询出用户对应的所有地址</li>
<li>实现根据用户id查询收货地址功能，需要验证用户状态，冻结用户抛出异常（练习）</li>
</ol>
<p>需求1：改造根据id查询用户的接口，查询用户的同时，查询出用户对应的所有地址</p>
<ol>
<li><p>添加AddressVO类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 虎哥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2023-07-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;收货地址VO&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddressVO</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;省&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;市&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;县/区&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String town;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;手机&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;详细地址&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;联系人&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String contact;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否是默认 1默认 0否&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isDefault;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;备注&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String notes;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给UserVO中添加成员变量：用户的收货地址集合</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户VO实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserVO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;详细信息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;使用状态（1正常 2冻结）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;账户余额&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户的收货地址&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AddressVO&gt; address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改UserController中的queryUserById方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据ID查询用户接口&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> UserVO <span class="title function_">queryUserById</span><span class="params">(<span class="meta">@ApiParam(&quot;用户id&quot;)</span> <span class="meta">@PathVariable</span> Long id)</span>&#123; <span class="comment">//PathVariable接收浏览器页面请求的id</span></span><br><span class="line">    <span class="keyword">return</span> userService.queryUserAndAddressById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在IUserService中声明queryUserAndAddressById方法，UserServiceImpl中实现queryUserAndAddressById方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.toolkit.Db;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.Address;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.AddressVO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserVO <span class="title function_">queryUserAndAddressById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 查询用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getById(id);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span> || user.getStatus() == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户状态异常！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 查询地址</span></span><br><span class="line">        List&lt;Address&gt; addresses = Db.lambdaQuery(Address.class).eq(Address::getUserId, id).list();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 封装VO</span></span><br><span class="line">        <span class="comment">//3.1 转User的PO为VO</span></span><br><span class="line">        <span class="type">UserVO</span> <span class="variable">userVO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserVO.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.2 转地址VO</span></span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isNotEmpty(addresses))&#123;</span><br><span class="line">            List&lt;AddressVO&gt; addressVOList = BeanUtil.copyToList(addresses, AddressVO.class);</span><br><span class="line">            userVO.setAddress(addressVOList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在测试接口中测试对应的接口是否正确</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220000823092.png" alt="image-20240220000823092"></p>
</li>
</ol>
<p>需求2：改造根据id批量查询用户的接口，查询用户的同时，查询出用户对应的所有地址</p>
<ol>
<li><p>修改UserController中的queryUserById方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据ID批量查询用户接口&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="keyword">public</span> List&lt;UserVO&gt; <span class="title function_">queryUserById</span><span class="params">(<span class="meta">@ApiParam(&quot;用户id集合&quot;)</span> <span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; ids)</span>&#123; <span class="comment">//PathVariable接收浏览器页面请求的id</span></span><br><span class="line">    <span class="keyword">return</span> userService.queryUsersAndAddressesById(ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在IUserService中声明queryUsersAndAddressesById方法，UserServiceImpl中实现queryUsersAndAddressesById方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.toolkit.Db;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.Address;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.AddressVO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserVO&gt; <span class="title function_">queryUsersAndAddressesById</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 查询用户</span></span><br><span class="line">        List&lt;User&gt; users = listByIds(ids);</span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isEmpty(users))&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.查询地址</span></span><br><span class="line">        <span class="comment">//2.1 查询用户id集合</span></span><br><span class="line">        List&lt;Long&gt; userIds = users.stream().map(User::getId).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//2.2 根据用户id查询地址</span></span><br><span class="line">        List&lt;Address&gt; addresses = Db.lambdaQuery(Address.class).in(Address::getUserId, userIds).list();</span><br><span class="line">        <span class="comment">//2.3 转换地址VO</span></span><br><span class="line">        List&lt;AddressVO&gt; addressVOList = BeanUtil.copyToList(addresses, AddressVO.class);</span><br><span class="line">        <span class="comment">//2.4 地址集合分组处理，相同用户放到一个集合中</span></span><br><span class="line">        Map&lt;Long, List&lt;AddressVO&gt;&gt; addressMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isNotEmpty(addressVOList))&#123;</span><br><span class="line">            addressMap = addressVOList.stream().collect(Collectors.groupingBy(AddressVO::getUserId));<span class="comment">//用用户id分组</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 转换VO返回</span></span><br><span class="line">        List&lt;UserVO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(users.size());</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            <span class="comment">//3.1转换User的PO为VO</span></span><br><span class="line">            <span class="type">UserVO</span> <span class="variable">vo</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserVO.class);</span><br><span class="line">            list.add(vo);</span><br><span class="line">            <span class="comment">//3.2转换地址VO</span></span><br><span class="line">            vo.setAddress(addressMap.get(user.getId()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        // 1. 查询用户列表</span></span><br><span class="line"><span class="comment">//        List&lt;User&gt; users = lambdaQuery().in(User::getId, ids).list();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        // 2. 准备一个空的UserVO列表用于返回结果</span></span><br><span class="line"><span class="comment">//        List&lt;UserVO&gt; userVOList = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        // 3. 遍历用户列表，为每个用户查询地址并封装成UserVO</span></span><br><span class="line"><span class="comment">//        for (User user : users) &#123;</span></span><br><span class="line"><span class="comment">//            // 跳过状态为2的用户</span></span><br><span class="line"><span class="comment">//            if (user.getStatus() == 2) &#123;</span></span><br><span class="line"><span class="comment">//                continue;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            // 3.1 将User转换为UserVO</span></span><br><span class="line"><span class="comment">//            UserVO userVO = BeanUtil.copyProperties(user, UserVO.class);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            // 3.2 查询当前用户的地址列表</span></span><br><span class="line"><span class="comment">//            List&lt;Address&gt; addresses = Db.lambdaQuery(Address.class).eq(Address::getUserId, user.getId()).list();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            // 3.3 将地址列表转换为AddressVO列表</span></span><br><span class="line"><span class="comment">//            List&lt;AddressVO&gt; addressVOList = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">//            for (Address address : addresses) &#123;</span></span><br><span class="line"><span class="comment">//                AddressVO addressVO = BeanUtil.copyProperties(address, AddressVO.class);</span></span><br><span class="line"><span class="comment">//                addressVOList.add(addressVO);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            // 3.4 设置用户VO的地址信息</span></span><br><span class="line"><span class="comment">//            userVO.setAddress(addressVOList);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            // 3.5 将UserVO添加到结果列表中</span></span><br><span class="line"><span class="comment">//            userVOList.add(userVO);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return userVOList;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>在测试接口中测试对应的接口是否正确<img src="/2024/02/18/mybatisplus-day01/image-20240220002059865.png" alt="image-20240220002059865"></p>
</li>
</ol>
<h2 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h2><p>举例：淘宝购物后会形成订单， 在订单列表中有删除订单功能，在删除数据时，这个订单在后台的数据中并未真正被删除。</p>
<p><strong>逻辑删除</strong>就是基于代码逻辑模拟删除效果，但并不会真正删除数据。思路如下：</p>
<ul>
<li>在表中添加一个字段标记数据是否被删除</li>
<li>当删除数据时把标记置为1</li>
<li>查询时只查询标记为0的数据</li>
</ul>
<p>例如逻辑删除字段为deleted：</p>
<ul>
<li><p>删除操作：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220105031798.png" alt="image-20240220105031798"></p>
</li>
<li><p>查询操作</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220105156527.png" alt="image-20240220105156527"></p>
</li>
</ul>
<p>目前的MP它执行的操作语句不会额外在条件查询处加上这个判断，如果用逻辑删除原先的MP都不能用了。</p>
<p>Mybatis提供了逻辑删除功能，无需改变方法调用的方式，而是在底层帮我们自动修改CRUD的语句。我们要做的就是在application.yaml文件中配置逻辑删除的字段名称和值即可。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220105839937.png" alt="image-20240220105839937"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220105829649.png" alt="image-20240220105829649"></p>
<p>注意：</p>
<p>逻辑删除本身也有自己的问题，比如：</p>
<ul>
<li>会导致数据库表垃圾数据越来越多，影响查询效率</li>
<li>SQL中全都需要对逻辑删除字段做判断，影响查询效率</li>
</ul>
<p>因此，我不太推荐采用逻辑删除功能，如果数据不能删除，可以采用把数据迁移到其他表的方法。</p>
<h2 id="枚举处理器"><a href="#枚举处理器" class="headerlink" title="枚举处理器"></a>枚举处理器</h2><p>User类中有一个用户状态字段：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220110745823.png" alt="image-20240220110745823"></p>
<p>当状态数量过多时，对应的数字和状态越多，对编程的要求就更复杂，容易出错。</p>
<p>既然状态是有限数量的，可以用枚举来表示。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220111021894.png" alt="image-20240220111021894"></p>
<p>虽然用了枚举类型，但是我们的status状态还是Integer类型，这导致我们在做状态查询时用的还是数字。解决办法，使用UserStatus枚举类型的数据来表示状态。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220111232868.png" alt="image-20240220111232868"></p>
<p>这样操作虽然业务上方便了，但是我们后台的数据库表当中status字段的类型仍然是INT，它接受的仍然是数字。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220111540493.png" alt="image-20240220111540493"></p>
<p>Mybatis帮助我们实现了TypeHandler类，常见的POJO中实体类成员变量的类型它都有对应的处理器，因此它能自动实现Java数据类型与数据库类型的转换。其中就包括枚举类型处理器EnumOrdinalTypeHandler，然而，这个处理器对枚举类型的数据处理效果不是很好。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220111709228.png" alt="image-20240220111709228"></p>
<p>MP在此基础上做了进一步拓展，其中新增了MyBatisEnumTypeHandler处理器等等</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220111857384.png" alt="image-20240220111857384"></p>
<p>使用MyBatisEnumTypeHandler处理器可以将实体类中的枚举类型UserStatus转换为数据库表中的数字类型INT。具体实现操作如下：</p>
<ol>
<li><p>创建并标记枚举类型，在枚举类中对应的数据库字段的值上添加注释@EnumValue</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220113205152.png" alt="image-20240220113205152"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220112222477.png" alt="image-20240220112222477"></p>
</li>
<li><p>让枚举处理器生效，在application.yml中配置全局枚举处理器：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220112340573.png" alt="image-20240220112340573"></p>
</li>
<li><p>修改User和UserVo类成员变量status的类型由Integer为UserStatus。</p>
</li>
<li><p>加上@JsonValue注解，确保返回的是正常或冻结，而不是NORMAL或FROZEN；</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220113640238.png" alt="image-20240220113640238"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220113727515.png" alt="image-20240220113727515"></p>
</li>
</ol>
<p><strong>总结</strong></p>
<p>如何实现PO类中的枚举类型变量与数据库字段的转换？</p>
<ol>
<li><p>给枚举中的与数据库对应value值添加@EnumValue注解</p>
</li>
<li><p>在配置文件中配置的枚举处理器，实现类型转换</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220113838932.png" alt="image-20240220113838932"></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220113858908.png" alt="image-20240220113858908"></p>
</li>
</ol>
<h2 id="JSON处理器"><a href="#JSON处理器" class="headerlink" title="JSON处理器"></a>JSON处理器</h2><p>MP还额外提供了AbstarctJsonTypeHandler数据处理器，它用来解决数据库中的json数据类型与Java类型之间的转化。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220113944606.png" alt="image-20240220113944606"></p>
<p>数据库user表中有一个json类型的字段：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220114120948.png" alt="image-20240220114120948"></p>
<p>在Java中没有对应的json数据类型，默认使用的是String，mybatis会自动实现json和string的处理。这会导致一个问题，如果我们需要获取string中的键值对呢？一个比较好的处理办法是创建该JSON数据对应的实体类，如下所示：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220114651876.png" alt="image-20240220114651876"></p>
<p>成员变量info由string转换为自定义的UserInfo类。这样做可以实现info数据内部查询，但随着而来的是Mybatis并未实现UserInfo类和json格式的数据转换。这时候就要用到<font color="red">MP提供的类型处理器</font>。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220115012276.png" alt="image-20240220115012276"></p>
<p>如上所示，实体类User嵌套了实体类UserInfo。并且在其上方加入了@TableField字段，指定了typeHandler，确定了处理该字段的类型处理器。<font color="red">然而这种实体类的嵌套要求定义复杂的resultmap，如果不想要的话，就在Tablename加上属性autoResultMap &#x3D; false</font></p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220115508545.png" alt="image-20240220115508545"></p>
<p>实操</p>
<ol>
<li><p>创建UserInfo实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.po;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(staticName = &quot;of&quot;)</span>  <span class="comment">//加了staticName，可以通过静态方法UserInfo.of()创建对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String Intro;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改User成员变量对应信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.example.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;tb_user&quot;, autoResultMap = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">//用户id</span></span><br><span class="line">    <span class="meta">@TableId(type= IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户名</span></span><br><span class="line">    <span class="meta">@TableField(&quot;`username`&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//注册手机号</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">//详细信息</span></span><br><span class="line">    <span class="meta">@TableField(typeHandler = JacksonTypeHandler.class)</span></span><br><span class="line">    <span class="keyword">private</span> UserInfo info;</span><br><span class="line">    <span class="comment">//使用状态（1正常2冻结）</span></span><br><span class="line">    <span class="keyword">private</span> UserStatus status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="插件功能"><a href="#插件功能" class="headerlink" title="插件功能"></a>插件功能</h1><p>MybatisPlus提供的内置拦截器有下面这些：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>拦截器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>TenantLineInnerInterceptor</td>
<td>多租户插件</td>
</tr>
<tr>
<td>2</td>
<td>DynamicTableNameInnerInterceptor</td>
<td>动态表名插件</td>
</tr>
<tr>
<td>3</td>
<td>PaginationInnerInterceptor</td>
<td>分页插件</td>
</tr>
<tr>
<td>4</td>
<td>OptimisticLockerInnerInterceptor</td>
<td>乐观锁插件</td>
</tr>
<tr>
<td>5</td>
<td>IllegalSQLInnerInterceptor</td>
<td>SQL性能规范插件，检测并拦截垃圾SQL</td>
</tr>
<tr>
<td>6</td>
<td>BlockAttackInnerInterceptor</td>
<td>防止全表更新和删除的插件</td>
</tr>
</tbody></table>
<h2 id="分页插件基本用法"><a href="#分页插件基本用法" class="headerlink" title="分页插件基本用法"></a>分页插件基本用法</h2><p>首先，要在配置类中注册MybatisPlus的核心插件，同时添加分页插件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.exceptions.MybatisPlusException;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//声明方法，通过返回第三方类的对象实现IOC容器Bean对象的注入</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//1. 初始化核心插件</span></span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">//2. 添加分页插件</span></span><br><span class="line">        <span class="type">PaginationInnerInterceptor</span> <span class="variable">paginationInnerInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL);</span><br><span class="line">        paginationInnerInterceptor.setMaxLimit(<span class="number">1000L</span>); <span class="comment">//设置分页上限</span></span><br><span class="line">        interceptor.addInnerInterceptor(paginationInnerInterceptor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着，就可以使用分页的API了（IService，Db静态工具，LambdaQuery都有类似的分页工具）：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220132445037.png" alt="image-20240220132445037"></p>
<p> 它有个泛型E，E继承自IPage接口及其子类（Page和PageDTO），我们用的比较多的是Page对象。</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220133020397.png" alt="image-20240220133020397"></p>
<p>接着，就可以使用分页的API了：</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220133039514.png" alt="image-20240220133039514"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.OrderItem;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.UserInfo;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.jupiter.api.Assertions.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IUserServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testPageQuery</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//1.查询</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>, pageSize=  <span class="number">5</span>;</span><br><span class="line">        <span class="comment">//1.1 分页参数</span></span><br><span class="line">        Page&lt;User&gt; page = Page.of(pageNo,pageSize);</span><br><span class="line">        <span class="comment">//1.2排序参数，通过OrderItem来指定</span></span><br><span class="line">        page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;balance&quot;</span>,<span class="literal">true</span>));</span><br><span class="line">        <span class="comment">//1.3分页查询</span></span><br><span class="line">        Page&lt;User&gt; p = userService.page(page);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.总条数</span></span><br><span class="line">        System.out.println(<span class="string">&quot;total = &quot;</span> + p.getTotal());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 总页数</span></span><br><span class="line">        System.out.println(<span class="string">&quot;pages = &quot;</span> + p.getPages());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 分页数据</span></span><br><span class="line">        List&lt;User&gt; records = p.getRecords();</span><br><span class="line">        records.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="通用分页实体"><a href="#通用分页实体" class="headerlink" title="通用分页实体"></a>通用分页实体</h2><p>案例：简单分页查询案例</p>
<p>需求：遵循下面的接口规范，编写一个UserController接口，实现User的分页查询</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220134455782.png" alt="image-20240220134455782"></p>
<p>返回值</p>
<p><img src="/2024/02/18/mybatisplus-day01/image-20240220134554535.png" alt="image-20240220134554535"></p>
<p>实现操作</p>
<ol>
<li><p>创建PageQuery类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.query;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageSize;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortyBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否升序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isAsc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>让UserQuery继承PageQuery</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.query;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;用户查询条件实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserQuery</span> <span class="keyword">extends</span> <span class="title class_">PageQuery</span>&#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户名关键字&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer name;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;用户状态：1-正常，2-冻结&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最小值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer minBalance;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;余额最大值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxBalance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在dto包下创建返回给前端的数据类型泛型类PageDTO&lt;T&gt;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总条数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer total;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer pages;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;集合&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.OrderItem;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.toolkit.Db;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.dto.PageDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.Address;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.query.UserQuery;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.AddressVO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUsersPage</span><span class="params">(UserQuery query)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> query.getName();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> query.getStatus();</span><br><span class="line">        <span class="comment">//1.构建查询条件</span></span><br><span class="line">        <span class="comment">//1.1 分页条件</span></span><br><span class="line">        Page&lt;User&gt; page = Page.of(query.getPageNo(),query.getPageSize());</span><br><span class="line">        <span class="comment">//1.2 排序条件</span></span><br><span class="line">        <span class="keyword">if</span>(query.getSortyBy() != <span class="literal">null</span>)&#123;</span><br><span class="line">            page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(query.getSortyBy(),query.getIsAsc()));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//为空，默认按照更新时间降序排序</span></span><br><span class="line">            page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;update_time&quot;</span>,<span class="literal">false</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.分页查询</span></span><br><span class="line">        Page&lt;User&gt; p = lambdaQuery().like(name != <span class="literal">null</span>, User::getUsername, name)</span><br><span class="line">            .eq(status != <span class="literal">null</span>, User::getStatus, status)</span><br><span class="line">            .page(page);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.封装VO结果</span></span><br><span class="line">        PageDTO&lt;UserVO&gt; dto = <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//3.1 总条数</span></span><br><span class="line">        dto.setTotal(p.getTotal());</span><br><span class="line">        <span class="comment">//3.2 总页数</span></span><br><span class="line">        dto.setPages(p.getPages());</span><br><span class="line">        <span class="comment">//3.3 当前页数据</span></span><br><span class="line">        List&lt;User&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isEmpty(records))&#123;</span><br><span class="line">            dto.setList((Collections.emptyList()));</span><br><span class="line">            <span class="keyword">return</span> dto;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.4 拷贝user的VO</span></span><br><span class="line">        List&lt;UserVO&gt; userVOS = BeanUtil.copyToList(p.getRecords(), UserVO.class);</span><br><span class="line">        dto.setList(userVOS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.返回</span></span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="通用分页实体与MP转换"><a href="#通用分页实体与MP转换" class="headerlink" title="通用分页实体与MP转换"></a>通用分页实体与MP转换</h2><p>案例：通用分页实体</p>
<p>需求：</p>
<ul>
<li><p>在PageQuery中定义方法，将PageQuery对象转化为MyBatisPlus中的Page对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.query;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.OrderItem;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页查询实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageQuery</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sortyBy;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否升序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">isAsc</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(OrderItem... items)</span> &#123;</span><br><span class="line">        <span class="comment">//1.构建查询条件</span></span><br><span class="line">        <span class="comment">//1.1 分页条件</span></span><br><span class="line">        Page&lt;T&gt; page = Page.of(pageNo, pageSize);</span><br><span class="line">        <span class="comment">//1.2 排序条件</span></span><br><span class="line">        <span class="keyword">if</span> (sortyBy != <span class="literal">null</span>) &#123;</span><br><span class="line">            page.addOrder(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(sortyBy, isAsc));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (items != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//为空，默认按照更新时间降序排序</span></span><br><span class="line">            page.addOrder(items);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPage</span><span class="params">(String defaultSortBy, Boolean defaultAsc)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(defaultSortBy, defaultAsc));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPageDefaultSortByCreateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;create_time&quot;</span>, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Page&lt;T&gt; <span class="title function_">toMpPageDefaultSortByUpdateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toMpPage(<span class="keyword">new</span> <span class="title class_">OrderItem</span>(<span class="string">&quot;update_time&quot;</span>, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在PageDTO中定义方法，将MyBatisPlus中的Page结果转化为PageDTO的结果</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.domain.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总条数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;集合&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;PO, VO&gt;  PageDTO&lt;VO&gt; <span class="title function_">of</span><span class="params">(Page&lt;PO&gt; p, Class&lt;VO&gt; clazz)</span>&#123;</span><br><span class="line">        <span class="comment">//3.封装VO结果</span></span><br><span class="line">        PageDTO&lt;VO&gt; dto = <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//3.1 总条数</span></span><br><span class="line">        dto.setTotal(p.getTotal());</span><br><span class="line">        <span class="comment">//3.2 总页数</span></span><br><span class="line">        dto.setPages(p.getPages());</span><br><span class="line">        <span class="comment">//3.3 当前页数据</span></span><br><span class="line">        List&lt;PO&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isEmpty(records))&#123;</span><br><span class="line">            dto.setList((Collections.emptyList()));</span><br><span class="line">            <span class="keyword">return</span> dto;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.4 拷贝user的VO</span></span><br><span class="line">        List&lt;VO&gt; userVOS = BeanUtil.copyToList(records, clazz);</span><br><span class="line">        dto.setList(userVOS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.返回</span></span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新改写根据条件分页查询结果的测试方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.OrderItem;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.toolkit.Db;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.dto.PageDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.Address;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.query.PageQuery;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.query.UserQuery;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.AddressVO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUsersPage</span><span class="params">(UserQuery query)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> query.getName();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> query.getStatus();</span><br><span class="line">        Page&lt;User&gt; page = query.toMpPageDefaultSortByUpdateTime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.分页查询</span></span><br><span class="line">        Page&lt;User&gt; p = lambdaQuery().like(name != <span class="literal">null</span>, User::getUsername, name)</span><br><span class="line">            .eq(status != <span class="literal">null</span>, User::getStatus, status)</span><br><span class="line">            .page(page);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> PageDTO.of(p, UserVO.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>缺点：<code>BeanUtil.copyToList(records, clazz);</code>要求PO和VO类型的字段名一致。如果字段名不一致，无法拷贝，就必须自己完成PO到VO的转化。解决办法，传递转换方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//pageDTO.java</span></span><br><span class="line"><span class="keyword">package</span> com.example.domain.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collector;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;分页结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageDTO</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总条数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;总页数&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long pages;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;集合&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;PO, VO&gt;  PageDTO&lt;VO&gt; <span class="title function_">of</span><span class="params">(Page&lt;PO&gt; p, Function&lt;PO,VO&gt; convertor)</span>&#123;</span><br><span class="line">        <span class="comment">//3.封装VO结果</span></span><br><span class="line">        PageDTO&lt;VO&gt; dto = <span class="keyword">new</span> <span class="title class_">PageDTO</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//3.1 总条数</span></span><br><span class="line">        dto.setTotal(p.getTotal());</span><br><span class="line">        <span class="comment">//3.2 总页数</span></span><br><span class="line">        dto.setPages(p.getPages());</span><br><span class="line">        <span class="comment">//3.3 当前页数据</span></span><br><span class="line">        List&lt;PO&gt; records = p.getRecords();</span><br><span class="line">        <span class="keyword">if</span>(CollUtil.isEmpty(records))&#123;</span><br><span class="line">            dto.setList((Collections.emptyList()));</span><br><span class="line">            <span class="keyword">return</span> dto;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.4 拷贝user的VO</span></span><br><span class="line">        dto.setList(records.stream().map(convertor).collect(Collectors.toList()));</span><br><span class="line"><span class="comment">//        List&lt;VO&gt; userVOS = BeanUtil.copyToList(records, clazz);</span></span><br><span class="line"><span class="comment">//        dto.setList(userVOS);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.返回</span></span><br><span class="line">        <span class="keyword">return</span> dto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UserServiceImpl.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.bean.BeanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.metadata.OrderItem;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.toolkit.Db;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.dto.PageDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.po.Address;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.query.PageQuery;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.query.UserQuery;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.AddressVO;</span><br><span class="line"><span class="keyword">import</span> com.example.domain.vo.UserVO;</span><br><span class="line"><span class="keyword">import</span> com.example.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageDTO&lt;UserVO&gt; <span class="title function_">queryUsersPage</span><span class="params">(UserQuery query)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> query.getName();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> query.getStatus();</span><br><span class="line">        Page&lt;User&gt; page = query.toMpPageDefaultSortByUpdateTime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.分页查询</span></span><br><span class="line">        Page&lt;User&gt; p = lambdaQuery().</span><br><span class="line">            like(name != <span class="literal">null</span>, User::getUsername, name)</span><br><span class="line">            .eq(status != <span class="literal">null</span>, User::getStatus, status)</span><br><span class="line">            .page(page);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> PageDTO.of(p, user -&gt; &#123;</span><br><span class="line"><span class="comment">//            BeanUtil.copyProperties(user, UserVO.class)</span></span><br><span class="line">            <span class="type">UserVO</span> <span class="variable">vo</span> <span class="operator">=</span> BeanUtil.copyProperties(user,UserVO.class);</span><br><span class="line">            vo.setUsername(vo.getUsername().substring(<span class="number">0</span>,vo.getUsername().length() - <span class="number">2</span>) + <span class="string">&quot;**&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> vo;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>mybatisplus</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb-day09-maven高级</title>
    <url>/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/</url>
    <content><![CDATA[<h1 id="分模块设计与开发"><a href="#分模块设计与开发" class="headerlink" title="分模块设计与开发"></a>分模块设计与开发</h1><ul>
<li><p>为什么？</p>
<ul>
<li>（一个电商项目可能包含多个业务功能，商品、搜索、购物车、订单等等模块，所有的代码都在一个java项目中，这个项目的管理和维护会很困难）</li>
<li>（在项目中定义了通用的工具类和组件，公司其他项目组也想使用这些工具类和组件，这种情况也不太方便，代码难以复用）</li>
</ul>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216183352534.png" alt="image-20240216183352534"></p>
</li>
<li><p>分模块设计：将项目按照功能拆分为若干个子模块，方便项目的管理维护、拓展，也方便模块间的相互调用，资源共享。（商品、搜索、购物车、订单、实体类|通用组件模块等）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216183456409.png" alt="image-20240216183456409"></p>
</li>
<li><p>实践</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216213219458.png" alt="image-20240216213219458"></p>
</li>
<li><p>步骤</p>
<ul>
<li><p>创建maven模块 tlias-pojo，存放实体类。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216214402332.png" alt="image-20240216214402332"></p>
<p>给tlias-pojo的pom.xml文件加上对应的依赖，确保其中的pojo类方法能正常运行。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216214515180.png" alt="image-20240216214515180"></p>
</li>
<li><p>创建maven模块tlias-utils，存放相关工具类。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216214900547.png" alt="image-20240216214900547"></p>
</li>
<li><p>在主程序中引入这两个模块</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216215548913.png" alt="image-20240216215548913"></p>
<p><font color="red">注意事项：分模块开发需要先针对模块功能进行设计，再进行编码。不会先将工程开发完毕，然后进行拆分。</font></p>
</li>
</ul>
</li>
</ul>
<h1 id="继承与聚合"><a href="#继承与聚合" class="headerlink" title="继承与聚合"></a>继承与聚合</h1><h2 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h2><p><strong>问题</strong></p>
<p>不同模块的配置引入了多个相同依赖。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216220009702.png" alt="image-20240216220009702"></p>
<p><strong>继承</strong></p>
<ul>
<li>概念：继承描述的是两个工程间的关系，与Java中的继承相似，子工程可以继承父工程中的配置信息，常见于依赖关系的继承。（将各个子工程中的公共依赖放到父工程依赖中）。</li>
<li>作用：简化依赖配置，统一管理依赖。</li>
<li>实现：&lt;parent&gt; … &lt;&#x2F;parent&gt;</li>
</ul>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216220347887.png" alt="image-20240216220347887"></p>
<p><strong>步骤</strong></p>
<ol>
<li><p>创建maven模块tlias-parent，该工程为父工程，设置打包方式pom（默认jar）。</p>
<ul>
<li>jar：普通模块打包，springboot项目基本都是jar包（内嵌tomcat运行）</li>
<li>war：普通web程序打包，需要部署在外部的tomcat服务器中运行</li>
<li>pom：父工程或聚合工程，该模块不写代码，仅进行依赖管理</li>
</ul>
<p>注意：在maven当中，一个工程只能继承一个父工程。我们原始的tlias-web-management已经有父工程spring-boot-starter-parent。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216221111872.png" alt="image-20240216221111872"></p>
<p>解决办法：让tlias-parent继承spring-boot-starter-parent，再让tlias-web-management继承tlias-parent。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216221158176.png" alt="image-20240216221158176"></p>
<p>设置tlias-parent的pom.xml内容，设置了parent父工程，packaging打包方式。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216221232706.png" alt="image-20240216221232706"></p>
</li>
<li><p>在子工程的pom.xml文件中，配置继承关系。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216223213319.png" alt="image-20240216223213319"></p>
<ul>
<li>在子工程中，配置了继承关系之后，坐标中的groupId是可以省略的，因为会自动继承父工程的。</li>
<li>relativePath指定父工程的pom文件的相对位置（如果不指定，将从本地仓库&#x2F;远程仓库中查找该工程）。</li>
</ul>
</li>
<li><p>在父工程中配置各个工程共有的依赖（子工程会自动继承父工程的依赖）。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216223346649.png" alt="image-20240216223346649"></p>
<ul>
<li><font color="red">若父子工程都配置了同一个依赖的不同版本，以子工程的为准。</font></li>
</ul>
</li>
</ol>
<p><strong>实操</strong></p>
<ol>
<li>创建tlias-parent模块作为父工程。</li>
</ol>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216221627518.png" alt="image-20240216221627518"></p>
<ol start="2">
<li><p>设置tlias-parent模块的打包方式和父工程，删除无用的src目录（仅做依赖管理）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216221919180.png" alt="image-20240216221919180"></p>
</li>
<li><p>设置子工程的pom.xml</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216222504798.png" alt="image-20240216222504798"></p>
</li>
<li><p>在父工程中配置子工程中相同的配置</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216222918026.png" alt="image-20240216222918026"></p>
</li>
</ol>
<p><strong>真实的项目模块结构</strong>（有图所示）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216223542356.png" alt="image-20240216223542356"></p>
<h2 id="版本锁定"><a href="#版本锁定" class="headerlink" title="版本锁定"></a>版本锁定</h2><p>分模块之后，子工程可以继承父工程的依赖。</p>
<p>问题：存在多个（非全部）子工程使用同一个依赖。这个依赖无法直接添加到父工程中。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216223913990.png" alt="image-20240216223913990"></p>
<p>解决办法：</p>
<p>在maven中，可以在父工程的pom文件中通过&lt;dependencyManagement&gt;来统一管理依赖版本。（仅仅代表我们要统一管理这个依赖的版本，但是不将其添加至父工程的依赖中，实际上配置时还是在子工程中配置依赖，但是不用再在子工程中指定依赖版本）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216224152871.png" alt="image-20240216224152871"></p>
<p>注意事项：</p>
<ul>
<li>子工程引入依赖时，无需指定&lt;version&gt;版本号，父工程统一管理。变更依赖版本，只需在父工程中统一变更。</li>
</ul>
<p><strong>自定义属性&#x2F;引用属性</strong></p>
<p>在yml文件的properties属性中设置依赖版本</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216225128520.png" alt="image-20240216225128520"></p>
<ol>
<li>&lt;dependencyManagement&gt;与&lt;dependencies&gt;的区别是什么？</li>
</ol>
<ul>
<li>&lt;dependencies&gt;是直接依赖，在父工程配置了依赖，子工程会直接继承下来。</li>
<li>&lt;dependencyManagement&gt;是统一管理依赖版本，不会直接依赖，还需要在子工程中引入所需依赖（无需指定版本）</li>
</ul>
<h2 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h2><p>问题：要将tlias-web-management打包，得先将tlias-parent，tlias-pojo，tlias-utils执行install，然后才能打包tlias-web-management。</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216231527264.png" alt="image-20240216231527264"></p>
<p>maven的聚合操作就是来解决这个问题：一键编译、打包、安装。</p>
<ul>
<li><p>聚合</p>
<p>将多个模块组织成一个整体，同时进行项目的构建。</p>
</li>
<li><p>聚合工程</p>
<p>一个不具有业务功能的“空”工程（有且仅有一个pom文件）（目前项目中就有，是tlias-parent，因此tlias-parent既是父工程，也是聚合工程）</p>
</li>
<li><p>作用</p>
<p>快速构建项目（无需根据依赖关系手动构建，直接在聚合工程上构建即可）</p>
</li>
</ul>
<p>maven可以通过在pom.xml中设置&lt;modules&gt;，从而设置当前聚合工程所包含的子模块名称</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216231953596.png" alt="image-20240216231953596"></p>
<p>注意事项：</p>
<ul>
<li>聚合工程中所包含的模块，在构建时，会根据模块间的依赖关系设置构建顺序，与聚合工程中模块的配置书写位置无关。</li>
</ul>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240216232244285.png" alt="image-20240216232244285"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>作用<ul>
<li>聚合用于快速构建项目</li>
<li>继承用于简化依赖配置、统一管理依赖</li>
</ul>
</li>
<li>相同点<ul>
<li>聚合与继承的pom.xml文件打包方式均为pom，可以将两种关系制作到同一个pom文件中</li>
<li>聚合与继承均属于设计型模块， 并无实际的模块内容</li>
</ul>
</li>
<li>不同点<ul>
<li>聚合是在聚合工程中配置关系，聚合可以感知到参与聚合的模块有哪些</li>
<li>继承是在子模块中配置关系，父模块无法感知哪些子模块继承了自己</li>
</ul>
</li>
</ul>
<h1 id="私服"><a href="#私服" class="headerlink" title="私服"></a>私服</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217011547756.png" alt="image-20240217011547756"></p>
<p>问题：怎么将A中的jar包导入至B的项目中？</p>
<p>解决办法：搭建私服。私服从中央仓库下载第三方依赖，确保A和B能使用对方的依赖和中央仓库的依赖。</p>
<ul>
<li><p>私服是一种特殊的远程仓库，它是架设在局域网内的仓库服务，用来代理位于外部的中央仓库，用于解决团队内部的资源共享与资源同步问题。</p>
</li>
<li><p>依赖查找顺序：</p>
<ul>
<li>本地仓库</li>
<li>私服</li>
<li>中央仓库</li>
</ul>
</li>
<li><p>注意事项：私服在企业项目开发中，一个项目&#x2F;公司，只需要一台即可（<font color="red">无需我们搭建，会使用即可</font>）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217011926163.png" alt="image-20240217011926163"></p>
</li>
</ul>
<h2 id="资源上传与下载"><a href="#资源上传与下载" class="headerlink" title="资源上传与下载"></a>资源上传与下载</h2><p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217012323930.png" alt="image-20240217012323930"></p>
<p><strong>私服的仓库</strong></p>
<ul>
<li>RELEASE(发行版本)：功能趋于稳定，当前更新停止，可以用于发行的版本，存储在私服的RELEASE仓库中。</li>
<li>SNAPSHOT（快照版本）：功能不稳定、尚处于开发中的版本，即快照版本，存储在私服的SNAPSHOT仓库中。</li>
</ul>
<ol>
<li><p>配置访问私服的用户名&#x2F;密码（settings.xml中的servers中配置）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217013612624.png" alt="image-20240217013612624"></p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217013535822.png" alt="image-20240217013535822"></p>
</li>
<li><p>IDEA的maven工程的pom文件中配置上传（发布）地址</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217013625786.png" alt="image-20240217013625786"></p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217013643914.png" alt="image-20240217013643914"></p>
</li>
<li><p>设置私服依赖下载的仓库组地址（仓库组挂载了所有仓库，settings.xml中的mirrors、profiles中配置）</p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217013820947.png" alt="image-20240217013820947"></p>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217013850809.png" alt="image-20240217013850809"></p>
</li>
</ol>
<h2 id="私服配置说明"><a href="#私服配置说明" class="headerlink" title="私服配置说明"></a>私服配置说明</h2><p>访问私服：<a href="http://192.168.150.101:8081/">http://192.168.150.101:8081</a></p>
<p>访问密码：admin&#x2F;admin</p>
<p>使用私服，需要在maven的settings.xml配置文件中，做如下配置：</p>
<ol>
<li><p>需要在 <strong>servers</strong> 标签中，配置访问私服的个人凭证(访问的用户名和密码)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>在 <strong>mirrors</strong> 中只配置我们自己私服的连接地址(如果之前配置过阿里云，需要直接替换掉)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.150.101:8081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>需要在 <strong>profiles</strong> 中，增加如下配置，来指定snapshot快照版本的依赖，依然允许使用</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>allow-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.150.101:8081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">            	<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            	<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>如果需要上传自己的项目到私服上，需要在项目的pom.xml文件中，增加如下配置，来配置项目发布的地址(也就是私服的地址)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- release版本的发布地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.150.101:8081/repository/maven-releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- snapshot版本的发布地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.150.101:8081/repository/maven-snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>发布项目，直接运行 deploy 生命周期即可 (发布时，建议跳过单元测试)</p>
</li>
</ol>
<p>​		</p>
<h2 id="启动本地私服"><a href="#启动本地私服" class="headerlink" title="启动本地私服"></a>启动本地私服</h2><ol>
<li><p>解压： apache-maven-nexus.zip</p>
</li>
<li><p>进入目录： apache-maven-nexus\nexus-3.39.0-01\bin</p>
</li>
<li><p>启动服务：双击 start.bat </p>
</li>
<li><p>访问服务：localhost:8081</p>
</li>
<li><p>私服配置说明：将上述配置私服信息的 192.168.150.101 改为 localhost</p>
</li>
</ol>
<h1 id="Web开发完结"><a href="#Web开发完结" class="headerlink" title="Web开发完结"></a>Web开发完结</h1><p>接下来的学习路线</p>
<ol>
<li>MyBatis-Plus</li>
<li>瑞吉外卖项目</li>
<li>微服务技术栈</li>
<li>学成在线项目</li>
</ol>
<p><img src="/2024/02/16/javaweb-day09-maven%E9%AB%98%E7%BA%A7/image-20240217015500978.png" alt="image-20240217015500978"></p>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb-day08-springboot原理篇</title>
    <url>/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/</url>
    <content><![CDATA[<h1 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h1><ul>
<li><p>springboot中支持三种格式的配置文件：</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215195245829.png" alt="image-20240215195245829"></p>
<p>properties的优先级最高</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215195550412.png" alt="image-20240215195550412"></p>
<p>yml的优先级次之</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215195629992.png" alt="image-20240215195629992"></p>
<p>yaml的优先级最后</p>
</li>
<li><p>注意事项：虽然springboot支持多种格式配置文件，但是在项目开发时，推荐统一使用一种格式的配置（yml是主流）</p>
</li>
<li><p>springboot除了支持配置文件属性配置，还支持<font color="red">Java系统属性</font>和<font color="red">命令行参数</font>的方法进行属性配置。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215195946438.png" alt="image-20240215195946438"></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215200530374.png" alt="image-20240215200530374"></p>
<p><font color="red">命令行参数（Program argument）的优先级要高于Java系统属性（VM option）设置。</font></p>
</li>
</ul>
<p>目前的设置是在idea中，假如我们使用的不是idea，或者我们的项目已经打包上线了，我们又如何设置java系统属性和命令行参数呢？接下来运行项目打包后运行时如何指定java系统属性和命令行参数。</p>
<ol>
<li><p>执行maven打包指令package</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215201417286.png" alt="image-20240215201417286"></p>
</li>
<li><p>执行java指令，运行jar包</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -Dserver.port=<span class="number">9000</span> -jar tlias-web-management-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.jar --server.port=<span class="number">10010</span></span><br></pre></td></tr></table></figure>

<p>注意事项：springboot项目进行打包时，需要引入插件spring-boot-maven-plugin（基于官网骨架创建项目，会自动添加该插件）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215201808877.png" alt="image-20240215201808877"></p>
</li>
</ol>
<p>配置优先级（从高到低）</p>
<ul>
<li>java系统属性（-Dxxx&#x3D;xxx）</li>
<li>命令行参数（–xxx&#x3D;xxx）</li>
<li>application.properties</li>
<li>application.yml</li>
<li>application.yaml（忽略）</li>
</ul>
<h1 id="Bean管理"><a href="#Bean管理" class="headerlink" title="Bean管理"></a>Bean管理</h1><h2 id="获取bean"><a href="#获取bean" class="headerlink" title="获取bean"></a>获取bean</h2><ul>
<li><p>默认情况下，Spring项目启动时，会把bean都创建好放在IOC容器中，如果想要主动获取这些bean，可以通过如下方式：</p>
<ul>
<li>根据name获取bean：<code>Object getBean(String name)</code></li>
<li>根据类型获取bean：<code>&lt;T&gt; T getBean(Class&lt;T&gt; requiredType)</code></li>
<li>根据name获取bean（带类型转换）：<code>&lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType)</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TliasWebManagementApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext; <span class="comment">//IOC容器对象</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//根据bean的名称获取</span></span><br><span class="line">        <span class="type">DeptController</span> <span class="variable">bean1</span> <span class="operator">=</span> (DeptController) applicationContext.getBean(<span class="string">&quot;deptController&quot;</span>);</span><br><span class="line">		System.out.println(bean1);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//根据bean的类型获取</span></span><br><span class="line">		<span class="type">DeptController</span> <span class="variable">bean2</span> <span class="operator">=</span> applicationContext.getBean(DeptController.class);</span><br><span class="line">		System.out.println(bean2);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//根据bean的名称及类型获取</span></span><br><span class="line">		<span class="type">DeptController</span> <span class="variable">bean3</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;deptController&quot;</span>, DeptController.class);</span><br><span class="line">		System.out.println(bean3);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项：上述所说的[Spring项目启动时，会把其中的bean都创建好]还会收到作用域及延迟初始化影响，这里主要针对默认的单例非延迟加载的bean而言。</p>
</li>
</ul>
<h2 id="bean作用域"><a href="#bean作用域" class="headerlink" title="bean作用域"></a>bean作用域</h2><ul>
<li><p>Spring支持五种作用域，后三种在web环境才会生效</p>
<table>
<thead>
<tr>
<th>作用域</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><font color="red">singleton</font></td>
<td><font color="red">容器内声明的bean只有一个实例（单例）（默认）</font></td>
</tr>
<tr>
<td><font color="red">prototype</font></td>
<td><font color="red">每次使用该bean时都会创建新的实例（非单例）</font></td>
</tr>
<tr>
<td>request</td>
<td>每个请求范围内都会创建新的实例（web环境中，了解）</td>
</tr>
<tr>
<td>session</td>
<td>每个会话范围内都会创建新的实例（web环境中，了解）</td>
</tr>
<tr>
<td>application</td>
<td>每个应用范围内都会创建新的实例（web环境中，了解）</td>
</tr>
</tbody></table>
</li>
<li><p>可以通过@Scope注解来进行配置作用域：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/depts&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意事项</p>
<ul>
<li>默认singleton的bean，在容器启动时被创建，可以通过@Lazy注解来延迟初始化（延迟到第一次使用时）。</li>
<li>prototype的bean，每一次使用该bean的时候都会创建一个新的实例。</li>
<li>实际开发当中，绝大部分的Bean都是单例的，也就是说绝大部分Bean不需要配置scope属性。</li>
</ul>
</li>
</ul>
<h2 id="第三方bean"><a href="#第三方bean" class="headerlink" title="第三方bean"></a>第三方bean</h2><p>原生Bean</p>
<ul>
<li>@Controller</li>
<li>@Service</li>
<li>@Repository（@Mapper）</li>
<li>@Component</li>
</ul>
<p>现在有以下情况，需要初始化某些第三方jar包中的某些类对象，而这些第三方jar包的原码默认是read-only的，不能在其类上加注解@Component。</p>
<ul>
<li><p>如果要管理的bean对象来自于第三方（不是自定义的），是无法用@Component及衍生注解声明bean的，就需要用到@Bean注解。</p>
</li>
<li><p>若要管理的第三方bean对象，建议对这些bean进行集中分类配置，可以通过@Configuration注解声明一个配置类。</p>
</li>
<li><p>将当前方法的返回值对象交给IOC容器管理，称为IOC容器的bean，通过@Bean注解的&#x2F;name&#x2F;value属性指定bean名称，如果为指定，默认方法名即为该第三方bean对象。（完成了控制反转）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215223531608.png" alt="image-20240215223531608"></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215224343513.png" alt="image-20240215224343513"></p>
</li>
<li><p>完成了依赖注入</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215225225131.png" alt="image-20240215225225131"></p>
</li>
<li><p>如果第三方bean需要依赖其他bean对象，直接再bean定义方法中设置形参即可，容器会根据类型自动装配。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215225407697.png" alt="image-20240215225407697"></p>
</li>
</ul>
<h1 id="SpringBoot原理"><a href="#SpringBoot原理" class="headerlink" title="SpringBoot原理"></a>SpringBoot原理</h1><p>Spring全家桶都基于Spring Framework，这个框架比较繁琐（配置pom.xml复杂），基于此，在Spring Framework4.0之后，推出了Spring Boot框架（简化Spring Framework的开发）。</p>
<p>Spring Boot提供了起步依赖和自动配置。</p>
<ul>
<li>起步依赖：大大简化pom.xml中依赖配置，解决spring framework中依赖配置繁琐的问题。</li>
<li>自动配置：简化spring framework使用时bean的声明和配置。</li>
</ul>
<h2 id="起步依赖"><a href="#起步依赖" class="headerlink" title="起步依赖"></a>起步依赖</h2><p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215230254400.png" alt="image-20240215230254400"></p>
<p>spring框加进行web程序开发要引入上述每个依赖，而springboot只需要引入一个依赖，<font color="red">收益于maven的依赖传递（如果a依赖了b，b依赖了c，那么在引入a之后，b和c这两个依赖也都会引入）</font>。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215230457232.png" alt="image-20240215230457232"></p>
<h2 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h2><ul>
<li><p>SpringBoot的自动配置就是当spring容器启动后，一些配置类、bean对象就会自动存入到IOC容器中，不需要我们手动去声明，从而简化了开发，省去了繁琐的配置操作。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215231251757.png" alt="image-20240215231251757"></p>
</li>
</ul>
<h3 id="自动配置原理"><a href="#自动配置原理" class="headerlink" title="自动配置原理"></a>自动配置原理</h3><p>springboot当中，我们引入对应的依赖，是如何将依赖中jar包当中所提供的这些bean以及配置类直接加载到当前项目的spring ioc容器当中，然后我们就可以直接使用了。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215231450566.png" alt="image-20240215231450566"></p>
<ul>
<li><p>方案一：@ComponentScan组件扫描</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215232814762.png" alt="image-20240215232814762"></p>
</li>
<li><p>方案二：@Import导入。使用@Import导入的类会被Spring加载到IOC容器中，导入形式主要有以下几种：</p>
<ul>
<li><p>导入普通类</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215233345565.png" alt="image-20240215233345565"></p>
</li>
<li><p>导入配置类（@Configuration，这个类中所有的加了@Bean方法返回的对象都会加载到IOC容器中）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215233510157.png" alt="image-20240215233510157"></p>
</li>
<li><p>导入ImportSelector接口实现类(<font color="red">selectImports方法，极其重要，决定哪些类可以作为Bean对象导入到IOC容器中</font>)</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215234724430.png" alt="image-20240215234724430"></p>
</li>
<li><p>@EnableXxxx注解，封装@Import注解，让第三方库作者来设置要实现哪些bean对象（推荐，方便，优雅）</p>
<p>为启动程序加上@EnableXxxx注解，再创建Enablexxx接口，在该接口加上注解@Import(Xxxx.class)，指定的这个Xxxx.class实现ImportSelector接口的selectImports方法，该方法返回了具体哪些类会注入到ioc容器中。这样第三方作者可以快速方便的自动决定哪些类要加入到IOC容器中。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215235112424.png" alt="image-20240215235112424"></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240215235235351.png" alt="image-20240215235235351"></p>
</li>
</ul>
</li>
</ul>
<h3 id="源码跟踪"><a href="#源码跟踪" class="headerlink" title="源码跟踪"></a>源码跟踪</h3><p>重点&#x2F;关键：@SpringBootApplication(SpringBoot中最为重要的注解)</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216002845192.png" alt="image-20240216002845192"></p>
<p>技巧：抓关键点，找关键流程</p>
<ol>
<li><p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216003918693.png" alt="image-20240216003918693"></p>
</li>
<li><p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216004027562.png" alt="image-20240216004027562"></p>
</li>
<li><p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216004154608.png" alt="image-20240216004154608"></p>
</li>
<li><p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216004548571.png" alt="image-20240216004548571"></p>
</li>
<li><p>找到了对应的selectImports方法，该方法会返回要封装到IOC容器的bean对象的全类名的数组。现在要查明数组的具体内容是什么，先进入getAutoConfigurationEntry找到具体的实现细节。<img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216004713347.png" alt="image-20240216004713347"></p>
</li>
<li><p>Entry里面返回了哪些信息，在这里可以看到，直接return了一个entry对象，new  entry对象时里面传递了两个参数，分别是configurations，exclusions，通过图5可以知道最终调用的是configurations。我们要去看一下这个configurations如何获取的，是通过调用getCandidateConfigurations方法。<img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216005719506.png" alt="image-20240216005719506"></p>
</li>
<li><p>getCandidateConfigurations的代码如下所示，通过调用loadFactoryNames获得configurations，它的具体实现细节暂时可跳过，重点注意下面的断言，如果configurations是空的，就会提示信息，信息描述是说当没有自动配置的类被发现时就会报错，这里有两个文件，首先，第一个文件是META-INF下的spring.factory文件，另一个是META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports，那也就是说，springboot在启动时会自动加载这两个文件中配置的信息，并将其封装到list集合，最终将list集合的内容封装到string类型的数组中，这些数据最终加载到IOC容器的Bean或者配置类。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216010055187.png" alt="image-20240216010055187"></p>
</li>
<li><p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216010605951.png" alt="image-20240216010605951"></p>
</li>
<li><p>可以看到，这两个文件下的内容都是各个类的全类名<img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216010704636.png" alt="image-20240216010704636"></p>
</li>
</ol>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216010819685.png" alt="image-20240216010819685"></p>
<p>@SpringBootApplication</p>
<ul>
<li>该注解表示在SpringBoot工程引导类上，是springboot最最最重要的注解，该注解由三个部分组成。<ul>
<li>@SpringBootConfiguration：该注解与@Configuration注解作用相同，用来声明当前也是一个配置类。</li>
<li>@ComponentScan：组件扫描，默认扫描当前引导类所在包及其子包。</li>
<li>@EnableAutoConfiguration：SpringBoot实现自动化配置的核心注解。</li>
</ul>
</li>
</ul>
<p>并不是所有的@Bean都会注册为bean对象，@ConditionalOnMissingBean就是用来决定哪些加了@Bean的方法返回的对象可以成为bean对象。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216011245608.png" alt="image-20240216011245608"></p>
<p>@Conditional</p>
<ul>
<li>作用：按照一定的条件进行判断，在满足给定条件后才会注册对应的bean对象到Spring IOC容器中。</li>
<li>位置：方法、类。</li>
<li>@Conditional本身是一个父注解， 派生出大量的子注解；<ul>
<li>@ConditionalOnClass：判断环境中是否有对应的字节码文件，才注册bean到IOC容器。</li>
<li>@ConditionalOnMissingBean：判断环境中没有对应的bean（类型或名称），才注册bean到IOC容器。</li>
<li>@ConditionalOnProperty：判断配置文件中有对应属性和值，才注册bean到IOC容器。</li>
</ul>
</li>
</ul>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216011800342.png" alt="image-20240216011800342"></p>
<ol>
<li>不加@ConditionalOnClass注解的结果</li>
</ol>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216135152532.png" alt="image-20240216135152532"></p>
<ol start="2">
<li><p>加了@ConditionalOnMissingBean注解（如果用户没有定义对应的第三方类名或方法，才会将其注入到Bean对象中）</p>
</li>
<li><p>加了@ConditionalOnClass注解（<font color="red">当pom.xml文件中引入当前name指定的全类对应的依赖时，才会将对象加入到bean对象中</font>）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216135356633.png" alt="image-20240216135356633"></p>
</li>
<li><p>加了@ConditionalOnProperty注解（判断配置文件是否存在对应的属性和属性值，如果存在，才会将这个bean注册到ioc容器中）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216142834334.png" alt="image-20240216142834334"></p>
</li>
</ol>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216142936518.png" alt="image-20240216142936518"></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216143403666.png" alt="image-20240216143403666"></p>
<h3 id="案例（自定义starter）"><a href="#案例（自定义starter）" class="headerlink" title="案例（自定义starter）"></a>案例（自定义starter）</h3><p><strong>场景</strong></p>
<ul>
<li>在实际开发中，经常会定义一些公共组件，提供给各个项目团队使用。而在SpringBoot的项目中，一般会将这些公共组件封装为SpringBoot的starter。</li>
</ul>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216144308670.png" alt="image-20240216144308670"></p>
<p><strong>需求</strong></p>
<ul>
<li>需求：自定义aliyun-oss-spring-boot-starter，完成阿里云OSS操作工具类AliyunOSSUtils的自动配置。</li>
<li>目标：引入起步依赖之后，要想使用阿里云OSS，注入AliyunOSSUtils直接使用即可。</li>
</ul>
<p>原始的使用阿里云OSS的步骤</p>
<ol>
<li>需要在pom.xml文件中引入阿里云OSS的一堆依赖</li>
<li>参照官方提供的SDK改造工具类，将官方的SDK demo示例改造成工具类，然后在yml中配置aliyunOSS需要的配置参数，然后在通过AliyunOSS的实体类来加载yml配置文件当中的配置项，最后才可以在AliyunOSSUtils中获取这些参数，最后再将这个类交给SpringIOC容器管理，称为IOC容器当中的Bean对象。</li>
</ol>
<p>步骤</p>
<ol>
<li>创建aliyun-oss-spring-boot-starter模块</li>
<li>创建aliyun-oss-spring-boot-autoconfigure模块，在starter中引入该模块</li>
<li>在aliyun-oss-spring-boot-autoconfigure模块中定义自动配置功能， 并定义自动配置文件 META-INF&#x2F;spring&#x2F;xxxx.imports</li>
</ol>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216145204597.png" alt="image-20240216145204597"></p>
<p><strong>创建aliyun-oss-spring-boot-starter模块</strong></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216145946840.png" alt="image-20240216145946840"></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216150000745.png" alt="image-20240216150000745"></p>
<p>修改pom.xml文件，可以删除下述三个红框位置的内容。<img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216150040587.png" alt="image-20240216150040587"></p>
<p>删除所有文件至留下以下两项（如果创建的maven项目没有imi文件，解决办法：<a href="https://blog.csdn.net/helloearth121/article/details/118168244">IDEA使用Maven生成普通项目没有生成iml文件解决方法_创建java不自动创建iml-CSDN博客</a>）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216150441995.png" alt="image-20240216150441995"></p>
<p><strong>创建aliyun-oss-spring-boot-autoconfigure模块</strong></p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216150711921.png" alt="image-20240216150711921"></p>
<p>精简至如下结果</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216151112174.png" alt="image-20240216151112174"></p>
<ol>
<li><p>将autoconfigure依赖导入starter的pom.xml</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216151300776.png" alt="image-20240216151300776"></p>
</li>
<li><p>在autoconfigure模块中配置好AliyunOSSUtils（在autoconfigure模块的pom.xml中引入阿里云OSS依赖）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216151802968.png" alt="image-20240216151802968"></p>
</li>
<li><p>将对应AliOSSProperties类和AliOSSUtils类复制到autoconfigure模块的com.aliyun.oss包下。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216152055856.png" alt="image-20240216152055856"></p>
</li>
<li><p>补全这两个类需要的依赖和代码（getter和setter方法）</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216152347046.png" alt="image-20240216152347046"></p>
</li>
<li><p>由于这两个方法中加了@Component，但是它们都不是项目启动时加入的Bean对象，因此要将注解删除。为了实现依赖注入，要为我们自定义的第三方项目创建配置类，声明AliyunOSSUtils这个Bean.因此这一步的操作是声明配置类。</p>
<p>先创建AliOSSAutoConfiguration类，加@Configuration使其成为配置类，加@Bean方法，返回值AliOSSUtils类，方法名为aliOSSUtils，使得返回的与方法名同名的AliOSSUtils类型的对象注册为Bean对象。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216152851187.png" alt="image-20240216152851187"></p>
</li>
<li><p>通过@EnableConfigurationProperties将AliOSSProperties导入到IOC容器中，使其称为Bean对象，同时将其作为aliOSSUtils的参数输入（默认将IOC容器的Bean对象传入），给AliOSSUtils类添加AliOSSProperties的对象属性，重构对应的AliOSSUtils的构造函数，确保其属性能接收到参数传入的Bean对象。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216154218655.png" alt="image-20240216154218655"></p>
</li>
<li><p>配置对应的配置文件META-INF&#x2F;spring&#x2F;xxxx.imports（在resource目录下创建META-INF.spring目录，在该目录下创建org.springframework.boot.autoconfigure.AutoConfiguration.imports文件，并将配置类的全类名com.aliyun.oss.AliOSSAutoConfiguration写入其中。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216155040246.png" alt="image-20240216155040246"></p>
</li>
<li><p>至此，完成！</p>
</li>
</ol>
<p><strong>小结</strong></p>
<p>我们主要定义了starter和autoconfigure两个模块，starter模块主要进行依赖管理，autoconfigure模块实现自动配置。</p>
<p>我们需要定义一个自动配置类，将需要自动配置的Bean都定义在这个自动配置类当中，接着在org.springframework.boot.autoconfigure.AutoConfiguration.imports下导入启动类。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216160946664.png" alt="image-20240216160946664"></p>
<h1 id="Web后端开发总结"><a href="#Web后端开发总结" class="headerlink" title="Web后端开发总结"></a>Web后端开发总结</h1><p>Web后端开发基于三层架构开发</p>
<ul>
<li>Controller控制器层，负责接受请求，响应数据</li>
<li>Service业务层，负责业务逻辑处理</li>
<li>Dao数据访问层&#x2F;持久层，负责处理数据访问操作，完成数据库增删改查</li>
</ul>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216161332789.png" alt="image-20240216161332789"></p>
<p>如果我们在执行具体业务之前要进行通用的业务处理，比如要进行登录校验，要进行统一的字符编码。此时可以借助于JavaWeb三大组件之一的过滤器Filter或Spring当中提供的拦截器Interceptor实现。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216161633213.png" alt="image-20240216161633213"></p>
<p>为了实现三层架构层与层之间的解耦，我们学习了spring框架的第一大核心IOC控制反转和DI依赖注入。</p>
<p>IOC控制反转：将对象创建的控制权由应用程序自身交给外部容器，并将对象声明为IOC容器的Bean对象。</p>
<p>DI依赖注入：容器为程序提供运行时需要的资源。</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216161940142.png" alt="image-20240216161940142"></p>
<ul>
<li><p>AOP面向切面编程</p>
</li>
<li><p>事务管理</p>
</li>
<li><p>全局异常处理</p>
</li>
<li><p>传统会话技术：Cookie、Session</p>
</li>
<li><p>新的会话跟踪解决方案：JWT</p>
</li>
<li><p>阿里云OSS对象存储服务</p>
</li>
<li><p>MyBatis持久层框架操作数据库</p>
</li>
</ul>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216162200217.png" alt="image-20240216162200217"></p>
<p>各个技术分属细节</p>
<p><img src="/2024/02/15/javaweb-day08-springboot%E5%8E%9F%E7%90%86%E7%AF%87/image-20240216162502383.png" alt="image-20240216162502383"></p>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb-day07-事务管理 &amp; AOP</title>
    <url>/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/</url>
    <content><![CDATA[<h1 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h1><h2 id="事务回顾"><a href="#事务回顾" class="headerlink" title="事务回顾"></a>事务回顾</h2><ul>
<li><p>概念</p>
<p>事务是一组操作的集合，它是一个不可分割的工作单位，这些操作要么同时成功，要么同时失败。</p>
</li>
<li><p>操作</p>
<ul>
<li>开启事务（一组操作开始前，开启事务）：start transaction &#x2F; begin；</li>
<li>提交事务（这组操作全部成功后，提交事务）：commit；</li>
<li>回滚事务（中间任何一个操作出现异常，回滚事务）：rollback；</li>
</ul>
</li>
</ul>
<h2 id="Spring事务管理"><a href="#Spring事务管理" class="headerlink" title="Spring事务管理"></a>Spring事务管理</h2><p>案例需求：解散部门，删除部门，同时删除该部门下的员工。</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214122907385.png" alt="image-20240214122907385"></p>
<p>问题（数据库操作中间报错，导致后续数据库操作未正常执行）</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214122932665.png" alt="image-20240214122932665"></p>
<p>解决办法Spring事务管理</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214123058600.png" alt="image-20240214123058600"></p>
<ul>
<li><p>注解：@Transactional</p>
</li>
<li><p>位置：业务（service）层的方法上、类上、接口上</p>
<p>（作用在方法上，表示当前方法交由spring事务管理；作用在类上，表示当前类的所有方法交由spring事务管理；作用在接口上，表示这个接口下所有实现类的所有实现方法都交由spring事务管理）</p>
</li>
<li><p>作用：将当前方法交给spring进行事务管理，方法执行前，开启事务；成功执行完毕，提交事务；出现异常，回滚事务</p>
</li>
<li><p>常见用法：在执行多次数据访问操作的业务方法上加上Transactional注解。</p>
</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214124025970.png" alt="image-20240214124025970"></p>
<p><strong>开启事务日志</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开启事务管理日志</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.springframework.jdbc.support.JdbcTransactionManager :</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h2 id="事务进阶"><a href="#事务进阶" class="headerlink" title="事务进阶"></a>事务进阶</h2><h3 id="rollbackFor"><a href="#rollbackFor" class="headerlink" title="rollbackFor"></a>rollbackFor</h3><ul>
<li><p>默认情况下，只有出现RuntimeException才回滚异常。rollbackFor属性用于控制出现何种异常类型，回滚事务。</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214125021300.png" alt="image-20240214125021300"></p>
<p>增加代码</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214124800658.png" alt="image-20240214124800658"></p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214125224998.png" alt="image-20240214125224998"></p>
</li>
</ul>
<h3 id="propagation"><a href="#propagation" class="headerlink" title="propagation"></a>propagation</h3><ul>
<li><p>事务传播行为：指的是当一个事务方法被另一个事务方法调用时，这个事务方法应该如何进行事务控制。</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214125400853.png" alt="image-20240214125400853"></p>
<table>
<thead>
<tr>
<th>属性值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><font color="red">REQUIRED</font></td>
<td><font color="red">【默认值】需要事务，有则加入，无则创建新事务</font></td>
</tr>
<tr>
<td><font color="red">REQUIRES_NEW</font></td>
<td><font color="red">需要新事务，无论有无，总是创建新事务</font></td>
</tr>
<tr>
<td>SUPPORTS</td>
<td>支持事务，有则加入，无则在无事务状态中运行</td>
</tr>
<tr>
<td>NOT_SUPPORTED</td>
<td>不支持事务，在无事务状态下运行，如果当前存在已有事务，则挂起当前事务</td>
</tr>
<tr>
<td>MANDATORY</td>
<td>必须有事务，否则抛异常</td>
</tr>
<tr>
<td>NEVER</td>
<td>必须没事务，否则抛异常</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
</li>
</ul>
<p>案例：解散部门时，记录操作日志</p>
<p>需求：解散部门时，无论是成功还是失败，都要记录操作日志。</p>
<p>步骤：</p>
<ol>
<li>解散部门：删除部门、删除部门下的员工</li>
<li>记录日志到数据库表中</li>
</ol>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214132730521.png" alt="image-20240214132730521"></p>
<ul>
<li>REQUIRED：大部分情况下都是用该传播行为即可。</li>
<li>REQUIRES_NEW：当我们不希望事务之间相互影响时，可以使用该传播行为。例如：下订单前需要记录日志，不论订单保存成功与否，都需要保证日志记录能够记录成功。</li>
</ul>
<h1 id="AOP基础"><a href="#AOP基础" class="headerlink" title="AOP基础"></a>AOP基础</h1><h2 id="AOP概述"><a href="#AOP概述" class="headerlink" title="AOP概述"></a>AOP概述</h2><ul>
<li><p>AOP：Aspect Oriented Programming（面向切面编程、面向方面编程），其实就是面向特定方法编程。</p>
</li>
<li><p>场景</p>
<ul>
<li><p>案例部分功能运行较慢，定位执行耗时较长的业务方法，此时需要统计每个业务方法的执行耗时</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214135211983.png" alt="image-20240214135211983"></p>
</li>
<li><p>实现：</p>
<ul>
<li>动态代理是面向切面编程最主流的实现。而SpringAOP是Spring框架的高级技术，旨在管理bean对象的过程中，主要通过底层的动态代理机制，对特定的方法进行编程。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="AOP快速入门"><a href="#AOP快速入门" class="headerlink" title="AOP快速入门"></a>AOP快速入门</h2><p>案例：Spring AOP快速入门：统计各个业务层方法执行耗时</p>
<ul>
<li><p>导入依赖：在pom.xml中导入AOP的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写AOP程序：针对于特定方法根据业务需要进行编程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//当前类是AOP类</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.example.service.*.*(..))&quot;)</span>  <span class="comment">//运行service包下所有类或接口的所有方法，切入点表达式</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">recordTime</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//1. 记录开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 调用原始方法运行</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 记录结束时间，计算方法执行耗时</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(joinPoint.getSignature() + <span class="string">&quot;方法执行耗时：&#123;&#125;ms&quot;</span>,end-begin);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214144033685.png" alt="image-20240214144033685"></p>
<h2 id="AOP核心概念"><a href="#AOP核心概念" class="headerlink" title="AOP核心概念"></a>AOP核心概念</h2><ul>
<li><p>连接点：JoinPoint，可以被AOP控制的方法（暗含方法执行时的相关信息）</p>
</li>
<li><p>通知：Advice，指那些重复的逻辑，也就是共性功能（最终体现为一个方法）</p>
</li>
<li><p>切入点：PointCut，匹配连接点的条件，通知仅会在切入点方法执行时被应用</p>
</li>
<li><p>切面：Aspect，描述通知与切入点的对应关系（通知+切入点）</p>
</li>
<li><p>目标对象：Target，通知所应用的对象</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214144744583.png" alt="image-20240214144744583"></p>
</li>
<li><p>AOP执行流程</p>
<p>程序运行时，会自动为目标对象生成对应的代理对象，在代理对象中，就会对目标对象中的原始方法进行功能增强。增强逻辑取决于Aspect定义的增强功能。AOP本质还是基于动态代理。如下所示：</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214145040852.png" alt="image-20240214145040852"></p>
</li>
</ul>
<h1 id="AOP进阶"><a href="#AOP进阶" class="headerlink" title="AOP进阶"></a>AOP进阶</h1><h2 id="通知类型"><a href="#通知类型" class="headerlink" title="通知类型"></a>通知类型</h2><ol>
<li>@Around：环绕通知，此注解标注的通知方法在目标方法前、后都被执行</li>
<li>@Before：前置通知，此注解标注的通知方法在目标方法前被执行</li>
<li>@After：后置通知，此注解标注的通知方法在目标方法后被执行，无论是否有异常都会执行</li>
<li>@AfterReturning：返回后通知，此注解标注的通知方法在目标方法后被执行，有异常不会执行</li>
<li>@AfterThrowing：异常后通知，此注解标注的通知方法发生异常后执行</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.example.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.example.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;around before ...&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        log.info(<span class="string">&quot;around after ...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.example.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;execution(* com.example.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterReturning ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;execution(* com.example.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterThrowing</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterThrowing ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行顺序如下所示：</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214151512139.png" alt="image-20240214151512139"></p>
<p>注意事项：</p>
<ul>
<li>@Around环绕通知需要自己调用proceedingJoinPoint.proceed()来让原始方法执行，其他通知不需要考虑目标方法执行</li>
<li>@Around环绕通知方法的返回值，必须指定为Object，来接收原始方法的返回值。</li>
</ul>
<p>@PointCut</p>
<ul>
<li><p>该注解的作用时将公共的切点表达式抽取出来，需要用到时引用该切点表达式即可。</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214152457184.png" alt="image-20240214152457184"></p>
</li>
</ul>
<p><strong>小结</strong></p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214152524439.png" alt="image-20240214152524439"></p>
<h2 id="通知顺序"><a href="#通知顺序" class="headerlink" title="通知顺序"></a>通知顺序</h2><p>当有多个切面的切入点都匹配到了目标方法，目标方法运行时，多个通知方法都会被执行。</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214152933743.png" alt="image-20240214152933743"></p>
<p>执行顺序</p>
<ol>
<li><p>不同切面类中，默认按照切面类的类名字母排序</p>
<ul>
<li>目标方法前的通知方法：字母排名靠前的先执行</li>
<li>目标方法后的通知方法：字母排名靠前的后执行</li>
</ul>
</li>
<li><p>用@Order(数字)加载切面类上来控制顺序</p>
<ul>
<li>目标方法前的通知方法：数字小的先执行</li>
<li>目标方法后的通知方法：数字小的后执行</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214153232022.png" alt="image-20240214153232022"></p>
</li>
</ol>
<h2 id="切入点表达式"><a href="#切入点表达式" class="headerlink" title="切入点表达式"></a>切入点表达式</h2><ul>
<li>切入点表达式：描述切入点方法的一种表达式</li>
<li>作用：主要用来决定项目中的哪些方法需要加入通知</li>
<li>常见形式：<ul>
<li>execution(…)：根据方法的签名来匹配</li>
<li>@annotation(…)：根据注解匹配</li>
</ul>
</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214153640323.png" alt="image-20240214153640323"></p>
<h3 id="切入点表达式-execution"><a href="#切入点表达式-execution" class="headerlink" title="切入点表达式 - execution"></a>切入点表达式 - execution</h3><p>execution主要根据方法的返回值、包名、类名、方法名、方法参数等信息来匹配，语法为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">execution(访问修饰符? 返回值 包名.类名.?方法名(方法参数) <span class="keyword">throws</span> 异常?)</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214153831045.png" alt="image-20240214153831045"></p>
<ul>
<li><p>其中带？的表示可以省略的部分</p>
<ul>
<li>访问修饰符：可省略（比如：public、protected）</li>
<li>包名.类名：可省略</li>
<li>throws 异常：可省略（注意是方法上声明抛出的异常，不是实际抛出的异常）</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214153959965.png" alt="image-20240214153959965"></p>
</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214155556329.png" alt="image-20240214155556329"></p>
<ul>
<li><p>可以使用通配符描述切入店</p>
<ul>
<li><p>*：单个独立的任意符号，可以通配任意返回值、包名、类名、方法名、任意类型的一个参数，也可以通配包、类、方法名的一部分</p>
<p>如下所示：匹配任意返回类型，任意二级包名，任意类&#x2F;接口，update后续任意部分的任意单个参数</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214155710577.png" alt="image-20240214155710577"></p>
</li>
<li><p>.. : 多个连续的任意符号，可以通配任意层级的包，或任意类型、任意个数的参数</p>
<p>如下所示：匹配任意返回类型，任意层级的包，任意方法名，任意数量的参数</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214155744813.png" alt="image-20240214155744813"></p>
</li>
</ul>
</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214160336308.png" alt="image-20240214160336308"></p>
<p>匹配：com包下任意一级子包的service包的impl包的以ServiceImpl结尾的类的以delete开头且含有一个参数的方法。</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214161042187.png" alt="image-20240214161042187"></p>
<p><font color="red">匹配多个不同名不同参数的方法。</font></p>
<p>书写规范</p>
<ul>
<li>所有业务方法名在命名时应该尽量规范蛮方便切入点表达式快速匹配。如：查询类方法都是find开头，更新类方法都以update开头。</li>
<li>描述切入点方法时通常基于接口描述，而不是直接描述实现类，增强拓展性。</li>
<li>在满足业务需要的前提下，尽量缩小切入点的匹配范围。如：包名匹配尽量不要使用..,使用*匹配单个包。</li>
</ul>
<h3 id="切入点表达式-anotation"><a href="#切入点表达式-anotation" class="headerlink" title="切入点表达式 - @anotation"></a>切入点表达式 - @anotation</h3><ul>
<li><p>@annotation切入点表达式，用于匹配标识有特定注解的方法</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214164136474.png" alt="image-20240214164136474"></p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214164149820.png" alt="image-20240214164149820"></p>
</li>
</ul>
<h2 id="连接点"><a href="#连接点" class="headerlink" title="连接点"></a>连接点</h2><ul>
<li><p>在Spring中用JoinPoint抽象了连接点，用它可以获得方法执行时的相关信息，如目标类名，方法名，方法参数等。</p>
<ul>
<li>对于@Around 通知，获取连接点信息只能使用ProceedingJoinPoint</li>
<li>对于其他四种通知，获取连接点信息只能使用JointPoint，它是ProceedingJoinPoint的父类型</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214170831453.png" alt="image-20240214170831453"></p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214170900363.png" alt="image-20240214170900363"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//@Order(3)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect7</span> &#123; </span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.example.service.DeptService.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect8 ... before ...&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect8 around before ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 获取目标对象的类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> proceedingJoinPoint.getTarget().getClass().getName();</span><br><span class="line">        log.info(<span class="string">&quot;目标对象的类名：&#123;&#125;&quot;</span>,className);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 获取目标方法的方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> proceedingJoinPoint.getSignature().getName();</span><br><span class="line">        log.info(<span class="string">&quot;目标方法的方法名:&#123;&#125;&quot;</span>,methodName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 获取目标方法运行时传入的参数</span></span><br><span class="line">        Object[] args = proceedingJoinPoint.getArgs();</span><br><span class="line">        log.info(<span class="string">&quot;目标方法运行时传入的参数：&#123;&#125;&quot;</span>, Arrays.toString(args));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 获取目标方法执行</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 获取目标方法运行的返回值</span></span><br><span class="line">        log.info(<span class="string">&quot;目标方法运行的返回值：&#123;&#125;&quot;</span>,result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="AOP案例"><a href="#AOP案例" class="headerlink" title="AOP案例"></a>AOP案例</h1><p>案例：将案例中增删改查相关接口的操作日志记录到数据库表中</p>
<p>操作日志</p>
<p>日志信息包含：操作人、操作时间、执行方法的全类名、执行方法名、方法运行时参数、返回值、方法执行时长</p>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214172708047.png" alt="image-20240214172708047"></p>
<p>思路分析</p>
<ul>
<li>需要对所有业务类中的增删改查方法添加统一功能，使用AOP技术最为方便。</li>
</ul>
<p><img src="/2024/02/14/javaweb-day07-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86-AOP/image-20240214173033257.png" alt="image-20240214173033257"></p>
<p>步骤</p>
<ul>
<li><p>准备：</p>
<ul>
<li><p>在案例工程中引入AOP的起步依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>导入资料中准备好的数据库表结构，并引入对应的实体类</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> operate_log</span><br><span class="line">(</span><br><span class="line">    id            <span class="type">int</span> unsigned auto_increment comment <span class="string">&#x27;ID&#x27;</span></span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    operate_user  <span class="type">int</span> unsigned  <span class="keyword">null</span> comment <span class="string">&#x27;操作人ID&#x27;</span>,</span><br><span class="line">    operate_time  datetime      <span class="keyword">null</span> comment <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">    class_name    <span class="type">varchar</span>(<span class="number">100</span>)  <span class="keyword">null</span> comment <span class="string">&#x27;操作的类名&#x27;</span>,</span><br><span class="line">    method_name   <span class="type">varchar</span>(<span class="number">100</span>)  <span class="keyword">null</span> comment <span class="string">&#x27;操作的方法名&#x27;</span>,</span><br><span class="line">    method_params <span class="type">varchar</span>(<span class="number">1000</span>) <span class="keyword">null</span> comment <span class="string">&#x27;方法参数&#x27;</span>,</span><br><span class="line">    return_value  <span class="type">varchar</span>(<span class="number">2000</span>) <span class="keyword">null</span> comment <span class="string">&#x27;返回值&#x27;</span>,</span><br><span class="line">    cost_time     <span class="type">bigint</span>        <span class="keyword">null</span> comment <span class="string">&#x27;方法执行耗时, 单位:ms&#x27;</span></span><br><span class="line">)</span><br><span class="line">    comment <span class="string">&#x27;操作日志表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperateLog</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id; <span class="comment">//ID</span></span><br><span class="line">    <span class="keyword">private</span> Integer operateUser; <span class="comment">//操作人ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime operateTime; <span class="comment">//操作时间</span></span><br><span class="line">    <span class="keyword">private</span> String className; <span class="comment">//操作类名</span></span><br><span class="line">    <span class="keyword">private</span> String methodName; <span class="comment">//操作方法名</span></span><br><span class="line">    <span class="keyword">private</span> String methodParams; <span class="comment">//操作方法参数</span></span><br><span class="line">    <span class="keyword">private</span> String returnValue; <span class="comment">//操作方法返回值</span></span><br><span class="line">    <span class="keyword">private</span> Long costTime; <span class="comment">//操作耗时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>编码：</p>
<ul>
<li><p>自定义注解@Log</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.anno;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Log &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义切面类，完成记录操作日志的逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.example.mapper.OperateLogMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.OperateLog;</span><br><span class="line"><span class="keyword">import</span> com.example.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OperateLogMapper operateLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest httpServletRequest;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.example.anno.Log)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">recordLog</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作人员ID - 当前登录员工ID</span></span><br><span class="line">        <span class="comment">//获取请求头中的JWT令牌，解析令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtils.parseJWT(jwt);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">operatorUser</span> <span class="operator">=</span> (Integer) claims.get(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作时间</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">operateTime</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> proceedingJoinPoint.getTarget().getClass().getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> proceedingJoinPoint.getSignature().getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作方法参数</span></span><br><span class="line">        Object[] args = proceedingJoinPoint.getArgs();</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodParams</span> <span class="operator">=</span> Arrays.toString(args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作耗时</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用原始目标方法运行</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//操作方法返回值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">returnValue</span> <span class="operator">=</span> JSONObject.toJSONString(result);</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">costTime</span> <span class="operator">=</span> end - begin;</span><br><span class="line"></span><br><span class="line">        <span class="type">OperateLog</span> <span class="variable">operateLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OperateLog</span>(<span class="literal">null</span>, operatorUser, operateTime, className, methodName, methodParams, returnValue, costTime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//记录操作日志</span></span><br><span class="line">        operateLogMapper.insert(operateLog);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;AOP记录操作日志：&#123;&#125;&quot;</span>, operateLog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义operateLogMapper接口，创建对应的插入操作</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.DeptLog;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptLogMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Insert(&quot;insert into dept_log(create_time,description) values(#&#123;createTime&#125;,#&#123;description&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(DeptLog deptLog)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>获取当前登录用户</p>
<ul>
<li>获取request对象，从请求头中获取到jwt令牌，解析令牌获取出当前用户的id。</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javeweb-day06-登录认证</title>
    <url>/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<h1 id="基础登录功能"><a href="#基础登录功能" class="headerlink" title="基础登录功能"></a>基础登录功能</h1><p>判断用户输入的用户名和密码是否正确</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213121002402.png" alt="image-20240213121002402"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213121908243.png" alt="image-20240213121908243"></p>
<h1 id="登录校验（重点）"><a href="#登录校验（重点）" class="headerlink" title="登录校验（重点）"></a>登录校验（重点）</h1><p><strong>联调测试</strong></p>
<p><strong>问题</strong></p>
<ul>
<li>在未登录的情况下，我们也可以直接访问部门管理、员工管理等功能。</li>
</ul>
<p><strong>理想实现操作</strong></p>
<ul>
<li>在服务器接收到浏览器发送过来的请求之后，要先校验用户是否登录，如果用户已经登录了，直接执行业务操作即可。</li>
<li>如果用户并没有登录，此时不允许执行相关操作，直接给前端响应一个错误的结果，最终跳转到登录页面，要求登录成功之后再来访问相应的数据。</li>
</ul>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213122931243.png" alt="image-20240213122931243"></p>
<p>HTTP请求是无状态的，即上一次业务操作与下一次业务操作是相互分隔的。所以服务器无法判断用户是否登录。</p>
<p>解决办法：在服务器端存储登录标记，一旦员工登录成功，就存储相应的登录标记。根据用户是否登录执行不同的操作。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213123143360.png" alt="image-20240213123143360"></p>
<p>每次操作都要判断用户是否登录，会导致后端的代码量上升，因此，我们产生了统一拦截的技术。通过统一拦截，我们可以拦截浏览器发送的所有请求，拦截到之后，就可以对请求进行校验，校验员工是否登录。如果拦截到请求后，没有获取到对应的登录标记，或者登录标记是有问题的，则直接给前端响应错误信息，前端会自动跳转到登录页面。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213123345266.png" alt="image-20240213123345266"></p>
<p><strong>登陆标记</strong></p>
<ul>
<li>用户登录成功之后，每一次请求后，都可以获取到该标记。（会话技术）</li>
</ul>
<p><strong>统一拦截</strong></p>
<ul>
<li>过滤器Filter（servlet技术）</li>
<li>拦截器Interceptor（spring技术）</li>
</ul>
<h2 id="会话技术"><a href="#会话技术" class="headerlink" title="会话技术"></a>会话技术</h2><ul>
<li><p>会话：用户打开浏览器，访问web浏览器的资源，会话建立，直到有任何一方断开连接，会话结束。在一次会话中可以包含多次请求和响应。</p>
</li>
<li><p>会话跟踪：一种维护浏览器状态的方法，服务器需要识别多次请求是否来自于同一浏览器，以便在同一次会话的多次请求间共享数据。</p>
</li>
<li><p>会话跟踪方案：</p>
<ul>
<li>客户端会话跟踪技术：Cookie（浏览器）</li>
<li>服务端会话跟踪技术：Session（服务器）</li>
<li>令牌技术</li>
</ul>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213123837098.png" alt="image-20240213123837098"></p>
</li>
</ul>
<p><strong>会话跟踪方案对比</strong></p>
<p> 服务器通过响应头直接设置Set-cookie:name&#x3D;value，响应头返回给浏览器，浏览器会自动解析这个响应头，然后拿到响应头对应的cookie，将其存储在浏览器本地，在后续的每一次请求，浏览器都会将存储的cookie值通过请求头携带到服务端，在Tomcat中，提供了cookie操作的api，可以很方便的设置。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213130050761.png" alt="image-20240213130050761"></p>
<p><strong>SessionController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置Cookie（服务器给浏览器设置响应数据）</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/c1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">cookie1</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">        response.addCookie(<span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;login_username&quot;</span>,<span class="string">&quot;itheima&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/c2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">cookie2</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">            <span class="keyword">if</span>(cookie.getName().equals(<span class="string">&quot;login_username&quot;</span>))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;login_username:&quot;</span> + cookie.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优点：HTTP协议中支持的技术</p>
<p>缺点：</p>
<ul>
<li>移动端APP无法使用Cookie</li>
<li>不安全，用户可以自己禁用Cookie</li>
<li>Cookie不能跨域</li>
</ul>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213131523089.png" alt="image-20240213131523089"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213131651459.png" alt="image-20240213131651459"></p>
<p>优点：存储在服务端，安全</p>
<p>缺点：</p>
<ul>
<li><p>现在开发的服务器一般都部署在集群上，同一个项目部署多份，用户访问负载均衡的服务器，它负责将请求均匀的发送给后端的服务器。如果使用session，出现单点故障就寄了。</p>
</li>
<li><p>Cookie当中的缺点。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213132732677.png" alt="image-20240213132732677"></p>
</li>
</ul>
<p><strong>SessionController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/s1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">session1</span><span class="params">(HttpSession session)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;HttpSession-s1:&#123;&#125;&quot;</span>,session.hashCode());</span><br><span class="line"></span><br><span class="line">        session.setAttribute(<span class="string">&quot;loginUser&quot;</span>,<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/s2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">session2</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        log.info(<span class="string">&quot;HttpSession-s2:&#123;&#125;&quot;</span>,session.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">loginUser</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;loginUser&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;logUser:&#123;&#125;&quot;</span>,loginUser);</span><br><span class="line">        <span class="keyword">return</span> Result.success(loginUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="JWT令牌（主流）"><a href="#JWT令牌（主流）" class="headerlink" title="JWT令牌（主流）"></a>JWT令牌（主流）</h2><p>令牌就是用户身份的标识，本质就是一个字符串，通过令牌技术跟踪会话，浏览器发送请求，在请求登录接口的时候，如果登录成功，就生成一个令牌，令牌就是用户的合法身份凭证，在响应数据的时候，就可以把这个令牌响应给前端，接下来前端程序接收到这个令牌之后，就需要将这个令牌存储起来，令牌可以存储在cookie或者其他存储空间，后续的每一次请求，都需要将令牌携带到服务端，服务端需要校验令牌有效性，如果令牌有效，则说明用户已经执行了登录操作，如果令牌是无效的，则用户之前并未执行登录操作。</p>
<p>如果想要在多次会话之间共享数据，可以将数据存储在令牌当中。</p>
<p>优点：</p>
<ul>
<li>支持PC，移动端</li>
<li>解决集群环境下的认证问题</li>
<li>减轻服务器端存储压力</li>
</ul>
<p>缺点：需要自己编程实现</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213133400789.png" alt="image-20240213133400789"></p>
<ul>
<li><p>全称：JSON Web Token（<a href="https://jwt.io/%EF%BC%89">https://jwt.io/）</a></p>
</li>
<li><p>定义了一种简洁的、自包含的格式，用于在通信双方以json数据格式安全的传输信息。由于数字签名的存在，这些信息是可靠的。</p>
</li>
<li><p>组成：</p>
<ul>
<li><p>第一部分：Header（头）：记录令牌类型、签名算法等。例如：{“alg”:”HS256”,”type”:”JWT”}</p>
<p>在生成JWT的时候，要先进行Base64编码（是一种基于64个可打印字符（A-Z a-Z 0-9 + &#x2F;）来表示二进制数据的编码方式。</p>
</li>
<li><p>第二部分：Payload（有效载荷），携带了一些自定义信息、默认信息等。例如:{“id”:”1”,”username”:”Tom”}，也进行了Base64编码。</p>
</li>
<li><p>第三部分：Signature（签名），防止Token被篡改、确保安全性。将header，payload，并加入指定密钥，通过指定签名算法计算而来。</p>
</li>
</ul>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213134135704.png" alt="image-20240213134135704"></p>
</li>
<li><p>场景：登录认证。</p>
<ul>
<li><p>登录成功后，生成令牌。</p>
</li>
<li><p>后续每个请求，都要携带JWT令牌，系统在每次请求处理之前，先校验令牌，通过后，再处理</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213134329360.png" alt="image-20240213134329360"></p>
</li>
</ul>
</li>
</ul>
<p><strong>JWT-生成</strong></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213134519464.png" alt="image-20240213134519464"></p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>test单元测试（生成JWT令牌）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenJwt</span><span class="params">()</span>&#123;</span><br><span class="line">    Map&lt;String,Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    claims.put(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    claims.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;tom&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">        .signWith(SignatureAlgorithm.HS256, <span class="string">&quot;itheima&quot;</span>) <span class="comment">//签名算法，其中itheima是密钥，用于第三部分加密</span></span><br><span class="line">        .setClaims(claims)  <span class="comment">//自定义内容（载荷）</span></span><br><span class="line">        .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()) <span class="comment">// 设置JWT令牌的有效期为1h</span></span><br><span class="line">        .compact();</span><br><span class="line"></span><br><span class="line">    System.out.println(jwt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（解析JWT令牌）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testParseJwt</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser().setSigningKey(<span class="string">&quot;itheima&quot;</span>).parseClaimsJws(<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJuYW1lIjoidG9tIiwiaWQiOjEsImV4cCI6MTcwNzgwNDA5Mn0.KCv1P2sm4hAMjEfW1OSDhk9iitL-oBlCvotb2OLWavo&quot;</span>).getBody();</span><br><span class="line"></span><br><span class="line">	System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路</p>
<ul>
<li>令牌生成：登录成功后，生成JWT令牌，并返回给前端。</li>
<li>令牌校验：在请求到达服务端后，对令牌进行统一拦截，校验。</li>
</ul>
<p><strong>登录-生成令牌</strong></p>
<p>步骤</p>
<ul>
<li>引入JWT令牌操作工具类。</li>
<li>登录完成后，调用工具类生成JWT令牌，并返回。</li>
</ul>
<p><strong>JwtUtils.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">signKey</span> <span class="operator">=</span> <span class="string">&quot;itheima&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Long</span> <span class="variable">expire</span> <span class="operator">=</span> <span class="number">43200000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成JWT令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> claims JWT第二部分负载 payload 中存储的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateJwt</span><span class="params">(Map&lt;String, Object&gt; claims)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .addClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS256, signKey)</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + expire))</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="keyword">return</span> jwt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析JWT令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt JWT令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JWT第二部分负载 payload 中存储的内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title function_">parseJWT</span><span class="params">(String jwt)</span>&#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(signKey)</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">        <span class="keyword">return</span> claims;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213142444360.png" alt="image-20240213142444360"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213142542418.png" alt="image-20240213142542418"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213142641695.png" alt="image-20240213142641695"></p>
<h2 id="过滤器Filter"><a href="#过滤器Filter" class="headerlink" title="过滤器Filter"></a>过滤器Filter</h2><ul>
<li><p>概念：Filter过滤器，是JavaWeb三大组件（Servlet、Filter、Linstener）之一。</p>
</li>
<li><p>过滤器可以把对资源的请求拦截下来，从而实现一些比较特殊的功能。</p>
</li>
<li><p>过滤器一般完成一些通用的操作，比如：登录校验、统一编码处理、敏感字符处理等。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213143033277.png" alt="image-20240213143033277"></p>
</li>
</ul>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><ol>
<li><p>定义Filter：定义一个类，实现Filter接口，并重写其所有方法。</p>
</li>
<li><p>配置Filter：Filter类上加@WebFilter注解，配置拦截资源的路径。引导类上加@ServletComponentScan开启Servlet组件支持。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213143454407.png" alt="image-20240213143454407"></p>
</li>
</ol>
<h3 id="详解-执行流程、拦截路径、过滤器链"><a href="#详解-执行流程、拦截路径、过滤器链" class="headerlink" title="详解(执行流程、拦截路径、过滤器链)"></a>详解(执行流程、拦截路径、过滤器链)</h3><p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213153026983.png" alt="image-20240213153026983"></p>
<p>先执行放行前逻辑——放行——执行服务器代码——执行放行后逻辑。</p>
<p>疑问</p>
<ul>
<li>放行后会访问对应资源，资源访问完成后，还会回到Filter中吗？会</li>
<li>如果回到Filter中，是重新执行还是执行放行之后的逻辑呢？执行放行后逻辑</li>
</ul>
<p><strong>Filter拦截路径</strong></p>
<ul>
<li><p>Filter可以根据需求，配置不同的拦截资源路径</p>
<table>
<thead>
<tr>
<th>拦截路径</th>
<th>urlPatterns值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>拦截具体路径</td>
<td>&#x2F;login</td>
<td>只有访问&#x2F;login路径时，才会被拦截</td>
</tr>
<tr>
<td>目录拦截</td>
<td>&#x2F;emps&#x2F;*</td>
<td>访问&#x2F;emps下的所有资源，都会被拦截</td>
</tr>
<tr>
<td>拦截所有</td>
<td>&#x2F;*</td>
<td>访问所有资源，都会被拦截</td>
</tr>
</tbody></table>
</li>
</ul>
<p><strong>过滤器链</strong></p>
<ul>
<li><p>介绍：一个web应用中，可以配置多个过滤器，这多个过滤器就形成了一个过滤器链。</p>
</li>
<li><p>顺序：注解配置的filter，优先级默认是按照过滤器类名（字符串）的自然排序。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213154743954.png" alt="image-20240213154743954"></p>
</li>
</ul>
<p><strong>小结</strong></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213154815641.png" alt="image-20240213154815641"></p>
<h3 id="登录校验-Filter"><a href="#登录校验-Filter" class="headerlink" title="登录校验-Filter"></a>登录校验-Filter</h3><p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213154957750.png" alt="image-20240213154957750"></p>
<p>思考</p>
<ul>
<li>所有的请求，拦截到了之后，都需要校验令牌吗？有一个例外，登录请求</li>
<li>拦截到请求后，什么情况下才可以放行，执行业务操作？有令牌，且令牌校验通过（合法）；否则都返回未登录错误结果</li>
</ul>
<p>步骤</p>
<ul>
<li>获取请求url。</li>
<li>判断请求url中是否包含login，如果包含，说明是登录操作，放行。</li>
<li>获取请求头中的令牌（token）。</li>
<li>判断令牌是否存在，如果不存在，返回错误结果（未登录）。</li>
<li>解析token，如果解析失败，返回错误结果（未登录）。</li>
<li>放行。</li>
</ul>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213155513342.png" alt="image-20240213155513342"></p>
<p><strong>LoginCheckFilter类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.util.StringUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> netscape.javascript.JSObject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns =  &quot;/*&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginCheckFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">//1. 获取请求url。</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> (HttpServletResponse) servletResponse;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 判断请求url中是否包含login，如果包含，说明是登录操作，放行。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> req.getRequestURI().toString();</span><br><span class="line">        log.info(<span class="string">&quot;请求的url：&#123;&#125;&quot;</span>,url);</span><br><span class="line">        <span class="keyword">if</span>(url.contains(<span class="string">&quot;login&quot;</span>))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录操作，放行....&quot;</span>);</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 获取请求头中的令牌（token）。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> req.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 判断令牌是否存在，如果不存在，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasLength(jwt))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;请求头token为空，返回未登录的信息&quot;</span>);</span><br><span class="line">            <span class="type">Result</span> <span class="variable">error</span> <span class="operator">=</span> Result.error(<span class="string">&quot;NOT_LOGIN&quot;</span>);</span><br><span class="line">            <span class="comment">//手动转换 对象 --阿里巴巴fastjson</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">notlogin</span> <span class="operator">=</span> JSONObject.toJSONString(error);</span><br><span class="line">            resp.getWriter().write(notlogin);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 解析token，如果解析失败，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JwtUtils.parseJWT(jwt);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; <span class="comment">//jwt解析失败</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.info(<span class="string">&quot;解析令牌失败。返回未登录错误信息&quot;</span>);</span><br><span class="line">            <span class="type">Result</span> <span class="variable">error</span> <span class="operator">=</span> Result.error(<span class="string">&quot;NOT_LOGIN&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">notlogin</span> <span class="operator">=</span> JSONObject.toJSONString(error);</span><br><span class="line">            resp.getWriter().write(notlogin);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 放行。</span></span><br><span class="line">        log.info(<span class="string">&quot;令牌合法，放行&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="拦截器Interceptor"><a href="#拦截器Interceptor" class="headerlink" title="拦截器Interceptor"></a>拦截器Interceptor</h2><h3 id="简介-快速入门"><a href="#简介-快速入门" class="headerlink" title="简介 &amp; 快速入门"></a>简介 &amp; 快速入门</h3><ul>
<li>概念：是一种动态拦截方法调用的机制，类似于过滤器。Spring框架中提供的，用来动态拦截控制器方法的执行。</li>
<li>作用：拦截请求，在请求的方法调用前后，根据业务需要执行预先设定的代码。</li>
</ul>
<ol>
<li><p>定义拦截器，实现HandlerInterceptor接口，并重写其中所有方法。</p>
</li>
<li><p>注册拦截器。</p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213194352886.png" alt="image-20240213194352886"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213194419268.png" alt="image-20240213194419268"></p>
<p><strong>LoginCheckInterceptor.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginCheckInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//目标资源方法运行前运行，返回true；放行，返回false，不放行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//目标资源方法运行后运行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 视图渲染完毕后运行，最后运行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>WebConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.interceptor.LoginCheckInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginCheckInterceptor loginCheckInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(loginCheckInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><p>拦截器可以根据需求，配置不同的拦截路径：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.interceptor.LoginCheckInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginCheckInterceptor loginCheckInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;       registry.addInterceptor(loginCheckInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>).excludePathPatterns(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>拦截路径</th>
<th>含义</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;*</td>
<td>一级路径</td>
<td>能匹配&#x2F;depts,&#x2F;emps,&#x2F;login，不能匹配&#x2F;depts&#x2F;1</td>
</tr>
<tr>
<td>&#x2F;**</td>
<td>任意级路径</td>
<td>能匹配&#x2F;depts,&#x2F;depts&#x2F;1,&#x2F;depts&#x2F;1&#x2F;2</td>
</tr>
<tr>
<td>&#x2F;depts&#x2F;*</td>
<td>&#x2F;depts下的一级路径</td>
<td>能匹配&#x2F;depts&#x2F;1，不能匹配&#x2F;depts&#x2F;1&#x2F;2，&#x2F;depts</td>
</tr>
<tr>
<td>&#x2F;depts&#x2F;**</td>
<td>&#x2F;depts下的任意级路径</td>
<td>能匹配&#x2F;depts,&#x2F;depts&#x2F;1,depts&#x2F;1&#x2F;2;不能匹配&#x2F;emps</td>
</tr>
</tbody></table>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213202921519.png" alt="image-20240213202921519"></p>
</li>
</ul>
<p><strong>Filter与Interceptor</strong></p>
<ul>
<li>接口规范不同：过滤器需要实现Filter接口，而拦截器需要实现HandlerInterceptor接口。</li>
<li>拦截范围不同：过滤器Filter会拦截所有资源，而Interceptor只会拦截Spring环境中的资源。</li>
</ul>
<h3 id="登录校验-Interceptor"><a href="#登录校验-Interceptor" class="headerlink" title="登录校验 - Interceptor"></a>登录校验 - Interceptor</h3><p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213203640091.png" alt="image-20240213203640091"></p>
<p><strong>LoginCheckInterceptor类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginCheckInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//目标资源方法运行前运行，返回true；放行，返回false，不放行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 获取请求url。</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 判断请求url中是否包含login，如果包含，说明是登录操作，放行。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> req.getRequestURI().toString();</span><br><span class="line">        log.info(<span class="string">&quot;请求的url：&#123;&#125;&quot;</span>,url);</span><br><span class="line">        <span class="keyword">if</span>(url.contains(<span class="string">&quot;login&quot;</span>))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录操作，放行....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 获取请求头中的令牌（token）。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> req.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 判断令牌是否存在，如果不存在，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasLength(jwt))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;请求头token为空，返回未登录的信息&quot;</span>);</span><br><span class="line">            <span class="type">Result</span> <span class="variable">error</span> <span class="operator">=</span> Result.error(<span class="string">&quot;NOT_LOGIN&quot;</span>);</span><br><span class="line">            <span class="comment">//手动转换 对象 --阿里巴巴fastjson</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">notlogin</span> <span class="operator">=</span> JSONObject.toJSONString(error);</span><br><span class="line">            resp.getWriter().write(notlogin);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 解析token，如果解析失败，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JwtUtils.parseJWT(jwt);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; <span class="comment">//jwt解析失败</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.info(<span class="string">&quot;解析令牌失败。返回未登录错误信息&quot;</span>);</span><br><span class="line">            <span class="type">Result</span> <span class="variable">error</span> <span class="operator">=</span> Result.error(<span class="string">&quot;NOT_LOGIN&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">notlogin</span> <span class="operator">=</span> JSONObject.toJSONString(error);</span><br><span class="line">            resp.getWriter().write(notlogin);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 放行。</span></span><br><span class="line">        log.info(<span class="string">&quot;令牌合法，放行&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//目标资源方法运行后运行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 视图渲染完毕后运行，最后运行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213205958788.png" alt="image-20240213205958788"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240213210058206.png" alt="image-20240213210058206"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240214120014045.png" alt="image-20240214120014045"></p>
<p><img src="/2024/02/12/javeweb-day06-%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81/image-20240214120254171.png" alt="image-20240214120254171"></p>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb-day05-springboot案例</title>
    <url>/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/</url>
    <content><![CDATA[<h1 id="SpringBootWeb案例"><a href="#SpringBootWeb案例" class="headerlink" title="SpringBootWeb案例"></a>SpringBootWeb案例</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209151042104.png" alt="image-20240209151042104"></p>
<p>环境搭建</p>
<ul>
<li><p>准备数据库表（dept，emp）</p>
</li>
<li><p>创建springboot工程，引入对应的起步依赖（web、mybatis、mysql驱动、lombok）</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209152041678.png" alt="image-20240209152041678"></p>
</li>
<li><p>在application.properties中配置数据库信息，引入mybatis的配置信息，准备对应的实体类</p>
</li>
<li><p>准备三层架构的基础代码（controller、service（接口，实现类）、mapper（dao层））</p>
</li>
</ul>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209151547313.png" alt="image-20240209151547313"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209152929582.png" alt="image-20240209152929582"></p>
<p>数据库</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 部门管理</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept(</span><br><span class="line">    id <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">unique</span> comment <span class="string">&#x27;部门名称&#x27;</span>,</span><br><span class="line">    create_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    update_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;修改时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;部门表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> dept (id, name, create_time, update_time) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;学工部&#x27;</span>,now(),now()),(<span class="number">2</span>,<span class="string">&#x27;教研部&#x27;</span>,now(),now()),(<span class="number">3</span>,<span class="string">&#x27;咨询部&#x27;</span>,now(),now()), (<span class="number">4</span>,<span class="string">&#x27;就业部&#x27;</span>,now(),now()),(<span class="number">5</span>,<span class="string">&#x27;人事部&#x27;</span>,now(),now());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 员工管理(带约束)</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp (</span><br><span class="line">  id <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">  username <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">unique</span> comment <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  password <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">default</span> <span class="string">&#x27;123456&#x27;</span> comment <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  gender tinyint unsigned <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;性别, 说明: 1 男, 2 女&#x27;</span>,</span><br><span class="line">  image <span class="type">varchar</span>(<span class="number">300</span>) comment <span class="string">&#x27;图像&#x27;</span>,</span><br><span class="line">  job tinyint unsigned comment <span class="string">&#x27;职位, 说明: 1 班主任,2 讲师, 3 学工主管, 4 教研主管, 5 咨询师&#x27;</span>,</span><br><span class="line">  entrydate <span class="type">date</span> comment <span class="string">&#x27;入职时间&#x27;</span>,</span><br><span class="line">  dept_id <span class="type">int</span> unsigned comment <span class="string">&#x27;部门ID&#x27;</span>,</span><br><span class="line">  create_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  update_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;修改时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;员工表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp</span><br><span class="line">	(id, username, password, name, gender, image, job, entrydate,dept_id, create_time, update_time) <span class="keyword">VALUES</span></span><br><span class="line">	(<span class="number">1</span>,<span class="string">&#x27;jinyong&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;金庸&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;1.jpg&#x27;</span>,<span class="number">4</span>,<span class="string">&#x27;2000-01-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">2</span>,<span class="string">&#x27;zhangwuji&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;张无忌&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2015-01-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">3</span>,<span class="string">&#x27;yangxiao&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;杨逍&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;3.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2008-05-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">4</span>,<span class="string">&#x27;weiyixiao&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;韦一笑&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;4.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2007-01-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">5</span>,<span class="string">&#x27;changyuchun&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;常遇春&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;5.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2012-12-05&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">6</span>,<span class="string">&#x27;xiaozhao&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;小昭&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;6.jpg&#x27;</span>,<span class="number">3</span>,<span class="string">&#x27;2013-09-05&#x27;</span>,<span class="number">1</span>,now(),now()),</span><br><span class="line">	(<span class="number">7</span>,<span class="string">&#x27;jixiaofu&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;纪晓芙&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;7.jpg&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2005-08-01&#x27;</span>,<span class="number">1</span>,now(),now()),</span><br><span class="line">	(<span class="number">8</span>,<span class="string">&#x27;zhouzhiruo&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;周芷若&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;8.jpg&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2014-11-09&#x27;</span>,<span class="number">1</span>,now(),now()),</span><br><span class="line">	(<span class="number">9</span>,<span class="string">&#x27;dingminjun&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;丁敏君&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;9.jpg&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2011-03-11&#x27;</span>,<span class="number">1</span>,now(),now()),</span><br><span class="line">	(<span class="number">10</span>,<span class="string">&#x27;zhaomin&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;赵敏&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;10.jpg&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2013-09-05&#x27;</span>,<span class="number">1</span>,now(),now()),</span><br><span class="line">	(<span class="number">11</span>,<span class="string">&#x27;luzhangke&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;鹿杖客&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;11.jpg&#x27;</span>,<span class="number">5</span>,<span class="string">&#x27;2007-02-01&#x27;</span>,<span class="number">3</span>,now(),now()),</span><br><span class="line">	(<span class="number">12</span>,<span class="string">&#x27;hebiweng&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;鹤笔翁&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;12.jpg&#x27;</span>,<span class="number">5</span>,<span class="string">&#x27;2008-08-18&#x27;</span>,<span class="number">3</span>,now(),now()),</span><br><span class="line">	(<span class="number">13</span>,<span class="string">&#x27;fangdongbai&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;方东白&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;13.jpg&#x27;</span>,<span class="number">5</span>,<span class="string">&#x27;2012-11-01&#x27;</span>,<span class="number">3</span>,now(),now()),</span><br><span class="line">	(<span class="number">14</span>,<span class="string">&#x27;zhangsanfeng&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;张三丰&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;14.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2002-08-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">15</span>,<span class="string">&#x27;yulianzhou&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;俞莲舟&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;15.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2011-05-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">16</span>,<span class="string">&#x27;songyuanqiao&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;宋远桥&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;16.jpg&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;2007-01-01&#x27;</span>,<span class="number">2</span>,now(),now()),</span><br><span class="line">	(<span class="number">17</span>,<span class="string">&#x27;chenyouliang&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>,<span class="string">&#x27;陈友谅&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;17.jpg&#x27;</span>,<span class="keyword">NULL</span>,<span class="string">&#x27;2015-03-21&#x27;</span>,<span class="keyword">NULL</span>,now(),now());</span><br></pre></td></tr></table></figure>

<p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/tlias</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置mybatis的日志，指定其输出到控制台</span></span><br><span class="line"><span class="attr">mybatis.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 开启mybatis的驼峰命名自动映射开关</span></span><br><span class="line"><span class="attr">mybatis.configuration.map-underscore-to-camel-case</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>



<h2 id="开发规范"><a href="#开发规范" class="headerlink" title="开发规范"></a>开发规范</h2><p>案例基于当前最主流的前后端分离模式进行开发。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209154811663.png" alt="image-20240209154811663"></p>
<ul>
<li><p>REST（REpresentational State Transfer），表述性状态转换，它是一种软件架构风格</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209155135828.png" alt="image-20240209155135828"></p>
<p>注意事项</p>
<ul>
<li>REST是风格，是约定方式，约定不是规定，可以打破。</li>
<li>描述模块的功能通常使用复数，也就是加s的格式来描述，表示此类资源，而非单个资源。如：users、emps、books…</li>
</ul>
</li>
<li><p>所有的增删改查接口都要返回统一的响应结果Result（code，msg，data）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;<span class="comment">//响应码，1 代表成功; 0 代表失败</span></span><br><span class="line">    <span class="keyword">private</span> String msg;  <span class="comment">//响应信息 描述字符串</span></span><br><span class="line">    <span class="keyword">private</span> Object data; <span class="comment">//返回的数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//增删改 成功响应</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">success</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="number">1</span>,<span class="string">&quot;success&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询 成功响应</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">success</span><span class="params">(Object data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="number">1</span>,<span class="string">&quot;success&quot;</span>,data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//失败响应</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">error</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Result</span>(<span class="number">0</span>,msg,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209155326662.png" alt="image-20240209155326662"></p>
</li>
</ul>
<h2 id="开发流程"><a href="#开发流程" class="headerlink" title="开发流程"></a>开发流程</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209155531746.png" alt="image-20240209155531746"></p>
<h1 id="部门管理"><a href="#部门管理" class="headerlink" title="部门管理"></a>部门管理</h1><h2 id="查询部门"><a href="#查询部门" class="headerlink" title="查询部门"></a>查询部门</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209160429415.png" alt="image-20240209160429415"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209160528223.png" alt="image-20240209160528223"></p>
<ol>
<li><p>编写DeptController类中代码</p>
<ol>
<li>@RestController，让DeptController返回restful形式的统一响应结果</li>
<li>@Slf4j，自动为注释的类创建log对象</li>
<li>@GetMapping，设置该请求仅回复get响应</li>
<li>设置deptService（<font color="red">service层接口对象</font>），方便控制反转</li>
<li>设置相应的返回方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DeptController</span></span><br><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 部门管理Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span>  <span class="comment">//该注释会为相应类生成对应的log对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line">    <span class="comment">//private static Logger log = LoggerFactory.getLogger(DeptController.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"><span class="comment">//    @RequestMapping(value = &quot;/depts&quot;,method = RequestMethod.GET)  //RequestMapping映射页面请求和处理方法</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/depts&quot;)</span>  <span class="comment">//RequestMapping映射页面请求和处理方法</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">list</span><span class="params">()</span>&#123;  <span class="comment">//Controller层查询结果，返回的是Result对象</span></span><br><span class="line">        log.info(<span class="string">&quot;查询全部部门数据&quot;</span>);</span><br><span class="line">        List&lt;Dept&gt; deptList =  deptService.list();</span><br><span class="line">        <span class="keyword">return</span> Result.success(deptList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写services代码查询数据</p>
<ol>
<li>设置service层接口及其实现类对象（实现类对象要加@Service，方便依赖注入）</li>
<li>设置deptMapper(<font color="red">dao层接口对象</font>)，方便控制反转</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//DeptService.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line">    List&lt;Dept&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//DeptServiceImpl.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.DeptMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptMapper deptMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">list</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> deptMapper.list();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写dao层代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from dept&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h2><p><font color="red">前端接口通过nginx服务器与后端的tomcat服务器实现端口映射。</font></p>
<p>概念：将前端工程和后端工程都启动起来，然后访问前端工程，通过前端工程访问服务器程序，进而调试结果。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209165501994-17074689029111.png" alt="image-20240209165501994"></p>
<h2 id="删除部门"><a href="#删除部门" class="headerlink" title="删除部门"></a>删除部门</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209170144724.png" alt="image-20240209170144724"></p>
<p>使用@PathVariable获取id参数值</p>
<p><strong>controller层</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 部门管理Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span>  <span class="comment">//该注释会为相应类生成对应的log对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line">    <span class="comment">//private static Logger log = LoggerFactory.getLogger(DeptController.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 删除部门</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(value = &quot;/depts/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;根据id删除指定部门:&#123;&#125;&quot;</span>,id);</span><br><span class="line">        deptService.delete(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line">    List&lt;Dept&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Delete(&quot;delete from dept where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="新增部门"><a href="#新增部门" class="headerlink" title="新增部门"></a>新增部门</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209175909231.png" alt="image-20240209175909231"></p>
<p><strong>controller层</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 部门管理Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span>  <span class="comment">//该注释会为相应类生成对应的log对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line">    <span class="comment">//private static Logger log = LoggerFactory.getLogger(DeptController.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/depts&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> Dept dept)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;新增部门：&#123;&#125;&quot;</span>,dept);</span><br><span class="line"></span><br><span class="line">        deptService.add(dept);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.DeptMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptMapper deptMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Dept dept)</span> &#123;</span><br><span class="line">        dept.setCreateTime(LocalDateTime.now());</span><br><span class="line">        dept.setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        deptMapper.insert(dept);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptMapper</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Insert(&quot;insert into dept(name,create_time, update_time) values(#&#123;name&#125;,#&#123;createTime&#125;,#&#123;updateTime&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Dept dept)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用@RequestMapping简化Controller类中方法的编写过程</strong></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209181608222.png" alt="image-20240209181608222"></p>
<ul>
<li>一个完整的请求路径，应该是类上的@RequestMapping的value属性+方法上的@RequestMapping的value属性。</li>
</ul>
<h2 id="修改部门"><a href="#修改部门" class="headerlink" title="修改部门"></a>修改部门</h2><p><strong>controller层</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 部门管理Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span>  <span class="comment">//该注释会为相应类生成对应的log对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line">    <span class="comment">//private static Logger log = LoggerFactory.getLogger(DeptController.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/depts&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> Dept dept)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;更新部门:&#123;&#125;&quot;</span>,dept);</span><br><span class="line"></span><br><span class="line">        deptService.update(dept);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>service层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.DeptMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> com.example.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptMapper deptMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Dept dept)</span> &#123;</span><br><span class="line">        dept.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        dept.setCreateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        deptMapper.update(dept);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>mapper层代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Dept;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptMapper</span> &#123;    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update dept set name = #&#123;name&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Dept dept)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="员工管理"><a href="#员工管理" class="headerlink" title="员工管理"></a>员工管理</h1><h2 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240209185704327.png" alt="image-20240209185704327"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240210002309264.png" alt="image-20240210002309264"></p>
<p><strong>定义实体类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PageBean</span></span><br><span class="line"><span class="keyword">package</span> com.example.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long total; <span class="comment">// 总记录数</span></span><br><span class="line">    <span class="keyword">private</span> List rows; <span class="comment">//数据列表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>EmpController类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.PageBean;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.example.service.EmpService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmpController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpService empService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/emps&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">page</span><span class="params">(<span class="meta">@RequestParam(defaultValue = &quot;1&quot;)</span> Integer page, <span class="meta">@RequestParam(defaultValue = &quot;10&quot;)</span> Integer pageSize)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;分页查询，参数：&#123;&#125;,&#123;&#125;&quot;</span>,page,pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="type">PageBean</span> <span class="variable">pageBean</span> <span class="operator">=</span>  empService.page(page,pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(pageBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>EmpService类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.EmpMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.PageBean;</span><br><span class="line"><span class="keyword">import</span> com.example.service.EmpService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmpServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmpService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageBean <span class="title function_">page</span><span class="params">(Integer page, Integer pageSize)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> empMapper.count();</span><br><span class="line">        List&lt;Emp&gt; emp = empMapper.page((page - <span class="number">1</span>) * pageSize, pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageBean</span>(num, emp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>EmpMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select count(*) from emp&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">count</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from emp limit #&#123;start&#125;,#&#123;pageSize&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Emp&gt; <span class="title function_">page</span><span class="params">(Integer start, Integer pageSize)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240210003718951.png" alt="image-20240210003718951"></p>
<h2 id="分页插件PageHelper"><a href="#分页插件PageHelper" class="headerlink" title="分页插件PageHelper"></a>分页插件PageHelper</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240210005329151.png" alt="image-20240210005329151"></p>
<p>引入pageHelper依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- PageHelper分页插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240210005505728.png" alt="image-20240210005505728"></p>
<p><strong>EmpServiceImpl类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.EmpMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.PageBean;</span><br><span class="line"><span class="keyword">import</span> com.example.service.EmpService;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmpServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmpService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public PageBean page(Integer page, Integer pageSize) &#123;</span></span><br><span class="line"><span class="comment">//        Long num = empMapper.count();</span></span><br><span class="line"><span class="comment">//        List&lt;Emp&gt; emp = empMapper.page((page - 1) * pageSize, pageSize);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        return new PageBean(num, emp);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageBean <span class="title function_">page</span><span class="params">(Integer page, Integer pageSize)</span>&#123;</span><br><span class="line">        <span class="comment">// 1. 设置分页参数</span></span><br><span class="line">        PageHelper.startPage(page,pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 执行查询</span></span><br><span class="line">        List&lt;Emp&gt; empList = empMapper.list();</span><br><span class="line">        Page&lt;Emp&gt; p = (Page&lt;Emp&gt;) empList;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 封装PageBean对象</span></span><br><span class="line">        <span class="type">PageBean</span> <span class="variable">pageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageBean</span>(p.getTotal(),p.getResult());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pageBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>EmpMapper类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpMapper</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Select(&quot;select count(*) from emp&quot;)</span></span><br><span class="line"><span class="comment">//    public Long count();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    @Select(&quot;select * from emp limit #&#123;start&#125;,#&#123;pageSize&#125;&quot;)</span></span><br><span class="line"><span class="comment">//    public List&lt;Emp&gt; page(Integer start, Integer pageSize);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工信息查询</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from emp&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Emp&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">注意，这里可能会出现版本适配问题，即springboot和对应的PageHelper插件版本不同，导致最终程序无法正确运行。</font></p>
<p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">		 <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tlias-web-management<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>tlias-web-management<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--web起步依赖--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--mybatis起步依赖--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--mysql驱动--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--springboot单元测试--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!--PageHelper分页插件--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="分页条件查询"><a href="#分页条件查询" class="headerlink" title="分页条件查询"></a>分页条件查询</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212122859658.png" alt="image-20240212122859658"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212124618865.png" alt="image-20240212124618865"></p>
<h2 id="删除员工"><a href="#删除员工" class="headerlink" title="删除员工"></a>删除员工</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212132059565.png" alt="image-20240212132059565"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212132905480.png" alt="image-20240212132905480"></p>
<h2 id="新增员工"><a href="#新增员工" class="headerlink" title="新增员工"></a>新增员工</h2><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212145401473.png" alt="image-20240212145401473"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212145955119.png" alt="image-20240212145955119"></p>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>文件上传，是指将本地图片、视频、音频等文件上传到服务器，供其他用户浏览或下载的过程。</li>
<li>文件上传在项目中应用非常广泛，我们经常发微博、发微信朋友圈都用到了文件上传功能。</li>
</ul>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212152007551.png" alt="image-20240212152007551"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212153024176.png" alt="image-20240212153024176"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212153040779.png" alt="image-20240212153040779"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212155104185.png" alt="image-20240212155104185"></p>
<h3 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h3><p>在服务器端，接收到上传上来的文件之后，将文件存储在本地服务器磁盘中。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212160650537.png" alt="image-20240212160650537"></p>
<p>在Springboot中，文件上传，默认单个文件允许最大大小为1M。如果需要上传大文件，可以在application.properties中进行如下配置：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置单个文件最大上传大小</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.max-file-size</span>=<span class="string">10MB</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 配置单个请求最大上传大小（一次请求可以上传多个文件）</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.max-request-size</span>=<span class="string">100MB</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212163506732.png" alt="image-20240212163506732"></p>
<p>multipartfile的常用功能</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212163755305.png" alt="image-20240212163755305"></p>
<h3 id="阿里云OSS"><a href="#阿里云OSS" class="headerlink" title="阿里云OSS"></a>阿里云OSS</h3><p>阿里云对象存储OSS（Object Storage Service），是一款海量、安全、低成本、高可靠的云存储服务。使用OSS，您可以通过网络随时存储和调用包括文本、图片、音频和视频在内的各种文件。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212164038792.png" alt="image-20240212164038792"></p>
<p>第三方服务-通用思路</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212164215124.png" alt="image-20240212164215124"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212164305194.png" alt="image-20240212164305194"></p>
<p>Bucket：存储空间是用户用于存储对象（Object，就是文件）的容器，所有的对象都必须隶属于某个存储空间。</p>
<p>SDK：Software Development Kit的缩写，软件开发工具包，包括辅助软件开发的依赖（jar包）,代码示例等，都可以叫做SDK。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212175938569.png" alt="image-20240212175938569"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212180022852.png" alt="image-20240212180022852"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212180106893.png" alt="image-20240212180106893"></p>
<p><a href="https://blog.csdn.net/qq_59621600/article/details/134859770">03_阿里云_配置OSS环境变量_从环境变量中获取访问凭证。运行本代码示例之前,请确保已设置环境变量oss_access_-CSDN博客</a></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212180508466.png" alt="image-20240212180508466"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212181243549.png" alt="image-20240212181243549"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212182131820.png" alt="image-20240212182131820"></p>
<h2 id="修改员工"><a href="#修改员工" class="headerlink" title="修改员工"></a>修改员工</h2><h3 id="查询回显"><a href="#查询回显" class="headerlink" title="查询回显"></a>查询回显</h3><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212182543275.png" alt="image-20240212182543275"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212183024576.png" alt="image-20240212183024576"></p>
<h3 id="修改员工-1"><a href="#修改员工-1" class="headerlink" title="修改员工"></a>修改员工</h3><p> <img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212183219286.png" alt="image-20240212183219286"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212183659370.png" alt="image-20240212183659370"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212184349123.png" alt="image-20240212184349123"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212184809216.png" alt="image-20240212184809216"></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="参数配置化"><a href="#参数配置化" class="headerlink" title="参数配置化"></a>参数配置化</h3><p>每次涉及到第三方参数，都要重新编写java代码，是比较繁琐的。且第三方参数在各个文件中，要修改的地方太多，</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212185212846.png" alt="image-20240212185212846"></p>
<p>pom.xml文件是maven环境的配置文件，application.properties是springboot的配置文件。将第三方参数配置到application.properties中。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212185659858.png" alt="image-20240212185659858"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212185831938.png" alt="image-20240212185831938"></p>
<h3 id="yml配置文件"><a href="#yml配置文件" class="headerlink" title="yml配置文件"></a>yml配置文件</h3><ul>
<li><p>springboot提供了多种属性配置方式</p>
<ul>
<li><p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="attr">server.address</span>=<span class="string">127.0.0.1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="string">port:8080</span></span><br><span class="line">	<span class="string">address:127.0.0.1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="string">port:8080</span></span><br><span class="line">	<span class="string">address:127.0.0.1</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>常见配置文件格式对比</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212190404086.png" alt="image-20240212190404086"></p>
</li>
<li><p>Yml基本语法</p>
<ul>
<li>大小写敏感</li>
<li>数值前必须有空格，作为分隔符</li>
<li>使用缩进表示层级关系，缩进式，不允许使用Tab键，只能使用空格（idea会自动将Tab转化为空格）</li>
<li>缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</li>
<li>#表示注释，从这个字符一直到行尾，都会被解析器忽略</li>
</ul>
</li>
</ul>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212190610849.png" alt="image-20240212190610849"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212190644684.png" alt="image-20240212190644684"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212191542372.png" alt="image-20240212191542372"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212191559992.png" alt="image-20240212191559992"></p>
<h3 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="@ConfigurationProperties"></a>@ConfigurationProperties</h3><p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212191836626.png" alt="image-20240212191836626"></p>
<p>问题：待注入的属性值过多。</p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212192057758.png" alt="image-20240212192057758"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212193223494.png" alt="image-20240212193223494"></p>
<p><img src="/2024/02/09/javaweb-day05-springboot%E6%A1%88%E4%BE%8B/image-20240212193244630.png" alt="image-20240212193244630"></p>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb-day04-mybatis</title>
    <url>/2024/02/08/javaweb-day04-mybatis/</url>
    <content><![CDATA[<h1 id="MyBatis概述"><a href="#MyBatis概述" class="headerlink" title="MyBatis概述"></a>MyBatis概述</h1><p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208175300104.png" alt="image-20240208175300104"></p>
<p>在项目中通过Java程序操作数据库，其中最主流的技术则是MyBatis。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208175438494.png" alt="image-20240208175438494"></p>
<ul>
<li><font color="red">MyBatis是一款优秀的持久层框架，用于简化JDBC的开发。</font></li>
<li>MyBatis原本是Apache的一个开源项目iBatis，2010年这个项目由apache迁移到了google code，并且改名为MyBatis。2013年11月迁移到Github。</li>
<li>官网：<a href="https://mybatis.org/mybatis-3/zh/index.html">https://mybatis.org/mybatis-3/zh/index.html</a></li>
</ul>
<h1 id="MyBatis入门"><a href="#MyBatis入门" class="headerlink" title="MyBatis入门"></a>MyBatis入门</h1><p>案例：使用MyBatis查询所有用户数据</p>
<ol>
<li>准备工作（创建springboot工程，数据库表user，实体类User）</li>
<li>引入Mybatis的相关依赖，配置Mybatis（数据库连接信息）</li>
<li>编写SQL语句（注解&#x2F;XML）</li>
</ol>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208180807585.png" alt="image-20240208180807585"></p>
<ol>
<li><p>配置springboot工程的相关依赖包。</p>
</li>
<li><p>在application.properties中设置数据库连接信息。</p>
</li>
<li><p>设置注解@Mapper，为接口UserMapper定义方法list()，再加上注解@Select，指定当前方法是查询操作，在注解中指定要执行的sql语句。最终在执行sql语句，只需要调用UserMapper中的list方法即可，此时框架就会自动执行sql语句，并将sql语句的执行结果返回到方法的返回值中。</p>
</li>
<li><p>在Mybatis的设计中，只需要设计接口，不需要定义实现类，程序运行时，框架底层会自动生成该实现类对象。</p>
</li>
</ol>
<p><strong>准备工作</strong></p>
<ol>
<li><p>配置springboot工程及相关依赖包。<img src="/2024/02/08/javaweb-day04-mybatis/image-20240208181512518.png" alt="image-20240208181512518"></p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208181638813.png" alt="image-20240208181638813"></p>
</li>
<li><p>数据库表user的建立</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(</span><br><span class="line">    id <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    age tinyint unsigned comment <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    gender tinyint unsigned comment <span class="string">&#x27;性别, 1:男, 2:女&#x27;</span>,</span><br><span class="line">    phone <span class="type">varchar</span>(<span class="number">11</span>) comment <span class="string">&#x27;手机号&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id, name, age, gender, phone) <span class="keyword">VALUES</span> (<span class="keyword">null</span>,<span class="string">&#x27;白眉鹰王&#x27;</span>,<span class="number">55</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;18800000000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id, name, age, gender, phone) <span class="keyword">VALUES</span> (<span class="keyword">null</span>,<span class="string">&#x27;金毛狮王&#x27;</span>,<span class="number">45</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;18800000001&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id, name, age, gender, phone) <span class="keyword">VALUES</span> (<span class="keyword">null</span>,<span class="string">&#x27;青翼蝠王&#x27;</span>,<span class="number">38</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;18800000002&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id, name, age, gender, phone) <span class="keyword">VALUES</span> (<span class="keyword">null</span>,<span class="string">&#x27;紫衫龙王&#x27;</span>,<span class="number">42</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;18800000003&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id, name, age, gender, phone) <span class="keyword">VALUES</span> (<span class="keyword">null</span>,<span class="string">&#x27;光明左使&#x27;</span>,<span class="number">37</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;18800000004&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id, name, age, gender, phone) <span class="keyword">VALUES</span> (<span class="keyword">null</span>,<span class="string">&#x27;光明右使&#x27;</span>,<span class="number">48</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;18800000005&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建实体类User</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208182232317.png" alt="image-20240208182232317"></p>
<p>在pojo目录下创建实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Short age;</span><br><span class="line">    <span class="keyword">private</span> Short gender;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(Integer id, String name, Short age, Short gender, String phone)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.gender = gender;</span><br><span class="line">        <span class="built_in">this</span>.phone = phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">            <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">            <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">            <span class="string">&quot;, gender=&quot;</span> + gender +</span><br><span class="line">            <span class="string">&quot;, phone=&#x27;&quot;</span> + phone + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Short <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Short age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Short <span class="title function_">getGender</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGender</span><span class="params">(Short gender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.gender = gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPhone</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.phone = phone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在resoures目录下配置数据库的连接信息</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/mybatis</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"># 配置mybatis的日志信息，指定输出至控制台</span></span><br><span class="line"><span class="attr">mybatis.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写SQL语句（注解&#x2F;XML）</p>
<p>在mapper目录下创建UserMapper</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojp.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span> <span class="comment">//在运行时，会自动生成该接口的实现类对象（代理对象），并且将该对象交给IOC容器管理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="comment">//查询全部的用户信息</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在test目录的测试类中测试编写好的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojp.User;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span> <span class="comment">//springboot整合单元测试的注解</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootMybatisQuickstartApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span>  UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testListUser</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;User&gt; userList = userMapper.list();</span><br><span class="line">        userList.stream().forEach(user-&gt;&#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">由于加了SpringBootTest的注解，运行时，程序会自动加载整个springboot的环境，并且创建springboot的ioc容器，ioc容器创建之后，由于加了@Autowired，实现了依赖注入，因而userMapper自动从ioc容器中获取相应的bean对象，接下来就可以调用这个bean对象当中的list方法，进而实现sql语句的查询。</font></p>
</li>
</ol>
<h1 id="配置SQL提示"><a href="#配置SQL提示" class="headerlink" title="配置SQL提示"></a>配置SQL提示</h1><p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208184500656.png" alt="image-20240208184500656"></p>
<p>存在报错信息</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208184604448.png" alt="image-20240208184604448"></p>
<p>好处：编写的sql语句如果有问题，可以在编码阶段就发现问题，而不是运行时才能显示问题。</p>
<h1 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h1><ul>
<li><p>JDBC（Java DataBase Connectivity），就是Java语言操作关系型数据库的一套API。</p>
<p>JDBC仅仅实现了接口，没有实现具体的实现机制。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208185018446.png" alt="image-20240208185018446"></p>
</li>
<li><p>JDBC vs MyBatis</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208185543665.png" alt="image-20240208185543665"></p>
<p>MyBatis单独提炼出连接数据库的配置，同时节省了数据查询结果的封装过程，此外，采用数据库连接池技术存储连接过程中创建的connection对象，节省了频繁开销带来的性能损失。</p>
</li>
<li><p>MyBatis的实现关注重点</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208185621056.png" alt="image-20240208185621056"></p>
</li>
</ul>
<h1 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h1><ul>
<li><p>数据库连接池是一个容器，负责分配、管理数据库连接（Connection）</p>
</li>
<li><p>它允许应用程序重复使用一个现有的数据库对象，而不是重新建立一个</p>
</li>
<li><p>释放空间时间超过最大空闲时间的链接，来避免因为没有释放连接引起的数据库连接遗漏（如果用户获取数据库对象后在一定时间未对数据库进行操作，超出时间后，连接池会收回该对象）</p>
</li>
</ul>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208190243297.png" alt="image-20240208190243297"></p>
<p>优势</p>
<ul>
<li>资源重用</li>
<li>提升系统响应速度</li>
<li>避免数据库连接泄露</li>
</ul>
<p>标准接口：DataSource</p>
<ul>
<li><p>官方（sun）提供的数据库连接池接口，由第三方组织实现此接口。</p>
</li>
<li><p>功能：获取链接 <code>Connection getConnection() throws SQLException;</code></p>
</li>
<li><p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208190417420.png" alt="image-20240208190417420"></p>
</li>
<li><p>Druid和HiKari的连接池都不错</p>
<ul>
<li>Druid连接池是阿里巴巴开源的数据库连接池项目</li>
<li>功能强大，性能优秀，是Java语言最好的数据库连接池之一</li>
</ul>
</li>
<li><p>切换Druid数据库连接池</p>
<p>官方地址：<a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/mybatis</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 指定数据源类型为Druid</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="lombok"><a href="#lombok" class="headerlink" title="lombok"></a>lombok</h1><p>问题：原有的类过于臃肿，每个属性都要创建对应的get，set方法。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208193220097.png" alt="image-20240208193220097"></p>
<ul>
<li><p>Lombok是一个实用的Java类库，能通过注解的形式自动生成构造器、getter&#x2F;setter、equals、hashcode、toString等方法，并可以自动化生成日志变量，简化java开发，提高效率。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>@Getter&#x2F;@Setter</td>
<td>为所有的属性提供get&#x2F;set方法</td>
</tr>
<tr>
<td>@ToString</td>
<td>会为类自动生成易阅读的toString方法</td>
</tr>
<tr>
<td>@EqualsAndHashCode</td>
<td>根据类所拥有的非静态字段自动重写equals方法和hashCode方法</td>
</tr>
<tr>
<td>@Data</td>
<td>提供更综合的生成代码功能（@Getter+@Setter+@ToString+@EqualsAndHashCode）</td>
</tr>
<tr>
<td>@NoArgsConstructor</td>
<td>为实体类生成无参的构造器方法</td>
</tr>
<tr>
<td>@AllArgsConstructor</td>
<td>为实体类生成除了static修饰的字段之外带有各参数的构造器方法</td>
</tr>
</tbody></table>
</li>
<li><p>引入lambok的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>实例代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pojp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Short age;</span><br><span class="line">    <span class="keyword">private</span> Short gender;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<ul>
<li><p>lombok在编译时，自动生成对应的java代码，我们使用lombok时，还需要安装一个lombok的插件（idea自带）。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208194835391.png" alt="image-20240208194835391"></p>
</li>
</ul>
</li>
</ul>
<h1 id="Mybatis基础操作"><a href="#Mybatis基础操作" class="headerlink" title="Mybatis基础操作"></a>Mybatis基础操作</h1><p>准备工作</p>
<ul>
<li><p>准备数据库表emp</p>
</li>
<li><p>创建一个新的springboot工程，选择引入对应的起步依赖（mybatis、mysql、lombok）</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208212225283.png" alt="image-20240208212225283"></p>
</li>
<li><p>application.properties中引入数据库连接信息</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/mybatis</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 切换为Druid</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建对应的实体类Emp（实体类属性采用驼峰命名法）</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208212425880.png" alt="image-20240208212425880"></p>
</li>
<li><p>准备Mapper接口EmpMapper</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208212434113.png" alt="image-20240208212434113"></p>
</li>
</ul>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208214036989.png" alt="image-20240208214036989"></p>
<p>删除时点击删除按钮，最终会向后台发送该数据对应的主键id，交给后端处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//EmpMapper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpMapper</span> &#123;</span><br><span class="line">    <span class="comment">//根据ID删除数据（该函数是有返回值的，返回的是删除操作影响的记录数）</span></span><br><span class="line">    <span class="meta">@Delete(&quot;delete from emp where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SpringbootMybatisCrudApplicationTests</span></span><br><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.EmpMapper;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootMybatisCrudApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span>&#123;</span><br><span class="line">        empMapper.delete(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<p>如果mapper接口方法形参只有一个普通类型的参数，#{…}里面的属性名可以随便写，如：#{id}，#{value}。</p>
<p><strong>日志输出</strong></p>
<ul>
<li><p>可以在application.properties中，打开mybatis的日志，并指定输出到控制台。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置mybatis的日志信息，指定输出至控制台</span></span><br><span class="line"><span class="attr">mybatis.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>

<p>再次运行之后得到预编译SQL操作信息（在运行前，后将Parameter写入Preparing中的参数）</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208215940314.png" alt="image-20240208215940314"></p>
<p>使用#{id}，代表占位符，最终执行时，？会用参数占位符的实际内容16代替，发送到数据库执行语句。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208220029626.png" alt="image-20240208220029626"></p>
</li>
</ul>
<p><strong>MySQL语句的执行过程 | 预编译SQL</strong></p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208220327688.png" alt="image-20240208220327688"></p>
<p>普通的java语句-&gt;sql语法解析检查-&gt;优化SQL-&gt;编译sql-&gt;执行sql</p>
<p>其中，预编译会将“sql语法解析检查-&gt;优化SQL-&gt;编译sql”这几步<strong>缓存</strong>起来，后续如果有大量的SQL语句，则从<strong>缓存</strong>中找是否有对应的预编译好的指令，如果有，就省略这三步操作，直接去执行SQL语句，否则，需要再次执行操作。</p>
<p>例如，如果我们要执行以下三条语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>则这三条语句都要进行语法检查，优化，编译。</p>
<p>如果我们实际执行的是</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> id <span class="operator">=</span> ?;</span><br></pre></td></tr></table></figure>

<p>则对应的后两条删除语句可以直接将参数带入，直接执行SQL语句。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208220901168.png" alt="image-20240208220901168"></p>
<p><strong>防止SQL注入的具体例子：</strong></p>
<ul>
<li><p><strong>SQL注入</strong>是通过操作输入的数据来修改实现定义好的SQL语句，以达到执行代码对服务器进行<strong>攻击</strong>的方法。</p>
</li>
<li><p>例如 用户输入的是’waterdance’，password输入的是 ‘ or  ‘1’ &#x3D; ‘1</p>
</li>
<li><p>参数占位符类别</p>
<table>
<thead>
<tr>
<th>#{…}</th>
<th>${…}</th>
</tr>
</thead>
<tbody><tr>
<td>执行SQL语句时，会将#{…}替换为？，生成预编译的SQL，会自动设置参数值</td>
<td>拼接SQL。直接将 参数拼接在SQL语句中，存在SQL注入问题。</td>
</tr>
<tr>
<td>使用时机：参数传递，都使用#{}</td>
<td>使用时机：如果对表名、列表进行动态设置时使用。</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//EmpMapper</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Insert(&quot;insert into emp(username, name, gender, image, job, entrydate, dept_id, create_time, update_time)&quot; +</span></span><br><span class="line"><span class="meta">        &quot;values (#&#123;username&#125;, #&#123;name&#125;, #&#123;gender&#125;, #&#123;image&#125;, #&#123;job&#125;, #&#123;entrydate&#125;, #&#123;deptId&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;)&quot;)</span>  # 属性名要求按照类设计的属性名来编写</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insert</span><span class="params">(Emp emp)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SpringbootMybatisCrudApplicationTests</span></span><br><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.EmpMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.time.LocalDateTime.now;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.time.LocalDateTime.of;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootMybatisCrudApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Emp</span> <span class="variable">emp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Emp</span>();</span><br><span class="line">        emp.setUsername(<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        emp.setName(<span class="string">&quot;杰瑞&quot;</span>);</span><br><span class="line">        emp.setImage(<span class="string">&quot;1.jpg&quot;</span>);</span><br><span class="line">        emp.setGender((<span class="type">short</span>)<span class="number">1</span>);</span><br><span class="line">        emp.setJob((<span class="type">short</span>)<span class="number">1</span>);</span><br><span class="line">        emp.setEntrydate(LocalDate.of(<span class="number">2000</span>,<span class="number">1</span>,<span class="number">1</span>));</span><br><span class="line">        emp.setCreateTime(LocalDateTime.now());</span><br><span class="line">        emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        emp.setDeptId(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">insertNum</span> <span class="operator">=</span> empMapper.insert(emp);</span><br><span class="line">        System.out.println(insertNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208223618549.png" alt="image-20240208223618549"></p>
<p><strong>新增（主键返回）</strong></p>
<ul>
<li><p>描述：在数据添加成功后，需要获取插入数据库数据的主键。</p>
<p>如：添加套餐数据时，还需要维护套餐菜品关系表数据。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208223935524.png" alt="image-20240208223935524"></p>
<ul>
<li><p>实现</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208224223342.png" alt="image-20240208224223342"></p>
</li>
</ul>
</li>
</ul>
<p><strong>小结</strong></p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208224506667.png" alt="image-20240208224506667"></p>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//EmpMapper</span></span><br><span class="line"><span class="keyword">package</span> com.example.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Update(&quot;update emp set username = #&#123;username&#125;, name = #&#123;name&#125;, gender = #&#123;gender&#125;, image = #&#123;image&#125; ,&quot; +</span></span><br><span class="line"><span class="meta">           &quot; job = #&#123;job&#125;, entrydate = #&#123;entrydate&#125;, dept_id = #&#123;deptId&#125;, update_time = #&#123;updateTime&#125; where id = #&#123;id&#125; &quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Emp emp)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SpringbootMybatisCrudApplicationTests</span></span><br><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.mapper.EmpMapper;</span><br><span class="line"><span class="keyword">import</span> com.example.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.time.LocalDateTime.now;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.time.LocalDateTime.of;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootMybatisCrudApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Emp</span> <span class="variable">emp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Emp</span>();</span><br><span class="line">        emp.setId(<span class="number">18</span>);</span><br><span class="line">        emp.setUsername(<span class="string">&quot;Jerrysdasdasdasdas2&quot;</span>);</span><br><span class="line">        emp.setName(<span class="string">&quot;汤姆adasdas&quot;</span>);</span><br><span class="line">        emp.setImage(<span class="string">&quot;1sadasd.jpg&quot;</span>);</span><br><span class="line">        emp.setGender((<span class="type">short</span>) <span class="number">1</span>);</span><br><span class="line">        emp.setJob((<span class="type">short</span>) <span class="number">1</span>);</span><br><span class="line">        emp.setEntrydate(LocalDate.of(<span class="number">2000</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">        emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        emp.setDeptId(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        empMapper.update(emp);</span><br><span class="line">        System.out.println(emp.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//EmpMapper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from emp where id = #&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Emp <span class="title function_">getById</span><span class="params">(Integer id)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SpringbootMybatisCrudApplicationTests</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetById</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Emp</span> <span class="variable">emp</span> <span class="operator">=</span> empMapper.getById(<span class="number">1</span>);</span><br><span class="line">    System.out.println(emp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208230825297.png" alt="image-20240208230825297"></p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208230900933.png" alt="image-20240208230900933"></p>
<p><font color="red">其中deptId，createTime，updateTime字段值均为null，未正确封装数据内容。</font></p>
<p><font color="red">原因：</font></p>
<ul>
<li><p><font color="red">实体类属性名和数据库查询返回的字段名一致，mybatis会自动封装。</font></p>
</li>
<li><p><font color="red">如果实体类属性名和数据库表查询返回的字段名不一样，不能自动封装。</font></p>
</li>
</ul>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208231100003.png" alt="image-20240208231100003"></p>
<ul>
<li><p>为了解决实体类与数据库表命名不一致的问题，我们有以下方案。</p>
<ul>
<li><p>方案一：给字段起别名，让别名与实体类属性一致（修改empmapper类中的select方法）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//根据ID查询员工</span></span><br><span class="line">   <span class="meta">@Select(&quot;select id, username, password, name, gender, image, job,  entrydate, &quot; +</span></span><br><span class="line"><span class="meta">       &quot; dept_id deptId, create_time createTime, update_time updateTime from emp where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Emp <span class="title function_">getById</span><span class="params">(Integer id)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>方案二：通过MyBatis,@Result注释手动映射封装</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Results(&#123;</span></span><br><span class="line"><span class="meta">        @Result(column = &quot;dept_id&quot;,property = &quot;deptId&quot;),</span></span><br><span class="line"><span class="meta">        @Result(column = &quot;update_time&quot;,property = &quot;updateTime&quot;),</span></span><br><span class="line"><span class="meta">        @Result(column = &quot;create_time&quot;,property = &quot;createTime&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from emp where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Emp <span class="title function_">getById</span><span class="params">(Integer id)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>（推荐使用）方案三</strong>：开启mybatis的驼峰命名自动映射开关（将a_column这样的数据表字段自动映射到实体类的属性aColumn中,要严格遵循数据表字段是下划线分割，类中的属性名是驼峰命名）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/mybatis</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line"># 配置mybatis的日志，指定其输出到控制台</span><br><span class="line">mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl</span><br><span class="line"></span><br><span class="line"># 开启mybatis的驼峰命名自动映射开关</span><br><span class="line">mybatis.configuration.map-underscore-to-camel-case=true</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208231533437.png" alt="image-20240208231533437"></p>
</li>
</ul>
</li>
</ul>
<h2 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h2><ul>
<li><p>在empMapper类中编写接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//EmpMapper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from emp where name like &#x27;%$&#123;name&#125;%&#x27; and gender = #&#123;gender&#125; and &quot; +</span></span><br><span class="line"><span class="meta">        &quot;entrydate between #&#123;begin&#125; and #&#123;end&#125; order by update_time desc ;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title function_">list</span><span class="params">(String name, Short gender, LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在test类中测试接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SpringbootMybatisCrudApplicationTests</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;Emp&gt; empList = empMapper.list(<span class="string">&quot;张&quot;</span>, (<span class="type">short</span>) <span class="number">1</span>, LocalDate.of(<span class="number">2010</span>, <span class="number">1</span>, <span class="number">1</span>), LocalDate.of(<span class="number">2020</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    System.out.println(empList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208233621106.png" alt="image-20240208233621106"></p>
<p>因为name使用的是${}而不是#{}，可能存在SQL注入问题。解决办法：empMapper类中编写的接口使用mysql的concat函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//条件查询员工</span></span><br><span class="line"><span class="meta">@Select(&quot;select * from emp where name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;) and gender = #&#123;gender&#125; and &quot; +</span></span><br><span class="line"><span class="meta">        &quot;entrydate between #&#123;begin&#125; and #&#123;end&#125; order by update_time desc ;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title function_">list</span><span class="params">(String name, Short gender, LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208233536664.png" alt="image-20240208233536664"></p>
</li>
</ul>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208233800310.png" alt="image-20240208233800310"></p>
<p>springboot的1.x版本和2.x版本的参数设置有一点区别，区别如下所示：</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240208234015102.png" alt="image-20240208234015102"></p>
<h1 id="XML映射文件"><a href="#XML映射文件" class="headerlink" title="XML映射文件"></a>XML映射文件</h1><p>之前的方式是通过注解的方式配置sql语句，这是通过xml来配置sql语句。</p>
<ul>
<li><strong>实际开发时，选择注解来映射简单语句，如果需要实现复杂的SQL功能，还是要通过xml来完成。</strong></li>
</ul>
<h2 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h2><ul>
<li><p>XML映射文件的名称与Mapper接口名称一致，并且将XML映射文件和Mapper接口放置在<strong>相同包</strong>下(同包同名)。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209120818270.png" alt="image-20240209120818270"></p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209122155859.png" alt="image-20240209122155859"></p>
</li>
<li><p>XML映射文件的namespace属性与Mapper接口<strong>全限定名</strong>一致。resultType属性要填写的单条记录要封装的类型的<strong>全限定名</strong>。（下图中EmpMapper与namespace中的内容一致）</p>
</li>
<li><p>XML映射文件中sql语句的id与Mapper接口中的方法名一致，并保持返回类型一致。（下图中方法名list与id的内容一致，resultType是单条记录封装的类型的全类名）</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209120946411.png" alt="image-20240209120946411"></p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209122759826.png" alt="image-20240209122759826"></p>
</li>
<li><p>例子：</p>
</li>
</ul>
<p>在resources目录下创建与EmpMapper想通包的文件EmpMapper.xml，其中的配置如下所示</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.EmpMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.pojo.Emp&quot;</span>&gt;</span></span><br><span class="line">        select * from emp where name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;) and gender = #&#123;gender&#125; and  + entrydate between #&#123;begin&#125; and #&#123;end&#125; order by update_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果我们按照这三点规范定义了XML映射文件，当我们在调用EmpMapper的list方法时，MyBatis就会自动查找namespace属性值与这个接口全类名的相同的XML映射文件，并在XML映射文件中找到id属性值与方法名相同的这条sql语句，最终运行sql语句，从而完成数据库的操作。</p>
<ul>
<li>安装mybatisX插件，mapper类会和对应的xml建立连接。</li>
</ul>
<h1 id="MyBatis动态SQL"><a href="#MyBatis动态SQL" class="headerlink" title="MyBatis动态SQL"></a>MyBatis动态SQL</h1><p><strong>动态SQL</strong></p>
<p>随着用户的输入或外部条件的变化而变化的SQL语句，我们称为动态SQL。</p>
<p> <img src="/2024/02/08/javaweb-day04-mybatis/image-20240209132846618.png" alt="image-20240209132846618"></p>
<p>如上图所示，我们设定死了要求输入三个参数来进行数据库查询。其实功能要泛化，实现单个或者任意两个参数也能实现相应的查询结果。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209133959066.png" alt="image-20240209133959066"></p>
<h2 id="if-where-set"><a href="#if-where-set" class="headerlink" title="if | where | set"></a>if | where | set</h2><ul>
<li><p>&lt;if&gt;：用于判断条件是否成立。使用test属性进行条件判断，如果条件为true，则拼接SQL。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- EmpMapper.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.EmpMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.pojo.Emp&quot;</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from emp</span><br><span class="line">        where</span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> =<span class="string">&quot;name != null&quot;</span>&gt;</span></span><br><span class="line">                name like concat(&quot;%&quot;,#&#123;name&#125;,&quot;%&quot;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;gender != null&quot;</span>&gt;</span></span><br><span class="line">                and gender = #&#123;gender&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;begin != null and end != null&quot;</span>&gt;</span></span><br><span class="line">                and entrydate between #&#123;begin&#125; and #&#123;end&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        order by update_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>有bug，当name属性的值为null时，会报错。改进措施，加上&lt;where&gt;标签</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- EmpMapper.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.EmpMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.example.pojo.Emp&quot;</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from emp</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> =<span class="string">&quot;name != null&quot;</span>&gt;</span></span><br><span class="line">                name like concat(&quot;%&quot;,#&#123;name&#125;,&quot;%&quot;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;gender != null&quot;</span>&gt;</span></span><br><span class="line">                and gender = #&#123;gender&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;begin != null and end != null&quot;</span>&gt;</span></span><br><span class="line">                and entrydate between #&#123;begin&#125; and #&#123;end&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by update_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>&lt;where&gt;：根据where中的子标签判断条件是否成立。如果所有条件都不成立，就不会生产where子句，否则会生成where子句，而且会自动去除子句的开头的AND或者OR。</p>
<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209135153909.png" alt="image-20240209135153909"></p>
</li>
<li><p>&lt;set&gt;：动态在行首插入set关键字，并会删除掉额外的逗号。（用在update语句中）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- EmpMapper.xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.EmpMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update2&quot;</span>&gt;</span></span><br><span class="line">        update emp</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;username != null&quot;</span>&gt;</span> username = #&#123;username&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;name != null&quot;</span>&gt;</span> name        = #&#123;name&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;gender != null&quot;</span>&gt;</span> gender      = #&#123;gender&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;image != null&quot;</span>&gt;</span> image       = #&#123;image&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;job != null&quot;</span>&gt;</span>job         = #&#123;job&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;entrydate != null&quot;</span>&gt;</span>entrydate   = #&#123;entrydate&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;deptId != null&quot;</span>&gt;</span>dept_id     = #&#123;deptId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;updateTime != null&quot;</span>&gt;</span>update_time = #&#123;updateTime&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209142712475.png" alt="image-20240209142712475"></p>
</li>
</ul>
<h2 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h2><p><strong>sql语句</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> emp <span class="keyword">where</span> id <span class="keyword">in</span>(<span class="number">20</span>,<span class="number">22</span>,<span class="number">23</span>);</span><br></pre></td></tr></table></figure>

<p><strong>接口方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteByIds</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;Integer&gt;  ids = Arrays.asList(<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>);</span><br><span class="line">    empMapper.deleteByIds(ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>XML映射文件</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.EmpMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 批量删除标签 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        collection : 遍历的集合</span></span><br><span class="line"><span class="comment">        item:遍历出来的元素</span></span><br><span class="line"><span class="comment">        seperator:分隔符</span></span><br><span class="line"><span class="comment">        open:遍历开始拼接的SQL片段</span></span><br><span class="line"><span class="comment">        close:遍历结束拼接的SQL片段</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByIds&quot;</span>&gt;</span></span><br><span class="line">        delete from emp where id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">            #&#123;id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209144453692.png" alt="image-20240209144453692"></p>
<h2 id="sql-include"><a href="#sql-include" class="headerlink" title="sql | include"></a>sql | include</h2><p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209144709292.png" alt="image-20240209144709292"></p>
<p>问题：</p>
<ul>
<li><p>在映射配置文件中select部分存在大量重复字段，如果修改了数据表中的字段名，映射配置文件xml中要修改部分太多，代码复用性较差。java定义一个方法，将重复部分的代码封装到方法中，哪里需要就调用这个方法即可。</p>
</li>
<li><p>实现机制，用sql标签抽取重复片段，给sql分配唯一标识（定义id属性），include标签引入sql片段，用refid指定引用片段。</p>
<ul>
<li>sql：定义可重用的SQL片段。</li>
<li>include:通过属性refid，指定包含的sql片段。</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/2024/02/08/javaweb-day04-mybatis/image-20240209145633455.png" alt="image-20240209145633455"></p>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
      <tags>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>javaweb-day03-mysql</title>
    <url>/2024/02/06/javaweb-day03-mysql/</url>
    <content><![CDATA[<p>什么是数据库？</p>
<ul>
<li><p>数据库：DataBase（DB），是存储和管理数据的仓库。</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206125606781.png" alt="image-20240206125606781"></p>
</li>
<li><p>数据库管理系统：DataBase Management System(DBMS)，操纵和管理数据库的大型软件。</p>
</li>
<li><p>SQL：Structured Query Language，操作关系型数据库的编程语言，定义了一套操作关系型数据库统一标准。</p>
</li>
</ul>
<p>数据库产品</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206130010075.png" alt="image-20240206130010075"></p>
<h1 id="MySQL概述"><a href="#MySQL概述" class="headerlink" title="MySQL概述"></a>MySQL概述</h1><h2 id="安装、配置"><a href="#安装、配置" class="headerlink" title="安装、配置"></a>安装、配置</h2><h2 id="一、下载"><a href="#一、下载" class="headerlink" title="一、下载"></a>一、下载</h2><p>点开下面的链接：<a href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20221020012302873.png" alt="image-20221020012302873"> </p>
<p>点击Download 就可以下载对应的安装包了, 安装包如下: <img src="/2024/02/06/javaweb-day03-mysql/image-20221020012428839.png" alt="image-20221020012428839">  </p>
<h2 id="二、解压"><a href="#二、解压" class="headerlink" title="二、解压"></a>二、解压</h2><p>下载完成后我们得到的是一个压缩包，将其解压，我们就可以得到MySQL 8.0.31 的软件本体了(就是一个文件夹)，我们可以把它放在你想安装的位置 。</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20221020013011737.png" alt="image-20221020013011737"> </p>
<h2 id="三、配置"><a href="#三、配置" class="headerlink" title="三、配置"></a>三、配置</h2><h3 id="1-添加环境变量"><a href="#1-添加环境变量" class="headerlink" title="1. 添加环境变量"></a>1. 添加环境变量</h3><blockquote>
<p>环境变量里面有很多选项，这里我们只用到<code>Path</code>这个参数。为什么在初始化的开始要添加环境变量呢？</p>
<p>在黑框(即CMD)中输入一个可执行程序的名字，Windows会先在环境变量中的<code>Path</code>所指的路径中寻找一遍，如果找到了就直接执行，没找到就在当前工作目录找，如果还没找到，就报错。我们添加环境变量的目的就是能够在任意一个黑框直接调用MySQL中的相关程序而不用总是修改工作目录，大大简化了操作。</p>
</blockquote>
<p>右键<code>此电脑</code>→<code>属性</code>，点击<code>高级系统设置</code></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/1556823-20181220220242472-524708778.png" alt="img"> </p>
<p>点击<code>环境变量</code></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/1556823-20181220220359609-736422950.png" alt="img"> </p>
<p>在<code>系统变量</code>中新建MYSQL_HOME</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20221020013128323.png" alt="image-20221020013128323">  </p>
<p>在<code>系统变量</code>中找到并<strong>双击</strong><code>Path</code></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/1556823-20181220220551145-1198958872.png" alt="img"> </p>
<p>点击<code>新建</code></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20201109135248104.png" alt="image-20201109135248104"> </p>
<p>最后点击确定。</p>
<p><strong>如何验证是否添加成功？</strong></p>
<p>右键开始菜单(就是屏幕左下角)，选择<code>命令提示符(管理员)</code>，打开黑框，敲入<code>mysql</code>，回车。</p>
<img src="/2024/02/06/javaweb-day03-mysql/image-20221020013302450.png" alt="image-20221020013302450" style="zoom:67%;"> 

<p>如果提示<code>Can&#39;t connect to MySQL server on &#39;localhost&#39;</code>则证明添加成功；</p>
<img src="/2024/02/06/javaweb-day03-mysql/image-20221020013335596.png" alt="image-20221020013335596" style="zoom:80%;"> 

<p>如果提示<code>mysql不是内部或外部命令，也不是可运行的程序或批处理文件</code>则表示添加添加失败，请重新检查步骤并重试。</p>
<h3 id="2-初始化MySQL"><a href="#2-初始化MySQL" class="headerlink" title="2. 初始化MySQL"></a>2. 初始化MySQL</h3><p>&#x3D;&#x3D;以管理员身份，运行命令行窗口：&#x3D;&#x3D;</p>
<img src="/2024/02/06/javaweb-day03-mysql/image-20220518172922780.png" alt="image-20220518172922780" style="zoom: 80%;">

<p>在刚才的命令行中，输入如下的指令： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqld --initialize-insecure</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/image-20201109140955772.png" alt="image-20201109140955772"> </p>
<p>稍微等待一会，如果出现没有出现报错信息，则证明data目录初始化没有问题，此时再查看MySQL目录下已经有data目录生成。</p>
<p>tips：如果出现如下错误</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20201109135848054.png" alt="image-20201109135848054"> </p>
<p>是由于权限不足导致的，以管理员方式运行 cmd</p>
<img src="/2024/02/06/javaweb-day03-mysql/image-20220518172922780.png" alt="image-20220518172922780" style="zoom: 80%;"> 

<h3 id="3-注册MySQL服务"><a href="#3-注册MySQL服务" class="headerlink" title="3. 注册MySQL服务"></a>3. 注册MySQL服务</h3><p>命令行（注意必须以管理员身份启动）中，输入如下的指令，回车执行： </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqld -install</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/image-20201109141325810.png" alt="image-20201109141325810"> </p>
<p>现在你的计算机上已经安装好了MySQL服务了。</p>
<h3 id="4-启动MySQL服务"><a href="#4-启动MySQL服务" class="headerlink" title="4. 启动MySQL服务"></a>4. 启动MySQL服务</h3><p>在黑框里敲入<code>net start mysql</code>，回车。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">net start mysql  <span class="comment">// 启动mysql服务</span></span><br><span class="line">    </span><br><span class="line">net stop mysql  <span class="comment">// 停止mysql服务</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/image-20220518183747072.png" alt="image-20220518183747072"> </p>
<h3 id="5-修改默认账户密码"><a href="#5-修改默认账户密码" class="headerlink" title="5. 修改默认账户密码"></a>5. 修改默认账户密码</h3><p>在黑框里敲入<code>mysqladmin -u root password 1234</code>，这里的<code>1234</code>就是指默认管理员(即root账户)的密码，可以自行修改成你喜欢的。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqladmin -u root password 1234</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/1556823-20181221093251250-819416425.png" alt="img"> </p>
<h2 id="四、登录MySQL"><a href="#四、登录MySQL" class="headerlink" title="四、登录MySQL"></a>四、登录MySQL</h2><p>右键开始菜单，选择<code>命令提示符</code>，打开黑框。<br>在黑框中输入，<code>mysql -uroot -p1234</code>，回车，出现下图且左下角为<code>mysql&gt;</code>，则登录成功。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -uroot -p1234</span><br></pre></td></tr></table></figure>

<img src="/2024/02/06/javaweb-day03-mysql/image-20221020013540957.png" alt="image-20221020013540957" style="zoom:80%;">   

<p><strong>到这里你就可以开始你的MySQL之旅了！</strong></p>
<p>退出mysql：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">exit</span><br><span class="line">quit</span><br></pre></td></tr></table></figure>

<p>登陆参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -u用户名 -p密码 -h要连接的mysql服务器的ip地址(默认127.0.0.1) -P端口号(默认3306)</span><br></pre></td></tr></table></figure>

<h2 id="五、卸载MySQL"><a href="#五、卸载MySQL" class="headerlink" title="五、卸载MySQL"></a>五、卸载MySQL</h2><p>如果你想卸载MySQL，也很简单。</p>
<p>点击开始菜单，输入cmd，选择 “命令提示符”，选择右侧的 “以管理员身份运行”。</p>
<img src="/2024/02/06/javaweb-day03-mysql/image-20220611083741275.png" alt="image-20220611083741275" style="zoom:80%;"> 

<ol>
<li>敲入<code>net stop mysql</code>，回车。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net stop mysql</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/1556823-20181220222924783-57600848.png" alt=" "> </p>
<ol start="2">
<li>再敲入<code>mysqld -remove mysql</code>，回车。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqld -remove mysql</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/1556823-20181220223025128-587235464.png" alt="img"> </p>
<ol start="3">
<li>最后删除MySQL目录及相关的环境变量。</li>
</ol>
<p><strong>至此，MySQL卸载完成！</strong></p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><ul>
<li><p>关系型数据库（RDBMS）：建立在关系模型基础上，由多张相互连接的二维表组成的数据库。</p>
<p>特点：</p>
<ul>
<li>使用表存储数据，格式统一，便于维护</li>
<li>使用SQL语言操作，标准统一，使用方便，可以用复杂查询</li>
</ul>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206131607795.png" alt="image-20240206131607795"></p>
</li>
</ul>
<h2 id="SQL介绍"><a href="#SQL介绍" class="headerlink" title="SQL介绍"></a>SQL介绍</h2><ul>
<li><p>SQL：一门操作关系型数据库的编程语言，定义操作所有关系型数据库的统一标准。</p>
<table>
<thead>
<tr>
<th>SQL语句可以单行或者多行书写，以分号结尾。</th>
<th>show databases;</th>
</tr>
</thead>
<tbody><tr>
<td>SQL语句可以使用空格&#x2F;缩进来增强语句的可读性。</td>
<td>show  databases;</td>
</tr>
<tr>
<td>MySQL数据库的SQL语句不区分大小写。</td>
<td>SHOW DATABASES;</td>
</tr>
<tr>
<td>注释： 单行注释：– 注释内容 或 # 注释内容（MySQL特有）</td>
<td>–show databases;</td>
</tr>
<tr>
<td>多行注释：&#x2F;* 注释内容 *&#x2F;</td>
<td>&#x2F;* show database; *&#x2F;</td>
</tr>
</tbody></table>
</li>
<li><p>SQL语句通常被分为四大类：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>全称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DDL</td>
<td>Data Definition Language</td>
<td>数据定义语言，用来定义数据库对象（数据库，表，字段）</td>
</tr>
<tr>
<td>DML</td>
<td>Data Manipulation Language</td>
<td>数据操作语言，用来对数据表中的数据进行增删改</td>
</tr>
<tr>
<td>DQL</td>
<td>Data Query Language</td>
<td>数据查询语言，用来查询数据库中表的记录</td>
</tr>
<tr>
<td>DCL</td>
<td>Data Control Language</td>
<td>数据控制语言，用来创建数据库用户，控制数据库的访问权限</td>
</tr>
</tbody></table>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206132230078.png" alt="image-20240206132230078"></p>
</li>
</ul>
<h1 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h1><h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><p>– 查询所有数据库<br>show databases;</p>
<p>– 创建数据库<br>create database if not exists db02;</p>
<p>–删除数据库</p>
<p>drop database if exists db02;</p>
<p>注意事项：</p>
<ul>
<li>上述语法中的databse，也可以替换成schema。如 create schema db01;</li>
</ul>
<h2 id="图形化工具"><a href="#图形化工具" class="headerlink" title="图形化工具"></a>图形化工具</h2><p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206135040052.png" alt="image-20240206135040052"></p>
<p>jetbrain已经将datagrip中的功能集成到了intellij idea中。</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206134857300.png" alt="image-20240206134857300"></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206135024009.png" alt="image-20240206135024009"></p>
<h2 id="数据表操作"><a href="#数据表操作" class="headerlink" title="数据表操作"></a>数据表操作</h2><ul>
<li><p>创建</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 表名&#123;</span><br><span class="line">	字段<span class="number">1</span> 字段类型 [约束] [comment 字段<span class="number">1</span>注释],</span><br><span class="line">	...</span><br><span class="line">    字段n 字段类型 [约束] [comment 字段n注释],	</span><br><span class="line">&#125;[comment 表注释];</span><br></pre></td></tr></table></figure>
</li>
<li><p>约束</p>
<ul>
<li>概念：约束是作用于表中字段上的规则，用于限制存储在表中的数据</li>
<li>目的：保证数据库中的数据正确性，有效性和完整性。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>约束</th>
<th>描述</th>
<th>关键字</th>
</tr>
</thead>
<tbody><tr>
<td>非空约束</td>
<td>限制该字段值不能为null</td>
<td>not null</td>
</tr>
<tr>
<td>唯一约束</td>
<td>保证字段的所有数据都是唯一、不重复的</td>
<td>unique</td>
</tr>
<tr>
<td>主键约束</td>
<td>主键是一行数据的唯一标识、要求非空且唯一</td>
<td>primary key（auto_increment)</td>
</tr>
<tr>
<td>默认约束</td>
<td>保存数据时，如果未指定该字段值，这采用默认值</td>
<td>default</td>
</tr>
<tr>
<td>外键约束</td>
<td>让两张表的数据建立连接，保证数据的一致性和完整性</td>
<td>foreign key</td>
</tr>
</tbody></table>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206140150269.png" alt="image-20240206140150269"></p>
<h1 id="DDL（表操作）"><a href="#DDL（表操作）" class="headerlink" title="DDL（表操作）"></a>DDL（表操作）</h1><ul>
<li><p>数据类型</p>
<p>MySQL中的数据类型有很多，主要分为三类：数值类型、字符串类型、日期时间类型。</p>
<p>数值类型：</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206140956703.png" alt="image-20240206140956703"></p>
<p>字符串类型：</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206141713907.png" alt="image-20240206141713907"></p>
<p>日期时间类型：</p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20231102151145540.png" alt="image-20231102151145540"></p>
</li>
</ul>
<h2 id="图形化方式建表"><a href="#图形化方式建表" class="headerlink" title="图形化方式建表"></a>图形化方式建表</h2><p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206142527606.png" alt="image-20240206142527606"></p>
<hr>

<ul>
<li><p>查询</p>
<ul>
<li>查询当前数据库所有表：show tables;</li>
<li>查询表结构：desc 表名；</li>
<li>查询建表语句：show create table 表名；</li>
</ul>
</li>
</ul>
<hr>

<ul>
<li><p>修改</p>
<ul>
<li><p>添加字段：alter table 表名 add 字段名 类型（长度） [comment 注释] [约束];</p>
</li>
<li><p>修改字段类型：alter table 表名 modify 字段名 新数据类型（长度）;</p>
</li>
<li><p>修改字段名和字段类型：alter table 表名 change 旧字段名 新字段名 类型（长度） [comment 注释] [约束];</p>
</li>
<li><p>删除字段：alter table 表名 drop column 字段名;</p>
</li>
<li><p>修改表名：rename table 表名 to 新表名;</p>
</li>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- DDL：修改表结构</span></span><br><span class="line"><span class="comment">-- 修改：为表 tb_emp添加字段 qq varchar(11)</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_emp <span class="keyword">add</span> qq <span class="type">varchar</span>(<span class="number">11</span>) comment <span class="string">&#x27;QQ&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改：修改表 tb_emp字段类型 qq varchar(13)</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_emp modify qq <span class="type">varchar</span>(<span class="number">11</span>) comment <span class="string">&#x27;QQ&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改： 修改表 tb_emp 字段名 qq为 qq_num  varchar(13)</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_emp change qq qq_num <span class="type">varchar</span>(<span class="number">13</span>) comment <span class="string">&#x27;QQ&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改：删除tb_emp的qq_num字段</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tb_emp <span class="keyword">drop</span> <span class="keyword">column</span>  qq_num;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改：将tb_emp表修改为 emp</span></span><br><span class="line">rename <span class="keyword">table</span> tb_emp <span class="keyword">to</span> emp;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>

<ul>
<li><p>删除</p>
<ul>
<li>删除表：drop table[if  exists] 表名;</li>
</ul>
</li>
</ul>
<h1 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h1><ul>
<li><p>插入数据（INSERT）</p>
<ul>
<li>指定字段添加数据： insert into 表名 （字段名1，字段名2）values(值1，值2);</li>
<li>全部字段添加数据： insert into 表名 values（值1，值2，。。。)</li>
<li>批量添加数据（指定字段）：insert into 表名（字段名 1，字段名2） values（值1，值2）（值1，值2）;</li>
<li>批量添加数据（全部字段）：insert into 表名 values（值1，值2，…)，（值1，值2，…);</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- DML: 数据操作语言</span></span><br><span class="line"><span class="comment">-- DML：插入数据 - insert</span></span><br><span class="line"><span class="comment">-- 1. 为 emp 表的username, name, gender字段插入值</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp (username,name,gender,create_time,update_time) <span class="keyword">values</span> (<span class="string">&#x27;wuji&#x27;</span>,<span class="string">&#x27;张无忌&#x27;</span>,<span class="number">1</span>,now(),now());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 为emp表的所有字段插入值</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp(id, username, password, name, gender, image, job, entrydate, create_time, update_time) <span class="keyword">values</span> (<span class="keyword">null</span>, <span class="string">&#x27;zhiruo&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;周芷若&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;1.jpg&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2010-01-01&#x27;</span>,now(),now());</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp <span class="keyword">values</span> (<span class="keyword">null</span>, <span class="string">&#x27;zhiruo2&#x27;</span>,<span class="string">&#x27;123&#x27;</span>,<span class="string">&#x27;周芷若2&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;1.jpg&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2010-01-01&#x27;</span>,now(),now());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 批量为emp表的username, name, gender字段插入值</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp(username, name, image,  create_time, update_time) <span class="keyword">values</span> (<span class="string">&#x27;weifuwang&#x27;</span>,<span class="string">&#x27;韦一笑&#x27;</span>,<span class="number">1</span>,now(),now()),(<span class="string">&#x27;xieshiwang&#x27;</span>,<span class="string">&#x27;谢逊&#x27;</span>,<span class="number">1</span>,now(),now());</span><br></pre></td></tr></table></figure>



<p>注意事项：</p>
<ol>
<li><p>插入数据时，指定的字段顺序需要与值的顺序一一对应</p>
</li>
<li><p>字符串和日期型数据应该包含在引号中</p>
</li>
<li><p>插入的数据大小，应在字段的规定范围内</p>
</li>
</ol>
</li>
</ul>
<hr>

<ul>
<li><p>更新数据（UPDATE）</p>
<ul>
<li><p>修改数据： update 表名 set 字段1&#x3D;值1，字段2&#x3D;值2，… [where 条件]；</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- DML：更新数据 - update</span></span><br><span class="line"><span class="comment">-- 1. 将emp表的ID为1的员工，姓名name字段更新为‘张三’</span></span><br><span class="line"><span class="keyword">update</span> emp <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span>,update_time<span class="operator">=</span>now() <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 将tb_emp表的所有员工的入职日期更改为‘2020-01-01’</span></span><br><span class="line"><span class="keyword">update</span> emp <span class="keyword">set</span> entrydate <span class="operator">=</span> <span class="string">&#x27;2010-01-01&#x27;</span>, update_time <span class="operator">=</span> now();</span><br></pre></td></tr></table></figure>

<hr></li>
</ul>
</li>
<li><p>删除数据（DELETE）</p>
<ul>
<li>删除数据： delete from 表名 where [条件];</li>
</ul>
<p>注意事项：</p>
<ol>
<li>DELETE语句的条件可以有，也可以没有，如果没有条件，则会删除整张表的所有数据。</li>
<li>DELETE语句不能删除某一个字段的值（如果要删除，可以使用UPDATE，该字段的值为NULL）.</li>
</ol>
</li>
</ul>
<hr>  

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206151657551.png" alt="image-20240206151657551"></p>
<h1 id="DQL-Data-query-language"><a href="#DQL-Data-query-language" class="headerlink" title="DQL(Data query language)"></a>DQL(Data query language)</h1><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    字段列表</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    表名列表</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    条件列表</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    分组字段列表</span><br><span class="line"><span class="keyword">having</span></span><br><span class="line">    分组后条件列表</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">    排序字段列表</span><br><span class="line">limit</span><br><span class="line">    分页参数</span><br></pre></td></tr></table></figure>

<ul>
<li>基本查询</li>
<li>条件查询（where）</li>
<li>分组查询（group by）</li>
<li>排序查询（order by）</li>
<li>分页查询（limit）</li>
</ul>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206200329379.png" alt="image-20240206200329379"></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240206201404182.png" alt="image-20240206201404182"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> name,entrydate <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> id, username, password, name, gender, image, job, entrydate, create_time, update_time <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- (不推荐，性能低)</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询所有员工的name, entrydate, 起别名</span></span><br><span class="line"><span class="keyword">select</span> name <span class="keyword">as</span> 姓名, entrydate <span class="keyword">as</span> 入职日期 <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询所有员工的name, entrydate, 起别名(别名有空格）</span></span><br><span class="line"><span class="keyword">select</span> name <span class="keyword">as</span> <span class="string">&#x27;姓 名&#x27;</span>, entrydate <span class="keyword">as</span> 入职日期 <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 查询已有的员工关联了哪几种职位（不要重复）</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> job <span class="keyword">from</span> tb_emp;</span><br></pre></td></tr></table></figure>



<hr>

<ul>
<li><p>条件查询（where）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表名 <span class="keyword">where</span> 条件列表;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>比较运算符</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&gt;&#x3D;</td>
<td>大于等于</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&lt;&#x3D;</td>
<td>小于等于</td>
</tr>
<tr>
<td>&#x3D;</td>
<td>等于</td>
</tr>
<tr>
<td>&lt;&gt; 或 !&#x3D;</td>
<td>不等于</td>
</tr>
<tr>
<td>between … and …</td>
<td>在某个范围之内（含最小，最大值）</td>
</tr>
<tr>
<td>in(…)</td>
<td>在in之后的列表中的值，多选一</td>
</tr>
<tr>
<td>like 占位符</td>
<td>模糊匹配（_匹配单个字符，%匹配任意字符）</td>
</tr>
<tr>
<td>is null</td>
<td>是null</td>
</tr>
<tr>
<td>and 或 &amp;&amp;</td>
<td>并且（多个条件同时成立）</td>
</tr>
<tr>
<td>or 或 ||</td>
<td>或者（多个条件任意一个成立）</td>
</tr>
<tr>
<td>not 或 ||</td>
<td>非，不是</td>
</tr>
</tbody></table>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 查询姓名为金庸的员工</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;金庸&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 查询id小于等于5的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> id <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询没有分配职位的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> job <span class="keyword">is</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 查询有职位的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> job <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 查询密码不等于‘123456’的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> password <span class="operator">!=</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> password <span class="operator">&lt;&gt;</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6. 查询入职日在&#x27;2000-01-01&#x27;（包含）到&#x27;2020-01-01&#x27;(包含）之间的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="keyword">between</span> <span class="string">&#x27;2000-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2010-01-01&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&gt;=</span> <span class="string">&#x27;2000-01-01&#x27;</span> <span class="keyword">and</span> entrydate <span class="operator">&lt;=</span> <span class="string">&#x27;2010-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 7. 查询入职时间在&#x27;2000-01-01&#x27;（包含）到&#x27;2010-01-01&#x27;（包含）之间且性别为女的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="keyword">between</span> <span class="string">&#x27;2000-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2010-01-01&#x27;</span> <span class="keyword">and</span> gender <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 8. 查询职位是2（讲师），3（学工主管），4（教研主管）的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> job <span class="operator">=</span> <span class="number">2</span> <span class="keyword">or</span> job <span class="operator">=</span> <span class="number">3</span> <span class="keyword">or</span> job <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> job <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 9. 查询姓名为两个字的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;__&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 10. 查询姓‘张’的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;张%&#x27;</span>;</span><br></pre></td></tr></table></figure>



  <hr>

<ul>
<li><p>分组查询（group by）</p>
<p>聚合函数：将一列数据作为一个整体，进行纵向运算。</p>
<p>聚合查询语法：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 聚合函数（字段列表） <span class="keyword">from</span> 表名；</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>count</td>
<td>统计数量</td>
</tr>
<tr>
<td>max</td>
<td>最大值</td>
</tr>
<tr>
<td>min</td>
<td>最小值</td>
</tr>
<tr>
<td>avg</td>
<td>平均值</td>
</tr>
<tr>
<td>sum</td>
<td>求和</td>
</tr>
</tbody></table>
<p>示例说明：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1、统计该企业的员工数量 -- count</span></span><br><span class="line"><span class="comment">-- A. count(字段）</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> tb_emp;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(job) <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- B. count(常量)</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">0</span>) <span class="keyword">from</span> tb_emp;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> tb_emp;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="string">&#x27;a&#x27;</span>) <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- C. count(*)</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 统计该企业最早入职的员工 --min</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">min</span>(entrydate) <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 统计该企业最晚入职的员工 --max</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(entrydate) <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 统计该企业员工ID的平均值 --avg</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(id) <span class="keyword">from</span> tb_emp;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项：</strong></p>
<ul>
<li>null值不参与所有聚合函数运算</li>
<li>统计数量可以使用：count(*) count(字段) count(常量)，推荐使用count(*)。</li>
</ul>
<hr>

<p>分组查询：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表名 [<span class="keyword">where</span> 条件] <span class="keyword">group</span> <span class="keyword">by</span> 分组字段名 [<span class="keyword">having</span> 分组过滤条件];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 根据性别分组，统计男性和女性员工的数量 count(*)</span></span><br><span class="line"><span class="keyword">select</span> gender,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_emp <span class="keyword">group</span> <span class="keyword">by</span> gender;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 先查询入职时间在 ’2015-01-01’(包含）以前的员工，并对结果根据职位分组，获取员工数量大于等于2的职位</span></span><br><span class="line"><span class="keyword">select</span> job, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&lt;=</span> <span class="string">&#x27;2015-01-01&#x27;</span> <span class="keyword">group</span> <span class="keyword">by</span> job <span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>where和having的区别</p>
<ol>
<li>执行时机不同：where是分组之前进行过滤，不满足where条件，不参与分组；而having是分组之后对结果进行过滤。</li>
<li>判断条件不同：<font color="red">where不能对聚合函数判断，而having可以。</font></li>
</ol>
</li>
<li><p>注意事项</p>
<ul>
<li><font color="red">分组之后，查询的字段一般为聚合聚合函数和分组字段，查询其他字段无任何意义。</font></li>
<li>执行顺序：where &gt; 聚合函数 &gt; having。</li>
</ul>
</li>
</ul>
<hr>
</li>
<li><p>排序查询（order by）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表名 [<span class="keyword">where</span> 条件] <span class="keyword">group</span> <span class="keyword">by</span> 分组字段名 [<span class="keyword">having</span> 分组过滤条件] <span class="keyword">order</span> <span class="keyword">by</span> 字段<span class="number">1</span> 排序方式<span class="number">1</span>, 字段<span class="number">2</span> 排序方式<span class="number">2</span>, ...;</span><br></pre></td></tr></table></figure>

<p>排序方式</p>
<ul>
<li>ASC：升序排序（默认）</li>
<li>DESC：降序排序</li>
</ul>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 根据入职时间，对员工进行升序排序 --asc</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">order</span> <span class="keyword">by</span> entrydate <span class="keyword">asc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 根据入职时间，对员工进行降序排序 --desc</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">order</span> <span class="keyword">by</span> entrydate <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1. 根据入职时间，对员工进行升序排序，入职时间相同，再根据更新事件进行降序排序 --asc</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">order</span> <span class="keyword">by</span> entrydate, update_time <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<hr>
</li>
<li><p>分页查询（limit）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表名 limit 起始索引,查询记录数；</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 从起始索引0开始查询员工数据，每页展示5条数据</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp limit <span class="number">0</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 查询第1页员工数据，每页展示5条数据</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp limit <span class="number">0</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询第2页员工数据，每页展示5条数据</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp limit <span class="number">5</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询第3页员工数据，每页展示5条数据</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp limit <span class="number">10</span>, <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<ol>
<li>起始索引从0开始，起始索引&#x3D;（查询页码 - 1）* 每页显示记录数。</li>
<li>分页查询是数据库的方言，不同数据库有不同的实现，MySQL是LIMIT。</li>
<li>如果查询的是第一页的数据，其实索引可以省略，可以简写为limit 10。</li>
</ol>
</li>
</ul>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 案例2-1：根据需求，完成员工性别信息的统计</span></span><br><span class="line"><span class="comment">-- 将1转化为男性员工，2转换为女性员工</span></span><br><span class="line"><span class="comment">-- if(条件表达式, true取值, false取值)</span></span><br><span class="line"><span class="keyword">select</span> if(gender<span class="operator">=</span> <span class="number">1</span>,<span class="string">&#x27;男性员工&#x27;</span>,<span class="string">&#x27;女性员工&#x27;</span>) 性别, <span class="built_in">count</span>(gender) 数量 <span class="keyword">from</span> tb_emp <span class="keyword">group</span> <span class="keyword">by</span> (gender);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例2-2：根据需求，完成员工职位信息的统计</span></span><br><span class="line"><span class="comment">-- case 表达式 when 值1 then 结果1 when 值2 then 结果2 ... else ... end</span></span><br><span class="line"><span class="keyword">select</span> (<span class="keyword">case</span> job <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;班主任&#x27;</span> <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;讲师&#x27;</span> <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">&#x27;学工主管&#x27;</span> <span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="string">&#x27;教研主管&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;未分配职位&#x27;</span> <span class="keyword">end</span>) 职位, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_emp <span class="keyword">group</span> <span class="keyword">by</span> job;</span><br></pre></td></tr></table></figure>

<p>函数：</p>
<ul>
<li>if(表达式,tvalue,fvalue):当表达式为true时，取值tvalue；当表达式为false时，取值fvalue;</li>
<li>case expr when value1 then result1 [when value2 then result2 …][else result] end</li>
</ul>
<h1 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h1><ul>
<li>字段1 [as] 别名1，字段2 [as] 别名2，…</li>
</ul>
<h1 id="多表模式"><a href="#多表模式" class="headerlink" title="多表模式"></a>多表模式</h1><ul>
<li><p>一对多（多对一）</p>
<p>外键：给A中的某个字段加外键（B中某个字段），意味着A中该字段的值要在B中该字段范围内取值。</p>
<p>实现细节：在数据库表中多的一方，添加字段，来关联一方的主键。（使用外键约束建立表联系）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建表时的指定方式</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> 表名(</span><br><span class="line">    字段名 数据类型,</span><br><span class="line">    ...</span><br><span class="line">    [<span class="keyword">constraint</span>][外键名称] <span class="keyword">foreign</span> key(外键字段名) <span class="keyword">references</span> 主表（字段名）</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建完表后的执行方式，添加外键</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> <span class="keyword">constraint</span> 外键名称 <span class="keyword">foreign</span> key(外键字段名) <span class="keyword">references</span> 主表（字段名）;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240207164619163.png" alt="image-20240207164619163"></p>
<p><strong>物理外键</strong></p>
<p>概念：使用foreign  key定义外键关联另外一张表</p>
<p>缺点：</p>
<ul>
<li>影响增、删、改的效率（需要检查外键关系）。</li>
<li>仅用于单节点数据库 ，不适用与分布式、集群场景。</li>
<li>容易引发数据库的死锁问题，消耗性能。</li>
</ul>
<p><strong>逻辑外键（推荐）</strong></p>
<p>概念：在业务逻辑中，解决外键关联。</p>
<p>通过逻辑外键，就可以很方便的解决上述问题。</p>
</li>
<li><p>一对一</p>
<p>案例：用户与身份证信息的关系</p>
<p>关系：一对一关系，多用于单表拆分，将一张表的基础字段放在一张表中，其他字段放在另一张表中，以提升操作效率</p>
</li>
</ul>
<p>​		实现：<font color="red">在任意一方加入外键，关联另外一方的主键，并且设置外键为唯一的（UNIQUE）</font></p>
<ul>
<li><p>多对多</p>
<p>案例：学生与课程的关系</p>
<p>关系：一个学生可以选修多门课程，一门课程也可以供多个学生选择</p>
<p>实现：建立第三张中间表，中间表中至少包含两个外键，分别关联两方主键</p>
</li>
</ul>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240207174539789.png" alt="image-20240207174539789"></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240207175403377.png" alt="image-20240207175403377"></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240207181108591.png" alt="image-20240207181108591"></p>
<h1 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h1><ul>
<li><p>多表查询：指从多张表中查询数据。</p>
</li>
<li><p>笛卡尔积：笛卡尔乘积是指数学中，两个集合的所有组合情况。</p>
</li>
<li><p>分类</p>
<ul>
<li><p>内连接：相当于查询A、B交集部分数据</p>
<p>语法：</p>
<ul>
<li><p>隐式内连接：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表<span class="number">1</span>，表<span class="number">2</span> <span class="keyword">where</span> 条件 ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 实例</span></span><br><span class="line"><span class="comment">-- A. 查询员工的姓名，及所属的部门名称（隐式内连接实现）</span></span><br><span class="line"><span class="keyword">select</span> tb_dept.name,tb_emp.name <span class="keyword">from</span> tb_emp, tb_dept <span class="keyword">where</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 起别名</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp e, tb_dept d <span class="keyword">where</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显式内连接：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表<span class="number">1</span> [<span class="keyword">inner</span>] <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 连接条件 ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 实例</span></span><br><span class="line"><span class="comment">-- B. 查询员工的姓名，及所属的部门名称（显式内连接实现）</span></span><br><span class="line"><span class="keyword">select</span> tb_emp.name,tb_dept.name <span class="keyword">from</span> tb_emp <span class="keyword">inner</span> <span class="keyword">join</span> tb_dept <span class="keyword">on</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>外连接：</p>
<ul>
<li><p>左外连接：查询左表所有数据（包括两张表交集部分的数据）(经常使用)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">left</span> [<span class="keyword">outer</span>] <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 连接条件 ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- A. 查询员工表所有员工的姓名，相对应的部门名称（左外连接）</span></span><br><span class="line"><span class="keyword">select</span> e.name, d.name <span class="keyword">from</span> tb_emp e <span class="keyword">left</span> <span class="keyword">join</span> tb_dept d <span class="keyword">on</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>右外连接：查询右表所有数据（包括两张表交集部分的数据）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> 字段列表 <span class="keyword">from</span> 表<span class="number">1</span> <span class="keyword">right</span> [<span class="keyword">outer</span>] <span class="keyword">join</span> 表<span class="number">2</span> <span class="keyword">on</span> 连接条件 ...;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- B. 查询部门表所有部门的名称，和对应的员工名称（右外连接）</span></span><br><span class="line"><span class="keyword">select</span> e.name,d.name <span class="keyword">from</span> tb_emp e <span class="keyword">right</span> <span class="keyword">join</span> tb_dept d <span class="keyword">on</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>子查询</p>
<ul>
<li><p>SQL语句中嵌套select语句，称为嵌套查询，又称子查询。</p>
</li>
<li><p>形式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> column1 <span class="operator">=</span> (<span class="keyword">select</span> column1 <span class="keyword">from</span> t2 ... );</span><br></pre></td></tr></table></figure>
</li>
<li><p>子查询外部的语句可以是 insert&#x2F;update&#x2F;delete&#x2F;select中的任何一个，最常见的是select。</p>
</li>
<li><p>分类</p>
<ul>
<li><p>标量子查询：子查询返回的结果为单个值</p>
<ul>
<li><p>子查询返回的结果是单个值（数字、字符串、日期等），最简单的形式</p>
</li>
<li><p>最常见的操作符： &#x3D;   &lt;&gt;   &gt;   &gt;&#x3D;   &lt;   &lt;&#x3D;</p>
<p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- A. 查询 “教研部”的所有员工信息</span></span><br><span class="line"><span class="comment">-- a. 查询教研部的ID - tb_dept（标量子查询）</span></span><br><span class="line"><span class="keyword">select</span>  id  <span class="keyword">from</span> tb_dept <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;教研部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- b. 查询教研部ID下的员工信息 tb_emp</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span>  dept_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span>  dept_id <span class="operator">=</span> (<span class="keyword">select</span>  id  <span class="keyword">from</span> tb_dept <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;教研部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- B. 查询在”方东白“入职之前的员工信息</span></span><br><span class="line"><span class="comment">-- a. 查询方东白的入职时间（单行单列值）</span></span><br><span class="line"><span class="keyword">select</span> entrydate <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;方东白&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- b. 查询在“方东白”入职之后的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&gt;</span> <span class="string">&#x27;2012-11-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&gt;</span> (<span class="keyword">select</span> entrydate <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;方东白&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>列子查询：子查询返回的结果为一列</p>
<ul>
<li><p>子查询返回的结果是一列（可以是多行 ）</p>
</li>
<li><p>常用的操作符：in、not in等</p>
</li>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 列子查询</span></span><br><span class="line"><span class="comment">-- A. 查询”教研部“和”咨询部“的所有员工信息</span></span><br><span class="line"><span class="comment">-- a. 查询教研部和咨询部的ID</span></span><br><span class="line"><span class="keyword">select</span> id  <span class="keyword">from</span> tb_dept <span class="keyword">where</span> name <span class="operator">=</span><span class="string">&#x27;教研部&#x27;</span> <span class="keyword">or</span> name <span class="operator">=</span> <span class="string">&#x27;咨询部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- b. 根据部门ID，查询该部门下的员工信息 tb_emp</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> dept_id <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> dept_id <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> id  <span class="keyword">from</span> tb_dept <span class="keyword">where</span> name <span class="operator">=</span><span class="string">&#x27;教研部&#x27;</span> <span class="keyword">or</span> name <span class="operator">=</span> <span class="string">&#x27;咨询部&#x27;</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>行子查询：子查询返回的结果为一行</p>
<ul>
<li><p>子查询返回的结果是一行（可以是多列）</p>
</li>
<li><p>常用的操作符： &#x3D;、&lt;&gt;、innot in</p>
</li>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- A. 查询与“韦一笑”的入职日期及值为都相同的员工信息；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- a. 查询“韦一笑”的入职日期及职位</span></span><br><span class="line"><span class="keyword">select</span> entrydate,job <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;韦一笑&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- b. 查询与其入职日期及职位都相同的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> (entrydate,job) <span class="operator">=</span> (<span class="keyword">select</span> entrydate,job <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;韦一笑&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>表子查询：子查询返回的结果为多行多列</p>
<ul>
<li><p>子查询返回的结果是多行多列，常作为临时表</p>
</li>
<li><p>常用的操作符：in</p>
</li>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 表子查询</span></span><br><span class="line"><span class="comment">-- A. 查询入职日期是“2006-01-01”之后的员工信息，及其部门名称</span></span><br><span class="line"><span class="comment">-- a.查询入职日期是”2006-01-01“之后的员工信息</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&gt;</span> <span class="string">&#x27;2006-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- b.查询这部分员工信息及其部门名称 - tb_dept</span></span><br><span class="line"><span class="keyword">select</span> e.<span class="operator">*</span>,d.name <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&gt;</span> <span class="string">&#x27;2006-01-01&#x27;</span>) e, tb_dept d <span class="keyword">where</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>实操</strong></p>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240208165030152.png" alt="image-20240208165030152"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 部门管理</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_dept</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">    name        <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">unique</span> comment <span class="string">&#x27;部门名称&#x27;</span>,</span><br><span class="line">    create_time datetime    <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    update_time datetime    <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;修改时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;部门表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_dept (id, name, create_time, update_time)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;学工部&#x27;</span>, now(), now()),</span><br><span class="line">       (<span class="number">2</span>, <span class="string">&#x27;教研部&#x27;</span>, now(), now()),</span><br><span class="line">       (<span class="number">3</span>, <span class="string">&#x27;咨询部&#x27;</span>, now(), now()),</span><br><span class="line">       (<span class="number">4</span>, <span class="string">&#x27;就业部&#x27;</span>, now(), now()),</span><br><span class="line">       (<span class="number">5</span>, <span class="string">&#x27;人事部&#x27;</span>, now(), now());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 员工管理</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_emp</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">    username    <span class="type">varchar</span>(<span class="number">20</span>)      <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">unique</span> comment <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">    password    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">default</span> <span class="string">&#x27;123456&#x27;</span> comment <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">    name        <span class="type">varchar</span>(<span class="number">10</span>)      <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    gender      tinyint unsigned <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;性别, 说明: 1 男, 2 女&#x27;</span>,</span><br><span class="line">    image       <span class="type">varchar</span>(<span class="number">300</span>) comment <span class="string">&#x27;图像&#x27;</span>,</span><br><span class="line">    job         tinyint unsigned comment <span class="string">&#x27;职位, 说明: 1 班主任,2 讲师, 3 学工主管, 4 教研主管, 5 咨询师&#x27;</span>,</span><br><span class="line">    entrydate   <span class="type">date</span> comment <span class="string">&#x27;入职时间&#x27;</span>,</span><br><span class="line">    dept_id     <span class="type">int</span> unsigned comment <span class="string">&#x27;部门ID&#x27;</span>,</span><br><span class="line">    create_time datetime         <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    update_time datetime         <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;修改时间&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;员工表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tb_emp</span><br><span class="line">(id, username, password, name, gender, image, job, entrydate, dept_id, create_time, update_time)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;jinyong&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;金庸&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;1.jpg&#x27;</span>, <span class="number">4</span>, <span class="string">&#x27;2000-01-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">2</span>, <span class="string">&#x27;zhangwuji&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;张无忌&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2015-01-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">3</span>, <span class="string">&#x27;yangxiao&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;杨逍&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;3.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2008-05-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">4</span>, <span class="string">&#x27;weiyixiao&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;韦一笑&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;4.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2007-01-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">5</span>, <span class="string">&#x27;changyuchun&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;常遇春&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;5.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2012-12-05&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">6</span>, <span class="string">&#x27;xiaozhao&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;小昭&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;6.jpg&#x27;</span>, <span class="number">3</span>, <span class="string">&#x27;2013-09-05&#x27;</span>, <span class="number">1</span>, now(), now()),</span><br><span class="line">       (<span class="number">7</span>, <span class="string">&#x27;jixiaofu&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;纪晓芙&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;7.jpg&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2005-08-01&#x27;</span>, <span class="number">1</span>, now(), now()),</span><br><span class="line">       (<span class="number">8</span>, <span class="string">&#x27;zhouzhiruo&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;周芷若&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;8.jpg&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2014-11-09&#x27;</span>, <span class="number">1</span>, now(), now()),</span><br><span class="line">       (<span class="number">9</span>, <span class="string">&#x27;dingminjun&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;丁敏君&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;9.jpg&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2011-03-11&#x27;</span>, <span class="number">1</span>, now(), now()),</span><br><span class="line">       (<span class="number">10</span>, <span class="string">&#x27;zhaomin&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;赵敏&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;10.jpg&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;2013-09-05&#x27;</span>, <span class="number">1</span>, now(), now()),</span><br><span class="line">       (<span class="number">11</span>, <span class="string">&#x27;luzhangke&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;鹿杖客&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;11.jpg&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;2007-02-01&#x27;</span>, <span class="number">3</span>, now(), now()),</span><br><span class="line">       (<span class="number">12</span>, <span class="string">&#x27;hebiweng&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;鹤笔翁&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;12.jpg&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;2008-08-18&#x27;</span>, <span class="number">3</span>, now(), now()),</span><br><span class="line">       (<span class="number">13</span>, <span class="string">&#x27;fangdongbai&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;方东白&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;13.jpg&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;2012-11-01&#x27;</span>, <span class="number">3</span>, now(), now()),</span><br><span class="line">       (<span class="number">14</span>, <span class="string">&#x27;zhangsanfeng&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;张三丰&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;14.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2002-08-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">15</span>, <span class="string">&#x27;yulianzhou&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;俞莲舟&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;15.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2011-05-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">16</span>, <span class="string">&#x27;songyuanqiao&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;宋远桥&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;16.jpg&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;2007-01-01&#x27;</span>, <span class="number">2</span>, now(), now()),</span><br><span class="line">       (<span class="number">17</span>, <span class="string">&#x27;chenyouliang&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;陈友谅&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;17.jpg&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;2015-03-21&#x27;</span>, <span class="keyword">NULL</span>, now(), now());</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tb_emp,</span><br><span class="line">     tb_dept;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb_emp.name, tb_dept.name</span><br><span class="line"><span class="keyword">from</span> tb_emp,</span><br><span class="line">     tb_dept</span><br><span class="line"><span class="keyword">where</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb_emp.name, tb_dept.name</span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line">         <span class="keyword">join</span> tb_dept <span class="keyword">on</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb_emp.name, tb_dept.name</span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> tb_dept <span class="keyword">on</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb_emp.name, tb_dept.name</span><br><span class="line"><span class="keyword">from</span> tb_dept</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> tb_emp <span class="keyword">on</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb_emp.name, tb_dept.name</span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line">         <span class="keyword">right</span> <span class="keyword">join</span> tb_dept <span class="keyword">on</span> tb_emp.dept_id <span class="operator">=</span> tb_dept.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> tb_dept.id</span><br><span class="line"><span class="keyword">from</span> tb_dept</span><br><span class="line"><span class="keyword">where</span> tb_dept.name <span class="operator">=</span> <span class="string">&#x27;教研部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> dept_id <span class="operator">=</span> (<span class="keyword">select</span> tb_dept.id <span class="keyword">from</span> tb_dept <span class="keyword">where</span> tb_dept.name <span class="operator">=</span> <span class="string">&#x27;教研部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> entrydate</span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;方东白&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> entrydate <span class="operator">&gt;=</span> (<span class="keyword">select</span> entrydate <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;方东白&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> id</span><br><span class="line"><span class="keyword">from</span> tb_dept</span><br><span class="line"><span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;教研部&#x27;</span></span><br><span class="line">   <span class="keyword">or</span> name <span class="operator">=</span> <span class="string">&#x27;咨询部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> dept_id <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> tb_dept <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;教研部&#x27;</span> <span class="keyword">or</span> name <span class="operator">=</span> <span class="string">&#x27;咨询部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> entrydate, job</span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;韦一笑&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> (entrydate, job) <span class="operator">=</span> (<span class="keyword">select</span> entrydate, job <span class="keyword">from</span> tb_emp <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;韦一笑&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tb_emp</span><br><span class="line"><span class="keyword">where</span> entrydate <span class="operator">&gt;</span> <span class="string">&#x27;2006-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> e.<span class="operator">*</span>, d.name</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> entrydate <span class="operator">&gt;</span> <span class="string">&#x27;2006-01-01&#x27;</span>) e,</span><br><span class="line">     tb_dept d</span><br><span class="line"><span class="keyword">where</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1. 查询价格低于10元的菜品的名称、价格及其菜品的分类名称。</span></span><br><span class="line"><span class="keyword">select</span> d.name, d.price, c.name</span><br><span class="line"><span class="keyword">from</span> dish d,</span><br><span class="line">     category c</span><br><span class="line"><span class="keyword">where</span> d.category_id <span class="operator">=</span> c.id</span><br><span class="line">  <span class="keyword">and</span> d.price <span class="operator">&lt;</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 查询所有价格在10元（含）到50元（含）之间且状态为起售的菜品，展示出菜品的名称、价格及其菜品的分类名称（及时菜品没有分类，也需要将菜品查询出来）</span></span><br><span class="line"><span class="keyword">select</span> d.name, d.price, c.name</span><br><span class="line"><span class="keyword">from</span> dish d</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">join</span> category c <span class="keyword">on</span> d.price <span class="keyword">between</span> <span class="number">10</span> <span class="keyword">and</span> <span class="number">50</span> <span class="keyword">and</span> d.status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> c.id <span class="operator">=</span> d.category_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询每个分类下最贵的菜品，展示出分类的名称、最贵的菜品的价格。</span></span><br><span class="line"><span class="keyword">select</span> c.name, <span class="built_in">max</span>(d.price)</span><br><span class="line"><span class="keyword">from</span> dish d,</span><br><span class="line">     category c</span><br><span class="line"><span class="keyword">where</span> d.category_id <span class="operator">=</span> c.id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c.name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4.查询各个分类下，菜品状态为“起售”,并且该分类下菜品总数量大于等于3的分类名称。</span></span><br><span class="line"><span class="keyword">select</span> c.name, <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> category c,</span><br><span class="line">     dish d</span><br><span class="line"><span class="keyword">where</span> c.id <span class="operator">=</span> d.category_id</span><br><span class="line">  <span class="keyword">and</span> d.status <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c.name</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5.查询&quot;商务套餐A&quot;中包含了哪些菜品（展示出套餐名称、价格、包含的菜品名称、价格、份数）</span></span><br><span class="line"><span class="keyword">select</span> s.name, s.price, d.name, d.price, sd.copies</span><br><span class="line"><span class="keyword">from</span> setmeal s,</span><br><span class="line">     setmeal_dish sd,</span><br><span class="line">     dish d</span><br><span class="line"><span class="keyword">where</span> s.id <span class="operator">=</span> sd.setmeal_id</span><br><span class="line">  <span class="keyword">and</span> d.id <span class="operator">=</span> sd.dish_id</span><br><span class="line">  <span class="keyword">and</span> s.name <span class="operator">=</span> <span class="string">&#x27;商务套餐A&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6. 查询出低于菜品平均价格的菜品信息（展示出菜品名称、菜品价格）</span></span><br><span class="line"><span class="keyword">select</span> d.name, d.price</span><br><span class="line"><span class="keyword">from</span> dish d</span><br><span class="line"><span class="keyword">where</span> d.price <span class="operator">&lt;</span> (<span class="keyword">select</span> <span class="built_in">avg</span>(d.price) <span class="keyword">from</span> dish d);</span><br></pre></td></tr></table></figure>



<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><ul>
<li><p>概念</p>
<p>事务是一组操作的集合，它是一个不可分割的工作单位，事务会把所有操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。</p>
<blockquote>
<p>注意事项，默认MySQL的事务是自动提交的，也就是说，当执行一条DML语句，MySQL会立即隐式的提交事务。</p>
</blockquote>
</li>
<li><p>事务控制</p>
<ul>
<li>开启事务：start transaction; &#x2F; begin；</li>
<li>提交事务：commit；</li>
<li>回滚事务：rollback；</li>
</ul>
</li>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">start</span> transaction ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除学工部</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb_dept <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除部门下的员工</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb_emp <span class="keyword">where</span> dept_id <span class="operator">=</span><span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">commit</span> ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>特性</p>
<ul>
<li>原子性：事务是不可分割的最小单元，要么全部成功 ，要么全部失败</li>
<li>一致性：事务完成时，必须使所有的数据都保持一致状态</li>
<li>隔离性：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行</li>
<li>持久性：事务一旦提交或回滚，它对数据库中的数据改变就是永久的</li>
</ul>
</li>
</ul>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><ul>
<li><p>概念：索引使帮助数据库高校获取数据的数据结构。</p>
</li>
<li><p>优点：</p>
<ul>
<li><p>提升数据库查询的效率，降低数据库的IO成本</p>
</li>
<li><p>通过索引对数据进行排序，降低数据排序的成本，降低CPU消耗</p>
</li>
</ul>
</li>
<li><p>缺点：</p>
<ul>
<li>索引会占用存储空间。（存储空间问题不大）</li>
<li>索引大大提高了查询效率，同时也降低了insert，update，delete的效率。（查询占据90%以上的工作量）</li>
</ul>
</li>
<li><p>结构：</p>
<p>MySQL数据库支持的索引结构有很多，如：Hash索引，B+Tree索引，Full-Text索引等。我们平常说的索引，如果没有特别指明 ，都是指默认的B+Tree结构组织的索引。</p>
<blockquote>
<p>采用二叉搜索树或红黑树，会导致大数据量情况下，层级深，检索速度慢。</p>
</blockquote>
<ul>
<li><p>B+ Tree(多路平衡搜索树)</p>
<ul>
<li>每一个节点，可以存储多个key(有n个key，就有n个指针)。</li>
<li>所有数据都存储在叶子节点，非叶子节点仅用于索引数据。</li>
<li>叶子节点形成一颗双向链表，便于数据的排序及区间范围查询。</li>
</ul>
<p><img src="/2024/02/06/javaweb-day03-mysql/image-20240208173844570.png" alt="image-20240208173844570"></p>
</li>
</ul>
</li>
<li><p>语法</p>
<ul>
<li><p>创建索引</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> [<span class="keyword">unique</span>] index 索引名 <span class="keyword">on</span> 表名(字段名,...)；</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看索引</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> 表名;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除索引</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> index 索引名 <span class="keyword">on</span> 表名;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>实例</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建：为 tb_emp表的name字段建立一个索引</span></span><br><span class="line"><span class="keyword">create</span> index idx_emp_name <span class="keyword">on</span> tb_emp(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询：查询tb_emp表的索引信息</span></span><br><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> tb_emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除：删除tb_emp表中name字段的索引</span></span><br><span class="line"><span class="keyword">drop</span> index idx_emp_name <span class="keyword">on</span> tb_emp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意事项</p>
<ul>
<li>主键字段，在建表时，会自动创建主键索引。</li>
<li>添加唯一约束时，数据库实际上会添加唯一索引。</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb-day02-springbootweb请求响应</title>
    <url>/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/</url>
    <content><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205175737760.png" alt="image-20240205175737760"></p>
<ol>
<li><p>通过浏览器访问服务器，请求结束后返回响应结果</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205175907200.png" alt="image-20240205175907200"></p>
<p>之前编写的Controller只是简单的java类，没有实现任何的接口或者继承任何类，这个类Tomcat是不识别的，也不能直接运行，Tomcat虽然不识别自己编写的Controller，但是识别Servlet容器。</p>
<p>前段浏览器发起的请求都会经过DispatcherServlet，它会转给各个Controller，由Controller处理请求，将请求处理后的结果返回给DispatcherServlet，由于它的重要性，我们将其称为前端控制器。</p>
<ul>
<li>Web服务器将浏览器发来的数据进行解析，得到HttpServletRequest</li>
<li>将解析的处理结果处理为HttpServltResponse返回给浏览器</li>
</ul>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205180637734.png" alt="image-20240205180637734"></p>
</li>
<li><p>客户端通过HTTP协议与浏览器进行交流</p>
</li>
</ol>
<h1 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h1><h2 id="请求工具"><a href="#请求工具" class="headerlink" title="请求工具"></a>请求工具</h2><p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205181106830.png" alt="image-20240205181106830"></p>
<p><strong>postman</strong></p>
<p>postman是一款功能强大的网页调试与发送网页HTPP请求的Chrome插件。</p>
<p>作用：常用于进行接口测试。</p>
<h2 id="简单参数"><a href="#简单参数" class="headerlink" title="简单参数"></a>简单参数</h2><ul>
<li><p>原始方式</p>
<p>在原始的web程序中，获取请求参数，需要通过HttpServletRequest对象手动获取。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205181550921.png" alt="image-20240205181550921"></p>
</li>
</ul>
<p>​		缺点：操作方式比较繁琐，需要将HttpServletRequest进行类型转换</p>
<ul>
<li><p>Springboot方式（下面左侧黄色部分是sprinboot接受简单参数的函数编写方式，右侧是postman分别使用get和post请求方式的发送效果），<font color="red">只要形参名和发送参数名一致就可自动接收成功。</font></p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205183539465.png" alt="image-20240205183539465"></p>
</li>
</ul>
<p>​	如果方法形参名称与请求参数名称不匹配，可以使用@RequestParam完成映射。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205184136093.png" alt="image-20240205184136093"></p>
<p>注意事项：@RequestParam中的required属性默认为True，代表该请求参数必须传递，如果不传递将报错。如果该参数是可以选择的，可以将required的属性设置为false。</p>
<p>总结：</p>
<ol>
<li><p>原始方法获取请求参数</p>
<ul>
<li>Controller方法形参中声明HttpServletRequest对象</li>
<li>调用对象的getParameter(参数名)</li>
</ul>
</li>
<li><p>SpringBoot中接受简单参数</p>
<ul>
<li>请求参数名与方法形参变量名相同</li>
<li>会自动进行类型转换</li>
</ul>
</li>
<li><p>@RequestParam注解</p>
<ul>
<li>方法形参名称与请求参数名称不匹配</li>
<li>该注解的required属性默认是true，代表请求参数必须传递</li>
</ul>
</li>
</ol>
<h2 id="实体参数（应对简单参数数量过多的情况）"><a href="#实体参数（应对简单参数数量过多的情况）" class="headerlink" title="实体参数（应对简单参数数量过多的情况）"></a>实体参数（应对简单参数数量过多的情况）</h2><ul>
<li><p>简单实体对象：请求参数名与形参对象属性名相同，定义POJO接受即可。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205185118298.png" alt="image-20240205185118298"></p>
</li>
</ul>
<h2 id="复杂实体参数（应对参数非简单类型的情况）"><a href="#复杂实体参数（应对参数非简单类型的情况）" class="headerlink" title="复杂实体参数（应对参数非简单类型的情况）"></a>复杂实体参数（应对参数非简单类型的情况）</h2><ul>
<li><p>复杂实体对象：请求参数名与形参对象属性名相同，按照对象层次结构关系即可接收嵌套POJO属性参数。（<font color="red">与简单实体参数一致，只要保证对应的嵌套关系不发生变化即可</font>）</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205190319798.png" alt="image-20240205190319798"></p>
</li>
</ul>
<h2 id="数组集合参数（形参可以是数组或者集合）"><a href="#数组集合参数（形参可以是数组或者集合）" class="headerlink" title="数组集合参数（形参可以是数组或者集合）"></a>数组集合参数（形参可以是数组或者集合）</h2><ul>
<li><p>数组参数：请求参数与形参数组名称相同且请求参数为多个，定义数组类型形参即可接收参数</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205190631950.png" alt="image-20240205190631950"></p>
</li>
<li><p>集合参数：请求参数名与形参集合名称相同且请求参数为多个，@RequestParam绑定参数关系。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205191132398.png" alt="image-20240205191132398"></p>
</li>
</ul>
<h2 id="日期参数"><a href="#日期参数" class="headerlink" title="日期参数"></a>日期参数</h2><ul>
<li><p>日期参数：使用@DateTimeFormat注解完成日期参数格式转换</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205191314005.png" alt="image-20240205191314005"></p>
</li>
</ul>
<h2 id="Json参数"><a href="#Json参数" class="headerlink" title="Json参数"></a>Json参数</h2><ul>
<li><p>JSON参数：JSON数据键名与形参对象属性名相同，定义POJO类型形参即可接收参数，需要使用@RequestBody标识</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205192029505.png" alt="image-20240205192029505"></p>
</li>
</ul>
<h2 id="路径参数"><a href="#路径参数" class="headerlink" title="路径参数"></a>路径参数</h2><ul>
<li><p>路径参数：通过请求URL直接传递参数，使用{…}来表示该路径参数，需要使用@PathVariable获取路径参数</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205192557467.png" alt="image-20240205192557467"></p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205192747492.png" alt="image-20240205192747492"></p>
<h1 id="响应数据-允许返回各种类型的数据"><a href="#响应数据-允许返回各种类型的数据" class="headerlink" title="响应数据(允许返回各种类型的数据)"></a>响应数据(允许返回各种类型的数据)</h1><p>浏览器发起请求后服务器响应会返回响应的数据。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205193201481.png" alt="image-20240205193201481"></p>
<p>@ResponseBody（将方法的返回值直接作为响应数据响应给客户端浏览器）</p>
<ul>
<li>类型：方法注解、类注解</li>
<li>位置：Controller方法上&#x2F;类上</li>
<li>作用：将方法返回值直接响应，<font color="red">如果返回值类型是实体对象&#x2F;集合，将会转化为JSON格式响应</font></li>
<li>说明：@RestController&#x3D;@Controller+@ResponseBody</li>
</ul>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205194650624.png" alt="image-20240205194650624"></p>
<p>由于不同页面的解析结果不同，为了便于管理，提出了以下的统一响应结果</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205194823402.png" alt="image-20240205194823402"></p>
<p><strong>总结</strong></p>
<ol>
<li><p>@ResponseBody</p>
<p>位置：Controller类上&#x2F;方法上</p>
<p>作用：将方法返回值直接响应，若返回值类型是实体对象&#x2F;集合，转JSON格式响应</p>
</li>
<li><p>统一响应结果</p>
<p>Result(code, msg, data)</p>
</li>
</ol>
<p><strong>案例</strong></p>
<p>获取员工数据，返回统一响应结果，在页面渲染展示</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205195526399.png" alt="image-20240205195526399"></p>
<p>步骤</p>
<ol>
<li>在pom.xml文件中引入dom4j的依赖，用于解析XML文件</li>
<li>引入资料中提供的解析XML的工具类XMLParserUtils，对应的实体类Emp，XML文件emp.xml</li>
<li>引入资料中提供的静态页面文件，放到resources下的static目录下</li>
<li>编写Controller程序，处理请求，响应数据</li>
</ol>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205200314718.png" alt="image-20240205200314718"></p>
<h1 id="分层解耦"><a href="#分层解耦" class="headerlink" title="分层解耦"></a>分层解耦</h1><h2 id="三层架构"><a href="#三层架构" class="headerlink" title="三层架构"></a>三层架构</h2><p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205220155037.png" alt="image-20240205220155037"></p>
<p>三层架构</p>
<ul>
<li><p>controller：控制层，接收前端发起的请求，对请求进行处理，并响应数据</p>
</li>
<li><p>service：业务逻辑层，处理具体的业务逻辑。</p>
</li>
<li><p>dao：数据访问层（Data Access Object）（持久层），负责数据访问操作，包括数据的增删改查。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205220322441.png" alt="image-20240205220322441"></p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205221510610.png" alt="image-20240205221510610"></p>
</li>
</ul>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205221614917.png" alt="image-20240205221614917"></p>
<h2 id="分层解耦-1"><a href="#分层解耦-1" class="headerlink" title="分层解耦"></a>分层解耦</h2><ul>
<li>内聚：软件中各个功能模块内部的功能联系。</li>
<li>耦合：衡量软件中各个层&#x2F;模块之间的依赖、关联程度。</li>
<li>软件设计原则：高内聚低耦合。</li>
</ul>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205222503596.png" alt="image-20240205222503596"></p>
<p><font color="red">目前的controller层和service层是耦合的，service层发生变动会导致controller层的代码也要做出相应的调整。</font></p>
<p><font color="red">于是springboot出现了容器的概念，容器存放创建的对象，controller需要什么样的service对象就从容器中提取。要实现这一步，需要解决两个问题，如何将service层的对象装入容器中，如何从controller层读取容器的内容。分别对应了两个问题，控制反转和依赖注入。</font></p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205223108844.png" alt="image-20240205223108844"></p>
<p>控制反转：Inversion Of Control，简称<font color="red">IOC</font>。对象的创建控制权是由程序自身转移到外部（容器）这种思想称为控制反转。</p>
<p>依赖注入：Dependency Injection，简称<font color="red">DI</font>。容器为应用程序提供运行时，所依赖的资源，称为依赖注入。</p>
<p>Bean对象：IOC容器中创建、管理的对象，称之为<font color="red">bean</font>。</p>
<h2 id="IOC-DI-入门"><a href="#IOC-DI-入门" class="headerlink" title="IOC &amp;  DI 入门"></a>IOC &amp;  DI 入门</h2><ol>
<li>Service层及Dao层的实现类，交给IOC容器管理。</li>
<li>为Controller及Service注入运行时，依赖的对象。</li>
<li>运行测试。</li>
</ol>
<p>实现机制</p>
<p>给EmpServer层和EmpDao层对应的类加上注释@Component，表示将当前类交给IOC容器管理，称为IOC容器红的Bean对象。完成了控制反转。</p>
<p>给Controller层的service变量和EmpService层的dao对象加上@Autowired注释，表示运行时，IOC容器会提供该类型的Bean对象，并赋值给该变量，完成了依赖注入。</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205224114750.png" alt="image-20240205224114750"></p>
<h2 id="IOC详解（控制反转）"><a href="#IOC详解（控制反转）" class="headerlink" title="IOC详解（控制反转）"></a>IOC详解（控制反转）</h2><p>Bean的声明</p>
<p>要把某个对象交给IOC容器管理，需要在对应的类上加上如下的注释之一：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
<th>位置</th>
</tr>
</thead>
<tbody><tr>
<td>@Component</td>
<td>声明bean的基础注解</td>
<td>不属于以下三类时，用此注解</td>
</tr>
<tr>
<td>@Controller</td>
<td>@Component的衍生注解</td>
<td>标注在控制器类上</td>
</tr>
<tr>
<td>@Service</td>
<td>@Component的衍生注解</td>
<td>标注在业务类上</td>
</tr>
<tr>
<td>@Repository</td>
<td>@Component的衍生注解</td>
<td>标注在数据访问类上（由于与mybatis整合，用的较少）</td>
</tr>
</tbody></table>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205230749072.png" alt="image-20240205230749072"></p>
<p>注意事项</p>
<ul>
<li>声明Bean的时候，可以通过value属性指定Bean的名字，如果没有指定，默认为类名首字母小写。</li>
<li>使用以上四个注释都可以声明bean，但是在springboot继承web开发中，Controller层声明的bean只能用Controller注释。</li>
</ul>
<p><strong>Bean组件扫描</strong></p>
<ul>
<li><p>前面声明bean的四大注解，要想生效，还需要被组件扫描注解@ComponentScan扫描。</p>
</li>
<li><p>@ComponentScan注解虽然没有显式配置，但是实际上已经包含在了启动类声明注解@SpringBootApplication中，默认扫描的范围时启动类所在包及其子包。</p>
<p>显式指定扫描范围的示例</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205231744806.png" alt="image-20240205231744806"></p>
</li>
</ul>
<h2 id="DI详解（出现多个同类型的Bean对象时该如何办）"><a href="#DI详解（出现多个同类型的Bean对象时该如何办）" class="headerlink" title="DI详解（出现多个同类型的Bean对象时该如何办）"></a>DI详解（出现多个同类型的Bean对象时该如何办）</h2><p>Bean注入</p>
<ul>
<li><p>Autowired注解，默认是按照类型进行，如果存在多个相同类型的bean，将会报以下错误：</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205232248743.png" alt="image-20240205232248743"></p>
</li>
<li><p>解决方法如下所示：</p>
<ul>
<li><p>@Primary（加在两个竞争的小类上方）</p>
</li>
<li><p>@Qualifier（加在大类的变量上方）（权限最高，比primary的权限高）</p>
</li>
<li><p>@Resource（去掉autowired，加在大类的变量上方）</p>
<p><img src="/2024/02/05/javaweb-day02-springbootweb%E8%AF%B7%E6%B1%82%E5%93%8D%E5%BA%94/image-20240205233023664.png" alt="image-20240205233023664"></p>
</li>
</ul>
</li>
</ul>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol>
<li>依赖注入的注解<ul>
<li>Autowired：默认按照类型自动装配。</li>
<li>如果同类型的bean存在多个：<ul>
<li>@Primary</li>
<li>@Autowired + @Qualified(“bean的名称”)</li>
<li>@Resource(name &#x3D; “bean的名称”)</li>
</ul>
</li>
</ul>
</li>
<li>@Resource和@Autowired的区别<ul>
<li>@Autowired是spring框架提供的注解，而@Resource是JDK提供的注解。</li>
<li>@Autowired默认是按照类型注入，而@Resource是默认按照名称注入，名称未指定的话默认是首字母小写的类名</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>javaweb_day01_maven_springbootweb入门</title>
    <url>/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/</url>
    <content><![CDATA[<h1 id="什么是maven"><a href="#什么是maven" class="headerlink" title="什么是maven?"></a>什么是maven?</h1><p>maven是apache旗下的一个开源项目，是一款用于管理和构建java项目的工具。</p>
<h1 id="maven的作用"><a href="#maven的作用" class="headerlink" title="maven的作用"></a>maven的作用</h1><ul>
<li><p>依赖管理</p>
<p>方便快捷的管理项目依赖的资源（jar包），避免版本冲突问题</p>
<p>创建maven项目后，要使用什么jar包，不用再单独导入，只要在pom.xml文件的dependencies下引入即可。</p>
</li>
<li><p>统一项目结构</p>
<p>  提供标准、统一的项目结构</p>
<blockquote>
<p>eclipse、myeclipse、intellij idea各个java编译器产生的java项目是不能直接互相导入的，通过maven可以提供标准、统一的项目结构</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240116155606951.png" alt="image-20240116155606951"></p>
</blockquote>
<p>  项目目录结构如下所示</p>
</li>
<li><p>项目构建</p>
<p>  标准跨平台（Linux、Windows、MacOS）的自动化项目构建方式</p>
<p>  <img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240116155754884.png" alt="image-20240116155754884"></p>
</li>
</ul>
<h1 id="Maven概述"><a href="#Maven概述" class="headerlink" title="Maven概述"></a>Maven概述</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><ul>
<li>Apache Maven是一个项目管理和构建工具，它基于项目对象模型（POM）的概念，通过一小段描述信息来管理项目的构建。(POM：project object model)</li>
<li>作用<ul>
<li>方便的依赖管理</li>
<li>统一的项目结构</li>
<li>标准的项目构建流程</li>
</ul>
</li>
<li>官网：<a href="http://maven.apache.org/">http://maven.apache.org/</a></li>
</ul>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240116161041259.png" alt="image-20240116161041259"></p>
<p>仓库：用于存储资源，管理各种jiar包。</p>
<ul>
<li>本地仓库：自己计算机上的一个目录。</li>
<li>中央仓库：由maven团队维护的全球唯一的。仓库地址：<a href="https://repo1/maven.org/maven2/">https://repo1/maven.org/maven2/</a></li>
<li>远程仓库（私服）：一般由公司团队搭建的私有仓库。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li><p>安装步骤</p>
<ol>
<li><p>解压apche-maven-3.6.1-bin.zip</p>
</li>
<li><p>配置本地仓库：修改conf&#x2F;settings.xml中的&lt;localRepository&gt;为一个指定目录，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>E:\module\apache-maven-3.6.1-bin\apache-maven-3.6.1\mvn_repo<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置阿里云私服：修改conf&#x2F;settings.xml中的&lt;mirrors&gt;标签，为其添加如下子标签：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/group/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置环境变量：MAVEN_HOME为maven的解压目录，并将其bin目录加入到PATH环境变量。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240116162338034.png" alt="image-20240116162338034"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240116162402754.png" alt="image-20240116162402754"></p>
</li>
</ol>
</li>
<li><p>测试</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">mvn -v</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240116162547523.png" alt="image-20240116162547523"></p>
</li>
</ul>
<h1 id="IDEA继承MAVEN"><a href="#IDEA继承MAVEN" class="headerlink" title="IDEA继承MAVEN"></a>IDEA继承MAVEN</h1><h2 id="全局配置Maven环境"><a href="#全局配置Maven环境" class="headerlink" title="全局配置Maven环境"></a>全局配置Maven环境</h2><ol>
<li>进入全局设置</li>
</ol>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143305873.png" alt="image-20240117143305873"></p>
<ol start="2">
<li><p>配置maven三件套（本地目录，settings.xml，本地仓库）</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143430051.png" alt="image-20240117143430051"></p>
</li>
<li><p>配置JRE版本</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143458156.png" alt="image-20240117143458156"></p>
</li>
<li><p>配置字节码文件版本</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143512837.png" alt="image-20240117143512837"></p>
</li>
</ol>
<h2 id="本地配置Maven环境"><a href="#本地配置Maven环境" class="headerlink" title="本地配置Maven环境"></a>本地配置Maven环境</h2><ul>
<li><p>选择IDEA中File–&gt;Settings–&gt;Build，Execution,Deployment–&gt;Build Tools–&gt;Maven</p>
</li>
<li><p>设置IDEA使用本地安装的Maven，并修改配置文件及本地仓库路径</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117141244693.png" alt="image-20240117141244693"></p>
</li>
<li><p>配置Runner，确保JRE是对应的版本</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117141340811.png" alt="image-20240117141340811"></p>
</li>
<li><p>配置JAVA语言的字节码版本为特定版本File–&gt;Settings–&gt;Build，Execution,Deployment–&gt;Complier–&gt;Java Complier</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143111362.png" alt="image-20240117143111362"></p>
</li>
</ul>
<h2 id="本地从0开始创建Maven项目"><a href="#本地从0开始创建Maven项目" class="headerlink" title="本地从0开始创建Maven项目"></a>本地从0开始创建Maven项目</h2><ol>
<li><p>创建项目目录</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117142650306.png" alt="image-20240117142650306"></p>
</li>
<li><p>创建项目</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117142733138.png" alt="image-20240117142733138"></p>
</li>
<li><p>设置maven仓库File–&gt;Settings–&gt;Build，Execution,Deployment–&gt;Build Tools–&gt;Maven</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117142851099.png" alt="image-20240117142851099"></p>
</li>
<li><p>配置Runner，确定JRE的版本</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143024667.png" alt="image-20240117143024667"></p>
</li>
<li><p>配置JAVA语言的字节码版本为特定版本File–&gt;Settings–&gt;Build，Execution,Deployment–&gt;Complier–&gt;Java Complier</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117143111362.png" alt="image-20240117143111362"></p>
</li>
</ol>
<h2 id="经过全局配置后通过模块创建项目"><a href="#经过全局配置后通过模块创建项目" class="headerlink" title="经过全局配置后通过模块创建项目"></a>经过全局配置后通过模块创建项目</h2><ol>
<li><p>创建模块，选择Maven，点击Next</p>
</li>
<li><p>填写模块名称，坐标信息，点击finish，创建完成</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117144720513.png" alt="image-20240117144720513"></p>
</li>
<li><p>观察生成的项目结构</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117145350061.png" alt="image-20240117145350061"></p>
<p>注意，main目录下存放的项目的资源，test目录下存放的是测试的相关资源，二者应该是一一对应的，但是刚生成的test目录下没有resources,这个时候选中test，右键new directory，它会提示你创建resouces。（上面的图示就是创建好的结果）</p>
<ul>
<li>java目录存放了运行代码。</li>
<li>resources目录下存放了配置信息。</li>
</ul>
</li>
<li><p>编写HelloWorld，File–&gt;New–&gt;Java Class–&gt;com.ithema.HelloWorld</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117145910982.png" alt="image-20240117145910982"></p>
</li>
<li><p>运行后产生target目录，它是Java编译后产生的字节码文件</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117150126244.png" alt="image-20240117150126244"></p>
</li>
</ol>
<h2 id="Maven坐标"><a href="#Maven坐标" class="headerlink" title="Maven坐标"></a>Maven坐标</h2><ul>
<li><p>什么是坐标？</p>
<ul>
<li>Maven中的坐标是资源的唯一标识，通过该坐标可以为一定为资源位置。</li>
<li>使用坐标来定义项目或引入项目中需要的依赖。（在porn.xml中添加坐标，相当于导包操作）</li>
</ul>
</li>
<li><p>Maven坐标主要组成</p>
<ul>
<li><p>groupId:定义当前Maven项目隶属组织名称（通常是域名反写，例如com.itheima）</p>
</li>
<li><p>artifactId：定义当前Maven项目名称（通常是模块名称，例如order-service、good-service）</p>
</li>
<li><p>version：定义当前项目版本号</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="导入Maven项目"><a href="#导入Maven项目" class="headerlink" title="导入Maven项目"></a>导入Maven项目</h2><p>方式一：打开IDEA，选择右侧Maven面板，点击+号，选中对应项目的pom.xml文件，双击即可。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117152800780.png" alt="image-20240117152800780"></p>
<p>方法二：打开IDEA，File–&gt;Project Structure，选中Modules，选中对应项目的pom.xml文件，双击即可</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117155211325.png" alt="image-20240117155211325"></p>
<h2 id="移除Maven项目"><a href="#移除Maven项目" class="headerlink" title="移除Maven项目"></a>移除Maven项目</h2><p>方法一：右键-unlink maven projects</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117153019917.png" alt="image-20240117153019917"></p>
<p>方法二：选中，右键，remove module</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240117153148909.png" alt="image-20240117153148909"></p>
<h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><h2 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h2><ul>
<li><p>依赖：指当前项目运行所需要的jar包，一个项目中可以引入多个依赖。</p>
</li>
<li><p>配置：</p>
<ol>
<li><p>在pom.xml中编写<code>&lt;dependencies&gt;</code>标签</p>
</li>
<li><p>在<code>&lt;dependices&gt;</code>标签中，使用<code>&lt;dependency&gt;</code>引入坐标</p>
</li>
<li><p>定义坐标的groupId，artifactId，version</p>
</li>
<li><p>点击刷新按钮，引入最新加入的坐标</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119152117196.png" alt="image-20240119152117196"></p>
</li>
</ol>
</li>
</ul>
<p>注意事项</p>
<ul>
<li>如果引入的依赖，在本地仓库不存在，将会链接远程仓库&#x2F;中央仓库，然后下载依赖。</li>
<li>如果不知道依赖的坐标信息，可以到<a href="https://mvnreposotory.com/%E4%B8%AD%E6%90%9C%E7%B4%A2%E3%80%82">https://mvnreposotory.com/中搜索。</a></li>
</ul>
<h2 id="依赖传递"><a href="#依赖传递" class="headerlink" title="依赖传递"></a>依赖传递</h2><ul>
<li><p>依赖具有传递性</p>
<ul>
<li><p>直接依赖：在当前项目中通过依赖配置建立的依赖关系</p>
</li>
<li><p>间接依赖：被依赖的资源如果依赖其他资源，当前项目间接依赖其他资源</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119153259194.png" alt="image-20240119153259194"></p>
</li>
</ul>
</li>
<li><p>排除依赖</p>
<p>排除依赖指主动断开依赖的资源，被排除的资源无需指定版本。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119154036910.png" alt="image-20240119154036910"></p>
</li>
</ul>
<h2 id="依赖范围"><a href="#依赖范围" class="headerlink" title="依赖范围"></a>依赖范围</h2><p>依赖的jar包，默认情况下，可以在任何地方使用。可以使用<code>&lt;scope&gt;...&lt;/scope&gt;</code>设置其作用范围。</p>
<p>作用范围：</p>
<ul>
<li>主程序范围有效。（main文件夹范围内）</li>
<li>测试程序范围有效。（test文件夹范围内）</li>
<li>是否参与打包运行。（package指令范围内）</li>
</ul>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119154350199.png" alt="image-20240119154350199"></p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p>Maven的生命周期就是为了对所有的maven项目构建过程进行抽象和统一。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119155450407.png" alt="image-20240119155450407"></p>
<p>Maven有3套相互独立的生命周期：</p>
<ul>
<li>clean：清理工作。</li>
<li>default：核心工作，如：编译、测试、打包、安装、部署等。</li>
<li>site：生成报告、发布站点等。</li>
</ul>
<p>每套生命周期包含一些阶段（phase）,阶段是有顺序的，后面的阶段依赖于前面的阶段。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119155612088.png" alt="image-20240119155612088"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119160354799.png" alt="image-20240119160354799"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240119160447967.png" alt="image-20240119160447967"></p>
<h1 id="SpringBootWeb入门"><a href="#SpringBootWeb入门" class="headerlink" title="SpringBootWeb入门"></a>SpringBootWeb入门</h1><ul>
<li><p>Spring发展到今天已经形成了一种开发生态圈，Spring提供了若干子项目，每个项目用于完成特定的功能。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240120130721110.png" alt="image-20240120130721110"></p>
</li>
<li><p>Spring Framework是所有项目的基础框架，它有两大缺点，上手难度大，配置繁琐，因而出现了spring boot这样的简介配置的基础框架。</p>
</li>
<li><p>Spring Boot可以帮助我们非常快速的构建应用程序，简化开发，直接上手。</p>
</li>
</ul>
<p><strong>需求：使用SPringBoot开发一个web应用，浏览器发起请求&#x2F;hello后，给浏览器返回字符串“Hello World ~”</strong></p>
<ol>
<li><p>创建springboot工程，并勾选web开发相关依赖。</p>
</li>
<li><p>定义HelloController类，添加方法hello，并添加注释。</p>
</li>
<li><p>运行测试。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240120132028164.png" alt="image-20240120132028164"></p>
<p>添加依赖</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240120132128021.png" alt="image-20240120132128021"></p>
<p>创建完项目后删除无关的包</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240120133542924.png" alt="image-20240120133542924"></p>
<p>项目在main&#x2F;java&#x2F;com&#x2F;example目录下自动生成了启动类</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240120133951516.png" alt="image-20240120133951516"></p>
<p>编写请求类（浏览器请求&#x2F;hello页面，就会触发这个方法）</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240120135516970.png" alt="image-20240120135516970"></p>
<p>启动程序<br>运行main方法即可（访问localhost:8080&#x2F;hello或者127.0.0.1:8080&#x2F;hello即可)</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125151520066.png" alt="image-20240125151520066"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125151747850.png" alt="image-20240125151747850"></p>
</li>
</ol>
<h1 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h1><h2 id="HTTP-概述"><a href="#HTTP-概述" class="headerlink" title="HTTP-概述"></a>HTTP-概述</h2><ul>
<li><p>概念：Hyper Text Transfer Protocol，超文本传输协议，规定了浏览器和服务器之间传输数据的规则。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125152407065.png" alt="image-20240125152407065"></p>
</li>
<li><p>特点：</p>
<ol>
<li>基于TCP协议：，面向连接。安全。</li>
<li>基于请求-响应模型的：一次请求对应一次响应。</li>
<li>HTTP协议是无状态的协议：对于事务没有记忆能力。，每次请求-相应都是独立的。<ul>
<li>缺点：多次请求间不能共享数据。</li>
<li>优点：速度快。</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="HTTP-请求协议（请求数据的格式）"><a href="#HTTP-请求协议（请求数据的格式）" class="headerlink" title="HTTP-请求协议（请求数据的格式）"></a>HTTP-请求协议（请求数据的格式）</h2><p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125153407721.png" alt="image-20240125153407721"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125153322567.png" alt="image-20240125153322567"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125153911088.png" alt="image-20240125153911088"></p>
<h2 id="HTTP-响应协议"><a href="#HTTP-响应协议" class="headerlink" title="HTTP-响应协议"></a>HTTP-响应协议</h2><p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125154148318.png" alt="image-20240125154148318"></p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125154206959.png" alt="image-20240125154206959"></p>
<h2 id="HTTP-协议解析"><a href="#HTTP-协议解析" class="headerlink" title="HTTP-协议解析"></a>HTTP-协议解析</h2><p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125164522319.png" alt="image-20240125164522319"></p>
<p>服务器自动把要传输的协议解析过程封装，比较著名的有jetty:&#x2F;&#x2F;，weblogic,websphere</p>
<p>其中最著名的当属apache tomcat。</p>
<h2 id="Web服务器"><a href="#Web服务器" class="headerlink" title="Web服务器"></a>Web服务器</h2><p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125164749729.png" alt="image-20240125164749729"></p>
<p>启动服务器，就可以打开浏览器，直接访问部署在服务器的页面。</p>
<p>Web服务器</p>
<ul>
<li>对HTP协议操作进行封装。简化web程序开发。</li>
<li>部署web项目，对外提供网上信息浏览服务。</li>
</ul>
<p>Tomcat</p>
<ul>
<li>一个轻量级的Web服务器，支持servlet,jsp等少量javaEE规范。</li>
<li>也被称为web容器，servlet容器。</li>
</ul>
<p>将网页部署到tomcat服务器的具体操作如下所示：</p>
<ol>
<li><p>下载并安装tomcat</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125165029068.png" alt="image-20240125165029068"></p>
</li>
<li><p>将已经写好的前端文件放到对应的tomcat安装目录的webapps目录中</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240125165206796.png" alt="image-20240125165206796"></p>
</li>
<li><p>双击bin\startup.bat，启动tomcat。</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126145251580.png" alt="image-20240126145251580"></p>
</li>
<li><p>进入浏览器，输入localhost:8080&#x2F;demo&#x2F;index.html</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126145329204.png" alt="image-20240126145329204"></p>
</li>
</ol>
<h1 id="Web服务器-Tomcat"><a href="#Web服务器-Tomcat" class="headerlink" title="Web服务器-Tomcat"></a>Web服务器-Tomcat</h1><ul>
<li><p>简介</p>
<ul>
<li><p>概念：Tomcat是Apache软件基金会一个核心项目，是一个开源免费的轻量级Web服务器。支持少量Servlet、JSP少量JavaEE规范。</p>
</li>
<li><p>JavaEE：Java Enterprise Edition，Java企业版。指Java企业级开发的技术规范总和。包含13项技术规范：JDBC，JNDI，EJB（被Spring替代），RMI，JSP，Servlet（被基于Servlet的框架替代），XML，JMS，Java IDL，JTS，JTA，JavaMail，JAF。</p>
</li>
<li><p>Tomcat也被称为Web容器，Servlet容器。Servlet程序需要依赖于Tomcat才能运行。</p>
</li>
</ul>
</li>
<li><p>基本使用</p>
<ul>
<li><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126143712623.png" alt="image-20240126143712623"></li>
<li><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126144304052.png" alt="image-20240126144304052"></li>
<li><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126144410282.png" alt="image-20240126144410282"></li>
</ul>
</li>
<li><p>入门程序解析</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126144954387.png" alt="image-20240126144954387"></p>
<p>springbootweb在启动时回启动内置的tomcat服务器（以后用的基本是springboot内置的tomcat服务器）</p>
<p><img src="/2024/01/16/javaweb-day01-web%E5%BC%80%E5%8F%91/image-20240126150234575.png" alt="image-20240126150234575"></p>
</li>
</ul>
]]></content>
      <categories>
        <category>javaweb</category>
      </categories>
  </entry>
  <entry>
    <title>2. github远程部署hexo</title>
    <url>/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/</url>
    <content><![CDATA[<h2 id="1-搭建环境"><a href="#1-搭建环境" class="headerlink" title="1. 搭建环境"></a>1. 搭建环境</h2><p>Hexo 基于 Node.js，搭建过程中还需要使用 npm（Node.js 已带） 和 git，因此先搭建本地操作环境，安装 Node.js 和 Git。</p>
<ul>
<li>Node.js：<a href="https://link.zhihu.com/?target=https://nodejs.org/zh-cn">https://nodejs.org/zh-cn</a></li>
<li>Git：<a href="https://link.zhihu.com/?target=https://git-scm.com/downloads">https://git-scm.com/downloads</a></li>
</ul>
<p>下载 Node.js 和 Git 程序并安装，一路点 “下一步” 按默认配置完成安装。</p>
<p>安装完成后，Win+R 输入 cmd 并打开，依次输入 <code>node -v</code>、<code>npm -v</code> 和 <code>git --version</code> 并回车，如下图出现程序版本号即可。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115151405964.png" alt="image-20240115151405964"></p>
<h2 id="2-连接github"><a href="#2-连接github" class="headerlink" title="2. 连接github"></a>2. 连接github</h2><p>使用邮箱注册 <a href="https://link.zhihu.com/?target=https://github.com/">GitHub</a> 账户，选择免费账户（Free），并完成邮件验证。</p>
<p>右键 -&gt; Git Bash Here，<strong>设置用户名和邮箱</strong>：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;GitHub 用户名&quot;</span><br><span class="line">git config --global user.email &quot;GitHub 邮箱&quot;</span><br></pre></td></tr></table></figure>

<p><strong>查看本地已经设置好的用户名和邮箱</strong></p>
<ol>
<li><p>查看全局用户名：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global user.name</span><br></pre></td></tr></table></figure>

<p>这个命令会显示你设置的全局用户名。</p>
</li>
<li><p>查看全局邮箱：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git config --global user.email</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>创建 SSH 密匙</strong>：</p>
<p>输入 <code>ssh-keygen -t rsa -C &quot;GitHub 邮箱&quot;</code>，然后一路回车。</p>
<p><strong>添加密匙：</strong></p>
<p>进入 [C:\Users\用户名.ssh] 目录（要勾选显示“隐藏的项目”），用记事本打开公钥 id_rsa.pub 文件并复制里面的内容。</p>
<p>登陆 GitHub ，进入 Settings 页面，选择左边栏的 SSH and GPG keys，点击 New SSH key。</p>
<p>Title 随便取个名字，粘贴复制的 id_rsa.pub 内容到 Key 中，点击 Add SSH key 完成添加。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115153151771.png" alt="image-20240115153151771"></p>
<p><strong>验证连接：</strong></p>
<p>打开 Git Bash，输入 <code>ssh -T git@github.com</code> 出现 “Are you sure……”，输入 yes 回车确认。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115153218063.png" alt="image-20240115153218063"></p>
<p>显示 “Hi xxx! You’ve successfully……” 即连接成功。</p>
<h2 id="3-创建-Github-Pages-仓库"><a href="#3-创建-Github-Pages-仓库" class="headerlink" title="3. 创建 Github Pages 仓库"></a>3. 创建 Github Pages 仓库</h2><p>GitHub 主页右上角加号 -&gt; New repository：</p>
<ul>
<li>Repository name 中输入 <code>用户名.github.io</code></li>
<li>勾选 “Initialize this repository with a README”</li>
<li>Description 选填</li>
</ul>
<p>填好后点击 Create repository 创建。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115153305115.png" alt="image-20240115153305115"></p>
<p>创建后默认自动启用 HTTPS，博客地址为：<code>https://用户名.github.io</code></p>
<h2 id="4-本地安装-Hexo-博客程序"><a href="#4-本地安装-Hexo-博客程序" class="headerlink" title="4. 本地安装 Hexo 博客程序"></a>4. 本地安装 Hexo 博客程序</h2><p>新建一个文件夹用来存放 Hexo 的程序文件，如 Hexo-Blog。打开该文件夹，右键 -&gt; Git Bash Here。</p>
<h3 id="4-1-安装-Hexo"><a href="#4-1-安装-Hexo" class="headerlink" title="4.1 安装 Hexo"></a>4.1 安装 Hexo</h3><p>使用 npm 一键安装 Hexo 博客程序：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>Mac 用户需要管理员权限（sudo），运行这条命令：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">sudo npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<p>安装时间有点久（真的很慢！），界面也没任何反应，<strong>耐心等待</strong>，安装完成后如下图。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115153349039.png" alt="image-20240115153349039"></p>
<h3 id="4-2-Hexo-初始化和本地预览"><a href="#4-2-Hexo-初始化和本地预览" class="headerlink" title="# 4.2 Hexo 初始化和本地预览"></a><strong># 4.2 Hexo 初始化和本地预览</strong></h3><p><strong>初始化并安装所需组件：</strong></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">hexo init      # 初始化</span><br><span class="line">npm install    # 安装组件</span><br></pre></td></tr></table></figure>

<p>完成后依次输入下面命令，<strong>启动本地服务器进行预览</strong>：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">hexo g   # 生成页面</span><br><span class="line">hexo s   # 启动预览</span><br></pre></td></tr></table></figure>

<p><strong>访问</strong> <code>http://localhost:4000</code><strong>，出现 Hexo 默认页面，本地博客安装成功！</strong></p>
<h2 id="5-部署-Hexo-到-GitHub-Pages"><a href="#5-部署-Hexo-到-GitHub-Pages" class="headerlink" title="5. 部署 Hexo 到 GitHub Pages"></a>5. 部署 Hexo 到 GitHub Pages</h2><p>本地博客测试成功后，就是上传到 GitHub 进行部署，使其能够在网络上访问。</p>
<p>首先<strong>安装 hexo-deployer-git</strong>：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>然后<strong>修改 _config.yml</strong> 文件末尾的 Deployment 部分，修改成如下：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: git@github.com:用户名/用户名.github.io.git</span><br><span class="line">  branch: main</span><br></pre></td></tr></table></figure>

<p>完成后运行 <code>hexo d</code> 将网站上传部署到 GitHub Pages。</p>
<p>完成！这时访问我们的 GitHub 域名 <code>https://用户名.github.io</code> 就可以看到 Hexo 网站了。</p>
<h2 id="6-绑定域名（可选）"><a href="#6-绑定域名（可选）" class="headerlink" title="6. 绑定域名（可选）"></a>6. 绑定域名（可选）</h2><p>博客搭建完成使用的是 GitHub 的子域名（用户名.<a href="https://link.zhihu.com/?target=http://github.io">http://github.io</a>），我们可以为 Hexo 博客绑定自己的域名替换 GitHub 域名，更加个性化和专业，也利于 SEO。</p>
<p>我们使用 <a href="https://link.zhihu.com/?target=https://www.namesilo.com/?rid=d27fa32do">Namesilo</a> 进行注册，便宜好用没啥套路，使用优惠码 <code>okoff</code> 优惠一美元，com 域名大概 50 块一年。</p>
<h3 id="6-1-域名注册和解析"><a href="#6-1-域名注册和解析" class="headerlink" title="6.1 域名注册和解析"></a>6.1 域名注册和解析</h3><ul>
<li>域名注册和解析教程：<a href="https://zhuanlan.zhihu.com/p/33921436">Namesilo 域名购买及使用教程</a></li>
</ul>
<p>按上面教程注册并解析域名，在 DNS 设置部分，删除自带的记录，然后添加 CNAME 记录将 www 域名解析指向 <code>用户名.github.io</code>。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115154525174.png" alt="image-20240115154525174"></p>
<h3 id="6-2-绑定域名到-Hexo-博客"><a href="#6-2-绑定域名到-Hexo-博客" class="headerlink" title="6.2 绑定域名到 Hexo 博客"></a>6.2 绑定域名到 Hexo 博客</h3><p>进入本地博客文件夹的 source 目录，打开记事本，里面输入自己的域名，如 <a href="http://www.example.com,保存名称为/">http://www.example.com，保存名称为</a> “CNAME”，格式为 “所有文件”（无 .txt 后缀）。</p>
<p>清除缓存等文件并重新发布网站：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">hexo clean   # 清除缓存文件等</span><br><span class="line">hexo g       # 生成页面</span><br><span class="line">hexo s       # 启动预览</span><br></pre></td></tr></table></figure>

<p>现在就可以使用自己的域名访问 Hexo 博客了。</p>
<h3 id="6-3-开启-HTTPS"><a href="#6-3-开启-HTTPS" class="headerlink" title="6.3 开启 HTTPS"></a>6.3 开启 HTTPS</h3><p>配置自己的域名后，需要我们手动开启 HTTPS。打开博客所在 GitHub 仓库，Settings -&gt; 下拉找到 GitHub Pages -&gt; 勾选 Enforce HTTPS。</p>
<p><img src="/2024/01/15/github%E8%BF%9C%E7%A8%8B%E9%83%A8%E7%BD%B2hexo/image-20240115154742811.png" alt="image-20240115154742811"></p>
<p>HTTPS 证书部署成功需要一定时间，等大概几分钟再访问域名，就可以看到域名前面的小绿锁了，HTTPS 配置完成！</p>
<h2 id="7-至此，完成hexo-github"><a href="#7-至此，完成hexo-github" class="headerlink" title="7.至此，完成hexo + github!"></a>7.至此，完成hexo + github!</h2>]]></content>
      <categories>
        <category>博客</category>
      </categories>
  </entry>
  <entry>
    <title>hexo中插入图片教程</title>
    <url>/2024/01/15/hexo%E4%B8%AD%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="1-解决方案"><a href="#1-解决方案" class="headerlink" title="1. 解决方案"></a>1. 解决方案</h2><h3 id="1-1-创建图片资源文件夹"><a href="#1-1-创建图片资源文件夹" class="headerlink" title="1.1 创建图片资源文件夹"></a>1.1 创建图片资源文件夹</h3><p>网上有关的解决方式几乎很大一部分会提到这一点：将_config.yml 文件中的post_asset_folder 选项设为 true 来打开。事实上这正是hexo官方文档给出的解决方案之一中的一个步骤。仔细阅读后会发现如下几点：</p>
<ol>
<li><p>该操作的作用就是在使用hexo new xxx指令新建博文时，在相同路径下同步创建一个xxx文件夹，而xxx文件夹的作用就是用来存放图片资源；</p>
</li>
<li><p>就我个人而言，我偏好于直接在source_posts文件夹下新建md文件，而不是通过hexo new xxx指令；</p>
</li>
<li><p>那么直接新建xxx.md再新建xxx文件夹，这种操作的最终效果和使用hexo new xxx指令新建博文的效果一样吗？经过实测，是一样的。</p>
</li>
</ol>
<p>基于以上3点，告诉大家几个结论：</p>
<ol>
<li>新建博文可以不用hexo new xxx指令，我较为推荐直接新建文件和文件夹的方式，只要达到一个md文件，一个同名文件夹的效果即可；</li>
<li>【将_config.yml 文件中的post_asset_folder 选项设为 true 】是必须的！理论上既然没用hexo new xxx指令，文件夹也是我自己新建的，这一步设置的意义似乎并不存在，但是后文介绍的插件必须在post_asset_folder 选项设为 true的情况下才能生效——本人亲测，大家记住这么设置即可！</li>
</ol>
<h3 id="1-2-typora中图像设置"><a href="#1-2-typora中图像设置" class="headerlink" title="1.2 typora中图像设置"></a>1.2 typora中图像设置</h3><p>一般来说，大家会现在typora里写好md格式的博客，然后通过hexo clean、hexo g、hexo s进行一下本地测试，确认无误后再发布到远端。</p>
<p>暂且不说hexo博客的图片插入是个问题，我相信当初单纯利用typora做笔记时，图片文件的管理就让很多人头疼过，typora官方似乎也意识到这个问题，所以偏好设置中图像是专门的一项，提供了很多选择。</p>
<p><img src="/2024/01/15/hexo%E4%B8%AD%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E6%95%99%E7%A8%8B/image-20240115143136972.png" alt="image-20240115143136972"></p>
<p>我相信大多数同学写md时的图片很多可能是直接截图或者在其他地方copy的，然后在typora中直接粘贴就ok了。但是这么做之前最好把typora插入图片时采取何种操作配置好，否则md文件和图片相隔十万八千里，后续一旦移动md文件图片就识别不出来，相信大家用过typora都深有体会。</p>
<p>所以接下来讲一下typora如何设置。直接给结论：</p>
<p><img src="/2024/01/15/hexo%E4%B8%AD%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E6%95%99%E7%A8%8B/image-20240115143150050.png" alt="image-20240115143150050"></p>
<p>的路径是：<code>./$&#123;filename&#125;</code>。<code>./</code>表示当前文件夹，<code>$&#123;filename&#125;</code>表示当前文件名。这么设置的好处：</p>
<ol>
<li>图片资源文件夹有了；</li>
<li>而且是同名文件夹！（2.1中的文件夹其实不用手动添加了）</li>
</ol>
<p>这么设置的结果就是：想写篇博客，在<code>source\_posts</code>文件夹下新建<code>xxx.md</code>文件，写着写着需要插一张图，从别处复制，然后在typora中直接粘贴，<code>bling!</code>图片资源文件夹自动搞定，并不用关心什么文件夹，只管专注于<code>md</code>文件即可。</p>
<h3 id="1-3-插件下载"><a href="#1-3-插件下载" class="headerlink" title="1.3 插件下载"></a>1.3 插件下载</h3><p>这个很多博客也有提到，插件的名字叫<code>hexo-asset-image</code>，相信在网上找了一波解决方案的同学一定对这个名字不陌生。</p>
<p>这个插件的不同版本可能会有不同的影响，我最终成功解决问题的版本是用如下命令下载的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm install https://github.com/CodeFalling/hexo-asset-image --save</span><br></pre></td></tr></table></figure>

<p>为什么需要这么插件呢？</p>
<p>因为我们虽然在<code>source\_posts</code>文件夹下写了md文件，也有了图片资源文件夹存了图片，但从我们前面typora中的设置不难知道，实际上md文件中的图片路径都是相对路径（<code>./$&#123;filename&#125;</code>）。而实际网上看到的博文显然不是md文件，而是html文件，从md到html的转变就是hexo帮我们做的，还记得<code>hexo g</code>命令吗？就是干这个的。转换后的html文件在<code>public</code>目录下，路径是通过日期指示的。</p>
<p>下面第一张图是存放md文件的地方，图片就在图中的jiangzhou文件夹中；第二张图是generate之后存在html和图片资源的地方。</p>
<p><img src="/2024/01/15/hexo%E4%B8%AD%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E6%95%99%E7%A8%8B/image-20240115145940757.png" alt="image-20240115145940757"></p>
<p><img src="/2024/01/15/hexo%E4%B8%AD%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E6%95%99%E7%A8%8B/image-20240115145902744.png" alt="image-20240115145902744"></p>
<h2 id="1-4-完成部署"><a href="#1-4-完成部署" class="headerlink" title="1.4 完成部署"></a>1.4 完成部署</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>经过以上三步，在本地目录public目录下就会根据日期产生对应的网页，网页中图片的路径经过插件<code>https://github.com/CodeFalling/hexo-asset-image</code>之后已经正确转换为对应的路径。</p>
]]></content>
      <categories>
        <category>博客</category>
      </categories>
  </entry>
  <entry>
    <title>junit-reflex-proxy</title>
    <url>/2023/11/17/junit-reflex-proxy/</url>
    <content><![CDATA[<h1 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h1><h2 id="概述、Junit框架快速入门"><a href="#概述、Junit框架快速入门" class="headerlink" title="概述、Junit框架快速入门"></a>概述、Junit框架快速入门</h2><ul>
<li><p>针对最小的功能单元（方法），编写测试代码进行正确性测试</p>
</li>
<li><p><strong>具体步骤</strong></p>
<ol>
<li><p>将junit框架的jar包导入到项目中（注意：IDEA已经集成了Junit框架，不需要我们自己手动导入了）</p>
</li>
<li><p>为需要测试的业务类，定义对应的测试类，并为每个业务方法，编写对应的测试方法（<strong>必须：公共、无参、无返回值</strong>）</p>
</li>
<li><p>测试方法上必须声明@Test注解，然后在测试方法中，编写代码调用被测试的业务方法进行测试；</p>
</li>
<li><p>开始测试：选中测试方法，右键选择“JUnit”运行，如果测试通过则是绿色；如果测试失败，则是红色</p>
<p><strong>1. 编写业务类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.d1_junit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printNumber</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(name == <span class="literal">null</span>)&#123;</span><br><span class="line">            System.out.println(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;名字长度是&quot;</span> + name.length());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getMaxIndex</span><span class="params">(String data)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data.length();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. 编写测试类（测试类和业务类方法一一对应）</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.d1_junit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringUtilTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPrintNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        StringUtil.printNumber(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        StringUtil.printNumber(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetMaxIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(StringUtil.getMaxIndex(<span class="string">&quot;3&quot;</span>));</span><br><span class="line">        System.out.println(StringUtil.getMaxIndex(<span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. 断言机制</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.d1_junit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringUtilTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPrintNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        StringUtil.printNumber(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        StringUtil.printNumber(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetMaxIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(StringUtil.getMaxIndex(<span class="string">&quot;3&quot;</span>));</span><br><span class="line">        System.out.println(StringUtil.getMaxIndex(<span class="literal">null</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> StringUtil.getMaxIndex(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="comment">//断言机制：程序员可以通过预测业务方法的结果</span></span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;方法内部有bug!&quot;</span>,<span class="number">4</span>,index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Junit框架的常见注解"><a href="#Junit框架的常见注解" class="headerlink" title="Junit框架的常见注解"></a>Junit框架的常见注解</h2></li>
</ul>
<p><strong>Junit单元测试框架的常用注解（Junit 4.xxxx版本）</strong></p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Test</td>
<td>测试类中的方法必须用它修饰才能成为测试方法，才能启动执行。</td>
</tr>
<tr>
<td>@Before</td>
<td>用来修饰一个实例方法，该方法会在每一个测试方法执行之前执行一次。</td>
</tr>
<tr>
<td>@After</td>
<td>用来修饰一个实例方法，该方法会在每一个测试方法执行之后执行一次。</td>
</tr>
<tr>
<td>@BeforeClass</td>
<td>用来修饰一个静态方法，该方法会在所有测试方法之前执行一次。</td>
</tr>
<tr>
<td>@AfterClass</td>
<td>用来修饰一个静态方法，该方法会在所有测试方法之后执行一次。</td>
</tr>
</tbody></table>
<ul>
<li>在测试方法执行前执行的方法，常用于：初始化资源。</li>
<li>在测试方法执行完之后再执行的方法，常用于：释放资源。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.d1_junit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringUtilTest</span> &#123;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----&gt; test1 Before执行了--------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----&gt;test2 After执行了--------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----&gt;Before CLass执行了---------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----&gt;After Class执行了---------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPrintNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        StringUtil.printNumber(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        StringUtil.printNumber(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetMaxIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(StringUtil.getMaxIndex(<span class="string">&quot;3&quot;</span>));</span><br><span class="line">        System.out.println(StringUtil.getMaxIndex(<span class="literal">null</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> StringUtil.getMaxIndex(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="comment">//断言机制：程序员可以通过预测业务方法的结果</span></span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;方法内部有bug!&quot;</span>, <span class="number">5</span>, index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果如下所示：</span><br><span class="line">----&gt;Before CLass执行了---------</span><br><span class="line">----&gt; test1 Before执行了--------</span><br><span class="line">名字长度是<span class="number">5</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">----&gt;test2 After执行了--------</span><br><span class="line">----&gt; test1 Before执行了--------</span><br><span class="line"><span class="number">1</span></span><br><span class="line">-<span class="number">1</span></span><br><span class="line">----&gt;test2 After执行了--------</span><br><span class="line">----&gt;After Class执行了---------</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><h2 id="认识反射、获取类"><a href="#认识反射、获取类" class="headerlink" title="认识反射、获取类"></a>认识反射、获取类</h2><ul>
<li>概念&#x2F;是什么：加载类，并允许以编程的方式解剖类中的各种成分（成员变量、方法、构造器等）。</li>
</ul>
<p>​		类是由成员变量、构造器、成员方法组成的。<strong>我们学习反射，就是学习获取类的信息，操作它们。</strong></p>
<h2 id="获取类的构造器"><a href="#获取类的构造器" class="headerlink" title="获取类的构造器"></a>获取类的构造器</h2><p><strong>1、 反射第一步：加载类，获取类的字节码：Class对象（万物皆对象，类的字节码在Java中还是Class对象）</strong></p>
<p>Student.java——&gt;Student.class——&gt;字节码文件——&gt;内存</p>
<p>获取Class对象的三种方式</p>
<ul>
<li>Class c1 &#x3D; 类名.class</li>
<li>调用Class提供方法：public static Class forName(String package);</li>
<li>Object提供的方法：public Class getClass(); Class c3 &#x3D; 对象.getClass();</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.d2_reliect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1Class</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//第一种方式</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Student.class;</span><br><span class="line">        System.out.println(c1.getName()); <span class="comment">// 全类名</span></span><br><span class="line">        System.out.println(c1.getSimpleName());  <span class="comment">//简名：Student</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第二种方式</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.itheima.d2_reliect.Student&quot;</span>);</span><br><span class="line">        System.out.println(c1 == c2);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//第三种方式</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c3</span> <span class="operator">=</span> s.getClass();</span><br><span class="line">        System.out.println(c3 == c1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2、获取类的构造器：Constructor对象</strong></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Constructor&lt;?&gt;[] getConstructors()</td>
<td>获取全部构造器（只能获取public修饰的）</td>
</tr>
<tr>
<td>Constructor&lt;?&gt;[] getDeclaredConstructors()</td>
<td>获取全部构造器（只要存在就能拿到）</td>
</tr>
<tr>
<td>Constructor&lt;?&gt;[] getConstructor(Class&lt;?&gt;… parameterTypes)</td>
<td>获取某个构造器（只能获取public修饰的）</td>
</tr>
<tr>
<td>Constructor&lt;?&gt;[] getDeclaredConstructor(Class&lt;?&gt;… parameterTypes)</td>
<td>获取某个构造器（只要存在就能拿到）</td>
</tr>
</tbody></table>
<p><strong>示例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetConstructor2</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">// 1、反射第一步：必须先得到这个类的Class对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Cat.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、获取某个构造器，无参数构造器</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor();</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        System.out.println(constructor.getName() + <span class="string">&quot;===&gt;&quot;</span> + constructor.getParameterCount());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1 通过无参构造器初始化实例</span></span><br><span class="line">        <span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> (Cat) constructor.newInstance();</span><br><span class="line">        System.out.println(cat);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、获取某个构造器，有参数构造器</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> c.getDeclaredConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">        System.out.println(constructor1.getName() + <span class="string">&quot;===&gt;&quot;</span> + constructor1.getParameterCount());</span><br><span class="line">        <span class="comment">// 3.1 通过有参构造器初始化实例</span></span><br><span class="line">        <span class="type">Cat</span> <span class="variable">cat2</span> <span class="operator">=</span> (Cat) constructor1.newInstance(<span class="string">&quot;阿松大&quot;</span>,<span class="number">33</span>);</span><br><span class="line">        System.out.println(cat2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.1、获取类构造器的作用：初始化类对象</strong></p>
<table>
<thead>
<tr>
<th>Constructor提供的方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>T newInstance(Object … initargs)</td>
<td>调用此构造器对象表示的构造器，并传入参数，完成对象的初始化并返回</td>
</tr>
<tr>
<td>public void setAccessible(boolean flag)</td>
<td>设置为true，表示禁止检查访问控制（暴力反射）</td>
</tr>
</tbody></table>
<p><strong>实例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1、获取类的class对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Cat.class;</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> c.getDeclaredConstructor();</span><br><span class="line">System.out.println(constructor1.getName() + <span class="string">&quot;---&gt;&quot;</span> + constructor1.getParameterCount());</span><br><span class="line"><span class="comment">//设置访问权限禁止检查</span></span><br><span class="line">constructor1.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 直接用会报错，因为Cat类的无参构造函数是private的，默认是无法访问的</span></span><br><span class="line"><span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> (Cat) constructor1.newInstance();</span><br><span class="line">System.out.println(cat);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取有参数构造器</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> c.getDeclaredConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">System.out.println(constructor2.getName() + <span class="string">&quot;---&gt;&quot;</span> + constructor2.getParameterCount());</span><br><span class="line"><span class="type">Cat</span> <span class="variable">cat2</span> <span class="operator">=</span> (Cat) constructor2.newInstance(<span class="string">&quot;叮当猫&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(cat2);</span><br></pre></td></tr></table></figure>

<p><strong>3、获取类的成员变量：Field对象</strong></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>public Field[] getFields()</td>
<td>获取类的全部成员变量（只能获取public修饰的）</td>
</tr>
<tr>
<td>public Field[] getDeclaredFields()</td>
<td>获取类的全部成员变量（只能存在就能拿到）</td>
</tr>
<tr>
<td>public Field[] getField(String name)</td>
<td>获取类的某个成员变量（只能获取public修饰的）</td>
</tr>
<tr>
<td>public Field[] getDeclaredField(String name)</td>
<td>获取类的某个成员变量（只能存在就能拿到）</td>
</tr>
</tbody></table>
<p><strong>实例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1、获取类的class对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Cat.class;</span><br><span class="line"><span class="comment">// 2、获取类的全部成员变量</span></span><br><span class="line">Field[] declaredFields = c.getDeclaredFields();</span><br><span class="line"><span class="comment">// 3、遍历这个成员变量数组</span></span><br><span class="line"><span class="keyword">for</span> (Field declaredField : declaredFields) &#123;</span><br><span class="line">    System.out.println(declaredField);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 4、定位某个成员变量</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">fName</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">System.out.println(fName.getName() + <span class="string">&quot;---&gt;&quot;</span> + fName.getType());</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">fAge</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">System.out.println(fAge.getName() + <span class="string">&quot;---&gt;&quot;</span> + fAge.getType());</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>void set(Object obj, Object value)</td>
<td>赋值</td>
</tr>
<tr>
<td>Object get(Object obj)</td>
<td>取值</td>
</tr>
<tr>
<td>public void setAccessible(boolean flag)</td>
<td>设置为true，表示禁止检查访问控制（暴力反射）</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//赋值</span></span><br><span class="line"><span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line"><span class="comment">//定位某个成员变量</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">fName</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">System.out.println(fName.getName() + <span class="string">&quot;---&gt;&quot;</span> + fName.getType());</span><br><span class="line"><span class="comment">//暴力反射</span></span><br><span class="line">fName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">fName.set(cat,<span class="string">&quot;加菲猫&quot;</span>);</span><br><span class="line">System.out.println(cat);</span><br><span class="line"></span><br><span class="line"><span class="comment">//取值</span></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String)fName.get(cat);</span><br><span class="line">System.out.println(name);</span><br></pre></td></tr></table></figure>

<p><strong>4、获取类的成员方法：Method对象</strong></p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Method[] getMethods()</td>
<td>获取类的全部成员方法（只能获取public修饰的）</td>
</tr>
<tr>
<td>Method[] getDeclaredMethods()</td>
<td>获取类的全部成员方法（只要存在就能拿到）</td>
</tr>
<tr>
<td>Method getMethod(String name, Class&lt;?&gt;… parameterTypes)</td>
<td>获取类的某个成员方法（只能获取public修饰的）</td>
</tr>
<tr>
<td>Method getDeclaredMethod(String name, Class&lt;?&gt;… parameterTypes)</td>
<td>获取类的某个成员方法（只要存在就能拿到）</td>
</tr>
</tbody></table>
<p><strong>示例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// 1、反射第一步，先得到类的CLass对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Cat.class;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2、获取类的全部成员方法</span></span><br><span class="line">Method[] declaredMethods = c.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3、遍历数组中的每个方法对象</span></span><br><span class="line"><span class="keyword">for</span> (Method declaredMethod : declaredMethods) &#123;</span><br><span class="line">    System.out.println(declaredMethod.getName() + <span class="string">&quot;---&gt;&quot;</span></span><br><span class="line">                       + declaredMethod.getParameterCount() + <span class="string">&quot;---&gt;&quot;</span></span><br><span class="line">                       + declaredMethod.getReturnType());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4、获取某个方法对象</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">eat</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;eat&quot;</span>);</span><br><span class="line">System.out.println(eat.getName() + <span class="string">&quot;---&gt;&quot;</span> + eat.getParameterCount() + <span class="string">&quot;---&gt;&quot;</span> + eat.getReturnType());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4、获取某个方法对象</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">eat2</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;eat&quot;</span>, String.class);</span><br><span class="line">System.out.println(eat2.getName() + <span class="string">&quot;---&gt;&quot;</span> + eat2.getParameterCount() + <span class="string">&quot;---&gt;&quot;</span> + eat2.getReturnType());</span><br></pre></td></tr></table></figure>

<p><strong>4.2、执行类的成员方法</strong></p>
<table>
<thead>
<tr>
<th>Method提供的方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>public Object invoke(Object obj, Object… args)</td>
<td>触发某个对象的该方法执行</td>
</tr>
<tr>
<td>public void setAccessible(boolean flag)</td>
<td>设置为true，表示禁止检查访问控制（暴力反射）</td>
</tr>
</tbody></table>
<p><strong>示例</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1、反射第一步，先得到类的CLass对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Cat.class;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2、获取某个方法对象</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">eat</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;eat&quot;</span>);</span><br><span class="line">System.out.println(eat.getName() + <span class="string">&quot;---&gt;&quot;</span> + eat.getParameterCount() + <span class="string">&quot;---&gt;&quot;</span> + eat.getReturnType());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3、获取某个方法对象</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">eat2</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;eat&quot;</span>, String.class);</span><br><span class="line">System.out.println(eat2.getName() + <span class="string">&quot;---&gt;&quot;</span> + eat2.getParameterCount() + <span class="string">&quot;---&gt;&quot;</span> + eat2.getReturnType());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4、出发run方法执行</span></span><br><span class="line"><span class="type">Cat</span> <span class="variable">cat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cat</span>();</span><br><span class="line">eat2.setAccessible(<span class="literal">true</span>);  <span class="comment">// 禁止检查访问权限</span></span><br><span class="line"><span class="type">String</span> <span class="variable">rs</span> <span class="operator">=</span> eat2.invoke(cat, <span class="string">&quot;shit&quot;</span>); <span class="comment">// 调用无参数的run方法，用cat对象触发调用的。</span></span><br><span class="line">System.out.println(rs);</span><br></pre></td></tr></table></figure>

<p><strong>5、反射的作用和应用场景</strong></p>
<p>反射的作用</p>
<ul>
<li><p>基本作用：可以得到一个类的全部成分然后操作。</p>
</li>
<li><p>可以破坏封装性。</p>
</li>
<li><p>最重要的用途是：适合做Java的框架，基本上，主流的框架都会基于反射设计出一些通用的功能。</p>
</li>
</ul>
<p>应用场景</p>
<p>需求： 对任意一个对象，该框架都可以把对象的字段名和对应的值，保存到文件中去。</p>
<p>实现步骤：</p>
<ol>
<li>定义一个方法，可以接受任意对象</li>
<li>每收到一个对象后，使用反射获取该对象的Class对象，然后获取全部的成员变量。</li>
<li>遍历成员变量，然后提取成员变量在该对象中的具体值。</li>
<li>把成员变量名，和其值，写到文件中即可。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectFrame</span> &#123;</span><br><span class="line">    <span class="comment">// 目标：保存任意对象的字段及其数据到文件中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveObject</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IllegalAccessException, FileNotFoundException &#123;</span><br><span class="line">        <span class="type">PrintStream</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;src\\data.txt&quot;</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、obj是任意对象，到底有多少个字段要保存。</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cName</span> <span class="operator">=</span> c.getSimpleName();</span><br><span class="line">        ps.println(<span class="string">&quot;------------------------------------&quot;</span> + cName + <span class="string">&quot;---------------------------&quot;</span>);</span><br><span class="line">        <span class="comment">// 2、从类中提取它的全部成员变量。</span></span><br><span class="line">        Field[] fields = c.getDeclaredFields();</span><br><span class="line">        <span class="comment">// 3、遍历每个成员变量</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="comment">// 4、拿到成员变量的名字</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> field.getName();</span><br><span class="line">            <span class="comment">// 5、拿到这个成员变量在对象中的数据</span></span><br><span class="line">            field.setAccessible(<span class="literal">true</span>); <span class="comment">// 禁止检查访问控制</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> field.get(obj) + <span class="string">&quot;&quot;</span>;</span><br><span class="line">            ps.println(name + <span class="string">&quot;=&quot;</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="注解（Annotation）"><a href="#注解（Annotation）" class="headerlink" title="注解（Annotation）"></a>注解（Annotation）</h1><h2 id="概述、自定义注解"><a href="#概述、自定义注解" class="headerlink" title="概述、自定义注解"></a>概述、自定义注解</h2><ul>
<li><p>就是Java代码中的特殊标记，比如：@Override，@Test等，作用是：让其他程序根据注解信息来决定怎么执行程序。</p>
</li>
<li><p>注意：注解可以用在类上、构造器上、方法上、成员变量上、参数上、等位置处。</p>
</li>
<li><p>自定义注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> 注解名称&#123;</span><br><span class="line">    <span class="keyword">public</span> 属性类型 属性名() <span class="keyword">default</span> 默认值;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>特殊属性名：value</p>
<ul>
<li>如果注解中只有一个value属性，使用注释时，value名称可以不写！！</li>
</ul>
<p>示例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*AnnotationTest1.java*/</span></span><br><span class="line"><span class="meta">@MyTest1(aaa = &quot;牛魔王&quot;, ccc = &#123;&quot;html&quot;,&quot;java&quot;&#125;)</span></span><br><span class="line"><span class="comment">//@MyTest2(value=&quot;孙悟空&quot;)</span></span><br><span class="line"><span class="meta">@MyTest2(&quot;孙悟空&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationTest1</span> &#123;</span><br><span class="line">    <span class="meta">@MyTest1(aaa = &quot;铁扇公主&quot;, bbb = false, ccc = &#123;&quot;python&quot;,&quot;前端&quot;,&quot;java&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Mytest1.java*/</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义注解</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTest1 &#123;</span><br><span class="line">    String <span class="title function_">aaa</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">bbb</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">    String[] ccc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Mytest2.java*/</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTest2 &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>; <span class="comment">//特殊属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注解的原理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTest1 &#123;</span><br><span class="line">    String <span class="title function_">aaa</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">bbb</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">    String[] ccc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行main函数得到编译文件，使用xjad反编译文件，得到结果</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyTest1</span> extend Annotation&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">aaa</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">bbb</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String[] ccc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注解本质上是一个接口，Java中所有注解都是继承Annotation接口的。</li>
<li>@注解(…)：其实就是一个实现类对象，实现了该注解以及Annotation接口。</li>
</ul>
</li>
</ul>
<h2 id="元注解"><a href="#元注解" class="headerlink" title="元注解"></a>元注解</h2><ul>
<li><p>指的是：修饰注解的注解。</p>
</li>
<li><p><strong>元注解一</strong></p>
<p>作用：声明被修饰的注解只能在哪些位置使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="number">1.</span> TYPE，类，接口</span><br><span class="line"><span class="number">2.</span> FIELD，成员变量</span><br><span class="line"><span class="number">3.</span> METHOD, 成员方法</span><br><span class="line"><span class="number">4.</span> PARAMETER, 方法参数</span><br><span class="line"><span class="number">5.</span> CONSTRUCTOR, 构造器</span><br><span class="line"><span class="number">6.</span> LOCAL_VARIABLE, 局部变量</span><br></pre></td></tr></table></figure>




<table>
<thead>
<tr>
<th>类型</th>
<th>作用范围</th>
</tr>
</thead>
<tbody><tr>
<td>TYPE</td>
<td>类，接口</td>
</tr>
<tr>
<td>FIELD</td>
<td>成员变量</td>
</tr>
<tr>
<td>METHOD</td>
<td>成员方法</td>
</tr>
<tr>
<td>PARAMETER</td>
<td>方法参数</td>
</tr>
<tr>
<td>CONSTRUCTOR</td>
<td>构造器</td>
</tr>
<tr>
<td>LOCAL_VARIABLE</td>
<td>局部变量</td>
</tr>
</tbody></table>
</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE,ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTest3 &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>元注解二</strong></p>
<p>作用：声明注解的保留周期</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy,RUNTIME)</span></span><br><span class="line"><span class="number">1.</span> SOURCE</span><br><span class="line">    只作用在源码阶段，字节码文件中不存在</span><br><span class="line"><span class="number">2.</span> CLASS（默认值）</span><br><span class="line">    保留到字节码文件姐阶段，运行阶段不存在</span><br><span class="line"><span class="number">3.</span> RUNTIME（开发常用）</span><br><span class="line">    一直保存到运行阶段</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="注解的解析"><a href="#注解的解析" class="headerlink" title="注解的解析"></a>注解的解析</h2><ul>
<li><p>就是判断类上面，方法上，成员变量上是否存在注解，并把注解里的内容解析出来</p>
</li>
<li><p>如何解析注解？</p>
<ul>
<li><p>指导思想：要解析谁上面的注解，就应该先拿到谁。</p>
</li>
<li><p>比如要解析类上面的注解，则应该先获取该类的对象，再通过Class对象解析其上面的注解。</p>
</li>
<li><p>比如要解析成员方法上面的注解，则应该先获取该成员方法的Method对象，再通过Method对象解析其上面的注解。</p>
</li>
<li><p>Class、Method、Field、Constructor都实现了AnnotatedElement接口，它们都拥有解析注解的能力。</p>
<table>
<thead>
<tr>
<th>AnnotatedElement接口提供了解析注解的方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>public Annotation[] getDeclaredAnnotations()</td>
<td>获取当前对象上面的注解</td>
</tr>
<tr>
<td>public T getDeclaredAnnotation(Class&lt;\T&gt; annotationClass)</td>
<td>获取指定的注解对象</td>
</tr>
<tr>
<td>public boolean isAnnotationPresent(Class&lt;Annotation&gt; annotationClass)</td>
<td>判断当前对象上是否存在某个注解</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>解析注解的案例</p>
<p>定义注解MyTest4,要求如下所示</p>
<ol>
<li>包含属性：String value()</li>
<li>包含属性：double aaa()，默认值是100</li>
<li>包含属性：String[] bbb()</li>
<li>限制注解使用的位置：类和成员方法上</li>
<li>限制注解的有效范围：一直到运行时</li>
</ol>
<p>定义一个类：Demo，在类中定义一个test1方法，并在该类和其方法上使用MyTest4注解</p>
<p>定义一个AnnotationTest3测试类，解析Demo类中的全部注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// -------------------MyTest4.java-----------------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE,ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTest4 &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">double</span> <span class="title function_">aaa</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">100</span>;</span><br><span class="line">    String[] bbb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------------Demo.java-------------------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@MyTest4(value = &quot;蜘蛛精&quot;, aaa = 99.5, bbb = &#123;&quot;至尊宝&quot;, &quot;黑马&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="meta">@MyTest4(value = &quot;至尊宝&quot;, aaa = 199.5, bbb = &#123;&quot;紫霞&quot;, &quot;牛夫人&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------------AnnotationTest3.java-----------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationTest3</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseClass</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="comment">// 1、先得到Class对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Demo.class;</span><br><span class="line">        <span class="comment">// 2、解析类上的注解</span></span><br><span class="line">        <span class="comment">// 判断类上是否包含了某个注解</span></span><br><span class="line">        <span class="keyword">if</span>(c.isAnnotationPresent(MyTest4.class)) &#123;</span><br><span class="line">            <span class="type">MyTest4</span> <span class="variable">myTest4</span> <span class="operator">=</span> (MyTest4) c.getDeclaredAnnotation(MyTest4.class);</span><br><span class="line">            System.out.println(myTest4.value());</span><br><span class="line">            System.out.println(myTest4.aaa());</span><br><span class="line">            System.out.println(Arrays.toString(myTest4.bbb()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseMethod</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="comment">// 1、先得到Class对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Demo.class;</span><br><span class="line">        <span class="comment">// 2、获取方法对象</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">        <span class="comment">// 3、判断方法对象上是否包含了某个注释</span></span><br><span class="line">        <span class="keyword">if</span>(m.isAnnotationPresent(MyTest4.class))&#123;</span><br><span class="line">            <span class="type">MyTest4</span> <span class="variable">myTest4</span> <span class="operator">=</span> (MyTest4) m.getDeclaredAnnotation(MyTest4.class);</span><br><span class="line">            System.out.println(myTest4.value());</span><br><span class="line">            System.out.println(myTest4.aaa());</span><br><span class="line">            System.out.println(Arrays.toString(myTest4.bbb()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li><p>模拟Junit框架</p>
<p><strong>需求</strong>：定义若干个方法，只要加了MyTest注解，就会触发该方法的执行。</p>
<p><strong>分析</strong></p>
<ol>
<li>定义一个自定义注解MyTest，只能注解方法，存活范围是一直都在。</li>
<li>定义若干个方法，部分方法加上@MyTest修饰，部分方法不加。</li>
<li>模拟一个Junit程序，可以触发加了@MyTest注解的方法执行。</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ---------------AnnotationTest4.java----------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationTest4</span> &#123;</span><br><span class="line">    <span class="meta">@MyTest</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----test1----&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@MyTest</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----test2----&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----test3----&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@MyTest</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;----test4----&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">AnnotationTest4</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationTest4</span>();</span><br><span class="line">        <span class="comment">//启动程序！</span></span><br><span class="line">        <span class="comment">// 1、得到class对象</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> AnnotationTest4.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、提取这个类的全部成员方法</span></span><br><span class="line">        Method[] methods = c.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="comment">//3、遍历这个数组中的每个方法，看方法是否被@MyTest注释</span></span><br><span class="line">            <span class="keyword">if</span>(method.isAnnotationPresent(MyTest.class))&#123;</span><br><span class="line">                <span class="comment">//说明当前方法是存在@MyTest，触发方法执行</span></span><br><span class="line">                method.invoke(a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------MyTest4.java----------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d3_annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE,ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTest4 &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">double</span> <span class="title function_">aaa</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">100</span>;</span><br><span class="line">    String[] bbb();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><ul>
<li><p>概述、快速入门</p>
<p>对象如果嫌身上干的事情太多的话，可以通过代理转移部分职责。</p>
<p>对象有什么方法想被代理，代理就一定要有对应的方法。</p>
</li>
<li><p>应用案例、使用代理的好处</p>
<p>转移对象的方法，优化类的逻辑结构</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ----------------------UserService.java------------------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d5_proxy2;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  用户业务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 登录功能</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String loginName,String passWord)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="comment">// 删除用户</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteUsers</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="comment">// 查询用户，返回数组的形式。</span></span><br><span class="line">    String[] selectUsers() <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------UserServceImpl.java-----------------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d5_proxy2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户业务实现类（面向接口编程）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String loginName, String passWord)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;admin&quot;</span>.equals(loginName) &amp;&amp; <span class="string">&quot;123456&quot;</span>.equals(passWord))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;您登录成功，欢迎光临本系统~&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;您登录失败，用户名或密码错误~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUsers</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;成功删除了1万个用户~&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectUsers() <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;查询出了3个用户&quot;</span>);</span><br><span class="line">        String[] names = &#123;<span class="string">&quot;张全蛋&quot;</span>, <span class="string">&quot;李二狗&quot;</span>, <span class="string">&quot;牛爱花&quot;</span>&#125;;</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> names;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------------------ProxyUtil.java------------------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d5_proxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyUtil</span> &#123;</span><br><span class="line"><span class="comment">//    public static UserService createProxy(UserService userService)&#123;</span></span><br><span class="line"><span class="comment">//        UserService userServiceProxy = (UserService) Proxy.newProxyInstance(ProxyUtil.class.getClassLoader(),</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;UserService.class&#125;, new InvocationHandler() &#123;</span></span><br><span class="line"><span class="comment">//                    @Override</span></span><br><span class="line"><span class="comment">//                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                        if(method.getName().equals(&quot;login&quot;) || method.getName().equals(&quot;deleteUsers&quot;)||</span></span><br><span class="line"><span class="comment">//                               method.getName().equals(&quot;selectUsers&quot;))&#123;</span></span><br><span class="line"><span class="comment">//                            long startTime = System.currentTimeMillis();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                            Object rs = method.invoke(userService, args);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                            long endTime = System.currentTimeMillis();</span></span><br><span class="line"><span class="comment">//                            System.out.println(method.getName() + &quot;方法执行耗时：&quot; + (endTime - startTime)/ 1000.0 + &quot;s&quot;);</span></span><br><span class="line"><span class="comment">//                            return rs;</span></span><br><span class="line"><span class="comment">//                        &#125;else &#123;</span></span><br><span class="line"><span class="comment">//                            Object rs = method.invoke(userService, args);</span></span><br><span class="line"><span class="comment">//                            return rs;</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;);</span></span><br><span class="line"><span class="comment">//        return userServiceProxy;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserService <span class="title function_">createProxy</span><span class="params">(UserService userService)</span>&#123;</span><br><span class="line">        <span class="comment">//1、使用Proxy类调用静态方法newProxyInstance创建代理，代理要强转为UserService类型</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userServiceProxy</span> <span class="operator">=</span> (UserService) Proxy.newProxyInstance(ProxyUtil.class.getClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;UserService.class&#125;, <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="keyword">if</span>(method.getName().equals(<span class="string">&quot;login&quot;</span>) || method.getName().equals(<span class="string">&quot;deleteUsers&quot;</span>) || method.getName().equals(<span class="string">&quot;selectUsers&quot;</span>))&#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">rs</span> <span class="operator">=</span> method.invoke(userService, args);</span><br><span class="line">                        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                        System.out.println(method.getName() + <span class="string">&quot;方法执行耗时：&quot;</span> + (endTime - startTime) / <span class="number">1000.0</span> + <span class="string">&quot;s&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> rs;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">rs</span> <span class="operator">=</span> method.invoke(userService, args);</span><br><span class="line">                        <span class="keyword">return</span> rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userServiceProxy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------------Test.java----------------------------</span></span><br><span class="line"><span class="keyword">package</span> com.itheima.d5_proxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 目标：使用动态代理解决实际问题，并掌握使用代理的好处。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 1、创建用户业务对象。</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> ProxyUtil.createProxy(<span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、调用用户业务的功能。</span></span><br><span class="line">        userService.login(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        userService.deleteUsers();</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] names = userService.selectUsers();</span><br><span class="line">        System.out.println(<span class="string">&quot;查询到的用户是：&quot;</span> + Arrays.toString(names));</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









]]></content>
      <categories>
        <category>javase</category>
      </categories>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2023/10/27/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
</search>
