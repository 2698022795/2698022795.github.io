<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />




  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg?v=5.1.4">






  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="和光同尘">
<meta property="og:type" content="website">
<meta property="og:title" content="章北海">
<meta property="og:url" content="http://2698022795.github.io/index.html">
<meta property="og:site_name" content="章北海">
<meta property="og:description" content="和光同尘">
<meta property="og:locale">
<meta property="article:author" content="waterdance">
<meta property="article:tag" content="Java,Python,Linux,C++,算法,编程技术">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://2698022795.github.io/"/>





  <title>章北海</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">章北海</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">轻舟已过万重山</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/" itemprop="url">如何在hexo中安装next主题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
	   		  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-01-12T13:57:00+08:00">
                2024-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index">
                    <span itemprop="name">博客</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="1-安装hexo"><a href="#1-安装hexo" class="headerlink" title="1. 安装hexo"></a>1. 安装hexo</h1><p>npm install -g hexo-cli</p>
<h1 id="2-主题下载安装"><a href="#2-主题下载安装" class="headerlink" title="2. 主题下载安装"></a>2. 主题下载安装</h1><p>进入命令行，下载 NexT 主题，输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<p>修改站点配置文件<code>_config.yml</code>，找到如下代码：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">landscape</span></span><br></pre></td></tr></table></figure>

<p>将 landscape 修改为 next 即可。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/31/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/31/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" itemprop="url">学成在线技术总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-31T13:31:20+08:00">
                2024-03-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  0
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2024/03/31/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331134948189.png" alt="image-20240331134948189"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" itemprop="url">微服务技术总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-29T15:38:18+08:00">
                2024-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  13.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  56
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="day01"><a href="#day01" class="headerlink" title="day01"></a>day01</h1><h2 id="1-Nacos的导入及使用"><a href="#1-Nacos的导入及使用" class="headerlink" title="1. Nacos的导入及使用"></a>1. Nacos的导入及使用</h2><p>这个依赖中同时包含了<strong>服务注册和服务发现</strong>的功能。</p>
<p><strong>服务注册</strong>：微服务启动时要将自己的服务信息提交至nacos。</p>
<p>服务注册步骤如下：</p>
<ol>
<li><p>引入nacos discovery依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nacos地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">application:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">item-service</span> <span class="comment">#服务名称</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">    	<span class="attr">nacos:</span></span><br><span class="line">    		<span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.226</span><span class="number">.129</span><span class="string">:8848</span> <span class="comment">#nacos地址</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>服务发现</strong>：服务调用者要调用别的服务就要去注册中心拉取列表。</p>
<p>消费者需要链接nacos以拉取和订阅服务，因此服务发现的前两步与服务注册是一样，后面再加上服务调用即可：</p>
<ol>
<li><p>引入nacos discovery依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nacos地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">application:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">item-service</span> <span class="comment">#服务名称</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">    	<span class="attr">nacos:</span></span><br><span class="line">    		<span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.226</span><span class="number">.129</span><span class="string">:8848</span> <span class="comment">#nacos地址</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-OpenFeign的导入及使用"><a href="#2-OpenFeign的导入及使用" class="headerlink" title="2. OpenFeign的导入及使用"></a>2. OpenFeign的导入及使用</h2><p><strong>总结：各自微服务模块原来该怎么写还是怎么写，但是微服务A要调用微服务B的接口，只需要使用OpenFeign封装好的接口方法即可。重点在于api接口模块汇总其他微服务要暴露的接口。</strong></p>
<p>OpenFeign已经被SpringCloud自动装配，实现起来非常简单：</p>
<ol>
<li><p><strong>第一步，创建hm-api模块，一般我们会将暴露给第三方的接口整合到单独的模块中，方便其他微服务模块引入和调用。后续的依赖配置均在hm-api模块中</strong></p>
</li>
<li><p>第二步，给<strong>hm-api微服务</strong>引入依赖，包括OpenFeign和负载均衡组件SpringCloudLoadBalancer</p>
<p>负载均衡早期使用的是SpringCloud的Ribbon，新版本用的是loadBalancer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--openFeign--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--负载均衡器--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<strong>hm-api微服务</strong>编写FeignClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/items&quot;)</span></span><br><span class="line">    List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只需要声明接口，无需实现方法。接口中的几个关键信息：</p>
<ul>
<li><strong><code>@FeignClient(&quot;item-service&quot;)</code> ：声明服务名称</strong></li>
<li><strong><code>@GetMapping</code> ：声明请求方式</strong></li>
<li><strong><code>@GetMapping(&quot;/items&quot;)</code> ：声明请求路径</strong></li>
<li><strong><code>@RequestParam(&quot;ids&quot;) Collection&lt;Long&gt; ids</code> ：声明请求参数</strong></li>
<li><strong><code>List&lt;ItemDTO&gt;</code> ：返回值类型</strong></li>
</ul>
<p><strong>有了上述信息，OpenFeign就可以利用动态代理帮我们实现这个方法，并且向<code>http://item-service/items</code>发送一个<code>GET</code>请求，携带ids为请求参数，并自动将返回值处理为<code>List&lt;ItemDTO&gt;</code>。</strong></p>
<p>我们只需要直接调用这个方法，即可实现远程调用了。</p>
</li>
<li><p>在<font color="red"><strong>第三方微服务启动类</strong></font>中通过@EnableFeignClients注解，启用OpenFeign功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.cart;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartApplication</span> &#123;</span><br><span class="line">	<span class="comment">// .. 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<font color="red"><strong>第三方微服务模块</strong></font>使用FeignClient调用hm-api的接口远程访问对应微服务模块的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ItemDTO&gt; items = itemClient.queryItemByIds(itemIds);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-1-OpenFeign连接池配置"><a href="#2-1-OpenFeign连接池配置" class="headerlink" title="2.1 OpenFeign连接池配置"></a>2.1 <strong>OpenFeign连接池配置</strong></h3><p>OpenFeign对Http请求做了优雅的伪装，不过其底层发起http请求，依赖于其他的框架。这些框架可以自己选择，包括以下三种：</p>
<ul>
<li>HttpURLConnection：默认实现，不支持连接池</li>
<li>Apache HttpClient：支持连接池</li>
<li>OKHttp：支持连接池</li>
</ul>
<p>hm-api微服务引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--OK http 的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>hm-api微服务开启连接池功能</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启OKHttp功能</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-OpenFeign日志输出配置"><a href="#2-2-OpenFeign日志输出配置" class="headerlink" title="2.2 OpenFeign日志输出配置"></a>2.2 OpenFeign日志输出配置</h3><p><strong>微服务接口调用如果我们要通过日志输出查看调用过程，要通过OpenFeign设置。</strong></p>
<p>OpenFeign只会在FeignClient所在包的日志级别为<strong>DEBUG</strong>时，才会输出日志。而且其日志级别有4级：</p>
<ul>
<li><strong>NONE</strong>：不记录任何日志信息，这是默认值。</li>
<li><strong>BASIC</strong>：仅记录请求的方法，URL以及响应状态码和执行时间</li>
<li><strong>HEADERS</strong>：在BASIC的基础上，额外记录了请求和响应的头信息</li>
<li><strong>FULL</strong>：记录所有请求和响应的明细，包括头信息、请求体、元数据。</li>
</ul>
<p>Feign默认的日志级别就是NONE，所以默认我们看不到请求日志。</p>
<p>要自定义日志级别需要声明一个类型为Logger.Level的Bean，在其中定义日志级别：(在hm-api中定义对应类)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.api.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultFeignConfig</span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，要让日志级别生效，还需要配置这个类。有两种方式：</p>
<ul>
<li><strong>局部</strong>生效：在某个<code>FeignClient</code>中配置，只对当前<code>FeignClient</code>生效</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;, configuration = DefaultFeignConfig.class)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>全局</strong>生效：在<code>@EnableFeignClients</code>中配置，针对所有<code>FeignClient</code>生效。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = DefaultFeignConfig.class)</span></span><br></pre></td></tr></table></figure>





<h1 id="day02"><a href="#day02" class="headerlink" title="day02"></a>day02</h1><h2 id="1-网关的导入及使用"><a href="#1-网关的导入及使用" class="headerlink" title="1. 网关的导入及使用"></a>1. 网关的导入及使用</h2><ol>
<li><p>创建hm-gateway模块，编写启动类，同时引入以下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在hm-gateway模块的application.yaml文件中导入网关配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item</span> <span class="comment"># 路由规则id，自定义，唯一</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span> <span class="comment"># 路由的目标服务，lb代表负载均衡，会从注册中心拉取服务列表</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，判断当前请求是否符合当前规则，符合则路由到目标服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,/search/**</span> <span class="comment"># 这里是以请求路径作为判断规则</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/users/**,/addresses/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">trade</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://trade-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/orders/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pay</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pay-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/pay-orders/**</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-网关配置登录校验"><a href="#2-网关配置登录校验" class="headerlink" title="2. 网关配置登录校验"></a>2. 网关配置登录校验</h2><p><strong>总结：网关中做登录校验，确保前端的用户是合法的。同时在网关向其他微服务转发请求的请求头中加上用户ID。</strong></p>
<ol>
<li><p>配置<code>AuthProperties</code>：配置登录校验需要拦截的路径，因为不是所有的路径都需要登录才能访问<code>JwtProperties</code>：定义与JWT工具有关的属性，比如秘钥文件位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hm.auth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; includePaths;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; excludePaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.gateway.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hm.jwt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Resource location;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String alias;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Duration</span> <span class="variable">tokenTTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>application.yaml</code>中配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">classpath:hmall.jks</span> <span class="comment"># 秘钥地址</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">hmall</span> <span class="comment"># 秘钥别名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hmall123</span> <span class="comment"># 秘钥文件密码</span></span><br><span class="line">    <span class="attr">tokenTTL:</span> <span class="string">30m</span> <span class="comment"># 登录有效期</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">excludePaths:</span> <span class="comment"># 无需登录校验的路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/search/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/users/login</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/items/**</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置登录校验的过滤器，这一步用来校验前端的token是否正确，同时向其他微服务转发请求时在请求头中加入user-info:userId，使得其他微服务可以通过拦截器获取该操作的用户id。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.gateway.filters;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthProperties authProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTool jwtTool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 获取request</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 判断是否需要做登录拦截</span></span><br><span class="line">        <span class="keyword">if</span>(isExclude(request.getPath().toString()))&#123;</span><br><span class="line">            <span class="comment">//放行</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//3. 获取token</span></span><br><span class="line">        List&lt;String&gt; headers = request.getHeaders().get(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(headers != <span class="literal">null</span> &amp;&amp; !headers.isEmpty())&#123;</span><br><span class="line">            token = headers.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//4. 校验并解析token</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            userId = jwtTool.parseToken(token);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (UnauthorizedException e)&#123;</span><br><span class="line">            <span class="comment">//拦截，设置响应状态码为401</span></span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> userId.toString();</span><br><span class="line">        <span class="type">ServerWebExchange</span> <span class="variable">swe</span> <span class="operator">=</span> exchange.mutate()</span><br><span class="line">            .request(builder -&gt; builder.header(<span class="string">&quot;user-info&quot;</span>, userInfo))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chain.filter(swe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExclude</span><span class="params">(String string)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String excludePath : authProperties.getExcludePaths()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(antPathMatcher.match(excludePath,string))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="3-微服务获取网关请求头用户id"><a href="#3-微服务获取网关请求头用户id" class="headerlink" title="3. 微服务获取网关请求头用户id"></a>3. 微服务获取网关请求头用户id</h2><p><strong>总结：</strong></p>
<p><strong>前端发送的请求经过网关token校验，判断是否合法，并将用户id存入请求头中；</strong></p>
<p><strong>微服务通过拦截器获取网关转发请求的请求头的用户ID。</strong></p>
<p><strong>为了确保每个微服务都有拦截器，一个常见的做法是将拦截器定义在common模块中，再微服务需要该模块时再引入依赖即可。</strong></p>
<p><strong>拦截器在单体项目中直接生效，但是如果要在其他模块中生效，需要先配置属性类将其诸如到IOC，同时编写META-INF&#x2F;spring.factories，将其纳入扫描包中。</strong></p>
<p><strong>最后，网关也引用了common模块，要将他排除，因此要在MvcConfig加上@ConditionalOnClass注解</strong></p>
<p>在hm-common中已经有一个用于保存登录用户的ThreadLocal工具：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329225927898.png" alt="image-20240329225927898"></p>
<p>其中已经提供了保存和获取用户的方法：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329225936384.png" alt="image-20240329225936384"></p>
<p>接下来，我们只需要编写拦截器，获取用户信息并保存到<code>UserContext</code>，然后放行即可。</p>
<p>由于每个微服务都有获取登录用户的需求，因此拦截器我们直接写在<code>hm-common</code>中，并写好自动装配。这样微服务只需要引入<code>hm-common</code>就可以直接具备拦截器功能，无需重复编写。</p>
<p>我们在<code>hm-common</code>模块下定义一个拦截器：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329225950802.png" alt="image-20240329225950802"></p>
<p>具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.common.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.hmall.common.utils.UserContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.获取请求头中的用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;user-info&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.判断是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(userInfo)) &#123;</span><br><span class="line">            <span class="comment">// 不为空，保存到ThreadLocal</span></span><br><span class="line">                UserContext.setUser(Long.valueOf(userInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 移除用户</span></span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着在<code>hm-common</code>模块下编写<code>SpringMVC</code>的配置类，配置登录拦截器：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329225959853.png" alt="image-20240329225959853"></p>
<p>具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.common.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.common.interceptors.UserInfoInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.DispatcherServlet;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">UserInfoInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，需要注意的是，这个配置类默认是不会生效的，因为它所在的包是<code>com.hmall.common.config</code>，与其它微服务的扫描包不一致，无法被扫描到，因此无法生效。</p>
<p>基于SpringBoot的自动装配原理，我们要将其添加到<code>resources</code>目录下的<code>META-INF/spring.factories</code>文件中：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329230010556.png" alt="image-20240329230010556"></p>
<p>内容如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MyBatisConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MvcConfig</span></span><br></pre></td></tr></table></figure>

<h2 id="4-微服务之间获取用户id"><a href="#4-微服务之间获取用户id" class="headerlink" title="4. 微服务之间获取用户id"></a>4. 微服务之间获取用户id</h2><p>总结：</p>
<p>如果微服务A和B之间发起OpenFeign远程调用，且微服务B要使用用户id，会出现用户id为null的情况。</p>
<p>在此之前，网关拦截前端请求，校验token，在请求头加上用户id，转发请求到对应微服务A之后，A调用B的方法，A中拦截器拦截了网关的请求并获取请求头中的用户id，但是网关又没向微服务B发请求，所以B没有拦截获取用户ID。</p>
<p>这就是导致出现情况的原因。</p>
<p>因此要解决OpenFeign调用的参数传递问题，</p>
<p>微服务之间调用是基于OpenFeign来实现的，并不是我们自己发送的请求。我们如何才能让每一个由OpenFeign发起的请求自动携带登录用户信息呢？</p>
<p>这里要借助Feign中提供的一个拦截器接口：<code>feign.RequestInterceptor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called for every request. </span></span><br><span class="line"><span class="comment">   * Add data using methods on the supplied &#123;<span class="doctag">@link</span> RequestTemplate&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只需要实现这个接口，然后实现apply方法，利用<code>RequestTemplate</code>类来添加请求头，将用户信息保存到请求头中。这样以来，每次OpenFeign发起请求的时候都会调用该方法，传递用户信息。</p>
<p>由于<code>FeignClient</code>全部都是在<code>hm-api</code>模块，因此我们在<code>hm-api</code>模块的<code>com.hmall.api.config.DefaultFeignConfig</code>中编写这个拦截器：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329231516482.png" alt="image-20240329231516482"></p>
<p>在<code>com.hmall.api.config.DefaultFeignConfig</code>中添加一个Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RequestInterceptor <span class="title function_">userInfoRequestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">            <span class="comment">// 获取登录用户</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">            <span class="keyword">if</span>(userId == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果为空则直接跳过</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果不为空则放入请求头中，传递给下游微服务</span></span><br><span class="line">            template.header(<span class="string">&quot;user-info&quot;</span>, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，现在微服务之间通过OpenFeign调用时也会传递登录用户信息了。</p>
<h2 id="5-Nacos配置共享"><a href="#5-Nacos配置共享" class="headerlink" title="5. Nacos配置共享"></a>5. Nacos配置共享</h2><p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309160100356.png" alt="image-20240309160100356"></p>
<p>步骤一：引入依赖</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309160639601.png" alt="image-20240309160639601"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos配置管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--读取bootstrap文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>步骤二：新建bootstrap.yaml文件</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309160705283.png" alt="image-20240309160705283"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cart-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.226</span><span class="number">.129</span> <span class="comment"># nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="comment"># 共享配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-jdbc.yaml</span> <span class="comment"># 共享mybatis配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-log.yaml</span> <span class="comment"># 共享日志配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">dataId:</span> <span class="string">shared-swagger.yaml</span> <span class="comment"># 共享日志配置</span></span><br></pre></td></tr></table></figure>



<p><strong>配置细节</strong></p>
<p><strong>shared-jdbc.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;hm.db.host:192.168.150.101&#125;:$&#123;hm.db.port:3306&#125;/$&#123;hm.db.database&#125;?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.db.un:root&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.db.pw:123&#125;</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>

<p>注意这里的jdbc的相关参数并没有写死，例如：</p>
<ul>
<li><code>数据库ip</code>：通过<code>$&#123;hm.db.host:192.168.150.101&#125;</code>配置了默认值为<code>192.168.150.101</code>，同时允许通过<code>$&#123;hm.db.host&#125;</code>来覆盖默认值</li>
<li><code>数据库端口</code>：通过<code>$&#123;hm.db.port:3306&#125;</code>配置了默认值为<code>3306</code>，同时允许通过<code>$&#123;hm.db.port&#125;</code>来覆盖默认值</li>
<li><code>数据库database</code>：可以通过<code>$&#123;hm.db.database&#125;</code>来设定，无默认值</li>
</ul>
<p><strong>shared-log.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmall:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>shared-swagger.yaml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">$&#123;hm.swagger.title:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">$&#123;hm.swagger.description:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">$&#123;hm.swagger.email:zhanghuyi@itcast.cn&#125;</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">$&#123;hm.swagger.concat:虎哥&#125;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">$&#123;hm.swagger.package&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意，这里的swagger相关配置我们没有写死，例如：</p>
<ul>
<li><code>title</code>：接口文档标题，我们用了<code>$&#123;hm.swagger.title&#125;</code>来代替，将来可以有用户手动指定</li>
<li><code>email</code>：联系人邮箱，我们用了<code>$&#123;hm.swagger.email:``zhanghuyi@itcast.cn``&#125;</code>，默认值是<code>zhanghuyi@itcast.cn</code>，同时允许用户利用<code>$&#123;hm.swagger.email&#125;</code>来覆盖。</li>
</ul>
<p>配置的加载顺序大致为：</p>
<ol>
<li><code>bootstrap.yaml</code>（初始化配置，如服务发现、配置中心地址）</li>
<li>配置中心的配置（如Nacos，基于<code>bootstrap.yaml</code>中的配置加载）</li>
<li><code>application.yaml</code>（应用的通用配置）</li>
<li>环境特定的配置文件（如<code>application-dev.yaml</code>，覆盖或补充前面的配置）</li>
</ol>
<h2 id="6-Swagger的导入及使用-方法二"><a href="#6-Swagger的导入及使用-方法二" class="headerlink" title="6. Swagger的导入及使用(方法二)"></a>6. Swagger的导入及使用(方法二)</h2><ol>
<li><p>导入如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-openapi2-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在nacos的yaml文件中配置相关信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">$&#123;hm.swagger.title:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">$&#123;hm.swagger.description:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">$&#123;hm.swagger.email:zhanghuyi@itcast.cn&#125;</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">$&#123;hm.swagger.concat:虎哥&#125;</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">$&#123;hm.swagger.package&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="7-Nacos配置热更新"><a href="#7-Nacos配置热更新" class="headerlink" title="7. Nacos配置热更新"></a>7. Nacos配置热更新</h2><p><strong>总结：通过Nacos配置重要参数，实现不重启即配置热更新。</strong></p>
<p>步骤一：nacos中要有一个与微服务名有关的配置文件。设置cart-service.yaml</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309162421345.png" alt="image-20240309162421345"><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240330183701985.png" alt="image-20240330183701985"></p>
<p>步骤二：</p>
<ol>
<li>微服务中要以特定方式读取需要热更新的配置属性（属性配置类或其他方式）</li>
</ol>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309162805777.png" alt="image-20240309162805777"></p>
<p>步骤三：</p>
<ol>
<li>在对应的代码处用CarProperties.getMaxItems()获取属性值。</li>
</ol>
<h2 id="8-Nacos的路由动态更新"><a href="#8-Nacos的路由动态更新" class="headerlink" title="8. Nacos的路由动态更新"></a>8. Nacos的路由动态更新</h2><h1 id="day03"><a href="#day03" class="headerlink" title="day03"></a>day03</h1><h2 id="1-Sentinel的导入及使用"><a href="#1-Sentinel的导入及使用" class="headerlink" title="1. Sentinel的导入及使用"></a>1. Sentinel的导入及使用</h2><p>1）下载jar包</p>
<p>下载地址：[Releases · alibaba&#x2F;Sentinel (github.com)](</p>
<p>2）运行</p>
<p>将jar包放在任意非中文、不包含特殊字符的目录下，重命名为<code>sentinel-dashboard.jar</code></p>
<p>然后运行如下命令启动控制台：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8090 -Dcsp.sentinel.dashboard.server=localhost:8090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar</span><br></pre></td></tr></table></figure>

<p>访问<a target="_blank" rel="noopener" href="http://localhost:8090/">http://localhost:8090</a>页面，就可以看到sentinel的控制台了：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309203242547.png" alt="image-20240309203242547"></p>
<p>需要输入账号和密码，默认都是：sentinel</p>
<p>登录后，即可看到控制台，默认会监控sentinel-dashboard服务本身：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309205034708.png" alt="image-20240309205034708"></p>
<p>3）在模块中引入sentinel依赖，连接sentinel-dashboard控制台，步骤如下：</p>
<p> 1）引入sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）配置控制台</p>
<p>修改application.yaml文件，添加下面内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8090</span></span><br></pre></td></tr></table></figure>

<p>3）访问<strong>微服务</strong>的任意端点</p>
<p><strong>簇点链路</strong>，就是单机调用链路，是一次请求进入服务后经过的每一个被<code>Sentinel</code>监控的资源。默认情况下，<code>Sentinel</code>会监控<code>SpringMVC</code>的每一个<code>Endpoint</code>（接口）。</p>
<p>因此，我们看到<code>/carts</code>这个接口路径就是其中一个簇点，我们可以对其进行限流、熔断、隔离等保护措施。</p>
<p><font color="red">说白了，就是监控controller中设置的请求路径。</font></p>
<p>不过，需要注意的是，我们的SpringMVC接口是按照Restful风格设计，因此购物车的查询、删除、修改等接口全部都是<code>/carts</code>路径：</p>
<p>Restful风格的API请求路径一般都相同，这会导致簇点资源名称重复。因此我们要修改配置，把<strong>请求方式+请求路径</strong>作为簇点资源名称：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8090</span></span><br><span class="line">      <span class="attr">http-method-specify:</span> <span class="literal">true</span> <span class="comment"># 开启请求方式前缀</span></span><br></pre></td></tr></table></figure>

<p>然后，重启服务，通过页面访问购物车的相关接口，可以看到sentinel控制台的簇点链路发生了变化：</p>
<h3 id="1-1-请求限流"><a href="#1-1-请求限流" class="headerlink" title="1.1 请求限流"></a>1.1 请求限流</h3><p><strong>请求限流：一段时间内要求总的请求量不要超过某个值，不强调某一时刻的总值</strong>。</p>
<p>在簇点链路后面点击流控按钮，即可对其做限流配置：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309210628641.png" alt="image-20240309210628641"></p>
<p>在弹出的菜单中这样填写：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309211057455.png" alt="image-20240309211057455"></p>
<p>这样就把查询购物车列表这个簇点资源的流量限制在了每秒6个，也就是最大QPS为6.</p>
<h3 id="1-2-线程隔离"><a href="#1-2-线程隔离" class="headerlink" title="1.2 线程隔离"></a>1.2 线程隔离</h3><p><strong>线程隔离：某一时刻总的请求量不要超过某个值，不强调一段时间内的总值</strong>。</p>
<p>步骤1：</p>
<p>让OpenFeign整合Sentinel：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  sentinel:</span><br><span class="line">    enabled: true # 开启feign对sentinel的支持</span><br></pre></td></tr></table></figure>

<p>步骤2：配置被请求微服务接口方法的QPS。</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309213633219.png" alt="image-20240309213633219"></p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309213832548.png" alt="image-20240309213832548"></p>
<h3 id="1-3-FeignClient的回调（Fallback）"><a href="#1-3-FeignClient的回调（Fallback）" class="headerlink" title="1.3 FeignClient的回调（Fallback）"></a>1.3 FeignClient的回调（Fallback）</h3><p><strong>当OpenFeign调用其他微服务接口时，如果出现异常，可以编写FallBack做异常处理。注意，我们一般将OpenFeign的接口放在hm-api模块中，让其他微服务模块引入该模块，即可将异常处理导入微服务模块中。</strong></p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309215127124.png" alt="image-20240309215127124"></p>
<p>假设我们有一个FeignClient如下：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309215255008.png" alt="image-20240309215255008"></p>
<p>为其编写Fallback逻辑。步骤如下所示：</p>
<p>步骤一：自定义类，实现FallbackFactory，编写对某个FeignClient的fallback逻辑：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309215640164.png" alt="image-20240309215640164"></p>
<p>步骤二：将刚刚定义的UserClientFallbackFactory注册为一个Bean：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309215821658.png" alt="image-20240309215821658"></p>
<p>步骤三：在UserClient接口中使用UserClientFallbackFactory</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309215850899.png" alt="image-20240309215850899"></p>
<p><strong>步骤一</strong>：在hm-api模块中给<code>ItemClient</code>定义降级处理类，实现<code>FallbackFactory</code>：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309221443729.png" alt="image-20240309221443729"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.api.client.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.api.client.ItemClient;</span><br><span class="line"><span class="keyword">import</span> com.hmall.api.dto.ItemDTO;</span><br><span class="line"><span class="keyword">import</span> com.hmall.api.dto.OrderDetailDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FallbackFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;ItemClient&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ItemClient <span class="title function_">create</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ItemClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(Collection&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">                <span class="comment">//查询出现异常，返回空集合</span></span><br><span class="line">                log.error(<span class="string">&quot;查询商品异常，异常原因：&quot;</span>,cause);</span><br><span class="line">                <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductStock</span><span class="params">(List&lt;OrderDetailDTO&gt; items)</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(cause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤二</strong>：在<code>hm-api</code>模块中的<code>com.hmall.api.config.DefaultFeignConfig</code>类中将<code>ItemClientFallback</code>注册为一个<code>Bean</code>：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309221555926.png" alt="image-20240309221555926"></p>
<p><strong>步骤三</strong>：在<code>hm-api</code>模块中的<code>ItemClient</code>接口中使用<code>ItemClientFallbackFactory</code>：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309221625339.png" alt="image-20240309221625339"></p>
<p>重启后，再次测试，发现被限流的请求不再报错，走了降级逻辑：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309224157908.png" alt="image-20240309224157908"></p>
<h3 id="1-4-服务熔断"><a href="#1-4-服务熔断" class="headerlink" title="1.4 服务熔断"></a>1.4 服务熔断</h3><p>熔断降级是解决雪崩问题的重要手段。思路：由<strong>断路器</strong>来统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务回复时，断路器会放行访问该服务的请求。</p>
<p>查询商品的RT较高（模拟的500ms），从而导致查询购物车的RT也变的很长。这样不仅拖慢了购物车服务，消耗了购物车服务的更多资源，而且用户体验也很差。</p>
<p>对于商品服务这种不太健康的接口，我们应该停止调用，直接走降级逻辑，避免影响到当前服务。也就是将商品查询接口<strong>熔断</strong>。当商品服务接口恢复正常后，再允许调用。这其实就是<strong>断路器</strong>的工作模式了。</p>
<p>Sentinel中的断路器不仅可以统计某个接口的<strong>慢请求比例</strong>，还可以统计<strong>异常请求比例</strong>。当这些比例超出阈值时，就会<strong>熔断</strong>该接口，即拦截访问该接口的一切请求，降级处理；当该接口恢复正常时，再放行对于该接口的请求。</p>
<p>断路器的工作状态切换有一个状态机来控制：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309224919146.png" alt="image-20240309224919146"></p>
<p>状态机包括三个状态：</p>
<ul>
<li><strong>closed</strong>：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li>
<li><strong>open</strong>：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态持续一段时间后会进入half-open状态</li>
<li><strong>half-open</strong>：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 <ul>
<li>请求成功：则切换到closed状态</li>
<li>请求失败：则切换到open状态</li>
</ul>
</li>
</ul>
<p>我们可以在控制台通过点击簇点后的**<code>熔断</code>**按钮来配置熔断策略：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309225202809.png" alt="image-20240309225202809"></p>
<p>这种是按照慢调用比例来做熔断，上述配置的含义是：</p>
<ul>
<li>RT超过200毫秒的请求调用就是慢调用</li>
<li>统计最近1000ms内的最少5次请求，如果慢调用比例不低于0.5，则触发熔断</li>
<li>熔断持续时长20s</li>
</ul>
<h3 id="1-4-持久化Sentinel的配置策略"><a href="#1-4-持久化Sentinel的配置策略" class="headerlink" title="1.4 持久化Sentinel的配置策略"></a>1.4 持久化Sentinel的配置策略</h3><p><strong>如果希望持久化sentinel设置的限流策略，我们可以按照以下步骤实现。</strong></p>
<ol>
<li><p>引入sentinel-nacos依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在nacos添加配置文件degrade.json，在json文件中配置熔断策略</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309230122960.png" alt="image-20240309230122960"></p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309230513990.png" alt="image-20240309230513990"></p>
</li>
<li><p>修改yaml文件，设置对应配置项，在datasource:ds2:下配置nacos的degrade.json文件的相关信息。</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309230749836.png" alt="image-20240309230749836"></p>
</li>
</ol>
<h2 id="2-Seata的导入及使用"><a href="#2-Seata的导入及使用" class="headerlink" title="2. Seata的导入及使用"></a>2. Seata的导入及使用</h2><p>步骤一：导入seata数据表</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240330201552422.png" alt="image-20240330201552422"></p>
<p>步骤二：导入SEATA，准备了一个seata目录，其中包含了seata运行时所需要的配置文件：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309233752868.png" alt="image-20240309233752868"></p>
<p>我们将整个seata文件夹拷贝到虚拟机的<code>/root</code>目录：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240309233945073.png" alt="image-20240309233945073"></p>
<p><strong>Docker部署</strong></p>
<p>需要注意，要确保nacos、mysql都在hm-net网络中。如果某个容器不再hm-net网络，可以参考下面的命令将某容器加入指定网络：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect [网络名] [容器名]</span><br></pre></td></tr></table></figure>

<p>在虚拟机的<code>/root</code>目录执行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run --name seata \</span><br><span class="line">-p 8099:8099 \</span><br><span class="line">-p 7099:7099 \</span><br><span class="line">-e SEATA_IP=192.168.226.129 \</span><br><span class="line">-v ./seata:/seata-server/resources \</span><br><span class="line">--privileged=true \</span><br><span class="line">--network hm-net \</span><br><span class="line">-d \</span><br><span class="line">seataio/seata-server:1.5.2</span><br></pre></td></tr></table></figure>

<p>步骤三：引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>步骤四：向nacos添加配置文件shared-seata.yaml,内容如下，让微服务找到TC服务地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">    <span class="attr">registry:</span> <span class="comment">#注册中心的配置，微服务根据这些信息去注册中心获取TC服务地址</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">nacos</span> <span class="comment">#注册中心类型nacos</span></span><br><span class="line">        <span class="attr">nacos:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">application:</span> <span class="string">seata-server</span> <span class="comment">#seata服务名称</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">password :</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">tx-service-group:</span> <span class="string">hmall</span> <span class="comment">#事务组名称</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">        <span class="attr">vgroup-mapping:</span> <span class="comment">#事务组与tc集群的映射关系</span></span><br><span class="line">        <span class="attr">hmall:</span> <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure>

<p>步骤五：向加入seata的微服务的bootstrap.yaml添加内容：</p>
<p>内容如下:</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240310000831228.png" alt="image-20240310000831228"></p>
<h3 id="2-1-XA模式"><a href="#2-1-XA模式" class="headerlink" title="2.1 XA模式"></a>2.1 XA模式</h3><ol>
<li><p>修改application.yaml文件（每个参与事务的微服务），开启XA模式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seata:</span><br><span class="line">  data-source-proxy-mode: XA</span><br></pre></td></tr></table></figure>
</li>
<li><p>给发起全局事务的入口方法添加@GlobalTransactional注解，本例中是OrderServiceImpl中的create方法：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240310130436215.png" alt="image-20240310130436215"></p>
</li>
</ol>
<h3 id="2-2-AT模式"><a href="#2-2-AT模式" class="headerlink" title="2.2 AT模式"></a>2.2 AT模式</h3><ol>
<li><p>修改application.yaml文件（每个参与事务的微服务），开启XA模式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seata:</span><br><span class="line">  data-source-proxy-mode: AT</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="day04"><a href="#day04" class="headerlink" title="day04"></a>day04</h1><h2 id="1-RabbitMQ的导入及使用"><a href="#1-RabbitMQ的导入及使用" class="headerlink" title="1. RabbitMQ的导入及使用"></a>1. RabbitMQ的导入及使用</h2><p>RabbitMQ是基于Erlang语言开发的开源消息通信中间件，官网地址：<a target="_blank" rel="noopener" href="http://www.rabbitmq.com/">http://www.rabbitmq.com/</a></p>
<p>我们同样基于Docker来安装RabbitMQ，使用下面的命令即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> -e RABBITMQ_DEFAULT_USER=itheima \</span><br><span class="line"> -e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class="line"> -v mq-plugins:/plugins \</span><br><span class="line"> --name mq \</span><br><span class="line"> --hostname mq \</span><br><span class="line"> -p 15672:15672 \</span><br><span class="line"> -p 5672:5672 \</span><br><span class="line"> --network hm-net\</span><br><span class="line"> -d \</span><br><span class="line"> rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>

<p>如果拉取镜像困难的话，可以使用课前资料给大家准备的镜像，利用docker load命令加载：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240311143611065.png" alt="image-20240311143611065"></p>
<p>可以看到在安装命令中有两个映射的端口：</p>
<ul>
<li>15672：RabbitMQ提供的管理控制台的端口</li>
<li>5672：RabbitMQ的消息发送处理接口</li>
</ul>
<p>安装完成后，我们访问 <a href="http://192.168.226.129:15672即可看到管理控制台。首次访问需要登录，默认的用户名和密码在配置文件中已经指定了。">http://192.168.226.129:15672即可看到管理控制台。首次访问需要登录，默认的用户名和密码在配置文件中已经指定了。</a></p>
<p><strong>步骤一：引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤二：配置RabbitMQ服务端消息</strong></p>
<p>在每个微服务中引入MQ服务端信息，这样微服务才能链接到RabbitMQ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.226</span><span class="number">.129</span> <span class="comment"># 你的虚拟机IP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240311160430629.png" alt="image-20240311160430629"></p>
<p><strong>步骤三：配置RabbitMQ服务端消息</strong></p>
<p>在每个微服务中引入MQ服务端信息，这样微服务才能链接到RabbitMQ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.226</span><span class="number">.129</span> <span class="comment"># 你的虚拟机IP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤四：发送消息</strong></p>
<p>SpringAMQP提供了RabbitTemplate工具类，方便我们发送消息。发送消息代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.publisher.amqp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAmqpTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSimpleQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 队列名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">        <span class="comment">// 消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, spring amqp!&quot;</span>;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤五：接收消息</strong></p>
<p>SpringAMQP提供了声明式的消息监听，我们只需要通过注解在方法上声明要监听的队列名称，将来SpringAMQP就会把消息传递给当前方法：</p>
<p>然后在<code>consumer</code>服务的<code>com.itheima.consumer.listener</code>包中新建一个类<code>SpringRabbitListener</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringRabbitListener</span> &#123;</span><br><span class="line">        <span class="comment">// 利用RabbitListener来声明要监听的队列信息</span></span><br><span class="line">    <span class="comment">// 将来一旦监听的队列中有了消息，就会推送给当前服务，调用当前方法，处理消息。</span></span><br><span class="line">    <span class="comment">// 可以看到方法体中接收的就是消息体的内容</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;spring 消费者接收到消息：【&quot;</span> + msg + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤六：引入依赖，数据序列化和反序列化</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置消息转换器，在<code>publisher</code>和<code>consumer</code>两个服务的启动类中添加一个Bean即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jackson2JsonMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jackson2JsonMessageConverter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jackson2JsonMessageConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-RabbitMQ的案例使用"><a href="#1-1-RabbitMQ的案例使用" class="headerlink" title="1.1 RabbitMQ的案例使用"></a>1.1 RabbitMQ的案例使用</h3><p><strong>总结：接收消息可以在微服务模块单独定义一个包listener来实现，在listener中编写交换机、队列和接收细节。发送消息则是在对应service层引入private final RabbitTemplate rabbitTemplate;，再调用其方法rabbitTemplate.convertAndSend(“pay.direct”, “pay.success”, po.getBizOrderNo());即可。</strong></p>
<p><strong>接收消息</strong></p>
<p>在trade-service服务中定义一个消息监听类：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240330235112678.png" alt="image-20240330235112678"></p>
<p>其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.trade.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ExchangeTypes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayStatusListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = &quot;trade.pay.success.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = &quot;pay.topic&quot;),</span></span><br><span class="line"><span class="meta">            key = &quot;pay.success&quot;</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenPaySuccess</span><span class="params">(Long orderId)</span>&#123;</span><br><span class="line">        orderService.markOrderPaySuccess(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>PayStatusListener</strong></p>
<ul>
<li><code>PayStatusListener</code>类定义了一个消息监听器，用于处理支付成功的消息。</li>
</ul>
<p><strong>@RabbitListener</strong></p>
<ul>
<li><p><code>@RabbitListener</code>注解标记一个方法作为RabbitMQ的消息监听方法，当消息到达时自动触发这个方法的执行。</p>
</li>
<li><p><code>bindings = @QueueBinding</code>  指定了消息队列、交换机和路由键的绑定信息：</p>
<ul>
<li><code>@Queue(name = &quot;mark.order.pay.queue&quot;, durable = &quot;true&quot;)</code>定义了一个队列，队列名称为<code>mark.order.pay.queue</code>，并且是持久化的，意味着即使RabbitMQ重启，这个队列也不会丢失。</li>
<li><code>@Exchange(name = &quot;pay.topic&quot;, type = ExchangeTypes.TOPIC)</code>定义了一个交换机，交换机名称为<code>pay.topic</code>，类型为<code>TOPIC</code>，表示消息会根据路由键的模式匹配被路由到不同的队列。</li>
<li><code>key = &quot;pay.success&quot;</code>指定了路由键为<code>pay.success</code>，意味着所有routing key匹配<code>pay.success</code>的消息都会被路由到<code>mark.order.pay.queue</code>队列。</li>
</ul>
</li>
</ul>
<p><strong>发送消息</strong></p>
<p>修改<code>pay-service</code>服务下的<code>com.hmall.pay.service.impl.PayOrderServiceImpl</code>类中的<code>tryPayOrderByBalance</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPayOrderByBalance</span><span class="params">(PayOrderDTO payOrderDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询支付单</span></span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">po</span> <span class="operator">=</span> getById(payOrderDTO.getId());</span><br><span class="line">    <span class="comment">// 2.判断状态</span></span><br><span class="line">    <span class="keyword">if</span>(!PayStatus.WAIT_BUYER_PAY.equalsValue(po.getStatus()))&#123;</span><br><span class="line">        <span class="comment">// 订单不是未支付，状态异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;交易已支付或关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.尝试扣减余额</span></span><br><span class="line">    userClient.deductMoney(payOrderDTO.getPw(), po.getAmount());</span><br><span class="line">    <span class="comment">// 4.修改支付单状态</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> markPayOrderSuccess(payOrderDTO.getId(), LocalDateTime.now());</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(<span class="string">&quot;交易已支付或关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.修改订单状态</span></span><br><span class="line">    <span class="comment">// tradeClient.markOrderPaySuccess(po.getBizOrderNo());</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;pay.direct&quot;</span>, <span class="string">&quot;pay.success&quot;</span>, po.getBizOrderNo());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;支付成功的消息发送失败，支付单id：&#123;&#125;， 交易单id：&#123;&#125;&quot;</span>, po.getId(), po.getBizOrderNo(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="day05"><a href="#day05" class="headerlink" title="day05"></a>day05</h1><h2 id="1-RabbitMQ的发送者可靠性"><a href="#1-RabbitMQ的发送者可靠性" class="headerlink" title="1. RabbitMQ的发送者可靠性"></a>1. RabbitMQ的发送者可靠性</h2><p><strong>总结: 解决发送者和MQ连接超时问；解决发送者和MQ连接操作结果确认问题</strong></p>
<p><strong>超时重连机制</strong></p>
<p>先第一种情况，就是生产者发送消息时，出现了网络故障，导致与MQ的连接中断。</p>
<p>为了解决这个问题，SpringAMQP提供的消息发送时的重试机制。即：当<code>RabbitTemplate</code>与MQ连接超时后，多次重试。</p>
<p>修改<strong>发送消息微服务</strong>的<code>application.yaml</code>文件，添加下面的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span> <span class="comment"># 设置MQ的连接超时时间</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启超时重试机制</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 失败后的初始等待时间</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br></pre></td></tr></table></figure>





<p><strong>投递成功确认机制</strong></p>
<ol>
<li>开启生产者确认</li>
</ol>
<p>在<strong>发送消息微服务</strong>的<code>application.yaml</code>中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># 开启publisher confirm机制，并设置confirm类型</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 开启publisher return机制</span></span><br></pre></td></tr></table></figure>

<p>这里<code>publisher-confirm-type</code>有三种模式可选：</p>
<ul>
<li><code>none</code>：关闭confirm机制</li>
<li><code>simple</code>：同步阻塞等待MQ的回执</li>
<li><code>correlated</code>：MQ异步回调返回回执</li>
</ul>
<p>一般我们推荐使用<code>correlated</code>，回调机制。</p>
<ol start="2">
<li>定义ReturnCallback</li>
</ol>
<p>每个<code>RabbitTemplate</code>只能配置一个<code>ReturnCallback</code>，因此我们可以在配置类中统一设置。我们在publisher模块定义一个配置类：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331124121859.png" alt="image-20240331124121859"></p>
<p>内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.publisher.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;触发return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>在<strong>发送消息微服务</strong>中定义confirmCallBack，即在使用convertAndSend方法时要额外增加CorrelationData对象cd。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建CorrelationData</span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>();</span><br><span class="line">    <span class="comment">// 2.给Future添加ConfirmCallback</span></span><br><span class="line">    cd.getFuture().addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.1.Future发生异常时的处理逻辑，基本不会触发</span></span><br><span class="line">            log.error(<span class="string">&quot;send message fail&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(CorrelationData.Confirm result)</span> &#123;</span><br><span class="line">            <span class="comment">// 2.2.Future接收到回执的处理逻辑，参数中的result就是回执内容</span></span><br><span class="line">            <span class="keyword">if</span>(result.isAck())&#123; <span class="comment">// result.isAck()，boolean类型，true代表ack回执，false 代表 nack回执</span></span><br><span class="line">                log.debug(<span class="string">&quot;发送消息成功，收到 ack!&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123; <span class="comment">// result.getReason()，String类型，返回nack时的异常描述</span></span><br><span class="line">                log.error(<span class="string">&quot;发送消息失败，收到 nack, reason : &#123;&#125;&quot;</span>, result.getReason());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 3.发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;hmall.direct&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;hello&quot;</span>, cd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-RabbitMQ的MQ可靠性"><a href="#2-RabbitMQ的MQ可靠性" class="headerlink" title="2. RabbitMQ的MQ可靠性"></a>2. RabbitMQ的MQ可靠性</h2><p><strong>总结：解决MQ的消息持久化问题</strong></p>
<p><strong>数据持久化</strong></p>
<p>MQ早期，3.6版本之前的技术。</p>
<p>RabbitMQ实现数据持久化包括三个方面：</p>
<ul>
<li><p>交换机持久化</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312140018619.png" alt="image-20240312140018619"></p>
</li>
<li><p>队列持久化</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312140131208.png" alt="image-20240312140131208"></p>
</li>
<li><p>消息持久化</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312140220907.png" alt="image-20240312140220907"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPageOut</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> MessageBuilder</span><br><span class="line">        .withBody(<span class="string">&quot;hello&quot;</span>.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">        .setDeliveryMode(MessageDeliveryMode.PERSISTENT).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;simple.queue&quot;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Lazy Queue</strong></p>
<p>3.6版本之后的技术。也就是惰性队列。</p>
<p>惰性队列的特征如下：</p>
<ul>
<li>接收到消息后直接存入磁盘而非内存（内存只保留最近的消息，默认2048条）</li>
<li>消费者要消费消息时才会从磁盘中读取并加载到内存</li>
<li>支持数百万条的消息存储</li>
</ul>
<p>在3.12版本后，所有队列都是Lazy Queue模式，无法更改。</p>
<p>要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312142539723.png" alt="image-20240312142539723"></p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312142856713.png" alt="image-20240312142856713"></p>
<h2 id="3-RabbitMQ的消费者可靠性"><a href="#3-RabbitMQ的消费者可靠性" class="headerlink" title="3. RabbitMQ的消费者可靠性"></a>3. RabbitMQ的消费者可靠性</h2><p><strong>总结：解决MQ消费者消息确认问题；解决MQ消费者消息处理失败问题；</strong></p>
<p>为了确认消费者是否成功处理消息，RabbitMQ提供了消费者确认机制（<strong>Consumer Acknowledgement</strong>）。即：当消费者处理消息结束后，应该向RabbitMQ发送一个回执，告知RabbitMQ自己消息处理状态。回执有三种可选值：</p>
<ul>
<li>ack：成功处理消息，RabbitMQ从队列中删除该消息</li>
<li>nack：消息处理失败，RabbitMQ需要再次投递消息</li>
<li>reject：消息处理失败并拒绝该消息，RabbitMQ从队列中删除该消息</li>
</ul>
<p>一般reject方式用的较少，除非是消息格式有问题，那就是开发问题了。因此大多数情况下我们需要将消息处理的代码通过<code>try catch</code>机制捕获，消息处理成功时返回ack，处理失败时返回nack.</p>
<p>由于消息回执的处理代码比较统一，因此SpringAMQP帮我们实现了消息确认。并允许我们通过配置文件设置ACK处理方式，有三种模式：</p>
<ul>
<li>**<code>none</code>**：不处理。即消息投递给消费者后立刻ack，消息会立刻从MQ删除。非常不安全，不建议使用</li>
<li>**<code>manual</code>**：手动模式。需要自己在业务代码中调用api，发送<code>ack</code>或<code>reject</code>，存在业务入侵，但更灵活</li>
<li>**<code>auto</code>**：自动模式。SpringAMQP利用AOP对我们的消息处理逻辑做了环绕增强，当业务正常执行时则自动返回<code>ack</code>.  当业务出现异常时，根据异常判断返回不同结果：<ul>
<li>如果是<strong>业务异常</strong>，会自动返回<code>nack</code>；</li>
<li>如果是<strong>消息处理或校验异常</strong>，自动返回<code>reject</code>;</li>
</ul>
</li>
</ul>
<p><strong>消费者确认机制</strong></p>
<p>通过修改消费者微服务下面的配置可以修改SpringAMQP的ACK处理方式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="string">|</span> <span class="string">manual</span> <span class="string">|</span> <span class="string">auto</span> <span class="comment"># 不做处理</span></span><br></pre></td></tr></table></figure>





<p><strong>消费者失败重试机制</strong></p>
<p>当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者。如果消费者再次执行依然出错，消息会再次requeue到队列，再次投递，直到消息处理成功为止。</p>
<p>极端情况就是消费者一直无法执行成功，那么消息requeue就会无限循环，导致mq的消息处理飙升，带来不必要的压力。为了应对上述情况Spring又提供了消费者失败重试机制：在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 初识的失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment"># true无状态；false有状态。如果业务中包含事务，这里改为false</span></span><br></pre></td></tr></table></figure>

<p>重启consumer服务，重复之前的测试。可以发现：</p>
<ul>
<li>消费者在失败后消息没有重新回到MQ无限重新投递，而是在本地重试了3次</li>
<li>本地重试3次以后，抛出了<code>AmqpRejectAndDontRequeueException</code>异常。查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是<code>reject</code></li>
</ul>
<p><strong>消费者失败处理策略</strong></p>
<p>在之前的测试中，本地测试达到最大重试次数后，消息会被丢弃。这在某些对于消息可靠性要求较高的业务场景下，显然不太合适了。</p>
<p>因此Spring允许我们自定义重试次数耗尽后的消息处理策略，这个策略是由<code>MessageRecovery</code>接口来定义的，它有3个不同实现：</p>
<ul>
<li><code>RejectAndDontRequeueRecoverer</code>：重试耗尽后，直接<code>reject</code>，丢弃消息。默认就是这种方式 </li>
<li><code>ImmediateRequeueMessageRecoverer</code>：重试耗尽后，返回<code>nack</code>，消息重新入队 </li>
<li><code>RepublishMessageRecoverer</code>：重试耗尽后，将失败消息投递到指定的交换机</li>
</ul>
<p>比较优雅的一种处理方案是<code>RepublishMessageRecoverer</code>，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。</p>
<p>1）在consumer服务中定义处理失败消息的交换机和队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）定义一个RepublishMessageRecoverer，关联队列和交换机</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.retry.MessageRecoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorMessageConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">errorMessageExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;error.direct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">errorQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;error.queue&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">errorBinding</span><span class="params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageRecoverer <span class="title function_">republishMessageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="string">&quot;error.direct&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-RabbitMQ的业务幂等性原理"><a href="#4-RabbitMQ的业务幂等性原理" class="headerlink" title="4. RabbitMQ的业务幂等性原理"></a>4. RabbitMQ的业务幂等性原理</h2><p><strong>总结：重复操作可能会出现业务执行结果出错，因此要通过唯一消息ID或者业务逻辑判断来解决这个问题。推荐使用业务逻辑，通过数据库字段判断业务状态是否发生变化，且推荐在数据库操作中判断，而不是在代码中判断。</strong></p>
<p>何为幂等性？</p>
<p><strong>幂等</strong>是一个数学概念，用函数表达式来描述是这样的：<code>f(x) = f(f(x))</code>，例如求绝对值函数。</p>
<p>在程序开发中，则是指同一个业务，执行一次或多次对业务状态的影响是一致的。例如：</p>
<ul>
<li>根据id删除数据</li>
<li>查询数据</li>
<li>新增数据</li>
</ul>
<p>但数据的更新往往不是幂等的，如果重复执行可能造成不一样的后果。比如：</p>
<ul>
<li>取消订单，恢复库存的业务。如果多次恢复就会出现库存重复增加的情况</li>
<li>退款业务。重复退款对商家而言会有经济损失。</li>
</ul>
<p>所以，我们要尽可能避免业务被重复执行。</p>
<p>然而在实际业务场景中，由于意外经常会出现业务被重复执行的情况，例如：</p>
<ul>
<li>页面卡顿时频繁刷新导致表单重复提交</li>
<li>服务间调用的重试</li>
<li>MQ消息的重复投递</li>
</ul>
<p>我们在用户支付成功后会发送MQ消息到交易服务，修改订单状态为已支付，就可能出现消息重复投递的情况。如果消费者不做判断，很有可能导致消息被消费多次，出现业务故障。</p>
<p>举例：</p>
<ol>
<li>假如用户刚刚支付完成，并且投递消息到交易服务，交易服务更改订单为<strong>已支付</strong>状态。</li>
<li>由于某种原因，例如网络故障导致生产者没有得到确认，隔了一段时间后<strong>重新投递</strong>给交易服务。</li>
<li>但是，在新投递的消息被消费之前，用户选择了退款，将订单状态改为了<strong>已退款</strong>状态。</li>
<li>退款完成后，新投递的消息才被消费，那么订单状态会被再次改为<strong>已支付</strong>。业务异常。</li>
</ol>
<p>因此，我们必须想办法保证消息处理的幂等性。这里给出两种方案：</p>
<ul>
<li>唯一消息ID</li>
<li>业务状态判断</li>
</ul>
<p><strong>唯一消息ID</strong></p>
<p>这个思路非常简单：</p>
<ol>
<li>每一条消息都生成一个唯一的id，与消息一起投递给消费者。</li>
<li>消费者接收到消息后处理自己的业务，业务处理成功后将消息ID保存到数据库</li>
<li>如果下次又收到相同消息，去数据库查询判断是否存在，存在则为重复消息放弃处理。</li>
</ol>
<p>我们该如何给消息添加唯一ID呢？</p>
<p>其实很简单，SpringAMQP的MessageConverter自带了MessageID的功能，我们只要开启这个功能即可。</p>
<p>以Jackson的消息转换器为例：<strong>只要将类注册到消费者微服务的启动类即可</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">    <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jjmc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    <span class="comment">// 2.配置自动创建消息id，用于识别不同消息，也可以在业务中基于ID判断是否是重复消息</span></span><br><span class="line">    jjmc.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jjmc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331130651650.png" alt="image-20240331130651650"></p>
<p><strong>业务判断</strong></p>
<p>业务判断就是基于业务本身的逻辑或状态来判断是否是重复的请求或消息，不同的业务场景判断的思路也不一样。</p>
<p>例如我们当前案例中，处理消息的业务逻辑是把订单状态从未支付修改为已支付。因此我们就可以在执行业务时判断订单状态是否是未支付，如果不是则证明订单已经被处理过，无需重复处理。</p>
<p>相比较而言，消息ID的方案需要改造原有的数据库，所以我更推荐使用业务判断的方案。</p>
<p>以支付修改订单的业务为例，我们需要修改<code>OrderServiceImpl</code>中的<code>markOrderPaySuccess</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.查询订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">old</span> <span class="operator">=</span> getById(orderId);</span><br><span class="line">    <span class="comment">// 2.判断订单状态</span></span><br><span class="line">    <span class="keyword">if</span> (old == <span class="literal">null</span> || old.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 订单不存在或者订单状态不是1，放弃处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.尝试更新订单</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setStatus(<span class="number">2</span>);</span><br><span class="line">    order.setPayTime(LocalDateTime.now());</span><br><span class="line">    updateById(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码逻辑上符合了幂等判断的需求，但是由于判断和更新是两步动作，因此在极小概率下可能存在线程安全问题。</p>
<p>我们可以合并上述操作为这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">markOrderPaySuccess</span><span class="params">(Long orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// UPDATE `order` SET status = ? , pay_time = ? WHERE id = ? AND status = 1</span></span><br><span class="line">    lambdaUpdate()</span><br><span class="line">            .set(Order::getStatus, <span class="number">2</span>)</span><br><span class="line">            .set(Order::getPayTime, LocalDateTime.now())</span><br><span class="line">            .eq(Order::getId, orderId)</span><br><span class="line">            .eq(Order::getStatus, <span class="number">1</span>)</span><br><span class="line">            .update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意看，上述代码等同于这样的SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> `<span class="keyword">order</span>` <span class="keyword">SET</span> status <span class="operator">=</span> ? , pay_time <span class="operator">=</span> ? <span class="keyword">WHERE</span> id <span class="operator">=</span> ? <span class="keyword">AND</span> status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>我们在where条件中除了判断id以外，还加上了status必须为1的条件。如果条件不符（说明订单已支付），则SQL匹配不到数据，根本不会执行。</p>
<h2 id="5-延迟任务的实现"><a href="#5-延迟任务的实现" class="headerlink" title="5. 延迟任务的实现"></a>5. 延迟任务的实现</h2><p>在电商的支付业务中，对于一些库存有限的商品，为了更好的用户体验，通常都会在用户下单时立刻扣减商品库存。例如电影院购票、高铁购票，下单后就会锁定座位资源，其他人无法重复购买。</p>
<p>但是这样就存在一个问题，假如用户下单后一直不付款，就会一直占有库存资源，导致其他客户无法正常交易，最终导致商户利益受损！</p>
<p>因此，电商中通常的做法就是：<strong>对于超过一定时间未支付的订单，应该立刻取消订单并释放占用的库存</strong>。</p>
<p>例如，订单支付超时时间为30分钟，则我们应该在用户下单后的第30分钟检查订单支付状态，如果发现未支付，应该立刻取消订单，释放库存。</p>
<p>但问题来了：如何才能准确的实现在下单后第30分钟去检查支付状态呢？</p>
<p>像这种在一段时间以后才执行的任务，我们称之为<strong>延迟任务</strong>，而要实现延迟任务，最简单的方案就是利用MQ的延迟消息了。</p>
<p>在RabbitMQ中实现延迟消息也有两种方案：</p>
<ul>
<li>死信交换机+TTL</li>
<li>延迟消息插件</li>
</ul>
<p>死信交换机缺点：设置的死信交换机和队列太多，管理复杂，麻烦。</p>
<p>且它本来不是用来做这个操作的。</p>
<p>RabbitMQ的官方也推出了一个插件，原生支持延迟消息功能。该插件的原理是设计了一种支持延迟消息功能的交换机，当消息投递到交换机后可以暂存一段时间，到期后再投递到队列。</p>
<p><strong>步骤一：安装插件</strong></p>
<p>插件下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></p>
<p>由于我们安装的MQ是<code>3.8</code>版本，因此这里下载<code>3.8.17</code>版本：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312163855601.png" alt="image-20240312163855601"></p>
<p>当然，也可以直接使用课前资料提供好的插件：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312163930621.png" alt="image-20240312163930621"></p>
<p>因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect mq-plugins</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;CreatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-06-19T09:22:59+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Mountpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/mq-plugins/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mq-plugins&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>插件目录被挂载到了<code>/var/lib/docker/volumes/mq-plugins/_data</code>这个目录，我们上传插件到该目录下。</p>
<p>接下来执行命令，安装插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240312164153404.png" alt="image-20240312164153404"></p>
<p><strong>步骤二：声明延迟交换机</strong></p>
<p>基于注解方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = &quot;delay&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到delay.queue的延迟消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于<code>@Bean</code>的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayExchangeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder</span><br><span class="line">                .directExchange(<span class="string">&quot;delay.direct&quot;</span>) <span class="comment">// 指定交换机类型和名称</span></span><br><span class="line">                .delayed() <span class="comment">// 设置delay的属性为true</span></span><br><span class="line">                .durable(<span class="literal">true</span>) <span class="comment">// 持久化</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayQueueBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayedQueue()).to(delayExchange()).with(<span class="string">&quot;delay&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>步骤三：发送延迟消息</strong></p>
<p>发送消息时，必须通过x-delay属性设定延迟时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherDelayMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, delayed message&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.发送消息，利用消息后置处理器添加消息头</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;delay.direct&quot;</span>, <span class="string">&quot;delay&quot;</span>, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">// 添加延迟消息属性</span></span><br><span class="line">            message.getMessageProperties().setDelay(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>案例：改造下单业务，发送延迟消息</strong></p>
<p><strong>步骤一：定义常量</strong></p>
<p>无论是消息发送还是接收都是在交易服务完成，因此我们在<code>trade-service</code>中定义一个常量类，用于记录交换机、队列、RoutingKey等常量：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331132520458.png" alt="image-20240331132520458"></p>
<p>内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.constants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MQConstants</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.direct&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.order.queue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_KEY</span> <span class="operator">=</span> <span class="string">&quot;delay.order.query&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤二：配置MQ</strong></p>
<p>在<code>trade-service</code>模块的<code>pom.xml</code>中引入amqp的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--amqp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>trade-service</code>的<code>application.yaml</code>中添加MQ的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.150</span><span class="number">.101</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure>

<p><strong>步骤三：改造下单业务，发送延迟消息</strong></p>
<p>接下来，我们改造下单业务，在下单完成后，发送延迟消息，查询支付状态。</p>
<p>修改<code>trade-service</code>模块的<code>com.hmall.trade.service.impl.OrderServiceImpl</code>类的<code>createOrder</code>方法，添加消息发送的代码：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331132623040.png" alt="image-20240331132623040"></p>
<p>这里延迟消息的时间应该是15分钟，不过我们为了测试方便，改成10秒。</p>
<p><strong>步骤四：编写查询支付状态接口</strong></p>
<p>由于MQ消息处理时需要查询支付状态，因此我们要在<code>pay-service</code>模块定义一个这样的接口，并提供对应的<code>FeignClient</code>.</p>
<p>首先，在<code>hm-api</code>模块定义三个类：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331132851753.png" alt="image-20240331132851753"></p>
<p>说明：</p>
<ul>
<li>PayOrderDTO：支付单的数据传输实体</li>
<li>PayClient：支付系统的Feign客户端</li>
<li>PayClientFallback：支付系统的fallback逻辑</li>
</ul>
<p><code>PayOrderDTO</code>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.api.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 支付订单</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;支付单数据传输实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayOrderDTO</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;业务订单号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bizOrderNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付单号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long payOrderNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付用户id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bizUserId;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付渠道编码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String payChannelCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付金额，单位分&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer amount;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;付类型，1：h5,2:小程序，3：公众号，4：扫码，5：余额支付&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer payType;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;付状态，0：待提交，1:待支付，2：支付超时或取消，3：支付成功&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;拓展字段，用于传递不同渠道单独处理的字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String expandJson;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;第三方返回业务码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String resultCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;第三方返回提示信息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String resultMsg;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付成功时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime paySuccessTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付超时时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime payOverTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付二维码链接&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String qrCodeUrl;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;创建时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;更新时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PayClient</code>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.api.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.api.client.fallback.PayClientFallback;</span><br><span class="line"><span class="keyword">import</span> com.hmall.api.dto.PayOrderDTO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;pay-service&quot;, fallbackFactory = PayClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PayClient</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据交易订单id查询支付单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 业务订单id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付单信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/pay-orders/biz/&#123;id&#125;&quot;)</span></span><br><span class="line">    PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PayClientFallback</code>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.api.client.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.api.client.PayClient;</span><br><span class="line"><span class="keyword">import</span> com.hmall.api.dto.PayOrderDTO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FallbackFactory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayClientFallback</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;PayClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PayClient <span class="title function_">create</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PayClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，在<code>pay-service</code>模块的<code>PayController</code>中实现该接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据id查询支付单&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/biz/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">payOrder</span> <span class="operator">=</span> payOrderService.lambdaQuery().eq(PayOrder::getBizOrderNo, id).one();</span><br><span class="line">    <span class="keyword">return</span> BeanUtils.copyBean(payOrder, PayOrderDTO.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤五：监听消息，查询支付状态</strong></p>
<p>接下来，我们在<code>trader-service</code>编写一个监听器，监听延迟消息，查询订单支付状态：</p>
<p><img src="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240331132935876.png" alt="image-20240331132935876"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.api.client.PayClient;</span><br><span class="line"><span class="keyword">import</span> com.hmall.api.dto.PayOrderDTO;</span><br><span class="line"><span class="keyword">import</span> com.hmall.trade.constants.MQConstants;</span><br><span class="line"><span class="keyword">import</span> com.hmall.trade.domain.po.Order;</span><br><span class="line"><span class="keyword">import</span> com.hmall.trade.service.IOrderService;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDelayMessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOrderService orderService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PayClient payClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(name = MQConstants.DELAY_ORDER_QUEUE_NAME),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(name = MQConstants.DELAY_EXCHANGE_NAME, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            key = MQConstants.DELAY_ORDER_KEY</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenOrderDelayMessage</span><span class="params">(Long orderId)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.查询订单</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">        <span class="comment">// 2.检测订单状态，判断是否已支付</span></span><br><span class="line">        <span class="keyword">if</span>(order == <span class="literal">null</span> || order.getStatus() != <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">// 订单不存在或者已经支付</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.未支付，需要查询支付流水状态</span></span><br><span class="line">        <span class="type">PayOrderDTO</span> <span class="variable">payOrder</span> <span class="operator">=</span> payClient.queryPayOrderByBizOrderNo(orderId);</span><br><span class="line">        <span class="comment">// 4.判断是否支付</span></span><br><span class="line">        <span class="keyword">if</span>(payOrder != <span class="literal">null</span> &amp;&amp; payOrder.getStatus() == <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">// 4.1.已支付，标记订单状态为已支付</span></span><br><span class="line">            orderService.markOrderPaySuccess(orderId);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// TODO 4.2.未支付，取消订单，回复库存</span></span><br><span class="line">            orderService.cancelOrder(orderId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，这里要在OrderServiceImpl中实现cancelOrder方法，留作作业大家自行实现。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" itemprop="url">苍穹外卖技术总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-27T15:43:10+08:00">
                2024-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/" itemprop="url" rel="index">
                    <span itemprop="name">苍穹外卖</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  9.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  48
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240327170256831.png" alt="image-20240327170256831"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240327170248149.png" alt="image-20240327170248149"></p>
<h1 id="day01"><a href="#day01" class="headerlink" title="day01"></a>day01</h1><h2 id="1-明文密码加密"><a href="#1-明文密码加密" class="headerlink" title="1. 明文密码加密"></a>1. 明文密码加密</h2><ol>
<li><p>将密码加密之后存储，提高安全性</p>
</li>
<li><p>使用MD5 加密方式对明文密码加密</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240220235218252.png" alt="image-20240220235218252"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240220235408563.png" alt="image-20240220235408563"></p>
</li>
</ol>
<p>实现步骤</p>
<ol>
<li><p>修改数据库中明文密码，改为MD5加密后的密文</p>
</li>
<li><p>修改Java代码，前端提交的代码进行MD5加密后再跟数据库中密码对比</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240220235547628.png" alt="image-20240220235547628"></p>
</li>
</ol>
<h2 id="2-接口文档导入"><a href="#2-接口文档导入" class="headerlink" title="2. 接口文档导入"></a>2. 接口文档导入</h2><p>前面完成了开发环境的搭建，后面要导入接口文档，开发方式是基于前后端分离的开发方式，要求开发之前，先将接口定义好，然后呢，前后端开发人员才能并行开发。我们需要将项目的接口导入到接口管理平台，为业务开发做好准备。</p>
<p>接口是开发过程中前后端多次开会决定的，且会不断地改进。</p>
<p><strong>前后端分离开发流程</strong></p>
<p>前后端分离开发流程：</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221002030439.png" alt="image-20240221002030439"></p>
<p><strong>操作步骤</strong></p>
<p>将课程资料中提供的项目接口导入YApi。</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221002137198.png" alt="image-20240221002137198"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221002354144.png" alt="image-20240221002354144"></p>
<p>导入对应的管理端JSON文件</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221002444885.png" alt="image-20240221002444885"></p>
<p>查看接口内容</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221002651360.png" alt="image-20240221002651360"></p>
<p>同理上传完客户端接口</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221002807634.png" alt="image-20240221002807634"></p>
<h2 id="3-Swagger的导入及使用-方法一"><a href="#3-Swagger的导入及使用-方法一" class="headerlink" title="3. Swagger的导入及使用(方法一)"></a>3. Swagger的导入及使用(方法一)</h2><p>使用Swagger只需要按照它的规范去定义接口及接口相关的信息，就可以做到<strong>生成接口文档</strong>，以及<strong>在线接口调试页面</strong>。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://swagger.io/">https://swagger.io/</a></p>
<p>Knife4j是为Java MVC框架集成Swagger生成APi文档的增强解决方案。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>导入knife4j的maven坐标</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221114507874.png" alt="image-20240221114507874"></p>
</li>
<li><p>在配置类中加入knife4j的相关配置</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221114520003.png" alt="image-20240221114520003"></p>
</li>
<li><p>设置静态资源映射，否则接口文档页面无法访问</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221115134316.png" alt="image-20240221115134316"></p>
</li>
</ol>
<p>完整代码(WebMvcConfiguration加了@Configuration，是配置类，且继承自WebMvcConfigurationSupport)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，注册web层相关组件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过knife4j生成接口文档</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">docket</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;准备生成接口文档...&quot;</span>);</span><br><span class="line">        <span class="type">ApiInfo</span> <span class="variable">apiInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;苍穹外卖项目接口文档&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;2.0&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;苍穹外卖项目接口文档&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Docket</span> <span class="variable">docket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.sky.controller&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> docket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置静态资源映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始设置静态资源映射...&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/doc.html&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/webjars/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>常用注解</strong></p>
<p>通过注解可以控制生成的接口文档，使接口文档拥有更好的可读性，常用注解如下：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Api</td>
<td>用在类上，例如Controller，表示对类的说明</td>
</tr>
<tr>
<td>@ApiModel</td>
<td>用在类上，例如entity、DTO、VO，表示对用途的说明</td>
</tr>
<tr>
<td>@ApiModelProperty</td>
<td>用在属性上，描述属性信息</td>
</tr>
<tr>
<td>@ApiOperation</td>
<td>用在方法上，例如Controller的方法，说明方法的用途、作用</td>
</tr>
</tbody></table>
<p>例如</p>
<ul>
<li>@Api(tags &#x3D; “员工相关接口”)</li>
<li>@ApiOperation(value &#x3D; “员工登录”)</li>
<li>@ApiModel(description &#x3D; “员工登录返回的数据格式”)</li>
<li>@ApiModelProperty(“用户名”)</li>
</ul>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221122024885.png" alt="image-20240221122024885"></p>
<h1 id="day02"><a href="#day02" class="headerlink" title="day02"></a>day02</h1><h2 id="1-实现全局异常处理器"><a href="#1-实现全局异常处理器" class="headerlink" title="1. 实现全局异常处理器"></a>1. 实现全局异常处理器</h2><p>程序存在的问题：</p>
<ul>
<li><p>录入的用户名已经存在，抛出异常后没有处理</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221135055314.png" alt="image-20240221135055314"></p>
<p>解决办法：</p>
<ol>
<li><strong>观察系统抛出的异常类型</strong></li>
<li><strong>创建全局异常处理器类（@RestControllerAdvice）</strong></li>
<li><strong>在异常处理器中创建Result exceptionHandler方法，形参为该异常类对象，捕获该异常类型，编写相应方法</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.BaseException;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.SQLIntegrityConstraintViolationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局异常处理器，处理项目中抛出的业务异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理SQL异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span><span class="params">(SQLIntegrityConstraintViolationException ex)</span>&#123;</span><br><span class="line"><span class="comment">//        Duplicate entry &#x27;zhangsan&#x27; for key &#x27;employee.idx_username&#x27;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span>(message.contains(<span class="string">&quot;Duplicate entry&quot;</span>))&#123;</span><br><span class="line">            String[] split = message.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> split[<span class="number">2</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> username + MessageConstant.ALREADY_EXISTS;</span><br><span class="line">            <span class="keyword">return</span> Result.error(msg);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(MessageConstant.UNKNOWN_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-实现JWT登录校验"><a href="#2-实现JWT登录校验" class="headerlink" title="2. 实现JWT登录校验"></a>2. 实现JWT登录校验</h2><p>通过实现HandlerInterceptor创建JwtTokenAdminInterceptor拦截器。拦截器，在拦截器的prehandler方法中编写拦截操作。同时将本次操作的<strong>用户id（不是线程id，别搞混了）</strong>保存到threadlocal中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jwt令牌校验的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenAdminInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验jwt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;当前线程的id:&quot;</span> + Thread.currentThread().getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前拦截到的是Controller的方法还是其他资源</span></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            <span class="comment">//当前拦截到的不是动态方法，直接放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、从请求头中获取令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getAdminTokenName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、校验令牌</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;jwt校验:&#123;&#125;&quot;</span>, token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">empId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());</span><br><span class="line">            log.info(<span class="string">&quot;当前员工id：&quot;</span>, empId);</span><br><span class="line">            BaseContext.setCurrentId(empId);</span><br><span class="line">            <span class="comment">//3、通过，放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">//4、不通过，响应401状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>JwtProperties配置属性类（保存用户密钥信息）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;sky.jwt&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 管理端员工生成jwt令牌相关配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String adminSecretKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> adminTtl;</span><br><span class="line">    <span class="keyword">private</span> String adminTokenName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户端微信用户生成jwt令牌相关配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String userSecretKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> userTtl;</span><br><span class="line">    <span class="keyword">private</span> String userTokenName;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JwtUtil类（生成密钥和验证密钥）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtBuilder;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成jwt</span></span><br><span class="line"><span class="comment">     * 使用Hs256算法, 私匙使用固定秘钥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secretKey jwt秘钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis jwt过期时间(毫秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> claims    设置的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJWT</span><span class="params">(String secretKey, <span class="type">long</span> ttlMillis, Map&lt;String, Object&gt; claims)</span> &#123;</span><br><span class="line">        <span class="comment">// 指定签名的时候使用的签名算法，也就是header那部分</span></span><br><span class="line">        <span class="type">SignatureAlgorithm</span> <span class="variable">signatureAlgorithm</span> <span class="operator">=</span> SignatureAlgorithm.HS256;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成JWT的时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> System.currentTimeMillis() + ttlMillis;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置jwt的body</span></span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                <span class="comment">// 如果有私有声明，一定要先设置这个自己创建的私有的声明，这个是给builder的claim赋值，一旦写在标准的声明赋值之后，就是覆盖了那些标准的声明的</span></span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                <span class="comment">// 设置签名使用的签名算法和签名使用的秘钥</span></span><br><span class="line">                .signWith(signatureAlgorithm, secretKey.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">                <span class="comment">// 设置过期时间</span></span><br><span class="line">                .setExpiration(exp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Token解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secretKey jwt秘钥 此秘钥一定要保留好在服务端, 不能暴露出去, 否则sign就可以被伪造, 如果对接多个客户端建议改造成多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token     加密后的token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title function_">parseJWT</span><span class="params">(String secretKey, String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 得到DefaultJwtParser</span></span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                <span class="comment">// 设置签名的秘钥</span></span><br><span class="line">                .setSigningKey(secretKey.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">                <span class="comment">// 设置需要解析的jwt</span></span><br><span class="line">                .parseClaimsJws(token).getBody();</span><br><span class="line">        <span class="keyword">return</span> claims;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>BaseContext线程封装类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setCurrentId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        threadLocal.set(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getCurrentId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeCurrentId</span><span class="params">()</span> &#123;</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-实现分页查询"><a href="#3-实现分页查询" class="headerlink" title="3. 实现分页查询"></a>3. 实现分页查询</h2><ol>
<li>引入pageHelper依赖</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- PageHelper分页插件 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>编写service层代码</p>
<ol>
<li>设置PageHelper</li>
<li>调用mapper层接口查询（注意mapper层接口返回类型是Page&lt;Employee&gt;）</li>
<li>调用new PageResult返回结果</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmployeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span> &#123;</span><br><span class="line"><span class="comment">//        //1.设置分页参数</span></span><br><span class="line"><span class="comment">//        PageHelper.startPage(employeePageQueryDTO.getPage(),employeePageQueryDTO.getPageSize());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //2.执行查询</span></span><br><span class="line"><span class="comment">//        List&lt;Employee&gt; empList = employeeMapper.list();</span></span><br><span class="line"><span class="comment">//        Page&lt;Employee&gt; p = (Page&lt;Employee&gt;) empList;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        // 3. 封装PageBean对象</span></span><br><span class="line"><span class="comment">//        PageResult pageResult = new PageResult(p.getTotal(),p.getResult());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        return pageResult;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始分页查询</span></span><br><span class="line">        PageHelper.startPage(employeePageQueryDTO.getPage(),employeePageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">        Page&lt;Employee&gt; page = employeeMapper.pageQuery(employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), page.getResult());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写mapper层代码（注意接口返回类型Page&lt;Employee&gt;，对应xml中具体实现的resultType也是Employee）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from employee&quot;)</span></span><br><span class="line">    List&lt;Employee&gt; <span class="title function_">list</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Page&lt;Employee&gt; <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.sky.mapper.EmployeeMapper&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageQuery&quot;</span>  <span class="attr">resultType</span>=<span class="string">&quot;com.sky.entity.Employee&quot;</span>&gt;</span></span><br><span class="line">        select * from employee</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">                name like concat(&#x27;%&#x27;,#&#123;name&#125;,&#x27;%&#x27;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-解决返回日期类型数据的格式问题"><a href="#4-解决返回日期类型数据的格式问题" class="headerlink" title="4. 解决返回日期类型数据的格式问题"></a>4. 解决返回日期类型数据的格式问题</h2><p>可以通过接口文档进行测试，也可以通过前后端联调测试，最后操作时间字段展示有问题，如下所示：</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221162938244.png" alt="image-20240221162938244"></p>
<p>建议使用解决方式二。</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240328144516573.png" alt="image-20240328144516573"></p>
<p>解决方式：</p>
<ul>
<li><p>方式一：在属性上加入注解，对日期进行格式化（缺点：只能给单个成员变量加注释）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime updateTime;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221164702793.png" alt="image-20240221164702793"></p>
</li>
<li><p>方式二：在WebMvcConfiguration中拓展Spring MVC的消息转换器，统一对日期类型进行格式化处理</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240221164331753.png" alt="image-20240221164331753"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.interceptor.JwtTokenAdminInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.sky.json.JacksonObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，注册web层相关组件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenAdminInterceptor jwtTokenAdminInterceptor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扩展Spring MVC框架的消息转化器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> converters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个消息转换器对象</span></span><br><span class="line">        <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//需要为消息转换器设置一个对象转换器，对象转换器可以将Java对象序列化为json数组</span></span><br><span class="line">        converter.setObjectMapper(<span class="keyword">new</span> <span class="title class_">JacksonObjectMapper</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将我们自己的转换器放入spring MVC框架的容器中</span></span><br><span class="line">        converters.add(<span class="number">0</span>,converter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JacksonObjectMapper相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.<span class="keyword">module</span>.SimpleModule;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalTimeSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对象映射器:基于jackson将Java对象转为json，或者将json转为Java对象</span></span><br><span class="line"><span class="comment"> * 将JSON解析为Java对象的过程称为 [从JSON反序列化Java对象]</span></span><br><span class="line"><span class="comment"> * 从Java对象生成JSON的过程称为 [序列化Java对象到JSON]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JacksonObjectMapper</span> <span class="keyword">extends</span> <span class="title class_">ObjectMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DATE_FORMAT</span> <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">    <span class="comment">//public static final String DEFAULT_DATE_TIME_FORMAT = &quot;yyyy-MM-dd HH:mm:ss&quot;;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DATE_TIME_FORMAT</span> <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_TIME_FORMAT</span> <span class="operator">=</span> <span class="string">&quot;HH:mm:ss&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JacksonObjectMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="comment">//收到未知属性时不报异常</span></span><br><span class="line">        <span class="built_in">this</span>.configure(FAIL_ON_UNKNOWN_PROPERTIES, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化时，属性不存在的兼容处理</span></span><br><span class="line">        <span class="built_in">this</span>.getDeserializationConfig().withoutFeatures(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleModule</span> <span class="variable">simpleModule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleModule</span>()</span><br><span class="line">                .addDeserializer(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">LocalDateTimeDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))</span><br><span class="line">                .addDeserializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))</span><br><span class="line">                .addDeserializer(LocalTime.class, <span class="keyword">new</span> <span class="title class_">LocalTimeDeserializer</span>(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)))</span><br><span class="line">                .addSerializer(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">LocalDateTimeSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_TIME_FORMAT)))</span><br><span class="line">                .addSerializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_DATE_FORMAT)))</span><br><span class="line">                .addSerializer(LocalTime.class, <span class="keyword">new</span> <span class="title class_">LocalTimeSerializer</span>(DateTimeFormatter.ofPattern(DEFAULT_TIME_FORMAT)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册功能模块 例如，可以添加自定义序列化器和反序列化器</span></span><br><span class="line">        <span class="built_in">this</span>.registerModule(simpleModule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="day03"><a href="#day03" class="headerlink" title="day03"></a>day03</h1><h2 id="1-实现自定义切面类和冗余代码抽取"><a href="#1-实现自定义切面类和冗余代码抽取" class="headerlink" title="1. 实现自定义切面类和冗余代码抽取"></a>1. 实现自定义切面类和冗余代码抽取</h2><p><strong>解决办法</strong></p>
<ul>
<li>自定义注解AutoFill，用于标识需要进行公共字段自动填充的方法</li>
<li>自定义切面类AutoFillAspect，统一拦截加入了AutoFill注解的方法，通过反射为公共字段赋值</li>
<li>在Mapper的方法上加上AutoFill注解</li>
</ul>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240328152232474.png" alt="image-20240328152232474"></p>
<ol>
<li><p>创建AutoFill注解(主要用于mapper)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.annotation;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义注解，用于标识某个方法需要进行功能字段自动填充处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoFill &#123;</span><br><span class="line">    <span class="comment">//数据库操作类型</span></span><br><span class="line">    OperationType <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>枚举类型OperationType定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.enumeration;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据库操作类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">OperationType</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UPDATE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INSERT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写自定义切面类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.AutoFillConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义切面，实现公共字段自动填充处理逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//log</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//切面类</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//交由IOC容器的Bean对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoFillAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定切入点（对哪些类的哪些方法指定）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)&quot;)</span>  <span class="comment">//拦截mapper包下所有类和接口的所有方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFillPointCut</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知，在通知中进行公共字段的赋值，这个切面的执行会直接修改通过这些mapper方法传递的参数实体。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;autoFillPointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFill</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始进行公共字段的自动填充...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*        Signature signature = joinPoint.getSignature(); //获取目标方法签名</span></span><br><span class="line"><span class="comment">        String name = joinPoint.getSignature().getName();</span></span><br><span class="line"><span class="comment">        Object[] args = joinPoint.getArgs();</span></span><br><span class="line"><span class="comment">        System.out.println(signature);</span></span><br><span class="line"><span class="comment">        System.out.println(name);</span></span><br><span class="line"><span class="comment">        System.out.println(args);*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        1. 获取当前被拦截的方法的数据库的操作类型（上面是反射包的相关代码，可读性相对差一些）</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature(); <span class="comment">//方法签名对象</span></span><br><span class="line"><span class="comment">//        void com.sky.mapper.EmployeeMapper.update(Employee)</span></span><br><span class="line"><span class="comment">//        System.out.println(signature);</span></span><br><span class="line">        <span class="type">AutoFill</span> <span class="variable">autoFill</span> <span class="operator">=</span> signature.getMethod().getAnnotation(AutoFill.class);  <span class="comment">//获得方法上的注解对象</span></span><br><span class="line"><span class="comment">//        System.out.println(autoFill);</span></span><br><span class="line"><span class="comment">//        @com.sky.annotation.AutoFill(UPDATE)</span></span><br><span class="line">        <span class="type">OperationType</span> <span class="variable">operationType</span> <span class="operator">=</span> autoFill.value(); <span class="comment">//获得数据库操作类型</span></span><br><span class="line"><span class="comment">//        System.out.println(operationType);</span></span><br><span class="line"><span class="comment">//        UPDATE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        2. 获取到方法的参数（实体类，可以是员工实体，分类实体，套餐实体，菜品实体），确保实体类对象放在第一个参数</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line"><span class="comment">//        System.out.println(args);</span></span><br><span class="line"><span class="comment">//        [Ljava.lang.Object;@6f17c9e0</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;\n\n&quot;);</span></span><br><span class="line">        <span class="keyword">if</span>(args == <span class="literal">null</span> &amp;&amp; args.length == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">entity</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(args[0]);</span></span><br><span class="line"><span class="comment">//        Employee(id=8, username=wangwu, name=王五, password=null, phone=15988853410, sex=1, idNumber=112233445566778989, status=null, createTime=null, updateTime=2024-02-22T12:08:43.927707700, createUser=null, updateUser=1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        3. 准备待赋值的数据，为实体对象赋值（有createTime，updateTime，createUser，updateUser）</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        4. 根据当前不同的操作类型，为对应的属性赋值（通过反射）</span></span><br><span class="line">        <span class="keyword">if</span>(operationType == OperationType.INSERT)&#123;</span><br><span class="line">            <span class="comment">//为4个公共字段赋值</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//直接用方法名去取method，是硬编码，如果获取的类方法发生了变化，整个代码就要重构</span></span><br><span class="line">                <span class="comment">//使用类常量命名，防止手敲出错</span></span><br><span class="line">                <span class="type">Method</span> <span class="variable">setCreateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setCreateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_USER, Long.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//通过反射为对象属性赋值</span></span><br><span class="line">                setCreateTime.invoke(entity,now);</span><br><span class="line">                setUpdateTime.invoke(entity,now);</span><br><span class="line">                setCreateUser.invoke(entity,currentId);</span><br><span class="line">                setUpdateUser.invoke(entity,currentId);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(operationType == OperationType.UPDATE)&#123;</span><br><span class="line">            <span class="comment">//为2个公共字段赋值</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//通过反射为对象属性赋值</span></span><br><span class="line">                setUpdateTime.invoke(entity,now);</span><br><span class="line">                setUpdateUser.invoke(entity,currentId);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给对应的方法上加上注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CategoryMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AutoFill(value=OperationType.INSERT)</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into category(type, name, sort, status, create_time, update_time, create_user, update_user)&quot; +</span></span><br><span class="line"><span class="meta">            &quot; VALUES&quot; +</span></span><br><span class="line"><span class="meta">            &quot; (#&#123;type&#125;, #&#123;name&#125;, #&#123;sort&#125;, #&#123;status&#125;, #&#123;createTime&#125;, #&#123;updateTime&#125;, #&#123;createUser&#125;, #&#123;updateUser&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Category category)</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AutoFill(value=OperationType.UPDATE)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Category category)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-接收multipart-form-data类型的数据"><a href="#2-接收multipart-form-data类型的数据" class="headerlink" title="2. 接收multipart&#x2F;form-data类型的数据"></a>2. 接收multipart&#x2F;form-data类型的数据</h2><p>使用MultipartFile类型接受该数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/common&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;通用接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;文件上传&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;文件上传：&#123;&#125;&quot;</span>,file);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-上传图片到阿里云并返回图片路径"><a href="#3-上传图片到阿里云并返回图片路径" class="headerlink" title="3. 上传图片到阿里云并返回图片路径"></a>3. 上传图片到阿里云并返回图片路径</h2><ol>
<li><p>编辑application-dev.yaml文件，配置阿里云OSS服务相关参数</p>
<p><strong>application-dev.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">alioss:</span></span><br><span class="line">    <span class="attr">endpoint :</span> <span class="string">https://oss-cn-hangzhou.aliyuncs.com</span></span><br><span class="line">    <span class="attr">access-key-id :</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">access-key-secret :</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">bucket-name :</span> <span class="string">waterdance-web-tlias</span></span><br></pre></td></tr></table></figure>

<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">alioss:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">$&#123;sky.alioss.endpoint&#125;</span></span><br><span class="line">    <span class="attr">access-key-id:</span> <span class="string">$&#123;sky.alioss.access-key-id&#125;</span></span><br><span class="line">    <span class="attr">access-key-secret:</span> <span class="string">$&#123;sky.alioss.access-key-secret&#125;</span></span><br><span class="line">    <span class="attr">bucket-name:</span> <span class="string">$&#123;sky.alioss.bucket-name&#125;</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写属性配置类，接收配置参数，将其诸如Bean对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;sky.alioss&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliOssProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写配置类，通过@Bean注解将AliOssUtil的属性初始化，并作为Bean对象注入到IOC容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，用于创建AliOssUtil对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> AliOssUtil <span class="title function_">aliOssUtil</span><span class="params">(AliOssProperties aliOssProperties)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始创建阿里云文件上传工具类对象：&#123;&#125;&quot;</span>,aliOssProperties);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliOssUtil</span>(aliOssProperties.getEndpoint(),</span><br><span class="line">                                aliOssProperties.getAccessKeyId(),</span><br><span class="line">                                aliOssProperties.getAccessKeySecret(),</span><br><span class="line">                                aliOssProperties.getBucketName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>编写接收MultipartFile类型数据的controller，将数据传输到阿里云，并返回图片在阿里云服务器的网址路径</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/common&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;通用接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AliOssUtil aliOssUtil;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;文件上传&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;文件上传：&#123;&#125;&quot;</span>,file);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//原始文件名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="comment">//截取原始文件名的后缀 dfdfdf.png</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="comment">//构造新文件名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> UUID.randomUUID().toString() + extension;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//为了防止文件重名导致文件覆盖，使用UUID重命名，</span></span><br><span class="line">            <span class="comment">//文件的请求路径</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> aliOssUtil.upload(file.getBytes(), objectName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result.success(filePath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;文件上传失败：&#123;&#125;&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.error(MessageConstant.UPLOAD_FAILED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>上传代码方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.utils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliOssUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] bytes, String objectName)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建PutObject请求。</span></span><br><span class="line">            ossClient.putObject(bucketName, objectName, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OSSException oe) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an OSSException, which means your request made it to OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;but was rejected with an error response for some reason.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message:&quot;</span> + oe.getErrorMessage());</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Code:&quot;</span> + oe.getErrorCode());</span><br><span class="line">            System.out.println(<span class="string">&quot;Request ID:&quot;</span> + oe.getRequestId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Host ID:&quot;</span> + oe.getHostId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException ce) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an ClientException, which means the client encountered &quot;</span></span><br><span class="line">                    + <span class="string">&quot;a serious internal problem while trying to communicate with OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;such as not being able to access the network.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message:&quot;</span> + ce.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ossClient != <span class="literal">null</span>) &#123;</span><br><span class="line">                ossClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件访问路径规则 https://BucketName.Endpoint/ObjectName</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;https://&quot;</span>);</span><br><span class="line">        stringBuilder</span><br><span class="line">                .append(bucketName)</span><br><span class="line">                .append(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">                .append(endpoint)</span><br><span class="line">                .append(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                .append(objectName);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;文件上传到:&#123;&#125;&quot;</span>, stringBuilder.toString());</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="day04"><a href="#day04" class="headerlink" title="day04"></a>day04</h1><h1 id="day05"><a href="#day05" class="headerlink" title="day05"></a>day05</h1><h2 id="1-Redis的导入及使用"><a href="#1-Redis的导入及使用" class="headerlink" title="1. Redis的导入及使用"></a>1. Redis的导入及使用</h2><p>Redis安装包分为Windows版本和Linux版本：</p>
<ul>
<li>Windows版本下载地址：<a target="_blank" rel="noopener" href="https://github.com/microsoftarchive/redis/releases">https://github.com/microsoftarchive/redis/releases</a></li>
<li>Linux版下载地址：<a target="_blank" rel="noopener" href="https://download.redis.io/releases/">https://download.redis.io/releases/</a></li>
</ul>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225211828939.png" alt="image-20240225211828939"></p>
<p>Redis的Windows版属于绿色软件，直接解压即可使用，解压后目录结构如下：</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225212144784.png" alt="image-20240225212144784"></p>
<p><strong>启动服务</strong>（第一个参数是redis-server.exe，第二个参数是redis.windows.conf）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server.exe redis.windows.conf</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225213141902.png" alt="image-20240225213141902"></p>
<p><strong>停止服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctrl + c</span><br></pre></td></tr></table></figure>



<p><strong>通过客户端连接redis服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cls.exe</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225214144982.png" alt="image-20240225214144982"></p>
<p>测试是否连上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225214313241.png" alt="image-20240225214313241"></p>
<p>退出redis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225214412285.png" alt="image-20240225214412285"></p>
<p><strong>指定连接主机地址和端口</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli.exe -h localhost -p 6379</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225214532703.png" alt="image-20240225214532703"></p>
<p>redis配置文件中默认是没有配置密码的，我们的客户端不用密码就可以连接上该redis。</p>
<p><strong>配置redis.windows.conf文件，给redis设置密码。</strong>（redis中没有用户名的概念）</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225214937198.png" alt="image-20240225214937198"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225215410275.png" alt="image-20240225215410275"></p>
<p>我们后期经常用的是redis客户端图形界面。</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225215513434.png" alt="image-20240225215513434"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225215559337.png" alt="image-20240225215559337"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225215648190.png" alt="image-20240225215648190"></p>
<p><strong>选择简体中文</strong></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240225215828897.png" alt="image-20240225215828897"></p>
<p>Redis的Java客户端很多，常用的几种：</p>
<ul>
<li>Jedis（Redis官方推荐的客户端）</li>
<li>Lettuce</li>
<li>Spring Data Redis（对Jedis和Lettuce进行了高度封装）</li>
</ul>
<p>Spring Data Redis是Spring的一部分，对Redis底层开发包进行了高度封装。</p>
<p>在Spring项目中，可以使用Spring Data Redis来简化操作。</p>
<p>Spring Data Redis使用方式</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240328213316190.png" alt="image-20240328213316190"></p>
<p>操作步骤：</p>
<ol>
<li><p>导入Spring Data Redis的maven坐标</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226001646019.png" alt="image-20240226001646019"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Redis数据源</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226001654290.png" alt="image-20240226001654290"></p>
<p><font color="red">redis服务启动后，默认情况下，他在redis服务中，创建了16个库。可以通过database指定使用的数据库，不同数据库的数据是完全隔离的。如果不配置database，默认连接到redis后，使用0号数据库。</font></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226002257564.png" alt="image-20240226002257564"></p>
</li>
<li><p>编写配置类，创建RedisTemplate对象（这个对象是Spring Data Redis最核心、最常用的对象）</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226001724266.png" alt="image-20240226001724266"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123; <span class="comment">//如果第三方bean需要依赖其他bean对象，直接再bean定义方法中设置形参即可，容器会根据类型自动装配</span></span><br><span class="line">        <span class="type">RedisTemplate</span> <span class="variable">redisTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置redis的连接工厂对象</span></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置redis当中key的序列化器</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过RedisTemplate对象操作Redis（通过单元测试可以系统学习redis的具体使用方式）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226004010021.png" alt="image-20240226004010021"></p>
</li>
</ol>
<p>redis有五种数据类型，每一种数据类型提供了各种操作命令，在此，redisTemplate封装了五种操作接口，对应五种数据类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226004304257.png" alt="image-20240226004304257"></p>
<p><strong>Spring Data Redis使用方法 操作字符串类型的数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作字符串类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//set 向redis中插入数据</span></span><br><span class="line">        <span class="comment">//get 从redis中获取数据</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;city&quot;</span>,<span class="string">&quot;北京&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(<span class="string">&quot;city&quot;</span>);</span><br><span class="line">        System.out.println(city);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setex 插入数据的同时设置数据有效期（设置键值对code:1234，有效期是3分钟）</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;code&quot;</span>,<span class="string">&quot;1234&quot;</span>,<span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setnx 向redis中插入数据（如果键不存在）（value可以给任意类型，最终它都会将其序列化，最终都会转成redis当中的string进行存储，从java代码角度来看，可以给任何类型的参数）</span></span><br><span class="line">        redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;lock&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在application-dev.yml文件中设置了redis连接的内存的数据库为10号，在debug模式下进入到以下语句，再查看db10中对应的键值对。</p>
<p>此时db10中已经存在对应的键值对 “city”:”北京”</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226103538896.png" alt="image-20240226103538896"></p>
<p>我们使用redis desktop manager查看db10中city的值，会发现它是乱码的。</p>
<p><font color="red">这个时候它其实不是乱码的，我们是通过java程序操作对应的redis数据，它其实对数据进行了序列化操作，序列化之后才变成了如下图所示的值。而且key（city）是没问题的，并未出现乱码的效果，那是因为我们在用配置类声明RedisTemplate时，在其中配置了redis key的序列化器。如果不配置序列化器，redis也会使用默认的序列化器来序列化数据。</font></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226103631514.png" alt="image-20240226103631514"></p>
<p><font color="red">所以在java中查询redis的键值对中的value是没有问题的。只是在客户端上看起来乱码。</font></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226104111245.png" alt="image-20240226104111245"></p>
<p><strong>Spring Data Redis使用方法 操作哈希类型的数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作哈希类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="comment">//hset</span></span><br><span class="line">        hashOperations.put(<span class="string">&quot;100&quot;</span>,<span class="string">&quot;name&quot;</span>,<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        hashOperations.put(<span class="string">&quot;100&quot;</span>,<span class="string">&quot;age&quot;</span>,<span class="string">&quot;20&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hget</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) hashOperations.get(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">age</span> <span class="operator">=</span> (String) hashOperations.get(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;age&quot;</span>);</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(age);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hkeys</span></span><br><span class="line">        <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> hashOperations.keys(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        System.out.println(keys);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hvals</span></span><br><span class="line">        <span class="type">List</span> <span class="variable">values</span> <span class="operator">=</span> hashOperations.values(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        System.out.println(values);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hdel</span></span><br><span class="line">        hashOperations.delete(<span class="string">&quot;100&quot;</span>,<span class="string">&quot;age&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226105445070.png" alt="image-20240226105445070"></p>
<p><strong>Spring Data Redis使用方法 操作其他类型的数据</strong></p>
<p><strong>操作list类型数据</strong></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226110601784.png" alt="image-20240226110601784"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作列表类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//lpush lrange rpop llen</span></span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//lpush</span></span><br><span class="line">        listOperations.leftPushAll(<span class="string">&quot;mylist&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>);</span><br><span class="line">        listOperations.leftPush(<span class="string">&quot;mylist&quot;</span>,<span class="string">&quot;d&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//lrange</span></span><br><span class="line">        <span class="type">List</span> <span class="variable">mylist</span> <span class="operator">=</span> listOperations.range(<span class="string">&quot;mylist&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        System.out.println(mylist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//rpop</span></span><br><span class="line">        listOperations.rightPop(<span class="string">&quot;mylist&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> listOperations.size(<span class="string">&quot;mylist&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">List</span> <span class="variable">mylist2</span> <span class="operator">=</span> listOperations.range(<span class="string">&quot;mylist&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        System.out.println(mylist2);</span><br><span class="line"></span><br><span class="line">        System.out.println(size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>操作set类型数据</strong></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226111149869.png" alt="image-20240226111149869"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作集合类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line"></span><br><span class="line">        setOperations.add(<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>);</span><br><span class="line">        setOperations.add(<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="string">&quot;y&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">set1</span> <span class="operator">=</span> setOperations.members(<span class="string">&quot;set1&quot;</span>);</span><br><span class="line">        System.out.println(set1);</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> setOperations.size(<span class="string">&quot;set1&quot;</span>);</span><br><span class="line">        System.out.println(size);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">intersect</span> <span class="operator">=</span> setOperations.intersect(<span class="string">&quot;set1&quot;</span>, <span class="string">&quot;set2&quot;</span>);</span><br><span class="line">        System.out.println(intersect);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">union</span> <span class="operator">=</span> setOperations.union(<span class="string">&quot;set1&quot;</span>, <span class="string">&quot;set2&quot;</span>);</span><br><span class="line">        System.out.println(union);</span><br><span class="line"></span><br><span class="line">        setOperations.remove(<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        System.out.println(setOperations.members(<span class="string">&quot;set1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>有序集合类型数据</strong></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226111711857.png" alt="image-20240226111711857"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作有序集合类型的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testZset</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">        zSetOperations.add(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        zSetOperations.add(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="number">12</span>);</span><br><span class="line">        zSetOperations.add(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Set</span> <span class="variable">zset1</span> <span class="operator">=</span> zSetOperations.range(<span class="string">&quot;zset1&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        System.out.println(zset1);</span><br><span class="line"></span><br><span class="line">        zSetOperations.incrementScore(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        zSetOperations.remove(<span class="string">&quot;zset1&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通用命令操作</strong></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240226112106895.png" alt="image-20240226112106895"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.DataType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用命令操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCommon</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//keys exists type del</span></span><br><span class="line">        <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> redisTemplate.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        System.out.println(keys);</span><br><span class="line"></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">name</span> <span class="operator">=</span> redisTemplate.hasKey(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">set</span> <span class="operator">=</span> redisTemplate.hasKey(<span class="string">&quot;set&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object key : keys) &#123;</span><br><span class="line">            <span class="type">DataType</span> <span class="variable">type</span> <span class="operator">=</span> redisTemplate.type(key);</span><br><span class="line">            System.out.println(type.name());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;mylist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-Swagger设置多个测试接口分组"><a href="#2-Swagger设置多个测试接口分组" class="headerlink" title="2. Swagger设置多个测试接口分组"></a>2. Swagger设置多个测试接口分组</h2><p>进入Swagger的配置类WebMvcConfiguration对应的方法docket的代码，复制docket，设置对应的属性</p>
<ol>
<li>复制docket方法</li>
<li>各自设置docket1和docket2扫描包的范围</li>
<li>各自设置groupName(“xxx”)</li>
</ol>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240328214736460.png" alt="image-20240328214736460"></p>
<h1 id="day06"><a href="#day06" class="headerlink" title="day06"></a>day06</h1><h2 id="1-微信登录"><a href="#1-微信登录" class="headerlink" title="1. 微信登录"></a>1. 微信登录</h2><h2 id><a href="#" class="headerlink" title></a></h2><h1 id="day07"><a href="#day07" class="headerlink" title="day07"></a>day07</h1><h2 id="1-使用Redis缓存商品数据"><a href="#1-使用Redis缓存商品数据" class="headerlink" title="1. 使用Redis缓存商品数据"></a>1. 使用Redis缓存商品数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController(&quot;userDishController&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/dish&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端-菜品浏览接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据分类id查询菜品&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;DishVO&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">        <span class="comment">//构造redis中的key，规则：dish_分类id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + categoryId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询redis中是否存在菜品数据</span></span><br><span class="line">        List&lt;DishVO&gt; list = (List&lt;DishVO&gt;) redisTemplate.opsForValue().get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果存在，直接返回，无需查询数据库</span></span><br><span class="line">            <span class="keyword">return</span> Result.success(list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">        dish.setCategoryId(categoryId);</span><br><span class="line">        dish.setStatus(StatusConstant.ENABLE);<span class="comment">//查询起售中的菜品</span></span><br><span class="line"></span><br><span class="line">        list = dishService.listWithFlavor(dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果不存在，查询数据库，将查询到的数据放到redis中</span></span><br><span class="line">        redisTemplate.opsForValue().set(key, list);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-使用SpringCache简化redis操作"><a href="#2-使用SpringCache简化redis操作" class="headerlink" title="2. 使用SpringCache简化redis操作"></a>2. 使用SpringCache简化redis操作</h2><p>使用它可以进一步简化代码，提供了注解，要操作缓存数据，只要在方法上加入它提供的注解就可以。这种使用方式类似于事务管理。</p>
<p>Spring Cache是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。</p>
<p>Spring Cache提供了一层抽象，底层可以切换不同的缓存实现，例如：</p>
<ul>
<li>EHCache</li>
<li>Caffeine</li>
<li>Redis</li>
</ul>
<p>实现步骤：</p>
<ul>
<li>导入Spring Cache和Redis相关的maven坐标</li>
<li>在启动类上加入@EnableCaching注解，开启缓存注解功能</li>
<li>在用户端接口SetmealController的list方法上加入@Cacheable注解</li>
<li>在管理端接口SetmealController的save、delete、update、startOrStop等方法上加入CacheEvit注解</li>
</ul>
<ol>
<li><strong>导入maven坐标</strong>（不同缓存对应不同坐标，用redis就导入redis坐标）</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!-- redis坐标 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>常用注解：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@EnableCaching</td>
<td>开启缓存注解功能，通常加在启动类上</td>
</tr>
<tr>
<td>@Cacheable</td>
<td>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将<strong>方法返回值</strong>放到缓存中</td>
</tr>
<tr>
<td>@CachePut</td>
<td>将<strong>方法的返回值</strong>放到缓存中</td>
</tr>
<tr>
<td>@CacheEvict</td>
<td>将一条或多条数据从缓存中删除</td>
</tr>
</tbody></table>
<ol start="2">
<li><p><strong>开启缓存功能</strong></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240301132649067.png" alt="image-20240301132649067"></p>
</li>
<li><p><strong>修改user&#x2F;setmealcontroller类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据分类id查询套餐&quot;)</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;setmealCache&quot;, key = &quot;#categoryId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;Setmeal&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">    setmeal.setCategoryId(categoryId);</span><br><span class="line">    setmeal.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">    List&lt;Setmeal&gt; list = setmealService.list(setmeal);</span><br><span class="line">    <span class="keyword">return</span> Result.success(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240301132834586.png" alt="image-20240301132834586"></p>
<p><strong>修改admin&#x2F;setmealcontroller类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;, key = &quot;#setmealDTO.categoryId&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;新增套餐接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;新增套餐接口:&#123;&#125;&quot;</span>,setmealDTO);</span><br><span class="line">    setmealService.saveWithDish(setmealDTO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;批量删除套餐&quot;)</span></span><br><span class="line"><span class="keyword">public</span>  Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span>&#123;</span><br><span class="line">    setmealService.deleteBatch(ids);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;修改套餐&quot;)</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> &#123;</span><br><span class="line">    setmealService.update(setmealDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/status/&#123;status&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;套餐起售停售&quot;)</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;setmealCache&quot;,allEntries = true)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status, Long id)</span> &#123;</span><br><span class="line">    setmealService.startOrStop(status, id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font color="red">给user&#x2F;admin端的dishcontroller类中也修改对应的注释。</font></p>
</li>
</ol>
<p><strong>ps：SpringCache指定键值对的键的方法如下所示：</strong></p>
<ol>
<li><p>使用@CachePut注解，将对应方法的返回值放入redis缓存中。</p>
<p>该返回值的键，可以由#user.id或#result.id决定。</p>
<p><strong>UserController类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#user.id&quot;) //如果使用spring Cache缓存数据，key的生成：userCache::2,</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#result.id&quot;) //对象导航</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#p0.id&quot;) //拿到当前方法的第一个参数</span></span><br><span class="line"><span class="comment">//    @CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#a0.id&quot;) //拿到当前方法的第一个参数</span></span><br><span class="line"><span class="meta">@CachePut(cacheNames = &quot;userCache&quot;,key = &quot;#root.args[0].id&quot;)</span> <span class="comment">//拿到当前方法的第一个参数</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">    <span class="comment">//插入数据时要将数据放到缓存中</span></span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用@Cacheable注解，如果查到数据，会把它直接放到缓存中。</p>
<p>（Spring Cache底层是基于代理技术，即加入注解之后，Spring Cache会为当前的controller创建代理对象，我们在请求方法前是先进入代理对象，而在代理对象中查询redis）</p>
<p><strong>UserController类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = &quot;userCache&quot;,key=&quot;#id&quot;)</span>  <span class="comment">//key的生成 userCache::id</span></span><br><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(id);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用@CacheEvict注解，方法结束完之后会删除缓存中的单条数据或全部数据</p>
<p><strong>UserController类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;userCache&quot;,key=&quot;#id&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    userMapper.deleteById(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = &quot;userCache&quot;,allEntries = true)</span> <span class="comment">//删除redis缓存中userCache下的所有键值对</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/delAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span>&#123;</span><br><span class="line">    userMapper.deleteAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="day08"><a href="#day08" class="headerlink" title="day08"></a>day08</h1><h2 id="1-微信支付"><a href="#1-微信支付" class="headerlink" title="1. 微信支付"></a>1. 微信支付</h2><h1 id="day09"><a href="#day09" class="headerlink" title="day09"></a>day09</h1><h2 id="1-校验收货地址是否超出配送范围"><a href="#1-校验收货地址是否超出配送范围" class="headerlink" title="1. 校验收货地址是否超出配送范围"></a>1. 校验收货地址是否超出配送范围</h2><h1 id="day10"><a href="#day10" class="headerlink" title="day10"></a>day10</h1><h2 id="1-Spring-Task的导入及使用"><a href="#1-Spring-Task的导入及使用" class="headerlink" title="1. Spring Task的导入及使用"></a>1. Spring Task的导入及使用</h2><p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329012440726.png" alt="image-20240329012440726"></p>
<p>Spring Task使用步骤：</p>
<ol>
<li>导入maven坐标spring-context（已存在）</li>
<li>启动类添加注释@EnableScheduling开启任务调度</li>
<li>自定义定时任务类</li>
</ol>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240329022206700.png" alt="image-20240329022206700"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Orders;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定时任务类，定时处理订单状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理超时订单的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = &quot;0 * * * * ?&quot;) //每分钟触发一次</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;1/5 * * * * ?&quot;)</span> <span class="comment">//每分钟触发一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processTimeOutOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;定时处理超时订单：&#123;&#125;&quot;</span>, LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//select * from orders where status == ? and order_time  &lt; (当前时间 - 15分钟)</span></span><br><span class="line">        List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrderTimeLT(Orders.PENDING_PAYMENT, time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">                orders.setStatus(Orders.CANCELLED);</span><br><span class="line">                orders.setCancelReason(<span class="string">&quot;订单超时，自动取消&quot;</span>);</span><br><span class="line">                orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">                orderMapper.update(orders);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理一直处于派送中状态的订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = &quot;0 0 1 * * ?&quot;) //每天凌晨1点触发一次</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeliveryOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;定时处理处于派送中的订单：&#123;&#125;&quot;</span>,LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().minusMinutes(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrderTimeLT(Orders.DELIVERY_IN_PROGRESS, time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">                orders.setStatus(Orders.COMPLETED);</span><br><span class="line">                orderMapper.update(orders);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-WebSocket的导入及使用"><a href="#2-WebSocket的导入及使用" class="headerlink" title="2. WebSocket的导入及使用"></a>2. WebSocket的导入及使用</h2><p>实现步骤：</p>
<ol>
<li>直接使用websocket.html页面作为WebSocket客户端</li>
<li>导入WebSocket的maven坐标</li>
<li>导入WebSocket服务端组件WebSocketServer，用于和客户端通信</li>
<li>导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</li>
<li>导入定时任务类WebSocketTask，定时向客户端推送数据</li>
</ol>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240303212557934.png" alt="image-20240303212557934"></p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240303212612276.png" alt="image-20240303212612276"></p>
<p><strong>websocket.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;send()&quot;</span>&gt;</span>发送消息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;closeWebSocket()&quot;</span>&gt;</span>关闭连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> websocket = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> clientId = <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//判断当前浏览器是否支持WebSocket</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(<span class="string">&#x27;WebSocket&#x27;</span> <span class="keyword">in</span> <span class="variable language_">window</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//连接WebSocket节点</span></span></span><br><span class="line"><span class="language-javascript">        websocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080/ws/&quot;</span>+clientId);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">&#x27;Not support websocket&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接发生错误的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(<span class="string">&quot;error&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接成功建立的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(<span class="string">&quot;连接成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//接收到消息的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接关闭的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onclose</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(<span class="string">&quot;close&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">onbeforeunload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        websocket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//将消息显示在网页上</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">setMessageInnerHTML</span>(<span class="params">innerHTML</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;message&#x27;</span>).<span class="property">innerHTML</span> += innerHTML + <span class="string">&#x27;&lt;br/&gt;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//发送消息</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">send</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> message = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;text&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        websocket.<span class="title function_">send</span>(message);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">	</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">//关闭连接</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">closeWebSocket</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        websocket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>导入maven坐标</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>WebSocketConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket配置类，用于注册WebSocket的Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>WebSocketServer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnClose;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnMessage;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnOpen;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放会话对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接建立成功调用的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;客户端：&quot;</span> + sid + <span class="string">&quot;建立连接&quot;</span>);</span><br><span class="line">        sessionMap.put(sid, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到客户端消息后调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 客户端发送过来的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到来自客户端：&quot;</span> + sid + <span class="string">&quot;的信息:&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接关闭调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;连接断开:&quot;</span> + sid);</span><br><span class="line">        sessionMap.remove(sid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 群发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllClient</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        Collection&lt;Session&gt; sessions = sessionMap.values();</span><br><span class="line">        <span class="keyword">for</span> (Session session : sessions) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//服务器向客户端发送消息</span></span><br><span class="line">                session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <strong>WebSocketTask</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.websocket.WebSocketServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketTask</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过WebSocket每隔5秒向客户端发送消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToClient</span><span class="params">()</span> &#123;</span><br><span class="line">        webSocketServer.sendToAllClient(<span class="string">&quot;这是来自服务端的消息：&quot;</span> + DateTimeFormatter.ofPattern(<span class="string">&quot;HH:mm:ss&quot;</span>).format(LocalDateTime.now()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-来单提醒"><a href="#3-来单提醒" class="headerlink" title="3. 来单提醒"></a>3. 来单提醒</h2><h2 id="4-客户催单"><a href="#4-客户催单" class="headerlink" title="4. 客户催单"></a>4. 客户催单</h2><h1 id="day11"><a href="#day11" class="headerlink" title="day11"></a>day11</h1><h1 id="day12"><a href="#day12" class="headerlink" title="day12"></a>day12</h1><h2 id="1-Apache-POI的导入及使用"><a href="#1-Apache-POI的导入及使用" class="headerlink" title="1. Apache POI的导入及使用"></a>1. Apache POI的导入及使用</h2><p>Apache POI是一个处理Miscrosoft Office各种文件格式的开源项目。简单来说就是，我们可以用POI在Java程序中对Miscrosoft Office各种文件进行读写操作。</p>
<p>一般情况下，POI都是操作Excel文件。</p>
<p><img src="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/image-20240304194119767.png" alt="image-20240304194119767"></p>
<p>Apache POI的应用场景：</p>
<ul>
<li>银行网银系统导出交易明细</li>
<li>各种业务系统导出Excel报表</li>
<li>批量导入业务数据</li>
</ul>
<p><strong>操作一：</strong></p>
<p>Apache POI的maven坐标：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- poi --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写案例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportBusinessData</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1. 查询数据库，获取营业数据 -- 查询最近30天的运营数据</span></span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">dateBegin</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">30</span>);</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">dateEnd</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(dateBegin, LocalTime.MIN);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(dateBegin, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询概览数据</span></span><br><span class="line">    <span class="type">BusinessDataVO</span> <span class="variable">businessData</span> <span class="operator">=</span> workspaceService.getBusinessData(beginTime, endTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 通过POI将数据写入到Excel文件中</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;template/运营数据报表模板&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于模板文件创建一个新的excel文件</span></span><br><span class="line">    <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(in);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 通过输出流将Excel文件下载至客户端浏览器</span></span><br><span class="line">    <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据 -- 时间</span></span><br><span class="line">    sheet.getRow(<span class="number">1</span>).getCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;时间：&quot;</span> + dateBegin + <span class="string">&quot;至&quot;</span> + dateEnd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据 -- 营业额 | 订单完成率 | 新增用户数</span></span><br><span class="line">    sheet.getRow(<span class="number">3</span>).getCell(<span class="number">2</span>).setCellValue(businessData.getTurnover());</span><br><span class="line">    sheet.getRow(<span class="number">3</span>).getCell(<span class="number">4</span>).setCellValue(businessData.getOrderCompletionRate());</span><br><span class="line">    sheet.getRow(<span class="number">3</span>).getCell(<span class="number">6</span>).setCellValue(businessData.getNewUsers());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据 -- 有效订单数 | 平均客单价</span></span><br><span class="line">    sheet.getRow(<span class="number">4</span>).getCell(<span class="number">2</span>).setCellValue(businessData.getValidOrderCount());</span><br><span class="line">    sheet.getRow(<span class="number">4</span>).getCell(<span class="number">4</span>).setCellValue(businessData.getUnitPrice());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充明细数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> dateBegin.plusDays(i);</span><br><span class="line">        <span class="comment">//查询某一天的营业数据</span></span><br><span class="line">        <span class="type">BusinessDataVO</span> <span class="variable">businessDataVO</span> <span class="operator">=</span> workspaceService.getBusinessData(LocalDateTime.of(date, LocalTime.MIN), LocalDateTime.of(date, LocalTime.MAX));</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">1</span>).setCellValue(date.toString());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">2</span>).setCellValue(businessDataVO.getTurnover());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">3</span>).setCellValue(businessDataVO.getValidOrderCount());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">4</span>).setCellValue(businessDataVO.getOrderCompletionRate());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">5</span>).setCellValue(businessDataVO.getUnitPrice());</span><br><span class="line">        sheet.getRow(<span class="number">7</span> + i).getCell(<span class="number">6</span>).setCellValue(businessDataVO.getNewUsers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过输出流对象下载数据到客户端浏览器</span></span><br><span class="line">    <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">    excel.write(out);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源</span></span><br><span class="line">    out.close();</span><br><span class="line">    excel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/" itemprop="url">学成在线-day09-课程发布 + day10-页面静态化、认证授权、SpringSecurity</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-24T14:46:43+08:00">
                2024-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  18.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  75
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1</strong> <strong>模块需求分析</strong></h1><h2 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1</strong> <strong>模块介绍</strong></h2><p>课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。</p>
<p>下边是课程编辑与发布的整体流程：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-171126384160695.gif" alt="img"></p>
<p>为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。</p>
<p>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。</p>
<p>下图是课程预览的效果图，也是课程正式发布后的课程详情界面：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-171126384160696.gif" alt="img"></p>
<p>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。</p>
<p>课程发布模块共包括三块功能：</p>
<p>1、课程预览</p>
<p>2、课程审核</p>
<p>3、课程发布</p>
<h2 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2</strong> <strong>业务流程</strong></h2><h3 id="1-2-1-课程预览"><a href="#1-2-1-课程预览" class="headerlink" title="1.2.1 课程预览"></a><strong>1.2.1</strong> <strong>课程预览</strong></h3><p>1.<strong>教育机构用户</strong>在课程管理中可对该机构内所管理的课程进行检索。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-171126384160797.gif" alt="img"></p>
<p>2.点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面效果。</p>
<p>下图是课程详情首页，显示了课程的基本信息。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-171126384160798.gif" alt="img"></p>
<p>点击课程目录，显示课程计划，通过此界面去核实课程计划的信息是否存在问题。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-171126384160799.gif" alt="img"></p>
<p>点击课程目录中的具体章节，查看视频播放是否正常</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711263841607102.gif" alt="img"></p>
<h3 id="1-2-2-课程审核"><a href="#1-2-2-课程审核" class="headerlink" title="1.2.2 课程审核"></a><strong>1.2.2</strong> <strong>课程审核</strong></h3><p>教学机构提交课程审核后，平台运营人员登录运营平台进行课程审核，课程审核包括程序自动审核和人工审核，程序会审核内容的完整性，人员通过课程预览进行审核。</p>
<p>流程如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711263841607100.gif" alt="img"></p>
<p>1、首先查询待审核的记录。</p>
<p>2、课程审核</p>
<p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。</p>
<p>如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。</p>
<p>如果课程内容没有违规信息且课程内容全面则审核通过。</p>
<p>课程审核通过后教学机构发布课程成功。</p>
<h3 id="1-2-3-课程发布"><a href="#1-2-3-课程发布" class="headerlink" title="1.2.3 课程发布"></a><strong>1.2.3</strong> <strong>课程发布</strong></h3><p>1.<strong>教育机构用户</strong>在课程管理中可对机构内课程进行检索。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711263841607101.gif" alt="img"></p>
<p>2.点击某课程数据后的 发布 链接（审核状态为通过），即可对该课程进行发布。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711263841607103.gif" alt="img"></p>
<p>3、课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711263841607104.gif" alt="img"></p>
<p>4 点击课程搜索页中课程列表的某个课程，可进入课程详情页。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image021-1711263841607105.gif" alt="img"></p>
<h1 id="2-课程预览"><a href="#2-课程预览" class="headerlink" title="2 课程预览"></a><strong>2</strong> <strong>课程预览</strong></h1><h2 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a><strong>2.1</strong> <strong>需求分析</strong></h2><p>课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711263841607106.gif" alt="img"></p>
<p>下图是课程预览的数据来源：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image024-1711263841607107.gif" alt="img"></p>
<p>在课程预览页面点击”视频播放图片”打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image026-1711263841607108.gif" alt="img"></p>
<p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的流程图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image028-1711263841607109.gif" alt="img"></p>
<p>说明如下：</p>
<p>1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。</p>
<p>2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。</p>
<p>3、通过课程预览页面点击”马上学习“打开视频播放页面。</p>
<p>4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资服务查询课程计划绑定的视频文件地址，在线浏览播放视频。</p>
<h2 id="2-2-模板引擎"><a href="#2-2-模板引擎" class="headerlink" title="2.2 模板引擎"></a><strong>2.2</strong> <strong>模板引擎</strong></h2><h3 id="2-2-1-什么是模板引擎"><a href="#2-2-1-什么是模板引擎" class="headerlink" title="2.2.1 什么是模板引擎"></a><strong>2.2.1</strong> <strong>什么是模板引擎</strong></h3><p>根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致。</p>
<p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p>
<p>早期我们采用的jsp技术就是一种模板引擎技术，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image030-1711263841607110.gif" alt="img"></p>
<p>1、浏览器请求web服务器</p>
<p>2、服务器渲染页面，渲染的过程就是向jsp页面(模板)内填充数据(模型)。</p>
<p>3、服务器将渲染生成的页面返回给浏览器。</p>
<p>所以模板引擎就是：模板+数据&#x3D;输出，Jsp页面就是模板，页面中嵌入的jsp标签就是数据，两者相结合输出html网页。</p>
<p>常用的java模板引擎还有哪些？</p>
<p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p>
<p>本项目采用Freemarker作为模板引擎技术。</p>
<p>Freemarker官方地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></p>
<p>FreeMarker 是一款 <em>模板引擎</em>： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。FreeMarker 是 <a target="_blank" rel="noopener" href="http://www.fsf.org/philosophy/free-sw.html">免费的</a>， 基于Apache许可证2.0版本发布。</p>
<h3 id="2-2-2-Freemarker快速入门"><a href="#2-2-2-Freemarker快速入门" class="headerlink" title="2.2.2 Freemarker快速入门"></a><strong>2.2.2 Freemarker快速入门</strong></h3><p>下边在内容管理接口层搭建Freemarker的运行环境并进行测试。</p>
<p>在内容管理接口工层 添加Freemarker与SpringBoot的整合包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在nacos为内容管理接口层配置freemarker，公用配置组新加一个freemarker-config-dev.yaml</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711263841607111.gif" alt="img"></p>
<p>配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span>   <span class="comment">#关闭模板缓存，方便测试</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">template_update_delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span>   <span class="comment">#页面模板后缀名</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/templates/</span>   <span class="comment">#页面模板位置(默认为 classpath:/templates/)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span></span><br></pre></td></tr></table></figure>

<p>在内容管理接口工程添加freemarker-config-dev.yaml</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image034-1711263841607112.gif" alt="img"></p>
<p>添加模板，在resources下创建templates目录，添加test.ftl模板文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Hello $&#123;name&#125;!</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写controller方法，准备模型数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.math.raw.Mod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> freemarker测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/15 19:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testfreemarker&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        <span class="comment">//设置模型数据</span></span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;小明&quot;</span>);</span><br><span class="line">        <span class="comment">//设置模板名称</span></span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/testfreemarker">http://localhost:63040/content/testfreemarker</a></p>
<p>屏幕输出：Hello 小明！</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image036-1711263841607113.gif" alt="img"></p>
<p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p>
<h2 id="2-3-测试静态页面"><a href="#2-3-测试静态页面" class="headerlink" title="2.3 测试静态页面"></a><strong>2.3</strong> <strong>测试静态页面</strong></h2><h3 id="2-3-1-部署网站门户"><a href="#2-3-1-部署网站门户" class="headerlink" title="2.3.1 部署网站门户"></a><strong>2.3.1</strong> <strong>部署网站门户</strong></h3><p>在课程预览界面上要加载css、js、图片等内容，这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image038-1711263841607114.gif" alt="img"></p>
<p>1、在本机安装 Nginx ，从课程资料目录获取nginx-1.23.1.zip并解压。</p>
<p>2、运行nginx-1.23.1目录下的nginx.exe。</p>
<p>默认端口为80，如果本机80端口被占用，则需要杀掉占用进程后再启动nginx。</p>
<p>如果无法杀掉80端口占用进程则需要修改nginx-1.23.1目录下conf&#x2F;nginx.conf配置文件</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image040-1711263841607115.gif" alt="img"></p>
<p>将80端口修改为空闲端口。</p>
<p>启动nginx，访问<a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a> 出现下边的网页表示启动成功</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image042-1711263841607116.gif" alt="img"></p>
<p>下边开始部署前端工程：</p>
<p>1、从课程资料目录获取xc-ui-pc-static-portal.zip 并解压。</p>
<p>2、修改本机hosts文件，加入127.0.0.1 <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">www.51xuecheng.cn</a> 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn。</p>
<p>window10操作系统hosts文件在C:\Windows\System32\drivers\etc下</p>
<p>Centos7操作系统的hosts文件在&#x2F;etc目录下。</p>
<p>在hosts文件加入如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn</span><br></pre></td></tr></table></figure>

<p>3、在nginx-1.23.1目录中找到conf目录，配置目录下的nginx.conf文件。</p>
<p>配置内容如下，注意更改xc-ui-pc-static-portal目录的路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  www.51xuecheng.cn localhost;</span><br><span class="line">    #rewrite ^(.*) https:<span class="comment">//$server_name$1 permanent;</span></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    #静态资源</span><br><span class="line">        location /<span class="keyword">static</span>/img/ &#123;  </span><br><span class="line">        alias  E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/img/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /<span class="keyword">static</span>/css/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/css/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /<span class="keyword">static</span>/js/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/js/;</span><br><span class="line">    &#125; </span><br><span class="line">    location /<span class="keyword">static</span>/plugins/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/plugins/;</span><br><span class="line">        add_header Access-Control-Allow-Origin http:<span class="comment">//ucenter.51xuecheng.cn;  </span></span><br><span class="line">        add_header Access-Control-Allow-Credentials <span class="literal">true</span>;  </span><br><span class="line">        add_header Access-Control-Allow-Methods GET;</span><br><span class="line">    &#125; </span><br><span class="line">    location /plugins/ &#123;  </span><br><span class="line">        alias   E:/<span class="keyword">module</span>/xuecheng/xc-ui-pc-<span class="keyword">static</span>-portal/xc-ui-pc-<span class="keyword">static</span>-portal/plugins/;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #error_page  <span class="number">404</span>              /<span class="number">404.</span>html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the <span class="keyword">static</span> page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">80</span></span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http:<span class="comment">//127.0.0.1;</span></span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span></span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9000</span>;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, <span class="keyword">if</span> Apache<span class="string">&#x27;s document root</span></span><br><span class="line"><span class="string">        # concurs with nginx&#x27;</span>s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动nginx:</p>
<p>进入任务管理器，杀死nginx的两个进程</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image044-1711263841607117.gif" alt="img"></p>
<p>杀死后再次双击nginx.exe。</p>
<p>启动成功在任务管理器会出现nginx的进程。</p>
<p>日志文件在nginx安装目录下的logs目录：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image046-1711263841607118.gif" alt="img"></p>
<p>启动成功访问<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">http://www.51xuecheng.cn</a> </p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image048-1711263841607119.gif" alt="img"></p>
<h3 id="2-3-2-课程详情页面"><a href="#2-3-2-课程详情页面" class="headerlink" title="2.3.2 课程详情页面"></a><strong>2.3.2</strong> <strong>课程详情页面</strong></h3><p>course_template.html是一个静态html页面，里边还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容。</p>
<p>course_template.html文件在xc-ui-pc-static-portal\course目录下</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image050-1711263841607120.gif" alt="img"></p>
<p>通过浏览器访问：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/course_template.html">http://www.51xuecheng.cn/course/course_template.html</a></p>
<p>效果如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image052-1711263841607121.gif" alt="img"></p>
<p>出现这个画面说明模板文件正常浏览是没有问题的。</p>
<h3 id="2-3-3-文件服务器"><a href="#2-3-3-文件服务器" class="headerlink" title="2.3.3 文件服务器"></a><strong>2.3.3</strong> <strong>文件服务器</strong></h3><p>在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问。如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image054-1711263841607122.gif" alt="img"></p>
<p>在hosts文件配置如下内容，如果已存在不要重复配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> www.51xuecheng.cn file.51xuecheng.cn</span><br></pre></td></tr></table></figure>

<p>在nginx.conf中配置文件服务器的代理地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#文件服务</span><br><span class="line">    upstream fileserver&#123;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span>:<span class="number">9000</span> weight=<span class="number">10</span>;</span><br><span class="line">&#125; </span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  file.51xuecheng.cn;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line">    location /video &#123;</span><br><span class="line">        proxy_pass   http:<span class="comment">//fileserver;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /mediafiles &#123;</span><br><span class="line">        proxy_pass   http:<span class="comment">//fileserver;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完毕，重新加载nginx配置文件。</p>
<p>通过cmd进入nginx.exe所在目录,运行如下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure>

<p>通过<a target="_blank" rel="noopener" href="http://file.51xuecheng.cn/mediafiles/%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80">http://file.51xuecheng.cn/mediafiles/图片文件地址</a> 访问图片</p>
<p>在媒资数据库的文件表中找一个图片的地址进行测试。</p>
<h3 id="2-3-4-视频播放页面"><a href="#2-3-4-视频播放页面" class="headerlink" title="2.3.4 视频播放页面"></a><strong>2.3.4</strong> <strong>视频播放页面</strong></h3><p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image056-1711263841607123.gif" alt="img"></p>
<p>首先在nginx.conf中配置视频播放页面的地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /course/preview/learning.html &#123;</span><br><span class="line">    alias D:/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-<span class="keyword">static</span>-portal/course/learning.html;</span><br><span class="line">&#125; </span><br><span class="line">location /course/search.html &#123;  </span><br><span class="line">    root   D:/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-<span class="keyword">static</span>-portal;</span><br><span class="line">&#125; </span><br><span class="line">location /course/learning.html &#123;  </span><br><span class="line">    root   D:/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-<span class="keyword">static</span>-portal;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>加载nginx配置文件</p>
<p>点击课程详情页面上的视频播放链接，打开视频播放页面，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image057-1711263841607124.gif" alt="img"></p>
<p>下边需要配置learning.html页面的视频播放路径来测试视频播放页面，找到learning.html页面中videoObject对象的定义处，配置视频的播放地址。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image059-1711263841607126.gif" alt="img"></p>
<p>配置完成，刷新页面，观察视频是否可以正常播放。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image061-1711263841607125.gif" alt="img"></p>
<p>注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。</p>
<h2 id="2-4-接口定义"><a href="#2-4-接口定义" class="headerlink" title="2.4 接口定义"></a><strong>2.4</strong> <strong>接口定义</strong></h2><h3 id="2-4-1-定义课程预览接口"><a href="#2-4-1-定义课程预览接口" class="headerlink" title="2.4.1 定义课程预览接口"></a><strong>2.4.1</strong> <strong>定义课程预览接口</strong></h3><p>课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器。</p>
<p>下边对课程预览接口进行分析：</p>
<p>1、请求参数</p>
<p>传入课程id，表示要预览哪一门课程。</p>
<p>2、响应结果</p>
<p>输出课程详情页面到浏览器。</p>
<p>响应页面到浏览器使用freemarker模板引擎技术实现，首先从课程资料目录下获取课程预览页面course_template.html，拷贝至内容管理的接口工程的resources&#x2F;templates下，并将其在本目录复制一份命名为course_template.ftl</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711268014348159.gif" alt="img"></p>
<p>下边开始定义接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览，发布</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> ModelAndView <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">      modelAndView.addObject(<span class="string">&quot;model&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">      modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> modelAndView;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/coursepreview/74">http://localhost:63040/content/coursepreview/74</a></p>
<p>如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711268014348160.gif" alt="img"></p>
<p>课程预览页面内容没有样式，稍后解决这个问题。</p>
<h3 id="2-4-2-配置反向代理"><a href="#2-4-2-配置反向代理" class="headerlink" title="2.4.2 配置反向代理"></a><strong>2.4.2</strong> <strong>配置反向代理</strong></h3><p>课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711268014348161.gif" alt="img"></p>
<p>这些静态资源全在门户下，我们需要由Nginx反向代理访问课程预览接口，通过门户的URL去访问课程预览。</p>
<p>1、在Nginx下配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#后台网关</span><br><span class="line">    upstream gatewayserver&#123;</span><br><span class="line">    server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">63010</span> weight=<span class="number">10</span>;</span><br><span class="line">&#125; </span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  www.51xuecheng.cn localhost;</span><br><span class="line">    ....</span><br><span class="line">        #api</span><br><span class="line">        location /api/ &#123;</span><br><span class="line">        proxy_pass http:<span class="comment">//gatewayserver/;</span></span><br><span class="line">    &#125; </span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>

<p>2、重新加载Nginx配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure>



<p>3、启动微服务网关</p>
<p>4、此时访问新地址： <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/74">http://www.51xuecheng.cn/api/content/coursepreview/74</a> </p>
<p>输出如下，页面样式正常。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711268014348163.gif" alt="img"></p>
<p>页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用service方式获取模型数据并进行页面渲染。</p>
<p>目前的方式是通过Nginx访问网关，由网关再将请求转发到微服务，Nginx是整个的项目最前方的代理服务器，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711268014348162.gif" alt="img"></p>
<h2 id="2-5-接口开发"><a href="#2-5-接口开发" class="headerlink" title="2.5 接口开发"></a><strong>2.5</strong> <strong>接口开发</strong></h2><h3 id="2-5-1-数据模型"><a href="#2-5-1-数据模型" class="headerlink" title="2.5.1 数据模型"></a><strong>2.5.1</strong> <strong>数据模型</strong></h3><p>课程预览就是把课程基本信息、营销信息、课程计划、师资等课程的相关信息进行整合，在预览页面进行展示。如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711268014348164.gif" alt="img"></p>
<p>在使用freemarker渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。</p>
<p>所以首先定义一个数据模型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览数据模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"> <span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePreviewDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程基本信息,课程营销信息</span></span><br><span class="line">    CourseBaseInfoDto courseBase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程计划信息</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplans;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//师资信息暂时不加...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CourseBaseInfoDto：包括了课程基本信息、营销信息。</p>
<p>List&lt;TeachplanDto&gt; ：包括了课程计划列表。</p>
<h3 id="2-5-2-Service接口"><a href="#2-5-2-Service接口" class="headerlink" title="2.5.2 Service接口"></a><strong>2.5.2 Service接口</strong></h3><p>Service负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成CoursePreviewDto 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览、发布接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:59</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoursePublishService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 获取课程预览信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CoursePreviewDto</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/16 15:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">   <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePreviewInfo</span><span class="params">(Long courseId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseBaseInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.TeachplanService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 15:37</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CoursePublishService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> TeachplanService teachplanService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePreviewInfo</span><span class="params">(Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程基本信息、营销信息</span></span><br><span class="line">  <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程计划信息</span></span><br><span class="line">  List&lt;TeachplanDto&gt; teachplanTree= teachplanService.findTeachplanTree(courseId);</span><br><span class="line"></span><br><span class="line">  <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDto</span>();</span><br><span class="line">  coursePreviewDto.setCourseBase(courseBaseInfo);</span><br><span class="line">  coursePreviewDto.setTeachplans(teachplanTree);</span><br><span class="line">  <span class="keyword">return</span> coursePreviewDto;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-3-接口层完善"><a href="#2-5-3-接口层完善" class="headerlink" title="2.5.3 接口层完善"></a><strong>2.5.3</strong> <strong>接口层完善</strong></h3><p>接口层Controller调用Service方法获取模板引擎需要的模型数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//获取课程预览信息</span></span><br><span class="line">     <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line"></span><br><span class="line">     <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">     modelAndView.addObject(<span class="string">&quot;model&quot;</span>,coursePreviewInfo);</span><br><span class="line">     modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> modelAndView;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-4-前后端联调"><a href="#2-5-4-前后端联调" class="headerlink" title="2.5.4 前后端联调"></a><strong>2.5.4</strong> <strong>前后端联调</strong></h3><p>原来前端直接指向后台网关地址，现在要更改为Nginx的地址，如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711268014348165.gif" alt="img"></p>
<p>重启前端工程，进入课程列表点击”预览”按钮，正常打开课程预览页面<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/2">http://www.51xuecheng.cn/api/content/coursepreview/2</a></p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711268014348166.gif" alt="img"></p>
<h3 id="2-5-5-编写模板"><a href="#2-5-5-编写模板" class="headerlink" title="2.5.5 编写模板"></a><strong>2.5.5</strong> <strong>编写模板</strong></h3><p>模型数据准备好后下一步将模型数据填充到course_template.ftl上，填充时注意不要一次填充太多，一边填充一边刷新调试。</p>
<p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p>
<p>修改模板后需要编译，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711268014348167.gif" alt="img"></p>
<p>在调试模板时，可以看出哪些信息有缺少，在课程管理处进行补充，比如下图显示课程计划信息不完整，需要进入课程计划界面添加课程计划。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711268014348168.gif" alt="img"></p>
<p>完整的course_template.ftl模板在课程资料目录下，差不多学会了freemarker标签的使用方法，将课程资料下的course_template.ftl覆盖自己的工程下的course_template.ftl。</p>
<h3 id="2-5-6-视频播放页面接口"><a href="#2-5-6-视频播放页面接口" class="headerlink" title="2.5.6 视频播放页面接口"></a><strong>2.5.6</strong> <strong>视频播放页面接口</strong></h3><p>从课程详情页面进入视频播放页面，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711268014348169.gif" alt="img"></p>
<p>在此页面需要从后台获取课程信息、根据课程计划获取对应的视频地址，下边编写这两个接口：</p>
<p>获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/open/content/course/whole/课程id</span><br><span class="line"></span><br><span class="line">响应：同课程预览service接口返回数据</span><br></pre></td></tr></table></figure>

<p>根据课程计划获取视频地址接口：&#x2F;open&#x2F;media&#x2F;preview&#x2F;{mediaId}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/open/media/preview/课程计划id</span><br><span class="line"></span><br><span class="line">响应：</span><br><span class="line">&#123;&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;,&quot;result&quot;:&quot;视频的url&quot;,&quot;successful&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>1、在nginx配置如下地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#openapi</span></span><br><span class="line">location /open/content/ &#123;</span><br><span class="line">        proxy_pass http://gatewayserver/content/open/;</span><br><span class="line">&#125; </span><br><span class="line">location /open/media/ &#123;</span><br><span class="line">        proxy_pass http://gatewayserver/media/open/;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p>配置运行nginx.exe -s reload加载nginx的配置文件 </p>
<p>2、在内容管理接口层定义CourseOpenController类，并定义接口：获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程公开查询接口&quot;,tags = &quot;课程公开查询接口&quot;)</span></span><br><span class="line"> <span class="meta">@RestController</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseOpenController</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CoursePreviewDto <span class="title function_">getPreviewInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">//获取课程预览信息</span></span><br><span class="line">    <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line">    <span class="keyword">return</span> coursePreviewInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、在媒资管理服务media-api工程定义MediaOpenController类，并定义接口&#x2F;open&#x2F;media&#x2F;preview&#x2F;</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;媒资文件管理接口&quot;,tags = &quot;媒资文件管理接口&quot;)</span></span><br><span class="line"> <span class="meta">@RestController</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaOpenController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  MediaFileService mediaFileService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;预览文件&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFileService.getFileById(mediaId);</span><br><span class="line">        <span class="keyword">if</span>(mediaFiles == <span class="literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl()))&#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;视频还没有转码处理&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(mediaFiles.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、测试</p>
<p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p>
<h1 id="3-课程审核"><a href="#3-课程审核" class="headerlink" title="3 课程审核"></a><strong>3</strong> <strong>课程审核</strong></h1><h2 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a><strong>3.1</strong> <strong>需求分析</strong></h2><h3 id="3-1-1-业务流程"><a href="#3-1-1-业务流程" class="headerlink" title="3.1.1 业务流程"></a><strong>3.1.1</strong> <strong>业务流程</strong></h3><p>根据模块需求分析，课程发布前要先审核，审核通过方可发布。下图是课程审核及发布的流程图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711273702556181.gif" alt="img"></p>
<p>为什么课程审核通过才可以发布呢？</p>
<p>这样做为了防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。</p>
<p>如何控制课程审核通过才可以发布课程呢？</p>
<p>在课程基本表course_base表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。</p>
<p>下边是课程状态的转化关系：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711273702556182.gif" alt="img"></p>
<p>说明如下：</p>
<p>1、一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。</p>
<p>2、课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。</p>
<p>3、当课程状态为已提交时运营平台人员对课程进行审核。</p>
<p>4、运营平台人员审核课程，结果有两个：审核通过、审核不通过。</p>
<p>5、课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。</p>
<p>6、课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。</p>
<p>7、课程发布后通过”下架“操作可以更改课程发布状态为”下架“</p>
<p>8、课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。</p>
<h3 id="3-1-2-数据模型"><a href="#3-1-2-数据模型" class="headerlink" title="3.1.2 数据模型"></a><strong>3.1.2</strong> <strong>数据模型</strong></h3><p>通过业务流程的分析，现在我们思考：</p>
<p>1、课程提交审核后还允许修改课程吗？</p>
<p>如果不允许修改是不合理的，因为提交审核后可以继续做下一个阶段的课程内容，比如添加课程计划，上传课程视频等。</p>
<p>如果允许修改那么课程审核时看到的课程内容从哪里来？如果也从课程基本信息表、课程营销表、课程计划表查询那么存在什么问题呢？如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711273702556184.gif" alt="img"></p>
<p>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突。比如：运营人员正在审核时教学机构把数据修改了。</p>
<p>为了解决这个问题，专门设计<strong>课程预发布表</strong>。</p>
<p>如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711273702556183.gif" alt="img"></p>
<p>提交课程审核，将课程信息汇总后写入课程预发布表，课程预发布表记录了教学机构在某个时间点要发布的课程信息。</p>
<p>课程审核人员从预发布表查询信息进行审核。</p>
<p>课程审核的同时可以对课程进行修改，修改的内容不会写入课程预发布表。</p>
<p>课程审核通过执行课程发布，将课程预发布表的信息写入课程发布表。</p>
<p>2、提交审核课程后，也修改了课程信息，可以再次提交审核吗？</p>
<p>这个问题在上边分析课程审核状态时已经有了答案，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711273702556185.gif" alt="img"></p>
<p><strong>提交审核课程后，必须等到课程审核完成才可以再次提交课程。</strong></p>
<p>课程审核功能涉及教学机构提交审核，运营人员进行课程审核。在课堂上我们仅实现教学机构提交审核功能，课程审核的结果通过手动修改数据库来实现。</p>
<p>虽然课堂上不实现课程审核功能，完整的课程审核数据表设计需要理解。</p>
<p>提交审核将信息写入课程预发布表，课程预发布表结构如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711273702556186.gif" alt="img"></p>
<p>更新课程基本信息表的课程审核状态为：已经提交</p>
<p>课程审核后更新课程基本信息表的审核状态、课程预发布表的审核状态，并将审核结果写入课程审核记录。</p>
<p>审核记录表结构如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711273702556187.gif" alt="img"></p>
<h2 id="3-2-接口定义"><a href="#3-2-接口定义" class="headerlink" title="3.2 接口定义"></a><strong>3.2</strong> <strong>接口定义</strong></h2><p>下边定义提交课程审核的接口，在课程发布Controller中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/courseaudit/commit/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-3-接口开发"><a href="#3-3-接口开发" class="headerlink" title="3.3 接口开发"></a><strong>3.3</strong> <strong>接口开发</strong></h2><h3 id="3-3-1-Dao开发"><a href="#3-3-1-Dao开发" class="headerlink" title="3.3.1 Dao开发"></a><strong>3.3.1 Dao开发</strong></h3><p>1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。</p>
<p>2、向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态为：已提交。</p>
<p>3、更新课程基本表course_base课程审核状态为：已提交。</p>
<p>约束：</p>
<p>1、对已提交审核的课程不允许提交审核。</p>
<p>2、本机构只允许提交本机构的课程。</p>
<p>3、没有上传图片不允许提交审核。</p>
<p>4、没有添加课程计划不允许提交审核。</p>
<p>使用代码生成器生成课程发布表、课程预发布表的PO、Mpper，并拷贝到相应的工程下。</p>
<h3 id="3-3-1-Service开发"><a href="#3-3-1-Service开发" class="headerlink" title="3.3.1 Service开发"></a><strong>3.3.1 Service开发</strong></h3><p>在课程发布Service类中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 提交审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/18 10:31</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId,Long courseId)</span>;</span><br></pre></td></tr></table></figure>



<p>接口实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//约束校验</span></span><br><span class="line"> <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line"> <span class="comment">//课程审核状态</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> courseBase.getAuditStatus();</span><br><span class="line"> <span class="comment">//当前审核状态为已提交不允许再次提交</span></span><br><span class="line"> <span class="keyword">if</span>(<span class="string">&quot;202003&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;当前为等待审核状态，审核完成可以再次提交。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line"> <span class="keyword">if</span>(!courseBase.getCompanyId().equals(companyId))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//课程图片是否填写</span></span><br><span class="line"> <span class="keyword">if</span>(StringUtils.isEmpty(courseBase.getPic()))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;提交失败，请上传课程图片&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//添加课程预发布记录</span></span><br><span class="line"> <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublishPre</span>();</span><br><span class="line"> <span class="comment">//课程基本信息加部分营销信息</span></span><br><span class="line"> <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line"> BeanUtils.copyProperties(courseBaseInfo,coursePublishPre);</span><br><span class="line"> <span class="comment">//课程营销信息</span></span><br><span class="line"> <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line"> <span class="comment">//转为json</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">courseMarketJson</span> <span class="operator">=</span> JSON.toJSONString(courseMarket);</span><br><span class="line"> <span class="comment">//将课程营销信息json数据放入课程预发布表</span></span><br><span class="line"> coursePublishPre.setMarket(courseMarketJson);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//查询课程计划信息</span></span><br><span class="line"> List&lt;TeachplanDto&gt; teachplanTree = teachplanService.findTeachplanTree(courseId);</span><br><span class="line"> <span class="keyword">if</span>(teachplanTree.size()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;提交失败，还没有添加课程计划&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//转json</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">teachplanTreeString</span> <span class="operator">=</span> JSON.toJSONString(teachplanTree);</span><br><span class="line"> coursePublishPre.setTeachplan(teachplanTreeString);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//设置预发布记录状态,已提交</span></span><br><span class="line"> coursePublishPre.setStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line"> <span class="comment">//教学机构id</span></span><br><span class="line"> coursePublishPre.setCompanyId(companyId);</span><br><span class="line"> <span class="comment">//提交时间</span></span><br><span class="line"> coursePublishPre.setCreateDate(LocalDateTime.now());</span><br><span class="line"> <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPreUpdate</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line"> <span class="keyword">if</span>(coursePublishPreUpdate == <span class="literal">null</span>)&#123;</span><br><span class="line">  <span class="comment">//添加课程预发布记录</span></span><br><span class="line">  coursePublishPreMapper.insert(coursePublishPre);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  coursePublishPreMapper.updateById(coursePublishPre);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//更新课程基本表的审核状态</span></span><br><span class="line"> courseBase.setAuditStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line"> courseBaseMapper.updateById(courseBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-接口完善"><a href="#3-4-接口完善" class="headerlink" title="3.4 接口完善"></a><strong>3.4</strong> <strong>接口完善</strong></h2><p>完善接口层的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/courseaudit/commit/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line">     <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">     coursePublishService.commitAudit(companyId,courseId);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-5-接口测试"><a href="#3-5-接口测试" class="headerlink" title="3.5 接口测试"></a><strong>3.5</strong> <strong>接口测试</strong></h2><p>使用前端提前课程审核：</p>
<p>1、找一门信息不全的课程，测试各各约束条件。</p>
<p>2、正常提交后，观察数据库中课程预发布表记录的内容是否完整。</p>
<p>3、测试审核过后再次提交，提交后观察数据库中课程预发布表记录的内容是否正确。</p>
<p>审核通过需手动修改数据库：</p>
<p>1、修改课程预发布表的状态为审核通过202004。</p>
<p>2、修改课程基本表的审核状态为审核通过202004。</p>
<h1 id="4-课程发布"><a href="#4-课程发布" class="headerlink" title="4 课程发布"></a><strong>4</strong> <strong>课程发布</strong></h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a><strong>4.1</strong> <strong>需求分析</strong></h2><h3 id="4-1-1-数据模型"><a href="#4-1-1-数据模型" class="headerlink" title="4.1.1 数据模型"></a><strong>4.1.1</strong> <strong>数据模型</strong></h3><p>教学机构人员在课程审核通过后即可发布课程，课程发布后会公开展示在网站上供学生查看、选课和学习。</p>
<p>在网站上展示课程信息需要解决课程信息显示的性能问题，如果速度慢(排除网速)会影响用户的体验性。</p>
<p>如何去快速搜索课程？</p>
<p>打开课程详情页面仍然去查询数据库可行吗？</p>
<p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image002-1711291285108197.gif" alt="img"></p>
<p>1、向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表中发布状态为已发布。</p>
<p>2、向Redis存储课程缓存信息。</p>
<p>3、向Elasticsearch存储课程索引信息。</p>
<p>4、请求分布文件系统存储课程静态化页面(即html页面)，实现快速浏览课程详情页面。</p>
<p>课程发布表的数据来源于课程预发布表，它们的结构基本一样，只是课程发布表中的状态是课程发布状态，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image004-1711291285108195.gif" alt="img"></p>
<p>redis中的课程缓存信息是将课程发布表中的数据转为json进行存储。</p>
<p>elasticsearch中的课程索引信息是根据搜索需要将课程名称、课程介绍等信息进行索引存储。</p>
<p>MinIO中存储了课程的静态化页面文件（html网页），查看课程详情是通过文件系统去浏览课程详情页面。</p>
<h2 id="4-2-分布式事务技术方案"><a href="#4-2-分布式事务技术方案" class="headerlink" title="4.2 分布式事务技术方案"></a><strong>4.2</strong> <strong>分布式事务技术方案</strong></h2><h3 id="4-2-1-什么是分布式事务"><a href="#4-2-1-什么是分布式事务" class="headerlink" title="4.2.1 什么是分布式事务"></a><strong>4.2.1</strong> <strong>什么是分布式事务</strong></h3><p>一次课程发布操作需要向数据库、redis、elasticsearch、MinIO写四份数据，这里存在分布式事务问题。</p>
<p>什么是分布式事务？</p>
<p>首先理解什么是本地事务？</p>
<p>平常我们在程序中通过spring去控制事务是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，此数据库只属于该应用，所以基于本应用自己的关系型数据库的事务又被称为本地事务。 </p>
<p>本地事务具有ACID四大特性，数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作 要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。 </p>
<p>理解了本地事务，什么是分布式事务？</p>
<p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p>
<p>在分布式系统中分布式事务的场景很多：</p>
<p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p>
<p>拿转账举例：</p>
<p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line"><span class="comment">//1.本地数据库操作：张三减少金额 </span></span><br><span class="line"><span class="comment">//2.本地数据库操作：李四增加金额 </span></span><br><span class="line">commit transation; </span><br></pre></td></tr></table></figure>

<p>但是在分布式环境下，会变成下边这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line"><span class="comment">//1.本地数据库操作：张三减少金额 </span></span><br><span class="line"><span class="comment">//2.远程调用：让李四增加金额 </span></span><br><span class="line">commit transation;</span><br></pre></td></tr></table></figure>

<p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。 </p>
<p>因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应 用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。 </p>
<p>下边的场景都会产生分布式事务：</p>
<p>微服务架构下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image006-1711291285108196.gif" alt="img"></p>
<p>单服务多数据库：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image008-1711291285108198.gif" alt="img"></p>
<p>多服务单数据库:</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image010-1711291285108199.gif" alt="img"></p>
<h3 id="4-2-2-什么是CAP理论"><a href="#4-2-2-什么是CAP理论" class="headerlink" title="4.2.2 什么是CAP理论"></a><strong>4.2.2</strong> <strong>什么是CAP理论</strong></h3><p>控制分布式事务首先需要理解CAP理论，什么是CAP理论？</p>
<p>CAP是 Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p>
<p>使用下边的分布式系统结构 进行说明：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image012-1711291285108205.gif" alt="img"></p>
<p>客户端经过网关访问用户服务的两个结点，一致性是指用户不管访问哪一个结点拿到的数据都是最新的，比如查询小明的信息，不能出现在数据没有改变的情况下两次查询结果不一样。</p>
<p>可用性是指任何时候查询用户信息都可以查询到结果，但不保证查询到最新的数据。</p>
<p>分区容忍性也叫分区容错性，当系统采用分布式架构时由于网络通信异常导致请求中断、消息丢失，但系统依然对外提供服务。</p>
<p>CAP理论要强调的是在分布式系统中这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。</p>
<p>满足P那么C和A不能同时满足：</p>
<p>比如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image014-1711291285108200.gif" alt="img"></p>
<p>如果要满足C一致性，必须等待小明的信息同步完成系统才可用（否则会出现请求到结点2时查询不到数据，违反了一致性），在信息同步过程中系统是不可用的，所以满足C的同时无法满足A。</p>
<p>如果要满足A可用性，要时刻保证系统可用就不用等待信息同步完成，此时系统的一致性无法满足。</p>
<p>所以在分布式系统中进行分布式事务控制，要么保证CP、要么保证AP。</p>
<h3 id="4-2-3-分布式事务控制方案"><a href="#4-2-3-分布式事务控制方案" class="headerlink" title="4.2.3 分布式事务控制方案"></a><strong>4.2.3</strong> <strong>分布式事务控制方案</strong></h3><p>学习了CAP理论该如何控制分布式事务呢？</p>
<p>学习了CAP理论我们知道进行分布式事务控制要在C和A中作出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要CP还是AP，具体要根据应用场景进行判断。</p>
<p>CP的场景：满足C舍弃A，强调一致性。</p>
<p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p>
<p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p>
<p>AP的场景：满足A舍弃C，强调可用性。</p>
<p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p>
<p>注册送积分，注册成功积分在24分到账。</p>
<p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p>
<p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了BASE理论。</p>
<p>什么是BASE理论？</p>
<p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。</p>
<p>基本可用：当系统无法满足全部可用时保证核心服务可用即可，比如一个外卖系统，每到中午12点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p>
<p>软状态：是指可以存在中间状态，比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在XXX时间后查收。虽然出现了中间状态，但最终状态是正确的。</p>
<p>最终一致性：退款操作后没有及时到账，经过一定的时间后账户到账，舍弃强一致性，满足最终一致性。</p>
<p>分布式事务控制有哪些常用的技术方案？</p>
<p>实现CP就是要实现强一致性:</p>
<p>使用Seata框架基于AT模式实现</p>
<p>使用Seata框架基于TCC模式实现。</p>
<p>实现AP则要保证最终数据一致性:</p>
<p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p>
<p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到elasticsearch、MinIO、redis中。</p>
<h3 id="4-2-4-课程发布的事务控制方案"><a href="#4-2-4-课程发布的事务控制方案" class="headerlink" title="4.2.4 课程发布的事务控制方案"></a><strong>4.2.4</strong> <strong>课程发布的事务控制方案</strong></h3><p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO写四份数据，这个场景用哪种方案？</p>
<p>满足CP？</p>
<p>如果要满足CP就表示课程发布操作后向数据库、redis、elasticsearch、MinIO写四份数据，只要有一份写失败其它的全部回滚。</p>
<p>满足AP？</p>
<p>课程发布操作后，先更新数据库中的课程发布状态，更新后向redis、elasticsearch、MinIO写课程信息，只要在一定时间内最终向redis、elasticsearch、MinIO写数据成功即可。</p>
<p>目前我们已经有了任务调度的技术积累，这里选用任务调度的方案去实现分布式事务控制，课程发布满足AP即可。</p>
<p>下图是具体的技术方案：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image016-1711291285108201.gif" alt="img"></p>
<p>1、在内容管理服务的数据库中添加一个消息表，消息表和课程发布表在同一个数据库。</p>
<p>2、点击课程发布通过本地事务向课程发布表写入课程发布信息，同时向消息表写课程发布的消息。通过数据库进行控制，只要课程发布表插入成功消息表也插入成功，消息表的数据就记录了某门课程发布的任务。</p>
<p>3、启动任务调度系统定时调度内容管理服务去定时扫描消息表的记录。</p>
<p>4、当扫描到课程发布的消息时即开始完成向redis、elasticsearch、MinIO同步数据的操作。</p>
<p>5、同步数据的任务完成后删除消息表记录。</p>
<p>时序图如下：</p>
<p>下图是课程发布操作的流程：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711291285108202.gif" alt="img"></p>
<p>1、执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p>
<p>2、任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p>
<p>3、拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p>
<p>4、任务完成后删除消息表记录。</p>
<h2 id="4-3-课程发布接口"><a href="#4-3-课程发布接口" class="headerlink" title="4.3 课程发布接口"></a><strong>4.3</strong> <strong>课程发布接口</strong></h2><h3 id="4-3-1-接口定义"><a href="#4-3-1-接口定义" class="headerlink" title="4.3.1 接口定义"></a><strong>4.3.1</strong> <strong>接口定义</strong></h3><p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p>
<p>在内容管理接口工程中定义课程发布接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览，发布</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程预览发布接口&quot;,tags = &quot;课程预览发布接口&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishController</span> &#123;</span><br><span class="line">...</span><br><span class="line"> <span class="meta">@ApiOperation(&quot;课程发布&quot;)</span></span><br><span class="line"> <span class="meta">@ResponseBody</span></span><br><span class="line"> <span class="meta">@PostMapping</span> (<span class="string">&quot;/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-接口开发"><a href="#4-3-3-接口开发" class="headerlink" title="4.3.3 接口开发"></a><strong>4.3.3</strong> <strong>接口开发</strong></h3><h4 id="4-3-3-1-DAO开发"><a href="#4-3-3-1-DAO开发" class="headerlink" title="4.3.3.1 DAO开发"></a><strong>4.3.3.1 DAO开发</strong></h4><p>课程发布操作对数据库操作如下：</p>
<p>1、向课程发布表course_publish插入一条记录,记录来源于课程预发布表，如果存在则更新，发布状态为：已发布。</p>
<p>2、更新course_base表的课程发布状态为：已发布</p>
<p>3、删除课程预发布表的对应记录。</p>
<p>4、向mq_message消息表插入一条消息，消息类型为：course_publish</p>
<p>约束：</p>
<p>1、课程审核通过方可发布。</p>
<p>2、本机构只允许发布本机构的课程。</p>
<p>以上功能使用自动生成的mapper接口即可完成。</p>
<p>1、在内容管理数据库创建mq_message消息表及消息历史消息表（历史表存储已经完成的消息）。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image020-1711291285108203.gif" alt="img"></p>
<p>消息表结构如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image022-1711291285108204.gif" alt="img"></p>
<p>2、生成mq_message消息表、course_publish课程发布表的po和mapper接口</p>
<p>稍后会开发一个通用的消息处理组件，这里先不生成代码。</p>
<h4 id="4-3-3-2-Service开发"><a href="#4-3-3-2-Service开发" class="headerlink" title="4.3.3.2 Service开发"></a><strong>4.3.3.2 Service开发</strong></h4><p>定义Service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程发布接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 16:23</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId,Long courseId)</span>;</span><br></pre></td></tr></table></figure>

<p>编写课程发布的Service方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//约束校验</span></span><br><span class="line">  <span class="comment">//查询课程预发布表</span></span><br><span class="line">  <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">     XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line">  <span class="keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;</span><br><span class="line">   XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程审核状态</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line">  <span class="comment">//审核通过方可发布</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="string">&quot;202004&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">   XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//保存课程发布信息</span></span><br><span class="line">  saveCoursePublish(courseId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//保存消息表</span></span><br><span class="line">  saveCoursePublishMessage(courseId);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//删除课程预发布表对应记录</span></span><br><span class="line">  coursePublishPreMapper.deleteById(courseId);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存课程发布信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublish</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">   <span class="comment">//整合课程发布信息</span></span><br><span class="line">  <span class="comment">//查询课程预发布表</span></span><br><span class="line">  <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">   XueChengPlusException.cast(<span class="string">&quot;课程预发布数据为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublish</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//拷贝到课程发布对象</span></span><br><span class="line">  BeanUtils.copyProperties(coursePublishPre,coursePublish);</span><br><span class="line">  coursePublish.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">  <span class="type">CoursePublish</span> <span class="variable">coursePublishUpdate</span> <span class="operator">=</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(coursePublishUpdate == <span class="literal">null</span>)&#123;</span><br><span class="line">   coursePublishMapper.insert(coursePublish);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   coursePublishMapper.updateById(coursePublish);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//更新课程基本表的发布状态</span></span><br><span class="line">  <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">  courseBase.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">  courseBaseMapper.updateById(courseBase);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 保存消息表记录，稍后实现</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublishMessage</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-3-接口完善"><a href="#4-3-3-3-接口完善" class="headerlink" title="4.3.3.3 接口完善"></a><strong>4.3.3.3</strong> <strong>接口完善</strong></h4><p>完善接口层代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程发布&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    coursePublishService.publish(companyId,courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-4-接口测试"><a href="#4-3-4-接口测试" class="headerlink" title="4.3.4 接口测试"></a><strong>4.3.4</strong> <strong>接口测试</strong></h3><p>先使用httpclient方法测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程发布</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/coursepublish/<span class="number">2</span></span><br></pre></td></tr></table></figure>



<p>先测试约束条件：</p>
<p>1、在未提交审核时进行课程发布测试。</p>
<p>2、在课程未审核通过时进行发布。</p>
<p>正常流程测试：</p>
<p>1、提交审核课程</p>
<p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p>
<p>3、执行课程发布</p>
<p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p>
<p>使用前后端联调方式测试。</p>
<h2 id="4-4-消息处理SDK"><a href="#4-4-消息处理SDK" class="headerlink" title="4.4 消息处理SDK"></a><strong>4.4</strong> <strong>消息处理SDK</strong></h2><h3 id="4-4-1-消息模块技术方案"><a href="#4-4-1-消息模块技术方案" class="headerlink" title="4.4.1 消息模块技术方案"></a><strong>4.4.1</strong> <strong>消息模块技术方案</strong></h3><p>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image024-1711291285108208.gif" alt="img"></p>
<p>上图中红色框内的都是与消息处理相关的操作：</p>
<p>1、新增消息表</p>
<p>2、扫描消息表。</p>
<p>3、更新消息表。</p>
<p>4、删除消息表。</p>
<p>使用消息表这种方式实现最终事务一致性的地方除了课程发布还有其它业务场景。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image026-1711291285108206.gif" alt="img"></p>
<p>如果在每个地方都实现一套针对消息表定时扫描、处理的逻辑基本上都是重复的，软件的可复用性太低，成本太高。</p>
<p>如何解决这个问题？</p>
<p>针对这个问题可以想到将消息处理相关的逻辑做成一个通用的东西。</p>
<p>是做成通用的服务，还是做成通用的代码组件呢？</p>
<p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p>
<p>代码组件也是完成一个通用的独立功能，通常会提供API的方式供外部系统使用，比如：fastjson、Apache commons工具包等。</p>
<p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且要提供与微服务通信的网络接口，单就针对当前需求而言开发成本有点高。</p>
<p>如果将消息处理做一个SDK工具包相比通用服务不仅可以解决将消息处理通用化的需求，还可以降低成本。</p>
<p>所以，本项目确定将对消息表相关的处理做成一个SDK组件供各微服务使用,如下图所示：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image028-1711291285108207.gif" alt="img"></p>
<p>下边对消息SDK的设计内容进行说明：</p>
<p>sdk需要提供执行任务的逻辑吗？</p>
<p>拿课程发布任务举例，执行课程发布任务是要向redis、索引库等同步数据，其它任务的执行逻辑是不同的，所以执行任务在sdk中不用实现任务逻辑，只需要提供一个抽象方法由具体的执行任务方去实现。</p>
<p>如何保证任务的幂等性？</p>
<p>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案，任务执行完成后会从消息表删除，如果消息的状态是完成或不存在消息表中则不用执行。</p>
<p>如何保证任务不重复执行？</p>
<p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用分片广播，根据分片参数去获取任务，另外阻塞调度策略为丢弃任务。</p>
<p>注意：这里是信息同步类任务，即使任务重复执行也没有关系，不再使用抢占任务的方式保证任务不重复执行。</p>
<p>还有一个问题，根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，如果一个任务有好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到redis、存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里该如何设计？</p>
<p>将小任务作为任务的不同的阶段，在消息表中设计阶段状态。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image030-1711291285108210.gif" alt="img"></p>
<p>每完成一个阶段在相应的阶段状态字段打上完成标记，即使这个大任务没有完成再重新执行时，如果小阶段任务完成了也不会重复执行某个小阶段的任务。</p>
<p>综上所述，除了消息表的基本的增、删、改、查的接口外，消息SDK还具有如下接口功能：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  服务类</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-09-21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MqMessageService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;MqMessage&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 扫描消息表记录，采用与扫描视频处理表相同的思路</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 扫描记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List 消息记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 18:55</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MqMessage&gt; <span class="title function_">getMessageList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal,  String messageType,<span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 完成任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completed</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 完成阶段任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageOne</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageTwo</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageThree</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageFour</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询阶段状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:54</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageOne</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageTwo</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageThree</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageFour</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>消息SDK提供消息处理抽象类，此抽象类供使用方去继承使用，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息处理抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 19:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqMessage 执行任务内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean true:处理成功，false处理失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 任务处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 19:47</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 扫描消息表多线程执行任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType  消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  一次取出任务总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:35</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal,  String messageType,<span class="type">int</span> count,<span class="type">long</span> timeout)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//扫描消息表获取任务清单</span></span><br><span class="line">            List&lt;MqMessage&gt; messageList = mqMessageService.getMessageList(shardIndex, shardTotal,messageType, count);</span><br><span class="line">            <span class="comment">//任务个数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> messageList.size();</span><br><span class="line">            log.debug(<span class="string">&quot;取出待处理消息&quot;</span>+size+<span class="string">&quot;条&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(size&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建线程池</span></span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">            <span class="comment">//计数器</span></span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">            messageList.forEach(message -&gt; &#123;</span><br><span class="line">                threadPool.execute(() -&gt; &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始任务:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                    <span class="comment">//处理任务</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> execute(message);</span><br><span class="line">                        <span class="keyword">if</span>(result)&#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;)&quot;</span>,message);</span><br><span class="line">                            <span class="comment">//更新任务状态,删除消息表记录,添加到历史表</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">completed</span> <span class="operator">=</span> mqMessageService.completed(message.getId());</span><br><span class="line">                            <span class="keyword">if</span> (completed&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行失败:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        log.debug(<span class="string">&quot;任务出现异常:&#123;&#125;,任务:&#123;&#125;&quot;</span>,e.getMessage(),message);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//计数</span></span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                    log.debug(<span class="string">&quot;结束任务:&#123;&#125;&quot;</span>,message);</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">            countDownLatch.await(timeout,TimeUnit.SECONDS);</span><br><span class="line">            System.out.println(<span class="string">&quot;结束....&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-2-消息模块SDK测试"><a href="#4-4-2-消息模块SDK测试" class="headerlink" title="4.4.2 消息模块SDK测试"></a><strong>4.4.2</strong> <strong>消息模块SDK测试</strong></h3><p>1、在内容管理数据库创建消息表和消息历史表</p>
<p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711291285108209.gif" alt="img"></p>
<p>3、修改test下的bootstrap.yml中的数据库连接</p>
<p>下边测试消息SDK的接口：</p>
<p>1、继承MessageProcessAbstract 抽象类编写任务执行方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息处理测试类，继承MessageProcessAbstract</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 21:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProcessClass</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        log.debug(<span class="string">&quot;开始执行任务:&#123;&#125;&quot;</span>,id);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取出阶段状态</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span>(stageOne&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始执行第一阶段任务&quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> mqMessageService.completedStageOne(id);</span><br><span class="line">            <span class="keyword">if</span>(i&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;完成第一阶段任务&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;无需执行第一阶段任务&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、编写测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 21:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProcessClassTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageProcessClass messageProcessClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;开始执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        messageProcessClass.process(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;test&quot;</span>, <span class="number">5</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;结束执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        Thread.sleep(<span class="number">9000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、准备测试数据，在消息表添加消息类型为”test”的消息</p>
<p>4、执行MessageProcessClassTest 类中的test()方法，观察控制台任务执行的日志信息。</p>
<h3 id="4-4-3-集成消息SDK"><a href="#4-4-3-集成消息SDK" class="headerlink" title="4.4.3 集成消息SDK"></a><strong>4.4.3</strong> <strong>集成消息SDK</strong></h3><h4 id="4-4-3-1-添加消息"><a href="#4-4-3-1-添加消息" class="headerlink" title="4.4.3.1 添加消息"></a><strong>4.4.3.1</strong> <strong>添加消息</strong></h4><p>1、在内容管理数据库创建消息表和消息历史表</p>
<p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image032-1711291285108209.gif" alt="img"></p>
<p>3、在内容管理service工程中添加sdk依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-message-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4、课程发布操作使用本地事务保存课程发布信息、添加消息表。</p>
<p>回到当初编写课程发布时的代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//约束校验</span></span><br><span class="line"> <span class="comment">//查询课程预发布表</span></span><br><span class="line"> <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line"> <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">    XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line"> <span class="keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//课程审核状态</span></span><br><span class="line"> <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line"> <span class="comment">//审核通过方可发布</span></span><br><span class="line"> <span class="keyword">if</span>(!<span class="string">&quot;202004&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//保存课程发布信息</span></span><br><span class="line"> saveCoursePublish(courseId);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//保存消息表</span></span><br><span class="line"> saveCoursePublishMessage(courseId);</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除课程预发布表对应记录</span></span><br><span class="line"> coursePublishPreMapper.deleteById(courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要填充的saveCoursePublishMessage(courseId)方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 保存消息表记录</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublishMessage</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">&quot;course_publish&quot;</span>, String.valueOf(courseId), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span>(mqMessage==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(CommonError.UNKOWN_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边进行测试：</p>
<p>发布一门课程，观察消息表是否正常添加消息。</p>
<p>需要手动修改课程审核状态为审核通过执行发布操作，发布后可以修改发布状态为下架重新发布测试。</p>
<h4 id="4-4-3-2-课程发布任务处理"><a href="#4-4-3-2-课程发布任务处理" class="headerlink" title="4.4.3.2 课程发布任务处理"></a><strong>4.4.3.2</strong> <strong>课程发布任务处理</strong></h4><p>在内容管理服务添加消息处理sdk的依赖即可使用它，实现sdk中的MessageProcessAbstract类，重写execte方法。</p>
<p>实现sdk中的MessageProcessAbstract类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/22 10:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程发布任务处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span> &#123;</span><br><span class="line">        <span class="comment">//获取消息相关的业务信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">businessKey1</span> <span class="operator">=</span> mqMessage.getBusinessKey1();</span><br><span class="line">        <span class="type">long</span> <span class="variable">courseId</span> <span class="operator">=</span> Integer.parseInt(businessKey1);</span><br><span class="line">        <span class="comment">//课程静态化</span></span><br><span class="line">        generateCourseHtml(mqMessage,courseId);</span><br><span class="line">        <span class="comment">//课程索引</span></span><br><span class="line">        saveCourseIndex(mqMessage,courseId);</span><br><span class="line">        <span class="comment">//课程缓存</span></span><br><span class="line">        saveCourseCache(mqMessage,courseId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成课程静态化页面并上传至文件系统</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateCourseHtml</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="comment">//消息id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        <span class="comment">//消息处理的service</span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">        <span class="comment">//消息幂等性处理</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span>(stageOne &gt;<span class="number">0</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;课程静态化已处理直接返回，课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存第一阶段状态</span></span><br><span class="line">        mqMessageService.completedStageOne(id);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将课程信息缓存至redis</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseCache</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;将课程信息缓存至redis,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存课程索引信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseIndex</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;保存课程索引信息,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-3-3-开启任务调度"><a href="#4-4-3-3-开启任务调度" class="headerlink" title="4.4.3.3 开启任务调度"></a><strong>4.4.3.3</strong> <strong>开启任务调度</strong></h4><p>1、首先在内容管理service工程中添加xxl-job依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置执行器</p>
<p>在nacos中在content-service-dev.yaml中配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">coursepublish-job</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">8999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>

<p>3、从媒资管理服务层工程中拷贝一个XxlJobConfig配置类到内容管理service工程中。</p>
<p>在xxl-job-admin控制台中添加执行器</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image034-1711291285108211.gif" alt="img"></p>
<p>3、编写任务调度入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//任务调度入口</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;CoursePublishJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursePublishJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">        log.debug(<span class="string">&quot;shardIndex=&quot;</span>+shardIndex+<span class="string">&quot;,shardTotal=&quot;</span>+shardTotal);</span><br><span class="line">        <span class="comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span></span><br><span class="line">        process(shardIndex,shardTotal,<span class="string">&quot;course_publish&quot;</span>,<span class="number">30</span>,<span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>



<p>4、在xxl-job添加任务</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image036-1711291285108212.gif" alt="img"></p>
<p>任务配置如下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image038-1711291285108213.gif" alt="img"></p>
<p>到此SDK开发、集成完成，下一步添加课程发布后页面静态化、课程缓存、课程索引等任务。</p>
<h4 id="4-4-3-4-测试"><a href="#4-4-3-4-测试" class="headerlink" title="4.4.3.4 测试"></a><strong>4.4.3.4</strong> <strong>测试</strong></h4><p>在消息表添加课程发布的消息，消息类型为course_publish,business_key1为发布课程的ID</p>
<p>1、测试是否可以正常调度执行。</p>
<p>2、测试任务幂等性</p>
<p>在 saveCourseCache(mqMessage,courseId);处打断点，待执行到这里观察数据库第一阶段完成的标记预期标记为1。</p>
<p>结束进程，再重新启动，观察第一阶段的任务预期不再执行。</p>
<p>3、任务执行完成删除消息表记录，插入历史表，state状态字段为1</p>
<h2 id="4-5-页面静态化"><a href="#4-5-页面静态化" class="headerlink" title="4.5 页面静态化"></a><strong>4.5</strong> <strong>页面静态化</strong></h2><h3 id="4-5-1-什么是页面静态化"><a href="#4-5-1-什么是页面静态化" class="headerlink" title="4.5.1 什么是页面静态化"></a><strong>4.5.1</strong> <strong>什么是页面静态化</strong></h3><p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统。</p>
<p>什么是页面静态化？</p>
<p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，服务端渲染的并发能力是有限的。</p>
<p>页面静态化则强调将生成html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时直接请求html页面，由于是静态页面可以使用nginx、apache等高性能的web服务器，并发性能高。</p>
<p>什么时候能用页面静态化技术？</p>
<p>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p>
<p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p>
<h3 id="4-5-2-静态化测试"><a href="#4-5-2-静态化测试" class="headerlink" title="4.5.2 静态化测试"></a><strong>4.5.2</strong> <strong>静态化测试</strong></h3><p>下边使用freemarker技术对页面静态化生成html页面。</p>
<p>在内容管理service工程中添加freemarker依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>编写测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Configuration;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Template;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.TemplateException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.freemarker.FreeMarkerTemplateUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> freemarker测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 18:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试页面静态化</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenerateHtmlByTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        <span class="comment">//配置freemarker</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.getVersion());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模板</span></span><br><span class="line">        <span class="comment">//选指定模板路径,classpath下templates下</span></span><br><span class="line">        <span class="comment">//得到classpath路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(classpath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        <span class="comment">//设置字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定模板文件名称</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备数据</span></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(<span class="number">2L</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//静态化</span></span><br><span class="line">        <span class="comment">//参数1：模板，参数2：数据模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">//将静态化内容输出到文件中</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> IOUtils.toInputStream(content);</span><br><span class="line">        <span class="comment">//输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;D:\\develop\\test.html&quot;</span>);</span><br><span class="line">        IOUtils.copy(inputStream, outputStream);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将content-api工程下的模板拷贝到content-service工程下：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image040-1711291285108216.gif" alt="img"></p>
<p>执行测试方法，观察D:\develop\test.html 是否成功生成。</p>
<h3 id="4-5-3-上传文件测试"><a href="#4-5-3-上传文件测试" class="headerlink" title="4.5.3 上传文件测试"></a><strong>4.5.3</strong> <strong>上传文件测试</strong></h3><h4 id="4-5-3-1-配置远程调用环境"><a href="#4-5-3-1-配置远程调用环境" class="headerlink" title="4.5.3.1 配置远程调用环境"></a><strong>4.5.3.1</strong> <strong>配置远程调用环境</strong></h4><p>静态化生成文件后需要上传至分布式文件系统，根据微服务的职责划分，媒资管理服务负责维护文件系统中的文件，所以内容管理服务对页面静态化生成html文件需要调用媒资管理服务的上传文件接口。如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image018-1711291285108202.gif" alt="img"></p>
<p>微服务之间难免会存在远程调用，在Spring Cloud中可以使用Feign进行远程调用，</p>
<p>Feign是一个声明式的http客户端，官方地址：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p>
<p>下边先准备Feign的开发环境:</p>
<p>1、在内容管理content-service工程添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--feign支持Multipart格式传参--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、在nacos配置feign-dev.yaml公用配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">30000</span>  <span class="comment">#熔断超时时间</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">60000</span> <span class="comment">#连接超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">60000</span> <span class="comment">#读超时时间</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span> <span class="comment">#重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换实例的重试次数</span></span><br></pre></td></tr></table></figure>



<p>3、在内容管理service工程和内容管理api工程都引入此配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">feign-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>4、在内容管理service工程配置feign支持Multipart，拷贝课程资料下的MultipartSupportConfig 到content-service工程下的config包下。</p>
<h4 id="4-5-3-2-扩充上传文件接口"><a href="#4-5-3-2-扩充上传文件接口" class="headerlink" title="4.5.3.2 扩充上传文件接口"></a><strong>4.5.3.2</strong> <strong>扩充上传文件接口</strong></h4><p>现在需要将课程的静态文件上传到minio，单独存储到course目录下，文件的objectname为”课程id.html”，原有的上传文件接口需要增加一个参数 objectname。</p>
<p>下边扩充媒资服务的上传文件接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(value= &quot;objectName&quot;,required=false)</span> String objectName)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">                                  <span class="comment">//....</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>service接口也增加一个参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 上传文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件磁盘路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath,String objectName)</span>;</span><br></pre></td></tr></table></figure>



<p>修改原有uploadFile方法，判断如果objectName为空则采取年月日样式的路径方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储到minio中的对象名(带目录)</span></span><br><span class="line"><span class="keyword">if</span>(StringUtils.isEmpty(objectName))&#123;</span><br><span class="line">    objectName =  defaultFolderPath + fileMd5 + extension;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//        String objectName = defaultFolderPath + fileMd5 + extension;</span></span><br></pre></td></tr></table></figure>

<h4 id="4-5-3-3-远程调用测试"><a href="#4-5-3-3-远程调用测试" class="headerlink" title="4.5.3.3 远程调用测试"></a><strong>4.5.3.3</strong> <strong>远程调用测试</strong></h4><p>在content-service下编写feign接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.feignclient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.config.MultipartSupportConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestPart;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资管理服务远程接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/media/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">uploadFile</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,<span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在启动类添加@EnableFeignClients注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure>

<p>编写测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.feignclient.MediaServiceClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试使用feign远程上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignUploadTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaServiceClient mediaServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程调用，上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="type">MultipartFile</span> <span class="variable">multipartFile</span> <span class="operator">=</span> MultipartSupportConfig.getMultipartFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\test.html&quot;</span>));</span><br><span class="line">        mediaServiceClient.uploadFile(multipartFile,<span class="string">&quot;course&quot;</span>,<span class="string">&quot;test.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边进行测试，启动媒资服务，执行测试方法，上传文件成功，进入minIO查看文件</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image042-1711291285108215.gif" alt="img"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html">http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html</a></p>
<p>查看是否可以正常访问。</p>
<h3 id="4-5-4-熔断降级处理"><a href="#4-5-4-熔断降级处理" class="headerlink" title="4.5.4 熔断降级处理"></a><strong>4.5.4</strong> <strong>熔断降级处理</strong></h3><h4 id="4-5-4-1-什么是熔断降级"><a href="#4-5-4-1-什么是熔断降级" class="headerlink" title="4.5.4.1 什么是熔断降级"></a><strong>4.5.4.1</strong> <strong>什么是熔断降级</strong></h4><p>微服务中难免存在服务之间的远程调用，比如：内容管理服务远程调用媒资服务的上传文件接口，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应。</p>
<p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉，比如：服务B调用服务A，由于A服务异常导致B服务响应缓慢，最后B、C等服务都不可用，像这样由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应，如下图：</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image044-1711291285108214.gif" alt="img"></p>
<p>如何解决由于微服务异常引起的雪崩效应呢？</p>
<p>可以采用熔断、降级的方法去解决。</p>
<p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系。</p>
<p>熔断：</p>
<p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image046-1711291285108217.gif" alt="img"></p>
<p>降级：</p>
<p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image048-1711291285108218.gif" alt="img"></p>
<p>两者都是为了保护系统，熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法。</p>
<h4 id="4-5-4-2-熔断降级处理"><a href="#4-5-4-2-熔断降级处理" class="headerlink" title="4.5.4.2 熔断降级处理"></a><strong>4.5.4.2</strong> <strong>熔断降级处理</strong></h4><p>项目使用Hystrix框架实现熔断、降级处理，在feign-dev.yaml中配置。</p>
<p>1、开启Feign熔断保护</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  hystrix:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  circuitbreaker:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>2、设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hystrix:</span><br><span class="line">  command:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      execution:</span><br><span class="line">        isolation:</span><br><span class="line">          thread:</span><br><span class="line">            timeoutInMilliseconds: <span class="number">30000</span>  #熔断超时时间</span><br><span class="line">ribbon:</span><br><span class="line">  ConnectTimeout: <span class="number">60000</span> #连接超时时间</span><br><span class="line">  ReadTimeout: <span class="number">60000</span> #读超时时间</span><br><span class="line">  MaxAutoRetries: <span class="number">0</span> #重试次数</span><br><span class="line">  MaxAutoRetriesNextServer: <span class="number">1</span> #切换实例的重试次数</span><br></pre></td></tr></table></figure>



<p>3、定义降级逻辑</p>
<p>两种方法：</p>
<p>1）fallback </p>
<p>  Java   @FeignClient(value &#x3D;  “media-api”,configuration &#x3D; MultipartSupportConfig.class,fallback &#x3D;  MediaServiceClientFallback.class)   @RequestMapping(“&#x2F;media”)   public interface MediaServiceClient{   …  </p>
<p>定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口。</p>
<p>第一种方法无法取出熔断所抛出的异常，第二种方法定义MediaServiceClientFallbackFactory 可以解决这个问题。</p>
<p>2）fallbackFactory </p>
<p>第二种方法在FeignClient中指定fallbackFactory ，如下：</p>
<p>  Java   @FeignClient(value &#x3D;  “media-api”,configuration &#x3D;  MultipartSupportConfig.class,fallbackFactory &#x3D;  MediaServiceClientFallbackFactory.class)  </p>
<p>定义MediaServiceClientFallbackFactory如下：</p>
<p>  Java   @Slf4j   @Component   public class MediaServiceClientFallbackFactory implements  FallbackFactory<MediaServiceClient> {     @Override     public MediaServiceClient  create(Throwable throwable) {       return new  MediaServiceClient(){         @Override         public String  uploadFile(MultipartFile upload, String objectName) {           &#x2F;&#x2F;降级方法           log.debug(“调用媒资管理服务上传文件时发生熔断，异常信息:{}”,throwable.toString(),throwable);           return null;         }       };     }   }  </MediaServiceClient></p>
<p>降级处理逻辑：</p>
<p>返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p>
<p>测试：</p>
<p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p>
<h3 id="4-5-4-课程静态化开发"><a href="#4-5-4-课程静态化开发" class="headerlink" title="4.5.4 课程静态化开发"></a><strong>4.5.4</strong> <strong>课程静态化开发</strong></h3><p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理SDK去调度执行。</p>
<h4 id="4-5-4-1-静态化实现"><a href="#4-5-4-1-静态化实现" class="headerlink" title="4.5.4.1 静态化实现"></a><strong>4.5.4.1</strong> <strong>静态化实现</strong></h4><p>课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。</p>
<p>在课程发布的service编写这两部分内容，最后通过消息去调度执行。</p>
<p>1、接口定义</p>
<p>  Java   &#x2F;**    * @description 课程静态化    * @param <em>courseId</em> 课程id    * @return File 静态化文件    * @author Mr.M    * @date 2022&#x2F;9&#x2F;23 16:59   <em>&#x2F;   public File generateCourseHtml(Long courseId);   &#x2F;</em>*    * @description 上传课程静态化页面    * @param <em>file</em> 静态化文件    * @return void    * @author Mr.M    * @date 2022&#x2F;9&#x2F;23 16:59   *&#x2F;   public void uploadCourseHtml(Long  courseId,File file);  </p>
<p>2、接口实现</p>
<p>将之前编写的静态化测试代码以及上传静态文件测试代码拷贝过来使用</p>
<p>  Java   @Override     public File generateCourseHtml(Long  courseId) {          &#x2F;&#x2F;静态化文件       File htmlFile &#x3D; null;          try {         &#x2F;&#x2F;配置freemarker         Configuration configuration  &#x3D; new Configuration(Configuration.<em>getVersion</em>());            &#x2F;&#x2F;加载模板         &#x2F;&#x2F;选指定模板路径,classpath下templates下         &#x2F;&#x2F;得到classpath路径         String classpath &#x3D;  this.getClass().getResource(“&#x2F;“).getPath();           configuration.setDirectoryForTemplateLoading(new File(classpath +  “&#x2F;templates&#x2F;“));          &#x2F;&#x2F;设置字符编码           configuration.setDefaultEncoding(“utf-8”);            &#x2F;&#x2F;指定模板文件名称         Template template &#x3D;  configuration.getTemplate(“course_template.ftl”);            &#x2F;&#x2F;准备数据         CoursePreviewDto  coursePreviewInfo &#x3D; this.getCoursePreviewInfo(courseId);            Map&lt;String, Object&gt;  map &#x3D; new HashMap&lt;&gt;();         map.put(“model”,  coursePreviewInfo);            &#x2F;&#x2F;静态化         &#x2F;&#x2F;参数1：模板，参数2：数据模型         String content &#x3D;  FreeMarkerTemplateUtils.<em>processTemplateIntoString</em>(template,  map);   &#x2F;&#x2F;        System.out.println(content);         &#x2F;&#x2F;将静态化内容输出到文件中         InputStream inputStream &#x3D;  IOUtils.<em>toInputStream</em>(content);         &#x2F;&#x2F;创建静态化文件         htmlFile &#x3D; File.<em>createTempFile</em>(“course”,”.html”);         <em>log</em>.debug(“课程静态化，生成静态文件:{}”,htmlFile.getAbsolutePath());         &#x2F;&#x2F;输出流         FileOutputStream  outputStream &#x3D; new FileOutputStream(htmlFile);         IOUtils.<em>copy</em>(inputStream, outputStream);       } catch (Exception e) {         log.error(“课程静态化异常:{}”,e.toString());           XueChengPlusException.cast(“课程静态化异常”);       }          return htmlFile;     }        @Override     public void uploadCourseHtml(Long  courseId, File file) {       MultipartFile multipartFile &#x3D;  MultipartSupportConfig.<em>getMultipartFile</em>(file);       String course &#x3D;  mediaServiceClient.uploadFile(multipartFile,  “course&#x2F;“+courseId+”.html”);       if(course&#x3D;&#x3D;null){           XueChengPlusException.cast(“上传静态文件异常”);       }     }  </p>
<p>完善课程发布任务CoursePublishTask类的代码：</p>
<p>  Java   &#x2F;&#x2F;生成课程静态化页面并上传至文件系统   public void generateCourseHtml(MqMessage mqMessage,long courseId){     <em>log</em>.debug(“开始进行课程静态化,课程id:{}”,courseId);     &#x2F;&#x2F;消息id     Long id &#x3D; mqMessage.getId();     &#x2F;&#x2F;消息处理的service     MqMessageService mqMessageService &#x3D;  this.getMqMessageService();     &#x2F;&#x2F;消息幂等性处理     int stageOne &#x3D;  mqMessageService.getStageOne(id);     if(stageOne &#x3D;&#x3D; 1){       <em>log</em>.debug(“课程静态化已处理直接返回，课程id:{}”,courseId);       return ;     }        &#x2F;&#x2F;生成静态化页面     File file &#x3D;  coursePublishService.generateCourseHtml(courseId);     &#x2F;&#x2F;上传静态化页面     if(file!&#x3D;null){         coursePublishService.uploadCourseHtml(courseId,file);     }     &#x2F;&#x2F;保存第一阶段状态       mqMessageService.completedStageOne(id);      }  </p>
<h4 id="4-5-4-2-测试"><a href="#4-5-4-2-测试" class="headerlink" title="4.5.4.2 测试"></a><strong>4.5.4.2</strong> <strong>测试</strong></h4><p>1、启动网关、媒资管理服务工程。</p>
<p>2、在内容管理api工程的启动类上配置FeignClient</p>
<p>  Java   @EnableFeignClients(basePackages&#x3D;{“com.xuecheng.content.feignclient”})  </p>
<p>在bootstrap.yml引用feign-dev.yaml</p>
<p>  Bash   - data-id:  feign-${spring.profiles.active}.yaml    group: xuecheng-plus-common    refresh: true #profiles默认为dev  </p>
<p>启动内容管理接口工程。</p>
<p>在CoursePublishTask类的execute方法中打上断点。</p>
<p>3、发布一门课程，保存消息表存在未处理的处理。</p>
<p>4、启动xxl-job调度中心、启动课程发布任务，等待定时调度。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image050-1711291285108220.gif" alt="img"></p>
<p>5、观察任务调度日志，观察任务是否可以正常处理。</p>
<p>6、处理完成进入文件系统，查询mediafiles桶内是否存在以课程id命名的html文件</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image052-1711291285108219.gif" alt="img"></p>
<p>如果不存在说明课程静态化存在问题，再仔细查看执行日志，排查问题。</p>
<p>如果存在则说明课程静态化并上传到minio成功。</p>
<h4 id="4-5-4-3-浏览详细页面"><a href="#4-5-4-3-浏览详细页面" class="headerlink" title="4.5.4.3 浏览详细页面"></a><strong>4.5.4.3</strong> <strong>浏览详细页面</strong></h4><p>课程静态化成功后可以用浏览器访问html文件是否可以正常浏览，下图表示可以正常浏览。</p>
<p><img src="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/clip_image054-1711291285108221.gif" alt="img"></p>
<p>页面还没有样式，需要在nginx配置虚拟目录，在<a href="http://www.51xuecheng.cn下配置：">www.51xuecheng.cn下配置：</a></p>
<p>  Plain  Text   location &#x2F;course&#x2F; {        proxy_pass  <a target="_blank" rel="noopener" href="http://fileserver/mediafiles/course/">http://fileserver/mediafiles/course/</a>;   }   </p>
<p>加载nginx配置文件</p>
<p>访问：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/2.html">http://www.51xuecheng.cn/course/2.html</a></p>
<p>2.html为以课程id命名的html文件。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/" itemprop="url">学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-22T11:49:51+08:00">
                2024-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  18.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  77
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="5-上传视频"><a href="#5-上传视频" class="headerlink" title="5 上传视频"></a><strong>5</strong> <strong>上传视频</strong></h1><h2 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a><strong>5.1</strong> <strong>需求分析</strong></h2><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p>
<p>点击“媒资管理”</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image002.gif" alt="img"></p>
<p>进入媒资管理列表页面查询本机构上传的媒资文件。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image004.gif" alt="img"></p>
<p>2、教育机构用户在”媒资管理”页面中点击 “上传视频” 按钮。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image006.gif" alt="img"></p>
<p>点击“上传视频”打开上传页面</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image008.gif" alt="img"></p>
<p>3、选择要上传的文件，自动执行文件上传。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image010.gif" alt="img"></p>
<p>4、视频上传成功会自动处理，处理完成可以预览视频。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image012.gif" alt="img"></p>
<h2 id="5-2-断点续传技术"><a href="#5-2-断点续传技术" class="headerlink" title="5.2 断点续传技术"></a><strong>5.2</strong> <strong>断点续传技术</strong></h2><h3 id="5-2-1-什么是断点续传"><a href="#5-2-1-什么是断点续传" class="headerlink" title="5.2.1 什么是断点续传"></a><strong>5.2.1</strong> <strong>什么是断点续传</strong></h3><p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p>
<p>什么是断点续传：</p>
<p>​    引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p>
<p>断点续传流程如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image014.gif" alt="img"></p>
<p>流程如下：</p>
<p>1、前端上传前先把文件分成块</p>
<p>2、一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p>
<p>3、各分块上传完成最后在服务端合并文件</p>
<h3 id="5-2-2-分块与合并测试"><a href="#5-2-2-分块与合并测试" class="headerlink" title="5.2.2 分块与合并测试"></a><strong>5.2.2</strong> <strong>分块与合并测试</strong></h3><p>为了更好的理解文件分块上传的原理，下边用java代码测试文件的分块与合并。</p>
<p>文件分块的流程如下：</p>
<p>1、获取源文件长度</p>
<p>2、根据设定的分块文件的大小计算出块数</p>
<p>3、从源文件读数据依次向每一个块文件写数据</p>
<p>测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件处理测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 9:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFileTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试文件分块方法</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChunk</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkPath</span> <span class="operator">=</span> <span class="string">&quot;d:/develop/bigfile_test/chunk/&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkPath);</span><br><span class="line">        <span class="keyword">if</span> (!chunkFolder.exists()) &#123;</span><br><span class="line">            chunkFolder.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分块大小</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//分块数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chunkNum</span> <span class="operator">=</span> (<span class="type">long</span>) Math.ceil(sourceFile.length() * <span class="number">1.0</span> / chunkSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;分块总数：&quot;</span>+chunkNum);</span><br><span class="line">        <span class="comment">//缓冲区大小</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">//使用RandomAccessFile访问文件</span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_read</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(sourceFile, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="comment">//分块</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chunkNum; i++) &#123;</span><br><span class="line">            <span class="comment">//创建分块文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkPath + i);</span><br><span class="line">            <span class="keyword">if</span>(file.exists())&#123;</span><br><span class="line">                file.delete();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">newFile</span> <span class="operator">=</span> file.createNewFile();</span><br><span class="line">            <span class="keyword">if</span> (newFile) &#123;</span><br><span class="line">                <span class="comment">//向分块文件中写数据</span></span><br><span class="line">                <span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> ((len = raf_read.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line">                    <span class="keyword">if</span> (file.length() &gt;= chunkSize) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                raf_write.close();</span><br><span class="line">                System.out.println(<span class="string">&quot;完成分块&quot;</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        raf_read.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件合并流程：</p>
<p>1、找到要合并的文件并按文件合并的先后进行排序。</p>
<p>2、创建合并文件</p>
<p>3、依次从合并的文件中读取数据向合并文件写入数</p>
<p>文件合并的测试代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试文件合并方法</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMerge</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//块文件目录</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/chunk/&quot;</span>);</span><br><span class="line">    <span class="comment">//原始文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">originalFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span>);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos01.mp4&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mergeFile.exists()) &#123;</span><br><span class="line">        mergeFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建新的合并文件</span></span><br><span class="line">    mergeFile.createNewFile();</span><br><span class="line">    <span class="comment">//用于写文件</span></span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    <span class="comment">//指针指向文件顶端</span></span><br><span class="line">    raf_write.seek(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//缓冲区</span></span><br><span class="line">    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">//分块列表</span></span><br><span class="line">    File[] fileArray = chunkFolder.listFiles();</span><br><span class="line">    <span class="comment">// 转成集合，便于排序</span></span><br><span class="line">    List&lt;File&gt; fileList = Arrays.asList(fileArray);</span><br><span class="line">    <span class="comment">// 从小到大排序</span></span><br><span class="line">    Collections.sort(fileList, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;File&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(File o1, File o2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(o1.getName()) - Integer.parseInt(o2.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="keyword">for</span> (File chunkFile : fileList) &#123;</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_read</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(chunkFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = raf_read.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        raf_read.close();</span><br><span class="line">    &#125;</span><br><span class="line">    raf_write.close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验文件</span></span><br><span class="line">    <span class="keyword">try</span> (</span><br><span class="line"></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(originalFile);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">mergeFileStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile);</span><br><span class="line"></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">//取出原始文件的md5</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="comment">//取出合并文件的md5进行比较</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">mergeFileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(mergeFileStream);</span><br><span class="line">        <span class="keyword">if</span> (originalMd5.equals(mergeFileMd5)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;合并文件成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;合并文件失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-3-视频上传流程"><a href="#5-2-3-视频上传流程" class="headerlink" title="5.2.3 视频上传流程"></a><strong>5.2.3</strong> <strong>视频上传流程</strong></h3><p>下图是上传视频的整体流程：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image016.gif" alt="img"></p>
<p>1、前端对文件进行分块。</p>
<p>2、前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。</p>
<p>3、如果分块文件不存在则前端开始上传</p>
<p>4、前端请求媒资服务上传分块。</p>
<p>5、媒资服务将分块上传至MinIO。</p>
<p>6、前端将分块上传完毕请求媒资服务合并分块。</p>
<p>7、媒资服务判断分块上传完成则请求MinIO合并文件。</p>
<p>8、合并完成校验合并后的文件是否完整，如果不完整则删除文件。</p>
<h3 id="5-2-4-minio合并文件测试"><a href="#5-2-4-minio合并文件测试" class="headerlink" title="5.2.4 minio合并文件测试"></a><strong>5.2.4 minio合并文件测试</strong></h3><p>1、将分块文件上传至minio</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将分块文件上传至minio</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadChunk</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFolderPath</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\upload\\chunk\\&quot;</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkFolderPath);</span><br><span class="line">    <span class="comment">//分块文件</span></span><br><span class="line">    File[] files = chunkFolder.listFiles();</span><br><span class="line">    <span class="comment">//将分块文件上传至minio</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;chunk/&quot;</span> + i).filename(files[i].getAbsolutePath()).build();</span><br><span class="line">            minioClient.uploadObject(uploadObjectArgs);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传分块成功&quot;</span>+i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、通过minio的合并文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//合并文件，要求分块文件最小5M</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_merge</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(<span class="number">6</span>)</span><br><span class="line">            .map(i -&gt; ComposeSource.builder()</span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">                    .object(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i)))</span><br><span class="line">                    .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="type">ComposeObjectArgs</span> <span class="variable">composeObjectArgs</span> <span class="operator">=</span> ComposeObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;merge01.mp4&quot;</span>).sources(sources).build();</span><br><span class="line">    minioClient.composeObject(composeObjectArgs);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//清除分块文件</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_removeObjects</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//合并分块完成将分块文件清除</span></span><br><span class="line">    List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(<span class="number">6</span>)</span><br><span class="line">            .map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i))))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).objects(deleteObjects).build();</span><br><span class="line">    Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">    results.forEach(r-&gt;&#123;</span><br><span class="line">        <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deleteError = r.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>minio合并文件默认分块最小5M，我们将分块改为5M再次测试。</p>
<h2 id="5-3-接口定义"><a href="#5-3-接口定义" class="headerlink" title="5.3 接口定义"></a><strong>5.3</strong> <strong>接口定义</strong></h2><p>根据上传视频流程，定义接口，与前端的约定是操作成功返回{code:0}否则返回{code:-1}</p>
<p>从课程资料中拷贝RestResponse.java类到base工程下的model包下。</p>
<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfo;</span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件上传接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFilesController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;合并文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-4-上传分块开发"><a href="#5-4-上传分块开发" class="headerlink" title="5.4 上传分块开发"></a><strong>5.4</strong> <strong>上传分块开发</strong></h2><h3 id="5-4-1-DAO开发"><a href="#5-4-1-DAO开发" class="headerlink" title="5.4.1 DAO开发"></a><strong>5.4.1 DAO开发</strong></h3><p>向媒资数据库的文件表插入记录，使用自动生成的Mapper接口即可满足要求。</p>
<h3 id="5-4-2-Service开发"><a href="#5-4-2-Service开发" class="headerlink" title="5.4.2 Service开发"></a><strong>5.4.2 Service开发</strong></h3><h4 id="5-4-2-1-检查文件和分块"><a href="#5-4-2-1-检查文件和分块" class="headerlink" title="5.4.2.1 检查文件和分块"></a><strong>5.4.2.1</strong> <strong>检查文件和分块</strong></h4><p>接口完成进行接口实现，首先实现检查文件方法和检查分块方法。</p>
<p>在MediaFileService中定义service接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 检查文件是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:38</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 检查分块是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkIndex  分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:39</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span>;</span><br></pre></td></tr></table></figure>



<p>service接口实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="comment">//查询文件信息</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//桶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaFiles.getBucket();</span><br><span class="line">        <span class="comment">//存储目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaFiles.getFilePath();</span><br><span class="line">        <span class="comment">//文件流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = minioClient.getObject(</span><br><span class="line">                    GetObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket)</span><br><span class="line">                            .object(filePath)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//文件已存在</span></span><br><span class="line">                <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件不存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//得到分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunkIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件流</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileInputStream = minioClient.getObject(</span><br><span class="line">                GetObjectArgs.builder()</span><br><span class="line">                        .bucket(bucket_videoFiles)</span><br><span class="line">                        .object(chunkFilePath)</span><br><span class="line">                        .build());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//分块已存在</span></span><br><span class="line">            <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分块未存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到分块文件的目录</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getChunkFileFolderPath</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;chunk&quot;</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-2-上传分块"><a href="#5-4-2-2-上传分块" class="headerlink" title="5.4.2.2 上传分块"></a><strong>5.4.2.2</strong> <strong>上传分块</strong></h4><p>定义service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunk  分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bytes  文件字节</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:50</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5,<span class="type">int</span> chunk,<span class="type">byte</span>[] bytes)</span>;</span><br></pre></td></tr></table></figure>



<p>接口实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//得到分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//将文件存储至minIO</span></span><br><span class="line">    addMediaFilesToMinIO(bytes, bucket_videoFiles,chunkFilePath);</span><br><span class="line">     <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        log.debug(<span class="string">&quot;上传分块文件:&#123;&#125;,失败:&#123;&#125;&quot;</span>,chunkFilePath,e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>,<span class="string">&quot;上传分块失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-4-2-3-上传分块测试"><a href="#5-4-2-3-上传分块测试" class="headerlink" title="5.4.2.3 上传分块测试"></a><strong>5.4.2.3</strong> <strong>上传分块测试</strong></h4><p>完善接口层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkFile(fileMd5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkChunk(fileMd5,chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    <span class="comment">//上传的文件拷贝到临时文件</span></span><br><span class="line">    file.transferTo(tempFile);</span><br><span class="line">    <span class="comment">//文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.uploadChunk(fileMd5,chunk,absolutePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动前端工程，进入上传视频界面进行前后端联调测试。</p>
<p>前端对文件分块的大小为5MB，SpringBoot web默认上传文件的大小限制为1MB，这里需要在media-api工程修改配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">50MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">50MB</span></span><br></pre></td></tr></table></figure>

<p>max-file-size：单个文件的大小限制</p>
<p>Max-request-size: 单次请求的大小限制</p>
<h2 id="5-5-合并分块开发"><a href="#5-5-合并分块开发" class="headerlink" title="5.5 合并分块开发"></a><strong>5.5</strong> <strong>合并分块开发</strong></h2><h3 id="5-5-1-service开发"><a href="#5-5-1-service开发" class="headerlink" title="5.5.1 service开发"></a><strong>5.5.1 service开发</strong></h3><p>定义service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 合并分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块总和</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId,String fileMd5,<span class="type">int</span> chunkTotal,UploadFileParamsDto uploadFileParamsDto)</span>;</span><br></pre></td></tr></table></figure>

<p>service实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId, String fileMd5, <span class="type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;</span><br><span class="line">    <span class="comment">//=====获取分块文件路径=====</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//组成将分块文件路径组成 List&lt;ComposeSource&gt;</span></span><br><span class="line">    List&lt;ComposeSource&gt; sourceObjectList = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(chunkTotal)</span><br><span class="line">            .map(i -&gt; ComposeSource.builder()</span><br><span class="line">                    .bucket(bucket_videoFiles)</span><br><span class="line">                    .object(chunkFileFolderPath.concat(Integer.toString(i)))</span><br><span class="line">                    .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//=====合并=====</span></span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//合并文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mergeFilePath</span> <span class="operator">=</span> getFilePathByMd5(fileMd5, extName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//合并文件</span></span><br><span class="line">        <span class="type">ObjectWriteResponse</span> <span class="variable">response</span> <span class="operator">=</span> minioClient.composeObject(</span><br><span class="line">                ComposeObjectArgs.builder()</span><br><span class="line">                        .bucket(bucket_videoFiles)</span><br><span class="line">                        .object(mergeFilePath)</span><br><span class="line">                        .sources(sourceObjectList)</span><br><span class="line">                        .build());</span><br><span class="line">        log.debug(<span class="string">&quot;合并文件成功:&#123;&#125;&quot;</span>,mergeFilePath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;合并文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;&quot;</span>,fileMd5,e.getMessage(),e);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;合并文件失败。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ====验证md5====</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">minioFile</span> <span class="operator">=</span> downloadFileFromMinIO(bucket_videoFiles,mergeFilePath);</span><br><span class="line">    <span class="keyword">if</span>(minioFile == <span class="literal">null</span>)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;下载合并后文件失败,mergeFilePath:&#123;&#125;&quot;</span>,mergeFilePath);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;下载合并后文件失败。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">newFileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(minioFile)) &#123;</span><br><span class="line">        <span class="comment">//minio上文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Hex</span> <span class="operator">=</span> DigestUtils.md5Hex(newFileInputStream);</span><br><span class="line">        <span class="comment">//比较md5值，不一致则说明文件不完整</span></span><br><span class="line">        <span class="keyword">if</span>(!fileMd5.equals(md5Hex))&#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;文件合并校验失败，最终上传失败。&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件大小</span></span><br><span class="line">        uploadFileParamsDto.setFileSize(minioFile.length());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;校验文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;&quot;</span>,fileMd5,e.getMessage(),e);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;文件合并校验失败，最终上传失败。&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(minioFile!=<span class="literal">null</span>)&#123;</span><br><span class="line">           minioFile.delete();</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件入库</span></span><br><span class="line">    currentProxy.addMediaFilesToDb(companyId,fileMd5,uploadFileParamsDto,bucket_videoFiles,mergeFilePath);</span><br><span class="line">    <span class="comment">//=====清除分块文件=====</span></span><br><span class="line">    clearChunkFiles(chunkFileFolderPath,chunkTotal);</span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从minio下载文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 下载后的文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(String bucket,String objectName)</span>&#123;</span><br><span class="line">    <span class="comment">//临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">minioFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> minioClient.getObject(GetObjectArgs.builder()</span><br><span class="line">                .bucket(bucket)</span><br><span class="line">                .object(objectName)</span><br><span class="line">                .build());</span><br><span class="line">        <span class="comment">//创建临时文件</span></span><br><span class="line">        minioFile=File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;.merge&quot;</span>);</span><br><span class="line">        outputStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(minioFile);</span><br><span class="line">        IOUtils.copy(stream,outputStream);</span><br><span class="line">        <span class="keyword">return</span> minioFile;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(outputStream!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 得到合并后的文件的地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件id即md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileExt 文件扩展名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFilePathByMd5</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清除分块文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkFileFolderPath 分块文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块文件总数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearChunkFiles</span><span class="params">(String chunkFileFolderPath,<span class="type">int</span> chunkTotal)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">                .limit(chunkTotal)</span><br><span class="line">                .map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(chunkFileFolderPath.concat(Integer.toString(i))))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(<span class="string">&quot;video&quot;</span>).objects(deleteObjects).build();</span><br><span class="line">        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">        results.forEach(r-&gt;&#123;</span><br><span class="line">            <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                deleteError = r.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.error(<span class="string">&quot;清楚分块文件失败,objectname:&#123;&#125;&quot;</span>,deleteError.objectName(),e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;清楚分块文件失败,chunkFileFolderPath:&#123;&#125;&quot;</span>,chunkFileFolderPath,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-4-3-接口层完善"><a href="#5-4-3-接口层完善" class="headerlink" title="5.4.3 接口层完善"></a>5.4.3 接口层完善</h3><p>下边完善接口层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkFile(fileMd5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkChunk(fileMd5,chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mediaFileService.uploadChunk(fileMd5,chunk,file.getBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;合并文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001002&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setTags(<span class="string">&quot;课程视频&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setRemark(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setFilename(fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mediaFileService.mergechunks(companyId,fileMd5,chunkTotal,uploadFileParamsDto);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-2-合并分块测试"><a href="#5-5-2-合并分块测试" class="headerlink" title="5.5.2 合并分块测试"></a><strong>5.5.2</strong> <strong>合并分块测试</strong></h3><p>下边进行前后端联调：</p>
<p>1、上传一个视频测试合并分块的执行逻辑</p>
<p>进入service方法逐行跟踪。</p>
<p>2、断点续传测试</p>
<p>上传一部分后，停止刷新浏览器再重新上传，通过浏览器日志发现已经上传过的分块不再重新上传</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image018.gif" alt="img"></p>
<h2 id="5-6其它问题"><a href="#5-6其它问题" class="headerlink" title="5.6其它问题"></a><strong>5.6其它问题</strong></h2><h3 id="5-6-1-分块文件清理问题"><a href="#5-6-1-分块文件清理问题" class="headerlink" title="5.6.1 分块文件清理问题"></a><strong>5.6.1</strong> <strong>分块文件清理问题</strong></h3><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p>
<p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p>
<p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="【面试】什么情况下事务失效？"><a href="#【面试】什么情况下事务失效？" class="headerlink" title="【面试】什么情况下事务失效？"></a>【面试】什么情况下事务失效？</h1><ol>
<li>在方法中捕获异常没有抛出去</li>
<li>非事务方法调用事务方法</li>
<li>事务方法内部调用事务方法</li>
<li>@Transactional标记的方法不是public</li>
<li>抛出的异常与rollbackFor指定的异常不匹配，默认rollbackFor指定的异常为RuntimeException6）</li>
<li>数据库表不支持事务，比如MySQL的MyISAM</li>
</ol>
<ol start="7">
<li>Spring的传播行为导致事务失效，比如: PROPAGATION_NEVER、PROPAGATION_NOT_SUPPORTED</li>
</ol>
<p>  PROPAGATION_REQUIRED –支持当前事务，如果当前没有事务，就新建一个事务。这是最常见的选择。PROPAGATION_SUPPORTS –支持当前事务，如果当前没有事务，就以非事务方式执行。<br>  PROPAGATION_MANDATORY –支持当前事务，如果当前没有事务，就抛出异常。<br>  PROPAGATION_REQUIRES_NEW –新建事务，如果当前存在事务，把当前事务挂起。<br>  PROPAGATION_NOT_SUPPORTED –以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。PROPAGATION_NEVER –以非事务方式执行，如果当前存在事务，则抛出异常。<br>  PROPAGATION_NESTED –如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则与PROPAGATION_REQUIRED类似的操作。</p>
<h1 id="【面试】断点续传是怎么做的？"><a href="#【面试】断点续传是怎么做的？" class="headerlink" title="【面试】断点续传是怎么做的？"></a>【面试】断点续传是怎么做的？</h1><p>我们是基于分块上传的模式实现断点续传的需求，当文件上传一部分断网后前边已经上传过的不再上传。</p>
<p>1）前端对文件分块。<br>2）前端使用多线程一块一块上传，上传前给服务端发一个消息校验该分块是否上传，如果已上传则不再上传。<br>3）等所有分块上传完毕，服务端合并所有分块，校验文件的完整性。</p>
<p>因为分块全部上传到了服务器，服务器将所有分块按顺序进行合并，就是写每个分块文件内容按顺序依次写入一个文件中。使用字节流去读写文件。</p>
<p>4）前端给服务传了一个md5值，服务端合并文件后计算合并后文件的md5是否和前端传的一样，如果一样则说文件完整，如果不一样说明可能由于网络丢包导致文件不完整，这时上传失败需要重新上传。</p>
<h1 id="【面试】分块文件清理问题？"><a href="#【面试】分块文件清理问题？" class="headerlink" title="【面试】分块文件清理问题？"></a>【面试】分块文件清理问题？</h1><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗?怎么做的?</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。<br>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。<br>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="7-视频处理"><a href="#7-视频处理" class="headerlink" title="7 视频处理"></a><strong>7</strong> <strong>视频处理</strong></h1><h2 id="7-1-视频转码需求"><a href="#7-1-视频转码需求" class="headerlink" title="7.1 视频转码需求"></a><strong>7.1</strong> <strong>视频转码需求</strong></h2><h3 id="7-7-1-什么是视频编码"><a href="#7-7-1-什么是视频编码" class="headerlink" title="7.7.1 什么是视频编码"></a><strong>7.7.1</strong> <strong>什么是视频编码</strong></h3><p>视频上传成功后需要对视频进行转码处理。</p>
<p>什么是视频编码？查阅百度百科如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image002-17111724006691.gif" alt="img"></p>
<p>详情参考 ：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038">https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038</a></p>
<p>首先我们要分清文件格式和编码格式：</p>
<p>文件格式：是指.mp4、.avi、.rmvb等 这些不同扩展名的视频文件的文件格式 ，视频文件的内容主要包括视频和音频，其文件格式是按照一 定的编码格式去编码，并且按照该文件所规定的封装格式将视频、音频、字幕等信息封装在一起，播放器会根据它们的封装格式去提取出编码，然后由播放器解码，最终播放音视频。</p>
<p>音视频编码格式：通过音视频的压缩技术，将视频格式转换成另一种视频格式，通过视频编码实现流媒体的传输。比如：一个.avi的视频文件原来的编码是a，通过编码后编码格式变为b，音频原来为c，通过编码后变为d。</p>
<p>音视频编码格式各类繁多，主要有几下几类：</p>
<p>MPEG系列</p>
<p>（由ISO[国际标准组织机构]下属的MPEG[运动图象专家组]开发 ）视频编码方面主要是Mpeg1（vcd用的就是它）、Mpeg2（DVD使用）、Mpeg4（的DVDRIP使用的都是它的变种，如：divx，xvid等）、Mpeg4 AVC（正热门）；音频编码方面主要是MPEG Audio Layer 1&#x2F;2、MPEG Audio Layer 3（大名鼎鼎的mp3）、MPEG-2 AAC 、MPEG-4 AAC等等。注意：DVD音频没有采用Mpeg的。</p>
<p>H.26X系列</p>
<p>（由ITU[国际电传视讯联盟]主导，侧重网络传输，注意：只是视频编码）</p>
<p>包括H.261、H.262、H.263、H.263+、H.263++、H.264（就是MPEG4 AVC-合作的结晶）</p>
<p>目前最常用的编码标准是视频H.264，音频AAC。</p>
<p>提问：</p>
<p>H.264是编码格式还是文件格式？</p>
<p>mp4是编码格式还是文件格式？</p>
<h3 id="7-7-2-FFmpeg-的基本使用"><a href="#7-7-2-FFmpeg-的基本使用" class="headerlink" title="7.7.2 FFmpeg 的基本使用"></a><strong>7.7.2 FFmpeg</strong> <strong>的基本使用</strong></h3><p>我们将视频录制完成后，使用视频编码软件对视频进行编码，本项目 使用FFmpeg对视频进行编码 。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image004-17111724006692.gif" alt="img"></p>
<p>FFmpeg被许多开源项目采用，QQ影音、暴风影音、VLC等。</p>
<p>下载：FFmpeg <a target="_blank" rel="noopener" href="https://www.ffmpeg.org/download.html#build-windows">https://www.ffmpeg.org/download.html#build-windows</a></p>
<p>请从常用工具软件目录找到ffmpeg.exe，并将ffmpeg.exe加入环境变量path中。</p>
<p>测试是否正常：cmd运行 ffmpeg -version</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image006-17111724006693.gif" alt="img"></p>
<p>安装成功，作下简单测试</p>
<p>将一个.avi文件转成mp4、mp3、gif等。</p>
<p>比如我们将nacos.avi文件转成mp4，运行如下命令：</p>
<p>D:\soft\ffmpeg\ffmpeg.exe -i 1.avi 1.mp4</p>
<p>可以将ffmpeg.exe配置到环境变量path中，进入视频目录直接运行：ffmpeg.exe -i 1.avi 1.mp4</p>
<p>转成mp3：ffmpeg -i nacos.avi nacos.mp3</p>
<p>转成gif：ffmpeg -i nacos.avi nacos.gif</p>
<p>官方文档（英文）：<a target="_blank" rel="noopener" href="http://ffmpeg.org/ffmpeg.html">http://ffmpeg.org/ffmpeg.html</a></p>
<h3 id="7-7-3-视频处理工具类"><a href="#7-7-3-视频处理工具类" class="headerlink" title="7.7.3 视频处理工具类"></a><strong>7.7.3</strong> <strong>视频处理工具类</strong></h3><p>将课程资料的工具类中的util拷贝至base工程。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image008-17111724006705.gif" alt="img"></p>
<p>其中Mp4VideoUtil类是用于将视频转为mp4格式，是我们项目要使用的工具类。</p>
<p>下边看下这个类的代码，并进行测试。</p>
<p>我们要通过ffmpeg对视频转码，Java程序调用ffmpeg，使用java.lang.ProcessBuilder去完成，具体在Mp4VideoUtil类的63行，下边进行简单的测试，下边的代码运行本机安装的QQ软件。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line">builder.command(<span class="string">&quot;C:\\Program Files (x86)\\Tencent\\QQ\\Bin\\QQScLauncher.exe&quot;</span>);</span><br><span class="line"><span class="comment">//将标准输入流和错误输入流合并，通过标准输入流程读取信息</span></span><br><span class="line">builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> builder.start();</span><br></pre></td></tr></table></figure>

<p>对Mp4VideoUtil类需要学习使用方法，下边代码将一个avi视频转为mp4视频，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//ffmpeg的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ffmpeg_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\soft\\ffmpeg\\ffmpeg.exe&quot;</span>;<span class="comment">//ffmpeg的安装位置</span></span><br><span class="line">    <span class="comment">//源avi视频的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">video_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.avi&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_name</span> <span class="operator">=</span> <span class="string">&quot;nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//创建工具类对象</span></span><br><span class="line">    <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpeg_path,video_path,mp4_name,mp4_path);</span><br><span class="line">    <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> videoUtil.generateMp4();</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行main方法，最终在控制台输出 success 表示执行成功。</p>
<h2 id="7-2-分布式任务处理"><a href="#7-2-分布式任务处理" class="headerlink" title="7.2 分布式任务处理"></a><strong>7.2</strong> <strong>分布式任务处理</strong></h2><h3 id="7-2-1-什么是分布式任务调度"><a href="#7-2-1-什么是分布式任务调度" class="headerlink" title="7.2.1 什么是分布式任务调度"></a><strong>7.2.1</strong> <strong>什么是分布式任务调度</strong></h3><p>对一个视频的转码可以理解为一个任务的执行，如果视频的数量比较多，如何去高效处理一批任务呢？</p>
<p>1、多线程</p>
<p>多线程是充分利用单机的资源。</p>
<p>2、分布式加多线程</p>
<p>充分利用多台计算机，每台计算机使用多线程处理。</p>
<p>方案2可扩展性更强。</p>
<p>方案2是一种分布式任务调度的处理方案。</p>
<p>什么是分布式任务调度？</p>
<p>我们可以先思考一下下面业务场景的解决方案：</p>
<p>​    每隔24小时执行数据备份任务。</p>
<p>​    12306网站会根据车次不同，设置几个时间点分批次放票。</p>
<p>​    某财务系统需要在每天上午10点前结算前一天的账单数据，统计汇总。</p>
<p>​    商品成功发货后，需要向客户发送短信提醒。</p>
<p>类似的场景还有很多，我们该如何实现？</p>
<p><strong>多线程方式实现：</strong></p>
<p>学过多线程的同学，可能会想到，我们可以开启一个线程，每sleep一段时间，就去检查是否已到预期执行时间。</p>
<p>以下代码简单实现了任务调度的功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;    </span><br><span class="line">    <span class="comment">//任务执行间隔时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeInterval</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//TODO：something</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(timeInterval);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码实现了按一定的间隔时间执行任务调度的功能。</p>
<p>Jdk也为我们提供了相关支持，如Timer、ScheduledExecutor，下边我们了解下。</p>
<p><strong>Timer方式实现</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();  </span><br><span class="line">    timer.schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">           <span class="comment">//TODO：something</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;, <span class="number">1000</span>, <span class="number">2000</span>);  <span class="comment">//1秒后开始调度，每2秒执行一次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        Timer 的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行。</p>
<p><strong>ScheduledExecutor方式实现</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span>&#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    service.scheduleAtFixedRate(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">//TODO：something</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1</span>,</span><br><span class="line">            <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    Java 5 推出了基于线程池设计的 ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰。</p>
<p>​    Timer 和 ScheduledExecutor 都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每月第一天凌晨1点执行任务、复杂调度任务的管理、任务间传递数据等等。</p>
<p><strong>第三方Quartz方式实现，项目地址：<a target="_blank" rel="noopener" href="https://github.com/quartz-scheduler/quartz">https://github.com/quartz-scheduler/quartz</a></strong>  </p>
<p>​    Quartz 是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz 设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job 负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler 将二者组装在一起，并触发任务开始执行。Quartz支持简单的按时间间隔调度、还支持按日历调度方式，通过设置CronTrigger表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p>
<p>下边是一个例子代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span> <span class="keyword">throws</span> SchedulerException &#123;</span><br><span class="line">    <span class="comment">//创建一个Scheduler</span></span><br><span class="line">    <span class="type">SchedulerFactory</span> <span class="variable">schedulerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdSchedulerFactory</span>();</span><br><span class="line">    <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactory.getScheduler();</span><br><span class="line">    <span class="comment">//创建JobDetail</span></span><br><span class="line">    <span class="type">JobBuilder</span> <span class="variable">jobDetailBuilder</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class);</span><br><span class="line">    jobDetailBuilder.withIdentity(<span class="string">&quot;jobName&quot;</span>,<span class="string">&quot;jobGroupName&quot;</span>);</span><br><span class="line">    <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> jobDetailBuilder.build();</span><br><span class="line">    <span class="comment">//创建触发的CronTrigger 支持按日历调度</span></span><br><span class="line">        <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(<span class="string">&quot;triggerName&quot;</span>, <span class="string">&quot;triggerGroupName&quot;</span>)</span><br><span class="line">                .startNow()</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">&quot;0/2 * * * * ?&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">    scheduler.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过以上内容我们学习了什么是任务调度，任务调度所解决的问题，以及任务调度的多种实现方式。</p>
<p><strong>任务调度顾名思义，就是对任务的调度，它是指系统为了完成特定业务，基于给定时间点，给定时间间隔或者给定执行次数自动执行任务。</strong></p>
<p><strong>什么是分布式任务调度？</strong></p>
<p>​    通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>，如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image010-17111724006704.gif" alt="img"></p>
<p><strong>分布式调度要实现的目标：</strong></p>
<p>​    不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p>
<p>1、并行任务调度</p>
<p>​    并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p>
<p>​    如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p>
<p>2、高可用</p>
<p>​    若某一个实例宕机，不影响其他实例来执行任务。</p>
<p>3、弹性扩容</p>
<p>​    当集群中增加实例就可以提高并执行任务的处理效率。</p>
<p>4、任务管理与监测</p>
<p>​    对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p>
<p>5、避免任务重复执行</p>
<p>​    当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p>
<h3 id="7-2-2-XXL-JOB介绍"><a href="#7-2-2-XXL-JOB介绍" class="headerlink" title="7.2.2 XXL-JOB介绍"></a><strong>7.2.2 XXL-JOB介绍</strong></h3><p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B">https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</a></p>
<p>XXL-JOB主要有调度中 心、执行器、任务：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image012-17111724006706.gif" alt="img"></p>
<p><strong>调度中心：</strong></p>
<p>​    负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p>
<p>​    主要职责为执行器管理、任务管理、监控运维、日志管理等</p>
<p><strong>任务执行器：</strong></p>
<p>​    负责接收调度请求并执行任务逻辑；</p>
<p>​    只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p>
<p><strong>任务：</strong>负责执行具体的业务处理。</p>
<p>调度中心与执行器之间的工作流程如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image014-17111724006707.gif" alt="img"></p>
<p><strong>执行流程：</strong></p>
<p>​    1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p>
<p>​    2.达到任务触发条件，调度中心下发任务</p>
<p>​    3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p>
<p>​    4.执行器消费内存队列中的执行结果，主动上报给调度中心</p>
<p>​    5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p>
<h3 id="7-2-3-搭建XXL-JOB"><a href="#7-2-3-搭建XXL-JOB" class="headerlink" title="7.2.3 搭建XXL-JOB"></a><strong>7.2.3</strong> <strong>搭建XXL-JOB</strong></h3><h4 id="7-2-3-1-调度中心"><a href="#7-2-3-1-调度中心" class="headerlink" title="7.2.3.1 调度中心"></a><strong>7.2.3.1</strong> <strong>调度中心</strong></h4><p>首先下载XXL-JOB</p>
<p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></p>
<p>码云：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></p>
<p>项目使用2.3.1版本： <a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></p>
<p>也可从课程资料目录获取，解压xxl-job-2.3.1.zip</p>
<p>使用IDEA打开解压后的目录</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image016-17111724006708.gif" alt="img"></p>
<p>xxl-job-admin：调度中心</p>
<p>xxl-job-core：公共依赖</p>
<p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p>
<p>  ：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p>
<p>  ：xxl-job-executor-sample-frameless：无框架版本；</p>
<p>doc :文档资料，包含数据库脚本</p>
<p>在下发的虚拟机的MySQL中已经创建了xxl_job_2.3.1数据库</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image018-17111724006709.gif" alt="img"></p>
<p>如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image020.gif" alt="img"></p>
<p>执行sh &#x2F;data&#x2F;soft&#x2F;restart.sh自动启动xxl-job调度中心</p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8088/xxl-job-admin/">http://192.168.101.65:8088/xxl-job-admin/</a></p>
<p>账号和密码：admin&#x2F;123456</p>
<p>如果无法使用虚拟机运行xxl-job可以在本机idea运行xxl-job调度中心。</p>
<h4 id="7-2-3-2-执行器"><a href="#7-2-3-2-执行器" class="headerlink" title="7.2.3.2 执行器"></a><strong>7.2.3.2</strong> <strong>执行器</strong></h4><p>下边配置执行器，执行器负责与调度中心通信接收调度中心发起的任务调度请求。</p>
<p>1、下边进入调度中心添加执行器</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image022.gif" alt="img"></p>
<p>点击新增，填写执行器信息，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image024.gif" alt="img"></p>
<p>添加成功：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image026.gif" alt="img"></p>
<p>2、首先在媒资管理模块的service工程添加依赖，在项目的父工程已约定了版本2.3.1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、在nacos下的media-service-dev.yaml下配置xxl-job</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">media-process-service</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>

<p>注意配置中的appname这是执行器的应用名，port是执行器启动的端口，如果本地启动多个执行器注意端口不能重复。</p>
<p>4、配置xxl-job的执行器</p>
<p>将xxl-job示例工程下配置类拷贝到媒资管理的service工程下</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image028.gif" alt="img"></p>
<p>拷贝至：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image030.gif" alt="img"></p>
<p>到此完成媒资管理模块service工程配置xxl-job执行器，在xxl-job调度中心添加执行器，下边准备测试执行器与调度中心是否正常通信，因为接口工程依赖了service工程，所以启动媒资管理模块的接口工程。</p>
<p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image032.gif" alt="img"></p>
<p>同时观察调度中心中的执行器界面</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image034.gif" alt="img"></p>
<p>在线机器地址处已显示1个执行器。</p>
<h4 id="7-2-3-3-执行任务"><a href="#7-2-3-3-执行任务" class="headerlink" title="7.2.3.3 执行任务"></a><strong>7.2.3.3</strong> <strong>执行任务</strong></h4><p>下边编写任务，参考示例工程中任务类的编写方法，如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image036.gif" alt="img"></p>
<p>在媒资服务service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试执行器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 20:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Component</span></span><br><span class="line"> <span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleJob</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@XxlJob(&quot;testJob&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  log.info(<span class="string">&quot;开始执行.....&quot;</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边在调度中心添加任务，进入任务管理</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image038.gif" alt="img"></p>
<p>点击新增，填写任务信息</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image040.gif" alt="img"></p>
<p>注意红色标记处：</p>
<p>调度类型：</p>
<p>固定速度指按固定的间隔定时调度。</p>
<p>Cron，通过Cron表达式实现更丰富的定时调度策略。</p>
<p>Cron表达式是一个字符串，通过它可以定义调度策略，格式如下：</p>
<p>{秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)}</p>
<p>xxl-job提供图形界面去配置：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image042.gif" alt="img"></p>
<p>一些例子如下：</p>
<p>30 10 1 * * ? 每天1点10分30秒触发</p>
<p>0&#x2F;30 * * * * ? 每30秒触发一次</p>
<p>* 0&#x2F;10 * * * ? 每10分钟触发一次</p>
<p>运行模式有BEAN和GLUE，bean模式较常用就是在项目工程中编写执行器的任务代码，GLUE是将任务代码编写在调度中心。</p>
<p>JobHandler即任务方法名，填写任务方法上边@XxlJob注解中的名称。</p>
<p>路由策略：当执行器集群部署时，调度中心向哪个执行器下发任务，这里选择第一个表示只向第一个执行器下发任务，路由策略的其它选项稍后在分片广播章节详细解释。</p>
<p>高级配置的其它配置项稍后在分片广播章节详细解释。</p>
<p>添加成功，启动任务</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image044.gif" alt="img"></p>
<p>通过调度日志查看任务执行情况</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image046.gif" alt="img"></p>
<p>下边启动媒资管理的service工程，启动执行器。</p>
<p>观察执行器方法的执行。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image048.gif" alt="img"></p>
<p>如果要停止任务需要在调度中心操作</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image050.gif" alt="img"></p>
<p>任务跑一段时间注意清理日志</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image052.gif" alt="img"></p>
<h3 id="7-2-4-分片广播"><a href="#7-2-4-分片广播" class="headerlink" title="7.2.4 分片广播"></a><strong>7.2.4</strong> <strong>分片广播</strong></h3><p>掌握了xxl-job的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image054.gif" alt="img"></p>
<p>执行器在集群部署下调度中心有哪些路由策略呢？</p>
<p>查看xxl-job官方文档，阅读高级配置相关的内容：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">高级配置：</span><br><span class="line">    <span class="operator">-</span> 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；</span><br><span class="line">        <span class="keyword">FIRST</span>（第一个）：固定选择第一个机器；</span><br><span class="line">        <span class="keyword">LAST</span>（最后一个）：固定选择最后一个机器；</span><br><span class="line">        ROUND（轮询）：；</span><br><span class="line">        RANDOM（随机）：随机选择在线的机器；</span><br><span class="line">        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span><br><span class="line">        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span><br><span class="line">        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span><br><span class="line">        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span> 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。</span><br><span class="line">    <span class="operator">-</span> 调度过期策略：</span><br><span class="line">        <span class="operator">-</span> 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</span><br><span class="line">        <span class="operator">-</span> 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</span><br><span class="line">    <span class="operator">-</span> 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</span><br><span class="line">        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span><br><span class="line">        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span><br><span class="line">        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span><br><span class="line">    <span class="operator">-</span> 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span><br><span class="line">    <span class="operator">-</span> 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br></pre></td></tr></table></figure>

<p>下边要重点说的是分片广播策略，分片是指是调度中心以执行器为维度进行分片，将集群中的执行器标上序号：0，1，2，3…，广播是指每次调度会向集群中的所有执行器发送任务调度，请求中携带分片参数。</p>
<p>如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image056.gif" alt="img"></p>
<p>每个执行器收到调度请求同时接收分片参数。</p>
<p>xxl-job支持动态扩容执行器集群从而动态增加分片数量，当有任务量增加可以部署更多的执行器到集群中，调度中心会动态修改分片的数量。</p>
<p><strong>作业分片适用哪些场景呢？</strong></p>
<p>•     分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p>
<p>•     广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p>
<p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p>
<p><strong>使用说明：</strong></p>
<p>“分片广播” 和普通任务开发流程一致，不同之处在于可以获取分片参数进行分片业务处理。</p>
<p>Java语言任务获取分片参数方式：</p>
<p>BEAN、GLUE模式(Java)，可参考Sample示例执行器中的示例任务”ShardingJobHandler”：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2、分片广播任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 分片序号，从0开始</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="comment">// 分片总数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>



<p>下边测试作业分片：</p>
<p>1、定义作业分片的任务方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 2、分片广播任务</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分片参数</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">  <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;分片参数：当前分片序号 = &#123;&#125;, 总分片数 = &#123;&#125;&quot;</span>, shardIndex, shardTotal);</span><br><span class="line">log.info(<span class="string">&quot;开始执行第&quot;</span>+shardIndex+<span class="string">&quot;批任务&quot;</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>2、在调度中心添加任务</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image058.gif" alt="img"></p>
<p>添加成功：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image060.gif" alt="img"></p>
<p>启动任务，观察日志</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image062.gif" alt="img"></p>
<p>下边启动两个执行器实例，观察每个实例的执行情况</p>
<p>首先在nacos中配置media-service的本地优先配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>将media-service启动两个实例</p>
<p>两个实例的在启动时注意端口不能冲突：</p>
<p>实例1 在VM options处添加：-Dserver.port&#x3D;63051 -Dxxl.job.executor.port&#x3D;9998</p>
<p>实例2 在VM options处添加：-Dserver.port&#x3D;63050 -Dxxl.job.executor.port&#x3D;9999</p>
<p>例如：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image064.gif" alt="img"></p>
<p>启动两个实例</p>
<p>观察任务调度中心，稍等片刻执行器有两个</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image066.gif" alt="img"></p>
<p>观察两个执行实例的日志：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image068.gif" alt="img"></p>
<p>另一实例的日志如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image070.gif" alt="img"></p>
<p>从日志可以看每个实例的分片序号不同。</p>
<p>如果其中一个执行器挂掉，只剩下一个执行器在工作，稍等片刻调用中心发现少了一个执行器将动态调整总分片数为1。</p>
<p>到此作业分片任务调试完成，此时我们可以思考：</p>
<p>当一次分片广播到来，各执行器如何根据分片参数去分布式执行任务，保证执行器之间执行的任务不重复呢？</p>
<h2 id="7-3-技术方案"><a href="#7-3-技术方案" class="headerlink" title="7.3 技术方案"></a><strong>7.3</strong> <strong>技术方案</strong></h2><h3 id="7-3-1-作业分片方案"><a href="#7-3-1-作业分片方案" class="headerlink" title="7.3.1 作业分片方案"></a><strong>7.3.1</strong> <strong>作业分片方案</strong></h3><p>掌握了xxl-job的分片广播调度方式，下边思考如何分布式去执行学成在线平台中的视频处理任务。</p>
<p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，此时如何保证多个执行器不会查询到重复的任务呢？</p>
<p>XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号，在向执行器任务调度的同时下发分片总数以及分片序号等参数，执行器收到这些参数根据自己的业务需求去利用这些参数。</p>
<p>下图表示了多个执行器获取视频处理任务的结构：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image072.gif" alt="img"></p>
<p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务。</p>
<p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p>
<p>1 % 2 &#x3D; 1  执行器2执行</p>
<p>2 % 2 &#x3D; 0  执行器1执行</p>
<p>3 % 2 &#x3D; 1   执行器2执行</p>
<p>以此类推.</p>
<h3 id="7-3-2-保证任务不重复执行"><a href="#7-3-2-保证任务不重复执行" class="headerlink" title="7.3.2 保证任务不重复执行"></a><strong>7.3.2</strong> <strong>保证任务不重复执行</strong></h3><p>通过作业分片方案保证了执行器之间查询到不重复的任务，如果一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</p>
<p>首先配置调度过期策略：</p>
<p>查看文档如下：</p>
<p>  - 调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；<br>     - 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；<br>     - 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；<br>   - 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p>
<p>这里我们选择忽略，如果立即执行一次就可能重复执行相同的任务。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image074.gif" alt="img"></p>
<p>其次，再看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束时调度中心进行任务调度，此时该如何处理。</p>
<p>查看文档如下：<br>     单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；<br>     丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；<br>     覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p>
<p>这里如果选择覆盖之前调度则可能重复执行任务，这里选择 丢弃后续调度或单机串行方式来避免任务重复执行。</p>
<p>只做这些配置可以保证任务不会重复执行吗？</p>
<p>做不到，还需要保证任务处理的幂等性，什么是任务的幂等性？任务的幂等性是指：对于数据的操作不论多少次，操作的结果始终是一致的。在本项目中要实现的是不论多少次任务调度同一个视频只执行一次成功的转码。</p>
<p>什么是幂等性？</p>
<p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p>
<p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p>
<p>解决幂等性常用的方案：</p>
<p>1）数据库约束，比如：唯一索引，主键。</p>
<p>2）乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p>
<p>3）唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p>
<p>基于以上分析，在执行器接收调度请求去执行视频处理任务时要实现视频处理的幂等性，要有办法去判断该视频是否处理完成，如果正在处理中或处理完则不再处理。这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p>
<h3 id="7-3-3-视频处理方案"><a href="#7-3-3-视频处理方案" class="headerlink" title="7.3.3 视频处理方案"></a><strong>7.3.3</strong> <strong>视频处理方案</strong></h3><p>确定了分片方案，下边梳理整个视频上传及处理的业务流程。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image076.gif" alt="img"></p>
<p>上传视频成功向视频处理待处理表添加记录。</p>
<p>视频处理的详细流程如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image078.gif" alt="img"></p>
<p>1、任务调度中心广播作业分片。</p>
<p>2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p>
<p>3、执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。</p>
<p>4、执行器启动多线程去处理任务。</p>
<p>5、任务处理完成，上传处理后的视频到MinIO。</p>
<p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p>
<h2 id="7-4-查询待处理任务"><a href="#7-4-查询待处理任务" class="headerlink" title="7.4 查询待处理任务"></a><strong>7.4</strong> <strong>查询待处理任务</strong></h2><h3 id="7-4-1-需求分析"><a href="#7-4-1-需求分析" class="headerlink" title="7.4.1 需求分析"></a><strong>7.4.1</strong> <strong>需求分析</strong></h3><p>查询待处理任务只处理未提交及处理失败的任务，任务处理失败后进行重试，最多重试3次。</p>
<p>任务处理成功将待处理记录移动到历史任务表。</p>
<p>下图是待处理任务表：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image080.gif" alt="img"></p>
<p>历史任务表与待处理任务表的结构相同。</p>
<h3 id="7-4-2添加待处理任务"><a href="#7-4-2添加待处理任务" class="headerlink" title="7.4.2添加待处理任务"></a><strong>7.4.2添加待处理任务</strong></h3><p>上传视频成功向视频处理待处理表添加记录，暂时只添加对avi视频的处理记录。</p>
<p>根据MIME Type去判断是否是avi视频，下边列出部分MIME Type</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image082.gif" alt="img"></p>
<p>avi视频的MIME Type是video&#x2F;x-msvideo</p>
<p>修改文件信息入库方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="comment">//从数据库查询文件</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        <span class="comment">//媒体类型</span></span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>, mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加到待处理任务表</span></span><br><span class="line">        addWaitingTask(mediaFiles);</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>, mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加待处理任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaFiles 媒资文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWaitingTask</span><span class="params">(MediaFiles mediaFiles)</span>&#123;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaFiles.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//文件mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(exension);</span><br><span class="line">    <span class="comment">//如果是avi视频添加到视频待处理表</span></span><br><span class="line">    <span class="keyword">if</span>(mimeType.equals(<span class="string">&quot;video/x-msvideo&quot;</span>))&#123;</span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">        BeanUtils.copyProperties(mediaFiles,mediaProcess);</span><br><span class="line">        mediaProcess.setStatus(<span class="string">&quot;1&quot;</span>);<span class="comment">//未处理</span></span><br><span class="line">        mediaProcess.setFailCount(<span class="number">0</span>);<span class="comment">//失败次数默认为0</span></span><br><span class="line">        mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-4-3-查询待处理任务"><a href="#7-4-3-查询待处理任务" class="headerlink" title="7.4.3 查询待处理任务"></a><strong>7.4.3</strong> <strong>查询待处理任务</strong></h3><p>如何保证查询到的待处理视频记录不重复？</p>
<p>编写根据分片参数获取待处理任务的DAO方法，定义DAO接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据分片参数获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal  分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardindex  分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 任务数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt; </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/14 8:54</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from media_process t where t.id % #&#123;shardTotal&#125; = #&#123;shardIndex&#125; and (t.status = &#x27;1&#x27; or t.status = &#x27;3&#x27;) and t.fail_count &lt; 3 limit #&#123;count&#125;&quot;)</span></span><br><span class="line">    List&lt;MediaProcess&gt; <span class="title function_">selectListByShardIndex</span><span class="params">(<span class="meta">@Param(&quot;shardTotal&quot;)</span> <span class="type">int</span> shardTotal,<span class="meta">@Param(&quot;shardIndex&quot;)</span> <span class="type">int</span> shardIndex,<span class="meta">@Param(&quot;count&quot;)</span> <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义Service接口，查询待处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件处理业务方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/10 8:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 获取记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/14 14:49</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex,<span class="type">int</span> shardTotal,<span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileProcessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">  List&lt;MediaProcess&gt; mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">   <span class="keyword">return</span> mediaProcesses;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="7-5-开始执行任务"><a href="#7-5-开始执行任务" class="headerlink" title="7.5 开始执行任务"></a><strong>7.5</strong> <strong>开始执行任务</strong></h2><h3 id="7-5-1-分布式锁"><a href="#7-5-1-分布式锁" class="headerlink" title="7.5.1 分布式锁"></a><strong>7.5.1</strong> <strong>分布式锁</strong></h3><p>为了避免多线程去争抢同一个任务可以使用synchronized同步锁去解决，如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(锁对象)&#123;</span><br><span class="line">   执行任务...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>synchronized只能保证同一个虚拟机中多个线程去争抢锁。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image084.gif" alt="img"></p>
<p>如果是多个执行器分布式部署，并不能保证同一个视频只有一个执行器去处理。</p>
<p>现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image086.gif" alt="img"></p>
<p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务。</p>
<p>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫分布式锁。</p>
<p>实现分布式锁的方案有很多，常用的如下：</p>
<p>1、基于数据库实现分布锁</p>
<p>利用数据库主键唯一性的特点，或利用数据库唯一索引、行级锁的特点，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p>
<p>2、基于redis实现锁</p>
<p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。</p>
<p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p>
<p>3、使用zookeeper实现</p>
<p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p>
<h3 id="7-5-2-开启任务"><a href="#7-5-2-开启任务" class="headerlink" title="7.5.2 开启任务"></a><strong>7.5.2</strong> <strong>开启任务</strong></h3><p>下边基于数据库方式实现分布锁，开始执行任务将任务执行状态更新为4表示任务执行中。</p>
<p>下边的sql语句可以实现更新操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update media_process m set m.status=<span class="string">&#x27;4&#x27;</span> where  m.id=?</span><br></pre></td></tr></table></figure>



<p>如果是多个线程去执行该sql都将会执行成功，但需求是只能有一个线程抢到锁，所以此sql无法满足需求。</p>
<p>下边使用乐观锁的方式实现更新操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update media_process m set m.status=<span class="string">&#x27;4&#x27;</span> where (m.status=<span class="string">&#x27;1&#x27;</span> or m.status=<span class="string">&#x27;3&#x27;</span>) and m.fail_count&lt;<span class="number">3</span> and m.id=?</span><br></pre></td></tr></table></figure>

<p>多个线程同时执行上边的sql只会有一个线程执行成功。</p>
<p>什么是乐观锁、悲观锁？</p>
<p>synchronized是一种悲观锁，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以要悲观锁。</p>
<p>乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。</p>
<p>实现如下：</p>
<p>1、定义mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启一个任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 任务id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 更新记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update(&quot;update media_process m set m.status=&#x27;4&#x27; where (m.status=&#x27;1&#x27; or m.status=&#x27;3&#x27;) and m.fail_count&lt;3 and m.id=#&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">startTask</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、service方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  开启一个任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 任务id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true开启任务成功，false开启任务失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startTask</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现如下</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startTask</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> mediaProcessMapper.startTask(id);</span><br><span class="line">    <span class="keyword">return</span> result&lt;=<span class="number">0</span>?<span class="literal">false</span>:<span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-6-更新任务状态"><a href="#7-6-更新任务状态" class="headerlink" title="7.6 更新任务状态"></a><strong>7.6</strong> <strong>更新任务状态</strong></h2><p>任务处理完成需要更新任务处理结果，任务执行成功更新视频的URL、及任务处理结果，将待处理任务记录删除，同时向历史任务表添加记录。</p>
<p>在MediaFileProcessService接口添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存任务结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> taskId  任务id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status 任务状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileId  文件id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> errorMsg 错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/15 11:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(Long taskId,String status,String fileId,String url,String errorMsg)</span>;</span><br></pre></td></tr></table></figure>

<p>service接口方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileProcessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaProcessHistoryMapper mediaProcessHistoryMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;</span><br><span class="line">    <span class="comment">//查出任务，如果不存在则直接返回</span></span><br><span class="line">    <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> mediaProcessMapper.selectById(taskId);</span><br><span class="line">    <span class="keyword">if</span>(mediaProcess == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理失败，更新任务处理结果</span></span><br><span class="line">    LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapperById = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;MediaProcess&gt;().eq(MediaProcess::getId, taskId);</span><br><span class="line">    <span class="comment">//处理失败</span></span><br><span class="line">    <span class="keyword">if</span>(status.equals(<span class="string">&quot;3&quot;</span>))&#123;</span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">        mediaProcess_u.setStatus(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        mediaProcess_u.setErrormsg(errorMsg);</span><br><span class="line">        mediaProcess_u.setFailCount(mediaProcess.getFailCount()+<span class="number">1</span>);</span><br><span class="line">        mediaProcessMapper.update(mediaProcess_u,queryWrapperById);</span><br><span class="line">        log.debug(<span class="string">&quot;更新任务处理状态为失败，任务信息:&#123;&#125;&quot;</span>,mediaProcess_u);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//任务处理成功</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileId);</span><br><span class="line">    <span class="keyword">if</span>(mediaFiles!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//更新媒资文件中的访问url</span></span><br><span class="line">        mediaFiles.setUrl(url);</span><br><span class="line">        mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理成功，更新url和状态</span></span><br><span class="line">    mediaProcess.setUrl(url);</span><br><span class="line">    mediaProcess.setStatus(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    mediaProcess.setFinishDate(LocalDateTime.now());</span><br><span class="line">    mediaProcessMapper.updateById(mediaProcess);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加到历史记录</span></span><br><span class="line">    <span class="type">MediaProcessHistory</span> <span class="variable">mediaProcessHistory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcessHistory</span>();</span><br><span class="line">    BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);</span><br><span class="line">    mediaProcessHistoryMapper.insert(mediaProcessHistory);</span><br><span class="line">    <span class="comment">//删除mediaProcess</span></span><br><span class="line">    mediaProcessMapper.deleteById(mediaProcess.getId());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">  List&lt;MediaProcess&gt; mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">   <span class="keyword">return</span> mediaProcesses;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-7-视频处理"><a href="#7-7-视频处理" class="headerlink" title="7.7 视频处理"></a><strong>7.7</strong> <strong>视频处理</strong></h2><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p>
<p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p>
<p>定义任务类VideoTask 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.jobhander;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.utils.Mp4VideoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileService;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/15 11:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileService mediaFileService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileProcessService mediaFileProcessService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;videoprocess.ffmpegpath&#125;&quot;)</span></span><br><span class="line">    String ffmpegpath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;videoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">videoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">    List&lt;MediaProcess&gt; mediaProcessList = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//取出cpu核心数作为一次处理数据的条数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="comment">//一次处理视频数量不要超过cpu核心数</span></span><br><span class="line">        mediaProcessList = mediaFileProcessService.getMediaProcessList(shardIndex, shardTotal, processors);</span><br><span class="line">        size = mediaProcessList.size();</span><br><span class="line">        log.debug(<span class="string">&quot;取出待处理视频任务&#123;&#125;条&quot;</span>, size);</span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动size个线程的线程池</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">    <span class="comment">//计数器</span></span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">    <span class="comment">//将处理任务加入线程池</span></span><br><span class="line">    mediaProcessList.forEach(mediaProcess -&gt; &#123;</span><br><span class="line">        threadPool.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//任务id</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> mediaProcess.getId();</span><br><span class="line">                <span class="comment">//抢占任务</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> mediaFileProcessService.startTask(taskId);</span><br><span class="line">                <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;开始执行任务:&#123;&#125;&quot;</span>, mediaProcess);</span><br><span class="line">                <span class="comment">//下边是处理逻辑</span></span><br><span class="line">                <span class="comment">//桶</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaProcess.getBucket();</span><br><span class="line">                <span class="comment">//存储路径</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaProcess.getFilePath();</span><br><span class="line">                <span class="comment">//原始视频的md5值</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> mediaProcess.getFileId();</span><br><span class="line">                <span class="comment">//原始文件名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaProcess.getFilename();</span><br><span class="line">                <span class="comment">//将要处理的文件下载到服务器上</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">originalFile</span> <span class="operator">=</span> mediaFileService.downloadFileFromMinIO(mediaProcess.getBucket(), mediaProcess.getFilePath());</span><br><span class="line">                <span class="keyword">if</span> (originalFile == <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;下载待处理文件失败,originalFile:&#123;&#125;&quot;</span>, mediaProcess.getBucket().concat(mediaProcess.getFilePath()));</span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;下载待处理文件失败&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//处理结束的视频文件</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">mp4File</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mp4File = File.createTempFile(<span class="string">&quot;mp4&quot;</span>, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;创建mp4临时文件失败&quot;</span>);</span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;创建mp4临时文件失败&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//视频处理结果</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//开始处理视频</span></span><br><span class="line">                    <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpegpath, originalFile.getAbsolutePath(), mp4File.getName(), mp4File.getAbsolutePath());</span><br><span class="line">                    <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">                    result = videoUtil.generateMp4();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    log.error(<span class="string">&quot;处理视频文件:&#123;&#125;,出错:&#123;&#125;&quot;</span>, mediaProcess.getFilePath(), e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!result.equals(<span class="string">&quot;success&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">//记录错误信息</span></span><br><span class="line">                    log.error(<span class="string">&quot;处理视频失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>, bucket + filePath, result);</span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, result);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">//将mp4上传至minio</span></span><br><span class="line">                <span class="comment">//mp4在minio的存储路径</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> getFilePath(fileId, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                <span class="comment">//访问url</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), <span class="string">&quot;video/mp4&quot;</span>, bucket, objectName);</span><br><span class="line">                    <span class="comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span></span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;2&quot;</span>, fileId, url, <span class="literal">null</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;上传视频失败或入库失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>, bucket + objectName, e.getMessage());</span><br><span class="line">                    <span class="comment">//最终还是失败了</span></span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;处理后视频上传或入库失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">    countDownLatch.await(<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFilePath</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-8-测试"><a href="#7-8-测试" class="headerlink" title="7.8 测试"></a><strong>7.8</strong> <strong>测试</strong></h2><h3 id="7-8-1-基本测试"><a href="#7-8-1-基本测试" class="headerlink" title="7.8.1 基本测试"></a><strong>7.8.1</strong> <strong>基本测试</strong></h3><p>进入xxl-job调度中心添加执行器和视频处理任务</p>
<p>在xxl-job配置任务调度策略：</p>
<p>1）配置阻塞处理策略为：丢弃后续调度。</p>
<p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢弃调度请求。</p>
<p>配置完成开始测试视频处理：</p>
<p>1、首先上传至少4个视频，非mp4格式。</p>
<p>2、在xxl-job启动视频处理任务</p>
<p>3、观察媒资管理服务后台日志</p>
<h3 id="7-8-2-失败测试"><a href="#7-8-2-失败测试" class="headerlink" title="7.8.2 失败测试"></a><strong>7.8.2</strong> <strong>失败测试</strong></h3><p>1、先停止调度中心的视频处理任务。</p>
<p>2、上传视频，手动修改待处理任务表中file_path字段为一个不存在的文件地址</p>
<p>3、启动任务</p>
<p>观察任务处理失败后是否会重试，并记录失败次数。</p>
<h3 id="7-8-3-抢占任务测试"><a href="#7-8-3-抢占任务测试" class="headerlink" title="7.8.3 抢占任务测试"></a><strong>7.8.3</strong> <strong>抢占任务测试</strong></h3><p>1、修改调度中心中视频处理任务的阻塞处理策略为“覆盖之间的调度”</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image088.gif" alt="img"></p>
<p>2、在抢占任务代码处打断点并选择支持多线程方式</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image090.gif" alt="img"></p>
<p>3、在抢占任务代码处的下边两行代码分别打上断点，避免观察时代码继续执行。</p>
<p>4、启动任务</p>
<p>此时多个线程执行都停留在断点处</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image092.gif" alt="img"></p>
<p>依次放行，观察同一个任务只会被一个线程抢占成功。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image094.gif" alt="img"></p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image096.gif" alt="img"></p>
<h2 id="7-9-其它问题"><a href="#7-9-其它问题" class="headerlink" title="7.9 其它问题"></a><strong>7.9</strong> <strong>其它问题</strong></h2><h3 id="7-9-1-任务补偿机制"><a href="#7-9-1-任务补偿机制" class="headerlink" title="7.9.1 任务补偿机制"></a><strong>7.9.1</strong> <strong>任务补偿机制</strong></h3><p>如果有线程抢占了某个视频的处理任务，如果线程处理过程中挂掉了，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p>
<p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p>
<p>任务执行期限是处理一个视频的最大时间，比如定为30分钟，通过任务的启动时间去判断任务是否超过执行期限。</p>
<p>大家思考这个sql该如何实现？</p>
<p>大家尝试自己实现此任务补偿机制。</p>
<h3 id="7-9-2-达到最大失败次数"><a href="#7-9-2-达到最大失败次数" class="headerlink" title="7.9.2 达到最大失败次数"></a><strong>7.9.2</strong> <strong>达到最大失败次数</strong></h3><p>当任务达到最大失败次数时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传mp4视频。</p>
<h3 id="7-9-3-分块文件清理问题"><a href="#7-9-3-分块文件清理问题" class="headerlink" title="7.9.3 分块文件清理问题"></a><strong>7.9.3</strong> <strong>分块文件清理问题</strong></h3><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p>
<p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p>
<p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="【面试】xxl-job的工作原理"><a href="#【面试】xxl-job的工作原理" class="headerlink" title="【面试】xxl-job的工作原理"></a>【面试】xxl-job的工作原理</h1><p>XXL-J0B分布式任务调度服务由调用中心和执行器组成，调用中心负责按任务调度策略向执行器下发任务，执行器负责接收任务执行任务。</p>
<p>1）首先部署并启动xxl-job调度中心。(一个java工程)</p>
<p>2）首先在微服务添加xxl-job依赖，在微服务中配置执行器</p>
<p>3）启动微服务，执行器向调度中心上报自己。</p>
<p>4）在微服务中写一个任务方法并用xxl-job的注解去标记执行任务的方法名称。</p>
<p>5）在调度中心配置任务调度策略，调度策略就是每隔多长时间执行还是在每天或每月的固定时间去执行，比如每天0点执行，或每隔1小时执行一次等。</p>
<p>6）在调度中心启动任务。</p>
<p>7）调度中心根据任务调度策略，到达时间就开始下发任务给执行器。</p>
<p>8）执行器收到任务就开始执行任务。</p>
<h1 id="【面试】2、如何保证任务不重复执行"><a href="#【面试】2、如何保证任务不重复执行" class="headerlink" title="【面试】2、如何保证任务不重复执行?"></a>【面试】2、如何保证任务不重复执行?</h1><ol>
<li>调度中心按分片广播的方式去下发任务</li>
</ol>
<ol start="2">
<li>执行器收到作业分片广播的参数:分片总数和分片序号，计算任务id除以分片总数得到一个余数，如果余数等于分片序号这时就去执行这个任务，这里保证了不同的执行器执行不同的任务。</li>
</ol>
<ol start="3">
<li><p>配置调度过期策略为”忽略”，避免同一个执行器多次重复执行同一个任务</p>
</li>
<li><p>配置任务阻塞处理策略为”丢弃后续调度”，注意:丢弃也没事下一次调度就又可以执行了</p>
</li>
<li><p>另外还要保证任务处理的幂等性，执行过的任务可以打一个状态标记已完成，下次再调度执行该任务判断该任务已完成就不再执行</p>
</li>
</ol>
<h1 id="【面试】3、任务幂等性如何保证"><a href="#【面试】3、任务幂等性如何保证" class="headerlink" title="【面试】3、任务幂等性如何保证?"></a>【面试】3、任务幂等性如何保证?</h1><p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。幂等性是为了解决重复提交问题，比如:恶意刷单，重复支付等。解决幂等性常用的方案:</p>
<p>1）数据库约南比如:唯一索引，主键。同一个主键不可能两次都插入成功。</p>
<p>2）乐观锁,常用于数据库，更新数据时根据乐观锁状态去更新。</p>
<p>3）唯一序列号请求前生成唯一的序列号，携带序列号丢请求，执行时在redis记录该序列号表示以该序列号的请</p>
<p>求执行过了，如果相同的序列号再次来执行说明是重复执行。<br>这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p>
<h1 id="8-绑定媒资"><a href="#8-绑定媒资" class="headerlink" title="8 绑定媒资"></a>8 绑定媒资</h1><h2 id="8-1-需求分析"><a href="#8-1-需求分析" class="headerlink" title="8.1 需求分析"></a>8.1 需求分析</h2><h3 id="8-1-1-业务流程"><a href="#8-1-1-业务流程" class="headerlink" title="8.1.1 业务流程"></a>8.1.1 业务流程</h3><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p>
<p>如何将课程计划绑定媒资呢？</p>
<p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p>
<p>具体的业务流程如下：</p>
<p>1.教育机构用户进入课程管理页面并编辑某一个课程，在”课程大纲”标签页的某一小节后可点击”添加视频“。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MDEzMzM1Yjk2ZjZkNGRhNjRhYTg3MjM2YzliMDZmMWZfYkVteGFFMEVsVTFsSG8yM3lYazR2amhYeHVFUGdrWXdfVG9rZW46Ym94Y25ud0VRRzhFb3Y3eGU0WWJnbWxuY1pnXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGZkMjQxYWJhNGFmYTcwZjNiZDMwMDU1NjhlNzE0NzBfQjUweXVvS21La041MTlydXM5Zmx0aWtvNzZJVVJpUnhfVG9rZW46Ym94Y25ZSG9CTTlJU2tqTUR0TkJNdFZmSmt5XzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MDVkNDUzNjA1MWE1MjE4Y2FiM2QyZTQxMTQ0N2VhODFfOXRjcVB1bmFSWHZtbTYwamQwSnNSZUoyVmZRdklqTENfVG9rZW46Ym94Y255d3ZtR2Fxa2wyMnNUTlI0MTBFdTBkXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>课程计划关联视频后如下图：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDRkZTQ3MTRmZjU1NGRkM2JjNmFkNDZlODg3MzdlYjdfemhZNjVBRWJ2dUh1UlRrMWN3UGRqTXNGQUkwMmtVbWFfVG9rZW46Ym94Y25zVmlhVjhaYUtkcjdvTDBFemM1VEFjXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>点击已经绑定的视频名称即可解除绑定。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=YjkwMTEyZGE3ZjhhZjFmMmI4NzQzMmY5NDc4N2I0OTJfRnl5U1NkMWZNbEtaSGRuSDA3MjVJcTJiVUcyeTh2c3lfVG9rZW46Ym94Y24xa2pKaTNWNnVablp5NGNUcEowTjRnXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<h3 id="8-1-2-数据模型"><a href="#8-1-2-数据模型" class="headerlink" title="8.1.2 数据模型"></a>8.1.2 数据模型</h3><p>课程计划绑定媒资文件后存储至课程计划绑定媒资表</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=NzYxYWU2YWQ5NWJiMjY0MzliODAxZTgzNzQwOGI0YzFfNDJsdUlPQk9KR1EyMk0zTlpabnBNMkRtQnFwOWZBOFFfVG9rZW46Ym94Y25PaVNiNUNmV1l4TW5GRUVXOGZwY0JkXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<h2 id="8-2-接口定义"><a href="#8-2-接口定义" class="headerlink" title="8.2 接口定义"></a>8.2 接口定义</h2><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，前端以json格式请求以下参数：</p>
<p>提交媒资文件id、文件名称、教学计划id</p>
<p>示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mediaId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;teachplanId&quot;</span><span class="punctuation">:</span> <span class="number">257</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>此接口在内容管理模块提供。</p>
<p>在内容管理模块定义请求参数模型类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;BindTeachplanMediaDto&quot;, description=&quot;教学计划-媒资绑定提交数据&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BindTeachplanMediaDto</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModelProperty(value = &quot;媒资文件id&quot;, required = true)</span></span><br><span class="line"><span class="keyword">private</span> String mediaId;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModelProperty(value = &quot;媒资文件名称&quot;, required = true)</span></span><br><span class="line"><span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程计划标识&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> Long teachplanId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在TeachplanController类中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-3-接口开发"><a href="#8-3-接口开发" class="headerlink" title="8.3 接口开发"></a>8.3 接口开发</h2><h3 id="8-3-1-DAO开发"><a href="#8-3-1-DAO开发" class="headerlink" title="8.3.1 DAO开发"></a>8.3.1 DAO开发</h3><p>对teachplanMedia表自动生成Mapper。</p>
<h3 id="8-3-2-Service开发"><a href="#8-3-2-Service开发" class="headerlink" title="8.3.2 Service开发"></a>8.3.2 Service开发</h3><p>根据需求定义service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 教学计划绑定媒资</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bindTeachplanMediaDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.content.model.po.TeachplanMedia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 22:20</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span>;</span><br></pre></td></tr></table></figure>

<p>定义接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span> &#123;</span><br><span class="line"> <span class="comment">//教学计划id</span></span><br><span class="line"> <span class="type">Long</span> <span class="variable">teachplanId</span> <span class="operator">=</span> bindTeachplanMediaDto.getTeachplanId();</span><br><span class="line"> <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line"> <span class="keyword">if</span>(teachplan==<span class="literal">null</span>)&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;教学计划不存在&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line"> <span class="keyword">if</span>(grade!=<span class="number">2</span>)&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//课程id</span></span><br><span class="line"> <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> teachplan.getCourseId();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//先删除原来该教学计划绑定的媒资</span></span><br><span class="line"> teachplanMediaMapper.delete(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId,teachplanId));</span><br><span class="line"></span><br><span class="line"> <span class="comment">//再添加教学计划与媒资的绑定关系</span></span><br><span class="line"> <span class="type">TeachplanMedia</span> <span class="variable">teachplanMedia</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TeachplanMedia</span>();</span><br><span class="line"> teachplanMedia.setCourseId(courseId);</span><br><span class="line"> teachplanMedia.setTeachplanId(teachplanId);</span><br><span class="line"> teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());</span><br><span class="line"> teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());</span><br><span class="line"> teachplanMedia.setCreateDate(LocalDateTime.now());</span><br><span class="line"> teachplanMediaMapper.insert(teachplanMedia);</span><br><span class="line"> <span class="keyword">return</span> teachplanMedia;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-3-接口层完善"><a href="#8-3-3-接口层完善" class="headerlink" title="8.3.3 接口层完善"></a>8.3.3 接口层完善</h3><p>完善接口层调用Service层的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line">    teachplanService.associationMedia(bindTeachplanMediaDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-4-接口测试"><a href="#8-3-4-接口测试" class="headerlink" title="8.3.4 接口测试"></a>8.3.4 接口测试</h3><p>1、使用httpclient测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划绑定视频</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan/association/media</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;mediaId&quot;: &quot;&quot;,</span><br><span class="line">  &quot;fileName&quot;: &quot;&quot;,</span><br><span class="line">  &quot;teachplanId&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、前后端联调</p>
<p>此功能较为简单推荐直接前后端联调</p>
<p>向指定课程计划添加视频</p>
<h2 id="8-4-实战"><a href="#8-4-实战" class="headerlink" title="8.4 实战"></a>8.4 实战</h2><p>根据接口定义实现解除绑定功能。</p>
<p>点击已经绑定的视频名称即可解除绑定。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=NmVkMDVlNjcwM2Q4NzA0MGE3OTdiZTQ1ZTZhMGQwMmVfS0tGSHVkdEFmYmxhVlZwNVpjQm4wRGhEa3o2VmVrMFFfVG9rZW46Ym94Y245RDFCMkE0OU5RNnI2aHFuSnV4b3loXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete /teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br><span class="line"></span><br><span class="line">返回<span class="number">200</span>状态码表示成功。</span><br></pre></td></tr></table></figure>

<p>开发完成使用httpclient测试、前后端联调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划接触视频绑定</span><br><span class="line">DELETE &#123;&#123;media_host&#125;&#125;/media/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br></pre></td></tr></table></figure>



<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><ul>
<li>根据接口定义实现解除绑定功能<ul>
<li>点击已经绑定的视频名称即可解除绑定</li>
</ul>
</li>
<li>接口定义如下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">delete /teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在TeachplanController中定义接口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功@ApiOperation(&quot;课程计划解除媒资信息绑定&quot;)</span><br><span class="line">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span><br><span class="line">public void unassociationMedia(@PathVariable Long teachPlanId, @PathVariable Long mediaId) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>根据需求定义Service接口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功/** 解绑教学计划与媒资信息</span><br><span class="line"> * @param teachPlanId       教学计划id</span><br><span class="line"> * @param mediaId           媒资信息id</span><br><span class="line"> */</span><br><span class="line">void unassociationMedia(Long teachPlanId, Long mediaId);</span><br></pre></td></tr></table></figure>

<ul>
<li>定义接口实现</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功@Override</span><br><span class="line">public void unassociationMedia(Long teachPlanId, Long mediaId) &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId)</span><br><span class="line">            .eq(TeachplanMedia::getMediaId, mediaId);</span><br><span class="line">    teachplanMediaMapper.delete(queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>完善接口层，调用service层的代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功@ApiOperation(&quot;课程计划解除媒资信息绑定&quot;)</span><br><span class="line">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span><br><span class="line">public void unassociationMedia(@PathVariable Long teachPlanId, @PathVariable String mediaId) &#123;</span><br><span class="line">    teachplanService.unassociationMedia(teachPlanId, mediaId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/" itemprop="url">学成在线-day06-媒资管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-20T21:36:16+08:00">
                2024-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  11.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  50
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1</strong> <strong>模块需求分析</strong></h1><h2 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1</strong> <strong>模块介绍</strong></h2><p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p>
<p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视&#x2F;音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AA%92%E4%BD%93?fromModule=lemma_inlink">媒体</a>资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p>
<p>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</p>
<p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p>
<p>媒资查询：教学机构查询自己所拥有的媒资信息。</p>
<p>文件上传：包括上传图片、上传文档、上传视频。</p>
<p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p>
<p>文件删除：教学机构删除自己上传的媒资文件。</p>
<p>下图是课程编辑与发布的整体流程，通过下图可以看到媒资管理在整体流程的位置：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002.gif" alt="img"></p>
<h2 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2</strong> <strong>业务流程</strong></h2><h3 id="1-2-1-上传图片"><a href="#1-2-1-上传图片" class="headerlink" title="1.2.1 上传图片"></a><strong>1.2.1</strong> <strong>上传图片</strong></h3><p>教学机构人员在课程信息编辑页面上传课程图片，课程图片统一记录在媒资管理系统。</p>
<p>下图是上传图片的界面：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004.gif" alt="img"></p>
<h3 id="1-2-2-上传视频"><a href="#1-2-2-上传视频" class="headerlink" title="1.2.2 上传视频"></a><strong>1.2.2</strong> <strong>上传视频</strong></h3><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p>
<p>点击“媒资管理”</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006.gif" alt="img"></p>
<p>进入媒资管理列表页面查询本机构上传的媒资文件。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008.gif" alt="img"></p>
<p>2、教育机构用户在”媒资管理”页面中点击 “上传视频” 按钮。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010.gif" alt="img"></p>
<p>点击“上传视频”打开上传页面</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012.gif" alt="img"></p>
<p>3、选择要上传的文件，自动执行文件上传，视频上传成功会自动处理。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014.gif" alt="img"></p>
<h3 id="1-2-3-处理视频"><a href="#1-2-3-处理视频" class="headerlink" title="1.2.3 处理视频"></a><strong>1.2.3</strong> <strong>处理视频</strong></h3><p>对需要转码处理的视频系统会自动对其处理，处理后生成视频的URL。</p>
<p>处理视频没有用户界面，完全是后台自动执行。</p>
<h3 id="1-2-4-审核媒资"><a href="#1-2-4-审核媒资" class="headerlink" title="1.2.4 审核媒资"></a><strong>1.2.4</strong> <strong>审核媒资</strong></h3><p>审核媒资包括程序自动审核和人工审核，程序可以通过鉴黄接口(<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)%E5%AE%A1%E6%A0%B8%E8%A7%86%E9%A2%91%EF%BC%8C%E5%AF%B9%E6%9C%89%E5%BC%82%E8%AE%AE%E7%9A%84%E8%A7%86%E9%A2%91%E7%94%B1%E4%BA%BA%E5%B7%A5%E8%BF%9B%E8%A1%8C%E5%AE%A1%E6%A0%B8%E3%80%82">https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)审核视频，对有异议的视频由人工进行审核。</a></p>
<p>1.运营用户登入运营平台并进入媒资管理页面，查找待审核媒资</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016.gif" alt="img"></p>
<p>2.点击列表中媒资名称链接，可预览该媒资，若是视频，则播放视频。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018.gif" alt="img"></p>
<p>3.点击列表中某媒资后的”审核” 按钮，既完成媒资的审批过程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020.gif" alt="img"></p>
<p> 点击“审核”，选择审核结果，输入审核意见。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022.gif" alt="img"></p>
<h3 id="1-2-5-绑定媒资"><a href="#1-2-5-绑定媒资" class="headerlink" title="1.2.5 绑定媒资"></a><strong>1.2.5</strong> <strong>绑定媒资</strong></h3><p>课程计划创建好后需要绑定媒资文件，比如：如果课程计划绑定了视频文件，进入课程在线学习界面后点课程计划名称则在线播放视频。如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image024.gif" alt="img"></p>
<p>如何将课程计划绑定媒资呢？</p>
<p>1.教育机构用户进入课程管理页面并编辑某一个课程，在”课程大纲”标签页的某一小节后可点击”添加视频“。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image026.gif" alt="img"></p>
<p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image028.gif" alt="img"></p>
<p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image030.gif" alt="img"></p>
<p>课程计划关联视频后如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image032.gif" alt="img"></p>
<h2 id="1-3-数据模型"><a href="#1-3-数据模型" class="headerlink" title="1.3 数据模型"></a><strong>1.3</strong> <strong>数据模型</strong></h2><p>本模块媒资文件相关的数据表如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image034.gif" alt="img"></p>
<p>媒资文件表：存储文件信息，包括图片、视频、文档等。</p>
<p>media_process: 待处理视频表。</p>
<p>media_process_history: 视频处理历史表，记录已经处理成功的视频信息。</p>
<p>媒资文件与课程计划绑定关系表如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image036.gif" alt="img"></p>
<h1 id="2-搭建模块环境"><a href="#2-搭建模块环境" class="headerlink" title="2 搭建模块环境"></a><strong>2</strong> <strong>搭建模块环境</strong></h1><h2 id="2-1-架构的问题分析"><a href="#2-1-架构的问题分析" class="headerlink" title="2.1 架构的问题分析"></a><strong>2.1</strong> <strong>架构的问题分析</strong></h2><p>当前要开发的是媒资管理服务，目前为止共三个微服务：内容管理、系统管理、媒资管理，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-17109957485941.gif" alt="img"></p>
<p>后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：</p>
<p>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护，比如下边代码中请求系统管理服务的地址使用的是localhost</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-17109957485952.gif" alt="img"></p>
<p>当系统上线后这里需要改成公网的域名，如果这种地址非常多则非常麻烦。</p>
<p>基于这个问题可以采用网关来解决，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-17109957485953.gif" alt="img"></p>
<p>这样在前端的代码中只需要指定每个接口的相对路径，如下所示：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-17109957485954.gif" alt="img"></p>
<p>在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务。</p>
<p>为什么所有的请求先到网关呢？</p>
<p>有了网关就可以对请求进行路由，路由到具体的微服务，减少外界对接微服务的成本，比如：400电话，路由的试可以根据请求路径进行路由、根据host地址进行路由等， 当微服务有多个实例时可以通过负载均衡算法进行路由，如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-17109957485955.gif" alt="img"></p>
<p>另外，网关还可以实现权限控制、限流等功能。</p>
<p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用Nacos作用服务发现中心和配置中心，整体的架构图如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012-17109957485956.gif" alt="img"></p>
<p>流程如下：</p>
<p>1、微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p>
<p>2、网关从Nacos读取服务列表，包括服务名称、服务地址等。</p>
<p>3、请求到达网关，网关将请求路由到具体的微服务。</p>
<p>要使用网关首先搭建Nacos，Nacos有两个作用：</p>
<p>1、服务发现中心。</p>
<p>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</p>
<p>2、配置中心。</p>
<p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</p>
<h2 id="2-2-搭建Nacos"><a href="#2-2-搭建Nacos" class="headerlink" title="2.2 搭建Nacos"></a><strong>2.2</strong> <strong>搭建Nacos</strong></h2><h3 id="2-2-1-服务发现中心"><a href="#2-2-1-服务发现中心" class="headerlink" title="2.2.1 服务发现中心"></a><strong>2.2.1</strong> <strong>服务发现中心</strong></h3><p>Spring Cloud ：一套规范</p>
<p>Spring Cloud alibaba: nacos服务注册中心，配置中心</p>
<p>根据上节讲解的网关的架构图，<strong>要使用网关首先搭建Nacos</strong>。</p>
<p>首先搭建Nacos服务发现中心。</p>
<p>在搭建Nacos服务发现中心之前需要搞清楚两个概念：namespace和group</p>
<p>namespace：用于区分环境、比如：开发环境、测试环境、生产环境。</p>
<p>group：用于区分项目，比如：xuecheng-plus项目、xuecheng2.0项目</p>
<p>首先在nacos配置namespace:</p>
<p>登录Centos，启动Naocs，使用sh &#x2F;data&#x2F;soft&#x2F;restart.sh将自动启动Nacos。</p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8848/nacos/">http://192.168.101.65:8848/nacos/</a></p>
<p>账号密码：nacos&#x2F;nacos</p>
<p>登录成功，点击左侧菜单“命名空间”进入命名空间管理界面，</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014-17109957485957.gif" alt="img"></p>
<p>点击“新建命名空间”，填写命名空间的相关信息。如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016-17109957485958.gif" alt="img"></p>
<p>使用相同的方法再创建“测试环境”、”生产环境”的命名空间。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018-17109957485959.gif" alt="img"></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020-171099574859510.gif" alt="img"></p>
<p>创建成功，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022-171099574859511.gif" alt="img"></p>
<p>在教学中可以创建具体班级的命名空间，假如创建1010班级的命名空间，如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image024-171099574859512.gif" alt="img"></p>
<p>注意：如果使用dev1010命名空间，在下边的配置中对namespace配置为dev1010。</p>
<p>首先完成各服务注册到Naocs，下边将内容管理服务注册到nacos中。</p>
<p>1）在xuecheng-plus-parent中添加依赖管理 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）在内容管理模块的接口工程、系统管理模块的接口工程中添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）配置nacos的地址</p>
<p>在系统管理的service工程的配置文件中配置如下信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">YAML</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure>

<p>在内容管理的接口工程的配置文件中配置如下信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure>



<p>4）重启内容管理服务、系统管理服务。</p>
<p>待微服务启动成功，进入Nacos服务查看服务列表</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image026-171099574859513.gif" alt="img"></p>
<p>在 “开发环境” 命名空间下有两个服务这说明内容管理微服务和系统管理微服务在Nacos注册成功。</p>
<p>点击其它一个微服务的“详情”</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image028-171099574859514.gif" alt="img"></p>
<p>通过上图可以查看微服务实例的地址。</p>
<h3 id="2-2-2-配置中心"><a href="#2-2-2-配置中心" class="headerlink" title="2.2.2 配置中心"></a><strong>2.2.2</strong> <strong>配置中心</strong></h3><h4 id="2-2-2-1-配置三要素"><a href="#2-2-2-1-配置三要素" class="headerlink" title="2.2.2.1 配置三要素"></a><strong>2.2.2.1</strong> <strong>配置三要素</strong></h4><p>搭建完成Nacos服务发现中心，下边搭建Nacos为配置中心，其目的就是通过Nacos去管理项目的所有配置。</p>
<p>先将项目中的配置文件分分类：</p>
<p>1、每个项目特有的配置</p>
<p>是指该配置只在有些项目中需要配置，或者该配置在每个项目中配置的值不同。</p>
<p>比如：spring.application.name每个项目都需要配置但值不一样，以及有些项目需要连接数据库而有些项目不需要，有些项目需要配置消息队列而有些项目不需要。</p>
<p>2、项目所公用的配置</p>
<p>是指在若干项目中配置内容相同的配置。比如：redis的配置，很多项目用的同一套redis服务所以配置也一样。</p>
<p>另外还需要知道nacos如何去定位一个具体的配置文件，即：namespace、group、dataid. </p>
<p>1、通过namespace、group找到具体的环境和具体的项目。</p>
<p>2、通过dataid找到具体的配置文件，dataid有三部分组成</p>
<p>比如：content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成</p>
<p>content-service：第一部分，它是在application.yaml中配置的应用名，即spring.application.name的值。</p>
<p>dev：第二部分，它是环境名，通过spring.profiles.active指定，</p>
<p>Yaml: 第三部分，它是配置文件 的后缀，目前nacos支持properties、yaml等格式类型，本项目选择yaml格式类型。</p>
<p>所以，如果我们要配置content-service工程的配置文件:</p>
<p>在开发环境中配置content-service-dev.yaml</p>
<p>在测试环境中配置content-service-test.yaml</p>
<p>在生产环境中配置content-service-prod.yaml</p>
<p>我们启动项目中传入spring.profiles.active的参数决定引用哪个环境的配置文件，例如：传入spring.profiles.active&#x3D;dev表示使用dev环境的配置文件即content-service-dev.yaml。</p>
<h4 id="2-2-2-2-配置content-service"><a href="#2-2-2-2-配置content-service" class="headerlink" title="2.2.2.2 配置content-service"></a><strong>2.2.2.2</strong> <strong>配置</strong>content-service</h4><p>下边以开发环境为例对content-service工程的配置文件进行配置，进入nacos，进入开发环境。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image030-171099574859515.gif" alt="img"></p>
<p>点击加号，添加一个配置</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image032-171099574859516.gif" alt="img"></p>
<p>输入data id、group以及配置文件内容。</p>
<p>为什么没在nacos中配置下边的内容 ？</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br></pre></td></tr></table></figure>

<p>因为刚才说了dataid第一部分就是spring.application.name，nacos 客户端要根据此值确定配置文件 名称，所以spring.application.name不在nacos中配置，而是要在工程的本地进行配置。</p>
<p>在content-service工程的test&#x2F;resources 中添加bootstrap.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#profiles默认为dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>在内容管理模块的接口工程和service工程配置依赖：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">    <span class="string">&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span><br><span class="line">    <span class="string">&lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span></span><br><span class="line"><span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置完成，运行content-service工程 的单元测试文件，能否正常测试，跟踪单元测试方法可以正常读取数据库的数据，说明从nacos读取配置信息正常。</p>
<p>通过运行观察控制台打印出下边的信息，NacosRestTemplate.java通过Post方式与nacos服务端交互读取配置信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:<span class="number">476</span>] - HTTP method: POST, url: http:<span class="comment">//192.168.101.65:8848/nacos/v1/cs/configs/listener, body: &#123;Listening-Configs=content-service.yaml?xuecheng-plus-project??dev?content-service-dev.yaml?xuecheng-plus-project?88459b1483b8381eccc2ef462bd59182?dev?content-service?xuecheng-plus-project??dev?, tenant=dev&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-3配置content-api"><a href="#2-2-2-3配置content-api" class="headerlink" title="2.2.2.3配置content-api"></a><strong>2.2.2.3</strong>配置<strong>content-api</strong></h4><p>以相同的方法配置content-api工程的配置文件，在nacos中的开发环境中配置content-api-dev.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/content</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63040</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># swagger 文档配置</span></span><br><span class="line"><span class="attr">swagger:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">&quot;学成在线内容管理系统&quot;</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;内容系统管理系统对课程相关信息进行业务管理数据&quot;</span></span><br><span class="line">  <span class="attr">base-package:</span> <span class="string">com.xuecheng.content</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>在content-api工程 的本地配置bootstrap.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>



<p><font color="red"> 注意：因为api接口工程依赖了service工程 的jar，所以这里使用extension-configs扩展配置文件 的方式引用service工程所用到的配置文件。</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>如果添加多个扩展文件，继续在下添加即可，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">填写文件</span> <span class="string">dataid</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span>           </span><br></pre></td></tr></table></figure>



<p>启动content-api工程，查询控制台是否打印出了请求nacos的日志，如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:476] - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener </span><br></pre></td></tr></table></figure>

<p>并使用Httpclient测试课程查询接口是否可以正常查询。</p>
<h3 id="2-2-3-公用配置"><a href="#2-2-3-公用配置" class="headerlink" title="2.2.3 公用配置"></a><strong>2.2.3</strong> <strong>公用配置</strong></h3><p>还有一个优化的点是如何在nacos中配置项目的公用配置呢？</p>
<p>nacos提供了shared-configs可以引入公用配置。</p>
<p>在content-api中配置了swagger，所有的接口工程 都需要配置swagger，这里就可以将swagger的配置定义为一个公用配置，哪个项目用引入即可。</p>
<p>单独在xuecheng-plus-common分组下创建xuecheng-plus的公用配置，进入nacos的开发环境，添加swagger-dev.yaml公用配置</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image034-171099574859517.gif" alt="img"></p>
<p>删除接口工程中对swagger的配置。</p>
<p>项目使用shared-configs可以引入公用配置。在接口工程的本地配置文件 中引入公用配置，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">swagger-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>再以相同 的方法配置日志的公用配置。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image036-171099574859518.gif" alt="img"></p>
<p>在接口工程和业务工程，引入loggin-dev.yaml公用配置文件 </p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image038.gif" alt="img"></p>
<p>配置完成，重启content-api接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html">http://localhost:63040/content/swagger-ui.html</a> 查看swagger接口文档是否可以正常访问，查看控制台log4j2日志输出是否正常。</p>
<h3 id="2-2-4-配置优先级"><a href="#2-2-4-配置优先级" class="headerlink" title="2.2.4 配置优先级"></a><strong>2.2.4</strong> <strong>配置优先级</strong></h3><p>到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml和nacos上的配置文件，SpringBoot读取配置文件 的顺序如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image040.gif" alt="img"></p>
<p>引入配置文件的形式有：</p>
<p>1、以项目应用名方式引入</p>
<p>2、以扩展配置文件方式引入</p>
<p>3、以共享配置文件 方式引入</p>
<p>4、本地配置文件</p>
<p>各配置文件 的优先级：项目应用名配置文件 &gt; 扩展配置文件 &gt; 共享配置文件 &gt; 本地配置文件。</p>
<p>有时候我们在测试程序时直接在本地加一个配置进行测试，比如下边的例子：</p>
<p>我们想启动两个内容管理微服务，此时需要在本地指定不同的端口，通过VM Options参数，在IDEA配置启动参数</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image042.gif" alt="img"></p>
<p>通过-D指定参数名和参数值，参数名即在bootstrap.yml中配置的server.port。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image044.gif" alt="img"></p>
<p>启动ContentApplication2，发现端口仍然是63040，这说明本地的配置没有生效。</p>
<p>这时我们想让本地最优先，可以在nacos配置文件 中配置如下即可实现：</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>再次启动ContentApplication2，端口为63041。</p>
<h3 id="2-2-5-导入配置文件"><a href="#2-2-5-导入配置文件" class="headerlink" title="2.2.5 导入配置文件"></a><strong>2.2.5</strong> <strong>导入配置文件</strong></h3><p>课程资料中提供了系统用的所有配置文件nacos_config_export.zip，下边将nacos_config_export.zip导入nacos。</p>
<p>进入具体的命名空间，点击“导入配置”</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image046.gif" alt="img"></p>
<p>打开导入窗口</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image048.gif" alt="img"></p>
<p>相同的配置选择覆盖配置。</p>
<p>点击“上传文件”选择资料中的nacos_config_export.zip开始导入。</p>
<h3 id="2-2-6-作业"><a href="#2-2-6-作业" class="headerlink" title="2.2.6 作业"></a><strong>2.2.6</strong> <strong>作业</strong></h3><p>按照上边的方法 自行将系统管理服务的配置信息在nacos上进行配置。</p>
<h2 id="2-3-搭建Gateway"><a href="#2-3-搭建Gateway" class="headerlink" title="2.3 搭建Gateway"></a><strong>2.3</strong> <strong>搭建Gateway</strong></h2><p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p>
<p>新建一个网关工程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-17110063357841.gif" alt="img"></p>
<p>工程结构</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-17110063357852.gif" alt="img"></p>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定父工程为xuecheng-plus-parent--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--服务发现中心--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>配置网关的bootstrap.yaml配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>



<p>在nacos上配置网关路由策略：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-17110063357853.gif" alt="img"></p>
<p>详细配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63010</span> <span class="comment"># 网关端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line"><span class="comment">#      filter:</span></span><br><span class="line"><span class="comment">#        strip-prefix:</span></span><br><span class="line"><span class="comment">#          enabled: true</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">content-api</span> <span class="comment"># 路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://content-api</span> <span class="comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/content/**</span> <span class="comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">system-api</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://system-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/system/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">media-api</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://media-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/media/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>启动网关工程，通过网关工程访问微服务进行测试。</p>
<p>在http-client-env.json中配置网关的地址</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-17110063357854.gif" alt="img"></p>
<p>使用httpclient测试课程查询 接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">### 课程查询列表</span><br><span class="line">POST &#123;&#123;gateway_host&#125;&#125;/content/course/list?pageNo=<span class="number">2</span>&amp;pageSize=<span class="number">1</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;courseName&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行，观察是否可以正常访问接口 ，如下所示可以正常请求接口。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:63010/content/course/list?pageNo=2&amp;pageSize=1</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">transfer-encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Sun<span class="punctuation">,</span> <span class="number">11</span> Sep <span class="number">2022</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">54</span><span class="punctuation">:</span><span class="number">32</span> GMT</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring cloud实战&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-09-04 09:56:19&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-12-26 22:10:38&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changePeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;203001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-17110063357855.gif" alt="img"></p>
<p>启动前端工程，测试之前开发内容管理模块的功能。</p>
<p>观察网关控制台，通过网关转发课程查询的日志如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-03-21 16:02:53.536 DEBUG 9084 --- [tor-http-nio-10] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: POST http://localhost:63010/content/course/list?pageNo=1&amp;pageSize=2] to Route&#123;<span class="built_in">id</span>=<span class="string">&#x27;content-api&#x27;</span>, uri=lb://content-api, order=0, predicate=Paths: [/content/**], match trailing slash: <span class="literal">true</span>, gatewayFilters=[], metadata=&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-4-搭建媒资工程"><a href="#2-4-搭建媒资工程" class="headerlink" title="2.4 搭建媒资工程"></a><strong>2.4</strong> <strong>搭建媒资工程</strong></h2><p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目。</p>
<p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p>
<p>右键pom.xml转为maven工程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-171100943395211.gif" alt="img"></p>
<p>下边做如下配置：</p>
<p>1、创建媒资数据库xc_media，并导入资料目录中的xcplus_media.sql</p>
<p>2、修改nacos上的media-service-dev.yaml配置文件中的数据库链接信息</p>
<p>重启media-api工程只要能正常启动成功即可，稍后根据需求写接口。</p>
<h1 id="3-分布式文件系统"><a href="#3-分布式文件系统" class="headerlink" title="3 分布式文件系统"></a><strong>3</strong> <strong>分布式文件系统</strong></h1><h2 id="3-1-什么是分布式文件系统"><a href="#3-1-什么是分布式文件系统" class="headerlink" title="3.1 什么是分布式文件系统"></a><strong>3.1</strong> <strong>什么是分布式文件系统</strong></h2><p>要理解分布式文件系统首先了解什么是文件系统。</p>
<p>查阅百度百科：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-171101045189613.gif" alt="img"></p>
<p>​    文件系统是负责管理和存储文件的系统软件，操作系统通过文件系统提供的接口去存取文件，用户通过操作系统访问磁盘上的文件。</p>
<p>下图指示了文件系统所处的位置：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-171101045189615.gif" alt="img"></p>
<p>常见的文件系统：FAT16&#x2F;FAT32、NTFS、HFS、UFS、APFS、XFS、Ext4等 。</p>
<p>现在有个问题，一此短视频平台拥有大量的视频、图片，这些视频文件、图片文件该如何存储呢？如何存储可以满足互联网上海量用户的浏览。</p>
<p>今天讲的分布式文件系统就是海量用户查阅海量文件的方案。</p>
<p>我们阅读百度百科去理解分布式文件系统的定义：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-171101045189614.gif" alt="img"></p>
<p>通过概念可以简单理解为：一个计算机无法存储海量的文件，通过网络将若干计算机组织起来共同去存储海量的文件，去接收海量用户的请求，这些组织起来的计算机通过网络进行通信，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-171101045189616.gif" alt="img"></p>
<p>好处：</p>
<p>1、一台计算机的文件系统处理能力扩充到多台计算机同时处理。</p>
<p>2、一台计算机挂了还有另外副本计算机提供数据。</p>
<p>3、每台计算机可以放在不同的地域，这样用户就可以就近访问，提高访问速度。</p>
<p>市面上有哪些分布式文件系统的产品呢？</p>
<p>1、NFS</p>
<p>阅读百度百科：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-171101045189617.gif" alt="img"></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012-171101045189618.gif" alt="img"></p>
<p>特点：</p>
<p>1）在客户端上映射NFS服务器的驱动器。</p>
<p>2）客户端通过网络访问NFS服务器的硬盘完全透明。</p>
<p>2、GFS</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014-171101045189619.gif" alt="img"></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016-171101045189620.gif" alt="img"></p>
<p>1）GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成。</p>
<p>2）master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中。</p>
<p>3）用户从master中获取数据元信息，向chunkserver存储数据。</p>
<p>3、HDFS</p>
<p>HDFS，是Hadoop Distributed File System的简称，是Hadoop抽象文件系统的一种实现。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</p>
<p>下图是HDFS的架构图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018-171101045189621.gif" alt="img"></p>
<p>1）HDFS采用主从结构，一个HDFS集群由一个名称结点和若干数据结点组成。</p>
<p>2）名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p>
<p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p>
<h2 id="云计算厂家"><a href="#云计算厂家" class="headerlink" title="云计算厂家"></a><strong>云计算厂家</strong></h2><p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于 99.9999999999%（12 个 9），服务设计可用性（或业务连续性）不低于 99.995%。</p>
<p><em>官方网站：</em><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss"><em>https://www.aliyun.com/product/oss</em></a> </p>
<p>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。您可以将任意数量和形式的非结构化数据存入BOS，并对数据进行管理和处理。BOS支持标准、低频、冷和归档存储等多种存储类型，满足多场景的存储需求。 </p>
<p><em>官方网站：</em><a target="_blank" rel="noopener" href="https://cloud.baidu.com/product/bos.html"><em>https://cloud.baidu.com/product/bos.html</em></a> </p>
<h2 id="3-2-MinIO"><a href="#3-2-MinIO" class="headerlink" title="3.2 MinIO"></a><strong>3.2 MinIO</strong></h2><h3 id="3-2-1-介绍"><a href="#3-2-1-介绍" class="headerlink" title="3.2.1 介绍"></a><strong>3.2.1</strong> <strong>介绍</strong></h3><p>本项目采用MinIO构建分布式文件系统，MinIO 是一个非常轻量的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器&#x2F;虚拟机镜像等。</p>
<p>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大5TB，兼容 Amazon S3接口，提供了 Java、Python、GO等多版本SDK支持。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://min.io/">https://min.io</a></p>
<p>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/%EF%BC%8Chttp://docs.minio.org.cn/docs/">https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</a></p>
<p>MinIO集群采用去中心化共享架构，每个结点是对等关系，通过Nginx可对MinIO进行负载均衡访问。</p>
<p>去中心化有什么好处？</p>
<p>在大数据领域，通常的设计理念都是无中心和分布式。Minio分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p>
<p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式Minio避免了单点故障。如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020-171101045189622.gif" alt="img"></p>
<p>Minio使用纠删码技术来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各各节点的磁盘上，所有的可用磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，除了将文件本身分成4个数据块，还会生成4个校验块，数据块和校验块会分散的存储在这8块硬盘上。</p>
<p>使用纠删码的好处是即便丢失一半数量（N&#x2F;2）的硬盘，仍然可以恢复数据。 比如上边集合中有4个以内的硬盘损害仍可保证数据恢复，不影响上传和下载，如果多于一半的硬盘坏了则无法恢复。</p>
<h3 id="3-2-2-数据恢复演示"><a href="#3-2-2-数据恢复演示" class="headerlink" title="3.2.2 数据恢复演示"></a><strong>3.2.2</strong> <strong>数据恢复演示</strong></h3><p>下边在本机演示MinIO恢复数据的过程，在本地创建4个目录表示4个硬盘。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022-171101045189623.gif" alt="img"></p>
<p>下载minio，下载地址在<a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/%EF%BC%8C%E5%8F%AF%E4%BB%8E%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99%E6%89%BE%E5%88%B0MinIO%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6minio.zip%E8%A7%A3%E5%8E%8B%E5%8D%B3%E5%8F%AF%E4%BD%BF%E7%94%A8%EF%BC%8CCMD%E8%BF%9B%E5%85%A5%E6%9C%89minio.exe%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E8%BF%90%E8%A1%8C%E4%B8%8B%E8%BE%B9%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A">https://dl.min.io/server/minio/release/，可从课程资料找到MinIO的安装文件minio.zip解压即可使用，CMD进入有minio.exe的目录，运行下边的命令：</a></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minio.exe server D:\develop\minio_data\data1  D:\develop\minio_data\data2  D:\develop\minio_data\data3  D:\develop\minio_data\data4</span><br></pre></td></tr></table></figure>

<p>启动结果如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image024-171101045189724.gif" alt="img"></p>
<p>说明如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span></span><br><span class="line">WARNING: MINIO_ACCESS_KEY <span class="keyword">and</span> MINIO_SECRET_KEY <span class="keyword">are</span> deprecated.</span><br><span class="line">         Please use MINIO_ROOT_USER <span class="keyword">and</span> MINIO_ROOT_PASSWORD</span><br><span class="line">Formatting <span class="number">1</span>st pool, <span class="number">1</span> <span class="keyword">set</span>(s), <span class="number">4</span> drives <span class="keyword">per</span> set.</span><br><span class="line">WARNING: Host <span class="keyword">local</span> has more than <span class="number">2</span> drives <span class="keyword">of</span> set. A host failure will <span class="keyword">result</span> <span class="keyword">in</span> data becoming unavailable.</span><br><span class="line">WARNING: Detected <span class="keyword">default</span> credentials <span class="string">&#x27;minioadmin:minioadmin&#x27;</span>, we recommend that you change these <span class="keyword">values</span> <span class="keyword">with</span> <span class="string">&#x27;MINIO_ROOT_USER&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;MINIO_ROOT_PASSWORD&#x27;</span> environment variables</span><br></pre></td></tr></table></figure>

<p>1）老版本使用的MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY不推荐使用，推荐使用MINIO_ROOT_USER 和MINIO_ROOT_PASSWORD设置账号和密码。</p>
<p>2）pool即minio节点组成的池子，当前有一个pool和4个硬盘组成的set集合</p>
<p>3）因为集合是4个硬盘，大于2的硬盘损坏数据将无法恢复。</p>
<p>4）账号和密码默认为minioadmin、minioadmin，可以在环境变量中设置通过’MINIO_ROOT_USER’ and ‘MINIO_ROOT_PASSWORD’ 进行设置。</p>
<p>下边输入<a href="http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin">http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin</a></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image026-171101045189725.gif" alt="img"></p>
<p>登录成功：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image028-171101045189726.gif" alt="img"></p>
<p>下一步创建bucket，桶，它相当于存储文件的目录，可以创建若干的桶。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image030-171101045189727.gif" alt="img"></p>
<p>输入bucket的名称，点击“CreateBucket”，创建成功</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image032-171101045189728.gif" alt="img"></p>
<p>点击“upload”上传文件。</p>
<p>下边上传几个文件 </p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image034-171101045189729.gif" alt="img"></p>
<p>下边去四个目录观察文件的存储情况</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image036-171101045189730.gif" alt="img"></p>
<p>我们发现上传的1.mp4文件存储在了四个目录，即四个硬盘上。</p>
<p>下边测试minio的数据恢复过程：</p>
<p>1、首先删除一个目录。</p>
<p>删除目录后仍然可以在web控制台上传文件和下载文件。</p>
<p>稍等片刻删除的目录自动恢复。</p>
<p>2、删除两个目录。</p>
<p>删除两个目录也会自动恢复。</p>
<p>3、删除三个目录 。</p>
<p>由于 集合中共有4块硬盘，有大于一半的硬盘损坏数据无法恢复。</p>
<p>此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p>
<h3 id="3-2-3-测试Docker环境"><a href="#3-2-3-测试Docker环境" class="headerlink" title="3.2.3 测试Docker环境"></a><strong>3.2.3</strong> <strong>测试</strong>Docker环境</h3><p>开发阶段和生产阶段统一使用Docker下的MINIO。</p>
<p>在下发的虚拟机中已安装了MinIO的镜像和容器，执行sh &#x2F;data&#x2F;soft &#x2F;restart.sh启动Docker下的MinIO</p>
<p>启动完成登录MinIO查看是否正常。</p>
<p>访问<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/">http://192.168.101.65:9000</a></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image038-171101045189731.gif" alt="img"></p>
<p>本项目创建两个buckets：</p>
<p>mediafiles： 普通文件</p>
<p>video：视频文件</p>
<h3 id="3-2-4-SDK"><a href="#3-2-4-SDK" class="headerlink" title="3.2.4 SDK"></a><strong>3.2.4 SDK</strong></h3><h4 id="3-2-4-1上传文件"><a href="#3-2-4-1上传文件" class="headerlink" title="3.2.4.1上传文件"></a><strong>3.2.4.1上传文件</strong></h4><p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>最低需求Java 1.8或更高版本:</p>
<p>maven依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在media-service工程添加此依赖。</p>
<p>参数说明：</p>
<p>需要三个参数才能连接到minio服务。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Endpoint</td>
<td>对象存储服务的URL</td>
</tr>
<tr>
<td>Access  Key</td>
<td>Access  key就像用户ID，可以唯一标识你的账户。</td>
</tr>
<tr>
<td>Secret  Key</td>
<td>Secret  key是你账户的密码。</td>
</tr>
</tbody></table>
<p>官方的示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.minio.BucketExistsArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MakeBucketArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.MinioException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploader</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidKeyException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span></span><br><span class="line">      <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">          MinioClient.builder()</span><br><span class="line">              .endpoint(<span class="string">&quot;https://play.min.io&quot;</span>)</span><br><span class="line">              .credentials(<span class="string">&quot;Q3AM3UQ867SPQQA43P2F&quot;</span>, <span class="string">&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;</span>)</span><br><span class="line">              .build();</span><br><span class="line">      <span class="comment">// Make &#x27;asiatrip&#x27; bucket if not exist.</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span></span><br><span class="line">          minioClient.bucketExists(BucketExistsArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">      <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        <span class="comment">// Make a new bucket called &#x27;asiatrip&#x27;.</span></span><br><span class="line">        minioClient.makeBucket(MakeBucketArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bucket &#x27;asiatrip&#x27; already exists.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Upload &#x27;/home/user/Photos/asiaphotos.zip&#x27; as object name &#x27;asiaphotos-2015.zip&#x27; to bucket</span></span><br><span class="line">      <span class="comment">// &#x27;asiatrip&#x27;.</span></span><br><span class="line">      minioClient.uploadObject(</span><br><span class="line">          UploadObjectArgs.builder()</span><br><span class="line">              .bucket(<span class="string">&quot;asiatrip&quot;</span>)</span><br><span class="line">              .object(<span class="string">&quot;asiaphotos-2015.zip&quot;</span>)</span><br><span class="line">              .filename(<span class="string">&quot;/home/user/Photos/asiaphotos.zip&quot;</span>)</span><br><span class="line">              .build());</span><br><span class="line">      System.out.println(</span><br><span class="line">          <span class="string">&quot;&#x27;/home/user/Photos/asiaphotos.zip&#x27; is successfully uploaded as &quot;</span></span><br><span class="line">              + <span class="string">&quot;object &#x27;asiaphotos-2015.zip&#x27; to bucket &#x27;asiatrip&#x27;.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MinioException e) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Error occurred: &quot;</span> + e);</span><br><span class="line">      System.out.println(<span class="string">&quot;HTTP trace: &quot;</span> + e.httpTrace());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>参考示例在media-service工程中 测试上传文件功能，</p>
<p>首先创建一个用于测试的bucket</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image040-171101045189732.gif" alt="img"></p>
<p>点击“Manage”修改bucket的访问权限</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image042-171101045189733.gif" alt="img"></p>
<p>选择public权限</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image044-171101045189734.gif" alt="img"></p>
<p>在xuecheng-plus-media-service工程 的test下编写测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.BucketExistsArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MakeBucketArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.MinioException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试MinIO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/11 21:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">            MinioClient.builder()</span><br><span class="line">                    .endpoint(<span class="string">&quot;http://192.168.101.65:9000&quot;</span>)</span><br><span class="line">                    .credentials(<span class="string">&quot;minioadmin&quot;</span>, <span class="string">&quot;minioadmin&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line"><span class="comment">//                    .object(&quot;test001.mp4&quot;)</span></span><br><span class="line">                    .object(<span class="string">&quot;001/test001.mp4&quot;</span>)<span class="comment">//添加子目录</span></span><br><span class="line">                    .filename(<span class="string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span>)</span><br><span class="line">                    .contentType(<span class="string">&quot;video/mp4&quot;</span>)<span class="comment">//默认根据扩展名确定文件内容类型，也可以指定</span></span><br><span class="line">                    .build();</span><br><span class="line">            minioClient.uploadObject(testbucket);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行upload方法，分别测试向桶的根目录上传文件以及子目录上传文件。</p>
<p>上传成功，通过web控制台查看文件，并预览文件。</p>
<p>说明：</p>
<p>设置contentType可以通过com.j256.simplemagic.ContentType枚举类查看常用的mimeType（媒体类型）</p>
<p>通过扩展名得到mimeType，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line"><span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流</span></span><br></pre></td></tr></table></figure>

<p>完善上边的代码 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line">    <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流</span></span><br><span class="line">    <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;</span><br><span class="line">        mimeType = extensionMatch.getMimeType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">            .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">            <span class="comment">//                    .object(&quot;test001.mp4&quot;)</span></span><br><span class="line">            .object(<span class="string">&quot;001/test001.mp4&quot;</span>)<span class="comment">//添加子目录</span></span><br><span class="line">            .filename(<span class="string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span>)</span><br><span class="line">            .contentType(mimeType)<span class="comment">//默认根据扩展名确定文件内容类型，也可以指定</span></span><br><span class="line">            .build();</span><br><span class="line">        minioClient.uploadObject(testbucket);</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-4-2-删除文件"><a href="#3-2-4-2-删除文件" class="headerlink" title="3.2.4.2 删除文件"></a><strong>3.2.4.2</strong> <strong>删除文件</strong></h4><p>下边测试删除文件</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-api-reference#removeObject">https://docs.min.io/docs/java-client-api-reference#removeObject</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        minioClient.removeObject(</span><br><span class="line">               RemoveObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;001/test001.mp4&quot;</span>).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;删除失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-4-3-查询文件"><a href="#3-2-4-3-查询文件" class="headerlink" title="3.2.4.3 查询文件"></a><strong>3.2.4.3</strong> <strong>查询文件</strong></h4><p>通过查询文件查看文件是否存在minio中。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-api-reference#getObject">https://docs.min.io/docs/java-client-api-reference#getObject</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询文件</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getFile</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;test001.mp4&quot;</span>).build();</span><br><span class="line">    <span class="keyword">try</span>(</span><br><span class="line">        <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1_2.mp4&quot;</span>));</span><br><span class="line">     ) &#123;</span><br><span class="line">        IOUtils.copy(inputStream,outputStream);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​       </p>
<p>校验文件的完整性，对文件计算出md5值，比较原始文件的md5和目标文件的md5，一致则说明完整</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//校验文件的完整性对文件的内容进行md5</span></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1.mp4&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">source_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream1);</span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1a.mp4&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">local_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line"><span class="keyword">if</span>(source_md5.equals(local_md5))&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;下载成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="4-上传图片"><a href="#4-上传图片" class="headerlink" title="4 上传图片"></a><strong>4</strong> <strong>上传图片</strong></h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a><strong>4.1</strong> <strong>需求分析</strong></h2><h3 id="4-1-1-业务流程"><a href="#4-1-1-业务流程" class="headerlink" title="4.1.1 业务流程"></a><strong>4.1.1</strong> <strong>业务流程</strong></h3><p>课程图片是宣传课程非常重要的信息，在新增课程界面上传课程图片，也可以修改课程图片。</p>
<p>如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-17110280643141.gif" alt="img"></p>
<p>上传课程图片总体上包括两部分：</p>
<p>1、上传课程图片前端请求媒资管理服务将文件上传至分布式文件系统，并且在媒资管理数据库保存文件信息。</p>
<p>2、上传图片成功保存图片地址到课程基本信息表中。</p>
<p>详细流程如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-17110280643152.gif" alt="img"></p>
<p>1、前端进入上传图片界面</p>
<p>2、上传图片，请求媒资管理服务。</p>
<p>3、媒资管理服务将图片文件存储在MinIO。</p>
<p>4、媒资管理记录文件信息到数据库。</p>
<p>5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。</p>
<h3 id="4-1-2-数据模型"><a href="#4-1-2-数据模型" class="headerlink" title="4.1.2 数据模型"></a><strong>4.1.2</strong> <strong>数据模型</strong></h3><p>涉及到的数据表有：课程信息表中的图片字段、媒资数据库的文件表，下边主要看媒资数据库的文件表。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-17110280643153.gif" alt="img"></p>
<p>各字段描述如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-17110280643154.gif" alt="img"></p>
<h2 id="4-2-准备环境"><a href="#4-2-准备环境" class="headerlink" title="4.2 准备环境"></a><strong>4.2</strong> <strong>准备环境</strong></h2><p>首先在minio配置bucket，bucket名称为：mediafiles，并设置bucket的权限为公开。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-17110280643155.gif" alt="img"></p>
<p>在nacos配置中minio的相关信息，进入media-service-dev.yaml:</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012-17110280643157.gif" alt="img"></p>
<p>配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">http://192.168.101.65:9000</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">secretKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">bucket:</span></span><br><span class="line">    <span class="attr">files:</span> <span class="string">mediafiles</span></span><br><span class="line">    <span class="attr">videofiles:</span> <span class="string">video</span></span><br></pre></td></tr></table></figure>



<p>在media-service工程编写minio的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> minio配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 19:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String endpoint;</span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String accessKey;</span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line"> <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">          MinioClient.builder()</span><br><span class="line">                  .endpoint(endpoint)</span><br><span class="line">                  .credentials(accessKey, secretKey)</span><br><span class="line">                  .build();</span><br><span class="line">  <span class="keyword">return</span> minioClient;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-接口定义"><a href="#4-3-接口定义" class="headerlink" title="4.3 接口定义"></a><strong>4.3</strong> <strong>接口定义</strong></h2><p>根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。</p>
<p>首先分析接口：</p>
<p>请求地址：&#x2F;media&#x2F;upload&#x2F;coursefile</p>
<p>请求内容：<strong>Content-Type:</strong> multipart&#x2F;form-data;</p>
<p>form-data; name&#x3D;”filedata”; filename&#x3D;”具体的文件名称”</p>
<p>响应参数：文件信息，如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;001001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bucket&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timelength&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-09-12T21:57:18&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileSize&quot;</span><span class="punctuation">:</span> <span class="number">248329</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>定义上传响应模型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件成功响应结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 18:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileResultDto</span> <span class="keyword">extends</span> <span class="title class_">MediaFiles</span> &#123;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口定义好后可以用httpclient工具测试一下</p>
<p>使用httpclient测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line">Content-Type: multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;filedata&quot;</span>; filename=<span class="string">&quot;1.jpg&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/develop/upload/<span class="number">1.</span>jpg</span><br></pre></td></tr></table></figure>

<h2 id="4-4-接口开发"><a href="#4-4-接口开发" class="headerlink" title="4.4 接口开发"></a><strong>4.4</strong> <strong>接口开发</strong></h2><h3 id="4-4-1-DAO开发"><a href="#4-4-1-DAO开发" class="headerlink" title="4.4.1 DAO开发"></a><strong>4.4.1 DAO开发</strong></h3><p>根据需求分析DAO层实现向media_files表插入一条记录，使用media_files表生成的mapper即可。</p>
<h3 id="4-4-2-Service开发"><a href="#4-4-2-Service开发" class="headerlink" title="4.4.2 Service开发"></a><strong>4.4.2 Service</strong>开发</h3><p>Service方法需要提供一个更加通用的保存文件的方法。</p>
<p>定义请求参数类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 18:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件名称</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String filename;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件类型（文档，音频，视频）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String fileType;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件大小</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long fileSize;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 标签</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上传人</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 备注</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定义service方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 上传文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件磁盘路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span>;</span><br></pre></td></tr></table></figure>



<p>实现方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MinioClient minioClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通文件桶</span></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String bucket_Files;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取文件默认存储目录路径 年/月/日</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getDefaultFolderPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;/&quot;</span>)+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> folder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取文件的md5</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFileMd5</span><span class="params">(File file)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="keyword">return</span> fileMd5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getMimeType</span><span class="params">(String extension)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(extension==<span class="literal">null</span>)</span><br><span class="line">        extension = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line">    <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(extension);</span><br><span class="line">    <span class="comment">//通用mimeType，字节流</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;</span><br><span class="line">    <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;</span><br><span class="line">        mimeType = extensionMatch.getMimeType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mimeType;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件写入minIO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath  文件地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String localFilePath,String mimeType,String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">                .bucket(bucket)</span><br><span class="line">                .object(objectName)</span><br><span class="line">                .filename(localFilePath)</span><br><span class="line">                .contentType(mimeType)</span><br><span class="line">                .build();</span><br><span class="line">        minioClient.uploadObject(testbucket);</span><br><span class="line">        log.debug(<span class="string">&quot;上传文件到minio成功,bucket:&#123;&#125;,objectName:&#123;&#125;&quot;</span>,bucket,objectName);</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;上传文件到minio出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误原因:&#123;&#125;&quot;</span>,bucket,objectName,e.getMessage(),e);</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;上传文件到文件系统失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;</span><br><span class="line">    <span class="comment">//从数据库查询文件</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localFilePath);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//文件mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);</span><br><span class="line">    <span class="comment">//文件的md5值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> getFileMd5(file);</span><br><span class="line">    <span class="comment">//文件的默认目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">defaultFolderPath</span> <span class="operator">=</span> getDefaultFolderPath();</span><br><span class="line">    <span class="comment">//存储到minio中的对象名(带目录)</span></span><br><span class="line">    <span class="type">String</span>  <span class="variable">objectName</span> <span class="operator">=</span> defaultFolderPath + fileMd5 + exension;</span><br><span class="line">    <span class="comment">//将文件上传到minio</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_files, objectName);</span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    uploadFileParamsDto.setFileSize(file.length());</span><br><span class="line">    <span class="comment">//将文件信息存储到数据库</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_mediafiles, objectName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//准备返回数据</span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileResultDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);</span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4-4-3-完善接口层"><a href="#4-4-3-完善接口层" class="headerlink" title="4.4.3 完善接口层"></a><strong>4.4.3</strong> <strong>完善接口层</strong></h3><p>完善接口层代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,<span class="meta">@RequestParam(value = &quot;folder&quot;,required=false)</span> String folder,<span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    uploadFileParamsDto.setFileSize(filedata.getSize());</span><br><span class="line">    <span class="comment">//图片</span></span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001001&quot;</span>);</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    uploadFileParamsDto.setFilename(filedata.getOriginalFilename());<span class="comment">//文件名称</span></span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">fileSize</span> <span class="operator">=</span> filedata.getSize();</span><br><span class="line">    uploadFileParamsDto.setFileSize(fileSize);</span><br><span class="line">    <span class="comment">//创建临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    <span class="comment">//上传的文件拷贝到临时文件</span></span><br><span class="line">    filedata.transferTo(tempFile);</span><br><span class="line">    <span class="comment">//文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();</span><br><span class="line">    <span class="comment">//上传文件</span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> mediaFileService.uploadFile(companyId, uploadFileParamsDto, absolutePath);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-4-接口测试"><a href="#4-4-4-接口测试" class="headerlink" title="4.4.4 接口测试"></a><strong>4.4.4</strong> <strong>接口测试</strong></h3><p>1、首先使用httpclient测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line">Content-Type: multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;filedata&quot;</span>; filename=<span class="string">&quot;1.jpg&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/develop/upload/<span class="number">1.</span>jpg</span><br></pre></td></tr></table></figure>

<p>2、再进行前后端联调测试</p>
<p>在新增课程、编辑课程界面上传图，保存课程信息后再次进入编辑课程界面，查看是否可以正常保存课程图片信息。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014-17110280643156.gif" alt="img"></p>
<p>上图图片完成后，进入媒资管理，查看文件列表中是否有刚刚上传的图片信息。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016-17110280643158.gif" alt="img"></p>
<h3 id="4-4-5-Service事务优化"><a href="#4-4-5-Service事务优化" class="headerlink" title="4.4.5 Service事务优化"></a><strong>4.4.5 Service</strong>事务优化</h3><p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p>
<p><font color="red"> 目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</font></p>
<p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p>
<p>优化后如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//从数据库查询文件</span></span><br><span class="line"><span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line"><span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">    mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">    <span class="comment">//拷贝基本信息</span></span><br><span class="line">    BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">    mediaFiles.setId(fileMd5);</span><br><span class="line">    mediaFiles.setFileId(fileMd5);</span><br><span class="line">    mediaFiles.setCompanyId(companyId);</span><br><span class="line">    mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">    mediaFiles.setBucket(bucket);</span><br><span class="line">    mediaFiles.setFilePath(objectName);</span><br><span class="line">    mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">    mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">    mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">    <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们人为在int insert &#x3D; mediaFilesMapper.insert(mediaFiles);下边添加一个异常代码int a&#x3D;1&#x2F;0;</p>
<p>测试是否事务控制。很遗憾，事务控制失败。</p>
<p>方法上已经添加了@Transactional注解为什么该方法不能被事务控制呢？</p>
<p>如果是在uploadFile方法上添加@Transactional注解就可以控制事务，去掉则不行。</p>
<p>现在的问题其实是一个非事务方法调同类一个事务方法，事务无法控制，这是为什么？</p>
<p>下边分析原因：</p>
<p>如果在uploadFile方法上添加@Transactional注解，代理对象执行此方法前会开启事务，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018-17110280643159.gif" alt="img"></p>
<p>如果在uploadFile方法上没有@Transactional注解，代理对象执行此方法前不进行事务控制，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020-171102806431510.gif" alt="img"></p>
<p>所以判断该方法是否可以事务控制必须保证是通过代理对象调用此方法，且此方法上添加了@Transactional注解。</p>
<p>现在在addMediaFilesToDb方法上添加@Transactional注解，也不会进行事务控制是因为并不是通过代理对象执行的addMediaFilesToDb方法。为了判断在uploadFile方法中去调用addMediaFilesToDb方法是否是通过代理对象去调用，我们可以打断点跟踪。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022-171102806431511.gif" alt="img"></p>
<p>我们发现在uploadFile方法中去调用addMediaFilesToDb方法不是通过代理对象去调用。</p>
<p>如何解决呢？通过代理对象去调用addMediaFilesToDb方法即可解决。</p>
<p>在MediaFileService的实现类中注入MediaFileService的代理对象，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MediaFileService currentProxy;</span><br></pre></td></tr></table></figure>

<p>将addMediaFilesToDb方法提成接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>;</span><br></pre></td></tr></table></figure>

<p>调用addMediaFilesToDb方法的代码处改为如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="comment">//写入文件表</span></span><br><span class="line"><span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_files, objectName);</span><br><span class="line"> ....</span><br></pre></td></tr></table></figure>

<p>再次测试事务是否可以正常控制。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="url">学成在线-day05-项目实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-20T18:08:18+08:00">
                2024-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="实战环境"><a href="#实战环境" class="headerlink" title="实战环境"></a><strong>实战环境</strong></h1><h2 id="实战流程"><a href="#实战流程" class="headerlink" title="实战流程"></a><strong>实战流程</strong></h2><p>项目实战是模拟企业实际开发的场景，自己参考文档独立完成开发任务，项目实战可以有效的培养自己面对需求进行分析与开发的能力。</p>
<p>实战流程如下：</p>
<p>1、由组长将实战的初始代码提交至本组git仓库。</p>
<p>2、每位成员从此仓库clone项目。</p>
<p>3、小组共同讨论实战功能需求及接口。</p>
<p>4、根据自己小组的情况进行分工，每人至少写一个接口并测试通过、提交至仓库。</p>
<p><strong>注意：每人在开发接口时创建自己的service、controller接口和类，不要出现多人共用同一个文件的情况。</strong></p>
<p>5、待功能开发完毕小组成员拉下全部代码，进行交叉测试，测试出来的bug信息记录在word文档上提交给组长由组长汇总。</p>
<p>6、根据bug记录进行修复自己接口中的bug，修复完成并测试没有问题后提交给Git。</p>
<p>7、整体流程测试，包括如下：</p>
<p>1）从网上找一门详细的课程信息(包括课程大纲) 添加到系统中。</p>
<p>功能包括：添加课程、添加课程计划、添加师资信息。</p>
<p>2）演示修改课程、修改课程计划及修改师资信息功能。</p>
<p>3）演示课程计划上移、下移功能。</p>
<p>4）演示删除课程计划、删除师资、删除课程功能。</p>
<p>8、项目评比</p>
<p><strong>小组推荐一名成员作工作汇总，老师根据团队协作情况、功能完成情况、演讲能力进行打分（满分10分）。</strong></p>
<h2 id="创建Git远程仓库"><a href="#创建Git远程仓库" class="headerlink" title="创建Git远程仓库"></a><strong>创建Git远程仓库</strong></h2><p>因为组员无法访问组长虚拟机中的gogs所以由组长在自己的电脑上安装gogs，这里提供windwos版本安装包，如果安装有问题也可以使用公网的git仓库，比如码云。</p>
<p>组长解压 软件工具目录下的gogs_0.12.10_windows_amd64.zip，安装gogs</p>
<p>解压后cmd进入gogs安装目录，输入gogs.exe web</p>
<p>自动打开安装界面：</p>
<p>第一步填写数据库信息</p>
<p>输入虚拟机中的数据库地址和账号、密码，数据库名称为gogs_windows，需要提前在数据库中创建gogs_windows数据库</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image002.gif" alt="img"></p>
<p>第二步应用基本设置：</p>
<p>仓库目录可以设置在gogs的安装目录下</p>
<p>域名为虚拟域名，组长和组员在自己的hosts文件中配置该域名及对应的组长电脑的IP地址。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image004.gif" alt="img"></p>
<p>下边配置日志路径 ，日志路径可以设置在gogs的安装目录下</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image006.gif" alt="img"></p>
<p>下边配置管理员账号和密码：gogs&#x2F;gogs</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image008.gif" alt="img"></p>
<p>输入完毕点击立即安装</p>
<p>安装完毕自动跳转到 <a target="_blank" rel="noopener" href="http://group1.xuecheng.com:3000/">http://group1.xuecheng.com:3000/</a></p>
<p>组长使用管理员账号密码登录，登录后参考 学成在线项目开发环境配置文档去创建组织及仓库，仓库的代码是老师下发的实战基础代码。</p>
<p>组长为组员创建git账号，创建完成将账号和密码发给每位组员。</p>
<p>组员需要记住自己的git账号和密码，</p>
<h2 id="拉取代码"><a href="#拉取代码" class="headerlink" title="拉取代码"></a><strong>拉取代码</strong></h2><p>组员拉取本组git远程仓库的代码，根据任务分工开始协作开发。</p>
<p>例如：本组的git仓库地址为<a target="_blank" rel="noopener" href="http://group1.xuecheng.com:3000/xuecheng-plus-group01/xuecheng-plus-project.git">http://group1.xuecheng.com:3000/xuecheng-plus-group01/xuecheng-plus-project.git</a></p>
<p>本组全体成员拉取此仓库的代码，根据任务分工开始协作开发。</p>
<h1 id="删除课程计划"><a href="#删除课程计划" class="headerlink" title="删除课程计划"></a><strong>删除课程计划</strong></h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>课程计划添加成功，如果课程还没有提交时可以删除课程计划。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image010.gif" alt="img"></p>
<p>删除第一级别的大章节时要求大章节下边没有小章节时方可删除。</p>
<p>删除第二级别的小章节的同时需要将teachplan_media表关联的信息也删除。</p>
<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><ul>
<li>删除课程计划的接口示例如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">删除结点</span><br><span class="line">Request URL: /content/teachplan/<span class="number">246</span></span><br><span class="line">Request Method: DELETE</span><br><span class="line">如果失败：</span><br><span class="line">&#123;<span class="string">&quot;errCode&quot;</span>:<span class="string">&quot;120409&quot;</span>,<span class="string">&quot;errMessage&quot;</span>:<span class="string">&quot;课程计划信息还有子级信息，无法操作&quot;</span>&#125;</span><br><span class="line">如果成功：状态码<span class="number">200</span>，不返回信息</span><br></pre></td></tr></table></figure>

<p>我这里没管这个错误状态码，因为与之前编写的异常模型类不符合</p>
<ul>
<li>定义接口如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程计划删除&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/content/teachplan/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a>接口开发</h4><ul>
<li>定义删除课程计划的接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(Long teachplanId)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的接口实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(Long teachplanId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (teachplanId == <span class="literal">null</span>)</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程计划id为空&quot;</span>);</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line">    <span class="comment">// 判断当前课程计划是章还是节</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line">    <span class="comment">// 当前课程计划为章</span></span><br><span class="line">    <span class="keyword">if</span> (grade == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 查询当前课程计划下是否有小节</span></span><br><span class="line">        LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// select * from teachplan where parentid = &#123;当前章计划id&#125;</span></span><br><span class="line">        queryWrapper.eq(Teachplan::getParentid, teachplanId);</span><br><span class="line">        <span class="comment">// 获取一下查询的条目数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> teachplanMapper.selectCount(queryWrapper);</span><br><span class="line">        <span class="comment">// 如果当前章下还有小节，则抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程计划信息还有子级信息，无法操作&quot;</span>);</span><br><span class="line">        teachplanMapper.deleteById(teachplanId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 课程计划为节</span></span><br><span class="line">        teachplanMapper.deleteById(teachplanId);</span><br><span class="line">        LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(TeachplanMedia::getTeachplanId, teachplanId);</span><br><span class="line">        teachplanMediaMapper.delete(queryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>完善Controller层接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功<span class="meta">@ApiOperation(&quot;课程计划删除&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/teachplan/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">    teachplanService.deleteTeachplan(teachplanId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h4><ul>
<li>删除有子计划的章节</li>
<li>删除没有子计划的章节和小节</li>
<li>删除有媒资信息的小节后，去数据库中查看对应的媒资信息是否真的被删除</li>
</ul>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>删除课程计划的接口定义：</p>
<p>传入课程计划id进行删除操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Request URL: /content/teachplan/<span class="number">246</span></span><br><span class="line">Request Method: DELETE</span><br><span class="line"></span><br><span class="line">如果失败返回：</span><br><span class="line">&#123;<span class="string">&quot;errCode&quot;</span>:<span class="string">&quot;120409&quot;</span>,<span class="string">&quot;errMessage&quot;</span>:<span class="string">&quot;课程计划信息还有子级信息，无法操作&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">如果成功：状态码<span class="number">200</span>，不返回信息</span><br></pre></td></tr></table></figure>



<h2 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>首先使用httpclient工具进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 删除课程计划</span><br><span class="line">DELETE &#123;&#123;content_host&#125;&#125;/content/teachplan/<span class="number">43</span></span><br></pre></td></tr></table></figure>

<p>分以下情况测试：</p>
<p>1、删除大章节，大章节下有小章节时不允许删除。</p>
<p>2、删除大章节，大单节下没有小章节时可以正常删除。</p>
<p>3、删除小章节，同时将关联的信息进行删除。</p>
<h2 id="课程计划排序"><a href="#课程计划排序" class="headerlink" title="课程计划排序"></a><strong>课程计划排序</strong></h2><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>课程计划新增后默认排在同级别最后，课程计划排序功能是可以灵活调整课程计划的显示顺序，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image012.gif" alt="img"></p>
<p>上移表示将课程计划向上移动。</p>
<p>下移表示将课程计划向下移动。</p>
<p>向上移动后和上边同级的课程计划交换位置，可以将两个课程计划的排序字段值进行交换。</p>
<p>向下移动后和下边同级的课程计划交换位置，可以将两个课程计划的排序字段值进行交换。</p>
<h2 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>接口示例如下：</p>
<p>向下移动：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Request URL: http:<span class="comment">//localhost:8601/api/content/teachplan/movedown/43</span></span><br><span class="line">Request Method: POST</span><br></pre></td></tr></table></figure>

<p>参数1：movedown 为 移动类型，表示向下移动<br> 参数2：43为课程计划id</p>
<p>向上移动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">Request URL: http:<span class="comment">//localhost:8601/api/content/teachplan/moveup/43</span></span><br><span class="line">Request Method: POST</span><br></pre></td></tr></table></figure>

<p>参数1：moveup 为 移动类型，表示向上移动<br> 参数2：43为课程计划id</p>
<p>每次移动传递两个参数：</p>
<p>1、移动类型: movedown和moveup</p>
<p>2、课程计划id</p>
<ul>
<li>定义接口如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程计划排序&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/&#123;moveType&#125;/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> String moveType, <span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h4><ul>
<li>定义课程计划排序接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(String moveType, Long teachplanId)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>编写对应的实现方法<ul>
<li>写的稍微复杂了些，其实也可以简化，在lt和orderby的前面加上判断条件就可以，但是可读性会降低</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(String moveType, Long teachplanId)</span> &#123;</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line">    <span class="comment">// 获取层级和当前orderby，章节移动和小节移动的处理方式不同</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">orderby</span> <span class="operator">=</span> teachplan.getOrderby();</span><br><span class="line">    <span class="comment">// 章节移动是比较同一课程id下的orderby</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> teachplan.getCourseId();</span><br><span class="line">    <span class="comment">// 小节移动是比较同一章节id下的orderby</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">parentid</span> <span class="operator">=</span> teachplan.getParentid();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;moveup&quot;</span>.equals(moveType)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (grade == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 章节上移，找到上一个章节的orderby，然后与其交换orderby</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE courseId = 117 AND grade = 1  AND orderby &lt; 1 ORDER BY orderby DESC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getGrade, <span class="number">1</span>)</span><br><span class="line">                    .eq(Teachplan::getCourseId, courseId)</span><br><span class="line">                    .lt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByDesc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 小节上移</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE parentId = 268 AND orderby &lt; 5 ORDER BY orderby DESC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getParentid, parentid)</span><br><span class="line">                    .lt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByDesc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;movedown&quot;</span>.equals(moveType)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (grade == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 章节下移</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE courseId = 117 AND grade = 1 AND orderby &gt; 1 ORDER BY orderby ASC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getCourseId, courseId)</span><br><span class="line">                    .eq(Teachplan::getGrade, grade)</span><br><span class="line">                    .gt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByAsc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 小节下移</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE parentId = 268 AND orderby &gt; 1 ORDER BY orderby ASC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getParentid, parentid)</span><br><span class="line">                    .gt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByAsc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交换两个Teachplan的orderby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> teachplan </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tmp </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">exchangeOrderby</span><span class="params">(Teachplan teachplan, Teachplan tmp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp == <span class="literal">null</span>)</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;已经到头啦，不能再移啦&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 交换orderby，更新</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">orderby</span> <span class="operator">=</span> teachplan.getOrderby();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">tmpOrderby</span> <span class="operator">=</span> tmp.getOrderby();</span><br><span class="line">        teachplan.setOrderby(tmpOrderby);</span><br><span class="line">        tmp.setOrderby(orderby);</span><br><span class="line">        teachplanMapper.updateById(tmp);</span><br><span class="line">        teachplanMapper.updateById(teachplan);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>完善Controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程计划排序&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/&#123;moveType&#125;/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> String moveType, <span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">    teachplanService.orderByTeachplan(moveType, teachplanId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>该功能可直接进行前后端联调，可以立即看到 效果。</p>
<p>1、向上移动测试</p>
<p> 先找一个上边有课程计划的进行测试，向上移动后两个交换顺序。</p>
<p>再找最上边的课程计划向上移动，操作后位置不变因为已经在最上边了。</p>
<p>2、向下移动测试</p>
<p>先找一个下边有课程计划的进行测试，向下移动后两个交换顺序。</p>
<p>再找最下边的课程计划向下移动，操作后位置不变因为已经在最下边了。</p>
<h2 id="师资管理"><a href="#师资管理" class="headerlink" title="师资管理"></a><strong>师资管理</strong></h2><h2 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>在课程计划维护界面点击下一步进入师资管理界面：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image014.gif" alt="img"></p>
<p>点击添加教师打开添加界面，如下图，不用实现上传照片。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image016.gif" alt="img"></p>
<p>添加成功查询教师信息如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image018.gif" alt="img"></p>
<p>在这个界面可以删除老师，也可以点击编辑，修改教师信息：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image020.gif" alt="img"></p>
<p>注意：</p>
<p>只允许向机构自己的课程中添加老师、删除老师。</p>
<p>机构id统一使用：1232141425L</p>
<h2 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><h2 id="查询教师接口请求示例"><a href="#查询教师接口请求示例" class="headerlink" title="查询教师接口请求示例"></a>查询教师接口请求示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">get /courseTeacher/list/<span class="number">75</span></span><br><span class="line"><span class="number">75</span>为课程id，请求参数为课程id</span><br><span class="line"></span><br><span class="line">响应结果</span><br><span class="line">[&#123;<span class="string">&quot;id&quot;</span>:<span class="number">23</span>,<span class="string">&quot;courseId&quot;</span>:<span class="number">75</span>,<span class="string">&quot;teacherName&quot;</span>:<span class="string">&quot;张老师&quot;</span>,<span class="string">&quot;position&quot;</span>:<span class="string">&quot;讲师&quot;</span>,<span class="string">&quot;introduction&quot;</span>:<span class="string">&quot;张老师教师简介张老师教师简介张老师教师简介张老师教师简介&quot;</span>,<span class="string">&quot;photograph&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;createDate&quot;</span>:<span class="literal">null</span>&#125;]</span><br></pre></td></tr></table></figure>



<p>2、添加教师请求示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">post  /courseTeacher</span><br><span class="line"></span><br><span class="line">请求参数：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span>: <span class="number">75</span>,</span><br><span class="line">  <span class="string">&quot;teacherName&quot;</span>: <span class="string">&quot;王老师&quot;</span>,</span><br><span class="line">  <span class="string">&quot;position&quot;</span>: <span class="string">&quot;教师职位&quot;</span>,</span><br><span class="line">  <span class="string">&quot;introduction&quot;</span>: <span class="string">&quot;教师简介&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">响应结果：</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="number">24</span>,<span class="string">&quot;courseId&quot;</span>:<span class="number">75</span>,<span class="string">&quot;teacherName&quot;</span>:<span class="string">&quot;王老师&quot;</span>,<span class="string">&quot;position&quot;</span>:<span class="string">&quot;教师职位&quot;</span>,<span class="string">&quot;introduction&quot;</span>:<span class="string">&quot;教师简介&quot;</span>,<span class="string">&quot;photograph&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;createDate&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure>

<p>3、修改教师</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">put /courseTeacher</span><br><span class="line">请求参数：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span>: <span class="number">75</span>,</span><br><span class="line">  <span class="string">&quot;teacherName&quot;</span>: <span class="string">&quot;王老师&quot;</span>,</span><br><span class="line">  <span class="string">&quot;position&quot;</span>: <span class="string">&quot;教师职位&quot;</span>,</span><br><span class="line">  <span class="string">&quot;introduction&quot;</span>: <span class="string">&quot;教师简介&quot;</span>,</span><br><span class="line">  <span class="string">&quot;photograph&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;createDate&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">响应：</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="number">24</span>,<span class="string">&quot;courseId&quot;</span>:<span class="number">75</span>,<span class="string">&quot;teacherName&quot;</span>:<span class="string">&quot;王老师&quot;</span>,<span class="string">&quot;position&quot;</span>:<span class="string">&quot;教师职位&quot;</span>,<span class="string">&quot;introduction&quot;</span>:<span class="string">&quot;教师简介&quot;</span>,<span class="string">&quot;photograph&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;createDate&quot;</span>:<span class="literal">null</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、删除教师</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">delete /ourseTeacher/course/<span class="number">75</span>/<span class="number">26</span></span><br><span class="line"></span><br><span class="line"><span class="number">75</span>:课程id</span><br><span class="line"><span class="number">26</span>:教师id，即course_teacher表的主键</span><br><span class="line">请求参数：课程id、教师id</span><br><span class="line"></span><br><span class="line">响应：状态码<span class="number">200</span>，不返回信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="接口测试-3"><a href="#接口测试-3" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、添加教师</p>
<p>2、查询教师</p>
<p>3、修改教师</p>
<p>4、删除教师</p>
<h2 id="删除课程"><a href="#删除课程" class="headerlink" title="删除课程"></a><strong>删除课程</strong></h2><h2 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>课程的审核状态为未提交时方可删除。</p>
<p>删除课程需要删除课程相关的基本信息、营销信息、课程计划、课程教师信息。</p>
<h2 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>删除课程接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">delete  /course/<span class="number">87</span></span><br><span class="line"><span class="number">87</span>为课程id</span><br><span class="line">请求参数：课程id</span><br><span class="line">响应：状态码<span class="number">200</span>，不返回信息</span><br></pre></td></tr></table></figure>



<h2 id="接口测试-4"><a href="#接口测试-4" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>找到一门课程进行删除，删除后从数据库确认课程基本信息、课程营销信息、课程计划、课程计划关联信息、课程师资是否删除成功。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/" itemprop="url">学成在线-day04-JSR303校验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-19T21:06:53+08:00">
                2024-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  37
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JSR303校验"><a href="#JSR303校验" class="headerlink" title="JSR303校验"></a>JSR303校验</h2><h2 id="统一校验的需求"><a href="#统一校验的需求" class="headerlink" title="统一校验的需求"></a><strong>统一校验的需求</strong></h2><p>前端请求后端接口传输参数，是在controller中校验还是在Service中校验？</p>
<p>答案是都需要校验，只是分工不同。</p>
<p>Contoller中校验请求参数的合法性，包括：必填项校验，数据格式校验，比如：是否是符合一定的日期格式，等。</p>
<p>Service中要校验的是业务规则相关的内容，比如：课程已经审核通过所以提交失败。</p>
<p>Service中根据业务规则去校验不方便写成通用代码，Controller中则可以将校验的代码写成通用代码。</p>
<p>早在JavaEE6规范中就定义了参数校验的规范，它就是JSR-303，它定义了Bean Validation，即对bean属性进行校验。</p>
<p>SpringBoot提供了JSR-303的支持，它就是spring-boot-starter-validation，它的底层使用Hibernate Validator，Hibernate Validator是Bean Validation 的参考实现。</p>
<p>所以，我们准备在Controller层使用spring-boot-starter-validation完成对请求参数的基本合法性进行校验。</p>
<h2 id="统一校验实现"><a href="#统一校验实现" class="headerlink" title="统一校验实现"></a><strong>统一校验实现</strong></h2><p>首先在Base工程添加spring-boot-starter-validation的依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在javax.validation.constraints包下有很多这样的校验注解，直接使用注解定义校验规则即可。</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image028.gif" alt="img"></p>
<p>规则如下：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image030.gif" alt="img"></p>
<p>现在准备对内容管理模块添加课程接口进行参数校验，如下接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此接口使用AddCourseDto模型对象接收参数，所以进入AddCourseDto类，在属性上添加校验规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 添加课程dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 17:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;AddCourseDto&quot;, description=&quot;新增课程基本信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddCourseDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;适用人群不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@Size(message = &quot;适用人群内容过少&quot;,min = 10)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;适用人群&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String users;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程标签&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;大分类&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String mt;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;小分类&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String st;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程等级不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程等级&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String grade;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;教学模式（普通，录播，直播等）&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String teachmode;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程介绍&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程图片&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String pic;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;收费规则不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;收费规则，对应数据字典&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String charge;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;价格&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上边用到了@NotEmpty和@Size两个注解，@NotEmpty表示属性不能为空，@Size表示限制属性内容的长短。</p>
<p>定义好校验规则还需要开启校验，在controller方法中添加@Validated注解，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果校验出错Spring会抛出MethodArgumentNotValidException异常，我们需要在统一异常处理器中捕获异常，解析出异常信息。</p>
<p>代码 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> RestErrorResponse <span class="title function_">methodArgumentNotValidException</span><span class="params">(MethodArgumentNotValidException e)</span> &#123;</span><br><span class="line">    <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> e.getBindingResult();</span><br><span class="line">    List&lt;String&gt; msgList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//将错误信息放在msgList</span></span><br><span class="line">    bindingResult.getFieldErrors().stream().forEach(item-&gt;msgList.add(item.getDefaultMessage()));</span><br><span class="line">    <span class="comment">//拼接错误信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> StringUtils.join(msgList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">    log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启内容管理服务。</p>
<p>使用httpclient进行测试，将必填项设置为空，“适用人群” 属性的内容设置1个字。</p>
<p>执行测试，接口响应结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;errMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;课程名称不能为空,课程分类不能为空,课程分类不能为空,适用人群内容过少&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到校验器生效。</p>
<h2 id="分组校验"><a href="#分组校验" class="headerlink" title="分组校验"></a><strong>分组校验</strong></h2><p>有时候在同一个属性上设置一个校验规则不能满足要求，比如：订单编号由系统生成，在添加订单时要求订单编号为空，在更新 订单时要求订单编写不能为空。此时就用到了分组校验，同一个属性定义多个校验规则属于不同的分组，比如：添加订单定义@NULL规则属于insert分组，更新订单定义@NotEmpty规则属于update分组，insert和update是分组的名称，是可以修改的。</p>
<p>下边举例说明</p>
<p>我们用class类型来表示不同的分组，所以我们定义不同的接口类型（空接口）表示不同的分组，由于校验分组是公用的，所以定义在 base工程中。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 校验分组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/8 15:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Inster</span>&#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>&#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>下边在定义校验规则时指定分组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(groups = &#123;ValidationGroups.Inster.class&#125;,message = &quot;添加课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@NotEmpty(groups = &#123;ValidationGroups.Update.class&#125;,message = &quot;修改课程名称不能为空&quot;)</span></span><br><span class="line"><span class="comment">// @NotEmpty(message = &quot;课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>

<p>在Controller方法中启动校验规则指定要使用的分组名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(&#123;ValidationGroups.Inster.class&#125;)</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>再次测试，由于这里指定了Insert分组，所以抛出 异常信息：添加课程名称不能为空。</p>
<p>如果修改分组为ValidationGroups.Update.class，异常信息为：修改课程名称不能为空。</p>
<h2 id="校验规则不满足？"><a href="#校验规则不满足？" class="headerlink" title="校验规则不满足？"></a><strong>校验规则不满足？</strong></h2><p>如果javax.validation.constraints包下的校验规则满足不了需求怎么办？</p>
<p>1、手写校验代码 。</p>
<p>2、自定义校验规则注解。</p>
<p>如何自定义校验规则注解，请自行查阅资料实现。</p>
<h1 id="【面试】请求参数的合法性校验如何做？"><a href="#【面试】请求参数的合法性校验如何做？" class="headerlink" title="【面试】请求参数的合法性校验如何做？"></a>【面试】请求参数的合法性校验如何做？</h1><p>1、请求参数的合法性校验如何做?</p>
<p>使用基于ISR303的校验框架实现，SpringBoot提供了ISR-303的支持，它就是spring-boot-starter-validation，它包括了很多校验规则，只需要在模型类中通过注解指定校验规则，在controller方法上开启校验。</p>
<h1 id="修改课程"><a href="#修改课程" class="headerlink" title="修改课程"></a><strong>修改课程</strong></h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>1、进入课程列表查询</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image002.gif" alt="img"></p>
<p>2、点击编辑</p>
<p>因为课程审核通过方可发布，任何时候都 可以编辑，下图是编辑课程的界面：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image004.gif" alt="img"></p>
<p>进入编辑界面显示出当前课程的信息。</p>
<p>3、修改成功自动进入课程计划编辑页面。</p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>修改课程的涉及到的数据表是课程基本信息表</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image006.gif" alt="img"></p>
<p>课程营销信息表：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image008.gif" alt="img"></p>
<p>1、进入课程编辑界面</p>
<p>界面中显示了课程的当前信息，需要根据课程id查询课程基本和课程营销信息，显示在表单上。</p>
<p>2、编辑、提交</p>
<p>修改课程提交的数据比新增课程多了一项课程id，因为修改课程需要针对某个课程进行修改。</p>
<p>3、保存数据</p>
<p>编辑完成保存课程基础信息和课程营销信息。</p>
<p>更新课程基本信息表中的修改人、修改时间。</p>
<h2 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><h2 id="查询课程信息"><a href="#查询课程信息" class="headerlink" title="查询课程信息"></a><strong>查询课程信息</strong></h2><p>定义根据课程id查询课程信息接口。</p>
<p>接口示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET /content/course/<span class="number">40</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line">#响应结果</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>

<p>查询结果为单条课程信息，内容和新增课程返回结果一致，所以采用与新增课程一致的模型类。</p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseById</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="修改课程信息"><a href="#修改课程信息" class="headerlink" title="修改课程信息"></a><strong>修改课程信息</strong></h2><p>根据前边的数据模型分析，修改课程提交的数据比新增多了课程id，接口示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT /content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###修改成功响应结果如下</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>



<p>这里定义修改课程提交的数据模型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.ValidationGroups;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 添加课程dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 17:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;EditCourseDto&quot;, description=&quot;修改课程基本信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EditCourseDto</span> <span class="keyword">extends</span> <span class="title class_">AddCourseDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程id&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>修改后返回最新课程信息，采用与新增课程接口返回类型一致的数据模型。</p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;修改课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">modifyCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> EditCourseDto editCourseDto)</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="查询课程信息-1"><a href="#查询课程信息-1" class="headerlink" title="查询课程信息"></a><strong>查询课程信息</strong></h2><p>查询课程信息的Service方法在新增课程接口开发中已实现，无需实现，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据课程id查询课程基本信息，包括基本信息和营销信息</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseInfo</span><span class="params">(<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(courseBase == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询营销信息</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">//要返回的对象</span></span><br><span class="line">    <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfoDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(courseBase,courseBaseInfoDto);</span><br><span class="line">    <span class="keyword">if</span>(courseMarket != <span class="literal">null</span>)&#123;</span><br><span class="line">        BeanUtils.copyProperties(courseMarket,courseBaseInfoDto);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询分类名称</span></span><br><span class="line">    <span class="type">CourseCategory</span> <span class="variable">courseCategoryBySt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getSt());</span><br><span class="line">    courseBaseInfoDto.setStName(courseCategoryBySt.getName());</span><br><span class="line">    <span class="type">CourseCategory</span> <span class="variable">courseCategoryByMt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getMt());</span><br><span class="line">    courseBaseInfoDto.setMtName(courseCategoryByMt.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoDto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>需要将查询课程信息的方法提到接口上，这样在controller中通过接口调用此方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseBaseInfoService</span> &#123;</span><br><span class="line">    ....</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据id查询课程基本信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CourseBaseInfoDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/9 8:13</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseInfo</span><span class="params">(<span class="type">long</span> courseId)</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>完善接口层代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseById</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试查询课程</p>
<p>用httpclient测试查询课程接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">### 查询课程信息</span><br><span class="line">GET /content/course/<span class="number">40</span></span><br></pre></td></tr></table></figure>

<h2 id="修改课程信息-1"><a href="#修改课程信息-1" class="headerlink" title="修改课程信息"></a><strong>修改课程信息</strong></h2><p>修改Service修改课程的接口与方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 修改课程信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto  课程信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CourseBaseInfoDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/8 21:04</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">updateCourseBase</span><span class="params">(Long companyId,EditCourseDto dto)</span>;</span><br></pre></td></tr></table></figure>



<p>实现方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">updateCourseBase</span><span class="params">(Long companyId, EditCourseDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> dto.getId();</span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(courseBase==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验本机构只能修改本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span>(!courseBase.getCompanyId().equals(companyId))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;本机构只能修改本机构的课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装基本信息的数据</span></span><br><span class="line">    BeanUtils.copyProperties(dto,courseBase);</span><br><span class="line">    courseBase.setChangeDate(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新课程基本信息</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> courseBaseMapper.updateById(courseBase);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装营销信息的数据</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseMarket</span>();</span><br><span class="line">    BeanUtils.copyProperties(dto,courseMarket);</span><br><span class="line">    saveCourseMarket(courseMarket);</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getCourseBaseInfo(courseId);</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfo;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>最后完善接口层代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;修改课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">modifyCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> EditCourseDto editCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.updateCourseBase(companyId,editCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>接口开发完成进行测试，使用httpclient测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">### 根据课程id查询课程信息</span><br><span class="line">GET &#123;&#123;content_host&#125;&#125;/content/course/<span class="number">40</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line">#响应结果</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">### 修改课程</span><br><span class="line">PUT &#123;&#123;content_host&#125;&#125;/content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###修改成功响应结果如下</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>

<p>前端开发完毕进行前后端接口联调。</p>
<p>过程略。</p>
<h1 id="查询课程计划"><a href="#查询课程计划" class="headerlink" title="查询课程计划"></a><strong>查询课程计划</strong></h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>课程基本信息添加或修改成功将自动进入课程计划编辑器界面，如下图：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image002-17109136929071.gif" alt="img"></p>
<p>课程计划即课程的大纲目录。</p>
<p>课程计划分为两级：大章节和小章节。</p>
<p>本小节完成课程计划信息的查询。</p>
<h2 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>从课程计划查询界面上可以看出整体上是 一个树型结构，课程计划表teachplan如下：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image004-17109136929072.gif" alt="img"></p>
<p>每个课程计划都有所属课程。</p>
<p>每个课程的课程计划有两个级别，第一级为大章节，grade为1、第二级为小章节，grade为2</p>
<p>3。第二级的parentid为第一级的id。</p>
<p>课程计划的显示顺序根据排序字段去显示。</p>
<p>根据业务流程中的界面原型，课程计划列表展示时还有课程计划关联的视频信息。</p>
<p>课程计划关联的视频信息在teachplan_media表，结构如下：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image006-17109136929083.gif" alt="img"></p>
<p>两张表是一对一关系，每个课程计划只能在teachplan_media表中存在一个视频。</p>
<p>从课程资料目录下的db目录中，从xcplus_content.sql文件中找到课程计划表teachplan、teachplan_media表的建表语句以及数据初始化语句，并通过mysql客户端去执行脚本。</p>
<p>这里使用DataGrid 客户端工具连接mysql并执行脚本。</p>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>接口示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">GET /teachplan/<span class="number">22</span>/tree-nodes</span><br><span class="line"></span><br><span class="line"> [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">        <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mediaType&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;parentid&quot;</span> : <span class="number">112</span>,</span><br><span class="line">        <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1章基础知识&quot;</span>,</span><br><span class="line">        <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">113</span>,</span><br><span class="line">        <span class="string">&quot;teachPlanTreeNodes&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;001002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;parentid&quot;</span> : <span class="number">113</span>,</span><br><span class="line">                <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1节项目概述&quot;</span>,</span><br><span class="line">                <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span> : <span class="number">115</span>,</span><br><span class="line">                <span class="string">&quot;teachPlanTreeNodes&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;teachplanMedia&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                    <span class="string">&quot;coursePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                    <span class="string">&quot;mediaFilename&quot;</span> : <span class="string">&quot;2.avi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mediaId&quot;</span> : <span class="number">41</span>,</span><br><span class="line">                    <span class="string">&quot;teachplanId&quot;</span> : <span class="number">115</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span> : <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;teachplanMedia&quot;</span> : <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">        <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;parentid&quot;</span> : <span class="number">112</span>,</span><br><span class="line">        <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第2章快速入门&quot;</span>,</span><br><span class="line">        <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">242</span>,</span><br><span class="line">        <span class="string">&quot;teachPlanTreeNodes&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;001002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orderby&quot;</span> : <span class="number">2</span>,</span><br><span class="line">                <span class="string">&quot;parentid&quot;</span> : <span class="number">242</span>,</span><br><span class="line">                <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1节搭建环境&quot;</span>,</span><br><span class="line">                <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span> : <span class="number">244</span>,</span><br><span class="line">                <span class="string">&quot;teachPlanTreeNodes&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;teachplanMedia&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                    <span class="string">&quot;coursePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                    <span class="string">&quot;mediaFilename&quot;</span> : <span class="string">&quot;3.avi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mediaId&quot;</span> : <span class="number">42</span>,</span><br><span class="line">                    <span class="string">&quot;teachplanId&quot;</span> : <span class="number">244</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span> : <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;001002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orderby&quot;</span> : <span class="number">3</span>,</span><br><span class="line">                <span class="string">&quot;parentid&quot;</span> : <span class="number">242</span>,</span><br><span class="line">                <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第2节项目概述&quot;</span>,</span><br><span class="line">                <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span> : <span class="number">245</span>,</span><br><span class="line">                <span class="string">&quot;teachPlanTreeNodes&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;teachplanMedia&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                    <span class="string">&quot;coursePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                    <span class="string">&quot;mediaFilename&quot;</span> : <span class="string">&quot;1a.avi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mediaId&quot;</span> : <span class="number">39</span>,</span><br><span class="line">                    <span class="string">&quot;teachplanId&quot;</span> : <span class="number">245</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span> : <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;teachplanMedia&quot;</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>查询课程计划的请求参数：课程id</p>
<p>响应结果需要自定义模型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.Teachplan;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.TeachplanMedia;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程计划树型结构dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 10:27</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeachplanDto</span> <span class="keyword">extends</span> <span class="title class_">Teachplan</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程计划关联的媒资信息</span></span><br><span class="line">  TeachplanMedia teachplanMedia;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//子结点</span></span><br><span class="line">  List&lt;TeachplanDto&gt; teachPlanTreeNodes;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiImplicitParam;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程计划编辑接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Api(value = &quot;课程计划编辑接口&quot;,tags = &quot;课程计划编辑接口&quot;)</span></span><br><span class="line"> <span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeachplanController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查询课程计划树形结构&quot;)</span></span><br><span class="line">    <span class="meta">@ApiImplicitParam(value = &quot;courseId&quot;,name = &quot;课程Id&quot;,required = true,dataType = &quot;Long&quot;,paramType = &quot;path&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/teachplan/&#123;courseId&#125;/tree-nodes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">getTreeNodes</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="DAO开发"><a href="#DAO开发" class="headerlink" title="DAO开发"></a>DAO开发</h2><p>Mapper接口使用sql查询课程计划，组成一个树型结构。</p>
<p>在TeachplanMapper自定义方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeachplanMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Teachplan&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询某课程的课程计划，组成树型结构 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.content.model.dto.TeachplanDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/9 11:10</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">selectTreeNodes</span><span class="params">(<span class="type">long</span> courseId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义mapper.xml中的sql语句，分析如下：</p>
<p>1、一级分类和二级分类通过teachplan表的自链接进行，如果只有一级分类其下边没有二级分类，此时也需要显示一级分类，这里使用左连接，左边是一级分类，右边是二级分类。</p>
<p>2、由于当还没有关联 视频时teachplan_media对应的记录为空，所以需要teachplan和teachplan_media左链接。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">            one.id             one_id,</span><br><span class="line">            one.pname          one_pname,</span><br><span class="line">            one.parentid       one_parentid,</span><br><span class="line">            one.grade          one_grade,</span><br><span class="line">            one.media_type     one_mediaType,</span><br><span class="line">            one.start_time     one_stratTime,</span><br><span class="line">            one.end_time       one_endTime,</span><br><span class="line">            one.orderby        one_orderby,</span><br><span class="line">            one.course_id      one_courseId,</span><br><span class="line">            one.course_pub_id  one_coursePubId,</span><br><span class="line">            two.id             two_id,</span><br><span class="line">            two.pname          two_pname,</span><br><span class="line">            two.parentid       two_parentid,</span><br><span class="line">            two.grade          two_grade,</span><br><span class="line">            two.media_type     two_mediaType,</span><br><span class="line">            two.start_time     two_stratTime,</span><br><span class="line">            two.end_time       two_endTime,</span><br><span class="line">            two.orderby        two_orderby,</span><br><span class="line">            two.course_id      two_courseId,</span><br><span class="line">            two.course_pub_id  two_coursePubId,</span><br><span class="line">            m1.media_fileName mediaFilename,</span><br><span class="line">            m1.id teachplanMeidaId,</span><br><span class="line">            m1.media_id mediaId</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> teachplan <span class="keyword">one</span></span><br><span class="line">                 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> teachplan two <span class="keyword">on</span> one.id <span class="operator">=</span> two.parentid</span><br><span class="line">                 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> teachplan_media m1 <span class="keyword">on</span> m1.teachplan_id <span class="operator">=</span> two.id</span><br><span class="line">        <span class="keyword">where</span> one.parentid <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> one.course_id<span class="operator">=</span>#&#123;<span class="keyword">value</span>&#125;</span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> one.orderby,</span><br><span class="line">                 two.orderby</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>定义mapper.xml</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 课程分类树型结构查询映射结果 --&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>resultMap id<span class="operator">=</span>&quot;treeNodeResultMap&quot; type<span class="operator">=</span>&quot;com.xuecheng.content.model.dto.TeachplanDto&quot;<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 一级数据映射 --&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span>id     <span class="keyword">column</span><span class="operator">=</span>&quot;one_id&quot;        property<span class="operator">=</span>&quot;id&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_pname&quot;      property<span class="operator">=</span>&quot;pname&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_parentid&quot;     property<span class="operator">=</span>&quot;parentid&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_grade&quot;  property<span class="operator">=</span>&quot;grade&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_mediaType&quot;   property<span class="operator">=</span>&quot;mediaType&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_stratTime&quot;   property<span class="operator">=</span>&quot;stratTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_endTime&quot;   property<span class="operator">=</span>&quot;endTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_orderby&quot;   property<span class="operator">=</span>&quot;orderby&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_courseId&quot;   property<span class="operator">=</span>&quot;courseId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_coursePubId&quot;   property<span class="operator">=</span>&quot;coursePubId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 一级中包含多个二级数据 --&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span>collection property<span class="operator">=</span>&quot;teachPlanTreeNodes&quot; ofType<span class="operator">=</span>&quot;com.xuecheng.content.model.dto.TeachplanDto&quot;<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 二级数据映射 --&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>id     <span class="keyword">column</span><span class="operator">=</span>&quot;two_id&quot;        property<span class="operator">=</span>&quot;id&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_pname&quot;      property<span class="operator">=</span>&quot;pname&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_parentid&quot;     property<span class="operator">=</span>&quot;parentid&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_grade&quot;  property<span class="operator">=</span>&quot;grade&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_mediaType&quot;   property<span class="operator">=</span>&quot;mediaType&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_stratTime&quot;   property<span class="operator">=</span>&quot;stratTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_endTime&quot;   property<span class="operator">=</span>&quot;endTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_orderby&quot;   property<span class="operator">=</span>&quot;orderby&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_courseId&quot;   property<span class="operator">=</span>&quot;courseId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_coursePubId&quot;   property<span class="operator">=</span>&quot;coursePubId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>association property<span class="operator">=</span>&quot;teachplanMedia&quot; javaType<span class="operator">=</span>&quot;com.xuecheng.content.model.po.TeachplanMedia&quot;<span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;teachplanMeidaId&quot;   property<span class="operator">=</span>&quot;id&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;mediaFilename&quot;   property<span class="operator">=</span>&quot;mediaFilename&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;mediaId&quot;   property<span class="operator">=</span>&quot;mediaId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_id&quot;   property<span class="operator">=</span>&quot;teachplanId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_courseId&quot;   property<span class="operator">=</span>&quot;courseId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_coursePubId&quot;   property<span class="operator">=</span>&quot;coursePubId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="operator">/</span>association<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">/</span>collection<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span>resultMap<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">--课程计划树型结构查询--&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectTreeNodes&quot; resultMap<span class="operator">=</span>&quot;treeNodeResultMap&quot; parameterType<span class="operator">=</span>&quot;long&quot; <span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            one.id             one_id,</span><br><span class="line">            one.pname          one_pname,</span><br><span class="line">            one.parentid       one_parentid,</span><br><span class="line">            one.grade          one_grade,</span><br><span class="line">            one.media_type     one_mediaType,</span><br><span class="line">            one.start_time     one_stratTime,</span><br><span class="line">            one.end_time       one_endTime,</span><br><span class="line">            one.orderby        one_orderby,</span><br><span class="line">            one.course_id      one_courseId,</span><br><span class="line">            one.course_pub_id  one_coursePubId,</span><br><span class="line">            two.id             two_id,</span><br><span class="line">            two.pname          two_pname,</span><br><span class="line">            two.parentid       two_parentid,</span><br><span class="line">            two.grade          two_grade,</span><br><span class="line">            two.media_type     two_mediaType,</span><br><span class="line">            two.start_time     two_stratTime,</span><br><span class="line">            two.end_time       two_endTime,</span><br><span class="line">            two.orderby        two_orderby,</span><br><span class="line">            two.course_id      two_courseId,</span><br><span class="line">            two.course_pub_id  two_coursePubId,</span><br><span class="line">            m1.media_fileName mediaFilename,</span><br><span class="line">            m1.id teachplanMeidaId,</span><br><span class="line">            m1.media_id mediaId</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> teachplan <span class="keyword">one</span></span><br><span class="line">                 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> teachplan two <span class="keyword">on</span> one.id <span class="operator">=</span> two.parentid</span><br><span class="line">                 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> teachplan_media m1 <span class="keyword">on</span> m1.teachplan_id <span class="operator">=</span> two.id</span><br><span class="line">        <span class="keyword">where</span> one.parentid <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> one.course_id<span class="operator">=</span>#&#123;<span class="keyword">value</span>&#125;</span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> one.orderby,</span><br><span class="line">                 two.orderby</span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>单元测试方法，略。</p>
<h2 id="Service开发"><a href="#Service开发" class="headerlink" title="Service开发"></a>Service开发</h2><p>定义service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.*;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程基本信息管理业务接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 21:42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeachplanService</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 查询课程计划树型结构</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;TeachplanDto&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 11:13</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">findTeachplanTree</span><span class="params">(<span class="type">long</span> courseId)</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>定义service接口实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.mapper.TeachplanMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.TeachplanService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程计划service接口实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 11:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeachplanServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">TeachplanService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line"> TeachplanMapper teachplanMapper;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">findTeachplanTree</span><span class="params">(<span class="type">long</span> courseId)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> teachplanMapper.selectTreeNodes(courseId);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、完善接口层代码 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">TeachplanService teachplanService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询课程计划树形结构&quot;)</span></span><br><span class="line"><span class="meta">@ApiImplicitParam(value = &quot;courseId&quot;,name = &quot;课程基础Id值&quot;,required = true,dataType = &quot;Long&quot;,paramType = &quot;path&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;teachplan/&#123;courseId&#125;/tree-nodes&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">getTreeNodes</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> teachplanService.findTeachplanTree(courseId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2、使用httpclient测试</p>
<p>找一个有课程计划的课程进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 查询某个课程的课程计划</span><br><span class="line">GET &#123;&#123;content_host&#125;&#125;/content/teachplan/<span class="number">74</span>/tree-nodes</span><br></pre></td></tr></table></figure>

<p>3、前后端联调</p>
<p>1）进入课程编辑页面</p>
<p>2）保存进入下一步</p>
<p>观察课程计划获取是否成功。</p>
<p>1）进入新增课程页面</p>
<p>2）新增课程成功，自动进入课程计划编辑界面。</p>
<p>由于是新增的课程，课程计划为空。</p>
<h1 id="新增-修改计划"><a href="#新增-修改计划" class="headerlink" title="新增&#x2F;修改计划"></a><strong>新增&#x2F;修改计划</strong></h1><h2 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>1、进入课程计划界面</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image002-17109233290917.gif" alt="img"></p>
<p>2、点击“添加章”新增第一级课程计划。</p>
<p>新增成功自动刷新课程计划列表。</p>
<p>3、点击“添加小节”向某个第一级课程计划下添加小节。</p>
<p>新增成功自动刷新课程计划列表。</p>
<p>新增的课程计划自动排序到最后。</p>
<p>4、点击“章”、“节”的名称，可以修改名称、选择是否免费。</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image004-17109233290928.gif" alt="img"></p>
<h2 id="数据模型-2"><a href="#数据模型-2" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>1、新增第一级课程计划</p>
<p>名称默认为：新章名称 [点击修改]</p>
<p>grade：1</p>
<p>orderby: 所属课程中同级别下排在最后</p>
<p>2、新增第二级课程计划</p>
<p>名称默认为：新小节名称 [点击修改]</p>
<p>grade：2</p>
<p>orderby: 所属课程计划中排在最后</p>
<p>3、修改第一级、第二级课程计划的名称，修改第二级课程计划是否免费</p>
<h2 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>接口示例如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程计划--章,当grade为<span class="number">1</span>时parentid为<span class="number">0</span></span><br><span class="line">POST /teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;新章名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">### 新增课程计划--节</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">247</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;小节名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同一个接口接收新增和修改两个业务请求，以是否传递课程计划id 来判断是新增还是修改。</p>
<p>如果传递了课程计划id说明当前是要修改该课程计划，否则是新增一个课程计划。</p>
<p>定义接收请求参数的数据模型类：</p>
<p>定义SaveTeachplanDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.Teachplan;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.TeachplanMedia;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存课程计划dto，包括新增、修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 10:27</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveTeachplanDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/***</span></span><br><span class="line"><span class="comment">  * 教学计划id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程计划名称</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String pname;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程计划父级Id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long parentid;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 层级，分为1、2、3级</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Integer grade;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程类型:1视频、2文档</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String mediaType;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程标识</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long courseId;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程发布标识</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long coursePubId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 是否支持试学或预览（试看）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String isPreview;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程计划创建或修改&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">( <span class="meta">@RequestBody</span> SaveTeachplanDto teachplan)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发-2"><a href="#接口开发-2" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="Mapper开发"><a href="#Mapper开发" class="headerlink" title="Mapper开发"></a>Mapper开发</h2><p>根据业务的分析，Mapper使用自动生成的mapper即可满足要求。</p>
<h2 id="Service开发-1"><a href="#Service开发-1" class="headerlink" title="Service开发"></a>Service开发</h2><p>定义保存课程计划的Service接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 只在课程计划</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> teachplanDto  课程计划信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/9 13:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">(SaveTeachplanDto teachplanDto)</span>;</span><br></pre></td></tr></table></figure>

<p>编写接口实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">(SaveTeachplanDto teachplanDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程计划id</span></span><br><span class="line">  <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> teachplanDto.getId();</span><br><span class="line">  <span class="comment">//修改课程计划</span></span><br><span class="line">  <span class="keyword">if</span>(id!=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(id);</span><br><span class="line">   BeanUtils.copyProperties(teachplanDto,teachplan);</span><br><span class="line">   teachplanMapper.updateById(teachplan);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//取出同父同级别的课程计划数量</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> getTeachplanCount(teachplanDto.getCourseId(), teachplanDto.getParentid());</span><br><span class="line">   <span class="type">Teachplan</span> <span class="variable">teachplanNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Teachplan</span>();</span><br><span class="line">   <span class="comment">//设置排序号</span></span><br><span class="line">   teachplanNew.setOrderby(count+<span class="number">1</span>);</span><br><span class="line">   BeanUtils.copyProperties(teachplanDto,teachplanNew);</span><br><span class="line"></span><br><span class="line">   teachplanMapper.insert(teachplanNew);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 获取最新的排序号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> parentId  父课程计划id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> int 最新排序号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/9 13:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getTeachplanCount</span><span class="params">(<span class="type">long</span> courseId,<span class="type">long</span> parentId)</span>&#123;</span><br><span class="line">  LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">  queryWrapper.eq(Teachplan::getCourseId,courseId);</span><br><span class="line">  queryWrapper.eq(Teachplan::getParentid,parentId);</span><br><span class="line">  <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> teachplanMapper.selectCount(queryWrapper);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h2 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、完善接口的代码 ，调用service方法完成课程计划的创建和修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程计划创建或修改&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">( <span class="meta">@RequestBody</span> SaveTeachplanDto teachplan)</span>&#123;</span><br><span class="line">    teachplanService.saveTeachplan(teachplan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、首先使用httpclient做以下测试。</p>
<p>添加章</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程计划--章</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;新章名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、添加小节</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程计划--节,从数据库找到第一级的课程计划id向其下边添加计划</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">247</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;小节名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、保存课程计划</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">### 课程课程计划,需要从数据库找到修改的课程计划id</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">22</span>,</span><br><span class="line">  <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;ctlBarShow&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;ctlEditTitle&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span> : <span class="number">237</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1节修改名称&quot;</span>,</span><br><span class="line">  <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;teachPlanId&quot;</span> : <span class="number">240</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、前后端联调</p>
<p>分别联调新增章、新增小节、保存计划信息。</p>
<h2 id="Bug修改"><a href="#Bug修改" class="headerlink" title="Bug修改"></a>Bug修改</h2><p>通过接口测试我们发现：</p>
<p>1、使用httpclient测试没有问题</p>
<p>2、前后端联调时发现新增的第一级目录不能显示在列表中。</p>
<p>请自己分析并修复。</p>
<p>3、思考添加课程计划的实现方式是否存在bug?</p>
<p>如有bug进行修改。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/" itemprop="url">学成在线-day03-课程查询、新增课程、前后端联调</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-17T17:48:17+08:00">
                2024-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  12.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  56
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="开发持久层"><a href="#开发持久层" class="headerlink" title="开发持久层"></a>开发持久层</h1><h2 id="生成mapper"><a href="#生成mapper" class="headerlink" title="生成mapper"></a>生成mapper</h2><p>本项目使用MyBatis-Plus开发持久层，需要创建PO类、Mapper接口、Mapper的xml文件，每个PO类对应数据库的每张表，每张表需要创建一个Mapper接口和Mapper的xml映射文件 。</p>
<p>下边将使用generator工程成的mapper接口和mapper映射文件 拷贝到service工程 ，如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002.gif" alt="img"></p>
<p>service工程即业务层为api接口工程提供业务处理支撑，本项目业务层包括了持久层的代码，一些大型公司的团队职责划分更细，会将持久层和业务层分为两个工程，不过这需要增加成本。</p>
<p>本项目使用持久层框架MyBatis-Plus进行开发，下边将mapper接口和xml文件 拷贝到 service工程 ，拷贝后如下图所示：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004.gif" alt="img"></p>
<p>到此mapper接口与mapper映射文件生成完毕。</p>
<h2 id="测试mapper"><a href="#测试mapper" class="headerlink" title="测试mapper"></a>测试mapper</h2><p>下边对mapper进行单元测试，测试course_base表的查询接口。</p>
<p>1、下边在service工程的pom.xml中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- MySQL 驱动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- mybatis plus的依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 Junit --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置扫描mapper及分页插件</p>
<p>从课程资料&#x2F;工程目录下拷贝MybatisPlusConfig 到 service工程的com.xuecheng.content.config包下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.autoconfigure.ConfigurationCustomizer;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *        Mybatis-Plus 配置</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.xuecheng.content.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 定义分页拦截器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">      interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">      <span class="keyword">return</span> interceptor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分页插件的原理：</p>
<p>首先分页参数放到ThreadLocal中，拦截执行的sql，根据数据库类型添加对应的分页语句重写sql，例如：<code>(select * from table where a)</code> 转换为 <code>(select count(*) from table where a)</code>和<code>(select * from table where a limit ,)</code></p>
<p>计算出了total总条数、pageNum当前第几页、pageSize每页大小和当前页的数据，是否为首页，是否为尾页，总页数等。</p>
<p>4、单元测试所需要的配置文件</p>
<p>在test&#x2F;resources下创建 log4j2-dev.xml、bootstrap.yml：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006.gif" alt="img"></p>
<p> log4j2-dev.xml:从课程资料&#x2F;项目工程 获取.</p>
<p>bootstrap.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/xcplus_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mysql</span></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-dev.xml</span></span><br></pre></td></tr></table></figure>

<p>5、编写启动类：</p>
<p>单元测试工作在test目录，在test下添加启动类</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008.gif" alt="img"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ContentApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、编写测试类</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010.gif" alt="img"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.mapper.CourseBaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Assertions;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CourseBaseMapperTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseBaseMapper courseBaseMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCourseBaseMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(<span class="number">74L</span>);</span><br><span class="line">        Assertions.assertNotNull(courseBase);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试查询接口</span></span><br><span class="line">        LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//查询条件</span></span><br><span class="line">        <span class="type">QueryCourseParamsDto</span> <span class="variable">queryCourseParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryCourseParamsDto</span>();</span><br><span class="line">        queryCourseParamsDto.setCourseName(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setAuditStatus(<span class="string">&quot;202004&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setPublishStatus(<span class="string">&quot;203001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拼接查询条件</span></span><br><span class="line">        <span class="comment">//根据课程名称模糊查询  name like &#x27;%名称%&#x27;</span></span><br><span class="line">        queryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()),CourseBase::getName,queryCourseParamsDto.getCourseName());</span><br><span class="line">        <span class="comment">//根据课程审核状态</span></span><br><span class="line">        queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()),CourseBase::getAuditStatus,queryCourseParamsDto.getAuditStatus());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页参数</span></span><br><span class="line">        <span class="type">PageParams</span> <span class="variable">pageParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageParams</span>();</span><br><span class="line">        pageParams.setPageNo(<span class="number">1L</span>);<span class="comment">//页码</span></span><br><span class="line">        pageParams.setPageSize(<span class="number">3L</span>);<span class="comment">//每页记录数</span></span><br><span class="line">        Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页查询E page 分页参数, @Param(&quot;ew&quot;) Wrapper&lt;T&gt; queryWrapper 查询条件</span></span><br><span class="line">        Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据</span></span><br><span class="line">        List&lt;CourseBase&gt; items = pageResult.getRecords();</span><br><span class="line">        <span class="comment">//总记录数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备返回数据 List&lt;T&gt; items, long counts, long page, long pageSize</span></span><br><span class="line">        PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(items, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        System.out.println(courseBasePageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试类的测试方法进行测试，测试成功：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012.gif" alt="img"></p>
<h1 id="开发业务层"><a href="#开发业务层" class="headerlink" title="开发业务层"></a><strong>开发业务层</strong></h1><h2 id="创建数据字典表"><a href="#创建数据字典表" class="headerlink" title="创建数据字典表"></a>创建数据字典表</h2><p>课程基本信息查询的主要数据来源是课程基本信息表，这里有一个点需要注意，就是课程的审核状态、发布状态。</p>
<p>审核状态在查询条件和查询结果中都存在，审核状态包括：未审核、审核通过、审核未通过三种，下边思考一个问题：一个课程的审核状态如果是“审核未通过”那么在课程基本信息表记录“审核未通过”三个字合适吗？</p>
<p>如果将“审核未通过”五个字记录在课程基本信息表中，显示出来的审核状态就是“审核未通过”这五个字，看起来没有什么问题，如果有一天客户想要将审核未通过的记录在显示时改为“未通过”三个字，怎么办？</p>
<p>这时你可能需要批量处理数据库记录，写一个 update 语句，审核状态等于“审核未通过”的全部更新 为“未通过”。看起来解决了问题，如果有一天客户又让改了呢？</p>
<p>和审核状态同类的有好多这样的信息，比如：课程状态、课程类型、用户类型等等，这一类数据有一个共同点就是它有一些分类项，且这些分类项较为固定。针对这些数据，为了提高系统的可扩展性，专门定义数据字典表去维护。</p>
<p>下边是课程审核状态的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202001&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;审核未通过&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202002&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;未审核&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202003&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;审核通过&quot;</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>每一项都由代码和名称组成。</p>
<p>此时我们好像要干 什么了 ，该课程 的审核状态为审核未通过，那么我们在课程基本信息表存储202001，也就是审核未通过对应的代码，这样查询出的数据在前端展示时根据代码取出它对应的内容显示给用户。如果用户要修改“审核未通过”的显示内容只需要在数据字典表修改，无法修改课程基本信息表。</p>
<p>数据字典表在系统管理数据库中存储，首先导入系统管理数据库，创建系统管理服务的数据库</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-17106848025587.gif" alt="img"></p>
<p>创建成功如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-17106848025598.gif" alt="img"></p>
<p>创建系统管理的数据库，导入课程资料中的xcplus_system.sql脚本。</p>
<h2 id="编写Service"><a href="#编写Service" class="headerlink" title="编写Service"></a>编写Service</h2><p>接下来开发Service方法，首先创建Service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程基本信息管理业务接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 21:42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> /</span></span><br><span class="line"><span class="comment">public interface CourseBaseInfoService  &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> /*</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 课程查询接口</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> pageParams 分页参数</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> queryCourseParamsDto 条件条件</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.content.model.po.CourseBase&gt;</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/6 21:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto)</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>再创建接口实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.mapper.CourseBaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程信息管理业务接口实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 21:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseBaseInfoServiceImpl</span>  <span class="keyword">implements</span> <span class="title class_">CourseBaseInfoService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> CourseBaseMapper courseBaseMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//构建查询条件对象</span></span><br><span class="line">  LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">  <span class="comment">//构建查询条件，根据课程名称查询</span></span><br><span class="line">     queryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()),CourseBase::getName,queryCourseParamsDto.getCourseName());</span><br><span class="line">  <span class="comment">//构建查询条件，根据课程审核状态查询</span></span><br><span class="line">     queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()),CourseBase::getAuditStatus,queryCourseParamsDto.getAuditStatus());</span><br><span class="line"><span class="comment">//构建查询条件，根据课程发布状态查询</span></span><br><span class="line"><span class="comment">//todo:根据课程发布状态查询 </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//分页对象</span></span><br><span class="line">  Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">  <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">  Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line">  <span class="comment">// 获取数据列表</span></span><br><span class="line">  List&lt;CourseBase&gt; list = pageResult.getRecords();</span><br><span class="line">  <span class="comment">// 获取数据总数</span></span><br><span class="line">  <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">  <span class="comment">// 构建结果集</span></span><br><span class="line">  PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">  <span class="keyword">return</span> courseBasePageResult;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="测试service"><a href="#测试service" class="headerlink" title="测试service"></a>测试service</h2><p>下边对service进行单元测试，编写单元测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CourseBaseInfoServiceTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCourseBaseInfoService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//查询条件</span></span><br><span class="line">        <span class="type">QueryCourseParamsDto</span> <span class="variable">queryCourseParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryCourseParamsDto</span>();</span><br><span class="line">        queryCourseParamsDto.setCourseName(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setAuditStatus(<span class="string">&quot;202004&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setPublishStatus(<span class="string">&quot;203001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页参数</span></span><br><span class="line">        <span class="type">PageParams</span> <span class="variable">pageParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageParams</span>();</span><br><span class="line">        pageParams.setPageNo(<span class="number">1L</span>);<span class="comment">//页码</span></span><br><span class="line">        pageParams.setPageSize(<span class="number">3L</span>);<span class="comment">//每页记录数</span></span><br><span class="line"></span><br><span class="line">        PageResult&lt;CourseBase&gt; courseBasePageResult = courseBaseInfoService.queryCourseBaseList(pageParams, queryCourseParamsDto);</span><br><span class="line">        System.out.println(courseBasePageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="完善todo"><a href="#完善todo" class="headerlink" title="完善todo"></a>完善todo</h2><p>课下完成service方法中的todo：根据课程发布状态查询课程信息。</p>
<h1 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h1><h2 id="接口完善"><a href="#接口完善" class="headerlink" title="接口完善"></a><strong>接口完善</strong></h2><p>控制层、业务层以及持久层三层通常可以面向接口并行开发，比如：业务层开发的同事可以先只编写一个Service接口，接口层的同事即可面向Service接口去开发，待接口层和业务层完成后进行连调。</p>
<p>下边课程查询接口的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程查询接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody(required = false)</span> QueryCourseParamsDto queryCourseParams)</span> &#123;</span><br><span class="line">    PageResult&lt;CourseBase&gt; pageResult = courseBaseInfoService.queryCourseBaseList(pageParams, queryCourseParams);</span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>代码编辑完毕，再次打开Swagger进行测试。</p>
<p>输入查询条件：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-171068748287111.gif" alt="img"></p>
<p>测试，观察结果是否正确。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-171068748287112.gif" alt="img"></p>
<h2 id="Httpclient测试"><a href="#Httpclient测试" class="headerlink" title="Httpclient测试"></a>Httpclient测试</h2><p>Swagger是一个在线接口文档，虽然使用它也能测试但需要浏览器进入Swagger，最关键的是它并不能保存测试数据。</p>
<p>在IDEA中有一个非常方便的http接口测试工具httpclient，下边介绍它的使用方法，后边我们会用它进行接口测试。</p>
<p>如果IDEA版本较低没有自带httpclient，需要安装httpclient插件</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-171068748287113.gif" alt="img"></p>
<p>进入controller类，找到http接口对应的方法</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-171068748287114.gif" alt="img"></p>
<p>点击Generate request in HTTP Client即可生成的一个测试用例。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-171068748287115.gif" alt="img"></p>
<p>可以看到自己生成了一个.http结尾的文件</p>
<p>我们可以添加请求参数进行测试</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-171068748287116.gif" alt="img"></p>
<p>参数添加完毕可以运行它</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014.gif" alt="img"></p>
<p>观察控制台，测试通过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">http:<span class="comment">//localhost:63040/course/list?pageNo=2&amp;pageSize=10</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, <span class="number">07</span> Sep <span class="number">2022</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">50</span> GMT</span><br><span class="line">Keep-Alive: timeout=<span class="number">60</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>: <span class="number">88</span>,</span><br><span class="line">      <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">      <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;users&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-1-1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">      <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">      <span class="string">&quot;description&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;http://r3zc5rung.hd-bkt.clouddn.com/cb1b6038-ef68-4362-8c29-a966886d1dc5sakUiFHLb5sRFdIK&quot;</span>,</span><br><span class="line">      <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2021-12-27 20:14:53&quot;</span>,</span><br><span class="line">      <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2021-12-27 20:28:58&quot;</span>,</span><br><span class="line">      <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202002&quot;</span>,</span><br><span class="line">      <span class="string">&quot;auditMind&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;auditNums&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;auditDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;auditPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;status&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;coursePubId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">   ....</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;counts&quot;</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="string">&quot;page&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;pageSize&quot;</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line">Response file saved.</span><br><span class="line">&gt; <span class="number">2022</span>-09-07T085450<span class="number">.200</span>.json</span><br><span class="line"></span><br><span class="line">Response code: <span class="number">200</span>; Time: 392ms (<span class="number">392</span> ms); Content length: <span class="number">1916</span> bytes (<span class="number">1.92</span> kB)</span><br></pre></td></tr></table></figure>

<p>.http文件即测试用例文档 ，它可以随着项目工程一起保存，这样测试的数据就可以保存下来，方便进行测试。</p>
<p>为了方便保存.http文件 ，我们单独在项目工程的根目录创建一个目录单独存放它们。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016.gif" alt="img"></p>
<p>我们以模块为单位创建.http文件。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018.gif" alt="img"></p>
<p>打开内容管理模块的 http文件 ，把刚才测试数据拷贝上去</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020.gif" alt="img"></p>
<p>为了方便将来和网关集成测试，这里我们把测试主机地址在配置文件http-client.env.json 中配置</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022.gif" alt="img"></p>
<p>注意：文件名称http-client.env.json保持一致，否则无法读取dev环境变量的内容。</p>
<p>内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gateway_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63010&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;content_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;system_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63110&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;media_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63050&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;search_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63080&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auth_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63070&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;checkcode_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63075&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;learning_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63020&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>再回到xc-content-api.http文件，将<a target="_blank" rel="noopener" href="http://localhost:63040/">http://localhost:63040</a> 用变量代替</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image024.gif" alt="img"></p>
<p>到此就完成了httpclient的配置与使用测试。</p>
<h1 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a><strong>前后端联调</strong></h1><h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><p>什么是前后端联调？</p>
<p>通常由后端工程师将接口设计好并编写接口文档，将接口文档交给前端工程师，前后端的工程师就开始并行开发，前端开发人员会使用mock数据（假数据）进行开发，当前后端代码完成后开始进行接口联调，前端工程师将mock数据改为请求后端接口获取，前端代码请求后端服务测试接口是否正常，这个过程是前后端联调。</p>
<p>当前后端联调出现问题需要根据测试环境下接口的请求及响应数据内容去判断是否符合接口文档的要求。查出是前端或后端的问题由具体的工程师负责修改缺陷，修改后再次回归测试。</p>
<p>在教学中进行前后端联调，首先配置前端环境，下边我们安装前端工程运行的环境。</p>
<p>首先从软件工具目录找到node-v16.17.0-x64.msi安装nodejs</p>
<p>安装完成，查看版本号</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-171068855806629.gif" alt="img"></p>
<p>idea中配置node.js</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/image-20240317232545772.png" alt="image-20240317232545772"></p>
<p>下边启动前端工程，从前端工程拷贝project-xczx2-portal-vue-ts.zip到代码目录并解压，并使用IDEA或VS Code打开project-xczx2-portal-vue-ts目录，下边以IDEA为例进行说明：</p>
<p>右键点击project-xczx2-portal-vue-ts目录下的package.json文件，</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-171068855806730.gif" alt="img"></p>
<p>点击Show npm Scripts打开npm窗口</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-171068855806731.gif" alt="img"></p>
<p>点击“Edit ‘serve’” setting，下边对启动项目的一些参数进行配置，选择nodejs、npm。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-171068855806732.gif" alt="img"></p>
<p>右键点击Serve，点击“Run serve”启动工程。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-171068855806733.gif" alt="img"></p>
<p>出现如下访问链接说明启动成功</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-171068855806734.gif" alt="img"></p>
<p>访问<a href="http://localhost:8601即可访问前端工程。">http://localhost:8601即可访问前端工程。</a></p>
<p>如果存在问题通过以下命令启动：</p>
<p>1、cmd进入工程根目录 </p>
<p>2、运行以下命令</p>
<p>npm install -g cnpm –registry&#x3D;<a target="_blank" rel="noopener" href="https://registry.npm.taobao.org/">https://registry.npm.taobao.org</a></p>
<p>cnpm i</p>
<p>npm run serve</p>
<h2 id="安装系统管理服务"><a href="#安装系统管理服务" class="headerlink" title="安装系统管理服务"></a>安装系统管理服务</h2><p>启动前端工程成功，在浏览器通过<a target="_blank" rel="noopener" href="http://localhost:8601/%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E3%80%82">http://localhost:8601/地址访问前端工程。</a></p>
<p>前端工程报错如下：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014-171068855806735.gif" alt="img"></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8601/api/system/dictionary/all">http://localhost:8601/system/dictionary/all</a> 指向的是系统管理服务。在前端讲解内容管理模块的需求时我们提到一个数据字典表，此链接正是在前端请求后端获取数据字典数据的接口地址。</p>
<p>数据字典表中配置了项目用的字典信息，此接口是查询字典中的全部数据 ，在此我们不再开发，按照下边的步骤安装系统管理服务即可。</p>
<p>从课程资料&#x2F;项目工程目录获取xuecheng-plus-system.zip，并解压</p>
<p>将xuecheng-plus-system目录拷贝到项目工程根目录，刷新maven，或进入pom.xml右键转为pom工程。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016-171068855806736.gif" alt="img"></p>
<p>进入xuecheng-plus-system-service工程，找到resources下的application.yml修改数据库连接参数。</p>
<p>启动系统管理服务，启动成功，在浏览器请求：<a target="_blank" rel="noopener" href="http://localhost:63110/system/dictionary/all">http://localhost:63110/system/dictionary/all</a></p>
<p>系统服务的端口是63110</p>
<p>如果可以正常读取数据字典信息则说明系统管理服务安装成功。</p>
<h2 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h2><p>在浏览器通过<a target="_blank" rel="noopener" href="http://localhost:8601/%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E3%80%82">http://localhost:8601/地址访问前端工程。</a></p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/image-20240318001127089.png" alt="image-20240318001127089"></p>
<p>chrome浏览器报错如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access to XMLHttpRequest at &#x27;http://localhost:63110/system/dictionary/all&#x27; from origin &#x27;http://localhost:8601&#x27; has been blocked by CORS policy: No &#x27;Access-Control-Allow-Origin&#x27; header is present on the requested resource.</span><br></pre></td></tr></table></figure>

<p>firefox浏览器报错如下：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">已拦截跨源请求：同源策略禁止读取位于 http://localhost:63110/system/dictionary/all 的远程资源。（原因：CORS 头缺少 &#x27;Access-Control-Allow-Origin&#x27;）。状态码：200。</span><br></pre></td></tr></table></figure>

<p>提示：从<a href="http://localhost:8601访问http://localhost:63110/system/dictionary/all被CORS">http://localhost:8601访问http://localhost:63110/system/dictionary/all被CORS</a> policy阻止，因为没有Access-Control-Allow-Origin 头信息。CORS全称是 cross origin resource share 表示跨域资源共享。</p>
<p>出这个提示的原因是基于浏览器的同源策略，去判断是否跨域请求，同源策略是浏览器的一种安全机制，从一个地址请求另一个地址，如果协议、主机、端口三者全部一致则不属于跨域，否则有一个不一致就是跨域请求。</p>
<p>比如：</p>
<p>从<a target="_blank" rel="noopener" href="http://localhost:8601/">http://localhost:8601</a> 到  <a target="_blank" rel="noopener" href="http://localhost:8602/">http://localhost:8602</a> 由于端口不同，是跨域。</p>
<p>从<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 到  <a target="_blank" rel="noopener" href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> 由于主机不同，是跨域。</p>
<p>从<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 到  <a target="_blank" rel="noopener" href="https://192.168.101.11:8601/">https://192.168.101.10:8601</a> 由于协议不同，是跨域。</p>
<p>注意：服务器之间不存在跨域请求。</p>
<p>浏览器判断是跨域请求会在请求头上添加origin，表示这个请求来源哪里。</p>
<p>比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Origin: http://localhost:8601</span><br></pre></td></tr></table></figure>

<p>服务器收到请求判断这个Origin是否允许跨域，如果允许则在响应头中说明允许该来源的跨域请求，如下：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin：http://localhost:8601 </span><br></pre></td></tr></table></figure>

<p>如果允许任何域名来源的跨域请求，则响应如下：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin：*</span><br></pre></td></tr></table></figure>

<p>解决跨域的方法：</p>
<p>1、JSONP</p>
<p>通过script标签的src属性进行跨域请求，如果服务端要响应内容则首先读取请求参数callback的值，callback是一个回调函数的名称，服务端读取callback的值后将响应内容通过调用callback函数的方式告诉请求方。如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018-171068855806737.gif" alt="img"> 2、添加响应头</p>
<p>服务端在响应头添加 Access-Control-Allow-Origin：*</p>
<p>3、通过nginx代理跨域</p>
<p>由于服务端之间没有跨域，浏览器通过nginx去访问跨域地址。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020-171068855806738.gif" alt="img"></p>
<p>1）浏览器先访问<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> nginx提供的地址，进入页面</p>
<p>2）此页面要跨域访问<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> ，不能直接跨域访问<a target="_blank" rel="noopener" href="http://www.baidu.com:8601/">http://www.baidu.com:8601</a> ，而是访问nginx的一个同源地址，比如：<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> ，通过<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> 的代理去访问<a href="http://www.baidu.com:8601。">http://www.baidu.com:8601。</a></p>
<p>这样就实现了跨域访问。</p>
<p>浏览器到<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> 没有跨域</p>
<p>nginx到<a href="http://www.baidu.com:8601通过服务端通信，没有跨域。">http://www.baidu.com:8601通过服务端通信，没有跨域。</a></p>
<p>我们准备使用方案2解决跨域问题。在内容管理的api工程config包下编写GlobalCorsConfig.java，</p>
<p>或直接从课程资料&#x2F;项目工程下拷贝，</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.system.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 跨域过虑器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 11:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalCorsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 允许跨域调用的过滤器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">   <span class="comment">//允许白名单域名进行跨域调用</span></span><br><span class="line">   config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">   <span class="comment">//允许跨越发送cookie</span></span><br><span class="line">   config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">   <span class="comment">//放行全部原始头信息</span></span><br><span class="line">   config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">   <span class="comment">//允许所有请求方法跨域调用</span></span><br><span class="line">   config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">   <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">   source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>此配置类实现了跨域过虑器，在响应头添加Access-Control-Allow-Origin。</p>
<p>重启系统管理服务，前端工程可以正常进入<a href="http://localhost:8601，观察浏览器记录，成功解决跨域。">http://localhost:8601，观察浏览器记录，成功解决跨域。</a></p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022-171068855806739.gif" alt="img"></p>
<h2 id="前后端联调-1"><a href="#前后端联调-1" class="headerlink" title="前后端联调"></a>前后端联调</h2><p>这里进行前后联调的目的是体会前后端联调的流程，测试的功能为课程查询功能。</p>
<p>1、启动前端工程，再启内容管理服务端。</p>
<p>2、修改服务端地址</p>
<p>前端默认连接的是项目的网关地址，由于现在网关工程还没有创建，这里需要更改前端工程的参数配置文件 ，修改网关地址为内容管理服务的地址。 </p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image024-171068855806740.gif" alt="img"></p>
<p>启动前端工程，用前端访问后端接口，观察前端界面的数据是否正确。</p>
<p>访问前端首页，进入课程管理：<a target="_blank" rel="noopener" href="http://localhost:8601/#/organization/course-list">http://localhost:8601/#/organization/course-list</a></p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image026.gif" alt="img"></p>
<p>更改课程条件及分页参数测试课程查询列表是否正常显示。</p>
<p>跟踪内容管理服务的输出日志，查看是否正常。</p>
<p>到此基本完成了前后端连调。</p>
<h1 id="课程分类查询"><a href="#课程分类查询" class="headerlink" title="课程分类查询"></a>课程分类查询</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>下边根据内容管理模块的业务流程，下一步要实现新增课程，在新增课程界面，有三处信息需要选择，如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-171069372561454.gif" alt="img"></p>
<p>课程等级、课程类型来源于数据字典表，此部分的信息前端已从系统管理服务读取。</p>
<p>课程分类信息没有在数据字典表中存储，而是由单独一张课程分类表，存储在内容管理数据库中。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-171069372561459.gif" alt="img"></p>
<p>下边看下course_category课程分类表的结构</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-171069372561455.gif" alt="img"></p>
<p>这张表是一个树型结构，通过父结点id将各元素组成一个树。</p>
<p>我们可以看下该表的数据，下图是一部分数据：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-171069372561456.gif" alt="img"></p>
<p>现在的需求是需要在内容管理服务中编写一个接口读取该课程分类表的数据，组成一个树型结构返回给前端。</p>
<p>课程分类的PO类如下：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-171069372561458.gif" alt="img"></p>
<p>如果没有此po类则需要生成的此表的po类拷贝到内容管理模块的model工程中，将mapper拷贝到内容管理模块的service工程中。</p>
<h2 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>我们可以点击新增课程，观察前端的请求记录：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-171069372561457.gif" alt="img"></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8601/api/content/course-category/tree-nodes">http://localhost:8601/api/content/course-category/tree-nodes</a> 该地址正是前端获取课程分类的接口地址。</p>
<p>通过上图界面的内容可以看出该接口的协议为：HTTP GET</p>
<p>请求参数为空。</p>
<p>通过查阅接口文档，此接口要返回全部课程分类，以树型结构返回，如下所示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;HTML/CSS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;HTML/CSS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;JavaScript&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;JavaScript&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jQuery&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jQuery&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ExtJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ExtJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AngularJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AngularJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Node.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Node.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-9&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Vue&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Vue&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-10&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;前端开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;前端开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;iOS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;iOS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;手游开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;手游开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Swift&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Swift&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Android&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Android&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactNative&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactNative&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Cordova&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Cordova&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>上边的数据格式是一个数组结构，数组的元素即为分类信息，分类信息设计两级分类，第一级的分类信息示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>

<p>第二级的分类是第一级分类中childrenTreeNodes属性，它是一个数组结构：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>所以，定义一个DTO类表示分类信息的模型类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseCategory;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程分类树型结点dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 15:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryTreeDto</span> <span class="keyword">extends</span> <span class="title class_">CourseCategory</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  List&lt;CourseCategoryTreeDto&gt; childrenTreeNodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseCategoryService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 数据字典 前端控制器</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/course-category/tree-nodes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="树型表查询"><a href="#树型表查询" class="headerlink" title="树型表查询"></a><strong>树型表查询</strong></h2><p>课程分类表是一个树型结构，其中parentid字段为父结点ID，它是树型结构的标志字段。</p>
<p>如果树的层级固定可以使用表的自链接去查询，比如：我们只查询两级课程分类，可以用下边的SQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">       one.id            one_id,</span><br><span class="line">       one.name          one_name,</span><br><span class="line">       one.parentid      one_parentid,</span><br><span class="line">       one.orderby       one_orderby,</span><br><span class="line">       one.label         one_label,</span><br><span class="line">       two.id            two_id,</span><br><span class="line">       two.name          two_name,</span><br><span class="line">       two.parentid      two_parentid,</span><br><span class="line">       two.orderby       two_orderby,</span><br><span class="line">       two.label         two_label</span><br><span class="line">   from course_category one</span><br><span class="line">            inner join course_category two on one.id = two.parentid</span><br><span class="line">   where one.parentid = 1</span><br><span class="line">     and one.is_show = 1</span><br><span class="line">     and two.is_show = 1</span><br><span class="line">   order by one.orderby,</span><br><span class="line">            two.orderby</span><br></pre></td></tr></table></figure>

<p>如果树的层级不确定，此时可以使用MySQL递归实现，使用with语法，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WITH [RECURSIVE]</span><br><span class="line">        cte_name [(col_name [, col_name] ...)] AS (subquery)</span><br><span class="line">        [, cte_name [(col_name [, col_name] ...)] AS (subquery)] ...</span><br></pre></td></tr></table></figure>

<p>cte_name :公共表达式的名称,可以理解为表名,用来表示as后面跟着的子查询</p>
<p>col_name :公共表达式包含的列名,可以写也可以不写</p>
<p>下边是一个递归的简单例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">with RECURSIVE t1  AS</span><br><span class="line">(</span><br><span class="line">  SELECT 1 as n</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT n + 1 FROM t1 WHERE n &lt; 5</span><br><span class="line">)</span><br><span class="line">SELECT * FROM t1;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014-171069372561460.gif" alt="img"></p>
<p>说明：</p>
<p>t1 相当于一个表名</p>
<p>select 1 相当于这个表的初始值，这里使用UNION ALL 将初始值加入到表中。</p>
<p>n&lt;5为递归执行的条件，当n&gt;&#x3D;5时结束递归调用。</p>
<p>下边我们使用递归实现课程分类的查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">with recursive t1 as (</span><br><span class="line">select * from  course_category p where  id= &#x27;1&#x27;</span><br><span class="line">union all</span><br><span class="line"> select t.* from course_category t inner join t1 on t1.id = t.parentid</span><br><span class="line">)</span><br><span class="line">select *  from t1 order by t1.id, t1.orderby</span><br></pre></td></tr></table></figure>

<p>查询结果如下：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016-171069372561461.gif" alt="img"></p>
<p>t1表中初始的数据是id等于1的记录，即根结点。</p>
<p>通过inner join t1 t2 on t2.id &#x3D; t.parentid 找到id&#x3D;’1’的下级节点 。</p>
<p>通过这种方法就找到了id&#x3D;’1’的所有下级节点，下级节点包括了所有层级的节点。</p>
<p>上边这种方法是向下递归，即找到初始节点的所有下级节点。</p>
<p>如何向上递归？</p>
<p>下边的sql实现了向上递归：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">with recursive t1 <span class="title function_">as</span> <span class="params">(</span></span><br><span class="line"><span class="params">select * from  course_category p where  id= <span class="string">&#x27;1-1-1&#x27;</span></span></span><br><span class="line"><span class="params">union all</span></span><br><span class="line"><span class="params"> select t.* from course_category t inner join t1 on t1.parentid = t.id</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">select *  from t1 order by t1.id, t1.orderby</span><br></pre></td></tr></table></figure>

<p>初始节点为1-1-1，通过递归找到它的父级节点，父级节点包括所有级别的节点。</p>
<p>以上是我们研究了树型表的查询方法，通过递归的方式查询课程分类比较灵活，因为它可以不限制层级。</p>
<p>mysql为了避免无限递归默认递归次数为1000，可以通过设置cte_max_recursion_depth参数增加递归深度，还可以通过max_execution_time限制执行时间，超过此时间也会终止递归操作。</p>
<p>mysql递归相当于在存储过程中执行若干次sql语句，java程序仅与数据库建立一次链接执行递归操作，所以只要控制好递归深度，控制好数据量性能就没有问题。</p>
<p>思考：如果java程序在递归操作中连接数据库去查询数据组装数据，这个性能高吗？</p>
<h2 id="开发Mapper"><a href="#开发Mapper" class="headerlink" title="开发Mapper"></a><strong>开发Mapper</strong></h2><p>下边我们可自定义mapper方法查询课程分类，最终将查询结果映射到List&lt;CourseCategoryTreeDto&gt;中。</p>
<p>生成课程分类表的mapper文件并拷贝至内容管理模块的service工程中。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018-171069372561462.gif" alt="img"></p>
<p>1、下边 定义一个mapper方法，并定义sql语句。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseCategoryMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;CourseCategory&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">selectTreeNodes</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、找到对应 的mapper.xml文件，编写sql语句。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;selectTreeNodes&quot;</span> resultType=<span class="string">&quot;com.xuecheng.content.model.dto.CourseCategoryTreeDto&quot;</span> parameterType=<span class="string">&quot;string&quot;</span>&gt;</span><br><span class="line">    with recursive t1 <span class="title function_">as</span> <span class="params">(</span></span><br><span class="line"><span class="params">        select * from  course_category p where  id= #&#123;id&#125;</span></span><br><span class="line"><span class="params">        union all</span></span><br><span class="line"><span class="params">        select t.* from course_category t inner join t1 on t1.id = t.parentid</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">    select *  from t1 order by t1.id, t1.orderby</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>



<h2 id="开发service"><a href="#开发service" class="headerlink" title="开发service"></a><strong>开发service</strong></h2><p>定义service接口，调用mapper查询课程分类，遍历数据按照接口要求对数据进行封装</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseCategoryService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程分类树形结构查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写service接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CourseCategoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseCategoryMapper courseCategoryMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">(String id)</span> &#123;</span><br><span class="line">       List&lt;CourseCategoryTreeDto&gt; courseCategoryTreeDtos = courseCategoryMapper.selectTreeNodes(id);</span><br><span class="line">    <span class="comment">//将list转map,以备使用,排除根节点</span></span><br><span class="line">    Map&lt;String, CourseCategoryTreeDto&gt; mapTemp = courseCategoryTreeDtos.stream().filter(item-&gt;!id.equals(item.getId())).collect(Collectors.toMap(key -&gt; key.getId(), value -&gt; value, (key1, key2) -&gt; key2));</span><br><span class="line">    <span class="comment">//最终返回的list</span></span><br><span class="line">    List&lt;CourseCategoryTreeDto&gt; categoryTreeDtos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//依次遍历每个元素,排除根节点</span></span><br><span class="line">    courseCategoryTreeDtos.stream().filter(item-&gt;!id.equals(item.getId())).forEach(item-&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(item.getParentid().equals(id))&#123;</span><br><span class="line">            categoryTreeDtos.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//找到当前节点的父节点</span></span><br><span class="line">        <span class="type">CourseCategoryTreeDto</span> <span class="variable">courseCategoryTreeDto</span> <span class="operator">=</span> mapTemp.get(item.getParentid());</span><br><span class="line">        <span class="keyword">if</span>(courseCategoryTreeDto!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(courseCategoryTreeDto.getChildrenTreeNodes() ==<span class="literal">null</span>)&#123;</span><br><span class="line">                courseCategoryTreeDto.setChildrenTreeNodes(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;CourseCategoryTreeDto&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//下边开始往ChildrenTreeNodes属性中放子节点</span></span><br><span class="line">            courseCategoryTreeDto.getChildrenTreeNodes().add(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> categoryTreeDtos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a><strong>单元测试</strong></h2><p>定义单元测试类对service接口进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseCategoryService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CourseCategoryServiceTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseCategoryService courseCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCourseCategoryService</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;CourseCategoryTreeDto&gt; courseCategoryTreeDtos = courseCategoryService.queryTreeNodes(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        System.out.println(courseCategoryTreeDtos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><h2 id="接口层代码完善"><a href="#接口层代码完善" class="headerlink" title="接口层代码完善"></a><strong>接口层代码完善</strong></h2><p>完善controller方法，注入service调用业务层方法查询课程分类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseCategoryService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程分类相关接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseCategoryService courseCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/course-category/tree-nodes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> courseCategoryService.queryTreeNodes(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h2><p>使用httpclient测试：</p>
<p>定义.http文件 </p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020-171069372561463.gif" alt="img"></p>
<p>运行测试。</p>
<p>完成前后端连调：</p>
<p>打开前端工程，进入新增课程页面。</p>
<p>课程分类下拉框可以正常显示</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022-171069372561464.gif" alt="img"></p>
<h1 id="新增课程"><a href="#新增课程" class="headerlink" title="新增课程"></a><strong>新增课程</strong></h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>根据前边对内容管理模块的数据模型分析，课程相关的信息有：课程基本信息、课程营销信息、课程图片信息、课程计划、课程师资信息，所以新增一门课程需要完成这几部分信息的填写。</p>
<p>以下是业务流程：</p>
<p>1、进入课程查询列表</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-17108230650771.gif" alt="img"></p>
<p>2、点击添加课程，选择课程形式为录播。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-17108230650772.gif" alt="img"></p>
<p>3、选择完毕，点击下一步，进入课程基本信息添加界面。</p>
<p>本界面分两部分信息，一部分是课程基本信息上，一部分是课程营销信息。</p>
<p>课程基本信息：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-17108230650773.gif" alt="img"></p>
<p>课程营销信息：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-17108230650774.gif" alt="img"></p>
<p>在这个界面中填写课程的基本信息、课程营销信息上。</p>
<p>填写完毕，保存并进行下一步。</p>
<p>4、在此界面填写课程计划信息</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-17108230650775.gif" alt="img"></p>
<p>课程计划即课程的大纲目录。</p>
<p>课程计划分为两级，章节和小节。</p>
<p>每个小节需要上传课程视频，用户点击 小节的标题即开始播放视频。</p>
<p>如果是直播课程则会进入直播间。</p>
<p>5、课程 计划填写完毕进入课程师资的管理。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-17108230650776.gif" alt="img"></p>
<p>在课程师资界面维护该课程的授课老师。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014-17108230650777.gif" alt="img"></p>
<p>至此，一门课程新增完成。</p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>通过业务流程可知，一门课程信息涉及：课程基本信息、课程营销信息、课程计划信息、课程师资信息。</p>
<p>本节开发新增课程按钮功能， 只向课程基本信息、课程营销信息添加记录。</p>
<p>这两部分信息分别在course_base、course_market两张表存储。当点击保存按钮时向这两张表插入数据。这两张表是一对一关联关系。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016-17108230650778.gif" alt="img"></p>
<p>新建课程的初始审核状态为“未提交”、初始发布状态为“未发布”。</p>
<p>生成课程基本信息、课程营销信息的PO、Mapper文件 </p>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>根据业务流程，这里先定义提交课程基本信息的接口。</p>
<p>1、接口协议 ：HTTP POST，Content-Type为application&#x2F;json</p>
<p>2、请求及响应结果如下</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018-17108230650779.gif" alt="img"></p>
<p>3、接口请求示例如下 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">### 创建课程</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;初级人员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;originalPrice&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;qq&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wechat&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;validDays&quot;</span>: <span class="number">365</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###响应结果如下</span><br><span class="line">#成功响应结果如下</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">109</span>,</span><br><span class="line">  <span class="string">&quot;companyId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;测试课程103&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;初级人员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2022-09-08 07:35:16&quot;</span>,</span><br><span class="line">  <span class="string">&quot;changeDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;coursePubId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;originalPrice&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;qq&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wechat&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;validDays&quot;</span>: <span class="number">365</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、定义请求参数类型和响应结构类型</p>
<p>根据接口定义内容，请求参数相比 CourseBase模型类不一致，需要在dto包下自定义，模型类从课程资料&#x2F;工程目录获取。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020-171082306507710.gif" alt="img"></p>
<p>4、定义接口如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="保存课程基本信息"><a href="#保存课程基本信息" class="headerlink" title="保存课程基本信息"></a><strong>保存课程基本信息</strong></h2><p>根据需求分析，新增课程表单中包括了课程基本信息、课程营销信息，需要分别向课程基本信息表、课程营销表保证数据。</p>
<p>首先定义service接口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 添加课程基本信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> companyId  教学机构id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> addCourseDto  课程基本信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CourseBaseInfoDto</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/7 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(Long companyId,AddCourseDto addCourseDto)</span>;</span><br></pre></td></tr></table></figure>



<p>编写service接口实现类，实现向课程基本信息表保存数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(Long companyId, AddCourseDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//合法性校验</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getName())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程名称为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getMt())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getSt())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getGrade())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程等级为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getTeachmode())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;教育模式为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getUsers())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;适应人群为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getCharge())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;收费规则为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//新增对象</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBaseNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBase</span>();</span><br><span class="line">    <span class="comment">//将填写的课程信息赋值给新增对象</span></span><br><span class="line">    BeanUtils.copyProperties(dto,courseBaseNew);</span><br><span class="line">    <span class="comment">//设置审核状态</span></span><br><span class="line">    courseBaseNew.setAuditStatus(<span class="string">&quot;202002&quot;</span>);</span><br><span class="line">    <span class="comment">//设置发布状态</span></span><br><span class="line">    courseBaseNew.setStatus(<span class="string">&quot;203001&quot;</span>);</span><br><span class="line">    <span class="comment">//机构id</span></span><br><span class="line">    courseBaseNew.setCompanyId(companyId);</span><br><span class="line">    <span class="comment">//添加时间</span></span><br><span class="line">    courseBaseNew.setCreateDate(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//插入课程基本信息表</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> courseBaseMapper.insert(courseBaseNew);</span><br><span class="line">    <span class="keyword">if</span>(insert&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;新增课程基本信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向课程营销表保存课程营销信息</span></span><br><span class="line">    <span class="comment">//课程营销信息</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarketNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseMarket</span>();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> courseBaseNew.getId();</span><br><span class="line">    BeanUtils.copyProperties(dto,courseMarketNew);</span><br><span class="line">    courseMarketNew.setId(courseId);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> saveCourseMarket(courseMarketNew);</span><br><span class="line">    <span class="keyword">if</span>(i&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;保存课程营销信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询课程基本信息及营销信息并返回</span></span><br><span class="line">    <span class="keyword">return</span> getCourseBaseInfo(courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//保存课程营销信息</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">saveCourseMarket</span><span class="params">(CourseMarket courseMarketNew)</span>&#123;</span><br><span class="line">    <span class="comment">//收费规则</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> courseMarketNew.getCharge();</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(charge))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;收费规则没有选择&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//收费规则为收费</span></span><br><span class="line">    <span class="keyword">if</span>(charge.equals(<span class="string">&quot;201001&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(courseMarketNew.getPrice() == <span class="literal">null</span> || courseMarketNew.getPrice().floatValue()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程为收费价格不能为空且必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据id从课程营销表查询</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarketObj</span> <span class="operator">=</span> courseMarketMapper.selectById(courseMarketNew.getId());</span><br><span class="line">    <span class="keyword">if</span>(courseMarketObj == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> courseMarketMapper.insert(courseMarketNew);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        BeanUtils.copyProperties(courseMarketNew,courseMarketObj);</span><br><span class="line">        courseMarketObj.setId(courseMarketNew.getId());</span><br><span class="line">        <span class="keyword">return</span> courseMarketMapper.updateById(courseMarketObj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据课程id查询课程基本信息，包括基本信息和营销信息</span></span><br><span class="line"> <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseInfo</span><span class="params">(<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(courseBase == <span class="literal">null</span>)&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line">  <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfoDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDto</span>();</span><br><span class="line">  BeanUtils.copyProperties(courseBase,courseBaseInfoDto);</span><br><span class="line">  <span class="keyword">if</span>(courseMarket != <span class="literal">null</span>)&#123;</span><br><span class="line">   BeanUtils.copyProperties(courseMarket,courseBaseInfoDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询分类名称</span></span><br><span class="line">  <span class="type">CourseCategory</span> <span class="variable">courseCategoryBySt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getSt());</span><br><span class="line">  courseBaseInfoDto.setStName(courseCategoryBySt.getName());</span><br><span class="line">  <span class="type">CourseCategory</span> <span class="variable">courseCategoryByMt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getMt());</span><br><span class="line">  courseBaseInfoDto.setMtName(courseCategoryByMt.getName());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoDto;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、首先去完善controller方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、使用httpclient测试</p>
<p>在xc-content-api.http中定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">### 创建课程</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;originalPrice&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;qq&quot;</span>: <span class="string">&quot;22333&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wechat&quot;</span>: <span class="string">&quot;223344&quot;</span>,</span><br><span class="line">  <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;13333333&quot;</span>,</span><br><span class="line">  <span class="string">&quot;validDays&quot;</span>: <span class="number">365</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;测试课程103&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;初级人员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、前后端联调</p>
<p>打开新增课程页面，除了课程图片其它信息全部输入。</p>
<p>点击保存，观察浏览器请求接口参数及响应结果是否正常。</p>
<h1 id="【面试】Mybatis分页插件的原理？"><a href="#【面试】Mybatis分页插件的原理？" class="headerlink" title="【面试】Mybatis分页插件的原理？"></a>【面试】Mybatis分页插件的原理？</h1><ol>
<li><p>Mybatis分页插件的原理？</p>
<p>首先分页参数会放到ThreadLocal中，拦截执行sql，根据数据库类型添加对应的分页语句重写sql，例如：（select * from  table where a）转换为（select count(*) from table where a）和（select * from table where a limit ,)计算出total总条数，pageNum当前第几页，pageSize每页大小和当前页的数据，是否为首页，是否为尾页，总页数等。</p>
</li>
</ol>
<h1 id="【面试】1、树型表的标记字段是什么-如何查询MySQL树型表"><a href="#【面试】1、树型表的标记字段是什么-如何查询MySQL树型表" class="headerlink" title="【面试】1、树型表的标记字段是什么?如何查询MySQL树型表?"></a>【面试】1、树型表的标记字段是什么?如何查询MySQL树型表?</h1><p>树型表的标记字段是parentid即父结点的id。</p>
<h1 id="【面试】查询一个树型表的方法"><a href="#【面试】查询一个树型表的方法" class="headerlink" title="【面试】查询一个树型表的方法:"></a>【面试】查询一个树型表的方法:</h1><p>1） 当层级固定时可以用表的自链接进行查询。</p>
<p>2） 如果想灵活查询每个层级可以使用mysql递归方法，使用with RECURSIVE 实现。</p>
<h1 id="【面试】MyBatis的ResultType和ResultMap的区别"><a href="#【面试】MyBatis的ResultType和ResultMap的区别" class="headerlink" title="【面试】MyBatis的ResultType和ResultMap的区别?"></a>【面试】MyBatis的ResultType和ResultMap的区别?</h1><p>ResultType:指定映射类型，只要查询的字段名和类型的属性名匹配可以自动映射。</p>
<p>ResultMap:自定义映射规则，当查询的字段名和映射类型的属性不匹配时可以通过ResultMap自定义映射规则,也可以实现一对多、—对一映射。</p>
<p>3、#{}和${}有什么区别?<br>#{}是标记一个占位符，可以防止sql注入。<br>${}用于在动态sql中拼接字符串，可能导致sql注入。</p>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a><strong>异常处理</strong></h2><h2 id="异常问题分析"><a href="#异常问题分析" class="headerlink" title="异常问题分析"></a><strong>异常问题分析</strong></h2><p>在service方法中有很多的参数合法性校验，当参数不合法则抛出异常，下边我们测试下异常处理。</p>
<p>请求创建课程基本信息，故意将必填项设置为空。</p>
<p>测试发现报500异常，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:63040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, <span class="number">07</span> Sep <span class="number">2022</span> <span class="number">11</span>:<span class="number">40</span>:<span class="number">29</span> GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;timestamp&quot;</span>: <span class="string">&quot;2022-09-07T11:40:29.677+00:00&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/content/course&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：并没有输出我们抛出异常时指定的异常信息。</p>
<p>所以，现在我们的需求是当正常操作时按接口要求返回数据，当非正常流程时要获取异常信息进行记录，并提示给用户。</p>
<p>异常处理除了输出在日志中，还需要提示给用户，前端和后端需要作一些约定：</p>
<p>1、错误提示信息统一以json格式返回给前端。</p>
<p>2、以HTTP状态码决定当前是否出错，非200为操作异常。</p>
<p>如何规范异常信息？</p>
<p>代码中统一抛出项目的自定义异常类型，这样可以统一去捕获这一类或几类的异常。</p>
<p>规范了异常类型就可以去获取异常信息。</p>
<p>如果捕获了非项目自定义的异常类型统一向用户提示“执行过程异常，请重试”的错误信息。</p>
<p>如何捕获异常？</p>
<p>代码统一用try&#x2F;catch方式去捕获代码比较臃肿，可以通过SpringMVC提供的控制器增强类统一由一个类去完成异常的捕获。</p>
<p>如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022-171082306507711.gif" alt="img"></p>
<h2 id="统一异常处理实现"><a href="#统一异常处理实现" class="headerlink" title="统一异常处理实现"></a><strong>统一异常处理实现</strong></h2><p>根据上边分析的方案，统一在base基础工程实现统一异常处理，各模块依赖了base基础工程都 可以使用。</p>
<p>首先在base基础工程添加需要依赖的包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt; </span><br></pre></td></tr></table></figure>

<p>1、定义一些通用的异常信息</p>
<p>从课程资料&#x2F;工程目录 拷贝CommonError 类到base工程com.xuecheng.base.execption下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 通用错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">CommonError</span> &#123;</span><br><span class="line"></span><br><span class="line">   UNKOWN_ERROR(<span class="string">&quot;执行过程异常，请重试。&quot;</span>),</span><br><span class="line">   PARAMS_ERROR(<span class="string">&quot;非法参数&quot;</span>),</span><br><span class="line">   OBJECT_NULL(<span class="string">&quot;对象为空&quot;</span>),</span><br><span class="line">   QUERY_NULL(<span class="string">&quot;查询结果为空&quot;</span>),</span><br><span class="line">   REQUEST_NULL(<span class="string">&quot;请求参数为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="title function_">CommonError</span><span class="params">( String errMessage)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2、自定义异常类型</p>
<p>在base工程com.xuecheng.base.execption下自定义异常类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 学成在线项目异常类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XueChengPlusException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">XueChengPlusException</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">XueChengPlusException</span><span class="params">(String errMessage)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(errMessage);</span><br><span class="line">      <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cast</span><span class="params">(CommonError commonError)</span>&#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(commonError.getErrMessage());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cast</span><span class="params">(String errMessage)</span>&#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(errMessage);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、响应用户的统一类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 错误响应参数包装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestErrorResponse</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestErrorResponse</span><span class="params">(String errMessage)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.errMessage= errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setErrMessage</span><span class="params">(String errMessage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4、全局异常处理器</p>
<p>​    从 Spring 3.0 - Spring 3.2 版本之间，对 Spring 架构和 SpringMVC 的Controller 的异常捕获提供了相应的异常处理。</p>
<p>•     @ExceptionHandler</p>
<p>•     Spring3.0提供的标识在方法上或类上的注解，用来表明方法的处理异常类型。</p>
<p>•     @ControllerAdvice</p>
<p>•     Spring3.2提供的新注解，从名字上可以看出大体意思是控制器增强，    在项目中来增强SpringMVC中的Controller。通常和**@ExceptionHandler** 结合使用，来处理SpringMVC的异常信息。</p>
<p>•     @ResponseStatus</p>
<p>•     Spring3.0提供的标识在方法上或类上的注解，用状态代码和应返回的原因标记方法或异常类。<br> 调用处理程序方法时，状态代码将应用于HTTP响应。</p>
<p>通过上面的两个注解便可实现微服务端全局异常处理，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 全局异常处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@ExceptionHandler(XueChengPlusException.class)</span></span><br><span class="line">   <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">   <span class="keyword">public</span> RestErrorResponse <span class="title function_">customException</span><span class="params">(XueChengPlusException e)</span> &#123;</span><br><span class="line">      log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getErrMessage(),e);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(e.getErrMessage());</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">   <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">   <span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line"></span><br><span class="line">      log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getMessage(),e);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="异常处理测试"><a href="#异常处理测试" class="headerlink" title="异常处理测试"></a><strong>异常处理测试</strong></h2><p>在内容管理的api工程添加base工程的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在异常处理测试之前首先在代码中抛出自定义类型的异常，这里以新增课程的service方法为例进行代码修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(Long companyId,AddCourseDto dto)</span> &#123;</span><br><span class="line"> ...</span><br><span class="line"><span class="comment">//合法性校验</span></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getName())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程名称为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getMt())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getSt())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getGrade())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程等级为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getTeachmode())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;教育模式为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getUsers())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;适应人群&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getCharge())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;收费规则为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  。。。</span><br><span class="line">   <span class="keyword">if</span>(charge.equals(<span class="string">&quot;201001&quot;</span>))&#123;</span><br><span class="line">       <span class="keyword">if</span>(courseMarketNew.getPrice() ==<span class="literal">null</span> || courseMarketNew.getPrice().floatValue()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程的价格不能为空并且必须大于0&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  。。。</span><br></pre></td></tr></table></figure>



<p>1、首先使用httpclient测试</p>
<p>请求新增课程接口，故意将必填项课程名称设置为空。</p>
<p>测试结果与预期一致，可以捕获异常并响应异常信息，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:63040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, <span class="number">07</span> Sep <span class="number">2022</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">14</span> GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;errMessage&quot;</span>: <span class="string">&quot;课程名称为空。&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、前后端调试</p>
<p>仍然测试新增课程接口，当课程收费的时候必须填写价格，这里设置课程为收费，价格设置为空。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image024-171082306507712.gif" alt="img"></p>
<p>通过测试发现，前端正常提示代码 中抛出的异常信息。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image026-171082306507713.gif" alt="img"></p>
<p>至此，项目异常处理的测试完毕，我们在开发中对于业务分支中错误的情况要抛出项目自定义的异常类型。</p>
<h1 id="【面试】1、系统如何处理异常"><a href="#【面试】1、系统如何处理异常" class="headerlink" title="【面试】1、系统如何处理异常?"></a>【面试】1、系统如何处理异常?</h1><p>我们自定义—个统一的异常处理器去捕获并处理异常。<br>使用控制器增加注解@ControllerAdvice和异常处理注解@ExceptionHandler来实现。1)处理自定义异常<br>程序在编写代码时根据校验结果主动抛出自定义异常类对象，抛出异常时指定详细的异常信息，异常处理器捕获异常信息记录异常日志并响应给用户。<br>2)处理未知异常<br>接口执行过程中的一些运行时异常也会由异常处理器统一捕获，记录异常日志，统一响应给用户500错误。在异常处理器中还可以针对某个异常类型进行单独处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
		  
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/2698022795" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:2698022795@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/qq_40493033" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

		  
			
			  <div class="links-of-blogroll motion-element links-of-blogroll-block">
				<div class="links-of-blogroll-title">
				  <!-- modify icon to fire by szw -->
				  <i class="fa fa-history fa-" aria-hidden="true"></i>
				  近期文章
				</div>
				<ul class="links-of-blogroll-list">
				  
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/31/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" title="学成在线技术总结" target="_blank">学成在线技术总结</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" title="微服务技术总结" target="_blank">微服务技术总结</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/27/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/" title="苍穹外卖技术总结" target="_blank">苍穹外卖技术总结</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/" title="学成在线-day09-课程发布 + day10-页面静态化、认证授权、SpringSecurity" target="_blank">学成在线-day09-课程发布 + day10-页面静态化、认证授权、SpringSecurity</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/" title="学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案" target="_blank">学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案</a>
					</li>
				  
				</ul>
			  </div>
			


          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">waterdance</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">268.1k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>

-->



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "default";
      
          flOptions.boxForm = "vertical";
      
          flOptions.position = "topRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  
  
		# 要加入的代码
</body>
</html>
