<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />




  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg?v=5.1.4">






  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="和光同尘">
<meta property="og:type" content="website">
<meta property="og:title" content="章北海">
<meta property="og:url" content="http://2698022795.github.io/index.html">
<meta property="og:site_name" content="章北海">
<meta property="og:description" content="和光同尘">
<meta property="og:locale">
<meta property="article:author" content="waterdance">
<meta property="article:tag" content="Java,Python,Linux,C++,算法,编程技术">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://2698022795.github.io/"/>





  <title>章北海</title>
  








<meta name="generator" content="Hexo 6.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">章北海</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">轻舟已过万重山</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/" itemprop="url">如何在hexo中安装next主题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
	   		  <i class="fa fa-thumb-tack"></i>
			  <font color=7D26CD>置顶</font>
			  <span class="post-meta-divider">|</span>
			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-01-12T13:57:00+08:00">
                2024-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index">
                    <span itemprop="name">博客</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="1-安装hexo"><a href="#1-安装hexo" class="headerlink" title="1. 安装hexo"></a>1. 安装hexo</h1><p>npm install -g hexo-cli</p>
<h1 id="2-主题下载安装"><a href="#2-主题下载安装" class="headerlink" title="2. 主题下载安装"></a>2. 主题下载安装</h1><p>进入命令行，下载 NexT 主题，输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure>

<p>修改站点配置文件<code>_config.yml</code>，找到如下代码：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">landscape</span></span><br></pre></td></tr></table></figure>

<p>将 landscape 修改为 next 即可。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2024/01/12/%E5%A6%82%E4%BD%95%E5%9C%A8hexo%E4%B8%AD%E5%AE%89%E8%A3%85next%E4%B8%BB%E9%A2%98/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/" itemprop="url">学成在线-day09-课程发布</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-24T14:46:43+08:00">
                2024-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  0
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/" itemprop="url">学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-22T11:49:51+08:00">
                2024-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  18.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  77
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="5-上传视频"><a href="#5-上传视频" class="headerlink" title="5 上传视频"></a><strong>5</strong> <strong>上传视频</strong></h1><h2 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a><strong>5.1</strong> <strong>需求分析</strong></h2><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p>
<p>点击“媒资管理”</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image002.gif" alt="img"></p>
<p>进入媒资管理列表页面查询本机构上传的媒资文件。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image004.gif" alt="img"></p>
<p>2、教育机构用户在”媒资管理”页面中点击 “上传视频” 按钮。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image006.gif" alt="img"></p>
<p>点击“上传视频”打开上传页面</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image008.gif" alt="img"></p>
<p>3、选择要上传的文件，自动执行文件上传。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image010.gif" alt="img"></p>
<p>4、视频上传成功会自动处理，处理完成可以预览视频。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image012.gif" alt="img"></p>
<h2 id="5-2-断点续传技术"><a href="#5-2-断点续传技术" class="headerlink" title="5.2 断点续传技术"></a><strong>5.2</strong> <strong>断点续传技术</strong></h2><h3 id="5-2-1-什么是断点续传"><a href="#5-2-1-什么是断点续传" class="headerlink" title="5.2.1 什么是断点续传"></a><strong>5.2.1</strong> <strong>什么是断点续传</strong></h3><p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p>
<p>什么是断点续传：</p>
<p>​    引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p>
<p>断点续传流程如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image014.gif" alt="img"></p>
<p>流程如下：</p>
<p>1、前端上传前先把文件分成块</p>
<p>2、一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p>
<p>3、各分块上传完成最后在服务端合并文件</p>
<h3 id="5-2-2-分块与合并测试"><a href="#5-2-2-分块与合并测试" class="headerlink" title="5.2.2 分块与合并测试"></a><strong>5.2.2</strong> <strong>分块与合并测试</strong></h3><p>为了更好的理解文件分块上传的原理，下边用java代码测试文件的分块与合并。</p>
<p>文件分块的流程如下：</p>
<p>1、获取源文件长度</p>
<p>2、根据设定的分块文件的大小计算出块数</p>
<p>3、从源文件读数据依次向每一个块文件写数据</p>
<p>测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件处理测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 9:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFileTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试文件分块方法</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChunk</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkPath</span> <span class="operator">=</span> <span class="string">&quot;d:/develop/bigfile_test/chunk/&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkPath);</span><br><span class="line">        <span class="keyword">if</span> (!chunkFolder.exists()) &#123;</span><br><span class="line">            chunkFolder.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分块大小</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//分块数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chunkNum</span> <span class="operator">=</span> (<span class="type">long</span>) Math.ceil(sourceFile.length() * <span class="number">1.0</span> / chunkSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;分块总数：&quot;</span>+chunkNum);</span><br><span class="line">        <span class="comment">//缓冲区大小</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">//使用RandomAccessFile访问文件</span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_read</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(sourceFile, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="comment">//分块</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chunkNum; i++) &#123;</span><br><span class="line">            <span class="comment">//创建分块文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkPath + i);</span><br><span class="line">            <span class="keyword">if</span>(file.exists())&#123;</span><br><span class="line">                file.delete();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">newFile</span> <span class="operator">=</span> file.createNewFile();</span><br><span class="line">            <span class="keyword">if</span> (newFile) &#123;</span><br><span class="line">                <span class="comment">//向分块文件中写数据</span></span><br><span class="line">                <span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> ((len = raf_read.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line">                    <span class="keyword">if</span> (file.length() &gt;= chunkSize) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                raf_write.close();</span><br><span class="line">                System.out.println(<span class="string">&quot;完成分块&quot;</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        raf_read.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件合并流程：</p>
<p>1、找到要合并的文件并按文件合并的先后进行排序。</p>
<p>2、创建合并文件</p>
<p>3、依次从合并的文件中读取数据向合并文件写入数</p>
<p>文件合并的测试代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试文件合并方法</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMerge</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//块文件目录</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/chunk/&quot;</span>);</span><br><span class="line">    <span class="comment">//原始文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">originalFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span>);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos01.mp4&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mergeFile.exists()) &#123;</span><br><span class="line">        mergeFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建新的合并文件</span></span><br><span class="line">    mergeFile.createNewFile();</span><br><span class="line">    <span class="comment">//用于写文件</span></span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    <span class="comment">//指针指向文件顶端</span></span><br><span class="line">    raf_write.seek(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//缓冲区</span></span><br><span class="line">    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">//分块列表</span></span><br><span class="line">    File[] fileArray = chunkFolder.listFiles();</span><br><span class="line">    <span class="comment">// 转成集合，便于排序</span></span><br><span class="line">    List&lt;File&gt; fileList = Arrays.asList(fileArray);</span><br><span class="line">    <span class="comment">// 从小到大排序</span></span><br><span class="line">    Collections.sort(fileList, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;File&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(File o1, File o2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(o1.getName()) - Integer.parseInt(o2.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="keyword">for</span> (File chunkFile : fileList) &#123;</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_read</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(chunkFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = raf_read.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        raf_read.close();</span><br><span class="line">    &#125;</span><br><span class="line">    raf_write.close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验文件</span></span><br><span class="line">    <span class="keyword">try</span> (</span><br><span class="line"></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(originalFile);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">mergeFileStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile);</span><br><span class="line"></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">//取出原始文件的md5</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="comment">//取出合并文件的md5进行比较</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">mergeFileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(mergeFileStream);</span><br><span class="line">        <span class="keyword">if</span> (originalMd5.equals(mergeFileMd5)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;合并文件成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;合并文件失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-2-3-视频上传流程"><a href="#5-2-3-视频上传流程" class="headerlink" title="5.2.3 视频上传流程"></a><strong>5.2.3</strong> <strong>视频上传流程</strong></h3><p>下图是上传视频的整体流程：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image016.gif" alt="img"></p>
<p>1、前端对文件进行分块。</p>
<p>2、前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。</p>
<p>3、如果分块文件不存在则前端开始上传</p>
<p>4、前端请求媒资服务上传分块。</p>
<p>5、媒资服务将分块上传至MinIO。</p>
<p>6、前端将分块上传完毕请求媒资服务合并分块。</p>
<p>7、媒资服务判断分块上传完成则请求MinIO合并文件。</p>
<p>8、合并完成校验合并后的文件是否完整，如果不完整则删除文件。</p>
<h3 id="5-2-4-minio合并文件测试"><a href="#5-2-4-minio合并文件测试" class="headerlink" title="5.2.4 minio合并文件测试"></a><strong>5.2.4 minio合并文件测试</strong></h3><p>1、将分块文件上传至minio</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将分块文件上传至minio</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadChunk</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFolderPath</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\upload\\chunk\\&quot;</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkFolderPath);</span><br><span class="line">    <span class="comment">//分块文件</span></span><br><span class="line">    File[] files = chunkFolder.listFiles();</span><br><span class="line">    <span class="comment">//将分块文件上传至minio</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;chunk/&quot;</span> + i).filename(files[i].getAbsolutePath()).build();</span><br><span class="line">            minioClient.uploadObject(uploadObjectArgs);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传分块成功&quot;</span>+i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、通过minio的合并文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//合并文件，要求分块文件最小5M</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_merge</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(<span class="number">6</span>)</span><br><span class="line">            .map(i -&gt; ComposeSource.builder()</span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">                    .object(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i)))</span><br><span class="line">                    .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="type">ComposeObjectArgs</span> <span class="variable">composeObjectArgs</span> <span class="operator">=</span> ComposeObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;merge01.mp4&quot;</span>).sources(sources).build();</span><br><span class="line">    minioClient.composeObject(composeObjectArgs);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//清除分块文件</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_removeObjects</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//合并分块完成将分块文件清除</span></span><br><span class="line">    List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(<span class="number">6</span>)</span><br><span class="line">            .map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i))))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).objects(deleteObjects).build();</span><br><span class="line">    Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">    results.forEach(r-&gt;&#123;</span><br><span class="line">        <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deleteError = r.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>minio合并文件默认分块最小5M，我们将分块改为5M再次测试。</p>
<h2 id="5-3-接口定义"><a href="#5-3-接口定义" class="headerlink" title="5.3 接口定义"></a><strong>5.3</strong> <strong>接口定义</strong></h2><p>根据上传视频流程，定义接口，与前端的约定是操作成功返回{code:0}否则返回{code:-1}</p>
<p>从课程资料中拷贝RestResponse.java类到base工程下的model包下。</p>
<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfo;</span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件上传接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFilesController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;合并文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-4-上传分块开发"><a href="#5-4-上传分块开发" class="headerlink" title="5.4 上传分块开发"></a><strong>5.4</strong> <strong>上传分块开发</strong></h2><h3 id="5-4-1-DAO开发"><a href="#5-4-1-DAO开发" class="headerlink" title="5.4.1 DAO开发"></a><strong>5.4.1 DAO开发</strong></h3><p>向媒资数据库的文件表插入记录，使用自动生成的Mapper接口即可满足要求。</p>
<h3 id="5-4-2-Service开发"><a href="#5-4-2-Service开发" class="headerlink" title="5.4.2 Service开发"></a><strong>5.4.2 Service开发</strong></h3><h4 id="5-4-2-1-检查文件和分块"><a href="#5-4-2-1-检查文件和分块" class="headerlink" title="5.4.2.1 检查文件和分块"></a><strong>5.4.2.1</strong> <strong>检查文件和分块</strong></h4><p>接口完成进行接口实现，首先实现检查文件方法和检查分块方法。</p>
<p>在MediaFileService中定义service接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 检查文件是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:38</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 检查分块是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkIndex  分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:39</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span>;</span><br></pre></td></tr></table></figure>



<p>service接口实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="comment">//查询文件信息</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//桶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaFiles.getBucket();</span><br><span class="line">        <span class="comment">//存储目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaFiles.getFilePath();</span><br><span class="line">        <span class="comment">//文件流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = minioClient.getObject(</span><br><span class="line">                    GetObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket)</span><br><span class="line">                            .object(filePath)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//文件已存在</span></span><br><span class="line">                <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件不存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//得到分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunkIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件流</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileInputStream = minioClient.getObject(</span><br><span class="line">                GetObjectArgs.builder()</span><br><span class="line">                        .bucket(bucket_videoFiles)</span><br><span class="line">                        .object(chunkFilePath)</span><br><span class="line">                        .build());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//分块已存在</span></span><br><span class="line">            <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分块未存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到分块文件的目录</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getChunkFileFolderPath</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;chunk&quot;</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-4-2-2-上传分块"><a href="#5-4-2-2-上传分块" class="headerlink" title="5.4.2.2 上传分块"></a><strong>5.4.2.2</strong> <strong>上传分块</strong></h4><p>定义service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunk  分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bytes  文件字节</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:50</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5,<span class="type">int</span> chunk,<span class="type">byte</span>[] bytes)</span>;</span><br></pre></td></tr></table></figure>



<p>接口实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//得到分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//将文件存储至minIO</span></span><br><span class="line">    addMediaFilesToMinIO(bytes, bucket_videoFiles,chunkFilePath);</span><br><span class="line">     <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        log.debug(<span class="string">&quot;上传分块文件:&#123;&#125;,失败:&#123;&#125;&quot;</span>,chunkFilePath,e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>,<span class="string">&quot;上传分块失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-4-2-3-上传分块测试"><a href="#5-4-2-3-上传分块测试" class="headerlink" title="5.4.2.3 上传分块测试"></a><strong>5.4.2.3</strong> <strong>上传分块测试</strong></h4><p>完善接口层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkFile(fileMd5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkChunk(fileMd5,chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    <span class="comment">//上传的文件拷贝到临时文件</span></span><br><span class="line">    file.transferTo(tempFile);</span><br><span class="line">    <span class="comment">//文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.uploadChunk(fileMd5,chunk,absolutePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动前端工程，进入上传视频界面进行前后端联调测试。</p>
<p>前端对文件分块的大小为5MB，SpringBoot web默认上传文件的大小限制为1MB，这里需要在media-api工程修改配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">50MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">50MB</span></span><br></pre></td></tr></table></figure>

<p>max-file-size：单个文件的大小限制</p>
<p>Max-request-size: 单次请求的大小限制</p>
<h2 id="5-5-合并分块开发"><a href="#5-5-合并分块开发" class="headerlink" title="5.5 合并分块开发"></a><strong>5.5</strong> <strong>合并分块开发</strong></h2><h3 id="5-5-1-service开发"><a href="#5-5-1-service开发" class="headerlink" title="5.5.1 service开发"></a><strong>5.5.1 service开发</strong></h3><p>定义service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 合并分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块总和</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId,String fileMd5,<span class="type">int</span> chunkTotal,UploadFileParamsDto uploadFileParamsDto)</span>;</span><br></pre></td></tr></table></figure>

<p>service实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId, String fileMd5, <span class="type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;</span><br><span class="line">    <span class="comment">//=====获取分块文件路径=====</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//组成将分块文件路径组成 List&lt;ComposeSource&gt;</span></span><br><span class="line">    List&lt;ComposeSource&gt; sourceObjectList = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(chunkTotal)</span><br><span class="line">            .map(i -&gt; ComposeSource.builder()</span><br><span class="line">                    .bucket(bucket_videoFiles)</span><br><span class="line">                    .object(chunkFileFolderPath.concat(Integer.toString(i)))</span><br><span class="line">                    .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//=====合并=====</span></span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//合并文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mergeFilePath</span> <span class="operator">=</span> getFilePathByMd5(fileMd5, extName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//合并文件</span></span><br><span class="line">        <span class="type">ObjectWriteResponse</span> <span class="variable">response</span> <span class="operator">=</span> minioClient.composeObject(</span><br><span class="line">                ComposeObjectArgs.builder()</span><br><span class="line">                        .bucket(bucket_videoFiles)</span><br><span class="line">                        .object(mergeFilePath)</span><br><span class="line">                        .sources(sourceObjectList)</span><br><span class="line">                        .build());</span><br><span class="line">        log.debug(<span class="string">&quot;合并文件成功:&#123;&#125;&quot;</span>,mergeFilePath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;合并文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;&quot;</span>,fileMd5,e.getMessage(),e);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;合并文件失败。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ====验证md5====</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">minioFile</span> <span class="operator">=</span> downloadFileFromMinIO(bucket_videoFiles,mergeFilePath);</span><br><span class="line">    <span class="keyword">if</span>(minioFile == <span class="literal">null</span>)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;下载合并后文件失败,mergeFilePath:&#123;&#125;&quot;</span>,mergeFilePath);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;下载合并后文件失败。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">newFileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(minioFile)) &#123;</span><br><span class="line">        <span class="comment">//minio上文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Hex</span> <span class="operator">=</span> DigestUtils.md5Hex(newFileInputStream);</span><br><span class="line">        <span class="comment">//比较md5值，不一致则说明文件不完整</span></span><br><span class="line">        <span class="keyword">if</span>(!fileMd5.equals(md5Hex))&#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;文件合并校验失败，最终上传失败。&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件大小</span></span><br><span class="line">        uploadFileParamsDto.setFileSize(minioFile.length());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;校验文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;&quot;</span>,fileMd5,e.getMessage(),e);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;文件合并校验失败，最终上传失败。&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(minioFile!=<span class="literal">null</span>)&#123;</span><br><span class="line">           minioFile.delete();</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件入库</span></span><br><span class="line">    currentProxy.addMediaFilesToDb(companyId,fileMd5,uploadFileParamsDto,bucket_videoFiles,mergeFilePath);</span><br><span class="line">    <span class="comment">//=====清除分块文件=====</span></span><br><span class="line">    clearChunkFiles(chunkFileFolderPath,chunkTotal);</span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从minio下载文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 下载后的文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(String bucket,String objectName)</span>&#123;</span><br><span class="line">    <span class="comment">//临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">minioFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> minioClient.getObject(GetObjectArgs.builder()</span><br><span class="line">                .bucket(bucket)</span><br><span class="line">                .object(objectName)</span><br><span class="line">                .build());</span><br><span class="line">        <span class="comment">//创建临时文件</span></span><br><span class="line">        minioFile=File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;.merge&quot;</span>);</span><br><span class="line">        outputStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(minioFile);</span><br><span class="line">        IOUtils.copy(stream,outputStream);</span><br><span class="line">        <span class="keyword">return</span> minioFile;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(outputStream!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 得到合并后的文件的地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件id即md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileExt 文件扩展名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFilePathByMd5</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清除分块文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkFileFolderPath 分块文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块文件总数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearChunkFiles</span><span class="params">(String chunkFileFolderPath,<span class="type">int</span> chunkTotal)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">                .limit(chunkTotal)</span><br><span class="line">                .map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(chunkFileFolderPath.concat(Integer.toString(i))))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(<span class="string">&quot;video&quot;</span>).objects(deleteObjects).build();</span><br><span class="line">        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">        results.forEach(r-&gt;&#123;</span><br><span class="line">            <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                deleteError = r.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.error(<span class="string">&quot;清楚分块文件失败,objectname:&#123;&#125;&quot;</span>,deleteError.objectName(),e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;清楚分块文件失败,chunkFileFolderPath:&#123;&#125;&quot;</span>,chunkFileFolderPath,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-4-3-接口层完善"><a href="#5-4-3-接口层完善" class="headerlink" title="5.4.3 接口层完善"></a>5.4.3 接口层完善</h3><p>下边完善接口层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkFile(fileMd5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkChunk(fileMd5,chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mediaFileService.uploadChunk(fileMd5,chunk,file.getBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;合并文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001002&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setTags(<span class="string">&quot;课程视频&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setRemark(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setFilename(fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mediaFileService.mergechunks(companyId,fileMd5,chunkTotal,uploadFileParamsDto);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-2-合并分块测试"><a href="#5-5-2-合并分块测试" class="headerlink" title="5.5.2 合并分块测试"></a><strong>5.5.2</strong> <strong>合并分块测试</strong></h3><p>下边进行前后端联调：</p>
<p>1、上传一个视频测试合并分块的执行逻辑</p>
<p>进入service方法逐行跟踪。</p>
<p>2、断点续传测试</p>
<p>上传一部分后，停止刷新浏览器再重新上传，通过浏览器日志发现已经上传过的分块不再重新上传</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image018.gif" alt="img"></p>
<h2 id="5-6其它问题"><a href="#5-6其它问题" class="headerlink" title="5.6其它问题"></a><strong>5.6其它问题</strong></h2><h3 id="5-6-1-分块文件清理问题"><a href="#5-6-1-分块文件清理问题" class="headerlink" title="5.6.1 分块文件清理问题"></a><strong>5.6.1</strong> <strong>分块文件清理问题</strong></h3><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p>
<p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p>
<p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="【面试】什么情况下事务失效？"><a href="#【面试】什么情况下事务失效？" class="headerlink" title="【面试】什么情况下事务失效？"></a>【面试】什么情况下事务失效？</h1><ol>
<li>在方法中捕获异常没有抛出去</li>
<li>非事务方法调用事务方法</li>
<li>事务方法内部调用事务方法</li>
<li>@Transactional标记的方法不是public</li>
<li>抛出的异常与rollbackFor指定的异常不匹配，默认rollbackFor指定的异常为RuntimeException6）</li>
<li>数据库表不支持事务，比如MySQL的MyISAM</li>
</ol>
<ol start="7">
<li>Spring的传播行为导致事务失效，比如: PROPAGATION_NEVER、PROPAGATION_NOT_SUPPORTED</li>
</ol>
<p>  PROPAGATION_REQUIRED –支持当前事务，如果当前没有事务，就新建一个事务。这是最常见的选择。PROPAGATION_SUPPORTS –支持当前事务，如果当前没有事务，就以非事务方式执行。<br>  PROPAGATION_MANDATORY –支持当前事务，如果当前没有事务，就抛出异常。<br>  PROPAGATION_REQUIRES_NEW –新建事务，如果当前存在事务，把当前事务挂起。<br>  PROPAGATION_NOT_SUPPORTED –以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。PROPAGATION_NEVER –以非事务方式执行，如果当前存在事务，则抛出异常。<br>  PROPAGATION_NESTED –如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则与PROPAGATION_REQUIRED类似的操作。</p>
<h1 id="【面试】断点续传是怎么做的？"><a href="#【面试】断点续传是怎么做的？" class="headerlink" title="【面试】断点续传是怎么做的？"></a>【面试】断点续传是怎么做的？</h1><p>我们是基于分块上传的模式实现断点续传的需求，当文件上传一部分断网后前边已经上传过的不再上传。</p>
<p>1）前端对文件分块。<br>2）前端使用多线程一块一块上传，上传前给服务端发一个消息校验该分块是否上传，如果已上传则不再上传。<br>3）等所有分块上传完毕，服务端合并所有分块，校验文件的完整性。</p>
<p>因为分块全部上传到了服务器，服务器将所有分块按顺序进行合并，就是写每个分块文件内容按顺序依次写入一个文件中。使用字节流去读写文件。</p>
<p>4）前端给服务传了一个md5值，服务端合并文件后计算合并后文件的md5是否和前端传的一样，如果一样则说文件完整，如果不一样说明可能由于网络丢包导致文件不完整，这时上传失败需要重新上传。</p>
<h1 id="【面试】分块文件清理问题？"><a href="#【面试】分块文件清理问题？" class="headerlink" title="【面试】分块文件清理问题？"></a>【面试】分块文件清理问题？</h1><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗?怎么做的?</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。<br>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。<br>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="7-视频处理"><a href="#7-视频处理" class="headerlink" title="7 视频处理"></a><strong>7</strong> <strong>视频处理</strong></h1><h2 id="7-1-视频转码需求"><a href="#7-1-视频转码需求" class="headerlink" title="7.1 视频转码需求"></a><strong>7.1</strong> <strong>视频转码需求</strong></h2><h3 id="7-7-1-什么是视频编码"><a href="#7-7-1-什么是视频编码" class="headerlink" title="7.7.1 什么是视频编码"></a><strong>7.7.1</strong> <strong>什么是视频编码</strong></h3><p>视频上传成功后需要对视频进行转码处理。</p>
<p>什么是视频编码？查阅百度百科如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image002-17111724006691.gif" alt="img"></p>
<p>详情参考 ：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038">https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038</a></p>
<p>首先我们要分清文件格式和编码格式：</p>
<p>文件格式：是指.mp4、.avi、.rmvb等 这些不同扩展名的视频文件的文件格式 ，视频文件的内容主要包括视频和音频，其文件格式是按照一 定的编码格式去编码，并且按照该文件所规定的封装格式将视频、音频、字幕等信息封装在一起，播放器会根据它们的封装格式去提取出编码，然后由播放器解码，最终播放音视频。</p>
<p>音视频编码格式：通过音视频的压缩技术，将视频格式转换成另一种视频格式，通过视频编码实现流媒体的传输。比如：一个.avi的视频文件原来的编码是a，通过编码后编码格式变为b，音频原来为c，通过编码后变为d。</p>
<p>音视频编码格式各类繁多，主要有几下几类：</p>
<p>MPEG系列</p>
<p>（由ISO[国际标准组织机构]下属的MPEG[运动图象专家组]开发 ）视频编码方面主要是Mpeg1（vcd用的就是它）、Mpeg2（DVD使用）、Mpeg4（的DVDRIP使用的都是它的变种，如：divx，xvid等）、Mpeg4 AVC（正热门）；音频编码方面主要是MPEG Audio Layer 1&#x2F;2、MPEG Audio Layer 3（大名鼎鼎的mp3）、MPEG-2 AAC 、MPEG-4 AAC等等。注意：DVD音频没有采用Mpeg的。</p>
<p>H.26X系列</p>
<p>（由ITU[国际电传视讯联盟]主导，侧重网络传输，注意：只是视频编码）</p>
<p>包括H.261、H.262、H.263、H.263+、H.263++、H.264（就是MPEG4 AVC-合作的结晶）</p>
<p>目前最常用的编码标准是视频H.264，音频AAC。</p>
<p>提问：</p>
<p>H.264是编码格式还是文件格式？</p>
<p>mp4是编码格式还是文件格式？</p>
<h3 id="7-7-2-FFmpeg-的基本使用"><a href="#7-7-2-FFmpeg-的基本使用" class="headerlink" title="7.7.2 FFmpeg 的基本使用"></a><strong>7.7.2 FFmpeg</strong> <strong>的基本使用</strong></h3><p>我们将视频录制完成后，使用视频编码软件对视频进行编码，本项目 使用FFmpeg对视频进行编码 。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image004-17111724006692.gif" alt="img"></p>
<p>FFmpeg被许多开源项目采用，QQ影音、暴风影音、VLC等。</p>
<p>下载：FFmpeg <a target="_blank" rel="noopener" href="https://www.ffmpeg.org/download.html#build-windows">https://www.ffmpeg.org/download.html#build-windows</a></p>
<p>请从常用工具软件目录找到ffmpeg.exe，并将ffmpeg.exe加入环境变量path中。</p>
<p>测试是否正常：cmd运行 ffmpeg -version</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image006-17111724006693.gif" alt="img"></p>
<p>安装成功，作下简单测试</p>
<p>将一个.avi文件转成mp4、mp3、gif等。</p>
<p>比如我们将nacos.avi文件转成mp4，运行如下命令：</p>
<p>D:\soft\ffmpeg\ffmpeg.exe -i 1.avi 1.mp4</p>
<p>可以将ffmpeg.exe配置到环境变量path中，进入视频目录直接运行：ffmpeg.exe -i 1.avi 1.mp4</p>
<p>转成mp3：ffmpeg -i nacos.avi nacos.mp3</p>
<p>转成gif：ffmpeg -i nacos.avi nacos.gif</p>
<p>官方文档（英文）：<a target="_blank" rel="noopener" href="http://ffmpeg.org/ffmpeg.html">http://ffmpeg.org/ffmpeg.html</a></p>
<h3 id="7-7-3-视频处理工具类"><a href="#7-7-3-视频处理工具类" class="headerlink" title="7.7.3 视频处理工具类"></a><strong>7.7.3</strong> <strong>视频处理工具类</strong></h3><p>将课程资料的工具类中的util拷贝至base工程。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image008-17111724006705.gif" alt="img"></p>
<p>其中Mp4VideoUtil类是用于将视频转为mp4格式，是我们项目要使用的工具类。</p>
<p>下边看下这个类的代码，并进行测试。</p>
<p>我们要通过ffmpeg对视频转码，Java程序调用ffmpeg，使用java.lang.ProcessBuilder去完成，具体在Mp4VideoUtil类的63行，下边进行简单的测试，下边的代码运行本机安装的QQ软件。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line">builder.command(<span class="string">&quot;C:\\Program Files (x86)\\Tencent\\QQ\\Bin\\QQScLauncher.exe&quot;</span>);</span><br><span class="line"><span class="comment">//将标准输入流和错误输入流合并，通过标准输入流程读取信息</span></span><br><span class="line">builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> builder.start();</span><br></pre></td></tr></table></figure>

<p>对Mp4VideoUtil类需要学习使用方法，下边代码将一个avi视频转为mp4视频，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//ffmpeg的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ffmpeg_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\soft\\ffmpeg\\ffmpeg.exe&quot;</span>;<span class="comment">//ffmpeg的安装位置</span></span><br><span class="line">    <span class="comment">//源avi视频的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">video_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.avi&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_name</span> <span class="operator">=</span> <span class="string">&quot;nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//创建工具类对象</span></span><br><span class="line">    <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpeg_path,video_path,mp4_name,mp4_path);</span><br><span class="line">    <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> videoUtil.generateMp4();</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行main方法，最终在控制台输出 success 表示执行成功。</p>
<h2 id="7-2-分布式任务处理"><a href="#7-2-分布式任务处理" class="headerlink" title="7.2 分布式任务处理"></a><strong>7.2</strong> <strong>分布式任务处理</strong></h2><h3 id="7-2-1-什么是分布式任务调度"><a href="#7-2-1-什么是分布式任务调度" class="headerlink" title="7.2.1 什么是分布式任务调度"></a><strong>7.2.1</strong> <strong>什么是分布式任务调度</strong></h3><p>对一个视频的转码可以理解为一个任务的执行，如果视频的数量比较多，如何去高效处理一批任务呢？</p>
<p>1、多线程</p>
<p>多线程是充分利用单机的资源。</p>
<p>2、分布式加多线程</p>
<p>充分利用多台计算机，每台计算机使用多线程处理。</p>
<p>方案2可扩展性更强。</p>
<p>方案2是一种分布式任务调度的处理方案。</p>
<p>什么是分布式任务调度？</p>
<p>我们可以先思考一下下面业务场景的解决方案：</p>
<p>​    每隔24小时执行数据备份任务。</p>
<p>​    12306网站会根据车次不同，设置几个时间点分批次放票。</p>
<p>​    某财务系统需要在每天上午10点前结算前一天的账单数据，统计汇总。</p>
<p>​    商品成功发货后，需要向客户发送短信提醒。</p>
<p>类似的场景还有很多，我们该如何实现？</p>
<p><strong>多线程方式实现：</strong></p>
<p>学过多线程的同学，可能会想到，我们可以开启一个线程，每sleep一段时间，就去检查是否已到预期执行时间。</p>
<p>以下代码简单实现了任务调度的功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;    </span><br><span class="line">    <span class="comment">//任务执行间隔时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeInterval</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//TODO：something</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(timeInterval);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码实现了按一定的间隔时间执行任务调度的功能。</p>
<p>Jdk也为我们提供了相关支持，如Timer、ScheduledExecutor，下边我们了解下。</p>
<p><strong>Timer方式实现</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();  </span><br><span class="line">    timer.schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">           <span class="comment">//TODO：something</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;, <span class="number">1000</span>, <span class="number">2000</span>);  <span class="comment">//1秒后开始调度，每2秒执行一次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        Timer 的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行。</p>
<p><strong>ScheduledExecutor方式实现</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span>&#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    service.scheduleAtFixedRate(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">//TODO：something</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1</span>,</span><br><span class="line">            <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    Java 5 推出了基于线程池设计的 ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰。</p>
<p>​    Timer 和 ScheduledExecutor 都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每月第一天凌晨1点执行任务、复杂调度任务的管理、任务间传递数据等等。</p>
<p><strong>第三方Quartz方式实现，项目地址：<a target="_blank" rel="noopener" href="https://github.com/quartz-scheduler/quartz">https://github.com/quartz-scheduler/quartz</a></strong>  </p>
<p>​    Quartz 是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz 设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job 负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler 将二者组装在一起，并触发任务开始执行。Quartz支持简单的按时间间隔调度、还支持按日历调度方式，通过设置CronTrigger表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p>
<p>下边是一个例子代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span> <span class="keyword">throws</span> SchedulerException &#123;</span><br><span class="line">    <span class="comment">//创建一个Scheduler</span></span><br><span class="line">    <span class="type">SchedulerFactory</span> <span class="variable">schedulerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdSchedulerFactory</span>();</span><br><span class="line">    <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactory.getScheduler();</span><br><span class="line">    <span class="comment">//创建JobDetail</span></span><br><span class="line">    <span class="type">JobBuilder</span> <span class="variable">jobDetailBuilder</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class);</span><br><span class="line">    jobDetailBuilder.withIdentity(<span class="string">&quot;jobName&quot;</span>,<span class="string">&quot;jobGroupName&quot;</span>);</span><br><span class="line">    <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> jobDetailBuilder.build();</span><br><span class="line">    <span class="comment">//创建触发的CronTrigger 支持按日历调度</span></span><br><span class="line">        <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(<span class="string">&quot;triggerName&quot;</span>, <span class="string">&quot;triggerGroupName&quot;</span>)</span><br><span class="line">                .startNow()</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">&quot;0/2 * * * * ?&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">    scheduler.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过以上内容我们学习了什么是任务调度，任务调度所解决的问题，以及任务调度的多种实现方式。</p>
<p><strong>任务调度顾名思义，就是对任务的调度，它是指系统为了完成特定业务，基于给定时间点，给定时间间隔或者给定执行次数自动执行任务。</strong></p>
<p><strong>什么是分布式任务调度？</strong></p>
<p>​    通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>，如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image010-17111724006704.gif" alt="img"></p>
<p><strong>分布式调度要实现的目标：</strong></p>
<p>​    不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p>
<p>1、并行任务调度</p>
<p>​    并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p>
<p>​    如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p>
<p>2、高可用</p>
<p>​    若某一个实例宕机，不影响其他实例来执行任务。</p>
<p>3、弹性扩容</p>
<p>​    当集群中增加实例就可以提高并执行任务的处理效率。</p>
<p>4、任务管理与监测</p>
<p>​    对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p>
<p>5、避免任务重复执行</p>
<p>​    当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p>
<h3 id="7-2-2-XXL-JOB介绍"><a href="#7-2-2-XXL-JOB介绍" class="headerlink" title="7.2.2 XXL-JOB介绍"></a><strong>7.2.2 XXL-JOB介绍</strong></h3><p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B">https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</a></p>
<p>XXL-JOB主要有调度中 心、执行器、任务：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image012-17111724006706.gif" alt="img"></p>
<p><strong>调度中心：</strong></p>
<p>​    负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p>
<p>​    主要职责为执行器管理、任务管理、监控运维、日志管理等</p>
<p><strong>任务执行器：</strong></p>
<p>​    负责接收调度请求并执行任务逻辑；</p>
<p>​    只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p>
<p><strong>任务：</strong>负责执行具体的业务处理。</p>
<p>调度中心与执行器之间的工作流程如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image014-17111724006707.gif" alt="img"></p>
<p><strong>执行流程：</strong></p>
<p>​    1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p>
<p>​    2.达到任务触发条件，调度中心下发任务</p>
<p>​    3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p>
<p>​    4.执行器消费内存队列中的执行结果，主动上报给调度中心</p>
<p>​    5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p>
<h3 id="7-2-3-搭建XXL-JOB"><a href="#7-2-3-搭建XXL-JOB" class="headerlink" title="7.2.3 搭建XXL-JOB"></a><strong>7.2.3</strong> <strong>搭建XXL-JOB</strong></h3><h4 id="7-2-3-1-调度中心"><a href="#7-2-3-1-调度中心" class="headerlink" title="7.2.3.1 调度中心"></a><strong>7.2.3.1</strong> <strong>调度中心</strong></h4><p>首先下载XXL-JOB</p>
<p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></p>
<p>码云：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></p>
<p>项目使用2.3.1版本： <a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></p>
<p>也可从课程资料目录获取，解压xxl-job-2.3.1.zip</p>
<p>使用IDEA打开解压后的目录</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image016-17111724006708.gif" alt="img"></p>
<p>xxl-job-admin：调度中心</p>
<p>xxl-job-core：公共依赖</p>
<p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p>
<p>  ：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p>
<p>  ：xxl-job-executor-sample-frameless：无框架版本；</p>
<p>doc :文档资料，包含数据库脚本</p>
<p>在下发的虚拟机的MySQL中已经创建了xxl_job_2.3.1数据库</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image018-17111724006709.gif" alt="img"></p>
<p>如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image020.gif" alt="img"></p>
<p>执行sh &#x2F;data&#x2F;soft&#x2F;restart.sh自动启动xxl-job调度中心</p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8088/xxl-job-admin/">http://192.168.101.65:8088/xxl-job-admin/</a></p>
<p>账号和密码：admin&#x2F;123456</p>
<p>如果无法使用虚拟机运行xxl-job可以在本机idea运行xxl-job调度中心。</p>
<h4 id="7-2-3-2-执行器"><a href="#7-2-3-2-执行器" class="headerlink" title="7.2.3.2 执行器"></a><strong>7.2.3.2</strong> <strong>执行器</strong></h4><p>下边配置执行器，执行器负责与调度中心通信接收调度中心发起的任务调度请求。</p>
<p>1、下边进入调度中心添加执行器</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image022.gif" alt="img"></p>
<p>点击新增，填写执行器信息，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image024.gif" alt="img"></p>
<p>添加成功：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image026.gif" alt="img"></p>
<p>2、首先在媒资管理模块的service工程添加依赖，在项目的父工程已约定了版本2.3.1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、在nacos下的media-service-dev.yaml下配置xxl-job</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">media-process-service</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>

<p>注意配置中的appname这是执行器的应用名，port是执行器启动的端口，如果本地启动多个执行器注意端口不能重复。</p>
<p>4、配置xxl-job的执行器</p>
<p>将xxl-job示例工程下配置类拷贝到媒资管理的service工程下</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image028.gif" alt="img"></p>
<p>拷贝至：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image030.gif" alt="img"></p>
<p>到此完成媒资管理模块service工程配置xxl-job执行器，在xxl-job调度中心添加执行器，下边准备测试执行器与调度中心是否正常通信，因为接口工程依赖了service工程，所以启动媒资管理模块的接口工程。</p>
<p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image032.gif" alt="img"></p>
<p>同时观察调度中心中的执行器界面</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image034.gif" alt="img"></p>
<p>在线机器地址处已显示1个执行器。</p>
<h4 id="7-2-3-3-执行任务"><a href="#7-2-3-3-执行任务" class="headerlink" title="7.2.3.3 执行任务"></a><strong>7.2.3.3</strong> <strong>执行任务</strong></h4><p>下边编写任务，参考示例工程中任务类的编写方法，如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image036.gif" alt="img"></p>
<p>在媒资服务service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试执行器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 20:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Component</span></span><br><span class="line"> <span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleJob</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@XxlJob(&quot;testJob&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  log.info(<span class="string">&quot;开始执行.....&quot;</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下边在调度中心添加任务，进入任务管理</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image038.gif" alt="img"></p>
<p>点击新增，填写任务信息</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image040.gif" alt="img"></p>
<p>注意红色标记处：</p>
<p>调度类型：</p>
<p>固定速度指按固定的间隔定时调度。</p>
<p>Cron，通过Cron表达式实现更丰富的定时调度策略。</p>
<p>Cron表达式是一个字符串，通过它可以定义调度策略，格式如下：</p>
<p>{秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)}</p>
<p>xxl-job提供图形界面去配置：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image042.gif" alt="img"></p>
<p>一些例子如下：</p>
<p>30 10 1 * * ? 每天1点10分30秒触发</p>
<p>0&#x2F;30 * * * * ? 每30秒触发一次</p>
<p>* 0&#x2F;10 * * * ? 每10分钟触发一次</p>
<p>运行模式有BEAN和GLUE，bean模式较常用就是在项目工程中编写执行器的任务代码，GLUE是将任务代码编写在调度中心。</p>
<p>JobHandler即任务方法名，填写任务方法上边@XxlJob注解中的名称。</p>
<p>路由策略：当执行器集群部署时，调度中心向哪个执行器下发任务，这里选择第一个表示只向第一个执行器下发任务，路由策略的其它选项稍后在分片广播章节详细解释。</p>
<p>高级配置的其它配置项稍后在分片广播章节详细解释。</p>
<p>添加成功，启动任务</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image044.gif" alt="img"></p>
<p>通过调度日志查看任务执行情况</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image046.gif" alt="img"></p>
<p>下边启动媒资管理的service工程，启动执行器。</p>
<p>观察执行器方法的执行。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image048.gif" alt="img"></p>
<p>如果要停止任务需要在调度中心操作</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image050.gif" alt="img"></p>
<p>任务跑一段时间注意清理日志</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image052.gif" alt="img"></p>
<h3 id="7-2-4-分片广播"><a href="#7-2-4-分片广播" class="headerlink" title="7.2.4 分片广播"></a><strong>7.2.4</strong> <strong>分片广播</strong></h3><p>掌握了xxl-job的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image054.gif" alt="img"></p>
<p>执行器在集群部署下调度中心有哪些路由策略呢？</p>
<p>查看xxl-job官方文档，阅读高级配置相关的内容：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">高级配置：</span><br><span class="line">    <span class="operator">-</span> 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；</span><br><span class="line">        <span class="keyword">FIRST</span>（第一个）：固定选择第一个机器；</span><br><span class="line">        <span class="keyword">LAST</span>（最后一个）：固定选择最后一个机器；</span><br><span class="line">        ROUND（轮询）：；</span><br><span class="line">        RANDOM（随机）：随机选择在线的机器；</span><br><span class="line">        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span><br><span class="line">        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span><br><span class="line">        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span><br><span class="line">        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span><br><span class="line"></span><br><span class="line">    <span class="operator">-</span> 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。</span><br><span class="line">    <span class="operator">-</span> 调度过期策略：</span><br><span class="line">        <span class="operator">-</span> 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</span><br><span class="line">        <span class="operator">-</span> 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</span><br><span class="line">    <span class="operator">-</span> 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</span><br><span class="line">        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span><br><span class="line">        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span><br><span class="line">        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span><br><span class="line">    <span class="operator">-</span> 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span><br><span class="line">    <span class="operator">-</span> 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br></pre></td></tr></table></figure>

<p>下边要重点说的是分片广播策略，分片是指是调度中心以执行器为维度进行分片，将集群中的执行器标上序号：0，1，2，3…，广播是指每次调度会向集群中的所有执行器发送任务调度，请求中携带分片参数。</p>
<p>如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image056.gif" alt="img"></p>
<p>每个执行器收到调度请求同时接收分片参数。</p>
<p>xxl-job支持动态扩容执行器集群从而动态增加分片数量，当有任务量增加可以部署更多的执行器到集群中，调度中心会动态修改分片的数量。</p>
<p><strong>作业分片适用哪些场景呢？</strong></p>
<p>•     分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p>
<p>•     广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p>
<p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p>
<p><strong>使用说明：</strong></p>
<p>“分片广播” 和普通任务开发流程一致，不同之处在于可以获取分片参数进行分片业务处理。</p>
<p>Java语言任务获取分片参数方式：</p>
<p>BEAN、GLUE模式(Java)，可参考Sample示例执行器中的示例任务”ShardingJobHandler”：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2、分片广播任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 分片序号，从0开始</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="comment">// 分片总数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>



<p>下边测试作业分片：</p>
<p>1、定义作业分片的任务方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 2、分片广播任务</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分片参数</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">  <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;分片参数：当前分片序号 = &#123;&#125;, 总分片数 = &#123;&#125;&quot;</span>, shardIndex, shardTotal);</span><br><span class="line">log.info(<span class="string">&quot;开始执行第&quot;</span>+shardIndex+<span class="string">&quot;批任务&quot;</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>2、在调度中心添加任务</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image058.gif" alt="img"></p>
<p>添加成功：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image060.gif" alt="img"></p>
<p>启动任务，观察日志</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image062.gif" alt="img"></p>
<p>下边启动两个执行器实例，观察每个实例的执行情况</p>
<p>首先在nacos中配置media-service的本地优先配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>将media-service启动两个实例</p>
<p>两个实例的在启动时注意端口不能冲突：</p>
<p>实例1 在VM options处添加：-Dserver.port&#x3D;63051 -Dxxl.job.executor.port&#x3D;9998</p>
<p>实例2 在VM options处添加：-Dserver.port&#x3D;63050 -Dxxl.job.executor.port&#x3D;9999</p>
<p>例如：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image064.gif" alt="img"></p>
<p>启动两个实例</p>
<p>观察任务调度中心，稍等片刻执行器有两个</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image066.gif" alt="img"></p>
<p>观察两个执行实例的日志：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image068.gif" alt="img"></p>
<p>另一实例的日志如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image070.gif" alt="img"></p>
<p>从日志可以看每个实例的分片序号不同。</p>
<p>如果其中一个执行器挂掉，只剩下一个执行器在工作，稍等片刻调用中心发现少了一个执行器将动态调整总分片数为1。</p>
<p>到此作业分片任务调试完成，此时我们可以思考：</p>
<p>当一次分片广播到来，各执行器如何根据分片参数去分布式执行任务，保证执行器之间执行的任务不重复呢？</p>
<h2 id="7-3-技术方案"><a href="#7-3-技术方案" class="headerlink" title="7.3 技术方案"></a><strong>7.3</strong> <strong>技术方案</strong></h2><h3 id="7-3-1-作业分片方案"><a href="#7-3-1-作业分片方案" class="headerlink" title="7.3.1 作业分片方案"></a><strong>7.3.1</strong> <strong>作业分片方案</strong></h3><p>掌握了xxl-job的分片广播调度方式，下边思考如何分布式去执行学成在线平台中的视频处理任务。</p>
<p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，此时如何保证多个执行器不会查询到重复的任务呢？</p>
<p>XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号，在向执行器任务调度的同时下发分片总数以及分片序号等参数，执行器收到这些参数根据自己的业务需求去利用这些参数。</p>
<p>下图表示了多个执行器获取视频处理任务的结构：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image072.gif" alt="img"></p>
<p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务。</p>
<p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p>
<p>1 % 2 &#x3D; 1  执行器2执行</p>
<p>2 % 2 &#x3D; 0  执行器1执行</p>
<p>3 % 2 &#x3D; 1   执行器2执行</p>
<p>以此类推.</p>
<h3 id="7-3-2-保证任务不重复执行"><a href="#7-3-2-保证任务不重复执行" class="headerlink" title="7.3.2 保证任务不重复执行"></a><strong>7.3.2</strong> <strong>保证任务不重复执行</strong></h3><p>通过作业分片方案保证了执行器之间查询到不重复的任务，如果一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</p>
<p>首先配置调度过期策略：</p>
<p>查看文档如下：</p>
<p>  - 调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；<br>     - 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；<br>     - 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；<br>   - 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p>
<p>这里我们选择忽略，如果立即执行一次就可能重复执行相同的任务。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image074.gif" alt="img"></p>
<p>其次，再看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束时调度中心进行任务调度，此时该如何处理。</p>
<p>查看文档如下：<br>     单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；<br>     丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；<br>     覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p>
<p>这里如果选择覆盖之前调度则可能重复执行任务，这里选择 丢弃后续调度或单机串行方式来避免任务重复执行。</p>
<p>只做这些配置可以保证任务不会重复执行吗？</p>
<p>做不到，还需要保证任务处理的幂等性，什么是任务的幂等性？任务的幂等性是指：对于数据的操作不论多少次，操作的结果始终是一致的。在本项目中要实现的是不论多少次任务调度同一个视频只执行一次成功的转码。</p>
<p>什么是幂等性？</p>
<p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p>
<p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p>
<p>解决幂等性常用的方案：</p>
<p>1）数据库约束，比如：唯一索引，主键。</p>
<p>2）乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p>
<p>3）唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p>
<p>基于以上分析，在执行器接收调度请求去执行视频处理任务时要实现视频处理的幂等性，要有办法去判断该视频是否处理完成，如果正在处理中或处理完则不再处理。这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p>
<h3 id="7-3-3-视频处理方案"><a href="#7-3-3-视频处理方案" class="headerlink" title="7.3.3 视频处理方案"></a><strong>7.3.3</strong> <strong>视频处理方案</strong></h3><p>确定了分片方案，下边梳理整个视频上传及处理的业务流程。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image076.gif" alt="img"></p>
<p>上传视频成功向视频处理待处理表添加记录。</p>
<p>视频处理的详细流程如下：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image078.gif" alt="img"></p>
<p>1、任务调度中心广播作业分片。</p>
<p>2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p>
<p>3、执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。</p>
<p>4、执行器启动多线程去处理任务。</p>
<p>5、任务处理完成，上传处理后的视频到MinIO。</p>
<p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p>
<h2 id="7-4-查询待处理任务"><a href="#7-4-查询待处理任务" class="headerlink" title="7.4 查询待处理任务"></a><strong>7.4</strong> <strong>查询待处理任务</strong></h2><h3 id="7-4-1-需求分析"><a href="#7-4-1-需求分析" class="headerlink" title="7.4.1 需求分析"></a><strong>7.4.1</strong> <strong>需求分析</strong></h3><p>查询待处理任务只处理未提交及处理失败的任务，任务处理失败后进行重试，最多重试3次。</p>
<p>任务处理成功将待处理记录移动到历史任务表。</p>
<p>下图是待处理任务表：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image080.gif" alt="img"></p>
<p>历史任务表与待处理任务表的结构相同。</p>
<h3 id="7-4-2添加待处理任务"><a href="#7-4-2添加待处理任务" class="headerlink" title="7.4.2添加待处理任务"></a><strong>7.4.2添加待处理任务</strong></h3><p>上传视频成功向视频处理待处理表添加记录，暂时只添加对avi视频的处理记录。</p>
<p>根据MIME Type去判断是否是avi视频，下边列出部分MIME Type</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image082.gif" alt="img"></p>
<p>avi视频的MIME Type是video&#x2F;x-msvideo</p>
<p>修改文件信息入库方法，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="comment">//从数据库查询文件</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        <span class="comment">//媒体类型</span></span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>, mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加到待处理任务表</span></span><br><span class="line">        addWaitingTask(mediaFiles);</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>, mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加待处理任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaFiles 媒资文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWaitingTask</span><span class="params">(MediaFiles mediaFiles)</span>&#123;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaFiles.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">exension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//文件mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(exension);</span><br><span class="line">    <span class="comment">//如果是avi视频添加到视频待处理表</span></span><br><span class="line">    <span class="keyword">if</span>(mimeType.equals(<span class="string">&quot;video/x-msvideo&quot;</span>))&#123;</span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">        BeanUtils.copyProperties(mediaFiles,mediaProcess);</span><br><span class="line">        mediaProcess.setStatus(<span class="string">&quot;1&quot;</span>);<span class="comment">//未处理</span></span><br><span class="line">        mediaProcess.setFailCount(<span class="number">0</span>);<span class="comment">//失败次数默认为0</span></span><br><span class="line">        mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-4-3-查询待处理任务"><a href="#7-4-3-查询待处理任务" class="headerlink" title="7.4.3 查询待处理任务"></a><strong>7.4.3</strong> <strong>查询待处理任务</strong></h3><p>如何保证查询到的待处理视频记录不重复？</p>
<p>编写根据分片参数获取待处理任务的DAO方法，定义DAO接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据分片参数获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal  分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardindex  分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 任务数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt; </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/14 8:54</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from media_process t where t.id % #&#123;shardTotal&#125; = #&#123;shardIndex&#125; and (t.status = &#x27;1&#x27; or t.status = &#x27;3&#x27;) and t.fail_count &lt; 3 limit #&#123;count&#125;&quot;)</span></span><br><span class="line">    List&lt;MediaProcess&gt; <span class="title function_">selectListByShardIndex</span><span class="params">(<span class="meta">@Param(&quot;shardTotal&quot;)</span> <span class="type">int</span> shardTotal,<span class="meta">@Param(&quot;shardIndex&quot;)</span> <span class="type">int</span> shardIndex,<span class="meta">@Param(&quot;count&quot;)</span> <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义Service接口，查询待处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件处理业务方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/10 8:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 获取记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/14 14:49</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex,<span class="type">int</span> shardTotal,<span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileProcessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">  List&lt;MediaProcess&gt; mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">   <span class="keyword">return</span> mediaProcesses;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="7-5-开始执行任务"><a href="#7-5-开始执行任务" class="headerlink" title="7.5 开始执行任务"></a><strong>7.5</strong> <strong>开始执行任务</strong></h2><h3 id="7-5-1-分布式锁"><a href="#7-5-1-分布式锁" class="headerlink" title="7.5.1 分布式锁"></a><strong>7.5.1</strong> <strong>分布式锁</strong></h3><p>为了避免多线程去争抢同一个任务可以使用synchronized同步锁去解决，如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(锁对象)&#123;</span><br><span class="line">   执行任务...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>synchronized只能保证同一个虚拟机中多个线程去争抢锁。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image084.gif" alt="img"></p>
<p>如果是多个执行器分布式部署，并不能保证同一个视频只有一个执行器去处理。</p>
<p>现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image086.gif" alt="img"></p>
<p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务。</p>
<p>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫分布式锁。</p>
<p>实现分布式锁的方案有很多，常用的如下：</p>
<p>1、基于数据库实现分布锁</p>
<p>利用数据库主键唯一性的特点，或利用数据库唯一索引、行级锁的特点，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p>
<p>2、基于redis实现锁</p>
<p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。</p>
<p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p>
<p>3、使用zookeeper实现</p>
<p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p>
<h3 id="7-5-2-开启任务"><a href="#7-5-2-开启任务" class="headerlink" title="7.5.2 开启任务"></a><strong>7.5.2</strong> <strong>开启任务</strong></h3><p>下边基于数据库方式实现分布锁，开始执行任务将任务执行状态更新为4表示任务执行中。</p>
<p>下边的sql语句可以实现更新操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update media_process m set m.status=<span class="string">&#x27;4&#x27;</span> where  m.id=?</span><br></pre></td></tr></table></figure>



<p>如果是多个线程去执行该sql都将会执行成功，但需求是只能有一个线程抢到锁，所以此sql无法满足需求。</p>
<p>下边使用乐观锁的方式实现更新操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update media_process m set m.status=<span class="string">&#x27;4&#x27;</span> where (m.status=<span class="string">&#x27;1&#x27;</span> or m.status=<span class="string">&#x27;3&#x27;</span>) and m.fail_count&lt;<span class="number">3</span> and m.id=?</span><br></pre></td></tr></table></figure>

<p>多个线程同时执行上边的sql只会有一个线程执行成功。</p>
<p>什么是乐观锁、悲观锁？</p>
<p>synchronized是一种悲观锁，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以要悲观锁。</p>
<p>乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。</p>
<p>实现如下：</p>
<p>1、定义mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启一个任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 任务id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 更新记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update(&quot;update media_process m set m.status=&#x27;4&#x27; where (m.status=&#x27;1&#x27; or m.status=&#x27;3&#x27;) and m.fail_count&lt;3 and m.id=#&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">startTask</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、service方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  开启一个任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 任务id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true开启任务成功，false开启任务失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startTask</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现如下</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startTask</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> mediaProcessMapper.startTask(id);</span><br><span class="line">    <span class="keyword">return</span> result&lt;=<span class="number">0</span>?<span class="literal">false</span>:<span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-6-更新任务状态"><a href="#7-6-更新任务状态" class="headerlink" title="7.6 更新任务状态"></a><strong>7.6</strong> <strong>更新任务状态</strong></h2><p>任务处理完成需要更新任务处理结果，任务执行成功更新视频的URL、及任务处理结果，将待处理任务记录删除，同时向历史任务表添加记录。</p>
<p>在MediaFileProcessService接口添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存任务结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> taskId  任务id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status 任务状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileId  文件id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> errorMsg 错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/15 11:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(Long taskId,String status,String fileId,String url,String errorMsg)</span>;</span><br></pre></td></tr></table></figure>

<p>service接口方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileProcessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> MediaProcessHistoryMapper mediaProcessHistoryMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;</span><br><span class="line">    <span class="comment">//查出任务，如果不存在则直接返回</span></span><br><span class="line">    <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> mediaProcessMapper.selectById(taskId);</span><br><span class="line">    <span class="keyword">if</span>(mediaProcess == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理失败，更新任务处理结果</span></span><br><span class="line">    LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapperById = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;MediaProcess&gt;().eq(MediaProcess::getId, taskId);</span><br><span class="line">    <span class="comment">//处理失败</span></span><br><span class="line">    <span class="keyword">if</span>(status.equals(<span class="string">&quot;3&quot;</span>))&#123;</span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">        mediaProcess_u.setStatus(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        mediaProcess_u.setErrormsg(errorMsg);</span><br><span class="line">        mediaProcess_u.setFailCount(mediaProcess.getFailCount()+<span class="number">1</span>);</span><br><span class="line">        mediaProcessMapper.update(mediaProcess_u,queryWrapperById);</span><br><span class="line">        log.debug(<span class="string">&quot;更新任务处理状态为失败，任务信息:&#123;&#125;&quot;</span>,mediaProcess_u);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//任务处理成功</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileId);</span><br><span class="line">    <span class="keyword">if</span>(mediaFiles!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//更新媒资文件中的访问url</span></span><br><span class="line">        mediaFiles.setUrl(url);</span><br><span class="line">        mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理成功，更新url和状态</span></span><br><span class="line">    mediaProcess.setUrl(url);</span><br><span class="line">    mediaProcess.setStatus(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    mediaProcess.setFinishDate(LocalDateTime.now());</span><br><span class="line">    mediaProcessMapper.updateById(mediaProcess);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加到历史记录</span></span><br><span class="line">    <span class="type">MediaProcessHistory</span> <span class="variable">mediaProcessHistory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcessHistory</span>();</span><br><span class="line">    BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);</span><br><span class="line">    mediaProcessHistoryMapper.insert(mediaProcessHistory);</span><br><span class="line">    <span class="comment">//删除mediaProcess</span></span><br><span class="line">    mediaProcessMapper.deleteById(mediaProcess.getId());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">  List&lt;MediaProcess&gt; mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">   <span class="keyword">return</span> mediaProcesses;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-7-视频处理"><a href="#7-7-视频处理" class="headerlink" title="7.7 视频处理"></a><strong>7.7</strong> <strong>视频处理</strong></h2><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p>
<p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p>
<p>定义任务类VideoTask 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.jobhander;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.utils.Mp4VideoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileService;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/15 11:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileService mediaFileService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileProcessService mediaFileProcessService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;videoprocess.ffmpegpath&#125;&quot;)</span></span><br><span class="line">    String ffmpegpath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;videoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">videoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">    List&lt;MediaProcess&gt; mediaProcessList = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//取出cpu核心数作为一次处理数据的条数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="comment">//一次处理视频数量不要超过cpu核心数</span></span><br><span class="line">        mediaProcessList = mediaFileProcessService.getMediaProcessList(shardIndex, shardTotal, processors);</span><br><span class="line">        size = mediaProcessList.size();</span><br><span class="line">        log.debug(<span class="string">&quot;取出待处理视频任务&#123;&#125;条&quot;</span>, size);</span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//启动size个线程的线程池</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">    <span class="comment">//计数器</span></span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">    <span class="comment">//将处理任务加入线程池</span></span><br><span class="line">    mediaProcessList.forEach(mediaProcess -&gt; &#123;</span><br><span class="line">        threadPool.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//任务id</span></span><br><span class="line">                <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> mediaProcess.getId();</span><br><span class="line">                <span class="comment">//抢占任务</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> mediaFileProcessService.startTask(taskId);</span><br><span class="line">                <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;开始执行任务:&#123;&#125;&quot;</span>, mediaProcess);</span><br><span class="line">                <span class="comment">//下边是处理逻辑</span></span><br><span class="line">                <span class="comment">//桶</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaProcess.getBucket();</span><br><span class="line">                <span class="comment">//存储路径</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaProcess.getFilePath();</span><br><span class="line">                <span class="comment">//原始视频的md5值</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> mediaProcess.getFileId();</span><br><span class="line">                <span class="comment">//原始文件名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaProcess.getFilename();</span><br><span class="line">                <span class="comment">//将要处理的文件下载到服务器上</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">originalFile</span> <span class="operator">=</span> mediaFileService.downloadFileFromMinIO(mediaProcess.getBucket(), mediaProcess.getFilePath());</span><br><span class="line">                <span class="keyword">if</span> (originalFile == <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;下载待处理文件失败,originalFile:&#123;&#125;&quot;</span>, mediaProcess.getBucket().concat(mediaProcess.getFilePath()));</span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;下载待处理文件失败&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//处理结束的视频文件</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">mp4File</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mp4File = File.createTempFile(<span class="string">&quot;mp4&quot;</span>, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;创建mp4临时文件失败&quot;</span>);</span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;创建mp4临时文件失败&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//视频处理结果</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//开始处理视频</span></span><br><span class="line">                    <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpegpath, originalFile.getAbsolutePath(), mp4File.getName(), mp4File.getAbsolutePath());</span><br><span class="line">                    <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">                    result = videoUtil.generateMp4();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    log.error(<span class="string">&quot;处理视频文件:&#123;&#125;,出错:&#123;&#125;&quot;</span>, mediaProcess.getFilePath(), e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!result.equals(<span class="string">&quot;success&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">//记录错误信息</span></span><br><span class="line">                    log.error(<span class="string">&quot;处理视频失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>, bucket + filePath, result);</span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, result);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">//将mp4上传至minio</span></span><br><span class="line">                <span class="comment">//mp4在minio的存储路径</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> getFilePath(fileId, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                <span class="comment">//访问url</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), <span class="string">&quot;video/mp4&quot;</span>, bucket, objectName);</span><br><span class="line">                    <span class="comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span></span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;2&quot;</span>, fileId, url, <span class="literal">null</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;上传视频失败或入库失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>, bucket + objectName, e.getMessage());</span><br><span class="line">                    <span class="comment">//最终还是失败了</span></span><br><span class="line">                    mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;处理后视频上传或入库失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">    countDownLatch.await(<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFilePath</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-8-测试"><a href="#7-8-测试" class="headerlink" title="7.8 测试"></a><strong>7.8</strong> <strong>测试</strong></h2><h3 id="7-8-1-基本测试"><a href="#7-8-1-基本测试" class="headerlink" title="7.8.1 基本测试"></a><strong>7.8.1</strong> <strong>基本测试</strong></h3><p>进入xxl-job调度中心添加执行器和视频处理任务</p>
<p>在xxl-job配置任务调度策略：</p>
<p>1）配置阻塞处理策略为：丢弃后续调度。</p>
<p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢弃调度请求。</p>
<p>配置完成开始测试视频处理：</p>
<p>1、首先上传至少4个视频，非mp4格式。</p>
<p>2、在xxl-job启动视频处理任务</p>
<p>3、观察媒资管理服务后台日志</p>
<h3 id="7-8-2-失败测试"><a href="#7-8-2-失败测试" class="headerlink" title="7.8.2 失败测试"></a><strong>7.8.2</strong> <strong>失败测试</strong></h3><p>1、先停止调度中心的视频处理任务。</p>
<p>2、上传视频，手动修改待处理任务表中file_path字段为一个不存在的文件地址</p>
<p>3、启动任务</p>
<p>观察任务处理失败后是否会重试，并记录失败次数。</p>
<h3 id="7-8-3-抢占任务测试"><a href="#7-8-3-抢占任务测试" class="headerlink" title="7.8.3 抢占任务测试"></a><strong>7.8.3</strong> <strong>抢占任务测试</strong></h3><p>1、修改调度中心中视频处理任务的阻塞处理策略为“覆盖之间的调度”</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image088.gif" alt="img"></p>
<p>2、在抢占任务代码处打断点并选择支持多线程方式</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image090.gif" alt="img"></p>
<p>3、在抢占任务代码处的下边两行代码分别打上断点，避免观察时代码继续执行。</p>
<p>4、启动任务</p>
<p>此时多个线程执行都停留在断点处</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image092.gif" alt="img"></p>
<p>依次放行，观察同一个任务只会被一个线程抢占成功。</p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image094.gif" alt="img"></p>
<p><img src="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/clip_image096.gif" alt="img"></p>
<h2 id="7-9-其它问题"><a href="#7-9-其它问题" class="headerlink" title="7.9 其它问题"></a><strong>7.9</strong> <strong>其它问题</strong></h2><h3 id="7-9-1-任务补偿机制"><a href="#7-9-1-任务补偿机制" class="headerlink" title="7.9.1 任务补偿机制"></a><strong>7.9.1</strong> <strong>任务补偿机制</strong></h3><p>如果有线程抢占了某个视频的处理任务，如果线程处理过程中挂掉了，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p>
<p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p>
<p>任务执行期限是处理一个视频的最大时间，比如定为30分钟，通过任务的启动时间去判断任务是否超过执行期限。</p>
<p>大家思考这个sql该如何实现？</p>
<p>大家尝试自己实现此任务补偿机制。</p>
<h3 id="7-9-2-达到最大失败次数"><a href="#7-9-2-达到最大失败次数" class="headerlink" title="7.9.2 达到最大失败次数"></a><strong>7.9.2</strong> <strong>达到最大失败次数</strong></h3><p>当任务达到最大失败次数时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传mp4视频。</p>
<h3 id="7-9-3-分块文件清理问题"><a href="#7-9-3-分块文件清理问题" class="headerlink" title="7.9.3 分块文件清理问题"></a><strong>7.9.3</strong> <strong>分块文件清理问题</strong></h3><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p>
<p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p>
<p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p>
<p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p>
<h1 id="【面试】xxl-job的工作原理"><a href="#【面试】xxl-job的工作原理" class="headerlink" title="【面试】xxl-job的工作原理"></a>【面试】xxl-job的工作原理</h1><p>XXL-J0B分布式任务调度服务由调用中心和执行器组成，调用中心负责按任务调度策略向执行器下发任务，执行器负责接收任务执行任务。</p>
<p>1）首先部署并启动xxl-job调度中心。(一个java工程)</p>
<p>2）首先在微服务添加xxl-job依赖，在微服务中配置执行器</p>
<p>3）启动微服务，执行器向调度中心上报自己。</p>
<p>4）在微服务中写一个任务方法并用xxl-job的注解去标记执行任务的方法名称。</p>
<p>5）在调度中心配置任务调度策略，调度策略就是每隔多长时间执行还是在每天或每月的固定时间去执行，比如每天0点执行，或每隔1小时执行一次等。</p>
<p>6）在调度中心启动任务。</p>
<p>7）调度中心根据任务调度策略，到达时间就开始下发任务给执行器。</p>
<p>8）执行器收到任务就开始执行任务。</p>
<h1 id="【面试】2、如何保证任务不重复执行"><a href="#【面试】2、如何保证任务不重复执行" class="headerlink" title="【面试】2、如何保证任务不重复执行?"></a>【面试】2、如何保证任务不重复执行?</h1><ol>
<li>调度中心按分片广播的方式去下发任务</li>
</ol>
<ol start="2">
<li>执行器收到作业分片广播的参数:分片总数和分片序号，计算任务id除以分片总数得到一个余数，如果余数等于分片序号这时就去执行这个任务，这里保证了不同的执行器执行不同的任务。</li>
</ol>
<ol start="3">
<li><p>配置调度过期策略为”忽略”，避免同一个执行器多次重复执行同一个任务</p>
</li>
<li><p>配置任务阻塞处理策略为”丢弃后续调度”，注意:丢弃也没事下一次调度就又可以执行了</p>
</li>
<li><p>另外还要保证任务处理的幂等性，执行过的任务可以打一个状态标记已完成，下次再调度执行该任务判断该任务已完成就不再执行</p>
</li>
</ol>
<h1 id="【面试】3、任务幂等性如何保证"><a href="#【面试】3、任务幂等性如何保证" class="headerlink" title="【面试】3、任务幂等性如何保证?"></a>【面试】3、任务幂等性如何保证?</h1><p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。幂等性是为了解决重复提交问题，比如:恶意刷单，重复支付等。解决幂等性常用的方案:</p>
<p>1）数据库约南比如:唯一索引，主键。同一个主键不可能两次都插入成功。</p>
<p>2）乐观锁,常用于数据库，更新数据时根据乐观锁状态去更新。</p>
<p>3）唯一序列号请求前生成唯一的序列号，携带序列号丢请求，执行时在redis记录该序列号表示以该序列号的请</p>
<p>求执行过了，如果相同的序列号再次来执行说明是重复执行。<br>这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p>
<h1 id="8-绑定媒资"><a href="#8-绑定媒资" class="headerlink" title="8 绑定媒资"></a>8 绑定媒资</h1><h2 id="8-1-需求分析"><a href="#8-1-需求分析" class="headerlink" title="8.1 需求分析"></a>8.1 需求分析</h2><h3 id="8-1-1-业务流程"><a href="#8-1-1-业务流程" class="headerlink" title="8.1.1 业务流程"></a>8.1.1 业务流程</h3><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p>
<p>如何将课程计划绑定媒资呢？</p>
<p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p>
<p>具体的业务流程如下：</p>
<p>1.教育机构用户进入课程管理页面并编辑某一个课程，在”课程大纲”标签页的某一小节后可点击”添加视频“。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MDEzMzM1Yjk2ZjZkNGRhNjRhYTg3MjM2YzliMDZmMWZfYkVteGFFMEVsVTFsSG8yM3lYazR2amhYeHVFUGdrWXdfVG9rZW46Ym94Y25ud0VRRzhFb3Y3eGU0WWJnbWxuY1pnXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGZkMjQxYWJhNGFmYTcwZjNiZDMwMDU1NjhlNzE0NzBfQjUweXVvS21La041MTlydXM5Zmx0aWtvNzZJVVJpUnhfVG9rZW46Ym94Y25ZSG9CTTlJU2tqTUR0TkJNdFZmSmt5XzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MDVkNDUzNjA1MWE1MjE4Y2FiM2QyZTQxMTQ0N2VhODFfOXRjcVB1bmFSWHZtbTYwamQwSnNSZUoyVmZRdklqTENfVG9rZW46Ym94Y255d3ZtR2Fxa2wyMnNUTlI0MTBFdTBkXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>课程计划关联视频后如下图：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDRkZTQ3MTRmZjU1NGRkM2JjNmFkNDZlODg3MzdlYjdfemhZNjVBRWJ2dUh1UlRrMWN3UGRqTXNGQUkwMmtVbWFfVG9rZW46Ym94Y25zVmlhVjhaYUtkcjdvTDBFemM1VEFjXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>点击已经绑定的视频名称即可解除绑定。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=YjkwMTEyZGE3ZjhhZjFmMmI4NzQzMmY5NDc4N2I0OTJfRnl5U1NkMWZNbEtaSGRuSDA3MjVJcTJiVUcyeTh2c3lfVG9rZW46Ym94Y24xa2pKaTNWNnVablp5NGNUcEowTjRnXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<h3 id="8-1-2-数据模型"><a href="#8-1-2-数据模型" class="headerlink" title="8.1.2 数据模型"></a>8.1.2 数据模型</h3><p>课程计划绑定媒资文件后存储至课程计划绑定媒资表</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=NzYxYWU2YWQ5NWJiMjY0MzliODAxZTgzNzQwOGI0YzFfNDJsdUlPQk9KR1EyMk0zTlpabnBNMkRtQnFwOWZBOFFfVG9rZW46Ym94Y25PaVNiNUNmV1l4TW5GRUVXOGZwY0JkXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<h2 id="8-2-接口定义"><a href="#8-2-接口定义" class="headerlink" title="8.2 接口定义"></a>8.2 接口定义</h2><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，前端以json格式请求以下参数：</p>
<p>提交媒资文件id、文件名称、教学计划id</p>
<p>示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mediaId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;teachplanId&quot;</span><span class="punctuation">:</span> <span class="number">257</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>此接口在内容管理模块提供。</p>
<p>在内容管理模块定义请求参数模型类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;BindTeachplanMediaDto&quot;, description=&quot;教学计划-媒资绑定提交数据&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BindTeachplanMediaDto</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModelProperty(value = &quot;媒资文件id&quot;, required = true)</span></span><br><span class="line"><span class="keyword">private</span> String mediaId;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModelProperty(value = &quot;媒资文件名称&quot;, required = true)</span></span><br><span class="line"><span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程计划标识&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> Long teachplanId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在TeachplanController类中定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-3-接口开发"><a href="#8-3-接口开发" class="headerlink" title="8.3 接口开发"></a>8.3 接口开发</h2><h3 id="8-3-1-DAO开发"><a href="#8-3-1-DAO开发" class="headerlink" title="8.3.1 DAO开发"></a>8.3.1 DAO开发</h3><p>对teachplanMedia表自动生成Mapper。</p>
<h3 id="8-3-2-Service开发"><a href="#8-3-2-Service开发" class="headerlink" title="8.3.2 Service开发"></a>8.3.2 Service开发</h3><p>根据需求定义service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 教学计划绑定媒资</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bindTeachplanMediaDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.content.model.po.TeachplanMedia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 22:20</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span>;</span><br></pre></td></tr></table></figure>

<p>定义接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span> &#123;</span><br><span class="line"> <span class="comment">//教学计划id</span></span><br><span class="line"> <span class="type">Long</span> <span class="variable">teachplanId</span> <span class="operator">=</span> bindTeachplanMediaDto.getTeachplanId();</span><br><span class="line"> <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line"> <span class="keyword">if</span>(teachplan==<span class="literal">null</span>)&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;教学计划不存在&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line"> <span class="keyword">if</span>(grade!=<span class="number">2</span>)&#123;</span><br><span class="line">  XueChengPlusException.cast(<span class="string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//课程id</span></span><br><span class="line"> <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> teachplan.getCourseId();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//先删除原来该教学计划绑定的媒资</span></span><br><span class="line"> teachplanMediaMapper.delete(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId,teachplanId));</span><br><span class="line"></span><br><span class="line"> <span class="comment">//再添加教学计划与媒资的绑定关系</span></span><br><span class="line"> <span class="type">TeachplanMedia</span> <span class="variable">teachplanMedia</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TeachplanMedia</span>();</span><br><span class="line"> teachplanMedia.setCourseId(courseId);</span><br><span class="line"> teachplanMedia.setTeachplanId(teachplanId);</span><br><span class="line"> teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());</span><br><span class="line"> teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());</span><br><span class="line"> teachplanMedia.setCreateDate(LocalDateTime.now());</span><br><span class="line"> teachplanMediaMapper.insert(teachplanMedia);</span><br><span class="line"> <span class="keyword">return</span> teachplanMedia;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-3-接口层完善"><a href="#8-3-3-接口层完善" class="headerlink" title="8.3.3 接口层完善"></a>8.3.3 接口层完善</h3><p>完善接口层调用Service层的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line">    teachplanService.associationMedia(bindTeachplanMediaDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-4-接口测试"><a href="#8-3-4-接口测试" class="headerlink" title="8.3.4 接口测试"></a>8.3.4 接口测试</h3><p>1、使用httpclient测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划绑定视频</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan/association/media</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;mediaId&quot;: &quot;&quot;,</span><br><span class="line">  &quot;fileName&quot;: &quot;&quot;,</span><br><span class="line">  &quot;teachplanId&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、前后端联调</p>
<p>此功能较为简单推荐直接前后端联调</p>
<p>向指定课程计划添加视频</p>
<h2 id="8-4-实战"><a href="#8-4-实战" class="headerlink" title="8.4 实战"></a>8.4 实战</h2><p>根据接口定义实现解除绑定功能。</p>
<p>点击已经绑定的视频名称即可解除绑定。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=NmVkMDVlNjcwM2Q4NzA0MGE3OTdiZTQ1ZTZhMGQwMmVfS0tGSHVkdEFmYmxhVlZwNVpjQm4wRGhEa3o2VmVrMFFfVG9rZW46Ym94Y245RDFCMkE0OU5RNnI2aHFuSnV4b3loXzE3MTEyNjA4ODg6MTcxMTI2NDQ4OF9WNA" alt="img"></p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete /teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br><span class="line"></span><br><span class="line">返回<span class="number">200</span>状态码表示成功。</span><br></pre></td></tr></table></figure>

<p>开发完成使用httpclient测试、前后端联调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划接触视频绑定</span><br><span class="line">DELETE &#123;&#123;media_host&#125;&#125;/media/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br></pre></td></tr></table></figure>



<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><ul>
<li>根据接口定义实现解除绑定功能<ul>
<li>点击已经绑定的视频名称即可解除绑定</li>
</ul>
</li>
<li>接口定义如下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">delete /teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在TeachplanController中定义接口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功@ApiOperation(&quot;课程计划解除媒资信息绑定&quot;)</span><br><span class="line">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span><br><span class="line">public void unassociationMedia(@PathVariable Long teachPlanId, @PathVariable Long mediaId) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>根据需求定义Service接口</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功/** 解绑教学计划与媒资信息</span><br><span class="line"> * @param teachPlanId       教学计划id</span><br><span class="line"> * @param mediaId           媒资信息id</span><br><span class="line"> */</span><br><span class="line">void unassociationMedia(Long teachPlanId, Long mediaId);</span><br></pre></td></tr></table></figure>

<ul>
<li>定义接口实现</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功@Override</span><br><span class="line">public void unassociationMedia(Long teachPlanId, Long mediaId) &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId)</span><br><span class="line">            .eq(TeachplanMedia::getMediaId, mediaId);</span><br><span class="line">    teachplanMediaMapper.delete(queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>完善接口层，调用service层的代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功@ApiOperation(&quot;课程计划解除媒资信息绑定&quot;)</span><br><span class="line">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span><br><span class="line">public void unassociationMedia(@PathVariable Long teachPlanId, @PathVariable String mediaId) &#123;</span><br><span class="line">    teachplanService.unassociationMedia(teachPlanId, mediaId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/" itemprop="url">学成在线-day06-媒资管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-20T21:36:16+08:00">
                2024-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  11.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  50
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1</strong> <strong>模块需求分析</strong></h1><h2 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1</strong> <strong>模块介绍</strong></h2><p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p>
<p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视&#x2F;音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AA%92%E4%BD%93?fromModule=lemma_inlink">媒体</a>资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p>
<p>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</p>
<p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p>
<p>媒资查询：教学机构查询自己所拥有的媒资信息。</p>
<p>文件上传：包括上传图片、上传文档、上传视频。</p>
<p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p>
<p>文件删除：教学机构删除自己上传的媒资文件。</p>
<p>下图是课程编辑与发布的整体流程，通过下图可以看到媒资管理在整体流程的位置：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002.gif" alt="img"></p>
<h2 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2</strong> <strong>业务流程</strong></h2><h3 id="1-2-1-上传图片"><a href="#1-2-1-上传图片" class="headerlink" title="1.2.1 上传图片"></a><strong>1.2.1</strong> <strong>上传图片</strong></h3><p>教学机构人员在课程信息编辑页面上传课程图片，课程图片统一记录在媒资管理系统。</p>
<p>下图是上传图片的界面：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004.gif" alt="img"></p>
<h3 id="1-2-2-上传视频"><a href="#1-2-2-上传视频" class="headerlink" title="1.2.2 上传视频"></a><strong>1.2.2</strong> <strong>上传视频</strong></h3><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p>
<p>点击“媒资管理”</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006.gif" alt="img"></p>
<p>进入媒资管理列表页面查询本机构上传的媒资文件。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008.gif" alt="img"></p>
<p>2、教育机构用户在”媒资管理”页面中点击 “上传视频” 按钮。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010.gif" alt="img"></p>
<p>点击“上传视频”打开上传页面</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012.gif" alt="img"></p>
<p>3、选择要上传的文件，自动执行文件上传，视频上传成功会自动处理。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014.gif" alt="img"></p>
<h3 id="1-2-3-处理视频"><a href="#1-2-3-处理视频" class="headerlink" title="1.2.3 处理视频"></a><strong>1.2.3</strong> <strong>处理视频</strong></h3><p>对需要转码处理的视频系统会自动对其处理，处理后生成视频的URL。</p>
<p>处理视频没有用户界面，完全是后台自动执行。</p>
<h3 id="1-2-4-审核媒资"><a href="#1-2-4-审核媒资" class="headerlink" title="1.2.4 审核媒资"></a><strong>1.2.4</strong> <strong>审核媒资</strong></h3><p>审核媒资包括程序自动审核和人工审核，程序可以通过鉴黄接口(<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)%E5%AE%A1%E6%A0%B8%E8%A7%86%E9%A2%91%EF%BC%8C%E5%AF%B9%E6%9C%89%E5%BC%82%E8%AE%AE%E7%9A%84%E8%A7%86%E9%A2%91%E7%94%B1%E4%BA%BA%E5%B7%A5%E8%BF%9B%E8%A1%8C%E5%AE%A1%E6%A0%B8%E3%80%82">https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)审核视频，对有异议的视频由人工进行审核。</a></p>
<p>1.运营用户登入运营平台并进入媒资管理页面，查找待审核媒资</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016.gif" alt="img"></p>
<p>2.点击列表中媒资名称链接，可预览该媒资，若是视频，则播放视频。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018.gif" alt="img"></p>
<p>3.点击列表中某媒资后的”审核” 按钮，既完成媒资的审批过程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020.gif" alt="img"></p>
<p> 点击“审核”，选择审核结果，输入审核意见。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022.gif" alt="img"></p>
<h3 id="1-2-5-绑定媒资"><a href="#1-2-5-绑定媒资" class="headerlink" title="1.2.5 绑定媒资"></a><strong>1.2.5</strong> <strong>绑定媒资</strong></h3><p>课程计划创建好后需要绑定媒资文件，比如：如果课程计划绑定了视频文件，进入课程在线学习界面后点课程计划名称则在线播放视频。如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image024.gif" alt="img"></p>
<p>如何将课程计划绑定媒资呢？</p>
<p>1.教育机构用户进入课程管理页面并编辑某一个课程，在”课程大纲”标签页的某一小节后可点击”添加视频“。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image026.gif" alt="img"></p>
<p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image028.gif" alt="img"></p>
<p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image030.gif" alt="img"></p>
<p>课程计划关联视频后如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image032.gif" alt="img"></p>
<h2 id="1-3-数据模型"><a href="#1-3-数据模型" class="headerlink" title="1.3 数据模型"></a><strong>1.3</strong> <strong>数据模型</strong></h2><p>本模块媒资文件相关的数据表如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image034.gif" alt="img"></p>
<p>媒资文件表：存储文件信息，包括图片、视频、文档等。</p>
<p>media_process: 待处理视频表。</p>
<p>media_process_history: 视频处理历史表，记录已经处理成功的视频信息。</p>
<p>媒资文件与课程计划绑定关系表如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image036.gif" alt="img"></p>
<h1 id="2-搭建模块环境"><a href="#2-搭建模块环境" class="headerlink" title="2 搭建模块环境"></a><strong>2</strong> <strong>搭建模块环境</strong></h1><h2 id="2-1-架构的问题分析"><a href="#2-1-架构的问题分析" class="headerlink" title="2.1 架构的问题分析"></a><strong>2.1</strong> <strong>架构的问题分析</strong></h2><p>当前要开发的是媒资管理服务，目前为止共三个微服务：内容管理、系统管理、媒资管理，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-17109957485941.gif" alt="img"></p>
<p>后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：</p>
<p>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护，比如下边代码中请求系统管理服务的地址使用的是localhost</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-17109957485952.gif" alt="img"></p>
<p>当系统上线后这里需要改成公网的域名，如果这种地址非常多则非常麻烦。</p>
<p>基于这个问题可以采用网关来解决，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-17109957485953.gif" alt="img"></p>
<p>这样在前端的代码中只需要指定每个接口的相对路径，如下所示：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-17109957485954.gif" alt="img"></p>
<p>在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务。</p>
<p>为什么所有的请求先到网关呢？</p>
<p>有了网关就可以对请求进行路由，路由到具体的微服务，减少外界对接微服务的成本，比如：400电话，路由的试可以根据请求路径进行路由、根据host地址进行路由等， 当微服务有多个实例时可以通过负载均衡算法进行路由，如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-17109957485955.gif" alt="img"></p>
<p>另外，网关还可以实现权限控制、限流等功能。</p>
<p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用Nacos作用服务发现中心和配置中心，整体的架构图如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012-17109957485956.gif" alt="img"></p>
<p>流程如下：</p>
<p>1、微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p>
<p>2、网关从Nacos读取服务列表，包括服务名称、服务地址等。</p>
<p>3、请求到达网关，网关将请求路由到具体的微服务。</p>
<p>要使用网关首先搭建Nacos，Nacos有两个作用：</p>
<p>1、服务发现中心。</p>
<p>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</p>
<p>2、配置中心。</p>
<p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</p>
<h2 id="2-2-搭建Nacos"><a href="#2-2-搭建Nacos" class="headerlink" title="2.2 搭建Nacos"></a><strong>2.2</strong> <strong>搭建Nacos</strong></h2><h3 id="2-2-1-服务发现中心"><a href="#2-2-1-服务发现中心" class="headerlink" title="2.2.1 服务发现中心"></a><strong>2.2.1</strong> <strong>服务发现中心</strong></h3><p>Spring Cloud ：一套规范</p>
<p>Spring Cloud alibaba: nacos服务注册中心，配置中心</p>
<p>根据上节讲解的网关的架构图，<strong>要使用网关首先搭建Nacos</strong>。</p>
<p>首先搭建Nacos服务发现中心。</p>
<p>在搭建Nacos服务发现中心之前需要搞清楚两个概念：namespace和group</p>
<p>namespace：用于区分环境、比如：开发环境、测试环境、生产环境。</p>
<p>group：用于区分项目，比如：xuecheng-plus项目、xuecheng2.0项目</p>
<p>首先在nacos配置namespace:</p>
<p>登录Centos，启动Naocs，使用sh &#x2F;data&#x2F;soft&#x2F;restart.sh将自动启动Nacos。</p>
<p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8848/nacos/">http://192.168.101.65:8848/nacos/</a></p>
<p>账号密码：nacos&#x2F;nacos</p>
<p>登录成功，点击左侧菜单“命名空间”进入命名空间管理界面，</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014-17109957485957.gif" alt="img"></p>
<p>点击“新建命名空间”，填写命名空间的相关信息。如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016-17109957485958.gif" alt="img"></p>
<p>使用相同的方法再创建“测试环境”、”生产环境”的命名空间。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018-17109957485959.gif" alt="img"></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020-171099574859510.gif" alt="img"></p>
<p>创建成功，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022-171099574859511.gif" alt="img"></p>
<p>在教学中可以创建具体班级的命名空间，假如创建1010班级的命名空间，如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image024-171099574859512.gif" alt="img"></p>
<p>注意：如果使用dev1010命名空间，在下边的配置中对namespace配置为dev1010。</p>
<p>首先完成各服务注册到Naocs，下边将内容管理服务注册到nacos中。</p>
<p>1）在xuecheng-plus-parent中添加依赖管理 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）在内容管理模块的接口工程、系统管理模块的接口工程中添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3）配置nacos的地址</p>
<p>在系统管理的service工程的配置文件中配置如下信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">YAML</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure>

<p>在内容管理的接口工程的配置文件中配置如下信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure>



<p>4）重启内容管理服务、系统管理服务。</p>
<p>待微服务启动成功，进入Nacos服务查看服务列表</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image026-171099574859513.gif" alt="img"></p>
<p>在 “开发环境” 命名空间下有两个服务这说明内容管理微服务和系统管理微服务在Nacos注册成功。</p>
<p>点击其它一个微服务的“详情”</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image028-171099574859514.gif" alt="img"></p>
<p>通过上图可以查看微服务实例的地址。</p>
<h3 id="2-2-2-配置中心"><a href="#2-2-2-配置中心" class="headerlink" title="2.2.2 配置中心"></a><strong>2.2.2</strong> <strong>配置中心</strong></h3><h4 id="2-2-2-1-配置三要素"><a href="#2-2-2-1-配置三要素" class="headerlink" title="2.2.2.1 配置三要素"></a><strong>2.2.2.1</strong> <strong>配置三要素</strong></h4><p>搭建完成Nacos服务发现中心，下边搭建Nacos为配置中心，其目的就是通过Nacos去管理项目的所有配置。</p>
<p>先将项目中的配置文件分分类：</p>
<p>1、每个项目特有的配置</p>
<p>是指该配置只在有些项目中需要配置，或者该配置在每个项目中配置的值不同。</p>
<p>比如：spring.application.name每个项目都需要配置但值不一样，以及有些项目需要连接数据库而有些项目不需要，有些项目需要配置消息队列而有些项目不需要。</p>
<p>2、项目所公用的配置</p>
<p>是指在若干项目中配置内容相同的配置。比如：redis的配置，很多项目用的同一套redis服务所以配置也一样。</p>
<p>另外还需要知道nacos如何去定位一个具体的配置文件，即：namespace、group、dataid. </p>
<p>1、通过namespace、group找到具体的环境和具体的项目。</p>
<p>2、通过dataid找到具体的配置文件，dataid有三部分组成</p>
<p>比如：content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成</p>
<p>content-service：第一部分，它是在application.yaml中配置的应用名，即spring.application.name的值。</p>
<p>dev：第二部分，它是环境名，通过spring.profiles.active指定，</p>
<p>Yaml: 第三部分，它是配置文件 的后缀，目前nacos支持properties、yaml等格式类型，本项目选择yaml格式类型。</p>
<p>所以，如果我们要配置content-service工程的配置文件:</p>
<p>在开发环境中配置content-service-dev.yaml</p>
<p>在测试环境中配置content-service-test.yaml</p>
<p>在生产环境中配置content-service-prod.yaml</p>
<p>我们启动项目中传入spring.profiles.active的参数决定引用哪个环境的配置文件，例如：传入spring.profiles.active&#x3D;dev表示使用dev环境的配置文件即content-service-dev.yaml。</p>
<h4 id="2-2-2-2-配置content-service"><a href="#2-2-2-2-配置content-service" class="headerlink" title="2.2.2.2 配置content-service"></a><strong>2.2.2.2</strong> <strong>配置</strong>content-service</h4><p>下边以开发环境为例对content-service工程的配置文件进行配置，进入nacos，进入开发环境。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image030-171099574859515.gif" alt="img"></p>
<p>点击加号，添加一个配置</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image032-171099574859516.gif" alt="img"></p>
<p>输入data id、group以及配置文件内容。</p>
<p>为什么没在nacos中配置下边的内容 ？</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br></pre></td></tr></table></figure>

<p>因为刚才说了dataid第一部分就是spring.application.name，nacos 客户端要根据此值确定配置文件 名称，所以spring.application.name不在nacos中配置，而是要在工程的本地进行配置。</p>
<p>在content-service工程的test&#x2F;resources 中添加bootstrap.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#profiles默认为dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>在内容管理模块的接口工程和service工程配置依赖：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">    <span class="string">&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span><br><span class="line">    <span class="string">&lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span></span><br><span class="line"><span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置完成，运行content-service工程 的单元测试文件，能否正常测试，跟踪单元测试方法可以正常读取数据库的数据，说明从nacos读取配置信息正常。</p>
<p>通过运行观察控制台打印出下边的信息，NacosRestTemplate.java通过Post方式与nacos服务端交互读取配置信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:<span class="number">476</span>] - HTTP method: POST, url: http:<span class="comment">//192.168.101.65:8848/nacos/v1/cs/configs/listener, body: &#123;Listening-Configs=content-service.yaml?xuecheng-plus-project??dev?content-service-dev.yaml?xuecheng-plus-project?88459b1483b8381eccc2ef462bd59182?dev?content-service?xuecheng-plus-project??dev?, tenant=dev&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-3配置content-api"><a href="#2-2-2-3配置content-api" class="headerlink" title="2.2.2.3配置content-api"></a><strong>2.2.2.3</strong>配置<strong>content-api</strong></h4><p>以相同的方法配置content-api工程的配置文件，在nacos中的开发环境中配置content-api-dev.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/content</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63040</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># swagger 文档配置</span></span><br><span class="line"><span class="attr">swagger:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">&quot;学成在线内容管理系统&quot;</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;内容系统管理系统对课程相关信息进行业务管理数据&quot;</span></span><br><span class="line">  <span class="attr">base-package:</span> <span class="string">com.xuecheng.content</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>在content-api工程 的本地配置bootstrap.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>



<p><font color="red"> 注意：因为api接口工程依赖了service工程 的jar，所以这里使用extension-configs扩展配置文件 的方式引用service工程所用到的配置文件。</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>如果添加多个扩展文件，继续在下添加即可，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">填写文件</span> <span class="string">dataid</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span>           </span><br></pre></td></tr></table></figure>



<p>启动content-api工程，查询控制台是否打印出了请求nacos的日志，如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:476] - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener </span><br></pre></td></tr></table></figure>

<p>并使用Httpclient测试课程查询接口是否可以正常查询。</p>
<h3 id="2-2-3-公用配置"><a href="#2-2-3-公用配置" class="headerlink" title="2.2.3 公用配置"></a><strong>2.2.3</strong> <strong>公用配置</strong></h3><p>还有一个优化的点是如何在nacos中配置项目的公用配置呢？</p>
<p>nacos提供了shared-configs可以引入公用配置。</p>
<p>在content-api中配置了swagger，所有的接口工程 都需要配置swagger，这里就可以将swagger的配置定义为一个公用配置，哪个项目用引入即可。</p>
<p>单独在xuecheng-plus-common分组下创建xuecheng-plus的公用配置，进入nacos的开发环境，添加swagger-dev.yaml公用配置</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image034-171099574859517.gif" alt="img"></p>
<p>删除接口工程中对swagger的配置。</p>
<p>项目使用shared-configs可以引入公用配置。在接口工程的本地配置文件 中引入公用配置，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">swagger-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>再以相同 的方法配置日志的公用配置。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image036-171099574859518.gif" alt="img"></p>
<p>在接口工程和业务工程，引入loggin-dev.yaml公用配置文件 </p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image038.gif" alt="img"></p>
<p>配置完成，重启content-api接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html">http://localhost:63040/content/swagger-ui.html</a> 查看swagger接口文档是否可以正常访问，查看控制台log4j2日志输出是否正常。</p>
<h3 id="2-2-4-配置优先级"><a href="#2-2-4-配置优先级" class="headerlink" title="2.2.4 配置优先级"></a><strong>2.2.4</strong> <strong>配置优先级</strong></h3><p>到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml和nacos上的配置文件，SpringBoot读取配置文件 的顺序如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image040.gif" alt="img"></p>
<p>引入配置文件的形式有：</p>
<p>1、以项目应用名方式引入</p>
<p>2、以扩展配置文件方式引入</p>
<p>3、以共享配置文件 方式引入</p>
<p>4、本地配置文件</p>
<p>各配置文件 的优先级：项目应用名配置文件 &gt; 扩展配置文件 &gt; 共享配置文件 &gt; 本地配置文件。</p>
<p>有时候我们在测试程序时直接在本地加一个配置进行测试，比如下边的例子：</p>
<p>我们想启动两个内容管理微服务，此时需要在本地指定不同的端口，通过VM Options参数，在IDEA配置启动参数</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image042.gif" alt="img"></p>
<p>通过-D指定参数名和参数值，参数名即在bootstrap.yml中配置的server.port。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image044.gif" alt="img"></p>
<p>启动ContentApplication2，发现端口仍然是63040，这说明本地的配置没有生效。</p>
<p>这时我们想让本地最优先，可以在nacos配置文件 中配置如下即可实现：</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>再次启动ContentApplication2，端口为63041。</p>
<h3 id="2-2-5-导入配置文件"><a href="#2-2-5-导入配置文件" class="headerlink" title="2.2.5 导入配置文件"></a><strong>2.2.5</strong> <strong>导入配置文件</strong></h3><p>课程资料中提供了系统用的所有配置文件nacos_config_export.zip，下边将nacos_config_export.zip导入nacos。</p>
<p>进入具体的命名空间，点击“导入配置”</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image046.gif" alt="img"></p>
<p>打开导入窗口</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image048.gif" alt="img"></p>
<p>相同的配置选择覆盖配置。</p>
<p>点击“上传文件”选择资料中的nacos_config_export.zip开始导入。</p>
<h3 id="2-2-6-作业"><a href="#2-2-6-作业" class="headerlink" title="2.2.6 作业"></a><strong>2.2.6</strong> <strong>作业</strong></h3><p>按照上边的方法 自行将系统管理服务的配置信息在nacos上进行配置。</p>
<h2 id="2-3-搭建Gateway"><a href="#2-3-搭建Gateway" class="headerlink" title="2.3 搭建Gateway"></a><strong>2.3</strong> <strong>搭建Gateway</strong></h2><p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p>
<p>新建一个网关工程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-17110063357841.gif" alt="img"></p>
<p>工程结构</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-17110063357852.gif" alt="img"></p>
<p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--指定父工程为xuecheng-plus-parent--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--服务发现中心--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>配置网关的bootstrap.yaml配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>



<p>在nacos上配置网关路由策略：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-17110063357853.gif" alt="img"></p>
<p>详细配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63010</span> <span class="comment"># 网关端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line"><span class="comment">#      filter:</span></span><br><span class="line"><span class="comment">#        strip-prefix:</span></span><br><span class="line"><span class="comment">#          enabled: true</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">content-api</span> <span class="comment"># 路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://content-api</span> <span class="comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/content/**</span> <span class="comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">system-api</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://system-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/system/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">media-api</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://media-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/media/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>启动网关工程，通过网关工程访问微服务进行测试。</p>
<p>在http-client-env.json中配置网关的地址</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-17110063357854.gif" alt="img"></p>
<p>使用httpclient测试课程查询 接口，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">### 课程查询列表</span><br><span class="line">POST &#123;&#123;gateway_host&#125;&#125;/content/course/list?pageNo=<span class="number">2</span>&amp;pageSize=<span class="number">1</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;courseName&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行，观察是否可以正常访问接口 ，如下所示可以正常请求接口。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:63010/content/course/list?pageNo=2&amp;pageSize=1</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">transfer-encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Sun<span class="punctuation">,</span> <span class="number">11</span> Sep <span class="number">2022</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">54</span><span class="punctuation">:</span><span class="number">32</span> GMT</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring cloud实战&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-09-04 09:56:19&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-12-26 22:10:38&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changePeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;203001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-17110063357855.gif" alt="img"></p>
<p>启动前端工程，测试之前开发内容管理模块的功能。</p>
<p>观察网关控制台，通过网关转发课程查询的日志如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-03-21 16:02:53.536 DEBUG 9084 --- [tor-http-nio-10] o.s.c.g.h.RoutePredicateHandlerMapping   : Mapping [Exchange: POST http://localhost:63010/content/course/list?pageNo=1&amp;pageSize=2] to Route&#123;<span class="built_in">id</span>=<span class="string">&#x27;content-api&#x27;</span>, uri=lb://content-api, order=0, predicate=Paths: [/content/**], match trailing slash: <span class="literal">true</span>, gatewayFilters=[], metadata=&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-4-搭建媒资工程"><a href="#2-4-搭建媒资工程" class="headerlink" title="2.4 搭建媒资工程"></a><strong>2.4</strong> <strong>搭建媒资工程</strong></h2><p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目。</p>
<p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p>
<p>右键pom.xml转为maven工程。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-171100943395211.gif" alt="img"></p>
<p>下边做如下配置：</p>
<p>1、创建媒资数据库xc_media，并导入资料目录中的xcplus_media.sql</p>
<p>2、修改nacos上的media-service-dev.yaml配置文件中的数据库链接信息</p>
<p>重启media-api工程只要能正常启动成功即可，稍后根据需求写接口。</p>
<h1 id="3-分布式文件系统"><a href="#3-分布式文件系统" class="headerlink" title="3 分布式文件系统"></a><strong>3</strong> <strong>分布式文件系统</strong></h1><h2 id="3-1-什么是分布式文件系统"><a href="#3-1-什么是分布式文件系统" class="headerlink" title="3.1 什么是分布式文件系统"></a><strong>3.1</strong> <strong>什么是分布式文件系统</strong></h2><p>要理解分布式文件系统首先了解什么是文件系统。</p>
<p>查阅百度百科：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-171101045189613.gif" alt="img"></p>
<p>​    文件系统是负责管理和存储文件的系统软件，操作系统通过文件系统提供的接口去存取文件，用户通过操作系统访问磁盘上的文件。</p>
<p>下图指示了文件系统所处的位置：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-171101045189615.gif" alt="img"></p>
<p>常见的文件系统：FAT16&#x2F;FAT32、NTFS、HFS、UFS、APFS、XFS、Ext4等 。</p>
<p>现在有个问题，一此短视频平台拥有大量的视频、图片，这些视频文件、图片文件该如何存储呢？如何存储可以满足互联网上海量用户的浏览。</p>
<p>今天讲的分布式文件系统就是海量用户查阅海量文件的方案。</p>
<p>我们阅读百度百科去理解分布式文件系统的定义：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-171101045189614.gif" alt="img"></p>
<p>通过概念可以简单理解为：一个计算机无法存储海量的文件，通过网络将若干计算机组织起来共同去存储海量的文件，去接收海量用户的请求，这些组织起来的计算机通过网络进行通信，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-171101045189616.gif" alt="img"></p>
<p>好处：</p>
<p>1、一台计算机的文件系统处理能力扩充到多台计算机同时处理。</p>
<p>2、一台计算机挂了还有另外副本计算机提供数据。</p>
<p>3、每台计算机可以放在不同的地域，这样用户就可以就近访问，提高访问速度。</p>
<p>市面上有哪些分布式文件系统的产品呢？</p>
<p>1、NFS</p>
<p>阅读百度百科：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-171101045189617.gif" alt="img"></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012-171101045189618.gif" alt="img"></p>
<p>特点：</p>
<p>1）在客户端上映射NFS服务器的驱动器。</p>
<p>2）客户端通过网络访问NFS服务器的硬盘完全透明。</p>
<p>2、GFS</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014-171101045189619.gif" alt="img"></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016-171101045189620.gif" alt="img"></p>
<p>1）GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成。</p>
<p>2）master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中。</p>
<p>3）用户从master中获取数据元信息，向chunkserver存储数据。</p>
<p>3、HDFS</p>
<p>HDFS，是Hadoop Distributed File System的简称，是Hadoop抽象文件系统的一种实现。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</p>
<p>下图是HDFS的架构图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018-171101045189621.gif" alt="img"></p>
<p>1）HDFS采用主从结构，一个HDFS集群由一个名称结点和若干数据结点组成。</p>
<p>2）名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p>
<p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p>
<h2 id="云计算厂家"><a href="#云计算厂家" class="headerlink" title="云计算厂家"></a><strong>云计算厂家</strong></h2><p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于 99.9999999999%（12 个 9），服务设计可用性（或业务连续性）不低于 99.995%。</p>
<p><em>官方网站：</em><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss"><em>https://www.aliyun.com/product/oss</em></a> </p>
<p>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。您可以将任意数量和形式的非结构化数据存入BOS，并对数据进行管理和处理。BOS支持标准、低频、冷和归档存储等多种存储类型，满足多场景的存储需求。 </p>
<p><em>官方网站：</em><a target="_blank" rel="noopener" href="https://cloud.baidu.com/product/bos.html"><em>https://cloud.baidu.com/product/bos.html</em></a> </p>
<h2 id="3-2-MinIO"><a href="#3-2-MinIO" class="headerlink" title="3.2 MinIO"></a><strong>3.2 MinIO</strong></h2><h3 id="3-2-1-介绍"><a href="#3-2-1-介绍" class="headerlink" title="3.2.1 介绍"></a><strong>3.2.1</strong> <strong>介绍</strong></h3><p>本项目采用MinIO构建分布式文件系统，MinIO 是一个非常轻量的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器&#x2F;虚拟机镜像等。</p>
<p>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大5TB，兼容 Amazon S3接口，提供了 Java、Python、GO等多版本SDK支持。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://min.io/">https://min.io</a></p>
<p>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/%EF%BC%8Chttp://docs.minio.org.cn/docs/">https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</a></p>
<p>MinIO集群采用去中心化共享架构，每个结点是对等关系，通过Nginx可对MinIO进行负载均衡访问。</p>
<p>去中心化有什么好处？</p>
<p>在大数据领域，通常的设计理念都是无中心和分布式。Minio分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p>
<p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式Minio避免了单点故障。如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020-171101045189622.gif" alt="img"></p>
<p>Minio使用纠删码技术来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各各节点的磁盘上，所有的可用磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，除了将文件本身分成4个数据块，还会生成4个校验块，数据块和校验块会分散的存储在这8块硬盘上。</p>
<p>使用纠删码的好处是即便丢失一半数量（N&#x2F;2）的硬盘，仍然可以恢复数据。 比如上边集合中有4个以内的硬盘损害仍可保证数据恢复，不影响上传和下载，如果多于一半的硬盘坏了则无法恢复。</p>
<h3 id="3-2-2-数据恢复演示"><a href="#3-2-2-数据恢复演示" class="headerlink" title="3.2.2 数据恢复演示"></a><strong>3.2.2</strong> <strong>数据恢复演示</strong></h3><p>下边在本机演示MinIO恢复数据的过程，在本地创建4个目录表示4个硬盘。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022-171101045189623.gif" alt="img"></p>
<p>下载minio，下载地址在<a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/%EF%BC%8C%E5%8F%AF%E4%BB%8E%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99%E6%89%BE%E5%88%B0MinIO%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6minio.zip%E8%A7%A3%E5%8E%8B%E5%8D%B3%E5%8F%AF%E4%BD%BF%E7%94%A8%EF%BC%8CCMD%E8%BF%9B%E5%85%A5%E6%9C%89minio.exe%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E8%BF%90%E8%A1%8C%E4%B8%8B%E8%BE%B9%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A">https://dl.min.io/server/minio/release/，可从课程资料找到MinIO的安装文件minio.zip解压即可使用，CMD进入有minio.exe的目录，运行下边的命令：</a></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minio.exe server D:\develop\minio_data\data1  D:\develop\minio_data\data2  D:\develop\minio_data\data3  D:\develop\minio_data\data4</span><br></pre></td></tr></table></figure>

<p>启动结果如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image024-171101045189724.gif" alt="img"></p>
<p>说明如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span></span><br><span class="line">WARNING: MINIO_ACCESS_KEY <span class="keyword">and</span> MINIO_SECRET_KEY <span class="keyword">are</span> deprecated.</span><br><span class="line">         Please use MINIO_ROOT_USER <span class="keyword">and</span> MINIO_ROOT_PASSWORD</span><br><span class="line">Formatting <span class="number">1</span>st pool, <span class="number">1</span> <span class="keyword">set</span>(s), <span class="number">4</span> drives <span class="keyword">per</span> set.</span><br><span class="line">WARNING: Host <span class="keyword">local</span> has more than <span class="number">2</span> drives <span class="keyword">of</span> set. A host failure will <span class="keyword">result</span> <span class="keyword">in</span> data becoming unavailable.</span><br><span class="line">WARNING: Detected <span class="keyword">default</span> credentials <span class="string">&#x27;minioadmin:minioadmin&#x27;</span>, we recommend that you change these <span class="keyword">values</span> <span class="keyword">with</span> <span class="string">&#x27;MINIO_ROOT_USER&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;MINIO_ROOT_PASSWORD&#x27;</span> environment variables</span><br></pre></td></tr></table></figure>

<p>1）老版本使用的MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY不推荐使用，推荐使用MINIO_ROOT_USER 和MINIO_ROOT_PASSWORD设置账号和密码。</p>
<p>2）pool即minio节点组成的池子，当前有一个pool和4个硬盘组成的set集合</p>
<p>3）因为集合是4个硬盘，大于2的硬盘损坏数据将无法恢复。</p>
<p>4）账号和密码默认为minioadmin、minioadmin，可以在环境变量中设置通过’MINIO_ROOT_USER’ and ‘MINIO_ROOT_PASSWORD’ 进行设置。</p>
<p>下边输入<a href="http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin">http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin</a></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image026-171101045189725.gif" alt="img"></p>
<p>登录成功：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image028-171101045189726.gif" alt="img"></p>
<p>下一步创建bucket，桶，它相当于存储文件的目录，可以创建若干的桶。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image030-171101045189727.gif" alt="img"></p>
<p>输入bucket的名称，点击“CreateBucket”，创建成功</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image032-171101045189728.gif" alt="img"></p>
<p>点击“upload”上传文件。</p>
<p>下边上传几个文件 </p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image034-171101045189729.gif" alt="img"></p>
<p>下边去四个目录观察文件的存储情况</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image036-171101045189730.gif" alt="img"></p>
<p>我们发现上传的1.mp4文件存储在了四个目录，即四个硬盘上。</p>
<p>下边测试minio的数据恢复过程：</p>
<p>1、首先删除一个目录。</p>
<p>删除目录后仍然可以在web控制台上传文件和下载文件。</p>
<p>稍等片刻删除的目录自动恢复。</p>
<p>2、删除两个目录。</p>
<p>删除两个目录也会自动恢复。</p>
<p>3、删除三个目录 。</p>
<p>由于 集合中共有4块硬盘，有大于一半的硬盘损坏数据无法恢复。</p>
<p>此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p>
<h3 id="3-2-3-测试Docker环境"><a href="#3-2-3-测试Docker环境" class="headerlink" title="3.2.3 测试Docker环境"></a><strong>3.2.3</strong> <strong>测试</strong>Docker环境</h3><p>开发阶段和生产阶段统一使用Docker下的MINIO。</p>
<p>在下发的虚拟机中已安装了MinIO的镜像和容器，执行sh &#x2F;data&#x2F;soft &#x2F;restart.sh启动Docker下的MinIO</p>
<p>启动完成登录MinIO查看是否正常。</p>
<p>访问<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/">http://192.168.101.65:9000</a></p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image038-171101045189731.gif" alt="img"></p>
<p>本项目创建两个buckets：</p>
<p>mediafiles： 普通文件</p>
<p>video：视频文件</p>
<h3 id="3-2-4-SDK"><a href="#3-2-4-SDK" class="headerlink" title="3.2.4 SDK"></a><strong>3.2.4 SDK</strong></h3><h4 id="3-2-4-1上传文件"><a href="#3-2-4-1上传文件" class="headerlink" title="3.2.4.1上传文件"></a><strong>3.2.4.1上传文件</strong></h4><p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>最低需求Java 1.8或更高版本:</p>
<p>maven依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在media-service工程添加此依赖。</p>
<p>参数说明：</p>
<p>需要三个参数才能连接到minio服务。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Endpoint</td>
<td>对象存储服务的URL</td>
</tr>
<tr>
<td>Access  Key</td>
<td>Access  key就像用户ID，可以唯一标识你的账户。</td>
</tr>
<tr>
<td>Secret  Key</td>
<td>Secret  key是你账户的密码。</td>
</tr>
</tbody></table>
<p>官方的示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.minio.BucketExistsArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MakeBucketArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.MinioException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploader</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidKeyException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span></span><br><span class="line">      <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">          MinioClient.builder()</span><br><span class="line">              .endpoint(<span class="string">&quot;https://play.min.io&quot;</span>)</span><br><span class="line">              .credentials(<span class="string">&quot;Q3AM3UQ867SPQQA43P2F&quot;</span>, <span class="string">&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;</span>)</span><br><span class="line">              .build();</span><br><span class="line">      <span class="comment">// Make &#x27;asiatrip&#x27; bucket if not exist.</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span></span><br><span class="line">          minioClient.bucketExists(BucketExistsArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">      <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        <span class="comment">// Make a new bucket called &#x27;asiatrip&#x27;.</span></span><br><span class="line">        minioClient.makeBucket(MakeBucketArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bucket &#x27;asiatrip&#x27; already exists.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Upload &#x27;/home/user/Photos/asiaphotos.zip&#x27; as object name &#x27;asiaphotos-2015.zip&#x27; to bucket</span></span><br><span class="line">      <span class="comment">// &#x27;asiatrip&#x27;.</span></span><br><span class="line">      minioClient.uploadObject(</span><br><span class="line">          UploadObjectArgs.builder()</span><br><span class="line">              .bucket(<span class="string">&quot;asiatrip&quot;</span>)</span><br><span class="line">              .object(<span class="string">&quot;asiaphotos-2015.zip&quot;</span>)</span><br><span class="line">              .filename(<span class="string">&quot;/home/user/Photos/asiaphotos.zip&quot;</span>)</span><br><span class="line">              .build());</span><br><span class="line">      System.out.println(</span><br><span class="line">          <span class="string">&quot;&#x27;/home/user/Photos/asiaphotos.zip&#x27; is successfully uploaded as &quot;</span></span><br><span class="line">              + <span class="string">&quot;object &#x27;asiaphotos-2015.zip&#x27; to bucket &#x27;asiatrip&#x27;.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MinioException e) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Error occurred: &quot;</span> + e);</span><br><span class="line">      System.out.println(<span class="string">&quot;HTTP trace: &quot;</span> + e.httpTrace());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>参考示例在media-service工程中 测试上传文件功能，</p>
<p>首先创建一个用于测试的bucket</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image040-171101045189732.gif" alt="img"></p>
<p>点击“Manage”修改bucket的访问权限</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image042-171101045189733.gif" alt="img"></p>
<p>选择public权限</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image044-171101045189734.gif" alt="img"></p>
<p>在xuecheng-plus-media-service工程 的test下编写测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.BucketExistsArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MakeBucketArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.MinioException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试MinIO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/11 21:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">            MinioClient.builder()</span><br><span class="line">                    .endpoint(<span class="string">&quot;http://192.168.101.65:9000&quot;</span>)</span><br><span class="line">                    .credentials(<span class="string">&quot;minioadmin&quot;</span>, <span class="string">&quot;minioadmin&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line"><span class="comment">//                    .object(&quot;test001.mp4&quot;)</span></span><br><span class="line">                    .object(<span class="string">&quot;001/test001.mp4&quot;</span>)<span class="comment">//添加子目录</span></span><br><span class="line">                    .filename(<span class="string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span>)</span><br><span class="line">                    .contentType(<span class="string">&quot;video/mp4&quot;</span>)<span class="comment">//默认根据扩展名确定文件内容类型，也可以指定</span></span><br><span class="line">                    .build();</span><br><span class="line">            minioClient.uploadObject(testbucket);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行upload方法，分别测试向桶的根目录上传文件以及子目录上传文件。</p>
<p>上传成功，通过web控制台查看文件，并预览文件。</p>
<p>说明：</p>
<p>设置contentType可以通过com.j256.simplemagic.ContentType枚举类查看常用的mimeType（媒体类型）</p>
<p>通过扩展名得到mimeType，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line"><span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流</span></span><br></pre></td></tr></table></figure>

<p>完善上边的代码 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line">    <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流</span></span><br><span class="line">    <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;</span><br><span class="line">        mimeType = extensionMatch.getMimeType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">            .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">            <span class="comment">//                    .object(&quot;test001.mp4&quot;)</span></span><br><span class="line">            .object(<span class="string">&quot;001/test001.mp4&quot;</span>)<span class="comment">//添加子目录</span></span><br><span class="line">            .filename(<span class="string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span>)</span><br><span class="line">            .contentType(mimeType)<span class="comment">//默认根据扩展名确定文件内容类型，也可以指定</span></span><br><span class="line">            .build();</span><br><span class="line">        minioClient.uploadObject(testbucket);</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-4-2-删除文件"><a href="#3-2-4-2-删除文件" class="headerlink" title="3.2.4.2 删除文件"></a><strong>3.2.4.2</strong> <strong>删除文件</strong></h4><p>下边测试删除文件</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-api-reference#removeObject">https://docs.min.io/docs/java-client-api-reference#removeObject</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        minioClient.removeObject(</span><br><span class="line">               RemoveObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;001/test001.mp4&quot;</span>).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;删除失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-4-3-查询文件"><a href="#3-2-4-3-查询文件" class="headerlink" title="3.2.4.3 查询文件"></a><strong>3.2.4.3</strong> <strong>查询文件</strong></h4><p>通过查询文件查看文件是否存在minio中。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-api-reference#getObject">https://docs.min.io/docs/java-client-api-reference#getObject</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询文件</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getFile</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;test001.mp4&quot;</span>).build();</span><br><span class="line">    <span class="keyword">try</span>(</span><br><span class="line">        <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1_2.mp4&quot;</span>));</span><br><span class="line">     ) &#123;</span><br><span class="line">        IOUtils.copy(inputStream,outputStream);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​       </p>
<p>校验文件的完整性，对文件计算出md5值，比较原始文件的md5和目标文件的md5，一致则说明完整</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//校验文件的完整性对文件的内容进行md5</span></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1.mp4&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">source_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream1);</span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1a.mp4&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">local_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line"><span class="keyword">if</span>(source_md5.equals(local_md5))&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;下载成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="4-上传图片"><a href="#4-上传图片" class="headerlink" title="4 上传图片"></a><strong>4</strong> <strong>上传图片</strong></h1><h2 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a><strong>4.1</strong> <strong>需求分析</strong></h2><h3 id="4-1-1-业务流程"><a href="#4-1-1-业务流程" class="headerlink" title="4.1.1 业务流程"></a><strong>4.1.1</strong> <strong>业务流程</strong></h3><p>课程图片是宣传课程非常重要的信息，在新增课程界面上传课程图片，也可以修改课程图片。</p>
<p>如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image002-17110280643141.gif" alt="img"></p>
<p>上传课程图片总体上包括两部分：</p>
<p>1、上传课程图片前端请求媒资管理服务将文件上传至分布式文件系统，并且在媒资管理数据库保存文件信息。</p>
<p>2、上传图片成功保存图片地址到课程基本信息表中。</p>
<p>详细流程如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image004-17110280643152.gif" alt="img"></p>
<p>1、前端进入上传图片界面</p>
<p>2、上传图片，请求媒资管理服务。</p>
<p>3、媒资管理服务将图片文件存储在MinIO。</p>
<p>4、媒资管理记录文件信息到数据库。</p>
<p>5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。</p>
<h3 id="4-1-2-数据模型"><a href="#4-1-2-数据模型" class="headerlink" title="4.1.2 数据模型"></a><strong>4.1.2</strong> <strong>数据模型</strong></h3><p>涉及到的数据表有：课程信息表中的图片字段、媒资数据库的文件表，下边主要看媒资数据库的文件表。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image006-17110280643153.gif" alt="img"></p>
<p>各字段描述如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image008-17110280643154.gif" alt="img"></p>
<h2 id="4-2-准备环境"><a href="#4-2-准备环境" class="headerlink" title="4.2 准备环境"></a><strong>4.2</strong> <strong>准备环境</strong></h2><p>首先在minio配置bucket，bucket名称为：mediafiles，并设置bucket的权限为公开。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image010-17110280643155.gif" alt="img"></p>
<p>在nacos配置中minio的相关信息，进入media-service-dev.yaml:</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image012-17110280643157.gif" alt="img"></p>
<p>配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">http://192.168.101.65:9000</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">secretKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">bucket:</span></span><br><span class="line">    <span class="attr">files:</span> <span class="string">mediafiles</span></span><br><span class="line">    <span class="attr">videofiles:</span> <span class="string">video</span></span><br></pre></td></tr></table></figure>



<p>在media-service工程编写minio的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> minio配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 19:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String endpoint;</span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String accessKey;</span><br><span class="line"> <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line"> <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">          MinioClient.builder()</span><br><span class="line">                  .endpoint(endpoint)</span><br><span class="line">                  .credentials(accessKey, secretKey)</span><br><span class="line">                  .build();</span><br><span class="line">  <span class="keyword">return</span> minioClient;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-接口定义"><a href="#4-3-接口定义" class="headerlink" title="4.3 接口定义"></a><strong>4.3</strong> <strong>接口定义</strong></h2><p>根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。</p>
<p>首先分析接口：</p>
<p>请求地址：&#x2F;media&#x2F;upload&#x2F;coursefile</p>
<p>请求内容：<strong>Content-Type:</strong> multipart&#x2F;form-data;</p>
<p>form-data; name&#x3D;”filedata”; filename&#x3D;”具体的文件名称”</p>
<p>响应参数：文件信息，如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;001001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bucket&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timelength&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-09-12T21:57:18&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileSize&quot;</span><span class="punctuation">:</span> <span class="number">248329</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>定义上传响应模型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件成功响应结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 18:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileResultDto</span> <span class="keyword">extends</span> <span class="title class_">MediaFiles</span> &#123;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口定义好后可以用httpclient工具测试一下</p>
<p>使用httpclient测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line">Content-Type: multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;filedata&quot;</span>; filename=<span class="string">&quot;1.jpg&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/develop/upload/<span class="number">1.</span>jpg</span><br></pre></td></tr></table></figure>

<h2 id="4-4-接口开发"><a href="#4-4-接口开发" class="headerlink" title="4.4 接口开发"></a><strong>4.4</strong> <strong>接口开发</strong></h2><h3 id="4-4-1-DAO开发"><a href="#4-4-1-DAO开发" class="headerlink" title="4.4.1 DAO开发"></a><strong>4.4.1 DAO开发</strong></h3><p>根据需求分析DAO层实现向media_files表插入一条记录，使用media_files表生成的mapper即可。</p>
<h3 id="4-4-2-Service开发"><a href="#4-4-2-Service开发" class="headerlink" title="4.4.2 Service开发"></a><strong>4.4.2 Service</strong>开发</h3><p>Service方法需要提供一个更加通用的保存文件的方法。</p>
<p>定义请求参数类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 18:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件名称</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String filename;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件类型（文档，音频，视频）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String fileType;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件大小</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long fileSize;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 标签</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上传人</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 备注</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定义service方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 上传文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件磁盘路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span>;</span><br></pre></td></tr></table></figure>



<p>实现方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MinioClient minioClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通文件桶</span></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String bucket_Files;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取文件默认存储目录路径 年/月/日</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getDefaultFolderPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;/&quot;</span>)+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> folder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取文件的md5</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFileMd5</span><span class="params">(File file)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="keyword">return</span> fileMd5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getMimeType</span><span class="params">(String extension)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(extension==<span class="literal">null</span>)</span><br><span class="line">        extension = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line">    <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(extension);</span><br><span class="line">    <span class="comment">//通用mimeType，字节流</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;</span><br><span class="line">    <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;</span><br><span class="line">        mimeType = extensionMatch.getMimeType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mimeType;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件写入minIO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath  文件地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String localFilePath,String mimeType,String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">                .bucket(bucket)</span><br><span class="line">                .object(objectName)</span><br><span class="line">                .filename(localFilePath)</span><br><span class="line">                .contentType(mimeType)</span><br><span class="line">                .build();</span><br><span class="line">        minioClient.uploadObject(testbucket);</span><br><span class="line">        log.debug(<span class="string">&quot;上传文件到minio成功,bucket:&#123;&#125;,objectName:&#123;&#125;&quot;</span>,bucket,objectName);</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;上传文件到minio出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误原因:&#123;&#125;&quot;</span>,bucket,objectName,e.getMessage(),e);</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;上传文件到文件系统失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;</span><br><span class="line">    <span class="comment">//从数据库查询文件</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localFilePath);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//文件mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);</span><br><span class="line">    <span class="comment">//文件的md5值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> getFileMd5(file);</span><br><span class="line">    <span class="comment">//文件的默认目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">defaultFolderPath</span> <span class="operator">=</span> getDefaultFolderPath();</span><br><span class="line">    <span class="comment">//存储到minio中的对象名(带目录)</span></span><br><span class="line">    <span class="type">String</span>  <span class="variable">objectName</span> <span class="operator">=</span> defaultFolderPath + fileMd5 + exension;</span><br><span class="line">    <span class="comment">//将文件上传到minio</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_files, objectName);</span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    uploadFileParamsDto.setFileSize(file.length());</span><br><span class="line">    <span class="comment">//将文件信息存储到数据库</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_mediafiles, objectName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//准备返回数据</span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileResultDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);</span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4-4-3-完善接口层"><a href="#4-4-3-完善接口层" class="headerlink" title="4.4.3 完善接口层"></a><strong>4.4.3</strong> <strong>完善接口层</strong></h3><p>完善接口层代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,<span class="meta">@RequestParam(value = &quot;folder&quot;,required=false)</span> String folder,<span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    uploadFileParamsDto.setFileSize(filedata.getSize());</span><br><span class="line">    <span class="comment">//图片</span></span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001001&quot;</span>);</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    uploadFileParamsDto.setFilename(filedata.getOriginalFilename());<span class="comment">//文件名称</span></span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">fileSize</span> <span class="operator">=</span> filedata.getSize();</span><br><span class="line">    uploadFileParamsDto.setFileSize(fileSize);</span><br><span class="line">    <span class="comment">//创建临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    <span class="comment">//上传的文件拷贝到临时文件</span></span><br><span class="line">    filedata.transferTo(tempFile);</span><br><span class="line">    <span class="comment">//文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();</span><br><span class="line">    <span class="comment">//上传文件</span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> mediaFileService.uploadFile(companyId, uploadFileParamsDto, absolutePath);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-4-接口测试"><a href="#4-4-4-接口测试" class="headerlink" title="4.4.4 接口测试"></a><strong>4.4.4</strong> <strong>接口测试</strong></h3><p>1、首先使用httpclient测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line">Content-Type: multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;filedata&quot;</span>; filename=<span class="string">&quot;1.jpg&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/develop/upload/<span class="number">1.</span>jpg</span><br></pre></td></tr></table></figure>

<p>2、再进行前后端联调测试</p>
<p>在新增课程、编辑课程界面上传图，保存课程信息后再次进入编辑课程界面，查看是否可以正常保存课程图片信息。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image014-17110280643156.gif" alt="img"></p>
<p>上图图片完成后，进入媒资管理，查看文件列表中是否有刚刚上传的图片信息。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image016-17110280643158.gif" alt="img"></p>
<h3 id="4-4-5-Service事务优化"><a href="#4-4-5-Service事务优化" class="headerlink" title="4.4.5 Service事务优化"></a><strong>4.4.5 Service</strong>事务优化</h3><p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p>
<p><font color="red"> 目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</font></p>
<p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p>
<p>优化后如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//从数据库查询文件</span></span><br><span class="line"><span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line"><span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">    mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">    <span class="comment">//拷贝基本信息</span></span><br><span class="line">    BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">    mediaFiles.setId(fileMd5);</span><br><span class="line">    mediaFiles.setFileId(fileMd5);</span><br><span class="line">    mediaFiles.setCompanyId(companyId);</span><br><span class="line">    mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">    mediaFiles.setBucket(bucket);</span><br><span class="line">    mediaFiles.setFilePath(objectName);</span><br><span class="line">    mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">    mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">    mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">    <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们人为在int insert &#x3D; mediaFilesMapper.insert(mediaFiles);下边添加一个异常代码int a&#x3D;1&#x2F;0;</p>
<p>测试是否事务控制。很遗憾，事务控制失败。</p>
<p>方法上已经添加了@Transactional注解为什么该方法不能被事务控制呢？</p>
<p>如果是在uploadFile方法上添加@Transactional注解就可以控制事务，去掉则不行。</p>
<p>现在的问题其实是一个非事务方法调同类一个事务方法，事务无法控制，这是为什么？</p>
<p>下边分析原因：</p>
<p>如果在uploadFile方法上添加@Transactional注解，代理对象执行此方法前会开启事务，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image018-17110280643159.gif" alt="img"></p>
<p>如果在uploadFile方法上没有@Transactional注解，代理对象执行此方法前不进行事务控制，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image020-171102806431510.gif" alt="img"></p>
<p>所以判断该方法是否可以事务控制必须保证是通过代理对象调用此方法，且此方法上添加了@Transactional注解。</p>
<p>现在在addMediaFilesToDb方法上添加@Transactional注解，也不会进行事务控制是因为并不是通过代理对象执行的addMediaFilesToDb方法。为了判断在uploadFile方法中去调用addMediaFilesToDb方法是否是通过代理对象去调用，我们可以打断点跟踪。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/clip_image022-171102806431511.gif" alt="img"></p>
<p>我们发现在uploadFile方法中去调用addMediaFilesToDb方法不是通过代理对象去调用。</p>
<p>如何解决呢？通过代理对象去调用addMediaFilesToDb方法即可解决。</p>
<p>在MediaFileService的实现类中注入MediaFileService的代理对象，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MediaFileService currentProxy;</span><br></pre></td></tr></table></figure>

<p>将addMediaFilesToDb方法提成接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>;</span><br></pre></td></tr></table></figure>

<p>调用addMediaFilesToDb方法的代码处改为如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="comment">//写入文件表</span></span><br><span class="line"><span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_files, objectName);</span><br><span class="line"> ....</span><br></pre></td></tr></table></figure>

<p>再次测试事务是否可以正常控制。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="url">学成在线-day05-项目实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-20T18:08:18+08:00">
                2024-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="实战环境"><a href="#实战环境" class="headerlink" title="实战环境"></a><strong>实战环境</strong></h1><h2 id="实战流程"><a href="#实战流程" class="headerlink" title="实战流程"></a><strong>实战流程</strong></h2><p>项目实战是模拟企业实际开发的场景，自己参考文档独立完成开发任务，项目实战可以有效的培养自己面对需求进行分析与开发的能力。</p>
<p>实战流程如下：</p>
<p>1、由组长将实战的初始代码提交至本组git仓库。</p>
<p>2、每位成员从此仓库clone项目。</p>
<p>3、小组共同讨论实战功能需求及接口。</p>
<p>4、根据自己小组的情况进行分工，每人至少写一个接口并测试通过、提交至仓库。</p>
<p><strong>注意：每人在开发接口时创建自己的service、controller接口和类，不要出现多人共用同一个文件的情况。</strong></p>
<p>5、待功能开发完毕小组成员拉下全部代码，进行交叉测试，测试出来的bug信息记录在word文档上提交给组长由组长汇总。</p>
<p>6、根据bug记录进行修复自己接口中的bug，修复完成并测试没有问题后提交给Git。</p>
<p>7、整体流程测试，包括如下：</p>
<p>1）从网上找一门详细的课程信息(包括课程大纲) 添加到系统中。</p>
<p>功能包括：添加课程、添加课程计划、添加师资信息。</p>
<p>2）演示修改课程、修改课程计划及修改师资信息功能。</p>
<p>3）演示课程计划上移、下移功能。</p>
<p>4）演示删除课程计划、删除师资、删除课程功能。</p>
<p>8、项目评比</p>
<p><strong>小组推荐一名成员作工作汇总，老师根据团队协作情况、功能完成情况、演讲能力进行打分（满分10分）。</strong></p>
<h2 id="创建Git远程仓库"><a href="#创建Git远程仓库" class="headerlink" title="创建Git远程仓库"></a><strong>创建Git远程仓库</strong></h2><p>因为组员无法访问组长虚拟机中的gogs所以由组长在自己的电脑上安装gogs，这里提供windwos版本安装包，如果安装有问题也可以使用公网的git仓库，比如码云。</p>
<p>组长解压 软件工具目录下的gogs_0.12.10_windows_amd64.zip，安装gogs</p>
<p>解压后cmd进入gogs安装目录，输入gogs.exe web</p>
<p>自动打开安装界面：</p>
<p>第一步填写数据库信息</p>
<p>输入虚拟机中的数据库地址和账号、密码，数据库名称为gogs_windows，需要提前在数据库中创建gogs_windows数据库</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image002.gif" alt="img"></p>
<p>第二步应用基本设置：</p>
<p>仓库目录可以设置在gogs的安装目录下</p>
<p>域名为虚拟域名，组长和组员在自己的hosts文件中配置该域名及对应的组长电脑的IP地址。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image004.gif" alt="img"></p>
<p>下边配置日志路径 ，日志路径可以设置在gogs的安装目录下</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image006.gif" alt="img"></p>
<p>下边配置管理员账号和密码：gogs&#x2F;gogs</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image008.gif" alt="img"></p>
<p>输入完毕点击立即安装</p>
<p>安装完毕自动跳转到 <a target="_blank" rel="noopener" href="http://group1.xuecheng.com:3000/">http://group1.xuecheng.com:3000/</a></p>
<p>组长使用管理员账号密码登录，登录后参考 学成在线项目开发环境配置文档去创建组织及仓库，仓库的代码是老师下发的实战基础代码。</p>
<p>组长为组员创建git账号，创建完成将账号和密码发给每位组员。</p>
<p>组员需要记住自己的git账号和密码，</p>
<h2 id="拉取代码"><a href="#拉取代码" class="headerlink" title="拉取代码"></a><strong>拉取代码</strong></h2><p>组员拉取本组git远程仓库的代码，根据任务分工开始协作开发。</p>
<p>例如：本组的git仓库地址为<a target="_blank" rel="noopener" href="http://group1.xuecheng.com:3000/xuecheng-plus-group01/xuecheng-plus-project.git">http://group1.xuecheng.com:3000/xuecheng-plus-group01/xuecheng-plus-project.git</a></p>
<p>本组全体成员拉取此仓库的代码，根据任务分工开始协作开发。</p>
<h1 id="删除课程计划"><a href="#删除课程计划" class="headerlink" title="删除课程计划"></a><strong>删除课程计划</strong></h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>课程计划添加成功，如果课程还没有提交时可以删除课程计划。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image010.gif" alt="img"></p>
<p>删除第一级别的大章节时要求大章节下边没有小章节时方可删除。</p>
<p>删除第二级别的小章节的同时需要将teachplan_media表关联的信息也删除。</p>
<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><ul>
<li>删除课程计划的接口示例如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">删除结点</span><br><span class="line">Request URL: /content/teachplan/<span class="number">246</span></span><br><span class="line">Request Method: DELETE</span><br><span class="line">如果失败：</span><br><span class="line">&#123;<span class="string">&quot;errCode&quot;</span>:<span class="string">&quot;120409&quot;</span>,<span class="string">&quot;errMessage&quot;</span>:<span class="string">&quot;课程计划信息还有子级信息，无法操作&quot;</span>&#125;</span><br><span class="line">如果成功：状态码<span class="number">200</span>，不返回信息</span><br></pre></td></tr></table></figure>

<p>我这里没管这个错误状态码，因为与之前编写的异常模型类不符合</p>
<ul>
<li>定义接口如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程计划删除&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/content/teachplan/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a>接口开发</h4><ul>
<li>定义删除课程计划的接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(Long teachplanId)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的接口实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(Long teachplanId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (teachplanId == <span class="literal">null</span>)</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程计划id为空&quot;</span>);</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line">    <span class="comment">// 判断当前课程计划是章还是节</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line">    <span class="comment">// 当前课程计划为章</span></span><br><span class="line">    <span class="keyword">if</span> (grade == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 查询当前课程计划下是否有小节</span></span><br><span class="line">        LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// select * from teachplan where parentid = &#123;当前章计划id&#125;</span></span><br><span class="line">        queryWrapper.eq(Teachplan::getParentid, teachplanId);</span><br><span class="line">        <span class="comment">// 获取一下查询的条目数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> teachplanMapper.selectCount(queryWrapper);</span><br><span class="line">        <span class="comment">// 如果当前章下还有小节，则抛异常</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程计划信息还有子级信息，无法操作&quot;</span>);</span><br><span class="line">        teachplanMapper.deleteById(teachplanId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 课程计划为节</span></span><br><span class="line">        teachplanMapper.deleteById(teachplanId);</span><br><span class="line">        LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(TeachplanMedia::getTeachplanId, teachplanId);</span><br><span class="line">        teachplanMediaMapper.delete(queryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>完善Controller层接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA</span><br><span class="line">复制成功<span class="meta">@ApiOperation(&quot;课程计划删除&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/teachplan/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">    teachplanService.deleteTeachplan(teachplanId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h4><ul>
<li>删除有子计划的章节</li>
<li>删除没有子计划的章节和小节</li>
<li>删除有媒资信息的小节后，去数据库中查看对应的媒资信息是否真的被删除</li>
</ul>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>删除课程计划的接口定义：</p>
<p>传入课程计划id进行删除操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Request URL: /content/teachplan/<span class="number">246</span></span><br><span class="line">Request Method: DELETE</span><br><span class="line"></span><br><span class="line">如果失败返回：</span><br><span class="line">&#123;<span class="string">&quot;errCode&quot;</span>:<span class="string">&quot;120409&quot;</span>,<span class="string">&quot;errMessage&quot;</span>:<span class="string">&quot;课程计划信息还有子级信息，无法操作&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">如果成功：状态码<span class="number">200</span>，不返回信息</span><br></pre></td></tr></table></figure>



<h2 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>首先使用httpclient工具进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 删除课程计划</span><br><span class="line">DELETE &#123;&#123;content_host&#125;&#125;/content/teachplan/<span class="number">43</span></span><br></pre></td></tr></table></figure>

<p>分以下情况测试：</p>
<p>1、删除大章节，大章节下有小章节时不允许删除。</p>
<p>2、删除大章节，大单节下没有小章节时可以正常删除。</p>
<p>3、删除小章节，同时将关联的信息进行删除。</p>
<h2 id="课程计划排序"><a href="#课程计划排序" class="headerlink" title="课程计划排序"></a><strong>课程计划排序</strong></h2><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>课程计划新增后默认排在同级别最后，课程计划排序功能是可以灵活调整课程计划的显示顺序，如下图：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image012.gif" alt="img"></p>
<p>上移表示将课程计划向上移动。</p>
<p>下移表示将课程计划向下移动。</p>
<p>向上移动后和上边同级的课程计划交换位置，可以将两个课程计划的排序字段值进行交换。</p>
<p>向下移动后和下边同级的课程计划交换位置，可以将两个课程计划的排序字段值进行交换。</p>
<h2 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>接口示例如下：</p>
<p>向下移动：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Request URL: http:<span class="comment">//localhost:8601/api/content/teachplan/movedown/43</span></span><br><span class="line">Request Method: POST</span><br></pre></td></tr></table></figure>

<p>参数1：movedown 为 移动类型，表示向下移动<br> 参数2：43为课程计划id</p>
<p>向上移动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">Request URL: http:<span class="comment">//localhost:8601/api/content/teachplan/moveup/43</span></span><br><span class="line">Request Method: POST</span><br></pre></td></tr></table></figure>

<p>参数1：moveup 为 移动类型，表示向上移动<br> 参数2：43为课程计划id</p>
<p>每次移动传递两个参数：</p>
<p>1、移动类型: movedown和moveup</p>
<p>2、课程计划id</p>
<ul>
<li>定义接口如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程计划排序&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/&#123;moveType&#125;/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> String moveType, <span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h4><ul>
<li>定义课程计划排序接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(String moveType, Long teachplanId)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>编写对应的实现方法<ul>
<li>写的稍微复杂了些，其实也可以简化，在lt和orderby的前面加上判断条件就可以，但是可读性会降低</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(String moveType, Long teachplanId)</span> &#123;</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line">    <span class="comment">// 获取层级和当前orderby，章节移动和小节移动的处理方式不同</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">orderby</span> <span class="operator">=</span> teachplan.getOrderby();</span><br><span class="line">    <span class="comment">// 章节移动是比较同一课程id下的orderby</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> teachplan.getCourseId();</span><br><span class="line">    <span class="comment">// 小节移动是比较同一章节id下的orderby</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">parentid</span> <span class="operator">=</span> teachplan.getParentid();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;moveup&quot;</span>.equals(moveType)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (grade == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 章节上移，找到上一个章节的orderby，然后与其交换orderby</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE courseId = 117 AND grade = 1  AND orderby &lt; 1 ORDER BY orderby DESC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getGrade, <span class="number">1</span>)</span><br><span class="line">                    .eq(Teachplan::getCourseId, courseId)</span><br><span class="line">                    .lt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByDesc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 小节上移</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE parentId = 268 AND orderby &lt; 5 ORDER BY orderby DESC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getParentid, parentid)</span><br><span class="line">                    .lt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByDesc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;movedown&quot;</span>.equals(moveType)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (grade == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 章节下移</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE courseId = 117 AND grade = 1 AND orderby &gt; 1 ORDER BY orderby ASC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getCourseId, courseId)</span><br><span class="line">                    .eq(Teachplan::getGrade, grade)</span><br><span class="line">                    .gt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByAsc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (grade == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 小节下移</span></span><br><span class="line">            <span class="comment">// SELECT * FROM teachplan WHERE parentId = 268 AND orderby &gt; 1 ORDER BY orderby ASC LIMIT 1</span></span><br><span class="line">            LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            queryWrapper.eq(Teachplan::getParentid, parentid)</span><br><span class="line">                    .gt(Teachplan::getOrderby, orderby)</span><br><span class="line">                    .orderByAsc(Teachplan::getOrderby)</span><br><span class="line">                    .last(<span class="string">&quot;LIMIT 1&quot;</span>);</span><br><span class="line">            <span class="type">Teachplan</span> <span class="variable">tmp</span> <span class="operator">=</span> teachplanMapper.selectOne(queryWrapper);</span><br><span class="line">            exchangeOrderby(teachplan, tmp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交换两个Teachplan的orderby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> teachplan </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tmp </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">exchangeOrderby</span><span class="params">(Teachplan teachplan, Teachplan tmp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp == <span class="literal">null</span>)</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;已经到头啦，不能再移啦&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 交换orderby，更新</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">orderby</span> <span class="operator">=</span> teachplan.getOrderby();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">tmpOrderby</span> <span class="operator">=</span> tmp.getOrderby();</span><br><span class="line">        teachplan.setOrderby(tmpOrderby);</span><br><span class="line">        tmp.setOrderby(orderby);</span><br><span class="line">        teachplanMapper.updateById(tmp);</span><br><span class="line">        teachplanMapper.updateById(teachplan);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>完善Controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程计划排序&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/&#123;moveType&#125;/&#123;teachplanId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderByTeachplan</span><span class="params">(<span class="meta">@PathVariable</span> String moveType, <span class="meta">@PathVariable</span> Long teachplanId)</span> &#123;</span><br><span class="line">    teachplanService.orderByTeachplan(moveType, teachplanId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>该功能可直接进行前后端联调，可以立即看到 效果。</p>
<p>1、向上移动测试</p>
<p> 先找一个上边有课程计划的进行测试，向上移动后两个交换顺序。</p>
<p>再找最上边的课程计划向上移动，操作后位置不变因为已经在最上边了。</p>
<p>2、向下移动测试</p>
<p>先找一个下边有课程计划的进行测试，向下移动后两个交换顺序。</p>
<p>再找最下边的课程计划向下移动，操作后位置不变因为已经在最下边了。</p>
<h2 id="师资管理"><a href="#师资管理" class="headerlink" title="师资管理"></a><strong>师资管理</strong></h2><h2 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>在课程计划维护界面点击下一步进入师资管理界面：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image014.gif" alt="img"></p>
<p>点击添加教师打开添加界面，如下图，不用实现上传照片。</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image016.gif" alt="img"></p>
<p>添加成功查询教师信息如下：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image018.gif" alt="img"></p>
<p>在这个界面可以删除老师，也可以点击编辑，修改教师信息：</p>
<p><img src="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/clip_image020.gif" alt="img"></p>
<p>注意：</p>
<p>只允许向机构自己的课程中添加老师、删除老师。</p>
<p>机构id统一使用：1232141425L</p>
<h2 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><h2 id="查询教师接口请求示例"><a href="#查询教师接口请求示例" class="headerlink" title="查询教师接口请求示例"></a>查询教师接口请求示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">get /courseTeacher/list/<span class="number">75</span></span><br><span class="line"><span class="number">75</span>为课程id，请求参数为课程id</span><br><span class="line"></span><br><span class="line">响应结果</span><br><span class="line">[&#123;<span class="string">&quot;id&quot;</span>:<span class="number">23</span>,<span class="string">&quot;courseId&quot;</span>:<span class="number">75</span>,<span class="string">&quot;teacherName&quot;</span>:<span class="string">&quot;张老师&quot;</span>,<span class="string">&quot;position&quot;</span>:<span class="string">&quot;讲师&quot;</span>,<span class="string">&quot;introduction&quot;</span>:<span class="string">&quot;张老师教师简介张老师教师简介张老师教师简介张老师教师简介&quot;</span>,<span class="string">&quot;photograph&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;createDate&quot;</span>:<span class="literal">null</span>&#125;]</span><br></pre></td></tr></table></figure>



<p>2、添加教师请求示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">post  /courseTeacher</span><br><span class="line"></span><br><span class="line">请求参数：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span>: <span class="number">75</span>,</span><br><span class="line">  <span class="string">&quot;teacherName&quot;</span>: <span class="string">&quot;王老师&quot;</span>,</span><br><span class="line">  <span class="string">&quot;position&quot;</span>: <span class="string">&quot;教师职位&quot;</span>,</span><br><span class="line">  <span class="string">&quot;introduction&quot;</span>: <span class="string">&quot;教师简介&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">响应结果：</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="number">24</span>,<span class="string">&quot;courseId&quot;</span>:<span class="number">75</span>,<span class="string">&quot;teacherName&quot;</span>:<span class="string">&quot;王老师&quot;</span>,<span class="string">&quot;position&quot;</span>:<span class="string">&quot;教师职位&quot;</span>,<span class="string">&quot;introduction&quot;</span>:<span class="string">&quot;教师简介&quot;</span>,<span class="string">&quot;photograph&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;createDate&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure>

<p>3、修改教师</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">put /courseTeacher</span><br><span class="line">请求参数：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span>: <span class="number">75</span>,</span><br><span class="line">  <span class="string">&quot;teacherName&quot;</span>: <span class="string">&quot;王老师&quot;</span>,</span><br><span class="line">  <span class="string">&quot;position&quot;</span>: <span class="string">&quot;教师职位&quot;</span>,</span><br><span class="line">  <span class="string">&quot;introduction&quot;</span>: <span class="string">&quot;教师简介&quot;</span>,</span><br><span class="line">  <span class="string">&quot;photograph&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;createDate&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">响应：</span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="number">24</span>,<span class="string">&quot;courseId&quot;</span>:<span class="number">75</span>,<span class="string">&quot;teacherName&quot;</span>:<span class="string">&quot;王老师&quot;</span>,<span class="string">&quot;position&quot;</span>:<span class="string">&quot;教师职位&quot;</span>,<span class="string">&quot;introduction&quot;</span>:<span class="string">&quot;教师简介&quot;</span>,<span class="string">&quot;photograph&quot;</span>:<span class="literal">null</span>,<span class="string">&quot;createDate&quot;</span>:<span class="literal">null</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、删除教师</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">delete /ourseTeacher/course/<span class="number">75</span>/<span class="number">26</span></span><br><span class="line"></span><br><span class="line"><span class="number">75</span>:课程id</span><br><span class="line"><span class="number">26</span>:教师id，即course_teacher表的主键</span><br><span class="line">请求参数：课程id、教师id</span><br><span class="line"></span><br><span class="line">响应：状态码<span class="number">200</span>，不返回信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="接口测试-3"><a href="#接口测试-3" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、添加教师</p>
<p>2、查询教师</p>
<p>3、修改教师</p>
<p>4、删除教师</p>
<h2 id="删除课程"><a href="#删除课程" class="headerlink" title="删除课程"></a><strong>删除课程</strong></h2><h2 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><p>课程的审核状态为未提交时方可删除。</p>
<p>删除课程需要删除课程相关的基本信息、营销信息、课程计划、课程教师信息。</p>
<h2 id="接口定义-4"><a href="#接口定义-4" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>删除课程接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">delete  /course/<span class="number">87</span></span><br><span class="line"><span class="number">87</span>为课程id</span><br><span class="line">请求参数：课程id</span><br><span class="line">响应：状态码<span class="number">200</span>，不返回信息</span><br></pre></td></tr></table></figure>



<h2 id="接口测试-4"><a href="#接口测试-4" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>找到一门课程进行删除，删除后从数据库确认课程基本信息、课程营销信息、课程计划、课程计划关联信息、课程师资是否删除成功。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/" itemprop="url">学成在线-day04-JSR303校验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-19T21:06:53+08:00">
                2024-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.9k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  37
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JSR303校验"><a href="#JSR303校验" class="headerlink" title="JSR303校验"></a>JSR303校验</h2><h2 id="统一校验的需求"><a href="#统一校验的需求" class="headerlink" title="统一校验的需求"></a><strong>统一校验的需求</strong></h2><p>前端请求后端接口传输参数，是在controller中校验还是在Service中校验？</p>
<p>答案是都需要校验，只是分工不同。</p>
<p>Contoller中校验请求参数的合法性，包括：必填项校验，数据格式校验，比如：是否是符合一定的日期格式，等。</p>
<p>Service中要校验的是业务规则相关的内容，比如：课程已经审核通过所以提交失败。</p>
<p>Service中根据业务规则去校验不方便写成通用代码，Controller中则可以将校验的代码写成通用代码。</p>
<p>早在JavaEE6规范中就定义了参数校验的规范，它就是JSR-303，它定义了Bean Validation，即对bean属性进行校验。</p>
<p>SpringBoot提供了JSR-303的支持，它就是spring-boot-starter-validation，它的底层使用Hibernate Validator，Hibernate Validator是Bean Validation 的参考实现。</p>
<p>所以，我们准备在Controller层使用spring-boot-starter-validation完成对请求参数的基本合法性进行校验。</p>
<h2 id="统一校验实现"><a href="#统一校验实现" class="headerlink" title="统一校验实现"></a><strong>统一校验实现</strong></h2><p>首先在Base工程添加spring-boot-starter-validation的依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在javax.validation.constraints包下有很多这样的校验注解，直接使用注解定义校验规则即可。</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image028.gif" alt="img"></p>
<p>规则如下：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image030.gif" alt="img"></p>
<p>现在准备对内容管理模块添加课程接口进行参数校验，如下接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此接口使用AddCourseDto模型对象接收参数，所以进入AddCourseDto类，在属性上添加校验规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 添加课程dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 17:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;AddCourseDto&quot;, description=&quot;新增课程基本信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddCourseDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;适用人群不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@Size(message = &quot;适用人群内容过少&quot;,min = 10)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;适用人群&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String users;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程标签&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;大分类&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String mt;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程分类不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;小分类&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String st;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;课程等级不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程等级&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String grade;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;教学模式（普通，录播，直播等）&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String teachmode;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程介绍&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程图片&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String pic;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@NotEmpty(message = &quot;收费规则不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;收费规则，对应数据字典&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String charge;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;价格&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上边用到了@NotEmpty和@Size两个注解，@NotEmpty表示属性不能为空，@Size表示限制属性内容的长短。</p>
<p>定义好校验规则还需要开启校验，在controller方法中添加@Validated注解，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果校验出错Spring会抛出MethodArgumentNotValidException异常，我们需要在统一异常处理器中捕获异常，解析出异常信息。</p>
<p>代码 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line"><span class="keyword">public</span> RestErrorResponse <span class="title function_">methodArgumentNotValidException</span><span class="params">(MethodArgumentNotValidException e)</span> &#123;</span><br><span class="line">    <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> e.getBindingResult();</span><br><span class="line">    List&lt;String&gt; msgList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//将错误信息放在msgList</span></span><br><span class="line">    bindingResult.getFieldErrors().stream().forEach(item-&gt;msgList.add(item.getDefaultMessage()));</span><br><span class="line">    <span class="comment">//拼接错误信息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> StringUtils.join(msgList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">    log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启内容管理服务。</p>
<p>使用httpclient进行测试，将必填项设置为空，“适用人群” 属性的内容设置1个字。</p>
<p>执行测试，接口响应结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;errMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;课程名称不能为空,课程分类不能为空,课程分类不能为空,适用人群内容过少&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到校验器生效。</p>
<h2 id="分组校验"><a href="#分组校验" class="headerlink" title="分组校验"></a><strong>分组校验</strong></h2><p>有时候在同一个属性上设置一个校验规则不能满足要求，比如：订单编号由系统生成，在添加订单时要求订单编号为空，在更新 订单时要求订单编写不能为空。此时就用到了分组校验，同一个属性定义多个校验规则属于不同的分组，比如：添加订单定义@NULL规则属于insert分组，更新订单定义@NotEmpty规则属于update分组，insert和update是分组的名称，是可以修改的。</p>
<p>下边举例说明</p>
<p>我们用class类型来表示不同的分组，所以我们定义不同的接口类型（空接口）表示不同的分组，由于校验分组是公用的，所以定义在 base工程中。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 校验分组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/8 15:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidationGroups</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Inster</span>&#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Update</span>&#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Delete</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>下边在定义校验规则时指定分组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotEmpty(groups = &#123;ValidationGroups.Inster.class&#125;,message = &quot;添加课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@NotEmpty(groups = &#123;ValidationGroups.Update.class&#125;,message = &quot;修改课程名称不能为空&quot;)</span></span><br><span class="line"><span class="comment">// @NotEmpty(message = &quot;课程名称不能为空&quot;)</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程名称&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>

<p>在Controller方法中启动校验规则指定要使用的分组名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated(&#123;ValidationGroups.Inster.class&#125;)</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>再次测试，由于这里指定了Insert分组，所以抛出 异常信息：添加课程名称不能为空。</p>
<p>如果修改分组为ValidationGroups.Update.class，异常信息为：修改课程名称不能为空。</p>
<h2 id="校验规则不满足？"><a href="#校验规则不满足？" class="headerlink" title="校验规则不满足？"></a><strong>校验规则不满足？</strong></h2><p>如果javax.validation.constraints包下的校验规则满足不了需求怎么办？</p>
<p>1、手写校验代码 。</p>
<p>2、自定义校验规则注解。</p>
<p>如何自定义校验规则注解，请自行查阅资料实现。</p>
<h1 id="【面试】请求参数的合法性校验如何做？"><a href="#【面试】请求参数的合法性校验如何做？" class="headerlink" title="【面试】请求参数的合法性校验如何做？"></a>【面试】请求参数的合法性校验如何做？</h1><p>1、请求参数的合法性校验如何做?</p>
<p>使用基于ISR303的校验框架实现，SpringBoot提供了ISR-303的支持，它就是spring-boot-starter-validation，它包括了很多校验规则，只需要在模型类中通过注解指定校验规则，在controller方法上开启校验。</p>
<h1 id="修改课程"><a href="#修改课程" class="headerlink" title="修改课程"></a><strong>修改课程</strong></h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>1、进入课程列表查询</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image002.gif" alt="img"></p>
<p>2、点击编辑</p>
<p>因为课程审核通过方可发布，任何时候都 可以编辑，下图是编辑课程的界面：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image004.gif" alt="img"></p>
<p>进入编辑界面显示出当前课程的信息。</p>
<p>3、修改成功自动进入课程计划编辑页面。</p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>修改课程的涉及到的数据表是课程基本信息表</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image006.gif" alt="img"></p>
<p>课程营销信息表：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image008.gif" alt="img"></p>
<p>1、进入课程编辑界面</p>
<p>界面中显示了课程的当前信息，需要根据课程id查询课程基本和课程营销信息，显示在表单上。</p>
<p>2、编辑、提交</p>
<p>修改课程提交的数据比新增课程多了一项课程id，因为修改课程需要针对某个课程进行修改。</p>
<p>3、保存数据</p>
<p>编辑完成保存课程基础信息和课程营销信息。</p>
<p>更新课程基本信息表中的修改人、修改时间。</p>
<h2 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><h2 id="查询课程信息"><a href="#查询课程信息" class="headerlink" title="查询课程信息"></a><strong>查询课程信息</strong></h2><p>定义根据课程id查询课程信息接口。</p>
<p>接口示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET /content/course/<span class="number">40</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line">#响应结果</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>

<p>查询结果为单条课程信息，内容和新增课程返回结果一致，所以采用与新增课程一致的模型类。</p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseById</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="修改课程信息"><a href="#修改课程信息" class="headerlink" title="修改课程信息"></a><strong>修改课程信息</strong></h2><p>根据前边的数据模型分析，修改课程提交的数据比新增多了课程id，接口示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT /content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###修改成功响应结果如下</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>



<p>这里定义修改课程提交的数据模型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.ValidationGroups;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 添加课程dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 17:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;EditCourseDto&quot;, description=&quot;修改课程基本信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EditCourseDto</span> <span class="keyword">extends</span> <span class="title class_">AddCourseDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@ApiModelProperty(value = &quot;课程id&quot;, required = true)</span></span><br><span class="line"> <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>修改后返回最新课程信息，采用与新增课程接口返回类型一致的数据模型。</p>
<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;修改课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">modifyCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> EditCourseDto editCourseDto)</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="查询课程信息-1"><a href="#查询课程信息-1" class="headerlink" title="查询课程信息"></a><strong>查询课程信息</strong></h2><p>查询课程信息的Service方法在新增课程接口开发中已实现，无需实现，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据课程id查询课程基本信息，包括基本信息和营销信息</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseInfo</span><span class="params">(<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(courseBase == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询营销信息</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">//要返回的对象</span></span><br><span class="line">    <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfoDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(courseBase,courseBaseInfoDto);</span><br><span class="line">    <span class="keyword">if</span>(courseMarket != <span class="literal">null</span>)&#123;</span><br><span class="line">        BeanUtils.copyProperties(courseMarket,courseBaseInfoDto);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询分类名称</span></span><br><span class="line">    <span class="type">CourseCategory</span> <span class="variable">courseCategoryBySt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getSt());</span><br><span class="line">    courseBaseInfoDto.setStName(courseCategoryBySt.getName());</span><br><span class="line">    <span class="type">CourseCategory</span> <span class="variable">courseCategoryByMt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getMt());</span><br><span class="line">    courseBaseInfoDto.setMtName(courseCategoryByMt.getName());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoDto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>需要将查询课程信息的方法提到接口上，这样在controller中通过接口调用此方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseBaseInfoService</span> &#123;</span><br><span class="line">    ....</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据id查询课程基本信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CourseBaseInfoDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/9 8:13</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseInfo</span><span class="params">(<span class="type">long</span> courseId)</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>完善接口层代码 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据课程id查询课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseById</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试查询课程</p>
<p>用httpclient测试查询课程接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">### 查询课程信息</span><br><span class="line">GET /content/course/<span class="number">40</span></span><br></pre></td></tr></table></figure>

<h2 id="修改课程信息-1"><a href="#修改课程信息-1" class="headerlink" title="修改课程信息"></a><strong>修改课程信息</strong></h2><p>修改Service修改课程的接口与方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 修改课程信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dto  课程信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CourseBaseInfoDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/8 21:04</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">updateCourseBase</span><span class="params">(Long companyId,EditCourseDto dto)</span>;</span><br></pre></td></tr></table></figure>



<p>实现方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">updateCourseBase</span><span class="params">(Long companyId, EditCourseDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> dto.getId();</span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(courseBase==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验本机构只能修改本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span>(!courseBase.getCompanyId().equals(companyId))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;本机构只能修改本机构的课程&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装基本信息的数据</span></span><br><span class="line">    BeanUtils.copyProperties(dto,courseBase);</span><br><span class="line">    courseBase.setChangeDate(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新课程基本信息</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> courseBaseMapper.updateById(courseBase);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装营销信息的数据</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseMarket</span>();</span><br><span class="line">    BeanUtils.copyProperties(dto,courseMarket);</span><br><span class="line">    saveCourseMarket(courseMarket);</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getCourseBaseInfo(courseId);</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfo;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>最后完善接口层代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;修改课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">modifyCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> EditCourseDto editCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    <span class="keyword">return</span> courseBaseInfoService.updateCourseBase(companyId,editCourseDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>接口开发完成进行测试，使用httpclient测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">### 根据课程id查询课程信息</span><br><span class="line">GET &#123;&#123;content_host&#125;&#125;/content/course/<span class="number">40</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line">#响应结果</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">### 修改课程</span><br><span class="line">PUT &#123;&#123;content_host&#125;&#125;/content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###修改成功响应结果如下</span><br><span class="line">#&#123;</span><br><span class="line">#  <span class="string">&quot;id&quot;</span>: <span class="number">40</span>,</span><br><span class="line">#  <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">#  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;SpringBoot核心&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;Spring Boot初学者&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;Spring项目的快速构建&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-3&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-3-2&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;200003&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;课程系统性地深度探讨 Spring Boot 核心特性，引导小伙伴对 Java 规范的重视，启发对技术原理性的思考，掌握排查问题的技能，以及学习阅读源码的方法和技巧，全面提升研发能力，进军架构师队伍。&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2019-09-10 16:05:39&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2022-09-09 07:27:48&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202004&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;203001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubId&quot;</span>: <span class="number">21</span>,</span><br><span class="line">#  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">#  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line">#  <span class="string">&quot;price&quot;</span>: <span class="number">0.01</span></span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>

<p>前端开发完毕进行前后端接口联调。</p>
<p>过程略。</p>
<h1 id="查询课程计划"><a href="#查询课程计划" class="headerlink" title="查询课程计划"></a><strong>查询课程计划</strong></h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>课程基本信息添加或修改成功将自动进入课程计划编辑器界面，如下图：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image002-17109136929071.gif" alt="img"></p>
<p>课程计划即课程的大纲目录。</p>
<p>课程计划分为两级：大章节和小章节。</p>
<p>本小节完成课程计划信息的查询。</p>
<h2 id="数据模型-1"><a href="#数据模型-1" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>从课程计划查询界面上可以看出整体上是 一个树型结构，课程计划表teachplan如下：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image004-17109136929072.gif" alt="img"></p>
<p>每个课程计划都有所属课程。</p>
<p>每个课程的课程计划有两个级别，第一级为大章节，grade为1、第二级为小章节，grade为2</p>
<p>3。第二级的parentid为第一级的id。</p>
<p>课程计划的显示顺序根据排序字段去显示。</p>
<p>根据业务流程中的界面原型，课程计划列表展示时还有课程计划关联的视频信息。</p>
<p>课程计划关联的视频信息在teachplan_media表，结构如下：</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image006-17109136929083.gif" alt="img"></p>
<p>两张表是一对一关系，每个课程计划只能在teachplan_media表中存在一个视频。</p>
<p>从课程资料目录下的db目录中，从xcplus_content.sql文件中找到课程计划表teachplan、teachplan_media表的建表语句以及数据初始化语句，并通过mysql客户端去执行脚本。</p>
<p>这里使用DataGrid 客户端工具连接mysql并执行脚本。</p>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>接口示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">GET /teachplan/<span class="number">22</span>/tree-nodes</span><br><span class="line"></span><br><span class="line"> [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">        <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mediaType&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;parentid&quot;</span> : <span class="number">112</span>,</span><br><span class="line">        <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1章基础知识&quot;</span>,</span><br><span class="line">        <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">113</span>,</span><br><span class="line">        <span class="string">&quot;teachPlanTreeNodes&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;001002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;parentid&quot;</span> : <span class="number">113</span>,</span><br><span class="line">                <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1节项目概述&quot;</span>,</span><br><span class="line">                <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span> : <span class="number">115</span>,</span><br><span class="line">                <span class="string">&quot;teachPlanTreeNodes&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;teachplanMedia&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                    <span class="string">&quot;coursePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                    <span class="string">&quot;mediaFilename&quot;</span> : <span class="string">&quot;2.avi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mediaId&quot;</span> : <span class="number">41</span>,</span><br><span class="line">                    <span class="string">&quot;teachplanId&quot;</span> : <span class="number">115</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span> : <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;teachplanMedia&quot;</span> : <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">        <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;parentid&quot;</span> : <span class="number">112</span>,</span><br><span class="line">        <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第2章快速入门&quot;</span>,</span><br><span class="line">        <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">242</span>,</span><br><span class="line">        <span class="string">&quot;teachPlanTreeNodes&quot;</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;001002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orderby&quot;</span> : <span class="number">2</span>,</span><br><span class="line">                <span class="string">&quot;parentid&quot;</span> : <span class="number">242</span>,</span><br><span class="line">                <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1节搭建环境&quot;</span>,</span><br><span class="line">                <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span> : <span class="number">244</span>,</span><br><span class="line">                <span class="string">&quot;teachPlanTreeNodes&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;teachplanMedia&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                    <span class="string">&quot;coursePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                    <span class="string">&quot;mediaFilename&quot;</span> : <span class="string">&quot;3.avi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mediaId&quot;</span> : <span class="number">42</span>,</span><br><span class="line">                    <span class="string">&quot;teachplanId&quot;</span> : <span class="number">244</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span> : <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;001002&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orderby&quot;</span> : <span class="number">3</span>,</span><br><span class="line">                <span class="string">&quot;parentid&quot;</span> : <span class="number">242</span>,</span><br><span class="line">                <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第2节项目概述&quot;</span>,</span><br><span class="line">                <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span> : <span class="number">245</span>,</span><br><span class="line">                <span class="string">&quot;teachPlanTreeNodes&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;teachplanMedia&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">                    <span class="string">&quot;coursePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">                    <span class="string">&quot;mediaFilename&quot;</span> : <span class="string">&quot;1a.avi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;mediaId&quot;</span> : <span class="number">39</span>,</span><br><span class="line">                    <span class="string">&quot;teachplanId&quot;</span> : <span class="number">245</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span> : <span class="literal">null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;teachplanMedia&quot;</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>查询课程计划的请求参数：课程id</p>
<p>响应结果需要自定义模型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.Teachplan;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.TeachplanMedia;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程计划树型结构dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 10:27</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeachplanDto</span> <span class="keyword">extends</span> <span class="title class_">Teachplan</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程计划关联的媒资信息</span></span><br><span class="line">  TeachplanMedia teachplanMedia;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//子结点</span></span><br><span class="line">  List&lt;TeachplanDto&gt; teachPlanTreeNodes;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiImplicitParam;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程计划编辑接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Api(value = &quot;课程计划编辑接口&quot;,tags = &quot;课程计划编辑接口&quot;)</span></span><br><span class="line"> <span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeachplanController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查询课程计划树形结构&quot;)</span></span><br><span class="line">    <span class="meta">@ApiImplicitParam(value = &quot;courseId&quot;,name = &quot;课程Id&quot;,required = true,dataType = &quot;Long&quot;,paramType = &quot;path&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/teachplan/&#123;courseId&#125;/tree-nodes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">getTreeNodes</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="DAO开发"><a href="#DAO开发" class="headerlink" title="DAO开发"></a>DAO开发</h2><p>Mapper接口使用sql查询课程计划，组成一个树型结构。</p>
<p>在TeachplanMapper自定义方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeachplanMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Teachplan&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询某课程的课程计划，组成树型结构 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.content.model.dto.TeachplanDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/9 11:10</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">selectTreeNodes</span><span class="params">(<span class="type">long</span> courseId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义mapper.xml中的sql语句，分析如下：</p>
<p>1、一级分类和二级分类通过teachplan表的自链接进行，如果只有一级分类其下边没有二级分类，此时也需要显示一级分类，这里使用左连接，左边是一级分类，右边是二级分类。</p>
<p>2、由于当还没有关联 视频时teachplan_media对应的记录为空，所以需要teachplan和teachplan_media左链接。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">            one.id             one_id,</span><br><span class="line">            one.pname          one_pname,</span><br><span class="line">            one.parentid       one_parentid,</span><br><span class="line">            one.grade          one_grade,</span><br><span class="line">            one.media_type     one_mediaType,</span><br><span class="line">            one.start_time     one_stratTime,</span><br><span class="line">            one.end_time       one_endTime,</span><br><span class="line">            one.orderby        one_orderby,</span><br><span class="line">            one.course_id      one_courseId,</span><br><span class="line">            one.course_pub_id  one_coursePubId,</span><br><span class="line">            two.id             two_id,</span><br><span class="line">            two.pname          two_pname,</span><br><span class="line">            two.parentid       two_parentid,</span><br><span class="line">            two.grade          two_grade,</span><br><span class="line">            two.media_type     two_mediaType,</span><br><span class="line">            two.start_time     two_stratTime,</span><br><span class="line">            two.end_time       two_endTime,</span><br><span class="line">            two.orderby        two_orderby,</span><br><span class="line">            two.course_id      two_courseId,</span><br><span class="line">            two.course_pub_id  two_coursePubId,</span><br><span class="line">            m1.media_fileName mediaFilename,</span><br><span class="line">            m1.id teachplanMeidaId,</span><br><span class="line">            m1.media_id mediaId</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> teachplan <span class="keyword">one</span></span><br><span class="line">                 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> teachplan two <span class="keyword">on</span> one.id <span class="operator">=</span> two.parentid</span><br><span class="line">                 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> teachplan_media m1 <span class="keyword">on</span> m1.teachplan_id <span class="operator">=</span> two.id</span><br><span class="line">        <span class="keyword">where</span> one.parentid <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> one.course_id<span class="operator">=</span>#&#123;<span class="keyword">value</span>&#125;</span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> one.orderby,</span><br><span class="line">                 two.orderby</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>定义mapper.xml</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 课程分类树型结构查询映射结果 --&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>resultMap id<span class="operator">=</span>&quot;treeNodeResultMap&quot; type<span class="operator">=</span>&quot;com.xuecheng.content.model.dto.TeachplanDto&quot;<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 一级数据映射 --&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span>id     <span class="keyword">column</span><span class="operator">=</span>&quot;one_id&quot;        property<span class="operator">=</span>&quot;id&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_pname&quot;      property<span class="operator">=</span>&quot;pname&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_parentid&quot;     property<span class="operator">=</span>&quot;parentid&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_grade&quot;  property<span class="operator">=</span>&quot;grade&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_mediaType&quot;   property<span class="operator">=</span>&quot;mediaType&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_stratTime&quot;   property<span class="operator">=</span>&quot;stratTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_endTime&quot;   property<span class="operator">=</span>&quot;endTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_orderby&quot;   property<span class="operator">=</span>&quot;orderby&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_courseId&quot;   property<span class="operator">=</span>&quot;courseId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;one_coursePubId&quot;   property<span class="operator">=</span>&quot;coursePubId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 一级中包含多个二级数据 --&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span>collection property<span class="operator">=</span>&quot;teachPlanTreeNodes&quot; ofType<span class="operator">=</span>&quot;com.xuecheng.content.model.dto.TeachplanDto&quot;<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">-- 二级数据映射 --&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>id     <span class="keyword">column</span><span class="operator">=</span>&quot;two_id&quot;        property<span class="operator">=</span>&quot;id&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_pname&quot;      property<span class="operator">=</span>&quot;pname&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_parentid&quot;     property<span class="operator">=</span>&quot;parentid&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_grade&quot;  property<span class="operator">=</span>&quot;grade&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_mediaType&quot;   property<span class="operator">=</span>&quot;mediaType&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_stratTime&quot;   property<span class="operator">=</span>&quot;stratTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_endTime&quot;   property<span class="operator">=</span>&quot;endTime&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_orderby&quot;   property<span class="operator">=</span>&quot;orderby&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_courseId&quot;   property<span class="operator">=</span>&quot;courseId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_coursePubId&quot;   property<span class="operator">=</span>&quot;coursePubId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>association property<span class="operator">=</span>&quot;teachplanMedia&quot; javaType<span class="operator">=</span>&quot;com.xuecheng.content.model.po.TeachplanMedia&quot;<span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;teachplanMeidaId&quot;   property<span class="operator">=</span>&quot;id&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;mediaFilename&quot;   property<span class="operator">=</span>&quot;mediaFilename&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;mediaId&quot;   property<span class="operator">=</span>&quot;mediaId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_id&quot;   property<span class="operator">=</span>&quot;teachplanId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_courseId&quot;   property<span class="operator">=</span>&quot;courseId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">                <span class="operator">&lt;</span><span class="keyword">result</span> <span class="keyword">column</span><span class="operator">=</span>&quot;two_coursePubId&quot;   property<span class="operator">=</span>&quot;coursePubId&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span><span class="operator">/</span>association<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">/</span>collection<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span>resultMap<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">!</span><span class="comment">--课程计划树型结构查询--&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectTreeNodes&quot; resultMap<span class="operator">=</span>&quot;treeNodeResultMap&quot; parameterType<span class="operator">=</span>&quot;long&quot; <span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            one.id             one_id,</span><br><span class="line">            one.pname          one_pname,</span><br><span class="line">            one.parentid       one_parentid,</span><br><span class="line">            one.grade          one_grade,</span><br><span class="line">            one.media_type     one_mediaType,</span><br><span class="line">            one.start_time     one_stratTime,</span><br><span class="line">            one.end_time       one_endTime,</span><br><span class="line">            one.orderby        one_orderby,</span><br><span class="line">            one.course_id      one_courseId,</span><br><span class="line">            one.course_pub_id  one_coursePubId,</span><br><span class="line">            two.id             two_id,</span><br><span class="line">            two.pname          two_pname,</span><br><span class="line">            two.parentid       two_parentid,</span><br><span class="line">            two.grade          two_grade,</span><br><span class="line">            two.media_type     two_mediaType,</span><br><span class="line">            two.start_time     two_stratTime,</span><br><span class="line">            two.end_time       two_endTime,</span><br><span class="line">            two.orderby        two_orderby,</span><br><span class="line">            two.course_id      two_courseId,</span><br><span class="line">            two.course_pub_id  two_coursePubId,</span><br><span class="line">            m1.media_fileName mediaFilename,</span><br><span class="line">            m1.id teachplanMeidaId,</span><br><span class="line">            m1.media_id mediaId</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> teachplan <span class="keyword">one</span></span><br><span class="line">                 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> teachplan two <span class="keyword">on</span> one.id <span class="operator">=</span> two.parentid</span><br><span class="line">                 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> teachplan_media m1 <span class="keyword">on</span> m1.teachplan_id <span class="operator">=</span> two.id</span><br><span class="line">        <span class="keyword">where</span> one.parentid <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> one.course_id<span class="operator">=</span>#&#123;<span class="keyword">value</span>&#125;</span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> one.orderby,</span><br><span class="line">                 two.orderby</span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>单元测试方法，略。</p>
<h2 id="Service开发"><a href="#Service开发" class="headerlink" title="Service开发"></a>Service开发</h2><p>定义service接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.*;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程基本信息管理业务接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 21:42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TeachplanService</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 查询课程计划树型结构</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;TeachplanDto&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 11:13</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">findTeachplanTree</span><span class="params">(<span class="type">long</span> courseId)</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>定义service接口实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.mapper.TeachplanMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.TeachplanService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程计划service接口实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 11:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TeachplanServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">TeachplanService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line"> TeachplanMapper teachplanMapper;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">findTeachplanTree</span><span class="params">(<span class="type">long</span> courseId)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> teachplanMapper.selectTreeNodes(courseId);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、完善接口层代码 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">TeachplanService teachplanService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询课程计划树形结构&quot;)</span></span><br><span class="line"><span class="meta">@ApiImplicitParam(value = &quot;courseId&quot;,name = &quot;课程基础Id值&quot;,required = true,dataType = &quot;Long&quot;,paramType = &quot;path&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;teachplan/&#123;courseId&#125;/tree-nodes&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;TeachplanDto&gt; <span class="title function_">getTreeNodes</span><span class="params">(<span class="meta">@PathVariable</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> teachplanService.findTeachplanTree(courseId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2、使用httpclient测试</p>
<p>找一个有课程计划的课程进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 查询某个课程的课程计划</span><br><span class="line">GET &#123;&#123;content_host&#125;&#125;/content/teachplan/<span class="number">74</span>/tree-nodes</span><br></pre></td></tr></table></figure>

<p>3、前后端联调</p>
<p>1）进入课程编辑页面</p>
<p>2）保存进入下一步</p>
<p>观察课程计划获取是否成功。</p>
<p>1）进入新增课程页面</p>
<p>2）新增课程成功，自动进入课程计划编辑界面。</p>
<p>由于是新增的课程，课程计划为空。</p>
<h1 id="新增-修改计划"><a href="#新增-修改计划" class="headerlink" title="新增&#x2F;修改计划"></a><strong>新增&#x2F;修改计划</strong></h1><h2 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>1、进入课程计划界面</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image002-17109233290917.gif" alt="img"></p>
<p>2、点击“添加章”新增第一级课程计划。</p>
<p>新增成功自动刷新课程计划列表。</p>
<p>3、点击“添加小节”向某个第一级课程计划下添加小节。</p>
<p>新增成功自动刷新课程计划列表。</p>
<p>新增的课程计划自动排序到最后。</p>
<p>4、点击“章”、“节”的名称，可以修改名称、选择是否免费。</p>
<p><img src="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/clip_image004-17109233290928.gif" alt="img"></p>
<h2 id="数据模型-2"><a href="#数据模型-2" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>1、新增第一级课程计划</p>
<p>名称默认为：新章名称 [点击修改]</p>
<p>grade：1</p>
<p>orderby: 所属课程中同级别下排在最后</p>
<p>2、新增第二级课程计划</p>
<p>名称默认为：新小节名称 [点击修改]</p>
<p>grade：2</p>
<p>orderby: 所属课程计划中排在最后</p>
<p>3、修改第一级、第二级课程计划的名称，修改第二级课程计划是否免费</p>
<h2 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>接口示例如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程计划--章,当grade为<span class="number">1</span>时parentid为<span class="number">0</span></span><br><span class="line">POST /teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;新章名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">### 新增课程计划--节</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">247</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;小节名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同一个接口接收新增和修改两个业务请求，以是否传递课程计划id 来判断是新增还是修改。</p>
<p>如果传递了课程计划id说明当前是要修改该课程计划，否则是新增一个课程计划。</p>
<p>定义接收请求参数的数据模型类：</p>
<p>定义SaveTeachplanDto</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.Teachplan;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.TeachplanMedia;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存课程计划dto，包括新增、修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/9 10:27</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveTeachplanDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/***</span></span><br><span class="line"><span class="comment">  * 教学计划id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程计划名称</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String pname;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程计划父级Id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long parentid;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 层级，分为1、2、3级</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Integer grade;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程类型:1视频、2文档</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String mediaType;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程标识</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long courseId;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 课程发布标识</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long coursePubId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 是否支持试学或预览（试看）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String isPreview;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程计划创建或修改&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">( <span class="meta">@RequestBody</span> SaveTeachplanDto teachplan)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发-2"><a href="#接口开发-2" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="Mapper开发"><a href="#Mapper开发" class="headerlink" title="Mapper开发"></a>Mapper开发</h2><p>根据业务的分析，Mapper使用自动生成的mapper即可满足要求。</p>
<h2 id="Service开发-1"><a href="#Service开发-1" class="headerlink" title="Service开发"></a>Service开发</h2><p>定义保存课程计划的Service接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 只在课程计划</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> teachplanDto  课程计划信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/9 13:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">(SaveTeachplanDto teachplanDto)</span>;</span><br></pre></td></tr></table></figure>

<p>编写接口实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">(SaveTeachplanDto teachplanDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//课程计划id</span></span><br><span class="line">  <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> teachplanDto.getId();</span><br><span class="line">  <span class="comment">//修改课程计划</span></span><br><span class="line">  <span class="keyword">if</span>(id!=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(id);</span><br><span class="line">   BeanUtils.copyProperties(teachplanDto,teachplan);</span><br><span class="line">   teachplanMapper.updateById(teachplan);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//取出同父同级别的课程计划数量</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> getTeachplanCount(teachplanDto.getCourseId(), teachplanDto.getParentid());</span><br><span class="line">   <span class="type">Teachplan</span> <span class="variable">teachplanNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Teachplan</span>();</span><br><span class="line">   <span class="comment">//设置排序号</span></span><br><span class="line">   teachplanNew.setOrderby(count+<span class="number">1</span>);</span><br><span class="line">   BeanUtils.copyProperties(teachplanDto,teachplanNew);</span><br><span class="line"></span><br><span class="line">   teachplanMapper.insert(teachplanNew);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 获取最新的排序号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> parentId  父课程计划id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> int 最新排序号</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/9 13:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getTeachplanCount</span><span class="params">(<span class="type">long</span> courseId,<span class="type">long</span> parentId)</span>&#123;</span><br><span class="line">  LambdaQueryWrapper&lt;Teachplan&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">  queryWrapper.eq(Teachplan::getCourseId,courseId);</span><br><span class="line">  queryWrapper.eq(Teachplan::getParentid,parentId);</span><br><span class="line">  <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> teachplanMapper.selectCount(queryWrapper);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h2 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、完善接口的代码 ，调用service方法完成课程计划的创建和修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程计划创建或修改&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTeachplan</span><span class="params">( <span class="meta">@RequestBody</span> SaveTeachplanDto teachplan)</span>&#123;</span><br><span class="line">    teachplanService.saveTeachplan(teachplan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、首先使用httpclient做以下测试。</p>
<p>添加章</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程计划--章</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;新章名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、添加小节</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 新增课程计划--节,从数据库找到第一级的课程计划id向其下边添加计划</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">74</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span>: <span class="number">247</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;小节名称 [点击修改]&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、保存课程计划</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">### 课程课程计划,需要从数据库找到修改的课程计划id</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/teachplan</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;changeDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;courseId&quot;</span> : <span class="number">22</span>,</span><br><span class="line">  <span class="string">&quot;cousePubId&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;createDate&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;ctlBarShow&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;ctlEditTitle&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;endTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span> : <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;isPreview&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mediaType&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;orderby&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;parentid&quot;</span> : <span class="number">237</span>,</span><br><span class="line">  <span class="string">&quot;pname&quot;</span> : <span class="string">&quot;第1节修改名称&quot;</span>,</span><br><span class="line">  <span class="string">&quot;startTime&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;teachPlanId&quot;</span> : <span class="number">240</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、前后端联调</p>
<p>分别联调新增章、新增小节、保存计划信息。</p>
<h2 id="Bug修改"><a href="#Bug修改" class="headerlink" title="Bug修改"></a>Bug修改</h2><p>通过接口测试我们发现：</p>
<p>1、使用httpclient测试没有问题</p>
<p>2、前后端联调时发现新增的第一级目录不能显示在列表中。</p>
<p>请自己分析并修复。</p>
<p>3、思考添加课程计划的实现方式是否存在bug?</p>
<p>如有bug进行修改。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/" itemprop="url">学成在线-day03-课程查询、新增课程、前后端联调</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-17T17:48:17+08:00">
                2024-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  12.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  56
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="开发持久层"><a href="#开发持久层" class="headerlink" title="开发持久层"></a>开发持久层</h1><h2 id="生成mapper"><a href="#生成mapper" class="headerlink" title="生成mapper"></a>生成mapper</h2><p>本项目使用MyBatis-Plus开发持久层，需要创建PO类、Mapper接口、Mapper的xml文件，每个PO类对应数据库的每张表，每张表需要创建一个Mapper接口和Mapper的xml映射文件 。</p>
<p>下边将使用generator工程成的mapper接口和mapper映射文件 拷贝到service工程 ，如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002.gif" alt="img"></p>
<p>service工程即业务层为api接口工程提供业务处理支撑，本项目业务层包括了持久层的代码，一些大型公司的团队职责划分更细，会将持久层和业务层分为两个工程，不过这需要增加成本。</p>
<p>本项目使用持久层框架MyBatis-Plus进行开发，下边将mapper接口和xml文件 拷贝到 service工程 ，拷贝后如下图所示：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004.gif" alt="img"></p>
<p>到此mapper接口与mapper映射文件生成完毕。</p>
<h2 id="测试mapper"><a href="#测试mapper" class="headerlink" title="测试mapper"></a>测试mapper</h2><p>下边对mapper进行单元测试，测试course_base表的查询接口。</p>
<p>1、下边在service工程的pom.xml中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- MySQL 驱动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- mybatis plus的依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 Junit --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、配置扫描mapper及分页插件</p>
<p>从课程资料&#x2F;工程目录下拷贝MybatisPlusConfig 到 service工程的com.xuecheng.content.config包下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.autoconfigure.ConfigurationCustomizer;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *        Mybatis-Plus 配置</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.xuecheng.content.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> &#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 定义分页拦截器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">      interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">      <span class="keyword">return</span> interceptor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分页插件的原理：</p>
<p>首先分页参数放到ThreadLocal中，拦截执行的sql，根据数据库类型添加对应的分页语句重写sql，例如：<code>(select * from table where a)</code> 转换为 <code>(select count(*) from table where a)</code>和<code>(select * from table where a limit ,)</code></p>
<p>计算出了total总条数、pageNum当前第几页、pageSize每页大小和当前页的数据，是否为首页，是否为尾页，总页数等。</p>
<p>4、单元测试所需要的配置文件</p>
<p>在test&#x2F;resources下创建 log4j2-dev.xml、bootstrap.yml：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006.gif" alt="img"></p>
<p> log4j2-dev.xml:从课程资料&#x2F;项目工程 获取.</p>
<p>bootstrap.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/xcplus_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mysql</span></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-dev.xml</span></span><br></pre></td></tr></table></figure>

<p>5、编写启动类：</p>
<p>单元测试工作在test目录，在test下添加启动类</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008.gif" alt="img"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ContentApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、编写测试类</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010.gif" alt="img"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.mapper.CourseBaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Assertions;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CourseBaseMapperTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseBaseMapper courseBaseMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCourseBaseMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(<span class="number">74L</span>);</span><br><span class="line">        Assertions.assertNotNull(courseBase);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试查询接口</span></span><br><span class="line">        LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//查询条件</span></span><br><span class="line">        <span class="type">QueryCourseParamsDto</span> <span class="variable">queryCourseParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryCourseParamsDto</span>();</span><br><span class="line">        queryCourseParamsDto.setCourseName(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setAuditStatus(<span class="string">&quot;202004&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setPublishStatus(<span class="string">&quot;203001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拼接查询条件</span></span><br><span class="line">        <span class="comment">//根据课程名称模糊查询  name like &#x27;%名称%&#x27;</span></span><br><span class="line">        queryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()),CourseBase::getName,queryCourseParamsDto.getCourseName());</span><br><span class="line">        <span class="comment">//根据课程审核状态</span></span><br><span class="line">        queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()),CourseBase::getAuditStatus,queryCourseParamsDto.getAuditStatus());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页参数</span></span><br><span class="line">        <span class="type">PageParams</span> <span class="variable">pageParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageParams</span>();</span><br><span class="line">        pageParams.setPageNo(<span class="number">1L</span>);<span class="comment">//页码</span></span><br><span class="line">        pageParams.setPageSize(<span class="number">3L</span>);<span class="comment">//每页记录数</span></span><br><span class="line">        Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页查询E page 分页参数, @Param(&quot;ew&quot;) Wrapper&lt;T&gt; queryWrapper 查询条件</span></span><br><span class="line">        Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据</span></span><br><span class="line">        List&lt;CourseBase&gt; items = pageResult.getRecords();</span><br><span class="line">        <span class="comment">//总记录数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备返回数据 List&lt;T&gt; items, long counts, long page, long pageSize</span></span><br><span class="line">        PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(items, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        System.out.println(courseBasePageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试类的测试方法进行测试，测试成功：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012.gif" alt="img"></p>
<h1 id="开发业务层"><a href="#开发业务层" class="headerlink" title="开发业务层"></a><strong>开发业务层</strong></h1><h2 id="创建数据字典表"><a href="#创建数据字典表" class="headerlink" title="创建数据字典表"></a>创建数据字典表</h2><p>课程基本信息查询的主要数据来源是课程基本信息表，这里有一个点需要注意，就是课程的审核状态、发布状态。</p>
<p>审核状态在查询条件和查询结果中都存在，审核状态包括：未审核、审核通过、审核未通过三种，下边思考一个问题：一个课程的审核状态如果是“审核未通过”那么在课程基本信息表记录“审核未通过”三个字合适吗？</p>
<p>如果将“审核未通过”五个字记录在课程基本信息表中，显示出来的审核状态就是“审核未通过”这五个字，看起来没有什么问题，如果有一天客户想要将审核未通过的记录在显示时改为“未通过”三个字，怎么办？</p>
<p>这时你可能需要批量处理数据库记录，写一个 update 语句，审核状态等于“审核未通过”的全部更新 为“未通过”。看起来解决了问题，如果有一天客户又让改了呢？</p>
<p>和审核状态同类的有好多这样的信息，比如：课程状态、课程类型、用户类型等等，这一类数据有一个共同点就是它有一些分类项，且这些分类项较为固定。针对这些数据，为了提高系统的可扩展性，专门定义数据字典表去维护。</p>
<p>下边是课程审核状态的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202001&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;审核未通过&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202002&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;未审核&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;202003&quot;</span>,<span class="string">&quot;desc&quot;</span>:<span class="string">&quot;审核通过&quot;</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>每一项都由代码和名称组成。</p>
<p>此时我们好像要干 什么了 ，该课程 的审核状态为审核未通过，那么我们在课程基本信息表存储202001，也就是审核未通过对应的代码，这样查询出的数据在前端展示时根据代码取出它对应的内容显示给用户。如果用户要修改“审核未通过”的显示内容只需要在数据字典表修改，无法修改课程基本信息表。</p>
<p>数据字典表在系统管理数据库中存储，首先导入系统管理数据库，创建系统管理服务的数据库</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-17106848025587.gif" alt="img"></p>
<p>创建成功如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-17106848025598.gif" alt="img"></p>
<p>创建系统管理的数据库，导入课程资料中的xcplus_system.sql脚本。</p>
<h2 id="编写Service"><a href="#编写Service" class="headerlink" title="编写Service"></a>编写Service</h2><p>接下来开发Service方法，首先创建Service接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程基本信息管理业务接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 21:42</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> /</span></span><br><span class="line"><span class="comment">public interface CourseBaseInfoService  &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> /*</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 课程查询接口</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> pageParams 分页参数</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> queryCourseParamsDto 条件条件</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.content.model.po.CourseBase&gt;</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/6 21:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto)</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p>再创建接口实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.mapper.CourseBaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程信息管理业务接口实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 21:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseBaseInfoServiceImpl</span>  <span class="keyword">implements</span> <span class="title class_">CourseBaseInfoService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> CourseBaseMapper courseBaseMapper;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">queryCourseBaseList</span><span class="params">(PageParams pageParams, QueryCourseParamsDto queryCourseParamsDto)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//构建查询条件对象</span></span><br><span class="line">  LambdaQueryWrapper&lt;CourseBase&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">  <span class="comment">//构建查询条件，根据课程名称查询</span></span><br><span class="line">     queryWrapper.like(StringUtils.isNotEmpty(queryCourseParamsDto.getCourseName()),CourseBase::getName,queryCourseParamsDto.getCourseName());</span><br><span class="line">  <span class="comment">//构建查询条件，根据课程审核状态查询</span></span><br><span class="line">     queryWrapper.eq(StringUtils.isNotEmpty(queryCourseParamsDto.getAuditStatus()),CourseBase::getAuditStatus,queryCourseParamsDto.getAuditStatus());</span><br><span class="line"><span class="comment">//构建查询条件，根据课程发布状态查询</span></span><br><span class="line"><span class="comment">//todo:根据课程发布状态查询 </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//分页对象</span></span><br><span class="line">  Page&lt;CourseBase&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">  <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">  Page&lt;CourseBase&gt; pageResult = courseBaseMapper.selectPage(page, queryWrapper);</span><br><span class="line">  <span class="comment">// 获取数据列表</span></span><br><span class="line">  List&lt;CourseBase&gt; list = pageResult.getRecords();</span><br><span class="line">  <span class="comment">// 获取数据总数</span></span><br><span class="line">  <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">  <span class="comment">// 构建结果集</span></span><br><span class="line">  PageResult&lt;CourseBase&gt; courseBasePageResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">  <span class="keyword">return</span> courseBasePageResult;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="测试service"><a href="#测试service" class="headerlink" title="测试service"></a>测试service</h2><p>下边对service进行单元测试，编写单元测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CourseBaseInfoServiceTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCourseBaseInfoService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//查询条件</span></span><br><span class="line">        <span class="type">QueryCourseParamsDto</span> <span class="variable">queryCourseParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryCourseParamsDto</span>();</span><br><span class="line">        queryCourseParamsDto.setCourseName(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setAuditStatus(<span class="string">&quot;202004&quot;</span>);</span><br><span class="line">        queryCourseParamsDto.setPublishStatus(<span class="string">&quot;203001&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页参数</span></span><br><span class="line">        <span class="type">PageParams</span> <span class="variable">pageParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageParams</span>();</span><br><span class="line">        pageParams.setPageNo(<span class="number">1L</span>);<span class="comment">//页码</span></span><br><span class="line">        pageParams.setPageSize(<span class="number">3L</span>);<span class="comment">//每页记录数</span></span><br><span class="line"></span><br><span class="line">        PageResult&lt;CourseBase&gt; courseBasePageResult = courseBaseInfoService.queryCourseBaseList(pageParams, queryCourseParamsDto);</span><br><span class="line">        System.out.println(courseBasePageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="完善todo"><a href="#完善todo" class="headerlink" title="完善todo"></a>完善todo</h2><p>课下完成service方法中的todo：根据课程发布状态查询课程信息。</p>
<h1 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h1><h2 id="接口完善"><a href="#接口完善" class="headerlink" title="接口完善"></a><strong>接口完善</strong></h2><p>控制层、业务层以及持久层三层通常可以面向接口并行开发，比如：业务层开发的同事可以先只编写一个Service接口，接口层的同事即可面向Service接口去开发，待接口层和业务层完成后进行连调。</p>
<p>下边课程查询接口的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程查询接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody(required = false)</span> QueryCourseParamsDto queryCourseParams)</span> &#123;</span><br><span class="line">    PageResult&lt;CourseBase&gt; pageResult = courseBaseInfoService.queryCourseBaseList(pageParams, queryCourseParams);</span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>代码编辑完毕，再次打开Swagger进行测试。</p>
<p>输入查询条件：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-171068748287111.gif" alt="img"></p>
<p>测试，观察结果是否正确。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-171068748287112.gif" alt="img"></p>
<h2 id="Httpclient测试"><a href="#Httpclient测试" class="headerlink" title="Httpclient测试"></a>Httpclient测试</h2><p>Swagger是一个在线接口文档，虽然使用它也能测试但需要浏览器进入Swagger，最关键的是它并不能保存测试数据。</p>
<p>在IDEA中有一个非常方便的http接口测试工具httpclient，下边介绍它的使用方法，后边我们会用它进行接口测试。</p>
<p>如果IDEA版本较低没有自带httpclient，需要安装httpclient插件</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-171068748287113.gif" alt="img"></p>
<p>进入controller类，找到http接口对应的方法</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-171068748287114.gif" alt="img"></p>
<p>点击Generate request in HTTP Client即可生成的一个测试用例。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-171068748287115.gif" alt="img"></p>
<p>可以看到自己生成了一个.http结尾的文件</p>
<p>我们可以添加请求参数进行测试</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-171068748287116.gif" alt="img"></p>
<p>参数添加完毕可以运行它</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014.gif" alt="img"></p>
<p>观察控制台，测试通过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">http:<span class="comment">//localhost:63040/course/list?pageNo=2&amp;pageSize=10</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, <span class="number">07</span> Sep <span class="number">2022</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">50</span> GMT</span><br><span class="line">Keep-Alive: timeout=<span class="number">60</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>: <span class="number">88</span>,</span><br><span class="line">      <span class="string">&quot;companyId&quot;</span>: <span class="number">1232141425</span>,</span><br><span class="line">      <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;users&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-1-1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">      <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">      <span class="string">&quot;description&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;http://r3zc5rung.hd-bkt.clouddn.com/cb1b6038-ef68-4362-8c29-a966886d1dc5sakUiFHLb5sRFdIK&quot;</span>,</span><br><span class="line">      <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2021-12-27 20:14:53&quot;</span>,</span><br><span class="line">      <span class="string">&quot;changeDate&quot;</span>: <span class="string">&quot;2021-12-27 20:28:58&quot;</span>,</span><br><span class="line">      <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202002&quot;</span>,</span><br><span class="line">      <span class="string">&quot;auditMind&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;auditNums&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;auditDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;auditPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;status&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;coursePubId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">   ....</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;counts&quot;</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="string">&quot;page&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;pageSize&quot;</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line">Response file saved.</span><br><span class="line">&gt; <span class="number">2022</span>-09-07T085450<span class="number">.200</span>.json</span><br><span class="line"></span><br><span class="line">Response code: <span class="number">200</span>; Time: 392ms (<span class="number">392</span> ms); Content length: <span class="number">1916</span> bytes (<span class="number">1.92</span> kB)</span><br></pre></td></tr></table></figure>

<p>.http文件即测试用例文档 ，它可以随着项目工程一起保存，这样测试的数据就可以保存下来，方便进行测试。</p>
<p>为了方便保存.http文件 ，我们单独在项目工程的根目录创建一个目录单独存放它们。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016.gif" alt="img"></p>
<p>我们以模块为单位创建.http文件。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018.gif" alt="img"></p>
<p>打开内容管理模块的 http文件 ，把刚才测试数据拷贝上去</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020.gif" alt="img"></p>
<p>为了方便将来和网关集成测试，这里我们把测试主机地址在配置文件http-client.env.json 中配置</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022.gif" alt="img"></p>
<p>注意：文件名称http-client.env.json保持一致，否则无法读取dev环境变量的内容。</p>
<p>内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gateway_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63010&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;content_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63040&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;system_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63110&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;media_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63050&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;search_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63080&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auth_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63070&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;checkcode_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63075&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;learning_host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:63020&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>再回到xc-content-api.http文件，将<a target="_blank" rel="noopener" href="http://localhost:63040/">http://localhost:63040</a> 用变量代替</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image024.gif" alt="img"></p>
<p>到此就完成了httpclient的配置与使用测试。</p>
<h1 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a><strong>前后端联调</strong></h1><h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><p>什么是前后端联调？</p>
<p>通常由后端工程师将接口设计好并编写接口文档，将接口文档交给前端工程师，前后端的工程师就开始并行开发，前端开发人员会使用mock数据（假数据）进行开发，当前后端代码完成后开始进行接口联调，前端工程师将mock数据改为请求后端接口获取，前端代码请求后端服务测试接口是否正常，这个过程是前后端联调。</p>
<p>当前后端联调出现问题需要根据测试环境下接口的请求及响应数据内容去判断是否符合接口文档的要求。查出是前端或后端的问题由具体的工程师负责修改缺陷，修改后再次回归测试。</p>
<p>在教学中进行前后端联调，首先配置前端环境，下边我们安装前端工程运行的环境。</p>
<p>首先从软件工具目录找到node-v16.17.0-x64.msi安装nodejs</p>
<p>安装完成，查看版本号</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-171068855806629.gif" alt="img"></p>
<p>idea中配置node.js</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/image-20240317232545772.png" alt="image-20240317232545772"></p>
<p>下边启动前端工程，从前端工程拷贝project-xczx2-portal-vue-ts.zip到代码目录并解压，并使用IDEA或VS Code打开project-xczx2-portal-vue-ts目录，下边以IDEA为例进行说明：</p>
<p>右键点击project-xczx2-portal-vue-ts目录下的package.json文件，</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-171068855806730.gif" alt="img"></p>
<p>点击Show npm Scripts打开npm窗口</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-171068855806731.gif" alt="img"></p>
<p>点击“Edit ‘serve’” setting，下边对启动项目的一些参数进行配置，选择nodejs、npm。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-171068855806732.gif" alt="img"></p>
<p>右键点击Serve，点击“Run serve”启动工程。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-171068855806733.gif" alt="img"></p>
<p>出现如下访问链接说明启动成功</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-171068855806734.gif" alt="img"></p>
<p>访问<a href="http://localhost:8601即可访问前端工程。">http://localhost:8601即可访问前端工程。</a></p>
<p>如果存在问题通过以下命令启动：</p>
<p>1、cmd进入工程根目录 </p>
<p>2、运行以下命令</p>
<p>npm install -g cnpm –registry&#x3D;<a target="_blank" rel="noopener" href="https://registry.npm.taobao.org/">https://registry.npm.taobao.org</a></p>
<p>cnpm i</p>
<p>npm run serve</p>
<h2 id="安装系统管理服务"><a href="#安装系统管理服务" class="headerlink" title="安装系统管理服务"></a>安装系统管理服务</h2><p>启动前端工程成功，在浏览器通过<a target="_blank" rel="noopener" href="http://localhost:8601/%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E3%80%82">http://localhost:8601/地址访问前端工程。</a></p>
<p>前端工程报错如下：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014-171068855806735.gif" alt="img"></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8601/api/system/dictionary/all">http://localhost:8601/system/dictionary/all</a> 指向的是系统管理服务。在前端讲解内容管理模块的需求时我们提到一个数据字典表，此链接正是在前端请求后端获取数据字典数据的接口地址。</p>
<p>数据字典表中配置了项目用的字典信息，此接口是查询字典中的全部数据 ，在此我们不再开发，按照下边的步骤安装系统管理服务即可。</p>
<p>从课程资料&#x2F;项目工程目录获取xuecheng-plus-system.zip，并解压</p>
<p>将xuecheng-plus-system目录拷贝到项目工程根目录，刷新maven，或进入pom.xml右键转为pom工程。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016-171068855806736.gif" alt="img"></p>
<p>进入xuecheng-plus-system-service工程，找到resources下的application.yml修改数据库连接参数。</p>
<p>启动系统管理服务，启动成功，在浏览器请求：<a target="_blank" rel="noopener" href="http://localhost:63110/system/dictionary/all">http://localhost:63110/system/dictionary/all</a></p>
<p>系统服务的端口是63110</p>
<p>如果可以正常读取数据字典信息则说明系统管理服务安装成功。</p>
<h2 id="解决跨域问题"><a href="#解决跨域问题" class="headerlink" title="解决跨域问题"></a>解决跨域问题</h2><p>在浏览器通过<a target="_blank" rel="noopener" href="http://localhost:8601/%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E3%80%82">http://localhost:8601/地址访问前端工程。</a></p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/image-20240318001127089.png" alt="image-20240318001127089"></p>
<p>chrome浏览器报错如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access to XMLHttpRequest at &#x27;http://localhost:63110/system/dictionary/all&#x27; from origin &#x27;http://localhost:8601&#x27; has been blocked by CORS policy: No &#x27;Access-Control-Allow-Origin&#x27; header is present on the requested resource.</span><br></pre></td></tr></table></figure>

<p>firefox浏览器报错如下：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">已拦截跨源请求：同源策略禁止读取位于 http://localhost:63110/system/dictionary/all 的远程资源。（原因：CORS 头缺少 &#x27;Access-Control-Allow-Origin&#x27;）。状态码：200。</span><br></pre></td></tr></table></figure>

<p>提示：从<a href="http://localhost:8601访问http://localhost:63110/system/dictionary/all被CORS">http://localhost:8601访问http://localhost:63110/system/dictionary/all被CORS</a> policy阻止，因为没有Access-Control-Allow-Origin 头信息。CORS全称是 cross origin resource share 表示跨域资源共享。</p>
<p>出这个提示的原因是基于浏览器的同源策略，去判断是否跨域请求，同源策略是浏览器的一种安全机制，从一个地址请求另一个地址，如果协议、主机、端口三者全部一致则不属于跨域，否则有一个不一致就是跨域请求。</p>
<p>比如：</p>
<p>从<a target="_blank" rel="noopener" href="http://localhost:8601/">http://localhost:8601</a> 到  <a target="_blank" rel="noopener" href="http://localhost:8602/">http://localhost:8602</a> 由于端口不同，是跨域。</p>
<p>从<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 到  <a target="_blank" rel="noopener" href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> 由于主机不同，是跨域。</p>
<p>从<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> 到  <a target="_blank" rel="noopener" href="https://192.168.101.11:8601/">https://192.168.101.10:8601</a> 由于协议不同，是跨域。</p>
<p>注意：服务器之间不存在跨域请求。</p>
<p>浏览器判断是跨域请求会在请求头上添加origin，表示这个请求来源哪里。</p>
<p>比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Origin: http://localhost:8601</span><br></pre></td></tr></table></figure>

<p>服务器收到请求判断这个Origin是否允许跨域，如果允许则在响应头中说明允许该来源的跨域请求，如下：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin：http://localhost:8601 </span><br></pre></td></tr></table></figure>

<p>如果允许任何域名来源的跨域请求，则响应如下：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin：*</span><br></pre></td></tr></table></figure>

<p>解决跨域的方法：</p>
<p>1、JSONP</p>
<p>通过script标签的src属性进行跨域请求，如果服务端要响应内容则首先读取请求参数callback的值，callback是一个回调函数的名称，服务端读取callback的值后将响应内容通过调用callback函数的方式告诉请求方。如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018-171068855806737.gif" alt="img"> 2、添加响应头</p>
<p>服务端在响应头添加 Access-Control-Allow-Origin：*</p>
<p>3、通过nginx代理跨域</p>
<p>由于服务端之间没有跨域，浏览器通过nginx去访问跨域地址。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020-171068855806738.gif" alt="img"></p>
<p>1）浏览器先访问<a target="_blank" rel="noopener" href="http://192.168.101.10:8601/">http://192.168.101.10:8601</a> nginx提供的地址，进入页面</p>
<p>2）此页面要跨域访问<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/">http://192.168.101.11:8601</a> ，不能直接跨域访问<a target="_blank" rel="noopener" href="http://www.baidu.com:8601/">http://www.baidu.com:8601</a> ，而是访问nginx的一个同源地址，比如：<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> ，通过<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> 的代理去访问<a href="http://www.baidu.com:8601。">http://www.baidu.com:8601。</a></p>
<p>这样就实现了跨域访问。</p>
<p>浏览器到<a target="_blank" rel="noopener" href="http://192.168.101.11:8601/api">http://192.168.101.11:8601/api</a> 没有跨域</p>
<p>nginx到<a href="http://www.baidu.com:8601通过服务端通信，没有跨域。">http://www.baidu.com:8601通过服务端通信，没有跨域。</a></p>
<p>我们准备使用方案2解决跨域问题。在内容管理的api工程config包下编写GlobalCorsConfig.java，</p>
<p>或直接从课程资料&#x2F;项目工程下拷贝，</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.system.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 跨域过虑器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 11:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalCorsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 允许跨域调用的过滤器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> CorsFilter <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">   <span class="comment">//允许白名单域名进行跨域调用</span></span><br><span class="line">   config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">   <span class="comment">//允许跨越发送cookie</span></span><br><span class="line">   config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">   <span class="comment">//放行全部原始头信息</span></span><br><span class="line">   config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">   <span class="comment">//允许所有请求方法跨域调用</span></span><br><span class="line">   config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">   <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">   source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>此配置类实现了跨域过虑器，在响应头添加Access-Control-Allow-Origin。</p>
<p>重启系统管理服务，前端工程可以正常进入<a href="http://localhost:8601，观察浏览器记录，成功解决跨域。">http://localhost:8601，观察浏览器记录，成功解决跨域。</a></p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022-171068855806739.gif" alt="img"></p>
<h2 id="前后端联调-1"><a href="#前后端联调-1" class="headerlink" title="前后端联调"></a>前后端联调</h2><p>这里进行前后联调的目的是体会前后端联调的流程，测试的功能为课程查询功能。</p>
<p>1、启动前端工程，再启内容管理服务端。</p>
<p>2、修改服务端地址</p>
<p>前端默认连接的是项目的网关地址，由于现在网关工程还没有创建，这里需要更改前端工程的参数配置文件 ，修改网关地址为内容管理服务的地址。 </p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image024-171068855806740.gif" alt="img"></p>
<p>启动前端工程，用前端访问后端接口，观察前端界面的数据是否正确。</p>
<p>访问前端首页，进入课程管理：<a target="_blank" rel="noopener" href="http://localhost:8601/#/organization/course-list">http://localhost:8601/#/organization/course-list</a></p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image026.gif" alt="img"></p>
<p>更改课程条件及分页参数测试课程查询列表是否正常显示。</p>
<p>跟踪内容管理服务的输出日志，查看是否正常。</p>
<p>到此基本完成了前后端连调。</p>
<h1 id="课程分类查询"><a href="#课程分类查询" class="headerlink" title="课程分类查询"></a>课程分类查询</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>下边根据内容管理模块的业务流程，下一步要实现新增课程，在新增课程界面，有三处信息需要选择，如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-171069372561454.gif" alt="img"></p>
<p>课程等级、课程类型来源于数据字典表，此部分的信息前端已从系统管理服务读取。</p>
<p>课程分类信息没有在数据字典表中存储，而是由单独一张课程分类表，存储在内容管理数据库中。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-171069372561459.gif" alt="img"></p>
<p>下边看下course_category课程分类表的结构</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-171069372561455.gif" alt="img"></p>
<p>这张表是一个树型结构，通过父结点id将各元素组成一个树。</p>
<p>我们可以看下该表的数据，下图是一部分数据：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-171069372561456.gif" alt="img"></p>
<p>现在的需求是需要在内容管理服务中编写一个接口读取该课程分类表的数据，组成一个树型结构返回给前端。</p>
<p>课程分类的PO类如下：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-171069372561458.gif" alt="img"></p>
<p>如果没有此po类则需要生成的此表的po类拷贝到内容管理模块的model工程中，将mapper拷贝到内容管理模块的service工程中。</p>
<h2 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>我们可以点击新增课程，观察前端的请求记录：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-171069372561457.gif" alt="img"></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8601/api/content/course-category/tree-nodes">http://localhost:8601/api/content/course-category/tree-nodes</a> 该地址正是前端获取课程分类的接口地址。</p>
<p>通过上图界面的内容可以看出该接口的协议为：HTTP GET</p>
<p>请求参数为空。</p>
<p>通过查阅接口文档，此接口要返回全部课程分类，以树型结构返回，如下所示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;HTML/CSS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;HTML/CSS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;JavaScript&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;JavaScript&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jQuery&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jQuery&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ExtJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ExtJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AngularJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AngularJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactJS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Node.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Node.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-9&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Vue&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Vue&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-10&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;前端开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;前端开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;iOS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;iOS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;手游开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;手游开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Swift&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Swift&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Android&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Android&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-6&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactNative&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ReactNative&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Cordova&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Cordova&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;其它&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>上边的数据格式是一个数组结构，数组的元素即为分类信息，分类信息设计两级分类，第一级的分类信息示例如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>

<p>第二级的分类是第一级分类中childrenTreeNodes属性，它是一个数组结构：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;移动开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;childrenTreeNodes&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isLeaf&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;isShow&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;label&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;微信开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;orderby&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;parentid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-2&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>所以，定义一个DTO类表示分类信息的模型类，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseCategory;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程分类树型结点dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/7 15:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryTreeDto</span> <span class="keyword">extends</span> <span class="title class_">CourseCategory</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  List&lt;CourseCategoryTreeDto&gt; childrenTreeNodes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseCategoryService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 数据字典 前端控制器</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/course-category/tree-nodes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="树型表查询"><a href="#树型表查询" class="headerlink" title="树型表查询"></a><strong>树型表查询</strong></h2><p>课程分类表是一个树型结构，其中parentid字段为父结点ID，它是树型结构的标志字段。</p>
<p>如果树的层级固定可以使用表的自链接去查询，比如：我们只查询两级课程分类，可以用下边的SQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">       one.id            one_id,</span><br><span class="line">       one.name          one_name,</span><br><span class="line">       one.parentid      one_parentid,</span><br><span class="line">       one.orderby       one_orderby,</span><br><span class="line">       one.label         one_label,</span><br><span class="line">       two.id            two_id,</span><br><span class="line">       two.name          two_name,</span><br><span class="line">       two.parentid      two_parentid,</span><br><span class="line">       two.orderby       two_orderby,</span><br><span class="line">       two.label         two_label</span><br><span class="line">   from course_category one</span><br><span class="line">            inner join course_category two on one.id = two.parentid</span><br><span class="line">   where one.parentid = 1</span><br><span class="line">     and one.is_show = 1</span><br><span class="line">     and two.is_show = 1</span><br><span class="line">   order by one.orderby,</span><br><span class="line">            two.orderby</span><br></pre></td></tr></table></figure>

<p>如果树的层级不确定，此时可以使用MySQL递归实现，使用with语法，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WITH [RECURSIVE]</span><br><span class="line">        cte_name [(col_name [, col_name] ...)] AS (subquery)</span><br><span class="line">        [, cte_name [(col_name [, col_name] ...)] AS (subquery)] ...</span><br></pre></td></tr></table></figure>

<p>cte_name :公共表达式的名称,可以理解为表名,用来表示as后面跟着的子查询</p>
<p>col_name :公共表达式包含的列名,可以写也可以不写</p>
<p>下边是一个递归的简单例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">with RECURSIVE t1  AS</span><br><span class="line">(</span><br><span class="line">  SELECT 1 as n</span><br><span class="line">  UNION ALL</span><br><span class="line">  SELECT n + 1 FROM t1 WHERE n &lt; 5</span><br><span class="line">)</span><br><span class="line">SELECT * FROM t1;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014-171069372561460.gif" alt="img"></p>
<p>说明：</p>
<p>t1 相当于一个表名</p>
<p>select 1 相当于这个表的初始值，这里使用UNION ALL 将初始值加入到表中。</p>
<p>n&lt;5为递归执行的条件，当n&gt;&#x3D;5时结束递归调用。</p>
<p>下边我们使用递归实现课程分类的查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">with recursive t1 as (</span><br><span class="line">select * from  course_category p where  id= &#x27;1&#x27;</span><br><span class="line">union all</span><br><span class="line"> select t.* from course_category t inner join t1 on t1.id = t.parentid</span><br><span class="line">)</span><br><span class="line">select *  from t1 order by t1.id, t1.orderby</span><br></pre></td></tr></table></figure>

<p>查询结果如下：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016-171069372561461.gif" alt="img"></p>
<p>t1表中初始的数据是id等于1的记录，即根结点。</p>
<p>通过inner join t1 t2 on t2.id &#x3D; t.parentid 找到id&#x3D;’1’的下级节点 。</p>
<p>通过这种方法就找到了id&#x3D;’1’的所有下级节点，下级节点包括了所有层级的节点。</p>
<p>上边这种方法是向下递归，即找到初始节点的所有下级节点。</p>
<p>如何向上递归？</p>
<p>下边的sql实现了向上递归：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">with recursive t1 <span class="title function_">as</span> <span class="params">(</span></span><br><span class="line"><span class="params">select * from  course_category p where  id= <span class="string">&#x27;1-1-1&#x27;</span></span></span><br><span class="line"><span class="params">union all</span></span><br><span class="line"><span class="params"> select t.* from course_category t inner join t1 on t1.parentid = t.id</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">select *  from t1 order by t1.id, t1.orderby</span><br></pre></td></tr></table></figure>

<p>初始节点为1-1-1，通过递归找到它的父级节点，父级节点包括所有级别的节点。</p>
<p>以上是我们研究了树型表的查询方法，通过递归的方式查询课程分类比较灵活，因为它可以不限制层级。</p>
<p>mysql为了避免无限递归默认递归次数为1000，可以通过设置cte_max_recursion_depth参数增加递归深度，还可以通过max_execution_time限制执行时间，超过此时间也会终止递归操作。</p>
<p>mysql递归相当于在存储过程中执行若干次sql语句，java程序仅与数据库建立一次链接执行递归操作，所以只要控制好递归深度，控制好数据量性能就没有问题。</p>
<p>思考：如果java程序在递归操作中连接数据库去查询数据组装数据，这个性能高吗？</p>
<h2 id="开发Mapper"><a href="#开发Mapper" class="headerlink" title="开发Mapper"></a><strong>开发Mapper</strong></h2><p>下边我们可自定义mapper方法查询课程分类，最终将查询结果映射到List&lt;CourseCategoryTreeDto&gt;中。</p>
<p>生成课程分类表的mapper文件并拷贝至内容管理模块的service工程中。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018-171069372561462.gif" alt="img"></p>
<p>1、下边 定义一个mapper方法，并定义sql语句。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseCategoryMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;CourseCategory&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">selectTreeNodes</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、找到对应 的mapper.xml文件，编写sql语句。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">&quot;selectTreeNodes&quot;</span> resultType=<span class="string">&quot;com.xuecheng.content.model.dto.CourseCategoryTreeDto&quot;</span> parameterType=<span class="string">&quot;string&quot;</span>&gt;</span><br><span class="line">    with recursive t1 <span class="title function_">as</span> <span class="params">(</span></span><br><span class="line"><span class="params">        select * from  course_category p where  id= #&#123;id&#125;</span></span><br><span class="line"><span class="params">        union all</span></span><br><span class="line"><span class="params">        select t.* from course_category t inner join t1 on t1.id = t.parentid</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">    select *  from t1 order by t1.id, t1.orderby</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>



<h2 id="开发service"><a href="#开发service" class="headerlink" title="开发service"></a><strong>开发service</strong></h2><p>定义service接口，调用mapper查询课程分类，遍历数据按照接口要求对数据进行封装</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseCategoryService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程分类树形结构查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写service接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CourseCategoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseCategoryMapper courseCategoryMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">(String id)</span> &#123;</span><br><span class="line">       List&lt;CourseCategoryTreeDto&gt; courseCategoryTreeDtos = courseCategoryMapper.selectTreeNodes(id);</span><br><span class="line">    <span class="comment">//将list转map,以备使用,排除根节点</span></span><br><span class="line">    Map&lt;String, CourseCategoryTreeDto&gt; mapTemp = courseCategoryTreeDtos.stream().filter(item-&gt;!id.equals(item.getId())).collect(Collectors.toMap(key -&gt; key.getId(), value -&gt; value, (key1, key2) -&gt; key2));</span><br><span class="line">    <span class="comment">//最终返回的list</span></span><br><span class="line">    List&lt;CourseCategoryTreeDto&gt; categoryTreeDtos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//依次遍历每个元素,排除根节点</span></span><br><span class="line">    courseCategoryTreeDtos.stream().filter(item-&gt;!id.equals(item.getId())).forEach(item-&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(item.getParentid().equals(id))&#123;</span><br><span class="line">            categoryTreeDtos.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//找到当前节点的父节点</span></span><br><span class="line">        <span class="type">CourseCategoryTreeDto</span> <span class="variable">courseCategoryTreeDto</span> <span class="operator">=</span> mapTemp.get(item.getParentid());</span><br><span class="line">        <span class="keyword">if</span>(courseCategoryTreeDto!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(courseCategoryTreeDto.getChildrenTreeNodes() ==<span class="literal">null</span>)&#123;</span><br><span class="line">                courseCategoryTreeDto.setChildrenTreeNodes(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;CourseCategoryTreeDto&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//下边开始往ChildrenTreeNodes属性中放子节点</span></span><br><span class="line">            courseCategoryTreeDto.getChildrenTreeNodes().add(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> categoryTreeDtos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a><strong>单元测试</strong></h2><p>定义单元测试类对service接口进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.QueryCourseParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CourseBase;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseCategoryService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CourseCategoryServiceTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseCategoryService courseCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testCourseCategoryService</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;CourseCategoryTreeDto&gt; courseCategoryTreeDtos = courseCategoryService.queryTreeNodes(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        System.out.println(courseCategoryTreeDtos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><h2 id="接口层代码完善"><a href="#接口层代码完善" class="headerlink" title="接口层代码完善"></a><strong>接口层代码完善</strong></h2><p>完善controller方法，注入service调用业务层方法查询课程分类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseCategoryTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseCategoryService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 课程分类相关接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseCategoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseCategoryService courseCategoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/course-category/tree-nodes&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CourseCategoryTreeDto&gt; <span class="title function_">queryTreeNodes</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> courseCategoryService.queryTreeNodes(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h2><p>使用httpclient测试：</p>
<p>定义.http文件 </p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020-171069372561463.gif" alt="img"></p>
<p>运行测试。</p>
<p>完成前后端连调：</p>
<p>打开前端工程，进入新增课程页面。</p>
<p>课程分类下拉框可以正常显示</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022-171069372561464.gif" alt="img"></p>
<h1 id="新增课程"><a href="#新增课程" class="headerlink" title="新增课程"></a><strong>新增课程</strong></h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h2><h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h2><p>根据前边对内容管理模块的数据模型分析，课程相关的信息有：课程基本信息、课程营销信息、课程图片信息、课程计划、课程师资信息，所以新增一门课程需要完成这几部分信息的填写。</p>
<p>以下是业务流程：</p>
<p>1、进入课程查询列表</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image002-17108230650771.gif" alt="img"></p>
<p>2、点击添加课程，选择课程形式为录播。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image004-17108230650772.gif" alt="img"></p>
<p>3、选择完毕，点击下一步，进入课程基本信息添加界面。</p>
<p>本界面分两部分信息，一部分是课程基本信息上，一部分是课程营销信息。</p>
<p>课程基本信息：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image006-17108230650773.gif" alt="img"></p>
<p>课程营销信息：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image008-17108230650774.gif" alt="img"></p>
<p>在这个界面中填写课程的基本信息、课程营销信息上。</p>
<p>填写完毕，保存并进行下一步。</p>
<p>4、在此界面填写课程计划信息</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image010-17108230650775.gif" alt="img"></p>
<p>课程计划即课程的大纲目录。</p>
<p>课程计划分为两级，章节和小节。</p>
<p>每个小节需要上传课程视频，用户点击 小节的标题即开始播放视频。</p>
<p>如果是直播课程则会进入直播间。</p>
<p>5、课程 计划填写完毕进入课程师资的管理。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image012-17108230650776.gif" alt="img"></p>
<p>在课程师资界面维护该课程的授课老师。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image014-17108230650777.gif" alt="img"></p>
<p>至此，一门课程新增完成。</p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h2><p>通过业务流程可知，一门课程信息涉及：课程基本信息、课程营销信息、课程计划信息、课程师资信息。</p>
<p>本节开发新增课程按钮功能， 只向课程基本信息、课程营销信息添加记录。</p>
<p>这两部分信息分别在course_base、course_market两张表存储。当点击保存按钮时向这两张表插入数据。这两张表是一对一关联关系。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image016-17108230650778.gif" alt="img"></p>
<p>新建课程的初始审核状态为“未提交”、初始发布状态为“未发布”。</p>
<p>生成课程基本信息、课程营销信息的PO、Mapper文件 </p>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h2><p>根据业务流程，这里先定义提交课程基本信息的接口。</p>
<p>1、接口协议 ：HTTP POST，Content-Type为application&#x2F;json</p>
<p>2、请求及响应结果如下</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image018-17108230650779.gif" alt="img"></p>
<p>3、接口请求示例如下 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">### 创建课程</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;初级人员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;originalPrice&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;qq&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wechat&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;validDays&quot;</span>: <span class="number">365</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###响应结果如下</span><br><span class="line">#成功响应结果如下</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">109</span>,</span><br><span class="line">  <span class="string">&quot;companyId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;companyName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;测试课程103&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;初级人员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mtName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;stName&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2022-09-08 07:35:16&quot;</span>,</span><br><span class="line">  <span class="string">&quot;changeDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;createPeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;changePeople&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;auditStatus&quot;</span>: <span class="string">&quot;202002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;coursePubId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;coursePubDate&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;originalPrice&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;qq&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wechat&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;validDays&quot;</span>: <span class="number">365</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、定义请求参数类型和响应结构类型</p>
<p>根据接口定义内容，请求参数相比 CourseBase模型类不一致，需要在dto包下自定义，模型类从课程资料&#x2F;工程目录获取。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image020-171082306507710.gif" alt="img"></p>
<p>4、定义接口如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h2><h2 id="保存课程基本信息"><a href="#保存课程基本信息" class="headerlink" title="保存课程基本信息"></a><strong>保存课程基本信息</strong></h2><p>根据需求分析，新增课程表单中包括了课程基本信息、课程营销信息，需要分别向课程基本信息表、课程营销表保证数据。</p>
<p>首先定义service接口，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 添加课程基本信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> companyId  教学机构id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> addCourseDto  课程基本信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CourseBaseInfoDto</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/7 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(Long companyId,AddCourseDto addCourseDto)</span>;</span><br></pre></td></tr></table></figure>



<p>编写service接口实现类，实现向课程基本信息表保存数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(Long companyId, AddCourseDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//合法性校验</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getName())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程名称为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getMt())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getSt())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getGrade())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程等级为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getTeachmode())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;教育模式为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getUsers())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;适应人群为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dto.getCharge())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;收费规则为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//新增对象</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBaseNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBase</span>();</span><br><span class="line">    <span class="comment">//将填写的课程信息赋值给新增对象</span></span><br><span class="line">    BeanUtils.copyProperties(dto,courseBaseNew);</span><br><span class="line">    <span class="comment">//设置审核状态</span></span><br><span class="line">    courseBaseNew.setAuditStatus(<span class="string">&quot;202002&quot;</span>);</span><br><span class="line">    <span class="comment">//设置发布状态</span></span><br><span class="line">    courseBaseNew.setStatus(<span class="string">&quot;203001&quot;</span>);</span><br><span class="line">    <span class="comment">//机构id</span></span><br><span class="line">    courseBaseNew.setCompanyId(companyId);</span><br><span class="line">    <span class="comment">//添加时间</span></span><br><span class="line">    courseBaseNew.setCreateDate(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//插入课程基本信息表</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> courseBaseMapper.insert(courseBaseNew);</span><br><span class="line">    <span class="keyword">if</span>(insert&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;新增课程基本信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向课程营销表保存课程营销信息</span></span><br><span class="line">    <span class="comment">//课程营销信息</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarketNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseMarket</span>();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> courseBaseNew.getId();</span><br><span class="line">    BeanUtils.copyProperties(dto,courseMarketNew);</span><br><span class="line">    courseMarketNew.setId(courseId);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> saveCourseMarket(courseMarketNew);</span><br><span class="line">    <span class="keyword">if</span>(i&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;保存课程营销信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询课程基本信息及营销信息并返回</span></span><br><span class="line">    <span class="keyword">return</span> getCourseBaseInfo(courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//保存课程营销信息</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">saveCourseMarket</span><span class="params">(CourseMarket courseMarketNew)</span>&#123;</span><br><span class="line">    <span class="comment">//收费规则</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> courseMarketNew.getCharge();</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(charge))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;收费规则没有选择&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//收费规则为收费</span></span><br><span class="line">    <span class="keyword">if</span>(charge.equals(<span class="string">&quot;201001&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(courseMarketNew.getPrice() == <span class="literal">null</span> || courseMarketNew.getPrice().floatValue()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;课程为收费价格不能为空且必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据id从课程营销表查询</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarketObj</span> <span class="operator">=</span> courseMarketMapper.selectById(courseMarketNew.getId());</span><br><span class="line">    <span class="keyword">if</span>(courseMarketObj == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> courseMarketMapper.insert(courseMarketNew);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        BeanUtils.copyProperties(courseMarketNew,courseMarketObj);</span><br><span class="line">        courseMarketObj.setId(courseMarketNew.getId());</span><br><span class="line">        <span class="keyword">return</span> courseMarketMapper.updateById(courseMarketObj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据课程id查询课程基本信息，包括基本信息和营销信息</span></span><br><span class="line"> <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">getCourseBaseInfo</span><span class="params">(<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">  <span class="keyword">if</span>(courseBase == <span class="literal">null</span>)&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line">  <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfoDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDto</span>();</span><br><span class="line">  BeanUtils.copyProperties(courseBase,courseBaseInfoDto);</span><br><span class="line">  <span class="keyword">if</span>(courseMarket != <span class="literal">null</span>)&#123;</span><br><span class="line">   BeanUtils.copyProperties(courseMarket,courseBaseInfoDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询分类名称</span></span><br><span class="line">  <span class="type">CourseCategory</span> <span class="variable">courseCategoryBySt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getSt());</span><br><span class="line">  courseBaseInfoDto.setStName(courseCategoryBySt.getName());</span><br><span class="line">  <span class="type">CourseCategory</span> <span class="variable">courseCategoryByMt</span> <span class="operator">=</span> courseCategoryMapper.selectById(courseBase.getMt());</span><br><span class="line">  courseBaseInfoDto.setMtName(courseCategoryByMt.getName());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoDto;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h2><p>1、首先去完善controller方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;新增课程基础信息&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(<span class="meta">@RequestBody</span> AddCourseDto addCourseDto)</span>&#123;</span><br><span class="line">    <span class="comment">//机构id，由于认证系统没有上线暂时硬编码</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">  <span class="keyword">return</span> courseBaseInfoService.createCourseBase(companyId,addCourseDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、使用httpclient测试</p>
<p>在xc-content-api.http中定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">### 创建课程</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/course</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;charge&quot;</span>: <span class="string">&quot;201000&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;originalPrice&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;qq&quot;</span>: <span class="string">&quot;22333&quot;</span>,</span><br><span class="line">  <span class="string">&quot;wechat&quot;</span>: <span class="string">&quot;223344&quot;</span>,</span><br><span class="line">  <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;13333333&quot;</span>,</span><br><span class="line">  <span class="string">&quot;validDays&quot;</span>: <span class="number">365</span>,</span><br><span class="line">  <span class="string">&quot;mt&quot;</span>: <span class="string">&quot;1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;st&quot;</span>: <span class="string">&quot;1-1-1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;测试课程103&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pic&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachmode&quot;</span>: <span class="string">&quot;200002&quot;</span>,</span><br><span class="line">  <span class="string">&quot;users&quot;</span>: <span class="string">&quot;初级人员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="string">&quot;204001&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3、前后端联调</p>
<p>打开新增课程页面，除了课程图片其它信息全部输入。</p>
<p>点击保存，观察浏览器请求接口参数及响应结果是否正常。</p>
<h1 id="【面试】Mybatis分页插件的原理？"><a href="#【面试】Mybatis分页插件的原理？" class="headerlink" title="【面试】Mybatis分页插件的原理？"></a>【面试】Mybatis分页插件的原理？</h1><ol>
<li><p>Mybatis分页插件的原理？</p>
<p>首先分页参数会放到ThreadLocal中，拦截执行sql，根据数据库类型添加对应的分页语句重写sql，例如：（select * from  table where a）转换为（select count(*) from table where a）和（select * from table where a limit ,)计算出total总条数，pageNum当前第几页，pageSize每页大小和当前页的数据，是否为首页，是否为尾页，总页数等。</p>
</li>
</ol>
<h1 id="【面试】1、树型表的标记字段是什么-如何查询MySQL树型表"><a href="#【面试】1、树型表的标记字段是什么-如何查询MySQL树型表" class="headerlink" title="【面试】1、树型表的标记字段是什么?如何查询MySQL树型表?"></a>【面试】1、树型表的标记字段是什么?如何查询MySQL树型表?</h1><p>树型表的标记字段是parentid即父结点的id。</p>
<h1 id="【面试】查询一个树型表的方法"><a href="#【面试】查询一个树型表的方法" class="headerlink" title="【面试】查询一个树型表的方法:"></a>【面试】查询一个树型表的方法:</h1><p>1） 当层级固定时可以用表的自链接进行查询。</p>
<p>2） 如果想灵活查询每个层级可以使用mysql递归方法，使用with RECURSIVE 实现。</p>
<h1 id="【面试】MyBatis的ResultType和ResultMap的区别"><a href="#【面试】MyBatis的ResultType和ResultMap的区别" class="headerlink" title="【面试】MyBatis的ResultType和ResultMap的区别?"></a>【面试】MyBatis的ResultType和ResultMap的区别?</h1><p>ResultType:指定映射类型，只要查询的字段名和类型的属性名匹配可以自动映射。</p>
<p>ResultMap:自定义映射规则，当查询的字段名和映射类型的属性不匹配时可以通过ResultMap自定义映射规则,也可以实现一对多、—对一映射。</p>
<p>3、#{}和${}有什么区别?<br>#{}是标记一个占位符，可以防止sql注入。<br>${}用于在动态sql中拼接字符串，可能导致sql注入。</p>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a><strong>异常处理</strong></h2><h2 id="异常问题分析"><a href="#异常问题分析" class="headerlink" title="异常问题分析"></a><strong>异常问题分析</strong></h2><p>在service方法中有很多的参数合法性校验，当参数不合法则抛出异常，下边我们测试下异常处理。</p>
<p>请求创建课程基本信息，故意将必填项设置为空。</p>
<p>测试发现报500异常，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:63040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, <span class="number">07</span> Sep <span class="number">2022</span> <span class="number">11</span>:<span class="number">40</span>:<span class="number">29</span> GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;timestamp&quot;</span>: <span class="string">&quot;2022-09-07T11:40:29.677+00:00&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="string">&quot;error&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/content/course&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：并没有输出我们抛出异常时指定的异常信息。</p>
<p>所以，现在我们的需求是当正常操作时按接口要求返回数据，当非正常流程时要获取异常信息进行记录，并提示给用户。</p>
<p>异常处理除了输出在日志中，还需要提示给用户，前端和后端需要作一些约定：</p>
<p>1、错误提示信息统一以json格式返回给前端。</p>
<p>2、以HTTP状态码决定当前是否出错，非200为操作异常。</p>
<p>如何规范异常信息？</p>
<p>代码中统一抛出项目的自定义异常类型，这样可以统一去捕获这一类或几类的异常。</p>
<p>规范了异常类型就可以去获取异常信息。</p>
<p>如果捕获了非项目自定义的异常类型统一向用户提示“执行过程异常，请重试”的错误信息。</p>
<p>如何捕获异常？</p>
<p>代码统一用try&#x2F;catch方式去捕获代码比较臃肿，可以通过SpringMVC提供的控制器增强类统一由一个类去完成异常的捕获。</p>
<p>如下图：</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image022-171082306507711.gif" alt="img"></p>
<h2 id="统一异常处理实现"><a href="#统一异常处理实现" class="headerlink" title="统一异常处理实现"></a><strong>统一异常处理实现</strong></h2><p>根据上边分析的方案，统一在base基础工程实现统一异常处理，各模块依赖了base基础工程都 可以使用。</p>
<p>首先在base基础工程添加需要依赖的包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt; </span><br></pre></td></tr></table></figure>

<p>1、定义一些通用的异常信息</p>
<p>从课程资料&#x2F;工程目录 拷贝CommonError 类到base工程com.xuecheng.base.execption下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 通用错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">CommonError</span> &#123;</span><br><span class="line"></span><br><span class="line">   UNKOWN_ERROR(<span class="string">&quot;执行过程异常，请重试。&quot;</span>),</span><br><span class="line">   PARAMS_ERROR(<span class="string">&quot;非法参数&quot;</span>),</span><br><span class="line">   OBJECT_NULL(<span class="string">&quot;对象为空&quot;</span>),</span><br><span class="line">   QUERY_NULL(<span class="string">&quot;查询结果为空&quot;</span>),</span><br><span class="line">   REQUEST_NULL(<span class="string">&quot;请求参数为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="title function_">CommonError</span><span class="params">( String errMessage)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2、自定义异常类型</p>
<p>在base工程com.xuecheng.base.execption下自定义异常类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 学成在线项目异常类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XueChengPlusException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">XueChengPlusException</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">XueChengPlusException</span><span class="params">(String errMessage)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(errMessage);</span><br><span class="line">      <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> errMessage;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cast</span><span class="params">(CommonError commonError)</span>&#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(commonError.getErrMessage());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cast</span><span class="params">(String errMessage)</span>&#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(errMessage);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>3、响应用户的统一类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 错误响应参数包装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestErrorResponse</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String errMessage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestErrorResponse</span><span class="params">(String errMessage)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.errMessage= errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getErrMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setErrMessage</span><span class="params">(String errMessage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.errMessage = errMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4、全局异常处理器</p>
<p>​    从 Spring 3.0 - Spring 3.2 版本之间，对 Spring 架构和 SpringMVC 的Controller 的异常捕获提供了相应的异常处理。</p>
<p>•     @ExceptionHandler</p>
<p>•     Spring3.0提供的标识在方法上或类上的注解，用来表明方法的处理异常类型。</p>
<p>•     @ControllerAdvice</p>
<p>•     Spring3.2提供的新注解，从名字上可以看出大体意思是控制器增强，    在项目中来增强SpringMVC中的Controller。通常和**@ExceptionHandler** 结合使用，来处理SpringMVC的异常信息。</p>
<p>•     @ResponseStatus</p>
<p>•     Spring3.0提供的标识在方法上或类上的注解，用状态代码和应返回的原因标记方法或异常类。<br> 调用处理程序方法时，状态代码将应用于HTTP响应。</p>
<p>通过上面的两个注解便可实现微服务端全局异常处理，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">package</span> com.xuecheng.base.execption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 全局异常处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@ExceptionHandler(XueChengPlusException.class)</span></span><br><span class="line">   <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">   <span class="keyword">public</span> RestErrorResponse <span class="title function_">customException</span><span class="params">(XueChengPlusException e)</span> &#123;</span><br><span class="line">      log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getErrMessage(),e);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(e.getErrMessage());</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">   <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">   <span class="keyword">public</span> RestErrorResponse <span class="title function_">exception</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line"></span><br><span class="line">      log.error(<span class="string">&quot;【系统异常】&#123;&#125;&quot;</span>,e.getMessage(),e);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestErrorResponse</span>(CommonError.UNKOWN_ERROR.getErrMessage());</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="异常处理测试"><a href="#异常处理测试" class="headerlink" title="异常处理测试"></a><strong>异常处理测试</strong></h2><p>在内容管理的api工程添加base工程的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在异常处理测试之前首先在代码中抛出自定义类型的异常，这里以新增课程的service方法为例进行代码修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> CourseBaseInfoDto <span class="title function_">createCourseBase</span><span class="params">(Long companyId,AddCourseDto dto)</span> &#123;</span><br><span class="line"> ...</span><br><span class="line"><span class="comment">//合法性校验</span></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getName())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程名称为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getMt())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getSt())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程分类为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getGrade())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程等级为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getTeachmode())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;教育模式为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getUsers())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;适应人群&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(dto.getCharge())) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;收费规则为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  。。。</span><br><span class="line">   <span class="keyword">if</span>(charge.equals(<span class="string">&quot;201001&quot;</span>))&#123;</span><br><span class="line">       <span class="keyword">if</span>(courseMarketNew.getPrice() ==<span class="literal">null</span> || courseMarketNew.getPrice().floatValue()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XueChengPlusException</span>(<span class="string">&quot;课程的价格不能为空并且必须大于0&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  。。。</span><br></pre></td></tr></table></figure>



<p>1、首先使用httpclient测试</p>
<p>请求新增课程接口，故意将必填项课程名称设置为空。</p>
<p>测试结果与预期一致，可以捕获异常并响应异常信息，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:63040/content/course</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">500</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Wed, <span class="number">07</span> Sep <span class="number">2022</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">14</span> GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;errMessage&quot;</span>: <span class="string">&quot;课程名称为空。&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、前后端调试</p>
<p>仍然测试新增课程接口，当课程收费的时候必须填写价格，这里设置课程为收费，价格设置为空。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image024-171082306507712.gif" alt="img"></p>
<p>通过测试发现，前端正常提示代码 中抛出的异常信息。</p>
<p><img src="/2024/03/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day03-%E8%AF%BE%E7%A8%8B%E6%9F%A5%E8%AF%A2%E3%80%81%E6%96%B0%E5%A2%9E%E8%AF%BE%E7%A8%8B%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83/clip_image026-171082306507713.gif" alt="img"></p>
<p>至此，项目异常处理的测试完毕，我们在开发中对于业务分支中错误的情况要抛出项目自定义的异常类型。</p>
<h1 id="【面试】1、系统如何处理异常"><a href="#【面试】1、系统如何处理异常" class="headerlink" title="【面试】1、系统如何处理异常?"></a>【面试】1、系统如何处理异常?</h1><p>我们自定义—个统一的异常处理器去捕获并处理异常。<br>使用控制器增加注解@ControllerAdvice和异常处理注解@ExceptionHandler来实现。1)处理自定义异常<br>程序在编写代码时根据校验结果主动抛出自定义异常类对象，抛出异常时指定详细的异常信息，异常处理器捕获异常信息记录异常日志并响应给用户。<br>2)处理未知异常<br>接口执行过程中的一些运行时异常也会由异常处理器统一捕获，记录异常日志，统一响应给用户500错误。在异常处理器中还可以针对某个异常类型进行单独处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/" itemprop="url">学成在线-day02-项目入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-16T21:05:00+08:00">
                2024-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  31
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Git相关问题"><a href="#Git相关问题" class="headerlink" title="Git相关问题"></a>Git相关问题</h1><p>1、Git代码冲突怎么处理?</p>
<p>我们在使用Git时难免会出现代码冲突的问题，出现冲突的原因是因为当本地文件的版本与目标分支中文件的版本不一致时，当存在同一行的内容不同时在进行合并时会出现冲突。</p>
<p>代码冲突一般发生在以下情况: .</p>
<ol>
<li><p>多个分支向主分支合并时</p>
</li>
<li><p>同一个分支下pull或push操作时。</p>
</li>
</ol>
<p>发生了冲突需要手动合并代码，选择最终的版本,可以通过图形界面(merge)完成</p>
<p>2、 <strong>你是在哪个分支开发？</strong></p>
<p>   我们不是直接在主分支开发，由技术经理创建独立的开发分支，我们是在独立的开发分支中进行开发，最后由技术经理将开发分支合并到主分支。</p>
<h1 id="Maven相关问题"><a href="#Maven相关问题" class="headerlink" title="Maven相关问题"></a>Maven相关问题</h1><p>1、maven的常用命令<br>mvn clean &#x2F;&#x2F;清除target目录中的生成结果<br>mvn compile &#x2F;&#x2F;编译源代码<br>mvn test &#x2F;&#x2F;执行单元测试<br>mvn package &#x2F;&#x2F;打包<br>mvn install &#x2F;&#x2F;打包并把打好的包保存到本地仓库<br>myn deploy &#x2F;&#x2F;打包并把打好的包上传到远程仓库</p>
<p>2、maven依赖版本冲突怎么处理？</p>
<p>maven依赖版本冲突-般是由于间接依赖导致一个jar包即有多个不同的版本,比如: A依赖了B的1.0版本，C依赖了B的2.0版本，项目依赖A和C从而间接依赖了B的1.0和2.0版本,此时B有两个版本引入到了项目中，当存在版本冲突时可能会出现ClassNotFoundException、NoSuchMethodError等错误。</p>
<p>处理版本冲突可以使用以下方法:</p>
<p>1、使用exclusions 排除依赖</p>
<p>比如:我们只依赖B的1 .0版本，此时可以在依赖C时排除对B的依赖。</p>
<p>2、使用dependencyManagement锁定版本号。</p>
<p>通常在父工程对依赖的版本统一管理。</p>
<p>比如:我们只依赖B的1 .0版本，此时可以在父工程中限定B的版本为1.0。</p>
<h1 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h1><p>内容管理模块的基础表涉及9张，如下：</p>
<p>使用PowerDesigner打开课程资料下的 “数据库\模型\学成在线项目.sws” </p>
<p> <img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/image-20240316215339582.png" alt="image-20240316215339582"></p>
<h1 id="创建模块工程"><a href="#创建模块工程" class="headerlink" title="创建模块工程"></a>创建模块工程</h1><p><strong>2.1</strong> <strong>模块工程结构</strong></p>
<p>在第一章节创建了项目父工程、项目基础工程，如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/image-20240316215406564.png" alt="image-20240316215406564"></p>
<p>接下来要创建内容管理模块的工程结构。</p>
<p>本项目是一个前后端分离项目，前端与后端开发人员之间主要依据接口进行开发。</p>
<p>下图是前后端交互的流程图：</p>
<p>1、前端请求后端服务提供的接口。（通常为http协议 ）</p>
<p>2、后端服务的控制层Controller接收前端的请求。</p>
<p>3、Contorller层调用Service层进行业务处理。</p>
<p>4、Service层调用Dao持久层对数据持久化。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/image-20240316215424984.png" alt="image-20240316215424984"></p>
<p>整个流程分为前端、接口层、业务层三部分。</p>
<p>所以模块工程的结构如下图所示：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/image-20240316215443208.png" alt="image-20240316215443208"></p>
<p>xuecheng-plus-content-api：接口工程，为前端提供接口。</p>
<p>xuecheng-plus-content-service: 业务工程，为接口工程提供业务支撑。</p>
<p>xuecheng-plus-content-model: 数据模型工程，存储数据模型类、数据传输类型等。</p>
<p>结合项目父工程、项目基础工程后，如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/image-20240316215517468.png" alt="image-20240316215517468"></p>
<p>xuecheng-plus-content：内容管理模块工程，负责聚合xuecheng-plus-content-api、xuecheng-plus-content-service、xuecheng-plus-content-model。</p>
<p>1、首先在项目根目录创建内容管理模块的父工程xuecheng-plus-content</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image002.gif" alt="img"></p>
<p>创建完成，只保留pom.xml文件，删除多余的文件。</p>
<p>内容管理父工程的主要职责是聚合内容管理接口和内容管理接口实现两个工程，它的父工程是</p>
<p>xuecheng-plus-parent。</p>
<p>pom.xml如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xuecheng-plus-content<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xuecheng-plus-content<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>xuecheng-plus-content-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>xuecheng-plus-content-model<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>xuecheng-plus-content-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​        </p>
<p>由于xuecheng-plus-content-api和xuecheng-plus-content-service两个工程还没有创建所以modules报错。</p>
<p>2、在xuecheng-plus-content下创建xuecheng-plus-content-model数据模型工程。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image004.gif" alt="img"></p>
<p>创建完成，只保留包和pom.xml文件 ，删除多余的文件。</p>
<p>修改pom.xml文件</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>3、在xuecheng-plus-content下创建xuecheng-plus-content-service接口实现工程。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image006.gif" alt="img"></p>
<p>创建完成，只保留包和pom.xml文件 ，删除多余的文件</p>
<p>pom.xml如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4、在xuecheng-plus-content下创建xuecheng-plus-content-api接口工程。</p>
<p>xuecheng-plus-content-api接口工程的父工程是xuecheng-plus-content，它依赖了xuecheng-plus-base基础工程。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image008.gif" alt="img"></p>
<p>编辑pom.xml</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>到此内容管理模块的四个工程创建完毕，工程结构图如下：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image010.gif" alt="img"></p>
<h1 id="创建数据库表及PO类型"><a href="#创建数据库表及PO类型" class="headerlink" title="创建数据库表及PO类型"></a>创建数据库表及PO类型</h1><p><strong>3.2.2</strong> <strong>生成<strong><strong>PO</strong></strong>类</strong></p>
<p>PO即持久对象(Persistent Object)，它们是由一组属性和属性的get和set方法组成，PO对应于数据库的表。</p>
<p>在开发持久层代码时需要根据数据表编写PO类，在实际开发中通常使用代码生成器（工具）生成PO类的代码。</p>
<p>由于在需求分析阶段对数据模型进行分析，PO类对应于数据模型，所以在需求分析阶段即可使用工具生成PO类，为下面的接口定义准备好模型类。</p>
<p>在企业开发中通常使用代码生成工具去自动生成这些文件，</p>
<p>本项目使用mybatis-plus的generator工程生成PO类、Mapper接口、Mapper的xml文件，地址在：<a target="_blank" rel="noopener" href="https://github.com/baomidou/generator">https://github.com/baomidou/generator</a></p>
<p>将课程资料目录下的xuecheng-plus-generator.zip解压后拷贝至项目工程根目录，如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image002-17106494387786.gif" alt="img"></p>
<p>打开IDEA将其导入项目工程 ，打开xuecheng-plus-generator工程的pom.xml，右键 点击“Add as Maven Project” 自动识别maven工程。</p>
<p>如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image004-17106494387787.gif" alt="img"></p>
<p>本次生成内容管理模块的PO类、Mapper接口和Mapper的xml文件 ，找到ContentCodeGenerator类，如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image006-17106494387788.gif" alt="img"></p>
<p>修改ContentCodeGenerator类中的信息，包括：数据库地址、数据库账号、数据库密码、生成的表、生成路径，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.generator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.*;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MyBatis-Plus 代码生成类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentCodeGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO 修改服务名以及数据表名</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICE_NAME</span> <span class="operator">=</span> <span class="string">&quot;content&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//数据库账号</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SOURCE_USER_NAME</span>  <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">	<span class="comment">//数据库密码</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_SOURCE_PASSWORD</span>  <span class="operator">=</span> <span class="string">&quot;mysql&quot;</span>;</span><br><span class="line">	<span class="comment">//生成的表</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] TABLE_NAMES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line"><span class="comment">//			&quot;mq_message&quot;,</span></span><br><span class="line"><span class="comment">//			&quot;mq_message_history&quot;</span></span><br><span class="line">			 <span class="string">&quot;course_base&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;course_market&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;teachplan&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;teachplan_media&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;course_teacher&quot;</span>,</span><br><span class="line">			<span class="string">&quot;course_category&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;course_publish&quot;</span>,</span><br><span class="line">			 <span class="string">&quot;course_publish_pre&quot;</span></span><br><span class="line"></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO 默认生成entity，需要生成DTO修改此变量</span></span><br><span class="line">	<span class="comment">// 一般情况下要先生成 DTO类 然后修改此参数再生成 PO 类。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">IS_DTO</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// 代码生成器</span></span><br><span class="line">		<span class="type">AutoGenerator</span> <span class="variable">mpg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoGenerator</span>();</span><br><span class="line">		<span class="comment">// 选择 freemarker 引擎，默认 Velocity</span></span><br><span class="line">		mpg.setTemplateEngine(<span class="keyword">new</span> <span class="title class_">FreemarkerTemplateEngine</span>());</span><br><span class="line">		<span class="comment">// 全局配置</span></span><br><span class="line">		<span class="type">GlobalConfig</span> <span class="variable">gc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GlobalConfig</span>();</span><br><span class="line">		gc.setFileOverride(<span class="literal">true</span>);</span><br><span class="line">		<span class="comment">//生成路径</span></span><br><span class="line">		gc.setOutputDir(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/xuecheng-plus-generator/src/main/java&quot;</span>);</span><br><span class="line">		gc.setAuthor(<span class="string">&quot;itcast&quot;</span>);</span><br><span class="line">		gc.setOpen(<span class="literal">false</span>);</span><br><span class="line">		gc.setSwagger2(<span class="literal">false</span>);</span><br><span class="line">		gc.setServiceName(<span class="string">&quot;%sService&quot;</span>);</span><br><span class="line">        gc.setBaseResultMap(<span class="literal">true</span>);</span><br><span class="line">        gc.setBaseColumnList(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (IS_DTO) &#123;</span><br><span class="line">			gc.setSwagger2(<span class="literal">true</span>);</span><br><span class="line">			gc.setEntityName(<span class="string">&quot;%sDTO&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		mpg.setGlobalConfig(gc);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 数据库配置</span></span><br><span class="line">		<span class="type">DataSourceConfig</span> <span class="variable">dsc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceConfig</span>();</span><br><span class="line">		dsc.setDbType(DbType.MYSQL);</span><br><span class="line">		dsc.setUrl(<span class="string">&quot;jdbc:mysql://192.168.101.65:3306/xcplus_&quot;</span> + SERVICE_NAME</span><br><span class="line">				+ <span class="string">&quot;?serverTimezone=UTC&amp;useUnicode=true&amp;useSSL=false&amp;characterEncoding=utf8&quot;</span>);</span><br><span class="line"><span class="comment">//		dsc.setDriverName(&quot;com.mysql.jdbc.Driver&quot;);</span></span><br><span class="line">		dsc.setDriverName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">		dsc.setUsername(DATA_SOURCE_USER_NAME);</span><br><span class="line">		dsc.setPassword(DATA_SOURCE_PASSWORD);</span><br><span class="line">		mpg.setDataSource(dsc);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 包配置</span></span><br><span class="line">		<span class="type">PackageConfig</span> <span class="variable">pc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageConfig</span>();</span><br><span class="line">		pc.setModuleName(SERVICE_NAME);</span><br><span class="line">		pc.setParent(<span class="string">&quot;com.xuecheng&quot;</span>);</span><br><span class="line"></span><br><span class="line">		pc.setServiceImpl(<span class="string">&quot;service.impl&quot;</span>);</span><br><span class="line">		pc.setXml(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">		pc.setEntity(<span class="string">&quot;model.po&quot;</span>);</span><br><span class="line">		mpg.setPackageInfo(pc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 设置模板</span></span><br><span class="line">		<span class="type">TemplateConfig</span> <span class="variable">tc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplateConfig</span>();</span><br><span class="line">		mpg.setTemplate(tc);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 策略配置</span></span><br><span class="line">		<span class="type">StrategyConfig</span> <span class="variable">strategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StrategyConfig</span>();</span><br><span class="line">		strategy.setNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">		strategy.setColumnNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">		strategy.setEntityLombokModel(<span class="literal">true</span>);</span><br><span class="line">		strategy.setRestControllerStyle(<span class="literal">true</span>);</span><br><span class="line">		strategy.setInclude(TABLE_NAMES);</span><br><span class="line">		strategy.setControllerMappingHyphenStyle(<span class="literal">true</span>);</span><br><span class="line">		strategy.setTablePrefix(pc.getModuleName() + <span class="string">&quot;_&quot;</span>);</span><br><span class="line">		<span class="comment">// Boolean类型字段是否移除is前缀处理</span></span><br><span class="line">		strategy.setEntityBooleanColumnRemoveIsPrefix(<span class="literal">true</span>);</span><br><span class="line">		strategy.setRestControllerStyle(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 自动填充字段配置</span></span><br><span class="line">		strategy.setTableFillList(Arrays.asList(</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;create_date&quot;</span>, FieldFill.INSERT),</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;change_date&quot;</span>, FieldFill.INSERT_UPDATE),</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;modify_date&quot;</span>, FieldFill.UPDATE)</span><br><span class="line">		));</span><br><span class="line">		mpg.setStrategy(strategy);</span><br><span class="line"></span><br><span class="line">		mpg.execute();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改完成，执行该类的main方法，自动生成content包，如下：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image008-17106494387789.gif" alt="img"></p>
<p>在该包下自动生成了内容管理模块的controller、mapper、po及service相关代码，这里我们只需要po类。</p>
<p>将po类拷贝到model工程</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image010-171064943877810.gif" alt="img"></p>
<p>打开一个PO类发现编译报错，这是缺少依赖包导致，本项目使用的持久层框架是MyBatisPlus，在生成的po类中加了一些MyBatisPlus框架的注解，这里需要添加MyBatisPlus框架的依赖，消除错误。</p>
<p>下边在model工程添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--存在mybatisplus注解添加相关注解保证不报错--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-annotation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="接口设计（DTO）"><a href="#接口设计（DTO）" class="headerlink" title="接口设计（DTO）"></a>接口设计（DTO）</h1><p>设计一个接口需要包括以下几个方面：</p>
<p>1）协议 </p>
<p>通常协议采用HTTP，查询类接口通常为get或post，查询条件较少的使用get，较多的使用post。</p>
<p>本接口使用 http post。</p>
<p>还要确定content-type，参数以什么数据格式提交，结果以什么数据格式响应。</p>
<p>一般情况没有特殊情况结果以json 格式响应。</p>
<p>2）分析请求参数</p>
<p>根据前边对数据模型的分析，请求参数为：课程名称、课程审核状态、当前页码、每页显示记录数。</p>
<p>根据分析的请求参数定义模型类。</p>
<p>3）分析响应结果</p>
<p>根据前边对数据模型的分析，响应结果为数据列表加一些分页信息（总记录数、当前页、每页显示记录数）。</p>
<p>数据列表中数据的属性包括：课程id、课程名称、任务数、创建时间、审核状态、类型。</p>
<p>注意：查询结果中的审核状态为数据字典中的代码字段，前端会根据审核状态代码 找到对应的名称显示。</p>
<p>根据分析的响应结果定义模型类。</p>
<p>4）分析完成，使用SpringBoot注解开发一个Http接口。</p>
<p>5）使用接口文档工具查看接口的内容。</p>
<p>6）接口中调用Service方法完成业务处理。</p>
<p>4）接口请求示例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /content/course/list?pageNo=<span class="number">2</span>&amp;pageSize=<span class="number">1</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;courseName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;publishStatus&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring cloud实战&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-09-04 09:56:19&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-12-26 22:10:38&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changePeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditNums&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h2 id="定义模型类"><a href="#定义模型类" class="headerlink" title="定义模型类"></a><strong>定义模型类</strong></h2><p>根据接口分析需要定义模型类接收请求的参数，并定义模型类用于响应结果。</p>
<p>1、分页查询模型类</p>
<p>由于分页查询这一类的接口在项目较多，这里针对分页查询的参数（当前页码、每页显示记录数）单独在xuecheng-plus-base基础工程中定义。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image002-17106621099921.gif" alt="img"></p>
<p>内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.java.Log;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 分页查询通用参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 14:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageParams</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每页记录数默认值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span><span class="number">10L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageParams</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageParams</span><span class="params">(<span class="type">long</span> pageNo,<span class="type">long</span> pageSize)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.pageNo = pageNo;</span><br><span class="line">        <span class="built_in">this</span>.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于上边类中用到了lombok注解所以在base工程添加依赖包如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>2、查询条件模型类</p>
<p>除了分页查询参数，剩下的就是课程查询的特有参数，此时需要在内容管理的model工程中定义课程查询参数模型类。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image004-17106621099932.gif" alt="img"></p>
<p>内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程查询参数Dto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 14:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryCourseParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//审核状态</span></span><br><span class="line">    <span class="keyword">private</span> String auditStatus;</span><br><span class="line">    <span class="comment">//课程名称</span></span><br><span class="line">    <span class="keyword">private</span> String courseName;</span><br><span class="line">    <span class="comment">//发布状态</span></span><br><span class="line">    <span class="keyword">private</span> String publishStatus;</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>3、响应模型类</p>
<p>根据接口分析，下边定义响应结果模型类。</p>
<p>针对分页查询结果经过分析也存在固定的数据和格式，所以在base工程定义一个基础的模型类。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image006-17106621099933.gif" alt="img"></p>
<p>内容如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 分页查询结果模型类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 14:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResult</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> counts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每页记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> pageSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageResult</span><span class="params">(List&lt;T&gt; items, <span class="type">long</span> counts, <span class="type">long</span> page, <span class="type">long</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.items = items;</span><br><span class="line">        <span class="built_in">this</span>.counts = counts;</span><br><span class="line">        <span class="built_in">this</span>.page = page;</span><br><span class="line">        <span class="built_in">this</span>.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现此模型类中定义了List属性，此属性存放数据列表，且支持泛型，课程查询接口的返回类型可以是此模型类型。</p>
<p>List中的数据类型用什么呢？根据需求分析使用生成的PO类即可，所以课程查询接口返回结果类型如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">泛型中填写CourseBase类型。</span><br><span class="line">PageResult&lt;CourseBase&gt;</span><br></pre></td></tr></table></figure>



<h2 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h2><p>根据分析，此接口提供 HTTP post协议，查询条件以json格式提交，响应结果为json 格式。</p>
<p>可使用SpringBoot注解在Controller类中实现。</p>
<p>1、首先在api工程添加依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-content-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--cloud的基础环境包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 的 Spring Web MVC 集成 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 swagger --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spring4all<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、定义controller方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 分页查询结果模型类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 14:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResult</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> counts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每页记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> pageSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PageResult</span><span class="params">(List&lt;T&gt; items, <span class="type">long</span> counts, <span class="type">long</span> page, <span class="type">long</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.items = items;</span><br><span class="line">        <span class="built_in">this</span>.counts = counts;</span><br><span class="line">        <span class="built_in">this</span>.page = page;</span><br><span class="line">        <span class="built_in">this</span>.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：pageParams分页参数通过url的key&#x2F;value传入，queryCourseParams通过json数据传入，使用@RequestBody注解将json转成QueryCourseParamsDto对象。</p>
<p>3、定义启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ContentApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、添加配置文件 </p>
<p>创建 log4j2-dev.xml、bootstrap.yml文件。</p>
<p>log4j2-dev.xml:从课程资料&#x2F;项目工程 获取.</p>
<p>bootstrap.yml内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/content</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63040</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.101.65:3306/xcplus_content148?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mysql</span></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-dev.xml</span></span><br></pre></td></tr></table></figure>



<p>4、下边启动服务，测试接口是否可以正常请求</p>
<p>在controller方法中打断点，debug启动微服务，在浏览器访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/course/list">http://localhost:63040/content/course/list</a></p>
<p>浏览器报400错误，400错误通常由于你访问的页面域名不存在或者请求错误。一般是因为我们输入的语法格式有错误，服务器无法理解用户的请求，不知道要表达的是什么。这个时候我们需要认真检查下语义、请求参数是否有误，不然再怎么刷新都没有用。</p>
<p>接口接收两部分参数，一部分是分页参数，它是通过http url传递key&#x2F;value串，另一部分是业务查询条件，通过http body传入json内容。</p>
<p>服务端使用RequestBody接收json内容，我们在测试并没有传递json内容这里导致错误。</p>
<p>下边在@RequestBody后添加(required&#x3D;false)表示此参数不是必填项，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(<span class="string">&quot;/course/list&quot;</span>)</span><br><span class="line"> public PageResult&lt;CourseBase&gt; list(PageParams pageParams, @RequestBody(required=<span class="literal">false</span>) QueryCourseParamsDto queryCourseParams)&#123;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">return</span> null;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>再次测试，运行到 断点处暂停。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image008-17106621099934.gif" alt="img"></p>
<h2 id="模型类的作用"><a href="#模型类的作用" class="headerlink" title="模型类的作用"></a>模型类的作用</h2><p>现在项目中有两类模型类：DTO数据传输对象、PO持久化对象，DTO用于接口层向业务层之间传输数据，PO用于业务层与持久层之间传输数据，有些项目还会设置VO对象，VO对象用在前端与接口层之间传输数据，如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image010-17106621099935.gif" alt="img"></p>
<p>当前端有多个平台且接口存在差异时就需要设置VO对象用于前端和接口层传输数据。</p>
<p>比如：</p>
<p>课程列表查询接口，根据需求用户在手机端也要查询课程信息，此时课程查询接口是否需要编写手机端和PC端两个接口呢？如果用户要求通过手机和PC的查询条件或查询结果不一样，此时就需要定义两个Controller课程查询接口，每个接口定义VO对象与前端传输数据。</p>
<p>手机查询：根据课程状态查询，查询结果只有课程名称和课程状态。</p>
<p>PC查询：可以根据课程名称、课程状态、课程审核状态等条件查询，查询结果也比手机查询结果内容多。</p>
<p>此时，Service业务层尽量提供一个业务接口，即使两个前端接口需要的数据不一样，Service可以提供一个最全查询结果，由Controller进行数据整合。</p>
<p>如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image012.gif" alt="img"></p>
<p>如果前端的接口没有多样性且比较固定，此时可以取消VO，只用DTO即可。</p>
<p>如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image014.gif" alt="img"></p>
<h1 id="生成接口文档"><a href="#生成接口文档" class="headerlink" title="生成接口文档"></a><strong>生成接口文档</strong></h1><p>在前后端分离开发中通常由后端程序员设计接口，完成后需要编写接口文档，最后将文档交给前端工程师，前端工程师参考文档进行开发。</p>
<p>可以通过一些工具快速生成接口文档 ，本项目通过Swagger生成接口在线文档 。</p>
<p>什么是Swagger？</p>
<p>​    OpenAPI规范（OpenAPI Specification 简称OAS）是Linux基金会的一个项目，试图通过定义一种用来描述API格式或API定义的语言，来规范RESTful服务开发过程，目前版本是V3.0，并且已经发布并开源在github上。</p>
<p>（<a target="_blank" rel="noopener" href="https://github.com/OAI/OpenAPI-Specification%EF%BC%89">https://github.com/OAI/OpenAPI-Specification）</a></p>
<p>​    Swagger是全球最大的OpenAPI规范（OAS）API开发工具框架，Swagger是一个在线接口文档的生成工具，前后端开发人员依据接口文档进行开发。 (<a target="_blank" rel="noopener" href="https://swagger.io/">https://swagger.io/</a>)</p>
<p>Spring Boot 可以集成Swagger，Swaager根据Controller类中的注解生成接口文档 ，只要添加Swagger的依赖和配置信息即可使用它。</p>
<p>1、在API工程添加swagger-spring-boot-starter依赖</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 集成 swagger --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spring4all<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、在 bootstrap.yml中配置swagger的扫描包路径及其它信息，base-package为扫描的包路径，扫描Controller类。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">swagger:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">&quot;学成在线内容管理系统&quot;</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;内容系统管理系统对课程相关信息进行管理&quot;</span></span><br><span class="line">  <span class="attr">base-package:</span> <span class="string">com.xuecheng.content</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>3、在启动类中添加@EnableSwagger2Doc注解</p>
<p>再次启动服务，工程启动起来，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html%E6%9F%A5%E7%9C%8B%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF">http://localhost:63040/content/swagger-ui.html查看接口信息</a></p>
<p>下图为swagger接口文档的界面：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image002-171066516623013.gif" alt="img"></p>
<p>这个文档存在两个问题：</p>
<p>1、接口名称显示course-base-info-controller名称不直观</p>
<p>2、课程查询是post方式只显示post &#x2F;course&#x2F;list即可。</p>
<p>下边进行修改，添加一些接口说明的注解，并且将RequestMapping改为PostMapping，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Api(value = <span class="string">&quot;课程信息编辑接口&quot;</span>,tags = <span class="string">&quot;课程信息编辑接口&quot;</span>)</span><br><span class="line"> @RestController</span><br><span class="line">public class CourseBaseInfoController &#123;</span><br><span class="line"></span><br><span class="line">  @ApiOperation(<span class="string">&quot;课程查询接口&quot;</span>)</span><br><span class="line"> @PostMapping(<span class="string">&quot;/course/list&quot;</span>)</span><br><span class="line">  public PageResult&lt;CourseBase&gt; list(PageParams pageParams, @RequestBody(required=<span class="literal">false</span>) QueryCourseParamsDto queryCourseParams)&#123;</span><br><span class="line">     //....</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、再次启动服务，工程启动起来，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html%E6%9F%A5%E7%9C%8B%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF">http://localhost:63040/content/swagger-ui.html查看接口信息</a></p>
<p>下图为swagger接口文档的界面：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image004-171066516623014.gif" alt="img"></p>
<p>接口文档中会有关于接口参数的说明，在模型类上也可以添加注解对模型类中的属性进行说明，方便对接口文档的阅读。</p>
<p>比如：下边标红的属性名称，可以通过swaager注解标注一个中文名称，方便阅读接口文档。</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image006-171066516623015.gif" alt="img"></p>
<p>标注的方法非常简单：</p>
<p>找到模型类，在属性上添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageParams</span> &#123;</span><br><span class="line"> ...</span><br><span class="line"> <span class="meta">@ApiModelProperty(&quot;当前页码&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModelProperty(&quot;每页记录数默认值&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">30L</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryCourseParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//审核状态</span></span><br><span class="line"><span class="meta">@ApiModelProperty(&quot;审核状态&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String auditStatus;</span><br><span class="line"> <span class="comment">//课程名称</span></span><br><span class="line"> <span class="meta">@ApiModelProperty(&quot;课程名称&quot;)</span></span><br><span class="line"> <span class="keyword">private</span> String courseName;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务，再次进入接口文档，如下图：</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image008-171066516623016.gif" alt="img"></p>
<p>Swagger的常用注解如下：</p>
<p>在Java类中添加Swagger的注解即可生成Swagger接口，常用Swagger注解如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Api：修饰整个类，描述Controller的作用</span><br><span class="line">@ApiOperation：描述一个类的一个方法，或者说一个接口</span><br><span class="line">@ApiParam：单个参数描述</span><br><span class="line">@ApiModel：用对象来接收参数</span><br><span class="line">@ApiModelProperty：用对象接收参数时，描述对象的一个字段</span><br><span class="line">@ApiResponse：HTTP响应其中1个描述</span><br><span class="line">@ApiResponses：HTTP响应整体描述</span><br><span class="line">@ApiIgnore：使用该注解忽略这个API</span><br><span class="line">@ApiError ：发生错误返回的信息</span><br><span class="line">@ApiImplicitParam：一个请求参数</span><br><span class="line">@ApiImplicitParams：多个请求参数</span><br></pre></td></tr></table></figure>

<p>@ApiImplicitParam属性如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>取值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>paramType</td>
<td></td>
<td>查询参数类型</td>
</tr>
<tr>
<td></td>
<td>path</td>
<td>以地址的形式提交数据</td>
</tr>
<tr>
<td></td>
<td>query</td>
<td>直接跟参数完成自动映射赋值</td>
</tr>
<tr>
<td></td>
<td>body</td>
<td>以流的形式提交 仅支持POST</td>
</tr>
<tr>
<td></td>
<td>header</td>
<td>参数在request  headers 里边提交</td>
</tr>
<tr>
<td></td>
<td>form</td>
<td>以form表单的形式提交 仅支持POST</td>
</tr>
<tr>
<td>dataType</td>
<td></td>
<td>参数的数据类型 只作为标志说明，并没有实际验证</td>
</tr>
<tr>
<td></td>
<td>Long</td>
<td></td>
</tr>
<tr>
<td></td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td></td>
<td>接收参数名</td>
</tr>
<tr>
<td>value</td>
<td></td>
<td>接收参数的意义描述</td>
</tr>
<tr>
<td>required</td>
<td></td>
<td>参数是否必填</td>
</tr>
<tr>
<td></td>
<td>true</td>
<td>必填</td>
</tr>
<tr>
<td></td>
<td>false</td>
<td>非必填</td>
</tr>
<tr>
<td>defaultValue</td>
<td></td>
<td>默认值</td>
</tr>
</tbody></table>
<p>使用Swagger可以进行接口的测试。</p>
<p>修改接口内容，添加一些测试代码 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="meta">@ApiOperation(&quot;课程查询接口&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/course/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;CourseBase&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody(required=false)</span> QueryCourseParamsDto queryCourseParams)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBase</span>();</span><br><span class="line">    courseBase.setName(<span class="string">&quot;测试名称&quot;</span>);</span><br><span class="line">    courseBase.setCreateDate(LocalDateTime.now());</span><br><span class="line">    List&lt;CourseBase&gt; courseBases = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    courseBases.add(courseBase);</span><br><span class="line">    <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;CourseBase&gt;(courseBases,<span class="number">10</span>,<span class="number">1</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>debug方式启动，在 return 处打断点，再用swagger请求接口。</p>
<p>通过下图可以看到请求参数已经正常请求至controller方法</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image010-171066516623117.gif" alt="img"></p>
<p>放行继续运行，观察swagger界面，结果可以正常返回</p>
<p><img src="/2024/03/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day02-%E9%A1%B9%E7%9B%AE%E5%85%A5%E9%97%A8/clip_image012-171066516623118.gif" alt="img"></p>
<p>不过存在一个问题就是LocalDateTime类型的数据转json后数据格式并不是我们要的年月日时分秒</p>
<p>在base工程com.xuecheng.base.config包下加配置LocalDateTimeConfig 类实现转json时字符串与LocalDateTime类型的转换，LocalDateTimeConfig 类可从课程资料下的项目工程目录中直接拷贝。</p>
<h1 id="SpringBoot接口开发注解有哪些？【面试】"><a href="#SpringBoot接口开发注解有哪些？【面试】" class="headerlink" title="SpringBoot接口开发注解有哪些？【面试】"></a>SpringBoot接口开发注解有哪些？【面试】</h1><table>
<thead>
<tr>
<th>注解</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>@Controller</td>
<td>标记此类是一个控制器，可以返回视图解析器指定的html页面，通过@ResponseBody可以将结果返回json. xml数据。</td>
</tr>
<tr>
<td>@RestController</td>
<td>相当于@ResponseBody加@Controller，实现rest接口开发，返回json数据，不能返回html页面。</td>
</tr>
<tr>
<td>@RequestMapping</td>
<td>定义接口地址，可以标记在类上也可以标记在方法上，支持http的post. put. get等方法。</td>
</tr>
<tr>
<td>@PostMapping</td>
<td>定义post接口，只能标记在方法上，用于添加记录，复杂条件的查询接口。</td>
</tr>
<tr>
<td>@GetMapping</td>
<td>定义get接口，只能标记在方法上，用于查询接口的定义。</td>
</tr>
<tr>
<td>@PutMapping</td>
<td>定义put接口，只能标记在方法上，用于修改接口的定义。</td>
</tr>
<tr>
<td>@DeleteMapping</td>
<td>定义delete接口，只能标记在方法上，用于删除接口的定义。@RequestBody定义在方法上，用于将json串转成java对象。</td>
</tr>
<tr>
<td>@Pathvarible</td>
<td>接收请求路径中占位符的值.</td>
</tr>
<tr>
<td>@ApiOperation</td>
<td>swagger注解，对接口方法进行说明。</td>
</tr>
<tr>
<td>@Api wagger注解</td>
<td>对接口类进行说明。</td>
</tr>
<tr>
<td>@Autowired</td>
<td>基于类型注入。</td>
</tr>
<tr>
<td>@Resourc</td>
<td>基于名称注入，如果基于名称注入失败转为基于类型注入。</td>
</tr>
</tbody></table>
<h1 id="你项目的开发流程是怎么样的？【面试】"><a href="#你项目的开发流程是怎么样的？【面试】" class="headerlink" title="你项目的开发流程是怎么样的？【面试】"></a>你项目的开发流程是怎么样的？【面试】</h1><p>1、产品人员设计产品原型。</p>
<p>2、讨论需求。</p>
<p>3、分模块设计接口。</p>
<p>4、出接口文档。</p>
<p>5、将接口文档给到前端人员，前后端分离开发。</p>
<p>6、开发完毕进行测试。</p>
<p>7、测试完毕发布项目，由运维人员进行部署安装。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/" itemprop="url">学成在线-day01-项目介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-15T22:34:51+08:00">
                2024-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/" itemprop="url" rel="index">
                    <span itemprop="name">学成在线</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  31
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240315223532295.png" alt="image-20240315223532295"></p>
<p>本项目包括了用户端、机构端、运营端。</p>
<p>核心模块包括:内容管理、媒资管理、课程搜索、订单支付、选课管理、认证授权等。</p>
<p>下图是项目的功能模块图:</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240315224559562.png" alt="image-20240315224559562"></p>
<p>本项目采用前后端分离架构，后端采用SpringBoot.SpringCloud技术栈开发，数据库使用了MySQL，还使用Redis、消息队列、分布式文件系统、Elasticsearch等中间件系统。</p>
<p>划分的微服务包括:内容管理服务、媒资管理服务、搜索服务、订单支付服务、学习中心服务、系统管理服务、认证授权服务、网关服务、注册中心服务、配置中心服务等。</p>
<p>下边介绍业务流程:</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240315224735067.png" alt="image-20240315224735067"></p>
<p>2、课程发布后学生登录平台进行选课、在线学习。</p>
<p>免费课程可直接学习，收费课程需要下单购买。</p>
<p>学生选课流程如下:</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240315224849424.png" alt="image-20240315224849424"></p>
<h1 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h1><p>1、详细说说你的项目吧</p>
<p>从以下几个方面进行项目介绍:</p>
<p>1、项目的背景，包括:是白研还是外包、什么业务、服务的客户群是谁、谁去运营等问题。</p>
<p>2、项目的业务流程</p>
<p>3、项目的功能模块</p>
<p>4、项目的技术架构</p>
<p>5、个人工作职责</p>
<p>6、个人负责模块的详细说明，包括模块的设计，所用到的技术，技术的实现方案等。</p>
<p>一个例子:</p>
<p>我最近参与的项目是我们公司自研的专门针对成人职业技能教育的网络课堂系统，网站提供了成人职业技能培训的相关课程，如:软件开发培训、职业资格证书培训、成人学历教育培训等课程。项目基于B2B2C的业务模式，培训机构可以在平台入驻、发布课程，我们公司作为运营方由专门的人员对发布的课程进行审核，审核通过后课程才可以发布成功，课程包括免费和收费两种形式，对于免费课程普通用户可以直接选课学习，对于收费课程在选课后需要支付成功才可以继续学习。</p>
<p>本项目包括三个端:用户端(学生端)、机构端、运营端。</p>
<p>核心模块包括:内容管理、媒资管理、课程搜索、订单支付、选课管理、认证授权等。</p>
<p>本项目采用前后端分离架构，后端采用SpringBoot、SpringCloud技术栈开发，数据库使用了MySQL，还使用的Redis、消息队列、分布式文件系统、Elasticsearch等中间件系统。</p>
<p>划分的微服务包括:内容管理服务、媒资管理服务、搜索服务、订单支付服务、学习中心服务、系统管理服务、认证授权服务、网关服务、注册中心服务、配置中心服务等。</p>
<p>我在这个项目中负责了内容管理、媒资管理、订单支付模块的设计与开发。</p>
<p>内容管理模块，是对平台上的课程进行管理，课程的相关信息比较多这里在数据库设计了课程基本信息表、课程营销表、课程计划、课程师资表进行存储，培训机构要发布一门课程需要填写课程基本信息、课程营销信息、课程计划信息、课程师资信息，填写完毕后需要提交审核，由运营人员进行课程信息的审核，整个审核过程是程序自动审核加人工确认的方式，通常24小时审核完成。课程审核通过即可发布课程，课程的相关信息会聚合到课程发布表中，这里不仅要将课程信息写到课程发布表还要将课程信息写到索引库、分布式文件系统中，所以这里存在分布式事务的问题，项目使用本地消息表加任务调度的方式去解决这里的分布式事务，保存数据的最终一致性。</p>
<h1 id="项目的技术架构（面试）"><a href="#项目的技术架构（面试）" class="headerlink" title="项目的技术架构（面试）"></a>项目的技术架构（面试）</h1><p>本项目采用前后端分离架构，后端采用SpringBoot、SpringCloud技术栈开发，数据库使用了MySQL，还使用的Redis、消息队列、分布式文件系统、Elasticsearch等中间件系统。</p>
<p>划分的微服务包括：内容管理服务、媒资管理服务、搜索服务、订单支付服务、 学习中心服务、系统管理服务、认证授权服务、网关服务、注册中心服务、配置中心服务等。</p>
<p>下图是项目的技术架构图：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316121844617.png" alt="image-20240316121844617"></p>
<p>各层职责说明如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>用户层</td>
<td>用户层描述了本系统所支持的用户类型包括：pc用户、app用户、h5用户。pc用户通过浏览器访问系统、app用户通过android、ios手机访问系统，H5用户通过h5页面访问系统。</td>
</tr>
<tr>
<td>CDN</td>
<td>CDN全称Content  Delivery Network，即内容分发网络，本系统所有静态资源全部通过CDN加速来提高访问速度。系统静态资源包括：html页面、js文件、css文件、image图片、pdf和ppt及doc教学文档、video视频等。</td>
</tr>
<tr>
<td>负载均衡</td>
<td>系统的CDN层、UI层、服务层及数据层均设置了负载均衡服务，上图仅在UI层前边标注了负载均衡。 每一层的负载均衡会根据系统的需求来确定负载均衡器的类型，系统支持4层负载均衡+7层负载均衡结合的方式，4层负载均衡是指在网络传输层进行流程转发，根据IP和端口进行转发，7层负载均衡完成HTTP协议负载均衡及反向代理的功能，根据url进行请求转发。</td>
</tr>
<tr>
<td>UI层</td>
<td>UI层描述了系统向pc用户、app用户、h5用户提供的产品界面。根据系统功能模块特点确定了UI层包括如下产品界面类型：  1）面向pc用户的门户系统、学习中心系统、教学管理系统、系统管理中心。  2）面向h5用户的门户系统、学习中心系统。  3）面向app用户的门户系统、学习中心系统。</td>
</tr>
<tr>
<td>微服务层</td>
<td>微服务层将系统服务分类三类：业务服务、基础服务、第三方代理服务。 业务服务：主要为学成在线核心业务提供服务，并与数据层进行交互获得数据。 基础服务：主要管理学成在线系统运行所需的配置、日志、任务调度、短信等系统级别的服务。 第三方代理服务：系统接入第三方服务完成业务的对接，例如认证、支付、视频点播&#x2F;直播、用户认证和授权。</td>
</tr>
<tr>
<td>数据层</td>
<td>数据层描述了系统的数据存储的内容类型，关系性数据库：持久化的业务数据使用MySQL。 消息队列：存储系统服务间通信的消息，本身提供消息存取服务，与微服务层的系统服务连接。 索引库：存储课程信息的索引信息，本身提供索引维护及搜索的服务，与微服务层的系统服务连接。 缓存：作为系统的缓存服务，作为微服务的缓存数据便于查询。 文件存储：提供系统静态资源文件的分布式存储服务，文件存储服务器作为CDN服务器的数据来源，CDN上的静态资源将最终在文件存储服务器上保存多份。</td>
</tr>
</tbody></table>
<h1 id="开发工具版本"><a href="#开发工具版本" class="headerlink" title="开发工具版本"></a><strong>开发工具版本</strong></h1><p>开发工具列表：</p>
<table>
<thead>
<tr>
<th>开发工具</th>
<th>版本号</th>
<th>安装位置</th>
</tr>
</thead>
<tbody><tr>
<td>IntelliJ-IDEA</td>
<td>2021.x以上版本</td>
<td>个人电脑</td>
</tr>
<tr>
<td>JDK</td>
<td>1.8.x</td>
<td>个人电脑</td>
</tr>
<tr>
<td>Maven</td>
<td>3.8.x以上版本</td>
<td>个人电脑</td>
</tr>
<tr>
<td>Git</td>
<td>2.37.x</td>
<td>个人电脑</td>
</tr>
<tr>
<td>VMware-workstation</td>
<td>16.x</td>
<td>个人电脑</td>
</tr>
<tr>
<td>CentOS</td>
<td>7.x</td>
<td>虚拟机</td>
</tr>
<tr>
<td>Docker</td>
<td>18.09.0</td>
<td>虚拟机</td>
</tr>
<tr>
<td>Mysql</td>
<td>8.x</td>
<td>docker</td>
</tr>
<tr>
<td>nacos</td>
<td>1.4.1</td>
<td>docker</td>
</tr>
<tr>
<td>rabbitmq</td>
<td>3.8.34</td>
<td>docker</td>
</tr>
<tr>
<td>redis</td>
<td>6.2.7</td>
<td>docker</td>
</tr>
<tr>
<td>xxl-job-admin</td>
<td>2.3.1</td>
<td>docker</td>
</tr>
<tr>
<td>minio</td>
<td>RELEASE.2022-09-07</td>
<td>docker</td>
</tr>
<tr>
<td>elasticsearch</td>
<td>7.12.1</td>
<td>docker</td>
</tr>
<tr>
<td>kibana</td>
<td>7.12.1</td>
<td>docker</td>
</tr>
<tr>
<td>gogs</td>
<td>0.13.0</td>
<td>docker</td>
</tr>
<tr>
<td>nginx</td>
<td>1.12.2</td>
<td>docker</td>
</tr>
</tbody></table>
<h1 id="2-IDEA环境配置"><a href="#2-IDEA环境配置" class="headerlink" title="2 IDEA环境配置"></a>2 <strong>IDEA环境配置</strong></h1><p>安装指定版本的IDEA，根据下边的步骤进行配置。</p>
<h2 id="2-1-编码配置"><a href="#2-1-编码配置" class="headerlink" title="2.1 编码配置"></a><strong>2.1 编码配置</strong></h2><p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130313055.png" alt="image-20240316130313055"></p>
<h2 id="2-2-自动导包设置"><a href="#2-2-自动导包设置" class="headerlink" title="2.2 自动导包设置"></a>2.2 <strong>自动导包设置</strong></h2><p>IDEA可以自动优化导入包，<strong>但是有多个同名的类调用不同的包，必须自己手动Alt+Enter设置</strong>， 下面可以通过设置来进行导包优化。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130335930.png" alt="image-20240316130335930"></p>
<h2 id="2-3-提示忽略大小写"><a href="#2-3-提示忽略大小写" class="headerlink" title="2.3 提示忽略大小写"></a>2.3 <strong>提示忽略大小写</strong></h2><p>IDEA代码提示默认是区分大小写的，设置为提示忽略大小写，编译我们后期的开发</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130458317.png" alt="image-20240316130458317"></p>
<h2 id="2-4-设置-Java-编译级别"><a href="#2-4-设置-Java-编译级别" class="headerlink" title="2.4 设置 Java 编译级别"></a>2.4 <strong>设置 Java 编译级别</strong></h2><p>工程创建成功，点击Project Structure:</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130658125.png" alt="image-20240316130658125"></p>
<p>点击Project，设置SDK为1.8及Project language level，如下图：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130706712.png" alt="image-20240316130706712"></p>
<h1 id="3-Maven环境"><a href="#3-Maven环境" class="headerlink" title="3 Maven环境"></a>3 Maven环境</h1><h2 id="3-1-安装Maven"><a href="#3-1-安装Maven" class="headerlink" title="3.1 安装Maven"></a>3.1 安装Maven</h2><p>下载maven3.8.6版本，下载链接如下：</p>
<p><a target="_blank" rel="noopener" href="https://dlcdn.apache.org/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.zip">https://dlcdn.apache.org/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.zip</a></p>
<p>解压apache-maven-3.8.6-bin.zip到没有中文的目录下。</p>
<h2 id="3-2-配置仓库"><a href="#3-2-配置仓库" class="headerlink" title="3.2 配置仓库"></a>3.2 <strong>配置仓库</strong></h2><p>1、解压课程资料中的maven仓库下的repository.zip到本地硬盘</p>
<p>2、在Maven的conf目录中setting.xml文件中配置本地仓库的地址。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130724357.png" alt="image-20240316130724357"></p>
<p>配置中央仓库位置：</p>
<p>在setting.xml文件中配置阿里云中央仓库地址。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130735726.png" alt="image-20240316130735726"></p>
<h2 id="3-3-IDEA中配置maven"><a href="#3-3-IDEA中配置maven" class="headerlink" title="3.3 IDEA中配置maven"></a><strong>3.3 IDEA中配置maven</strong></h2><p>在IDEA中配置maven：进入 File –&gt; Settings –&gt; Build –&gt; Build Tools –&gt; Maven</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130744860.png" alt="image-20240316130744860"></p>
<p>配置maven安装目录、setting.xml及本地仓库的位置。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316130752766.png" alt="image-20240316130752766"></p>
<h1 id="4-安装虚拟机"><a href="#4-安装虚拟机" class="headerlink" title="4 安装虚拟机"></a>4 安装虚拟机</h1><p>项目中用到的一些服务端软件如：MySQL、Nacos配置中心、RabbitMQ消息队列等通常会安装在企业局域网的服务器中，开发人员去远程连接它们。在教学中我们在自己的电脑上安装虚拟机，虚拟机代表了企业局域网中的服务器。</p>
<p>服务器操作系统使用Centos7，导入我发的虚拟机文件，也可以自行安装Centos7虚拟机。</p>
<p>1、导入虚拟机：</p>
<p>首先安装VMware-workstation 16.x 虚拟机软件。</p>
<p>1）设置网络</p>
<p>点击 “编辑–》虚拟网络编辑器”配置网络地址，地址须与下图一致。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316132214804.png" alt="image-20240316132214804"></p>
<p>设置子网IP：192.168.101.0，子网掩码：255.255.255.0。</p>
<p>2）导入虚拟机</p>
<p>解压老师提供的虚拟机文件，进入解压后的文件架，双击”CentOS 7 64 位.vmx” 文件，选择复制虚拟机。</p>
<p>对此虚拟机的设置建议8G内存、4核CPU。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316132226183.png" alt="image-20240316132226183"></p>
<p>设置完成，启动虚拟机。</p>
<p>注意：虚拟机的IP地址为192.168.101.65，不用修改IP地址。</p>
<p>3）远程连接虚拟机</p>
<p>使用ssh客户端工具FinalShell远程 连接 虚拟机中的CentOS系统。</p>
<p>IP地址：192.168.101.65</p>
<p>账号与密码为：root&#x2F;centos</p>
<p>执行 systemctl start docker 启动docker。</p>
<p>运行： sh &#x2F;data&#x2F;soft&#x2F;restart.sh  </p>
<p>查询docker容器：docker ps</p>
<p>如下图：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316134639621.png" alt="image-20240316134639621"></p>
<p>2、自行安装虚拟机：</p>
<p>首先安装VMware-workstation 16.x 虚拟机软件。</p>
<p>Centos7的安装文件在常用软件工具目录下的centos7目录中，也可以自行下载CentOS7的安装包，下载地址：<a target="_blank" rel="noopener" href="http://isoredirect.centos.org/centos/7/isos/x86_64/">http://isoredirect.centos.org/centos/7/isos/x86_64/</a> </p>
<p>CentOS7只提供了64位，这里选择DVD版本下载。</p>
<p>安装CentOS7，在VMware中新建一个虚拟机，选择刚才下载的CentOS7的iso映像文件，然后一步一步进行安装，具体可以参考centos7目录中的centos7安装.docx。</p>
<h1 id="5-安装数据库环境"><a href="#5-安装数据库环境" class="headerlink" title="5 安装数据库环境"></a>5 安装数据库环境</h1><p>1、启动虚拟机中的Docker及容器</p>
<p>保证mysql数据库启动成功</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316134745336.png" alt="image-20240316134745336"></p>
<p>2、安装数据库客户端工具，可使用软件工具目录的datagrip-2022.2.2.win.zip，也可自行下载。</p>
<p>3、远程连接数据库</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316134805028.png" alt="image-20240316134805028"></p>
<p>密码：mysql，用户名：root</p>
<p>到此数据库环境搭建成功。</p>
<h1 id="6-安装Git环境"><a href="#6-安装Git环境" class="headerlink" title="6 安装Git环境"></a>6 安装Git环境</h1><h2 id="6-1-安装Git"><a href="#6-1-安装Git" class="headerlink" title="6.1 安装Git"></a>6.1 安装Git</h2><p>在个人电脑安装Git，使用常用软件工具目录中的Git-2.37.3-64-bit.exe。</p>
<p>也可以自行下载，地址：<a target="_blank" rel="noopener" href="https://git-scm.com/">https://git-scm.com/</a>  （windows版本：<a target="_blank" rel="noopener" href="https://git-scm.com/download/win%EF%BC%89">https://git-scm.com/download/win）</a></p>
<p>安装成功，在右键菜单出现Git菜单，如下图</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135012947.png" alt="image-20240316135012947"></p>
<p>配置git邮箱：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;你的名字&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;你的邮箱&quot;</span></span><br></pre></td></tr></table></figure>

<p>安装成功在IDEA中配置git的安装目录</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135043880.png" alt="image-20240316135043880"></p>
<h2 id="6-2-搭建Gogs"><a href="#6-2-搭建Gogs" class="headerlink" title="6.2 搭建Gogs"></a>6.2 搭建Gogs</h2><p>在发放的虚拟机中已经安装了Gogs 服务，Gogs和GitHub、GitLab都是Git托管平台，Gogs相比它们两者更轻量。Gogs的官网地址：<a target="_blank" rel="noopener" href="https://gogs.io/%EF%BC%8C%E6%9C%AC%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8Gogs%E4%BD%9C%E4%B8%BAGit%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93%E3%80%82">https://gogs.io/，本项目使用Gogs作为Git远程仓库。</a></p>
<p>每位同学把虚拟上的Gogs服务作为远程仓库，每天练习的代码都需要上传至Gogs。</p>
<p>如果个人虚拟机Gogs存在问题也可以使用其它git仓库，比如：gitee.com等。</p>
<p>下边介绍Gogs的基本使用方法</p>
<p>进入Gogs：<a target="_blank" rel="noopener" href="http://192.168.101.65:10880/gogs/xuecheng-plus">http://192.168.101.65:10880</a>  </p>
<p>账号&#x2F;密码：gogs&#x2F;gogs</p>
<p>1、首先创建一个组织</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135121982.png" alt="image-20240316135121982"></p>
<p>创建成功，进入管理面板修改组织信息</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135300709.png" alt="image-20240316135300709"></p>
<p>点击编辑，填写组织名称。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135413371.png" alt="image-20240316135413371"></p>
<p>修改成功，进入首页点击组织名称</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135429648.png" alt="image-20240316135429648"></p>
<p>下边开始创建团队</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135445018.png" alt="image-20240316135445018"></p>
<p>假如创建研发团队，填写团队名称</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135516120.png" alt="image-20240316135516120"></p>
<p>选择权限等级，注意：这里即使选择了权限等级也需要在仓库管理中去管理协作者的权限。</p>
<p> 团队创建成功</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135535238.png" alt="image-20240316135535238"></p>
<p>团队创建成功下边开始创建成员账号 。</p>
<p> 首先在用户管理中添加账号分配给成员。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135716687.png" alt="image-20240316135716687"></p>
<p> 团队和组织创建完成，下边创建仓库，进入组织，创建仓库。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135747358.png" alt="image-20240316135747358"></p>
<p>填写仓库信息</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135849305.png" alt="image-20240316135849305"></p>
<p>创建成功，仓库地址：<a target="_blank" rel="noopener" href="http://192.168.101.65:10880/xuecheng-plus-group1/xuecheng-plus-group1.git%EF%BC%8C%E5%A6%82%E4%B8%8B">http://192.168.101.65:10880/xuecheng-plus-group1/xuecheng-plus-group1.git，如下</a></p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316135908676.png" alt="image-20240316135908676"></p>
<h1 id="7-Git环境"><a href="#7-Git环境" class="headerlink" title="7 Git环境"></a>7 Git环境</h1><h2 id="7-1-拉取代码"><a href="#7-1-拉取代码" class="headerlink" title="7.1  拉取代码"></a>7.1  拉取代码</h2><p>本项目使用Git进行版本控制，在gogs上创建一个个人使用的git仓库：<a target="_blank" rel="noopener" href="http://192.168.101.65:10880/xuecheng-plus-group01/xuecheng-plus.git%EF%BC%8C%E5%A6%82%E6%9E%9Cgogs%E5%AE%89%E8%A3%85%E6%9C%89%E9%97%AE%E9%A2%98%E4%B9%9F%E5%8F%AF%E8%87%AA%E8%A1%8C%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E5%85%AC%E7%BD%91%E7%9A%84Git%E4%BB%93%E5%BA%93%EF%BC%8C%E6%AF%94%E5%A6%82%EF%BC%9Agitee%E3%80%81github%EF%BC%8C%E6%B3%A8%E5%86%8C%E8%87%AA%E5%B7%B1%E7%9A%84%E8%B4%A6%E5%8F%B7%E5%B9%B6%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E3%80%82">http://192.168.101.65:10880/xuecheng-plus-group01/xuecheng-plus.git，如果gogs安装有问题也可自行选择一个公网的Git仓库，比如：gitee、github，注册自己的账号并创建仓库。</a></p>
<p>使用git拉取远程仓库。</p>
<p>打开IDEA，从版本控制创建工程。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141129367.png" alt="image-20240316141129367"></p>
<p>输入仓库地址，并选择工程路径。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141135408.png" alt="image-20240316141135408"></p>
<p>创建成功：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141142079.png" alt="image-20240316141142079"></p>
<p>添加.gitignore文件，编辑内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">HELP.md</span><br><span class="line">target/</span><br><span class="line">!.mvn/wrapper/maven-wrapper.jar</span><br><span class="line">!**/src/main<span class="comment">/**</span></span><br><span class="line"><span class="comment">!**/</span>src/test<span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### STS ###</span></span><br><span class="line"><span class="comment">.apt_generated</span></span><br><span class="line"><span class="comment">.classpath</span></span><br><span class="line"><span class="comment">.factorypath</span></span><br><span class="line"><span class="comment">.project</span></span><br><span class="line"><span class="comment">.settings</span></span><br><span class="line"><span class="comment">.springBeans</span></span><br><span class="line"><span class="comment">.sts4-cache</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### IntelliJ IDEA ###</span></span><br><span class="line"><span class="comment">.idea</span></span><br><span class="line"><span class="comment">*.iws</span></span><br><span class="line"><span class="comment">*.iml</span></span><br><span class="line"><span class="comment">*.ipr</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### NetBeans ###</span></span><br><span class="line"><span class="comment">/nbproject/private/</span></span><br><span class="line"><span class="comment">/nbbuild/</span></span><br><span class="line"><span class="comment">/dist/</span></span><br><span class="line"><span class="comment">/nbdist/</span></span><br><span class="line"><span class="comment">/.nb-gradle/</span></span><br><span class="line"><span class="comment">build/</span></span><br><span class="line"><span class="comment">logs/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### VS Code ###</span></span><br><span class="line"><span class="comment">.vscode/</span></span><br></pre></td></tr></table></figure>

<p>提交代码到git仓库。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141209775.png" alt="image-20240316141209775"></p>
<p>执行push：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141408170.png" alt="image-20240316141408170"></p>
<p>如果是首次向该git仓库提交代码需要输入账号和密码：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141420764.png" alt="image-20240316141420764"></p>
<p>可以输入默认的账号和密码：gogs&#x2F;gogs</p>
<p>如果账号密码输入错误报异常：Incorrect username or password (access token)  </p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141434226.png" alt="image-20240316141434226"></p>
<p>如果没有权限访问此仓库则报403错误：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141446568.png" alt="image-20240316141446568"></p>
<p>此时就需要在仓库成员管理界面将账号添加到此仓库即可。</p>
<p>如果忘记密码，此时可以先修改gogs中的密码，再修改windows凭据的密码，</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316141458062.png" alt="image-20240316141458062"></p>
<p>在此界面中找到远程仓库的记录，修改密码。</p>
<p>如果在windows凭据中找不到指定记录可以设置IDEA不记录密码</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316171755987.png" alt="image-20240316171755987"></p>
<p>在此界面中找到远程仓库的记录，修改密码。</p>
<p>如果在windows凭据中找不到指定记录可以设置IDEA不记录密码</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316171806767.png" alt="image-20240316171806767"></p>
<h2 id="7-2-创建开发分支"><a href="#7-2-创建开发分支" class="headerlink" title="7.2  创建开发分支"></a>7.2  创建开发分支</h2><p>通常不会在主分支进行开发，本项目在dev开发分支进行开发，下边创建开发分支。</p>
<p>新建一个分支，点击IDEA右下角的分支标识：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316171908635.png" alt="image-20240316171908635"></p>
<p>点击：Create</p>
<p>创建成功，右下角已经显示了dev分支</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316171958844.png" alt="image-20240316171958844"></p>
<p>打开Git Log：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316172015950.png" alt="image-20240316172015950"></p>
<p>下边将dev分支提交到远程仓库</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316172055714.png" alt="image-20240316172055714"></p>
<p>push成功，查看远程git仓库界面显示了dev分支：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316172230895.png" alt="image-20240316172230895"></p>
<p>接下来我们就在dev分支进行开发，开发完成后将合并到主分支。</p>
<p>要求：学生在练习每天老师布置的作业前都创建一个新分支进行。</p>
<h1 id="8-基础工程搭建"><a href="#8-基础工程搭建" class="headerlink" title="8 基础工程搭建"></a>8 基础工程搭建</h1><h2 id="8-1-工程结构关系"><a href="#8-1-工程结构关系" class="headerlink" title="8.1 工程结构关系"></a>8.1 工程结构关系</h2><p>​        学成在线使用 Maven 来进行项目的管理和构建。整个项目分为三大类工程：父工程、基础工程 和微服务工程。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316210412004.png" alt="image-20240316210412004"></p>
<p>每一种类的工程都有不同的作用，下面是对其功能进行说明：</p>
<ul>
<li>父工程<ul>
<li>对依赖包的版本进行管理 </li>
<li>本身为Pom工程，对子工程进行聚合管理</li>
</ul>
</li>
<li><h2 id="基础工程-继承父类工程-提供基础类库-提供工具类库"><a href="#基础工程-继承父类工程-提供基础类库-提供工具类库" class="headerlink" title="基础工程- 继承父类工程- 提供基础类库- 提供工具类库"></a>基础工程<br>- 继承父类工程<br>- 提供基础类库<br>- 提供工具类库</h2></li>
<li>微服务工程<ul>
<li>分别从业务、技术方面划分模块，每个模块构建为一个微服务。</li>
<li>每个微服务工程依赖基础工程，间接继承父工程。</li>
<li>包括：内容管理服务、媒资管理服务、搜索服务、订单支付服务等。</li>
</ul>
</li>
</ul>
<h2 id="8-2-构建父工程"><a href="#8-2-构建父工程" class="headerlink" title="8.2 构建父工程"></a>8.2 构建父工程</h2><p>父工程的职责是对依赖包的版本进行管理，本小节创建父工程分两步，第一创建父工程，第二在pom.xml编辑依赖管理。</p>
<p>1、首先创建父工程</p>
<p>为了对代码更好的进行权限管理，这里我们单独创建父工程。</p>
<p>使用idea打开工程目录，进入工程结构界面。</p>
<p>点击File–&gt;Project Structure: </p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316200949058.png" alt="image-20240316200949058"></p>
<p>进入Project Structure,首先检查jdk是否配置正确，并进行配置。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316201324805.png" alt="image-20240316201324805"></p>
<p>进入Modules界面，新建模块</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316201936842.png" alt="image-20240316201936842"></p>
<p>创建成功，删除多余文件</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316204914180.png" alt="image-20240316204914180"></p>
<p>选择要删除的文件，进行删除</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316204927459.png" alt="image-20240316204927459"></p>
<p>删除成功</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316204936797.png" alt="image-20240316204936797"></p>
<p>到此父工程创建完成。</p>
<p>2、依赖管理定义</p>
<p>下边开始编辑xuecheng-plus-parent父工程的依赖管理 。</p>
<p>父工程中没有代码，不用去依赖其它的包，它的作用是限定其它子工程依赖包的版本号，即在dependencyManagement 中去编辑即可。</p>
<p>1）确定父工程为一个pom工程，在pom.xml中添加如下内容：</p>
<p>&lt;packaging&gt;pom&lt;packaging&gt;</p>
<p>2）编辑依赖的包的版本号、打包插件等。</p>
<p>pom.xml如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.xuecheng&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xuecheng-plus-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;xuecheng-plus-parent&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;xuecheng-plus-parent&lt;/description&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;<span class="number">1.8</span>&lt;/java.version&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-<span class="number">8</span>&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-<span class="number">8</span>&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;spring-boot.version&gt;<span class="number">2.3</span><span class="number">.7</span>.RELEASE&lt;/spring-boot.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Hoxton.SR9&lt;/spring-cloud.version&gt;</span><br><span class="line">        &lt;org.mapstruct.version&gt;<span class="number">1.3</span><span class="number">.1</span>.Final&lt;/org.mapstruct.version&gt;</span><br><span class="line">        &lt;spring-cloud-alibaba.version&gt;<span class="number">2.2</span><span class="number">.6</span>.RELEASE&lt;/spring-cloud-alibaba.version&gt;</span><br><span class="line">        &lt;org.projectlombok.version&gt;<span class="number">1.18</span><span class="number">.8</span>&lt;/org.projectlombok.version&gt;</span><br><span class="line">        &lt;javax.servlet-api.version&gt;<span class="number">4.0</span><span class="number">.1</span>&lt;/javax.servlet-api.version&gt;</span><br><span class="line">        &lt;fastjson.version&gt;<span class="number">1.2</span><span class="number">.83</span>&lt;/fastjson.version&gt;</span><br><span class="line">        &lt;druid-spring-boot-starter.version&gt;<span class="number">1.2</span><span class="number">.8</span>&lt;/druid-spring-boot-starter.version&gt;</span><br><span class="line">        &lt;mysql-connector-java.version&gt;<span class="number">8.0</span><span class="number">.30</span>&lt;/mysql-connector-java.version&gt;</span><br><span class="line">        &lt;mybatis-plus-boot-starter.version&gt;<span class="number">3.4</span><span class="number">.1</span>&lt;/mybatis-plus-boot-starter.version&gt;</span><br><span class="line">        &lt;commons-lang.version&gt;<span class="number">2.6</span>&lt;/commons-lang.version&gt;</span><br><span class="line">        &lt;minio.version&gt;<span class="number">8.4</span><span class="number">.3</span>&lt;/minio.version&gt;</span><br><span class="line">        &lt;xxl-job-core.version&gt;<span class="number">2.3</span><span class="number">.1</span>&lt;/xxl-job-core.version&gt;</span><br><span class="line">        &lt;swagger-annotations.version&gt;<span class="number">1.5</span><span class="number">.20</span>&lt;/swagger-annotations.version&gt;</span><br><span class="line">        &lt;commons-lang3.version&gt;<span class="number">3.10</span>&lt;/commons-lang3.version&gt;</span><br><span class="line">        &lt;okhttp.version&gt;<span class="number">4.8</span><span class="number">.1</span>&lt;/okhttp.version&gt;</span><br><span class="line">        &lt;swagger-spring-boot-starter.version&gt;<span class="number">1.9</span><span class="number">.0</span>.RELEASE&lt;/swagger-spring-boot-starter.version&gt;</span><br><span class="line">        &lt;elasticsearch.version&gt;<span class="number">7.12</span><span class="number">.1</span>&lt;/elasticsearch.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line"></span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;<span class="keyword">import</span>&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;<span class="keyword">import</span>&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud-alibaba.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;<span class="keyword">import</span>&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- lombok，简化类的构建--&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;org.projectlombok.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- mapstruct 代码生成器，简化java bean之间的映射 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mapstruct-jdk8&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;org.mapstruct.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mapstruct-processor&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;org.mapstruct.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;io.swagger&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;swagger-annotations&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;swagger-annotations.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- Servlet 容器管理 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;javax.servlet-api.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- fastjson ，json解析工具 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;fastjson.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- druid 连接池管理 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;druid-spring-boot-starter.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- mySQL数据库驱动包管理 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;mysql-connector-java.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- mybatis plus 集成Spring Boot启动器 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;mybatis-plus-boot-starter.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- mybatis plus 代码生成器 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;mybatis-plus-boot-starter.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!-- 工具类管理 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;commons-lang&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;commons-lang&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;commons-lang.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!-- 分布式文件系统 minIO的客户端API包 --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;io.minio&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;minio&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;minio.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!--google推荐的一套工具类库--&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.google.guava&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;guava&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;<span class="number">25.0</span>-jre&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!--分布式任务调度--&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.xuxueli&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;xxl-job-core.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;!--Spring boot单元测试--&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">                &lt;exclusions&gt;</span><br><span class="line">                    &lt;exclusion&gt;</span><br><span class="line">                        &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;</span><br><span class="line">                        &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;</span><br><span class="line">                    &lt;/exclusion&gt;</span><br><span class="line">                &lt;/exclusions&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;okhttp&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;okhttp.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;commons-lang3.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;com.spring4all&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;swagger-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;swagger-spring-boot-starter.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;elasticsearch.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;elasticsearch.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;finalName&gt;$&#123;project.name&#125;&lt;/finalName&gt;</span><br><span class="line">        &lt;!--编译打包过虑配置--&gt;</span><br><span class="line">        &lt;resources&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">                &lt;filtering&gt;<span class="literal">true</span>&lt;/filtering&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;**<span class="comment">/*&lt;/include&gt;</span></span><br><span class="line"><span class="comment">                &lt;/includes&gt;</span></span><br><span class="line"><span class="comment">            &lt;/resource&gt;</span></span><br><span class="line"><span class="comment">            &lt;resource&gt;</span></span><br><span class="line"><span class="comment">                &lt;directory&gt;src/main/java&lt;/directory&gt;</span></span><br><span class="line"><span class="comment">                &lt;includes&gt;</span></span><br><span class="line"><span class="comment">                    &lt;include&gt;**/</span>*.xml&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">            &lt;/resource&gt;</span><br><span class="line">        &lt;/resources&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;<span class="number">3.8</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;!--指定项目源码jdk的版本--&gt;</span><br><span class="line">                    &lt;source&gt;<span class="number">1.8</span>&lt;/source&gt;</span><br><span class="line">                    &lt;!--指定项目编译后的jdk的版本--&gt;</span><br><span class="line">                    &lt;target&gt;<span class="number">1.8</span>&lt;/target&gt;</span><br><span class="line">                    &lt;!--配置注解预编译--&gt;</span><br><span class="line">                    &lt;annotationProcessorPaths&gt;</span><br><span class="line">                        &lt;path&gt;</span><br><span class="line">                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                            &lt;version&gt;$&#123;org.projectlombok.version&#125;&lt;/version&gt;</span><br><span class="line">                        &lt;/path&gt;</span><br><span class="line">                    &lt;/annotationProcessorPaths&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!--责处理项目资源文件并拷贝到输出目录，如果有额外的资源文件目录则需要配置--&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;<span class="number">3.3</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;encoding&gt;utf-<span class="number">8</span>&lt;/encoding&gt;</span><br><span class="line">                    &lt;!--使用默认分隔符，resource中可以使用分割符定义过虑的路径--&gt;</span><br><span class="line">                    &lt;useDefaultDelimiters&gt;<span class="literal">true</span>&lt;/useDefaultDelimiters&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<h2 id="8-3-构建基础工程"><a href="#8-3-构建基础工程" class="headerlink" title="8.3 构建基础工程"></a>8.3 构建基础工程</h2><p>基础工程的职责是提供一些系统架构所需要的基础类库以及一此工具类库。</p>
<p>1、首先创建基础工程xuecheng-plus-base。</p>
<p>创建的过程同父工程的创建过程，如下图：</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316210109126.png" alt="image-20240316210109126"></p>
<p>删除多余的文件</p>
<p>这里需要注意的是xuecheng-plus-base的父工程为xuecheng-plus-parent，xuecheng-plus-base的pom.xml的如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- fast Json --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- servlet Api 依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 通用组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--根据扩展名取mimetype--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.j256.simplemagic<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simplemagic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-module-parameter-names<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>基础工程中的内容待需要时再行开发。</p>
<p>至此父工程和基础工程创建完成，最后提交至git。</p>
<p><img src="/2024/03/15/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day01-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/image-20240316210215061.png" alt="image-20240316210215061"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://2698022795.github.io/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="章北海">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/" itemprop="url">微服务-day06-rabbitMQ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">

			
		  
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-03-11T23:04:28+08:00">
                2024-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="消息可靠性问题"><a href="#消息可靠性问题" class="headerlink" title="消息可靠性问题"></a>消息可靠性问题</h1><ol>
<li>消费者和MQ通信异常</li>
<li>MQ出现bug挂了</li>
<li>交易服务挂了，订单状态更新失败</li>
</ol>
<h1 id="发送者的可靠性"><a href="#发送者的可靠性" class="headerlink" title="发送者的可靠性"></a>发送者的可靠性</h1><h2 id="生产者重连"><a href="#生产者重连" class="headerlink" title="生产者重连"></a>生产者重连</h2><p>有的时候由于网络波动，可能会出现客户端连接MQ失败的情况。通过配置我们可以开启连接失败后的重连机制：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">connection-timeout:</span> <span class="string">1s</span> <span class="comment"># 设置MQ的连接超时时间</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启超时重试机制</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment"># 失败后的初始等待时间</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment"># 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment"># 最大重试次数</span></span><br></pre></td></tr></table></figure>

<p>注意<br>        当网络不稳定的时候，利用重试机制可以有效提高消息发送的成功率。不过SpringAMQP提供的重试机制是<strong>阻塞式</strong>的重试，也就是说多次重试等待的过程中，当前线程是被阻塞的，会影响业务性能。<br>        如果对于业务性能有要求，建议<strong>禁用</strong>重试机制。如果一定要使用，请合理配置等待时长和重试次数，当然也可以考虑使用<strong>异步</strong>线程来执行发送消息的代码。</p>
<h2 id="生产者确认"><a href="#生产者确认" class="headerlink" title="生产者确认"></a>生产者确认</h2><p>RabbitMQ有Publisher Confirm和Publisher Return两种机制。开启确认机制后，在MQ成功收到消息后会返回确认消息给生产者。返回的结果有以下几种情况：</p>
<ul>
<li>消息投递到了MQ，但是路由失败。此时会通过PublisherReturn返回路由异常原因，然后返回ACK，告知投递成功。</li>
<li>临时消息投递到了MQ，并且入队成功，返回ACK，告知投递成功</li>
<li>持久消息投递到了MQ，并且入队完成持久化，返回ACK，告知投递成功</li>
<li>其他情况都会返回NACK，告知投递失败</li>
</ul>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312131407485.png" alt="image-20240312131407485"></p>
<p>实现步骤</p>
<ol>
<li><p>在publisher这个微服务的application.yaml中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># 开启publisher confirm机制，并设置confirm类型</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 开启publisher return机制</span></span><br></pre></td></tr></table></figure>

<p>这里<code>publisher-confirm-type</code>有三种模式可选：</p>
<ul>
<li><code>none</code>：关闭confirm机制</li>
<li><code>simple</code>：同步阻塞等待MQ的回执</li>
<li><code>correlated</code>：MQ异步回调返回回执</li>
</ul>
<p>一般我们推荐使用<code>correlated</code>，回调机制。</p>
</li>
<li><p>每个 rabbitTemplate 只能配置一个ReturnCallback，因此需要在项目启动过程中配置。</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312131919068.png" alt="image-20240312131919068"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.publisher.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnsCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;触发return callback,&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());</span><br><span class="line">                log.debug(<span class="string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());</span><br><span class="line">                log.debug(<span class="string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());</span><br><span class="line">                log.debug(<span class="string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());</span><br><span class="line">                log.debug(<span class="string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送消息，指定消息ID，消息ConfirmCallback</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312132058059.png" alt="image-20240312132058059"></p>
</li>
</ol>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312134209676.png" alt="image-20240312134209676"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312134309448.png" alt="image-20240312134309448"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312134352110.png" alt="image-20240312134352110"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312134609434.png" alt="image-20240312134609434"></p>
<h1 id="MQ的可靠性"><a href="#MQ的可靠性" class="headerlink" title="MQ的可靠性"></a>MQ的可靠性</h1><p>在默认情况下，RabbitMQ会将接收到的消息保存到内存中以降低消息收发的延迟。这样会导致两个问题：</p>
<ul>
<li>一旦MQ宕机，内存中的消息会丢失</li>
<li>内存空间有限，当消费者故障或者处理过慢时，会导致消息积压，引发MQ阻塞</li>
</ul>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>MQ早期，3.6版本之前的技术。</p>
<p>RabbitMQ实现数据持久化包括三个方面：</p>
<ul>
<li><p>交换机持久化</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312140018619.png" alt="image-20240312140018619"></p>
</li>
<li><p>队列持久化</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312140131208.png" alt="image-20240312140131208"></p>
</li>
<li><p>消息持久化</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312140220907.png" alt="image-20240312140220907"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPageOut</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> MessageBuilder</span><br><span class="line">        .withBody(<span class="string">&quot;hello&quot;</span>.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">        .setDeliveryMode(MessageDeliveryMode.PERSISTENT).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;simple.queue&quot;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Lazy-Queue"><a href="#Lazy-Queue" class="headerlink" title="Lazy Queue"></a>Lazy Queue</h2><p>3.6版本之后的技术。也就是惰性队列。</p>
<p>惰性队列的特征如下：</p>
<ul>
<li>接收到消息后直接存入磁盘而非内存（内存只保留最近的消息，默认2048条）</li>
<li>消费者要消费消息时才会从磁盘中读取并加载到内存</li>
<li>支持数百万条的消息存储</li>
</ul>
<p>在3.12版本后，所有队列都是Lazy Queue模式，无法更改。</p>
<p>要设置一个队列为惰性队列，只需要在声明队列时，指定x-queue-mode属性为lazy即可。</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312142539723.png" alt="image-20240312142539723"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312142856713.png" alt="image-20240312142856713"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312143302816.png" alt="image-20240312143302816"></p>
<h1 id="消费者的可靠性"><a href="#消费者的可靠性" class="headerlink" title="消费者的可靠性"></a>消费者的可靠性</h1><h2 id="消费者确认机制"><a href="#消费者确认机制" class="headerlink" title="消费者确认机制"></a>消费者确认机制</h2><p>为了确认消费者是否成功处理消息，RabbitMQ提供了消费者确认机制（Consumer Acknowledgement）。当消费者处理消息结束后，应该向RabbitMQ发送一个回执，告知Rabbit MQ自己的消息处理状态。回执有三种可选值：</p>
<ul>
<li><strong>ack</strong>：成功处理消息，RabbitMQ从队列中删除该消息</li>
<li><strong>nack</strong>：消息处理失败，RabbitMQ需要再次投递消息</li>
<li><strong>reject</strong>：消息处理失败并拒绝该消息，RabbitMQ从队列中删除该消息</li>
</ul>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312143714470.png" alt="image-20240312143714470"></p>
<p>SPringAMQP已经实现了消息确认功能，并允许我们通过配置文件选择ACK处理方式，有三种方式：</p>
<ul>
<li>None：不处理。即消息投递给消费者后立刻ack，消息会立刻从MQ删除。非常不安全，不建议使用</li>
<li>manual：手动模式。需要自己在业务代码中调用api，发送ack或reject，存在业务入侵，但更灵活</li>
<li>auto：自动模式。SpringAMQP利用AOP对我们的消息处理逻辑做了环绕增强，当业务正常执行时则自动返回ack。<ul>
<li>当业务出现异常时，根据异常判断返回不同结果：<ul>
<li>如果是业务异常，会自动返回nack</li>
<li>如果是消息处理或检验异常，自动返回reject</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312144237321.png" alt="image-20240312144237321"></p>
<h2 id="消费失败处理"><a href="#消费失败处理" class="headerlink" title="消费失败处理"></a>消费失败处理</h2><p>当消费者出现异常后，消息会不断requeue（重新入队）到队列，再重新发送给消费者，然后再次异常，再次requeue，无限循环，导致mq的消息处理飙升，带来不必要的压力。</p>
<p>我们可以利用Spring的retry机制，在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312145619539.png" alt="image-20240312145619539"></p>
<p>在开启重试模式后，重试次数耗尽，如果消息依旧失败，则需要有MessageRevocerer接口来处理，它包含三种不同的实现：</p>
<ul>
<li>RejectAndDontRequeueRecover：重试耗尽后， 直接reject，丢弃消息。默认就是这种方式</li>
<li>ImmediateRequeueMessageRecoverer：重试耗尽后，返回nack，消息重新入队</li>
<li>RepublishMessageRecover：重试耗尽后，将失败消息投递到指定的交换机</li>
</ul>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312150404991.png" alt="image-20240312150404991"></p>
<p>将失败处理策略改为RepublishMessageRecover</p>
<ol>
<li>首先，定义接收失败消息的交换机、队列及其绑定关系，此处略：</li>
<li>然后，定义RepublishMessageRecover</li>
</ol>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312150559772.png" alt="image-20240312150559772"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312151818893.png" alt="image-20240312151818893"></p>
<h2 id="业务幂等性"><a href="#业务幂等性" class="headerlink" title="业务幂等性"></a>业务幂等性</h2><p>幂等是一个数学概念，用函数表达式来描述是这样的：f(x) &#x3D; f(f(x))。在程序开发中，则是指同一个业务，执行一次或多次对业务状态的影响是一致的。</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312152640581.png" alt="image-20240312152640581"></p>
<p>唯一消息id</p>
<p>方案一，给每个消息都设置一个唯一id，利用id区分是否是重复消息</p>
<ol>
<li>每一条消息都生成一个唯一的id，与消息一起投递给消费者。</li>
<li>消费者接收到消息后处理自己的业务，业务处理完成后将消息ID保存到数据库</li>
<li>如果下次又收到相同消息，去数据库查询判断是否存在，存在则为重复消息放弃处理。</li>
</ol>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312153407046.png" alt="image-20240312153407046"></p>
<p>方案二，是结合业务逻辑，基于业务本身做判断。以我们的业务为例：我们要在支付后修改订单状态为已支付，应该在修改订单状态前先查询订单状态，判断状态是否是未支付。只有未支付订单才需要修改，其他状态不做处理：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312154523630.png" alt="image-20240312154523630"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312155700448.png" alt="image-20240312155700448"></p>
<h1 id="延迟消息"><a href="#延迟消息" class="headerlink" title="延迟消息"></a>延迟消息</h1><p><strong>延迟消息</strong>：生产者发送消息时指定一个时间，消费者不会立刻收到消息，而是在指定时间之后才收到消息。</p>
<p><strong>延迟任务</strong>：设置在一定时间后才执行的任务。</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312161312805.png" alt="image-20240312161312805"></p>
<h2 id="死信交换机"><a href="#死信交换机" class="headerlink" title="死信交换机"></a>死信交换机</h2><p>当一个队列中的消息满足下列情况之一时，就会成为死信（dead letter）：</p>
<ul>
<li>消费者使用basic.reject或basic.nack声明消费失败，并且消息的requeue参数设置为false</li>
<li>消息是一个过期消息（达到了队列或消息本身设置的过期时间），超时无人消费</li>
<li>要投递的队列消息堆满了，最早的消息可能成为死信</li>
</ul>
<p>如果队列通过dead-letter-exchange属性指定了一个交换机，那么该队列中的死信就会投递到这个交换机中。这个交换机成为死信交换机（Dead Letter Exchange，简称DLX）。</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312161831908.png" alt="image-20240312161831908"></p>
<h2 id="延迟信息插件"><a href="#延迟信息插件" class="headerlink" title="延迟信息插件"></a>延迟信息插件</h2><p>死信交换机缺点：设置的死信交换机和队列太多，管理复杂，麻烦。</p>
<p>且它本来不是用来做这个操作的。</p>
<p>RabbitMQ的官方也推出了一个插件，原生支持延迟消息功能。该插件的原理是设计了一种支持延迟消息功能的交换机，当消息投递到交换机后可以暂存一段时间，到期后再投递到队列。</p>
<p>插件下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></p>
<p>由于我们安装的MQ是<code>3.8</code>版本，因此这里下载<code>3.8.17</code>版本：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312163855601.png" alt="image-20240312163855601"></p>
<p>当然，也可以直接使用课前资料提供好的插件：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312163930621.png" alt="image-20240312163930621"></p>
<p>因为我们是基于Docker安装，所以需要先查看RabbitMQ的插件目录对应的数据卷。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume inspect mq-plugins</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;CreatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-06-19T09:22:59+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Mountpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/mq-plugins/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mq-plugins&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>插件目录被挂载到了<code>/var/lib/docker/volumes/mq-plugins/_data</code>这个目录，我们上传插件到该目录下。</p>
<p>接下来执行命令，安装插件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312164153404.png" alt="image-20240312164153404"></p>
<h3 id="声明延迟交换机"><a href="#声明延迟交换机" class="headerlink" title="声明延迟交换机"></a>声明延迟交换机</h3><p>基于注解方式：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312164349718.png" alt="image-20240312164349718"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">        key = &quot;delay&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;接收到delay.queue的延迟消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于<code>@Bean</code>的方式：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312164408592.png" alt="image-20240312164408592"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.consumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayExchangeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">delayExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder</span><br><span class="line">                .directExchange(<span class="string">&quot;delay.direct&quot;</span>) <span class="comment">// 指定交换机类型和名称</span></span><br><span class="line">                .delayed() <span class="comment">// 设置delay的属性为true</span></span><br><span class="line">                .durable(<span class="literal">true</span>) <span class="comment">// 持久化</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay.queue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayQueueBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayedQueue()).to(delayExchange()).with(<span class="string">&quot;delay&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送延迟消息"><a href="#发送延迟消息" class="headerlink" title="发送延迟消息"></a>发送延迟消息</h3><p>发送消息时，必须通过x-delay属性设定延迟时间：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312164501195.png" alt="image-20240312164501195"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPublisherDelayMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, delayed message&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.发送消息，利用消息后置处理器添加消息头</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;delay.direct&quot;</span>, <span class="string">&quot;delay&quot;</span>, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            <span class="comment">// 添加延迟消息属性</span></span><br><span class="line">            message.getMessageProperties().setDelay(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>延迟消息插件内部会维护一个本地数据库表，同时使用Elang Timers功能实现计时。如果消息的延迟时间设置较长，可能会导致堆积的延迟消息非常多，会带来较大的CPU开销，同时延迟消息的时间会存在误差。</p>
<p>因此，<strong>不建议设置延迟时间过长的延迟消息</strong>。</p>
<h2 id="取消超时订单"><a href="#取消超时订单" class="headerlink" title="取消超时订单"></a>取消超时订单</h2><p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312170034464.png" alt="image-20240312170034464"></p>
<p>假如订单超时支付时间为30分钟，理论上说我们应该在下单时发送一条延迟消息，延迟时间为30分钟。这样就可以在接收到消息时检验订单支付状态，关闭未支付订单。</p>
<p>但是大多数情况下用户支付都会在1分钟内完成，我们发送的消息却要在MQ中停留30分钟，额外消耗了MQ的资源。因此，我们最好多检测几次订单支付状态，而不是在最后第30分钟才检测。</p>
<p>例如：我们在用户下单后的第10秒、20秒、30秒、45秒、60秒、1分30秒、2分、…30分分别设置延迟消息，如果提前发现订单已经支付，则后续的检测取消即可。</p>
<p>这样就可以有效避免对MQ资源的浪费了。</p>
<p>接下来，我们就在交易服务中利用延迟消息实现订单超时取消功能。其大概思路如下：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312170138579.png" alt="image-20240312170138579"></p>
<p>优化后的实现思路如下：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312170146743.png" alt="image-20240312170146743"></p>
<p>由于我们要多次发送延迟消息，因此需要先定义一个记录消息延迟时间的消息体，处于通用性考虑，我们将其定义到<code>hm-common</code>模块下：</p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312170710881.png" alt="image-20240312170710881"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.common.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmall.common.utils.CollUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiDelayMessage</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录延迟时间的集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; delayMillis;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultiDelayMessage</span><span class="params">(T data, List&lt;Long&gt; delayMillis)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="built_in">this</span>.delayMillis = delayMillis;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; MultiDelayMessage&lt;T&gt; <span class="title function_">of</span><span class="params">(T data, Long ... delayMillis)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MultiDelayMessage</span>&lt;&gt;(data, CollUtils.newArrayList(delayMillis));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取并移除下一个延迟时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 队列中的第一个延迟时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">removeNextDelay</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delayMillis.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否还有下一个延迟时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNextDelay</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !delayMillis.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无论是消息发送还是接收都是在交易服务完成，因此我们在<code>trade-service</code>中定义一个常量类，用于记录交换机、队列、RoutingKey等常量：</p>
<p>内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmall.trade.constants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MqConstants</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.topic&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;trade.order.delay.queue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">DELAY_ORDER_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;order.query&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发送延迟消息-1"><a href="#发送延迟消息-1" class="headerlink" title="发送延迟消息"></a>发送延迟消息</h3><p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312172613818.png" alt="image-20240312172613818"></p>
<p><img src="/2024/03/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1-day06-rabbitMQ/image-20240312172644940.png" alt="image-20240312172644940"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
		  
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/2698022795" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:2698022795@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/qq_40493033" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

		  
			
			  <div class="links-of-blogroll motion-element links-of-blogroll-block">
				<div class="links-of-blogroll-title">
				  <!-- modify icon to fire by szw -->
				  <i class="fa fa-history fa-" aria-hidden="true"></i>
				  近期文章
				</div>
				<ul class="links-of-blogroll-list">
				  
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day09-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83/" title="学成在线-day09-课程发布" target="_blank">学成在线-day09-课程发布</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/22/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day07-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-xxl-job/" title="学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案" target="_blank">学成在线-day07-断点续传 xxl-job + 学成在线-day08-视频处理-技术方案</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day06-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86/" title="学成在线-day06-媒资管理" target="_blank">学成在线-day06-媒资管理</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/20/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day05-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" title="学成在线-day05-项目实战" target="_blank">学成在线-day05-项目实战</a>
					</li>
				  
					<li class="recent_posts_li">
					  <a href="/2024/03/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF-day04-JSR303%E6%A0%A1%E9%AA%8C/" title="学成在线-day04-JSR303校验" target="_blank">学成在线-day04-JSR303校验</a>
					</li>
				  
				</ul>
			  </div>
			


          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">waterdance</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">226.3k</span>
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>

-->



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "default";
      
          flOptions.boxForm = "vertical";
      
          flOptions.position = "topRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

  
  
		# 要加入的代码
</body>
</html>
